define("dropbox",["modules/core/controller_registry","modules/clean/browse_interface","modules/clean/react/previews/preview_linkfile","modules/clean/base64","modules/core/uri","modules/clean/em_string","modules/core/exception","libs","modules/clean/uirequest","modules/clean/history","modules/clean/sharing/shared_link_modal","external/underscore","modules/clean/ajax","modules/clean/sso_login_checks","modules/core/notify","external/swfobject","modules/clean/search/search_helpers","modules/clean/job_progress","modules/clean/pagination_manager","modules/clean/previews/pdf_loader","modules/constants/viewer","modules/clean/people/experiments/link_profile_service_modal","modules/clean/account/email","modules/clean/dbmodal","modules/clean/events/rollback","modules/clean/page_role_observer","external/backbone","modules/clean/react/previews/preview_image_zoom","modules/clean/display_format","modules/clean/event_load","modules/clean/contacts/facebook_modal","modules/clean/contacts/facebook_oauth","external/plupload_dev","modules/clean/react/previews/preview_video","external/keymaster","modules/clean/image_size","modules/clean/viewer","modules/constants/python","external/cyfd","modules/clean/sprite","modules/clean/dbmodal_loading","modules/clean/undo","modules/clean/notserver","modules/clean/gandalf_util","modules/clean/multiaccount_login","modules/clean/datetime","modules/clean/video_util","modules/clean/react/previews/preview_flippable","modules/clean/contacts/types","external/react","modules/clean/profile_services/profile_services_constants","modules/clean/react/activity/comment_count_bubble","modules/clean/db_bubble","modules/clean/top_notif","external/purify","modules/clean/sharing/share_inband","modules/constants/env","modules/clean/sharing/shared_folder_settings_modal","jquery","modules/core/ordered_dictionary","modules/clean/components/bubble_picker","external/modernizr","modules/clean/teams/team_folder_modal","modules/clean/components/ajax_form","modules/clean/react/invite/invite_form_react","modules/clean/react/modal","modules/clean/contacts/list","modules/clean/profile_services/profile_services_link","modules/core/i18n","external/flash_detect","modules/core/dom","modules/clean/web_timing_logger","modules/clean/payments/credit_card_util","modules/clean/react/previews/preview_image","modules/clean/form","modules/core/cookies","modules/clean/clipboard","modules/clean/payments/cash","modules/clean/browse/browse_drag_utils","modules/clean/account/email_verify_reasons","modules/clean/react/hierarchical_nav_bar","modules/clean/payments/dfb_util","external/jquery_ui","modules/clean/contacts/cache","modules/clean/frame_messenger","modules/clean/analytics","modules/clean/photos/legacy_thumb_loader","modules/core/browser","modules/clean/react/previews/preview_blank","modules/clean/filepath","modules/core/html","modules/clean/static_urls"],function(bX,fi,bH,ai,F,bU,eb,cj,by,eD,aG,bx,cC,b6,ae,c1,am,z,fk,av,a9,b,cV,c7,ap,a6,el,dh,aD,ak,ed,es,o,a7,e4,af,cK,aV,eI,cv,cB,W,cQ,ax,bO,b4,bt,M,V,dA,c0,a4,aA,ct,cY,dO,fj,ac,bE,aZ,bA,d,dW,cf,Z,co,n,c9,bk,eY,B,eh,e7,cx,bb,bw,s,dR,cL,et,aX,c2,eG,eq,ev,ba,bs,b1,G,ay,fg,aK){var D={};var R=bH.PreviewLinkfile;var b8=eb.alertd;var cJ=eb.assert;var eN=eb.reportException;var eO=eb.stackTrace;var dj=z.Job;var eB=z.ModalProgress;var cw=b.LinkProfileServiceModal;var ar=cV.ChangeEmail;var d3=cV.EmailVerification;var d7=c7.DBModal;var d0=c7.DBModalStack;var dk=c7.DBUserModal;var aT=dh.PreviewImageZoom;var ek=a7.PreviewVideo;var aE=af.image_best_fit_size;var bP=cQ.NotServer;var d8=cQ.NotClients;var d4=M.PreviewFlippable;var c6=a4.CommentCountBubbleFactory;var e8=ct.TopNotificationBar;var eQ=ct.EUCookieNotificationBar;var q=ct.ExpiredIOSNotificationBar;var ef=ct.PackratUnlimitedOptInNotificationBar;var cg=ct.DfBAdminEarlyAccessSharingControlsBar;var cc=ct.DfBAdminEarlyAccessFtsBar;var aO=ct.LocaleSwitchBar;var eZ=ct.SuperInactiveRecoverBar;var dM=co.SimpleModal;var bj=c9.LinkedProfileServices;var ea=c9.ProfileServicesLinkingHandler;var bc=bk.ungettext;var eA=bk._;var dI=bk.N_;var E=bk.E_;var fa=bk.render_sentences;var w=cx.PreviewImage;var bi=dR.Cash;var fe=dR.CashUtil;var dJ=aX.HierarchicalNavBar;var ff=c2.DfBTransitionInfoFetcher;var cH=eq.ContactsCache;var b0=eq.DefaultContactsCache;var ei,e5,dd;INLINE_JS.$=$;INLINE_JS.$u=bx;Function.prototype.defer=Function.prototype.defer.wrap(function(fl){var T;T=$A(arguments).slice(1);this.__tb__=eO();return fl.apply(this,T)});String.prototype.evalScripts=String.prototype.evalScripts.wrap(function(fl){var T,fm;T=$A(arguments).slice(1);try{return fl.apply(this,T)}catch(fn){fm=fn;return cJ(0,fm.toString())}});ei=D.Jcached={cache:{},set:function(fl,fm,T){var fn;fn=ei.cache[fl];if(fn==null){fn=ei.cache[fl]={}}fn.value=fm;return fn.expires=T?new Date().getTime()+T:0},get:function(T){var fl;fl=ei.cache[T];if((fl==null)||new Date().getTime()>fl.expires){delete ei.cache[T];return false}return fl.value}};Function.prototype.cached=function(T){var fm,fl;fl=Math.random();fm=this;return function(){var fn;fn=ei.get(fl);if(fn!==false){return fn}fn=fm();ei.set(fl,fn,T);return fn}};Array.prototype.sort_by_key=function(fl,fm){var T;if(fm==null){fm=false}T=fm?-1:1;return this.sort(function(fn,fo){fn=fl(fn);fo=fl(fo);if(fn<fo){return T*-1}else{if(fn>fo){return T*1}else{return 0}}})};Array.prototype.contains=function(T){return this.indexOf(T)!==-1};Array.prototype.remove=function(fl,T){T=T||fl+1;return this.splice(fl,T-fl)};Array.prototype.removeItem=function(fl){var T;T=this.indexOf(fl);if(T>=0){return this.remove(T)}else{return false}};Array.prototype.dict_by=function(T){var fn,fo,fm,fp,fl;fm={};for(fn=fp=0,fl=this.length;fp<fl;fn=++fp){fo=this[fn];fm[this[fn][T]]=this[fn]}return fm};Array.prototype.unique=function(){var fo,fm,fn,fl,T;fo={};for(fn=0,fl=this.length;fn<fl;fn++){fm=this[fn];if(typeof fm!=="string"){return this}fo[fm]=0}T=[];for(fm in fo){T.push(fm)}return T};String.prototype.widthSplit=function(fn){var T,fm,fl,fo;if(fn==null){fn=15}T=[];fm=this;fo=0;fl=fm.substring(fo,fo+fn);while(fl!==""){T.push(fl);fo+=fn;fl=fm.substring(fo,fo+fn)}return T};Object.extend(Effect.Transitions,{EaseIn:function(T){return Math.pow(T,2)},EaseOut:function(T){return Math.pow(T,0.5)}});(function(fm){var fl,T;fl=function(fr){var fo,fv,fu,fs,fw,fq,fp,ft,fn;if(fr){if(Object.isArray(fr)){fo=[];for(fq=0,ft=fr.length;fq<ft;fq++){fv=fr[fq];fo.push(fg.escape(fv).toHTML())}fr=new fg(fo.join(""))}else{if(fr.top||fr.bottom||fr.before||fr.after){fs=["top","bottom","before","after"];for(fp=0,fn=fs.length;fp<fn;fp++){fu=fs[fp];fw=fr[fu];if(fw){fr[fu]=arguments.callee(fw)}}}else{if(d5.isElm(fr)||fr.toElement||fr.toHTML){}else{fr=fg.escape(fr)}}}}return fr};return Element.addMethods({db_observe:function(fo,fn,fp){return fo.observe(fn,function(fq){return fp(fq,fo)})},smoothScrollIntoView:function(fq,fp){var fu,fo,fn,ft,fs,fr;if(fp==null){fp={}}fu={duration:0.3,offset:0,padding:0,transition:Effect.Transitions.EaseOut};fp=Object.extend(fu,fp);fn=fq.viewportOffset(fq);fo=fq.getDimensions();fr=document.viewport.getDimensions();fs=fp.padding||0;if(fn.top>fs&&(fn.top+fo.height)<(fr.height-fs)){return}ft=fn.top<fs?-1*Math.floor(fr.height/4):-1*Math.floor(3*fr.height/4);fp.offset=fp.offset||ft;return new Effect.ScrollTo(fq,fp)},__sert:function(fn,fo){return Element.insert(fn,fl(fo))},__date:function(fn,fo){return Element.update(fn,fl(fo))},replace:T=function(fn,fo){return fm(fn,fl(fo))}})})(Element.replace);e5=function(T){if(T!=null?T.target:void 0){try{return document.activeElement=T.target===document?null:T.target}catch(fl){}}};dd=function(T){try{return document.activeElement=null}catch(fl){}};if(document.addEventListener){document.addEventListener("focus",e5,true);document.addEventListener("blur",dd,true)}if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}String.prototype.lpad=function(fl,T){var fm;if(T==null){T="0"}fm=this;while(fm.length<fl){fm=T+fm}return fm.toString()};String.prototype.reverse=function(){var fm,fl,T;T=this.split("");fl=T.reverse();fm=fl.join("");return fm};String.prototype.count=function(T){return(this.length-this.gsub(T,"").length)/T.length};String.prototype.repeat=function(T){return(new Array(T+1)).join(this)};String.prototype.title=function(){return this.charAt(0).toUpperCase()+this.substr(1)};Ajax.DBRequest=Class.create(Ajax.Request,{initialize:function($super,fs,fq){var fw,fv,fA,fm,T,fx,ft,fr,fn,fl,fy,fz,fu,fp,fo;if(fq==null){fq={}}this.orig_req={url:fs,options:fq};this.start_time=b4.time();fq.method=fq.method||"post";fq.evalJS=false;fq.suppress_nonstandard_headers=true;fq.parameters=fq.parameters||{};fq.parameters.t=bw.read(Constants.JS_CSRF_COOKIE);fq.parameters.is_xhr=true;if(fq.method.toLowerCase()==="post"||Constants.CPROFILE_ENABLED){fq.parameters.parent_request_id=Constants.REQUEST_ID}if(Constants.CPROFILE_ENABLED){fq.parameters.cProfile=Constants.CPROFILE_PARAMETER}if(Constants.PUBLIC_MODE_OVERRIDE){fq.parameters.public_mode_override="1"}if(Constants.COUNTRY_OVERRIDE){fq.parameters.public_mode_override=Constants.COUNTRY_OVERRIDE}if(Constants.GANDALF_PANEL&&fs.indexOf("/")===0){fq.parameters.gandalf_panel=1}if(Ajax.DBRequest.restrict){fq.parameters.restrict=Ajax.DBRequest.restrict}fv=fq.cleanUp||(function(){});this.subject_user=fq.subject_user||fq.job_user;if(fq.job){this.job_id=d5.nonce();fq.parameters.job_id=this.job_id;ec.watch(this,fq.dont_hide_progress_on_complete)}if(!fq.no_watch){ao.watch(this,!!fq.job)}fx=fq.onFailure;ft=fq.onSuccess;T=fq.onComplete;fm=(function(fB){return function(fC){var fE,fD;if(fq.parameters.xhr_retry||!fq.allow_retries){return false}if((fD=fC.status)===0||fD===500||fD===502||fD===503){fB.orig_req.options.parameters.xhr_retry=true;fB.orig_req.options.onFailure=fx;fB.orig_req.options.onSuccess=ft;fE=new Ajax.DBRequest(fB.orig_req.url,fB.orig_req.options);return true}return false}})(this);fq.onFailure=function(fC){var fE,fB,fD;if(dj.handled(fC.request.job_id)){return}if(fm(fC)){return}if(!fq.noAutonotify){if(!Constants.IS_PROD&&fC.status===500&&fC.getHeader("X-Debug-Url")){fs=fC.getHeader("X-Debug-Url");fE=eA("There was a problem completing this request.")+(' <a href="'+fs+'" target="_blank">View debug</a>');ae.error(new fg(fE))}else{ae.error()}}fv(false);if(fx){fx(fC)}if(fC.status===403){fB=d5.session_storage_get("reload-timestamp");if(!fB||b4.time()-fB>30*1000){d5.session_storage_set("reload-timestamp",b4.time());location.reload(true)}}return cJ(fq.noAutonotify||((fD=fC.status)===403||fD===404||fD===502),"Ajax "+fC.status+" on "+fC.request.url)};fq.onComplete=(function(fB){return function(fC){if(fC.responseText.length&&T){if(fC.responseText.indexOf("async_task_started:")!==0){return T(fC)}}}})(this);fq.onSuccess=(function(fB){return function(fP){var fM,fD,fS,fE,fO,fG,fI,fL,fN,fC,fR,fF,fJ,fQ,fK,fH;fF=b4.time()-fP.request.start_time;if(dj.handled(fP.request.job_id)){return}if(!fP.responseText.length){if(!fq.job){if(fm(fP)){return}if(!fq.noAutonotify){if(!fP||fP.status!==0){ae.error()}}if(fx){fx(fP)}}}else{if(fP.responseText.indexOf("err:")===0){if(!fq.noAutonotify){fE=fP.responseText.substr(4);if(fq.html_in_error_msg){fE=new fg(fE)}ae.error(fE)}if(fx){fx(fP)}}else{if(fP.responseText.indexOf("async_task_started:")===0){fB.async_task_id=fP.responseText.split(":")[1];ec.watch(fB)}else{if(ft){if(fP.responseText.indexOf("ok:")===0){ae.success(fP.responseText.substr(3))}ft(fP)}}fR=fP.getHeader("X-Server-Response-Time")||"-1";if(fq.log_timing){eh.log_ajax_transition.defer(fF,void 0,void 0,void 0,fR,fs=bd.absolutize(fB.url))}fM=bE("#cprofile");if(!fq.no_watch&&fM.length){fI=""+Constants.REQUEST_ID+"-"+(fP.getHeader("X-Dropbox-Request-Id"));fs=fP.request.url.replace(/[^/]*\/\/[^/]+/,"").replace(/\?.*$/,"");fO={request_id:fI};fG=fP.request.url;if(fG.indexOf(Constants.BLOCK_CLUSTER)!==-1){fO.block=1}else{fK=Constants.BATCH_THUMB_ENDPOINTS;for(fJ=0,fQ=fK.length;fJ<fQ;fJ++){fS=fK[fJ];if(fG.indexOf(fS)!==-1){fO.block=1;break}}}fL=bE('<a target="_new" />').attr("href",String(F({authority:Constants.WEBSERVER,path:"/profile/cprofile",query:fO}))).text("CG ");fC=bE('<a target="_new" />').attr("href",String(F({authority:Constants.WEBSERVER,path:"/profile/ioprofile",query:fO}))).text("IO ");fN=bE('<div class="ajax">').text("Ajax: "+fs+" ("+fR+"ms)").prepend(fL,fC);fD=fM.find(".ajax");if(fD.length>=10){fD.last().remove()}fM.prepend(fN)}if(bE("#gandalf_panel").length&&fP.request.url.substring(0,14)!=="/gandalf_panel"){if((fH=window.gandalf_panel)!=null){fH.add(fP.request.url,fP.getHeader("X-Dropbox-Request-Id"))}}}}return fv(true)}})(this);fq.onException=function(fC,fD){var fE,fB;if(window.console){throw fD}fE=("Error with AJAX callback for: "+fs+" :::: ")+fD.toString();fB=eO();fB.pop();return eN(fE,b1.get_href(),"",fB.join("\n"))};if(fq.job){fs+=(fs.indexOf("?")===-1?"?":"&")+"long_running=1"}if(fq.subject_user&&!((fu=fq.parameters)!=null?fu[Constants.UID_PARAM_NAME]:void 0)){fs=F.parse(fs).updateQuery(Constants.UID_PARAM_NAME,fq.subject_user).toString()}fw=$H({url:fs});if(fq.parameters){fw.update(fq.parameters);fp=fw.keys();for(fn=0,fy=fp.length;fn<fy;fn++){fA=fp[fn];fo=["passwd","password","oauth","ccn","host_id"];for(fl=0,fz=fo.length;fl<fz;fl++){fr=fo[fl];if(fA.indexOf(fr)!==-1){fw.unset(fA)}}}fw.unset("t")}fq.onSuccess.__tb_ajax_info__=fq.onFailure.__tb_ajax_info__=Object.toJSON(fw);return $super(fs,fq)}});if(typeof key!=="undefined"&&key!==null){Object.extend(key,{main_modifier:function(){if(d5.is_mac()){return decodeURIComponent("%E2%8C%98")}else{return"ctrl"}}})}Object.extend(Prototype.BrowserFeatures,{DB_CORS:window.XMLHttpRequest&&("withCredentials" in new XMLHttpRequest())});var c3=[].slice;if(!window.$j){window.$j=window.jQuery}INLINE_JS.$j=bE;if(!Function.prototype.bind){Function.prototype.bind=function(T){var fo,fn,fl,fm;if(typeof monkey_check==="function"){monkey_check()}if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}fo=Array.prototype.slice.call(arguments,1);fm=this;fl=function(){};fn=function(){return fm.apply((this instanceof fl&&T?this:T),fo.concat(Array.prototype.slice.call(arguments)))};fl.prototype=this.prototype;fn.prototype=new fl();return fn}}jQuery.fn.curry=function(){var T,fm,fl;fm=arguments[0],fl=arguments[1],T=3<=arguments.length?c3.call(arguments,2):[];if(fl==null){fl=window}if(typeof monkey_check==="function"){monkey_check()}return function(){var fn;fn=1<=arguments.length?c3.call(arguments,0):[];return fm.apply(fl,c3.call(T).concat(c3.call(fn)))}};jQuery.fn.stripTags=function(T){if(typeof monkey_check==="function"){monkey_check()}return T.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")};jQuery.fn.hasScrollBar=function(){if(typeof monkey_check==="function"){monkey_check()}return this.get(0).scrollHeight>this.height()};jQuery.fn.viewportOffset=function(){if(typeof monkey_check==="function"){monkey_check()}return B.viewport_offset(this)};jQuery.fn.visible=function(){if(typeof monkey_check==="function"){monkey_check()}return jQuery(this).is(":visible")};jQuery.fn.clonePosition=function(fl,T){if(typeof monkey_check==="function"){monkey_check()}B.clone_position(this,fl,T);return this};jQuery.format=function(fl,T){if(typeof monkey_check==="function"){monkey_check()}return fl.replace(/\{([^}]+)\}/g,function(fn,fm){if(fm in T){return T[fm]}else{return fn}})};jQuery.cachedScript=function(fl,T){if(typeof monkey_check==="function"){monkey_check()}T=bE.extend(T||{},{dataType:"script",cache:true,url:fl});return jQuery.ajax(T)};jQuery.browser=b1;jQuery.addSubjectParam=function(fm,T){var fl;if(typeof monkey_check==="function"){monkey_check()}if(fm.subject_user&&!((fl=fm.data)!=null?fl[Constants.UID_PARAM_NAME]:void 0)){return T[Constants.UID_PARAM_NAME]=String(fm.subject_user)}};jQuery.ajaxPrefilter(function(T,fn,fm){var fl;if(!fn.noDropboxDefaults){fl={t:bw.read(Constants.JS_CSRF_COOKIE),is_xhr:true};jQuery.addSubjectParam(fn,fl);if(jQuery.ajaxSettings.restrict!=null){fl.restrict=jQuery.ajaxSettings.restrict}T.data=bE.param(bE.extend(fn.data,fl),true);return false}});jQuery.ajax.retryOnce=function(fn,T,fl){var fm;if(typeof monkey_check==="function"){monkey_check()}if(T!=="abort"&&((fm=fn.status)===0||fm===500||fm===502||fm===503)&&!this.xhr_retry){this.xhr_retry=true;return jQuery.ajax(this)}};var eJ,di,dV,bd,d5,dy,du=function(T,fl){return function(){return T.apply(fl,arguments)}};d5=INLINE_JS.Util=D.Util={scroll_to_thumb:function(T){var fo,fn,fm,fl;fn=T.cumulativeOffset().top;fo=T.getHeight();fl=B.scroll_offsets().top;fm=B.viewport_dimensions().height;if(fn<fl||fn+fo>fl+fm){return B.scroll_to(0,fn-fm/2)}},decode_sort_key:function(fm){var fo,fn,fl,T;T=[];for(fn=0,fl=fm.length;fn<fl;fn++){fo=fm[fn];if(typeof fo==="string"){T.push(ai.decode(fo))}else{T.push(fo)}}return T},sort_by_rank_or_key:function(T,fl){if((T.sort_rank!=null)&&(fl.sort_rank!=null)){return T.sort_rank-fl.sort_rank}cJ((T.sort_key!=null)&&(fl.sort_key!=null),"expected sort keys on both elms");return this._sort_by_key(T,fl)},sort_by_key:function(T,fl){return this._sort_by_key(T,fl)},_sort_by_key:function(fl,fq){var fn,T,fm,fp,fo;T=fl.sort_key;fm=fq.sort_key;for(fn=fp=0,fo=T.length;0<=fo?fp<fo:fp>fo;fn=0<=fo?++fp:--fp){if(fm[fn]==null){return 1}if(typeof T[fn]!==typeof fm[fn]){if(typeof T[fn]==="string"){return 1}else{return -1}}else{if(T[fn]!==fm[fn]){if(T[fn]>fm[fn]){return 1}else{return -1}}}}if(fm.length>T.length){return -1}else{return 0}},add_sort_arrow_mouseover:function(T,fo,fm,fl){var fr,fp,fs,fq,fn;fq=$$(fm);fn=[];for(fp=0,fs=fq.length;fp<fs;fp++){fr=fq[fp];fn.push((function(ft){var fu;if(T!==ft){cv.src(ft.down("img"),"web","downtick-spacer");return ft.removeClassName("bolded")}else{ft.addClassName("bolded");if(ft.hasClassName("noarrow")){return}fu=fo?"arrow-up-gray":"arrow-down-gray";return cv.src(ft.down("img"),"web",fu)}})(fr))}return fn},add_sort_arrow_mouseover_j:function(T,fo,fm,fl){var fr,fp,fs,fq,fn;fq=bE(fm);fn=[];for(fp=0,fs=fq.length;fp<fs;fp++){fr=fq[fp];fn.push((function(ft){var fu;if(T.attr("data-sort")!==bE(ft).attr("data-sort")){cv.src(bE(ft).find("img")[0],"web","downtick-spacer");return bE(ft).removeClass("bolded")}else{bE(ft).addClass("bolded");if(bE(ft).hasClass("noarrow")){return}fu=fo?"arrow-up-gray":"arrow-down-gray";return cv.src(bE(ft).find("img")[0],"web",fu)}})(fr))}return fn},one_line_fit:function(T){var fm,fl;fm=$$(T);if(fm.length<2){return}fl=(function(fn){return function(){var fw,ft,fs,fq,fv,fr,fo,fp,fu;fs=fm[0];fv=fm[fm.length-1];fq=fs.cumulativeOffset().top;fr=fv.cumulativeOffset().top;if(fq!==fr){fw=parseInt(fs.getStyle("font-size"),10);fo=fw-1;if(fo<8){return}for(fp=0,fu=fm.length;fp<fu;fp++){ft=fm[fp];ft.style.fontSize=fo+"px"}return fl()}}})(this);return fl()},nice_list:function(fl){var fp,fo,fn,T,fm;if(!fl){return""}else{if(fl.length===1){return fl[0]}else{if(fl.length===2){return eA("%(x)s and %(y)s").format({x:fl[0],y:fl[1]})}}}fm=eA("%(x)s, %(y)s, and %(z)s").split(/%\(x\)s|%\(y\)s|%\(z\)s/);cJ(fm.length===4,"bad item list format %(x)s, %(y)s, and %(z)s");fo=fm[0];fn=fm[1];T=fm[2];fp=fm[3];return[fo,fl.slice(0,-1).join(fn),T,fl[fl.length-1],fp].join("")},list_em_snippet:function(fl,T){var fp,fn,fm,fo,fr,fq;fm="";T-=new bU("...").length;for(fn=fr=0,fq=fl.length;0<=fq?fr<fq:fr>fq;fn=0<=fq?++fr:--fr){fo=fl[fn];if(fn!==0){fo=", "+fo}fp=new bU(fo).length;if(fp>T){break}T-=fp;fm+=fo}return{str:fm,snipped:fl.length-fn}},start_of_day:function(T){var fl;fl=new Date();fl.setTime(T.getTime());fl.setHours(0);fl.setMinutes(0);fl.setSeconds(0);fl.setMilliseconds(0);return fl},to_iso8601_date:function(fn,fl,fm){var T;if(fl==null){fl=false}if(fm==null){fm=false}if(fl){T=fn.getUTCFullYear().toString()+"-"+(fn.getUTCMonth()+1).toString().lpad(2)+"-"+fn.getUTCDate().toString().lpad(2);if(fm){T+=" "+fn.getUTCHours().toString().lpad(2)+":"+fn.getUTCMinutes().toString().lpad(2)+":"+fn.getUTCSeconds().toString().lpad(2)}}else{T=fn.getFullYear().toString()+"-"+(fn.getMonth()+1).toString().lpad(2)+"-"+fn.getDate().toString().lpad(2);if(fm){T+=" "+fn.getHours().toString().lpad(2)+":"+fn.getMinutes().toString().lpad(2)+":"+fn.getSeconds().toString().lpad(2)}}return T},to_mysql_date:function(fo,T,fm){var fl,fp,fn;fl=fo.getFullYear().toString()+"-"+(fo.getMonth()+1).toString().lpad(2)+"-"+fo.getDate().toString().lpad(2);fn=fo.getHours().toString().lpad(2)+":"+fo.getMinutes().toString().lpad(2)+":"+fo.getSeconds().toString().lpad(2);fp="."+fo.getMilliseconds().toString().lpad(3);if(!T){return fl}if(!fm){return fl+" "+fn}return fl+" "+fn+fp},from_mysql_date:function(fl){var fn,fp,fm,fr,T,fq,fo;fr=fl.split(" ");fn=fr[0];fq=fr.length>1?fr[1]:false;fp=fn.split("-");cJ(fp.length===3,"weird date format on "+this+", expected yyyy-mm-dd");fm=new Date(fp[0],parseInt(fp[1],10)-1,fp[2]);if(fq){fo=fq.split(":");cJ(fo.length===3,"weird time format on "+this+", expected hh:mm:ss.ms");fm.setHours(fo[0]);fm.setMinutes(fo[1]);T=fo[2].split(".");fm.setSeconds(T[0]);if(T.length>1){fm.setMilliseconds(T[1])}}return fm},make_table:function(T,fr){var fm,fq,fs,fl,fo,fn,fp;fs=new Element("table",fr);fl=new Element("tbody");fs.__sert(fl);for(fq in T){fp=T[fq];fn=new Element("tr");fo=new Element("td").insert(fq);fm=new Element("td").insert(fp);fn.__sert(fo);fn.__sert(fm);fl.__sert(fn)}return fs},validate_email:function(T){var fl;fl=new RegExp("^['&A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,15}$","i");return fl.test(T)},scrollTop:function(){return window.scrollY||document.documentElement.scrollTop||0},scrollLeft:function(){return window.scrollX||document.documentElement.scrollLeft||0},scried:{},scry:function(fm){var fl,T;T=this.scried;fl=T[fm];if(!fl){fl=$(fm);T[fm]=fl}return fl},urlquote:function(T){return T.split("/").map(encodeURIComponent).join("/")},ie8:Prototype.Browser.IE&&document.documentMode&&true,ie:Prototype.Browser.IE,log:function(){var fl,T;if(!Constants.IS_PROD){if(Prototype.Browser.IE){return(fl=$("ieconsole"))!=null?fl.innerHTML+=$A(arguments).join(" ")+"<br>":void 0}else{return typeof console!=="undefined"&&console!==null?(T=console.log)!=null?T.apply(console,$A(arguments)):void 0:void 0}}},childElement:function(fm,fl){var T;T=this.childElementWithIndex(fm,fl);return T[0]},childElementWithIndex:function(fr,fm){var fo,fq,fn,fl,fp,T;fo=0;fl=fr.childNodes;for(fn=fp=0,T=fl.length;fp<T;fn=++fp){fq=fl[fn];if(fq.nodeType===1&&fo++===fm){return[fq,fn]}}return[false,false]},disableSelection:function(T){T.onselectstart=function(){return false};T.unselectable="on";T.style.MozUserSelect="none";return T.style.cursor="default"},enableSelection:function(T){T.onselectstart=function(){return true};T.unselectable="off";T.style.MozUserSelect="";return T.style.cursor=""},disable_ie_image_dragging:function(){if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return document.ondragstart=function(){return false}}},bsearch:function(T,fr,fp,fo){var fm,fn,fl,fq;if(!fp){fp=function(fs,ft){return fs-ft}}fm=T.length;fn=0;while(fm>fn){fl=Math.floor(fm/2+fn/2);fq=fp(T[fl],fr);if(fq>0){fm=fl}else{if(fq<0){fn=fl+1}else{return fl}}}if(fo){return fn}else{return -1}},nonce:function(){var fm,T,fl;fm=new Date();fl=fm.getTime().toString();T=Math.floor(Math.random()*1000000).toString().lpad(6);return fl+T},focus:function(fl){if(fl){fl=$(fl);try{return fl.focus()}catch(T){}}},sumStyles:function(fn,fo){var T,fm,fp,fl;fm=0;if(fn){for(fp=0,fl=fo.length;fp<fl;fp++){T=fo[fp];fm+=parseInt(fn.getStyle(T),10)||0}}return fm},async_load_script:function(fl){var T;T=function(){var fn,fm;fm=document.createElement("script");fm.src=fl;fm.type="text/javascript";fm.async=true;fn=document.getElementsByTagName("script")[0];return fn.parentNode.insertBefore(fm,fn)};if(document.readyState==="complete"){return T()}else{if(window.attachEvent!=null){return window.attachEvent("onload",T)}else{return window.addEventListener("load",T,false)}}},smart_window_load:function(T){if(document.readyState==="complete"){return T.defer()}else{return Event.observe(window,"load",T)}},isNumber:function(T){return !isNaN(Number(T,10))},shorten_url:function(T,fl){return new Ajax.DBRequest("/shorten_url",{parameters:{url:T},onSuccess:function(fm){return fl(fm.responseText)}})},falsy_to_empty:function(T){return T||""},preloaded_images:{},preload_image:function(fn,fm,fl){var T;if(this.preloaded_images[fn]){return}T=new Image();if(fm!=null){Element.extend(T).observe("error",fm)}if(fl!=null){Element.extend(T).observe("load",fl)}T.src=fn;return this.preloaded_images[fn]=T},get_preloaded_image:function(T){if(this.preloaded_images[T]){return this.preloaded_images[T].clone()}else{return new Element("img",{src:T})}},clear_selected:function(){var T;if(window.getSelection){T=window.getSelection();if(T.removeAllRanges){return T.removeAllRanges()}}else{if(document.selection){return document.selection.empty()}}},is_mac:function(){return navigator.appVersion.indexOf("Mac")!==-1},is_windows:function(){return navigator.appVersion.indexOf("Windows")!==-1},in_scrollbar:function(T){var fm,fl;fm=20;fl=B.viewport_dimensions();return T>fl.width-fm},freshbutton_overlay:function(fl,T){var fn,fm;fm=fl instanceof jQuery&&fl||bE(fl);fn=T instanceof jQuery&&T||bE(T);fm.on("mouseover",(function(fo){return function(){return fn.addClass("hovered")}})(this));fm.on("mouseout",(function(fo){return function(){fn.removeClass("hovered");return fn.removeClass("pressed")}})(this));fm.on("mousedown",(function(fo){return function(){fn.removeClass("hovered");return fn.addClass("pressed")}})(this));return fm.on("mouseup",(function(fo){return function(){return fn.removeClass("pressed")}})(this))},isElm:function(T){if(typeof HTMLElement==="object"){return T instanceof HTMLElement}else{return T&&typeof T==="object"&&T.nodeType===1&&typeof T.nodeName==="string"}},_track_twitter_chars_left:function(fl,fm){var T;clearInterval(this.chars_left_interval);T=(function(fn){return function(){var fo,fp;fo=$("twitter-chars");fp=fm-$F(fl).strip().length;if(fp<0){fo.addClassName("too-long")}else{fo.removeClassName("too-long")}return fo.__date(fp)}})(this);return this.chars_left_interval=setInterval(T,250)},session_storage_set:function(T,fl){if(!window.sessionStorage||!window.JSON){return}return window.sessionStorage.setItem(T,JSON.stringify(fl))},session_storage_get:function(T){if(window.sessionStorage&&window.JSON){return JSON.parse(window.sessionStorage.getItem(T))}},pdf_plugins:function(){var fm,fl,T;T=/Chrome PDF|Adobe Reader|Adobe PDF|Acrobat/gi;return fm=(function(){var fq,fo,fp,fn;fp=window.navigator.plugins;fn=[];for(fq=0,fo=fp.length;fq<fo;fq++){fl=fp[fq];if(T.test(fl.name)){fn.push(fl)}}return fn})()},get_window_location:function(){return window.location}};d5.scrollLeft=d5.scrollLeft.cached(50);d5.scrollTop=d5.scrollTop.cached(50);dV=D.UIButton=(function(){T.prototype.selector=function(){return".ui-button"};T.prototype.over=function(fl,fm){return fm.addClassName("over")};T.prototype.out=function(fl,fm){return fm.removeClassName("over")};T.prototype.down=function(fl,fm){return fm.addClassName("down")};T.prototype.up=function(fl){return $$(this.selector()+".down").invoke("removeClassName","down")};function T(){this.clear=du(this.clear,this);this.up=du(this.up,this);this.listen()}T.prototype.active=function(fm,fn){var fl;fl=bE(fn);if(fl.hasClass("ui-button-dropdown")){if(fl.hasClass("active")){bE(document).trigger("dropdownClosed",[1])}else{bE(document).trigger("dropdownOpened",[1])}}return fl.toggleClass("active")};T.prototype.clear=function(fr){var fm,fl,fq,ft,fs,fp,fn,fu,fo;fs=$(fr.target);fl=this.selector()+".active";fp=fs.match(fl)&&fs||fs.up(fl);fq=0;fo=$$(fl);for(fn=0,fu=fo.length;fn<fu;fn++){ft=fo[fn];fm=bE(ft);if(fp!==ft){if(fm.hasClass("active")&&fm.hasClass("ui-button-dropdown")){fq+=1}fm.removeClass("active")}}return bE(document).trigger("dropdownClosed",[fq])};T.prototype.listen=function(){$(document.body).on("mouseover",this.selector(),this.over);$(document.body).on("mouseout",this.selector(),this.out);$(document.body).on("mousedown",this.selector(),this.down);document.on("mouseup",this.up);$(document.body).on("click",this.selector(),this.active);return document.on("click",this.clear)};return T})();if(window.console==null){window.console={log:function(){},profile:function(){},profileEnd:function(){}}}document.observe("script:loaded",function(){var fm,fo,fl,fn,T;new dV();if(d5.ie8){fn=$$("#page-header a, #page-footer a");T=[];for(fo=0,fl=fn.length;fo<fl;fo++){fm=fn[fo];if(fm.target==="_blank"){T.push(fm.target="")}else{T.push(void 0)}}return T}});di=__CONDITIONAL_JS__.Trace=D.Trace=(function(){var T;T=[];return{log:function(){var fl;fl=b4.time()+": "+$A(arguments).join(" ");return T.push(fl)},get:function(){return T.join("\n")}}})();eJ=D.T=function(){return di.log.apply(this,$A(arguments))};document.observe("script:loaded",function(){var T;eJ("dom:loaded");T=function(){var fn,fl,fm,fo;fm=$("page-content");if(fm){fo=B.viewport_dimensions();fl=$(document.body);fn="absolutize";if(fo.width<fm.getWidth()){return fl.addClassName(fn)}else{return fl.removeClassName(fn)}}};Event.observe(window,"resize",bx.debounce(T,150));return T()});Event.observe(window,"load",function(){return eJ("window:load")});bd=D.URLUtil={absolutize:function(T){if(T.startsWith("https://")||T.startsWith("http://")){return T}else{if(T.charAt(0)==="/"){return""+window.location.protocol+"//"+window.location.host+T}else{return cJ(0,"absolutize is confused by "+T)}}}};dy=D.Velocity={scroll_container:null,velocity:0,last_nonzero_velocity:0,old_y:0,max_delta_y:0,calculate_velocity:function(){this.velocity=this.max_delta_y;if(this.velocity!==0){this.last_nonzero_velocity=this.velocity}return this.max_delta_y=0},capture_new_y_pos:function(){var T,fl;if(this.old_y==null){this.old_y=this.scroll_container!=null?this.scroll_container.scrollTop:B.scroll_offsets().top;return}if(this.max_delta_y==null){this.max_delta_y=0;return}fl=this.scroll_container!=null?this.scroll_container.scrollTop:B.scroll_offsets().top;T=Math.abs(this.max_delta_y)<Math.abs(fl-this.old_y);if(T){this.max_delta_y=fl-this.old_y;return this.old_y=fl}},start_capture:function(T){this.scroll_container=T;this.velocity_calculator_interval=setInterval(this.calculate_velocity.bind(this,500));if(this.scroll_container!=null){return this.scroll_container.observe("scroll",this.capture_new_y_pos.bind(this))}else{return Event.observe(window,"scroll",this.capture_new_y_pos.bind(this))}},get:function(T){if(T==null){T=false}cJ(this.velocity_calculator_interval!=null,"Haven't started capturing velocity");if(T){return this.last_nonzero_velocity}return this.velocity}};var ds;ds=D.DomUtil={fromElm:function(T){return $(T).innerHTML},updateFromElm:function(fl,T){fl=$(fl);T=$(T);return fl.update(this.fromElm(T))},fillVal:function(fr,fo){var fl,fq,fn,fp,T,fm;fp=$$("."+fo);fm=[];for(fq=0,fn=fp.length;fq<fn;fq++){fl=fp[fq];fl=$(fl);if(fl.tagName==="INPUT"){fl.value=fr;fm.push(fl.defaultValue=fr)}else{if(fl.innerHTML===""&&((T=fl.tagName)==="A"||T==="B"||T==="INPUT"||T==="I"||T==="LABEL"||T==="SELECT"||T==="SPAN"||T==="TEXTAREA")){d5.log("Filling an empty value; this may look broken in IE7",fl)}fm.push(fl.innerHTML=fr)}}return fm},copy_to_clipboard:function(fs,fp,ft){var fn,fm,T,fl,fq,fo;fn=$("hold_clipboard");fn.value=fs;if(fn.createTextRange){fo=fn.createTextRange();if(fo&&((typeof BodyLoaded==="undefined"||BodyLoaded===null)||BodyLoaded===1)){try{return fo.execCommand("Copy")}catch(fr){fq=fr;ft=ft||eA("Please copy the text below:");fp=fp||eA("Copy text");this.fillVal(fs,"text-to-copy");this.fillVal(ft,"copy-modal-body");fc.show(fp,this.fromElm("copy-modal"),{wit_group:"copy_to_clipboard"});return $("text-to-copy").select()}}}else{if(!$("flashcb")){T=document.createElement("div");T.id="flashcb";document.body.appendChild(T)}$("flashcb").innerHTML="";fm=encodeURIComponent(fn.value);fl='<embed src="/static/swf/_clipboard.swf" FlashVars="clipboard=#{clipboard}" width="0" height="0" type="application/x-shockwave-flash"></embed>';return $("flashcb").innerHTML=fl}}};var ao;ao=D.RequestWatcher={reqs:[],working_msg:eA("Still working...",{comment:"Comment about waiting for a process to complete"}),last_notification:null,TIMEOUT:10,watch:function(fl,fm){var T;T=this.reqs;if(!T.length){this.int_id=setInterval(this.check_up.bind(this),500)}if(fm){fl.skip_message=true}return T.push([fl,b4.time()])},check_up:function(){return this.scan(false)},remove:function(T){return this.scan(T)},scan:function(fp){var ft,fl,fn,T,fr,fq,fm,fs,fo;fl=b4.time();fn=[];fo=this.reqs;for(fm=0,fs=fo.length;fm<fs;fm++){T=fo[fm];fr=T[0];fq=T[1];ft=fl-fq;if(fr.transport.readyState===4){this.clearWorkingMessage();continue}if(ft>4000&&!fr.skip_message){fr.skip_message=true;if(ae.isShown()&&ae.current()===!W.undo_notification){this.last_notification=ae.success(this.working_msg)}}if(ft>this.TIMEOUT*1000&&fr.job){fr.transport.abort()}if(fr!==fp){fn.push([fr,fq])}else{fr.transport.abort()}}this.reqs=fn;if(!fn.length){return clearInterval(this.int_id)}},clearWorkingMessage:function(){if(ae.isShown()&&ae.current()===this.last_notification){return ae.clear()}}};bE(function(){var fm,fl,fn,T;fn=Prototype.Browser;T=[];for(fm in fn){fl=fn[fm];if(fl===true){T.push(bE(document.body).addClass(fm.toLowerCase()))}}return T});var dL,a2,c3=[].slice;dL=D.HTML5_HISTORY=Modernizr.history;bE((function(T){return function(){return eD.init()}})(this));a2=D.HashRouter={watch_timer:null,callback_map:{},last_hash:"",last_prefix:"",_get_location:function(){return window.location.href},_set_location:function(T){return window.location.href=T},_replace_location:function(T){return window.location.replace(T)},init:function(){return this.watch_timer=setInterval(this.check_hash.bind(this),300)},watch:function(T,fl){this.callback_map[T]=fl;if(!this.watch_timer){return this.init()}},check_hash:function(){var fl,fm,fn,fp,fo,T;fp=this._get_location().split("#")[1];if(fp!=null){fp=fp.replace(/%27/g,"'")}if(this.last_hash===fp){return}this.last_hash=fp;if(this.last_prefix&&fp===""){fp=this.last_prefix+":"}else{if(!fp){return}}T=fp.split(":");fo=T.first();this.last_prefix=fo;fn=this.callback_map[fo];if(fn!=null){fm=(function(){var ft,fr,fs,fq;fs=T.slice(1);fq=[];for(ft=0,fr=fs.length;ft<fr;ft++){fl=fs[ft];fq.push(decodeURIComponent(fl))}return fq})();fn.apply(null,fm)}return $(document).fire("db:hash_change",{hash:fp})},_prepare_hash:function(fm){var fl,T;T=$A(fm).map(d5.falsy_to_empty);fl=T.map(encodeURIComponent);return fl.join(":")},set_hash:function(){var T,fl;T=1<=arguments.length?c3.call(arguments,0):[];fl=this._prepare_hash(T);return this._set_hash(fl)},replace_hash:function(){var T,fl;T=1<=arguments.length?c3.call(arguments,0):[];fl=this._prepare_hash(T);return this._set_hash(fl,true)},_set_hash:function(fl,T){if(fl===""){fl="/"}this.last_hash=fl;if(!T){return this._set_location("#"+fl)}else{return this._replace_location("#"+fl)}}};var dE;dE=D.SharingState=(function(){function T(){}T.set_role=function(fl){bE(".shared-folder-role-param").val(fl);return this.role=fl};T.set_is_merged=function(fl){return this.is_merged=fl};T.set_team_name=function(fl){return this.team_name=fl};T.set_team_permissions=function(fm,fl){if(fm==null){fm=false}if(fl==null){fl=false}this.team_only=fm;return this.show_groups=fl};T.set_not_logged_in_role_and_email=function(fm,fl){this.not_logged_in_role=fm;return this.not_logged_in_email=fl};T.set_show_inbox=function(fl){return this.show_inbox=fl};return T})();var aY;aY=D.SharingUtil=(function(){function T(){}T.success_string_for_recipients=function(fl){var fm;if(fl.length===1){if(fl[0].indexOf("@")===-1){fm=eA("Sent to %(recipient)s.",{comment:"Recipient is a user's name"}).format({recipient:fl[0]})}else{fm=eA("Sent to %(recipient)s.",{comment:"Recipient is an email address"}).format({recipient:fl[0]})}}else{if(fl.length===2){if(fl[0].indexOf("@")===-1){if(fl[1].indexOf("@")===-1){fm=eA("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are users' names."}).format({recipient_first:fl[0],recipient_second:fl[1]})}else{fm=eA("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is a user's name, second is an email address"}).format({recipient_first:fl[0],recipient_second:fl[1]})}}else{if(fl[1].indexOf("@")===-1){fm=eA("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is an email address, second is a user's name"}).format({recipient_first:fl[0],recipient_second:fl[1]})}else{fm=eA("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are email addresses"}).format({recipient_first:fl[0],recipient_second:fl[1]})}}}else{if(fl[0].indexOf("@")===-1){fm=eA("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:fl[0],num_others:fl.length-1})}else{fm=eA("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:fl[0],num_others:fl.length-1})}}}return fm};return T})();var bl,cp;bl=D.SharingApi=(function(){T.REQUEST_SUCCEEDED_EVENT="db:sharing_api:request_succeeded";function T(fl){this.user=fl}T.prototype.invite_more_to_folder=function(fm,fl,fo,fq,fn,fp){var fr;fr={ns_id:fm,emails:fl.emails||[],fb_ids:fl.fb_ids||[],group_ids:fl.group_ids||[],new_style_group_ids:fl.new_style_group_ids||[],custom_message:fo||"",access_type:fq};return this._make_request("/share_ajax/invite_more",fr,fn,fp,true)};T.prototype.update_member_access_type=function(fl,fq,fo,fm,fn){var fp;fp={ns_id:fl,member_uid:fq,access_type:fo};return this._make_request("/share_ajax/update_member_access_type",fp,fm,fn)};T.prototype.update_team_folder_access_type=function(fm,fl,fn,fo){var fp;fp={ns_id:fm,can_edit:fl};return this._make_request("/team/admin/team_folder/update_access_type",fp,fn,fo,true,false)};T.prototype.update_invite_access_type=function(fp,fn,fl,fm){var fo;fo={invite_id:fp,access_type:fn};return this._make_request("/share_ajax/update_invite_access_type",fo,fl,fm)};T.prototype.share_folder=function(fu,fo,fn,ft,fs,fm,fv,fl,fq,fw,fp){var fr,fx;fr={emails:fn.emails||[],fb_ids:fn.fb_ids||[],group_ids:fn.group_ids||[],new_style_group_ids:fn.new_style_group_ids||[],custom_message:ft||"",audience:fs,inviter:fm,shared_link_policy:fv,access_type:fl,folder_settings:1};if(fu){fr.folder_name=fo;fx="/share_ajax/new"}else{fr.path=fo;fx=fq?"/share_ajax/existing_no_recipient":"/share_ajax/existing"}if(fs||fm){fr.custom_folder_settings=1}return this._make_request(fx,fr,fw,fp,true)};T.prototype.share_path=function(fw,fn,fs,fr,fm,ft,fl,fp,fu,fo){var fq,fv;fq={emails:fn.emails||[],fb_ids:fn.fb_ids||[],group_ids:fn.group_ids||[],new_style_group_ids:fn.new_style_group_ids||[],custom_message:fs||"",audience:fr,inviter:fm,shared_link_policy:ft,access_type:fl,folder_settings:1,path:fw};fv="/share_ajax/new_path";if(fr||fm){fq.custom_folder_settings=1}return this._make_request(fv,fq,fu,fo,true)};T.prototype.share_file=function(fp,ft,fn,fs,fr,fm,fu,fl,fv,fo){var fq,fw;fq={emails:fn.emails||[],fb_ids:fn.fb_ids||[],group_ids:fn.group_ids||[],new_style_group_ids:fn.new_style_group_ids||[],custom_message:fs||"",audience:fr,inviter:fm,shared_link_policy:fu,access_type:fl,folder_settings:1,path:fp,file_path:ft};fw="/share_ajax/share_file";if(fr||fm){fq.custom_folder_settings=1}return this._make_request(fw,fq,fv,fo,true)};T.prototype.unshare_folder=function(fm,fl,fn){var fo;fo={ns_id:fm,async:true};if(fl){fo.keep_files=true}return this._make_request("/share_ajax/unshare?long_running",fo,fn)};T.prototype.leave_folder=function(fm,fl,fn){var fo;fo={ns_id:fm};if(fl){fo.keep_files=true}return this._make_request("/share_ajax/leave?long_running",fo,fn)};T.prototype.transfer_ownership=function(fl,fn,fm){var fo;fo={ns_id:fl,user_id:fn};return this._make_request("/share_ajax/change_sf_owner",fo,fm)};T.prototype.cancel_invite=function(fl,fo,fm){var fn;fn={ns_id:fl,invite_id:fo};return this._make_request("/share_ajax/cancel_invite",fn,fm)};T.prototype.kick=function(fm,fo,fl,fn){var fp;fp={ns_id:fm,user_id:fo};if(fl){fp.keep_files=true}return this._make_request("/share_ajax/kick_user",fp,fn)};T.prototype.kick_group=function(fl,fn,fm){return ae.error("This feature has been removed.")};T.prototype.reinvite_user=function(fl,fo,fm){var fn;fn={ns_id:fl,invite_id:fo};return this._make_request("/share_ajax/reinvite_user",fn,fm)};T.prototype.update_sf_permissions=function(fl,fo,fm,fn){var fp;fp={ns_id:fl,new_permissions:fo};return this._make_request("/share_ajax/change_sf_perm",fp,fm,fn)};T.prototype.update_sf_team_permissions=function(fl,fo,fp,fn,fr,fm){var fq;fq={ns_id:fl,audience:fo,inviter:fp,shared_link_policy:fn};if(!(fr===void 0)){fq.activity_feed_enabled=fr}return this._make_request("/share_ajax/save_folder_settings",fq,fm)};T.prototype.validate_new_sf_path=function(fo,fl,fm){var fn;fn={share_type:"new",folder_name:fo};return this._make_request("/share_ajax/validate_folder",fn,fl,fm,true)};T.prototype.validate_existing_sf_path=function(fo,fl,fm){var fn;fn={share_type:"existing",path:fo};return this._make_request("/share_ajax/validate_folder",fn,fl,fm,true)};T.prototype._make_request=function(fn,fr,fl,fo,fq,fm){var fp;if(fq==null){fq=false}if(fm==null){fm=true}if(fm){fr[Constants.UID_PARAM_NAME]=this.user.id}if((fp=this.loading_elem)!=null){fp.addClass("ajax-loading")}return new Ajax.DBRequest(fn,{parameters:fr,onSuccess:function(fs){if(typeof fl==="function"){fl(fs)}return bE(document).trigger(T.REQUEST_SUCCEEDED_EVENT,{request_url:fn,ns_id:fr.ns_id||null})},onFailure:fo,onComplete:(function(fs){return function(){var ft;return(ft=fs.loading_elem)!=null?ft.removeClass("ajax-loading"):void 0}})(this),noAutonotify:fq})};return T})();cp=D.UserlessSharingApi=(function(){function T(){}T.prototype.get_inbox_counts=function(fl){return new Ajax.DBRequest("/inbox_count",{onSuccess:(function(fm){return function(fo){var fn;fn=JSON.parse(fo.responseText);cJ(typeof fn==="object","bad inbox_count");return fl(fn)}})(this)})};T.prototype.get_folder_info=function(fl,fm){return new Ajax.DBRequest("/share_ajax/list_folders",{onSuccess:fl,onFailure:fm})};return T})();var r;r=INLINE_JS.SharingModals=D.SharingModals=(function(){function T(){}T.show_shared_folder_options_modal=function(fo,fl,fm,fn){if(fm==null){fm=true}if(fn==null){fn=true}return d0.push(new df(fl,fo,fm,fn))};T.show_share_inband_modal=function(fn,fm,fl,fo){return eF.createAndShowInbandModal(fm,fn,true,fl,true,false,fo)};T.show_shared_folder_wizard=function(fl){return new er(fl,{element_id:"share-a-folder-wizard-modal"}).show()};T.get_select_role_modal=function(){return new cF({element_id:"select-role-modal"})};T.start_wizard_without_user=function(){if(cK.get_viewer().is_paired){if(this.select_role_modal==null){this.select_role_modal=T.get_select_role_modal()}return this.select_role_modal.show()}else{return this.start_wizard_for_user(cK.get_viewer().get_users()[0])}};T.start_wizard_for_user=function(fl){if(d3.get_for_user(fl).verified_or_show(et.SHARE_FOLDER)){return T.show_shared_folder_wizard(fl)}};T.show_share_existing_modal=function(fn,fl){var fm;if(d3.get_for_user(fl).verified_or_show()){fm=new cn(fl,{folder_name:fn,element_id:"invite-to-new-sf-wizard-modal-"+fl.id});return fm.show()}};T.show_shmodel_or_invite_modal=function(fm,fo,fl,fn){if(d3.get_for_user(fl).verified_or_show()){return new dY(fl,{path:fm,existing_sf:fo,element_id:"create-link-or-invite-wizard-modal",target_item:fn}).show()}};T.show_unshare_team_sf_modal=function(fm,fl,fo){var fn;fn=new b3(fm,{element_id:"unshare-confirm-modal",team_shared_folder:true,ns_id:fl,folder_path:fo});return fn.show()};T.show_ignore_modal=function(fm,fp,fl){var fo,fn,fq;cJ(fl,"Share ignore did not get an ns_id");fq=eA("Permanently remove '%(folder_name)s'").format({folder_name:bU.em_snippet(ay.filename(fp),15)});fo={path:fp,ns_id:fl};fn=new dk(fm,{element_id:"ignore-confirm",title:fq});fn.on_confirm_button_click=function(ft){var fs,fr,fu;ft.preventDefault();fs=bE(ft.target);fr=fs.closest("form");fu=function(fv){ae.success(eA("Removed shared folder successfully."));document.fire(aF.SF_IGNORE,{target_ns_id:fl,user_id:fm.id});return fn.hide()};return bT.ajax_submit(fr[0],false,fu,void 0,fs[0],fo)};return fn.show()};T.show_rejoin_modal=function(fm,fp,fl){var fo,fn,fq;cJ(fl,"Rejoin didn't get an ns_id");fq=eA("Rejoin the shared folder '%(folder_name)s'?").format({folder_name:bU.em_snippet(ay.filename(fp),13)});fo={path:fp,ns_id:fl};fn=new dk(fm,{element_id:"rejoin-confirm",title:fq});fn.on_confirm_button_click=function(ft){var fs,fr,fu;ft.preventDefault();fs=bE(ft.target);fr=fs.closest("form");fu=function(fx){var fv,fw;fw=fx.responseText;fv=ay.filename(fw);ae.success(eA("Rejoined shared folder successfully."));document.fire(aF.SF_REJOIN,{target_ns_id:fl,user_id:fm.id,filename:fv,mount_point:fw});return fn.hide()};return bT.ajax_submit(fr[0],false,fu,void 0,fs[0],fo)};return fn.show()};T.show_invites=function(){return d0.push(new cB({element_id:"invitation-page-modal",endpoint_url:"/share_ajax/get_invitation_page"}))};T.show_shared_subfolder_modal=function(fm,fo){var fr,fp,fq,fl,fn;fq=bU.em_snippet(ay.filename(fm),14);fp=eA("Can't share folder");fl="'%(parent_shared_folder)s' ".format({parent_shared_folder:fq});ds.fillVal(fl.escapeHTML(),"parent_shared_folder_name");fr=eA("Share '%(parent_shared_folder)s' folder");fn=fr.format({parent_shared_folder:fq});($("share_parent_folder_button")).value=fn;fc.show(eA("Loading shared folder options..."),"<p style='margin: 3em 0; text-align: center;'> <img src='/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif' alt=''/></p>");bE("#share_parent_folder_button").on("click",(function(fs){return function(ft){fc.hide();return fs.show_shared_folder_options_modal(fm,fo)}})(this));return fc.show(fp,$("share_subfolder"))};return T})();var de;de=D.InviteFormController=(function(){function T(fn,fm,fl,fs,fr,fq){var fp,fo;this.user=fn;this.$form=fm;this.members=fl;this.invitees=fs;this.new_style_groups=fr;this.team_only=this.$form.data("team-only");fo={tokens:[",",";"],include_fb:true,members:this.members,invitees:this.invitees,new_style_groups:this.new_style_groups,contacts_only:true};if(this.user.role==="work"){fp=Autocompleter.TeamTokenizer;fo.team_only=this.team_only}else{fp=Autocompleter.ContactsTokenizer;fo.include_team=true}if(this.user.role==="work"&&(__CIRCULAR_DEPENDENCY__.GroupsApi!=null)){fo.include_new_style_groups=true}this.sharing_options_auto_completer=new fp(this.user,fq+"-new-collab-input",fq+"-new-whobulk",fq+"-hidden-input",fo);ch._create(this.$form.find(".custom-message-container")[0]);if(this.user.role==="work"){this.team_shared_folder_controller=new j(this.$form)}}T.prototype.listen=function(){return this.sharing_options_auto_completer.listen()};T.prototype.reset_autocompleter=function(){return this.sharing_options_auto_completer.clearTokens()};T.prototype.tokenize=function(){return this.sharing_options_auto_completer.tokenize_emails_input(true)};T.prototype.reset_options=function(){return bE(this.sharing_options_auto_completer.get_entry_container()).hide()};T.prototype.set_team_only=function(fl){this.team_only=fl;return this.sharing_options_auto_completer.setTeamOnly(fl)};T.prototype.get_token_count=function(){return this.sharing_options_auto_completer.getTokenCount()};T.prototype.extract_invitees=function(){var fo,fn,fm,fr,fq,fl,fp;fr={};fp=["emails","fb_ids","group_ids","new_style_group_ids"];for(fq=0,fl=fp.length;fq<fl;fq++){fn=fp[fq];fm=this.$form.find("input[name="+fn+"]");fr[fn]=[(function(){var fu,ft,fs;fs=[];for(fu=0,ft=fm.length;fu<ft;fu++){fo=fm[fu];fs.push(bE(fo).val())}return fs})()]}return fr};T.prototype.get_custom_message=function(){return this.$form.find("textarea[name='custom_message']").val()};T.prototype.get_access_type=function(){return this.$form.find(".can-edit-dropdown").data("selected-value")};return T})();var aM,df,Q,ey,bv,fd,c5,dz,aS,eS,dt,cu,dQ,bM,aH,b3,au={}.hasOwnProperty,cN=function(fn,fl){for(var T in fl){if(au.call(fl,T)){fn[T]=fl[T]}}function fm(){this.constructor=fn}fm.prototype=fl.prototype;fn.prototype=new fm();fn.__super__=fl.prototype;return fn},du=function(T,fl){return function(){return T.apply(fl,arguments)}};dQ=D.SharedFolderBaseModal=(function(fl){cN(T,fl);function T(fm,fn){this.user=fm;this.options=fn;T.__super__.constructor.call(this,this.options);this.team_shared_folder=this.options.team_shared_folder;this.path=this.options.folder_path;this.ns_id=this.options.ns_id;this.sharing_api=new bl(this.user)}T.prototype.on_show=function(){return this.sharing_api.loading_elem=this.$modal_window};return T})(d7);df=D.ExistingSharedFolderOptionsModal=(function(fl){cN(T,fl);function T(fn,fp,fo,fq,fm){var fs,fr;this.user=fn;if(fo==null){fo=true}if(fq==null){fq=true}this.restore_modal=fm;this.__show_modal=du(this.__show_modal,this);this.__x_click_handler=du(this.__x_click_handler,this);cJ(fp!=null,"Missing folder path");this.path=ay.normalize(fp);fr=eA("Shared folder options for '%(folder)s'");fr=fr.format({folder:bU.em_snippet(ay.filename(fp),13)});fs={};fs[Constants.UID_PARAM_NAME]=this.user.id;fs.max_results=20;fs.show_invite_form=fo;fs.show_folder_settings=fq;d0.register(aM.MODAL_DONE_VIEWING_EVENT,(function(ft){return function(){return typeof ft.restore_modal==="function"?ft.restore_modal():void 0}})(this));T.__super__.constructor.call(this,{element_id:"folder-share-show-modal",title:fr,endpoint_url:F({path:"/share_options"+this.path}).toString(),parameters:fs})}T.prototype.__x_click_handler=function(fn){var fm;T.__super__.__x_click_handler.apply(this,arguments);fm={path:this.path};ba.SharedFolderActivityLogger.log("web","invite_modal_x_button",this.user,fm);return typeof this.restore_modal==="function"?this.restore_modal():void 0};T.prototype.__show_modal=function(fn){var fm;T.__super__.__show_modal.apply(this,arguments);fm={path:this.path};return ba.SharedFolderActivityLogger.log("web","invite_modal_displayed",this.user,fm)};return T})(cB);aM=D.ExistingSharedFolderOptionsContent=(function(){T.CONTENT_LOADED_EVENT="db:sharing_options:content_loaded";T.MODAL_DONE_VIEWING_EVENT="db:sharing_options:modal_done_viewing_event";function T(fq,fo,fp,fm,fn,fl){this.$root=fq;this.options=fm;this.show_invite_form=fn;this.allows_editor_manage_membership=fl;this.show_email_verification=du(this.show_email_verification,this);this.show_golden_gate_warning=du(this.show_golden_gate_warning,this);this.show_folder_settings=du(this.show_folder_settings,this);this.show_m2_folder_settings=du(this.show_m2_folder_settings,this);this.toggle_from_invite_mode=du(this.toggle_from_invite_mode,this);this.toggle_to_invite_mode=du(this.toggle_to_invite_mode,this);this.toggle_get_link_button_visibility=du(this.toggle_get_link_button_visibility,this);this.show_leave_folder_modal=du(this.show_leave_folder_modal,this);this.show_owner_leave_folder_warning=du(this.show_owner_leave_folder_warning,this);this.show_access_request_link_modal=du(this.show_access_request_link_modal,this);this.show_unshare_folder_modal=du(this.show_unshare_folder_modal,this);this.show_uninvite_modal=du(this.show_uninvite_modal,this);this.show_transfer_user_modal=du(this.show_transfer_user_modal,this);this.show_kick_group_modal=du(this.show_kick_group_modal,this);this.show_kick_user_modal=du(this.show_kick_user_modal,this);this.update_tf_access=du(this.update_tf_access,this);this.update_sf_perms=du(this.update_sf_perms,this);this.reinvite_user=du(this.reinvite_user,this);this.submit_invitations=du(this.submit_invitations,this);this.maybe_load_more=du(this.maybe_load_more,this);this.extract_user_data_and_call=du(this.extract_user_data_and_call,this);this.extract_invitee_data_and_call=du(this.extract_invitee_data_and_call,this);this.create_m2_inband_modal=du(this.create_m2_inband_modal,this);this._disable_token_for_sf=du(this._disable_token_for_sf,this);this.user=cK.get_viewer().get_user_by_id(fo);this.path=ay.normalize(fp);if(this.options){this.members=this.options.folder_members;this.invitees=this.options.folder_invitees;this.new_style_groups=this.options.new_style_groups;this.num_total=this.options.num_total}this.$root.find(".bubble-dropdown").click(function(fr){B.controller(bE(fr.target).closest(".sf-action-dropdown")).closeDropdown();return true});this.start=20;this.max_results=100;this.maybe_load_more();this.sharing_api=new bl(this.user);this.sharing_api.loading_elem=this.$root;be.register_all();c4.register_all();this.ns_id=this.$root.data("ns-id");this.$invite_form=this.$root.find(".invite-more-form");this.sf_access_type=this.$invite_form.find(".sf-invite-can-edit");this.team_shared_folder=this.$root.data("team-shared-folder");this.$allow_members_table=this.$root.find(".allow-members-table");this.$folder_management_buttons=this.$root.find(".folder-management-buttons");if(this.$root.find(".get-editable-link").length>0){ba.SimpleSharingLogger.log(this.user.id,29)}this.has_show_invite_form=false;this.log_extras={path:this.path,ns_id:this.ns_id};this.sf_access_type.hide();this.listen();d0.trigger(T.CONTENT_LOADED_EVENT)}T.prototype.listen=function(){var fn,fm,fp,fl,fo;this.$root.find(".confirm-button").click((function(fq){return function(fr){fr.preventDefault();return fq.submit_invitations()}})(this));this.$root.find(".cancel-button").click((function(fq){return function(fr){fr.preventDefault();return fq.toggle_from_invite_mode()}})(this));if(this.show_invite_form){this.get_link_button=this.$root.find(".get-editable-link-invite");this.$invite_input=this.$root.find("#sharing-options-new-collab-input");fo=["focus","keypress","contextmenu"];for(fp=0,fl=fo.length;fp<fl;fp++){fm=fo[fp];this.$invite_input.off(fm);this.$invite_input.on(fm,this.toggle_to_invite_mode)}this.$invite_input.keyup(this.toggle_get_link_button_visibility);if(this.$invite_input[0]){this.$invite_input[0].on("token:remove",this.toggle_get_link_button_visibility);this.$invite_input[0].on("token:add",this.toggle_get_link_button_visibility)}fn=this.$root.find("#custom-message-wizard");fn.on("focus",this.toggle_to_invite_mode);this.$root.find(".change-settings-link").on("click",this.show_folder_settings);this.$root.find(".change-m2-settings-link").on("click",this.show_m2_folder_settings);this.$root.find(".invite-verify-email").on("click",this.show_email_verification);this.$root.find(".golden-gate-upgrade-link").on("click",this.show_golden_gate_warning);if(this.$invite_form.length&&!this.team_shared_folder){this.invite_form_controller=new de(this.user,this.$invite_form,this.members,this.invitees,this.new_style_groups,"sharing-options")}}this.$root.on("click","a.leave-folder",(function(fq){return function(fr){fr.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_leave_button",fq.user,fq.log_extras);return fq.show_leave_folder_modal()}})(this));this.$root.on("click",".get-editable-link",(function(fq){return function(fs){var fr;return fq.create_m2_inband_modal(fs,fr=false)}})(this));this.$root.on("click",".get-editable-link-invite",(function(fq){return function(fs){var fr;return fq.create_m2_inband_modal(fs,fr=true)}})(this));this.$root.on("click","a.owner-leave-folder",(function(fq){return function(fr){fr.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_owner_leave_button",fq.user,fq.log_extras);return fq.show_owner_leave_folder_warning()}})(this));this.$root.on("click","a.kick-user",(function(fq){return function(fr){return fq.extract_user_data_and_call(fr,fq.show_kick_user_modal)}})(this));this.$root.on("click","a.kick-group",(function(fq){return function(ft){var fr,fs,fu;ft.preventDefault();fr=bE(ft.currentTarget);fu=fr.data("group-name");fs=fr.data("group-gid");return fq.show_kick_group_modal(fu,fs)}})(this));this.$root.on("click","a.make-owner",(function(fq){return function(fr){return fq.extract_user_data_and_call(fr,fq.show_transfer_user_modal)}})(this));this.$root.on("click","a.send-email",(function(fq){return function(fs){var fr,ft;fs.preventDefault();fr=bE(fs.currentTarget);ft=fr.data("email");return window.location=F({scheme:"mailto",path:ft}).toString()}})(this));this.$root.on("click","a.reinvite-user",(function(fq){return function(fr){return fq.extract_invitee_data_and_call(fr,fq.reinvite_user)}})(this));this.$root.on("click","a.uninvite-user",(function(fq){return function(fr){return fq.extract_invitee_data_and_call(fr,fq.show_uninvite_modal)}})(this));this.$root.on("click","input.sf-action-leave",(function(fq){return function(fr){fr.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_leave_button",fq.user,fq.log_extras);return fq.show_leave_folder_modal()}})(this));this.$root.on("click","input.sf-action-unshare",(function(fq){return function(fr){fr.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_unshare_button",fq.user,fq.log_extras);return fq.show_unshare_folder_modal()}})(this));this.$root.on("click","a.unshare_folder_link",(function(fq){return function(fr){fr.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_unshare_button",fq.user,fq.log_extras);return fq.show_unshare_folder_modal()}})(this));this.$root.on("click","input.simple-sharing-remove-link",(function(fq){return function(fr){fr.preventDefault();return fq._disable_token_for_sf(function(){return d0.pop()})}})(this));this.$root.on("click","a.remove-link",(function(fq){return function(fr){var fs;fr.preventDefault();fs=function(){var ft;ft=d7.get_containing_modal(fq.$root);if(ft&&ft instanceof cB){return ft.fetch()}};return fq._disable_token_for_sf(fs)}})(this));this.$root.on("click","input.sf-action-get-link",(function(fq){return function(fr){fr.preventDefault();return fq.show_access_request_link_modal()}})(this));this.$root.on("click","input.sf-action-done",(function(fq){return function(fr){fr.preventDefault();ba.SharedFolderActivityLogger.log("web","invite_modal_done_button",fq.user,fq.log_extras);d0.trigger(T.MODAL_DONE_VIEWING_EVENT);return d0.pop()}})(this));this.$root.on("click","input#change-sf-perm-checkbox",(function(fq){return function(fs){var fr;fr=bE(fs.currentTarget);return fq.update_sf_perms(fr.prop("checked"))}})(this));return this.$root.on("click","input#change-tf-access-checkbox",(function(fq){return function(fs){var fr;fr=bE(fs.currentTarget);return fq.update_tf_access(!fr.prop("checked"))}})(this))};T.prototype._disable_token_for_sf=function(fl){return cC.WebRequest({url:F({path:"/sm/disable_token_at_path"+ay.normalize(this.path)}),subject_user:this.user.id,type:"POST",success:(function(fm){return function(){bE(document).trigger("db:browse:update");ae.success(eA("Link removed"));ba.SimpleSharingLogger.log(fm.user.id,25);return typeof fl==="function"?fl():void 0}})(this),error:(function(fm){return function(){return ae.error(eA("An error occurred when removing link"))}})(this)})};T.prototype.create_m2_inband_modal=function(fm,fl){fm.preventDefault();d0.pop();if(fl){ba.SimpleSharingLogger.log(this.user.id,32)}else{ba.SimpleSharingLogger.log(this.user.id,30)}return eF.createAndShowM2InbandModal(this.user,this.path)};T.prototype.extract_invitee_data_and_call=function(fo,fn){var fl,fp,fm;fo.preventDefault();fl=bE(fo.currentTarget);fm=fl.data("email-or-fbname");fp=fl.data("invite-id");return fn(fm,this.ns_id,fp)};T.prototype.extract_user_data_and_call=function(fq,fp){var fm,fo,fn,fl;fq.preventDefault();fm=bE(fq.currentTarget);fn=fm.data("display-name");fo=fm.data("email");fl=fm.data("user-id");return fp(fn,fo,fl)};T.prototype.maybe_load_more=function(){var fm,fl,fn;fl=this.$root.closest("body").length;if(!fl){return}if((this.num_total==null)||(this.start>=this.num_total)){bE("#more-members-spinner").hide();return}bE("#more-members-spinner").show();fn={};fn[Constants.UID_PARAM_NAME]=this.user.id;fn.start=this.start;fn.max_results=this.max_results;fm=F({path:"/share_options"+this.path}).toString();this.$root.removeClass("ajax-loading");new by(this.$root,fm,{data:fn,success:(function(fo){return function(fs,fp,ft){var fq,fr;if(((fr=fs.data)!=null?fr.options:void 0)!=null){fq=fs.data.options;if((fo.members!=null)&&(fq.folder_members!=null)){Array.prototype.push.apply(fo.members,fq.folder_members)}if((fo.invitees!=null)&&(fq.folder_invitees!=null)){Array.prototype.push.apply(fo.invitees,fq.folder_invitees)}if((fo.new_style_groups!=null)&&(fq.new_style_groups!=null)){Array.prototype.push.apply(fo.new_style_groups,fq.new_style_groups)}}return fo.maybe_load_more()}})(this),error:(function(fo){return function(fr,fp,fq){return ae.error("Unable to load all members of this folder.")}})(this)});return this.start=this.start+this.max_results};T.prototype.submit_invitations=function(){var fo,fn,fq,fm,fp,fl;this.invite_form_controller.tokenize();fq=this.invite_form_controller.extract_invitees();fp=this.invite_form_controller.get_custom_message();fo=this.invite_form_controller.get_access_type();fm=bx.clone(this.log_extras);fm.access_type=fo;ba.SharedFolderActivityLogger.log("web","invite_modal_send_invites_button",this.user,fm);fl=(function(fr){return function(ft){var fs;fs=d7.get_containing_modal(fr.$root);if(fs&&fs instanceof cB){fs.fetch()}else{d0.pop()}ae.success(ft.responseText);return document.fire(aF.SF_INVITE,{target_ns_id:fr.ns_id,user_id:fr.user.id})}})(this);fn=(function(fr){return function(fs){return eL.show_validation_error(fs,fr.$root.find(".tokenized_autocompleter_container"))}})(this);return this.sharing_api.invite_more_to_folder(this.ns_id,fq,fp,fo,fl,fn)};T.prototype.reinvite_user=function(fn,fl,fm){return this.sharing_api.reinvite_user(fl,fm,(function(fo){return function(fv){var fs,ft,fu,fr,fp,fq;fr=JSON.parse(fv.responseText);fp=fr.status;if(fp==="OK"){fq=eA("%(email_or_fbname)s was reinvited successfully");fq=fq.format({email_or_fbname:fn});return ae.success(fq)}else{fu=fr.reason;if(fu==="ACCEPTED"){fs=eA("That invitation has already been accepted.")}else{if(fu==="DECLINED"){fs=eA("That invitation has already been declined.")}else{fs=eA("You no longer have permission to perform this action.")}}ae.error(fs);if(fr.reload){ft=d7.get_containing_modal(fo.$root);if(ft&&ft instanceof cB){return ft.fetch()}}}}})(this))};T.prototype.update_sf_perms=function(fm){var fn,fo,fl;this.$root.find("#change-sf-perm-saving").show();fn=(fm?1:0);fl=(function(fp){return function(fq){if(fm){ae.success(eA("Editors can now manage membership of this folder."))}else{ae.success(eA("Editors can no longer manage membership of this folder."))}return fp.$root.find("#change-sf-perm-saving").hide()}})(this);fo=(function(fp){return function(fq){if(fq.responseText.indexOf("err:")===0){ae.error(fq.responseText.substr(4))}else{ae.error(eA("Error updating your preference! Please try again."))}return fp.$root.find("#change-sf-perm-saving").hide()}})(this);return this.sharing_api.update_sf_permissions(this.ns_id,fn,fl,fo)};T.prototype.update_tf_access=function(fm){var fn,fl;fl=(function(fo){return function(fp){if(fm){return ae.success(eA("Team members can now change folder contents."))}else{return ae.success(eA("Team members can no longer change folder contents."))}}})(this);fn=(function(fo){return function(fp){return ae.error(eA("Error updating your preference! Please try again."))}})(this);return this.sharing_api.update_team_folder_access_type(this.ns_id,fm,fl,fn)};T.prototype.show_kick_user_modal=function(fn,fm,fl){return d0.push(new eS(this.user,{element_id:"kick-confirm-modal",ns_id:this.ns_id,user_name:fn,folder_path:this.path,user_id:fl}))};T.prototype.show_kick_group_modal=function(fl,fm){return d0.push(new aS(this.user,{element_id:"kick-group-confirm-modal",ns_id:this.ns_id,group_name:fl,folder_path:this.path,group_id:fm}))};T.prototype.show_transfer_user_modal=function(fn,fm,fl){return d0.push(new bM(this.user,{element_id:"transfer-confirm-modal",user_id:fl,user_name:fn,ns_id:this.ns_id,folder_path:this.path}))};T.prototype.show_uninvite_modal=function(fn,fl,fm){return d0.push(new aH(this.user,{element_id:"uninvite-confirm-modal",email_or_fbname:fn,ns_id:fl,invite_id:fm,folder_path:this.path}))};T.prototype.show_unshare_folder_modal=function(){return d0.push(new b3(this.user,{element_id:"unshare-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};T.prototype.show_access_request_link_modal=function(){return d0.push(new dg(this.user.id,this.path,void 0,true))};T.prototype.show_owner_leave_folder_warning=function(){return ae.error(eA("You can't leave this folder because you're the owner. You must transfer ownership to another member before you can leave."))};T.prototype.show_leave_folder_modal=function(){return d0.push(new dt(this.user,{element_id:"leave-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};T.prototype.toggle_get_link_button_visibility=function(){var fp,fm,fn,fl,fq,fo;fm=((fn=this.invite_form_controller)!=null?fn.get_token_count():void 0)===0;fp=((fl=this.$invite_input)!=null?fl.val():void 0)==="";if(fm&&fp){return(fq=this.get_link_button)!=null?fq.show():void 0}else{return(fo=this.get_link_button)!=null?fo.hide():void 0}};T.prototype.toggle_to_invite_mode=function(){var fl;this.$allow_members_table.show();this.$folder_management_buttons.hide();this.$invite_form.removeClass("collapsed");if((fl=this.sf_access_type)!=null){fl.show()}this.toggle_get_link_button_visibility();if(!this.has_show_invite_form&&this.get_link_button.length>0){ba.SimpleSharingLogger.log(this.user.id,31)}return this.has_show_invite_form=true};T.prototype.toggle_from_invite_mode=function(){var fm,fl;this.$allow_members_table.hide();this.$folder_management_buttons.show();this.$invite_form.addClass("collapsed");if((fm=this.sf_access_type)!=null){fm.hide()}if((fl=this.invite_form_controller)!=null){fl.reset_autocompleter()}return this.toggle_get_link_button_visibility()};T.prototype.show_m2_folder_settings=function(fm){var fn,fl;fl=this.path;fn=function(){var fo;fo=new df(cr.active_user,fl);return fo.show()};d0.pop();return ac.showInstance(dA.createElement(ac,{user:this.user,fq_path:this.path,is_shared_folder:true,ns_id:this.ns_id,initial_allows_editor_manage_membership:this.allows_editor_manage_membership,done_callback:fn}))};T.prototype.show_folder_settings=function(fl){ba.SharedFolderActivityLogger.log("web","invite_modal_change_settings",this.user,this.log_extras);fl.preventDefault();d0.register(ey.SAVED_PERMISSIONS,(function(fm){return function(fo,fn){if(fn!=null){return fm.set_team_only(fn)}}})(this));return d0.push(new ey(this.user,this.path,this.ns_id))};T.prototype.show_golden_gate_warning=function(fl){fl.preventDefault();return d0.push(new c5(this.user,this.ns_id,{element_id:"golden-gate-warning-modal",ns_id:this.ns_id}))};T.prototype.show_email_verification=function(fl){d0.pop();return d3.get_for_user(this.user).show()};T.prototype.set_team_only=function(fl){var fm;this.invite_form_controller.set_team_only(fl);fm=this.$invite_form.add(this.$root.find(".external-invite-message,.member-info .folder-settings"));if(fl){return fm.addClass("team-only")}else{return fm.removeClass("team-only")}};return T})();dt=D.LeaveFolderModal=(function(T){cN(fl,T);function fl(){this.before_show=du(this.before_show,this);this.on_show=du(this.on_show,this);this.on_confirm_button_click=du(this.on_confirm_button_click,this);return fl.__super__.constructor.apply(this,arguments)}fl.prototype.on_confirm_button_click=function(fn){var fm;fn.preventDefault();fm=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.leave_folder(this.ns_id,fm,(function(fo){return function(){var fp;fp=eA("You removed yourself from '%(msg)s'.").format({msg:bU.em_snippet(ay.filename(fo.path),25)});ae.success(fp);document.fire(aF.SF_LEAVE,{target_ns_id:fo.ns_id,folder_deleted:!fm,user_id:fo.user.id});return d0.clear()}})(this))};fl.prototype.on_show=function(){fl.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".keep_files_option").hide();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",false)}else{this.$modal_window.find(".keep_files_option").show();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",true)}};fl.prototype.before_show=function(){var fm;fm=eA("Leave the shared folder '%(folder_name)s'");fm=fm.format({folder_name:bU.em_snippet(ay.filename(this.path),14)});return this.format({".db-modal-title-text":fm})};return fl})(dQ);b3=D.UnshareFolderModal=(function(fl){cN(T,fl);function T(){this.before_show=du(this.before_show,this);this.on_show=du(this.on_show,this);this.on_confirm_button_click=du(this.on_confirm_button_click,this);return T.__super__.constructor.apply(this,arguments)}T.prototype.on_confirm_button_click=function(fn){var fm;fn.preventDefault();fm=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.unshare_folder(this.ns_id,fm,(function(fo){return function(){var fp;fp=eA("Unshared folder '%(folder_name)s'");fp=fp.format({folder_name:bU.em_snippet(ay.filename(fo.path),25)});ae.success(fp);document.fire(aF.SF_UNSHARE,{target_ns_id:fo.ns_id,user_id:fo.user.id});return d0.clear()}})(this))};T.prototype.on_show=function(){T.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".tsf_unshare_desc").show();return this.$modal_window.find(".regular_unshare_desc").hide()}else{this.$modal_window.find(".tsf_unshare_desc").hide();return this.$modal_window.find(".regular_unshare_desc").show()}};T.prototype.before_show=function(){var fm;fm=eA("Unshare '%(folder_name)s'");fm=fm.format({folder_name:bU.em_snippet(ay.filename(this.path),21)});return this.format({".db-modal-title-text":fm})};return T})(dQ);aH=D.UninviteModal=(function(fl){cN(T,fl);function T(fm,fn){this.before_show=du(this.before_show,this);this.on_confirm_button_click=du(this.on_confirm_button_click,this);this.email_or_fbname=fn.email_or_fbname;this.ns_id=fn.ns_id;this.invite_id=fn.invite_id;T.__super__.constructor.call(this,fm,fn)}T.prototype.on_confirm_button_click=function(fm){fm.preventDefault();return this.sharing_api.cancel_invite(this.ns_id,this.invite_id,(function(fn){return function(ft){var fr,fs,fq,fo,fp;fq=JSON.parse(ft.responseText);fo=fq.status;if(fo==="OK"){fp=eA("%(email_or_fbname)s has been uninvited.").format({email_or_fbname:fn.email_or_fbname});ae.success(fp)}else{fs=fq.reason;if(fs==="ACCEPTED"){fr=eA("That invitation has already been accepted.")}else{if(fs==="DECLINED"){fr=eA("That invitation has already been declined.")}}ae.error(fr)}return d0.pop()}})(this))};T.prototype.before_show=function(fm){var fn;fn=eA("Uninvite %(email_or_fbname)s?").format({email_or_fbname:bU.em_snippet(this.email_or_fbname,20)});return this.format({".uninvite-confirm-nickname":this.email_or_fbname,".uninvite-confirm-folder-name":ay.filename(this.path),".db-modal-title-text":fn})};return T})(dQ);eS=D.KickUserModal=(function(T){cN(fl,T);function fl(fm,fn){this.user=fm;this.options=fn;this.before_show=du(this.before_show,this);this.on_confirm_button_click=du(this.on_confirm_button_click,this);this.user_id=fn.user_id;this.user_name=fn.user_name;fl.__super__.constructor.call(this,fm,fn)}fl.prototype.on_confirm_button_click=function(fo){var fm,fn;fo.preventDefault();fm=this.$modal_window.find("#keep-files-check").prop("checked");this.sharing_api.kick(this.ns_id,this.user_id,fm,(function(fp){return function(){ae.success(eA("User removed successfully."));bZ.reload_folder_info_if_two_account();return d0.pop()}})(this));fn={ns_id:this.ns_id,kick_user_id:this.user_id,keep_files:fm};return ba.SharedFolderActivityLogger.log("web","invite_modal_kick_collaborator",this.user,fn)};fl.prototype.before_show=function(fm){var fn;fn=eA("Remove %(person_name)s from this folder?");fn=fn.format({person_name:this.user_name});return this.format({".kick-confirm-nickname":this.user_name,".db-modal-title-text":fn})};return fl})(dQ);aS=D.KickGroupModal=(function(T){cN(fl,T);function fl(fm,fn){this.user=fm;this.options=fn;this.before_show=du(this.before_show,this);this.on_confirm_button_click=du(this.on_confirm_button_click,this);this.group_id=fn.group_id;this.group_name=fn.group_name;fl.__super__.constructor.call(this,fm,fn)}fl.prototype.on_confirm_button_click=function(fm){fm.preventDefault();return __CIRCULAR_DEPENDENCY__.GroupsApi.remove_namespace_from_group({group_id:this.group_id,ns_id:this.ns_id},(function(fn){return function(){ae.success(eA("Group removed successfully."));bZ.reload_folder_info_if_two_account();return d0.pop()}})(this))};fl.prototype.before_show=function(){var fm;fm=eA("Remove %(group_name)s from this folder?");fm=fm.format({group_name:this.group_name});return this.format({".kick-confirm-nickname":this.group_name,".db-modal-title-text":fm})};return fl})(dQ);cu=D.MakeOwnerModal=(function(fl){cN(T,fl);function T(fm,fn){this.user=fm;this.options=fn;this.before_show=du(this.before_show,this);this.on_confirm_button_click=du(this.on_confirm_button_click,this);this.member_uid=fn.member_uid;this.member_name=fn.member_name;this.ns_id=fn.ns_id;this.access_type=fn.access_type;T.__super__.constructor.call(this,fm,fn)}T.prototype.on_confirm_button_click=function(fm){fm.preventDefault();return this.sharing_api.update_member_access_type(this.ns_id,this.member_uid,this.access_type,(function(fn){return function(){ae.success(eA("%(name)s now is the owner.").format({name:fn.member_name}));return d0.pop()}})(this))};T.prototype.before_show=function(){var fm;fm=eA("Make %(name)s the owner of this folder?");fm=fm.format({name:bU.em_snippet(this.member_name,14)});return this.format({".make-owner-confirm-nickname":this.member_name,".db-modal-title-text":fm})};return T})(dQ);bM=D.TransferOwnershipModal=(function(fl){cN(T,fl);function T(fm,fn){this.user=fm;this.options=fn;this.before_show=du(this.before_show,this);this.on_confirm_button_click=du(this.on_confirm_button_click,this);this.user_id=fn.user_id;this.user_name=fn.user_name;T.__super__.constructor.call(this,fm,fn)}T.prototype.on_confirm_button_click=function(fm){fm.preventDefault();return this.sharing_api.transfer_ownership(this.ns_id,this.user_id,(function(fn){return function(fo){ae.success(eA("Ownership changed successfully"));return d0.pop()}})(this))};T.prototype.before_show=function(){var fm;fm=eA("Make %(person_name)s the owner of this folder?");fm=fm.format({person_name:bU.em_snippet(this.user_name,14)});return this.format({".change_sf_owner-confirm-nickname":this.user_name,".db-modal-title-text":fm})};return T})(dQ);ey=D.ExistingSharedFolderPermissionsModal=(function(fl){cN(T,fl);T.SAVED_PERMISSIONS="existing_sf_permissions:saved";function T(fn,fo,fm,fr){var fq,fp;this.user=fn;this.path=fo;this.ns_id=fm;this.on_hide=fr;fq={ns_id:this.ns_id,folder_name:this.path};fq[Constants.UID_PARAM_NAME]=this.user.id;fp=eA("'%(folder_name)s' settings");fp=fp.format({folder_name:bU.em_snippet(ay.filename(this.path),13)});T.__super__.constructor.call(this,{element_id:"folder-permissions-modal",title:fp,endpoint_url:"/share_ajax/folder_settings",parameters:fq})}return T})(cB);c5=c5=(function(T){cN(fl,T);function fl(fn,fm){var fp,fo;this.user=fn;this.ns_id=fm;fp={ns_id:this.ns_id};fp[Constants.UID_PARAM_NAME]=this.user.id;fo=eA("Confirm converting to Golden Gate folder");fl.__super__.constructor.call(this,{element_id:"golden-gate-warning-modal",title:fo,endpoint_url:"/share_ajax/golden_gate_warning",parameters:fp})}return fl})(cB);dz=D.GoldenGateWarningModalContents=(function(){function T(fm,fn,fl){this.$form=fm;this.ns_id=fl;this._submit=du(this._submit,this);this.user=cK.get_viewer().get_user_by_id(fn);this._listen()}T.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};T.prototype._submit=function(fl){return d0.push(new bv(this.user,this.ns_id,{element_id:"golden-gate-warning-modal",ns_id:this.ns_id}))};T.prototype._cancel=function(fl){return d0.pop()};return T})();bv=bv=(function(fl){cN(T,fl);function T(fn,fm){var fp,fo;this.user=fn;this.ns_id=fm;fp={ns_id:this.ns_id};fp[Constants.UID_PARAM_NAME]=this.user.id;fo=eA("Confirm converting to Golden Gate folder");T.__super__.constructor.call(this,{element_id:"golden-gate-warning-modal",title:fo,endpoint_url:"/share_ajax/golden_gate_confirm",parameters:fp})}return T})(cB);fd=D.GoldenGateConfirmModalContents=(function(fl){cN(T,fl);function T(fn,fo,fm){this.$form=fn;this.ns_id=fm;this.user=cK.get_viewer().get_user_by_id(fo);new cf(this.$form,null,{should_submit_once:true});this.$form.on(cf.SUCCESS_EVENT,(function(fp){return function(){return cC.WebRequest({url:"/share_ajax/enable_golden_gate_step_two",subject_user:fp.user,data:{ns_id:fp.ns_id},success:function(){ae.success("Golden Gate enabled for this folder");return location.reload()}})}})(this));this._listen()}T.prototype._listen=function(){return this.$form.find(".cancel-button").click(this._cancel)};T.prototype._cancel=function(fm){return d0.pop()};return T})(cB);Q=D.ExistingSharedFolderPermissionsContent=(function(){function T(fm,fn,fl){this.$form=fm;this.ns_id=fl;this._submit=du(this._submit,this);this.user=cK.get_viewer().get_user_by_id(fn);this.sharing_api=new bl(this.user);this.sharing_api.loading_elem=this.$form;this._listen()}T.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};T.prototype._cancel=function(){return d0.pop()};T.prototype._submit=function(fq){var fr,fl,fo,fn,fm,fp;fq.preventDefault();fl=this.$form.find("input[name=audience]:checked").val();fo=this.$form.find("input[name=inviter]:checked").val();fm=this.$form.find("input[name=shared_link_policy]:checked").val();fr=(fp=this.$form.find("input[name=activity_feed_enabled]:checked"))!=null?fp.val():void 0;this.sharing_api.update_sf_team_permissions(this.ns_id,fl,fo,fm,fr,(function(fs){return function(fu){var ft,fv;ft=JSON.parse(fu.responseText);fv=ft.team_only_invite;ae.success(ft.message);d0.trigger(ey.SAVED_PERMISSIONS,fv);return d0.pop()}})(this));false;fn={ns_id:this.ns_id,audience:fl,inviter:fo};return ba.SharedFolderActivityLogger.log("web","settings_modal_save",this.user,fn)};return T})();var a0,d6,eV,dY,a1,eL,cn,cz,er,da,cd,bS,cX,cW,cU,cS,au={}.hasOwnProperty,cN=function(fn,fl){for(var T in fl){if(au.call(fl,T)){fn[T]=fl[T]}}function fm(){this.constructor=fn}fm.prototype=fl.prototype;fn.prototype=new fm();fn.__super__=fl.prototype;return fn},du=function(T,fl){return function(){return T.apply(fl,arguments)}};a0=D.BaseShareAFolderWizardModal=(function(T){cN(fl,T);fl.prototype.base_title=null;fl.prototype.personal_title=null;fl.prototype.work_title=null;function fl(fm,fn){this.user=fm;this.options=fn;fl.__super__.constructor.call(this,this.options);this.sharing_api=new bl(this.user)}fl.prototype.before_show=function(){var fm;this.sharing_api.loading_elem=this.$modal_window;fm=this.base_title;if(cK.get_viewer().is_paired){if(this.user.role==="personal"){fm=this.personal_title}else{fm=this.work_title.format({team_name:cK.get_viewer().team_name})}}return this.format({".db-modal-title-text":fm})};return fl})(d7);er=D.ShareAFolderWizardModal=(function(T){cN(fl,T);function fl(fm,fn){this.user=fm;this.options=fn;fl.__super__.constructor.call(this,this.user,this.options);this.base_title=eA("Share a folder");this.personal_title=eA("Share a folder from your personal Dropbox");this.work_title=eA("Share a folder from your %(team_name)s Dropbox")}fl.prototype.on_show=function(){this.$modal_window.find("input#create-new-sf").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(fm){return function(fn){fn.preventDefault();r.start_wizard_without_user();return fm.hide()}})(this));return this.$modal_window.find("#new-or-existing-sf li").on("click",(function(fm){return function(fn){bE(fn.currentTarget).find('input[name="sf_type"]').prop("checked",true);if(fm.$modal_window.find("input#create-new-sf").is(":checked")){return ba.SharedFolderActivityLogger.log("web","new_or_existing_modal_new_folder",fm.user)}else{return ba.SharedFolderActivityLogger.log("web","new_or_existing_modal_existing_folder",fm.user)}}})(this))};fl.prototype.on_confirm_button_click=function(fs){var fp,fr,fm,fo,fq,fn;fs.preventDefault();fr=this.$modal_window.find("input#create-new-sf").is(":checked");if(fr){fo=null;if(this.user.role==="work"){fq="shared-folder-type-wizard-modal";fn=d7.get_template(fq);if(fn.length){fo=new bS(this.user,{element_id:fq})}}if(fo===null){fo=new cd(this.user,{element_id:"share-new-folder-wizard-modal"})}this.hide();fm={selection:"new_folder"};ba.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,fm);return fo.show()}fp=this.$modal_window.find(".ajax-loading-indicator").show();return bE.ajax({url:"/share_ajax/account_has_existing_folders",type:"post",subject_user:this.user,success:(function(ft){return function(fu){var fv;fu=JSON.parse(fu);if(fu===true){fo=new da(ft.user,{element_id:"share-existing-folder-wizard-modal"});fm.has_existing_folder=true}else{fv=eA("You don't have any existing folders. Please create and share a new folder.");fo=new cd(ft.user,{element_id:"share-new-folder-wizard-modal",error_msg:fv});fm.has_existing_folder=false}ft.hide();return fo.show()}})(this),error:(function(ft){return function(){return ae.error()}})(this),complete:(function(ft){return function(){return fp.hide()}})(this)},fm={selection:"existing_folder"},ba.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,fm))};return fl})(a0);bS=D.SharedFolderTypeWizardModal=(function(fl){cN(T,fl);function T(fm,fn){this.user=fm;this.options=fn;T.__super__.constructor.call(this,this.user,this.options);this.work_title=eA("Share a folder from your %(team_name)s Dropbox")}T.prototype.on_show=function(){this.$modal_window.find("input#team-folder-option").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(fm){return function(fn){fn.preventDefault();r.start_wizard_for_user(fm.user);return fm.hide()}})(this));return this.$modal_window.find("#shared-folder-type li").on("click",(function(fm){return function(fn){bE(fn.currentTarget).find('input[name="shared_folder_type"]').prop("checked",true);if(fm.$modal_window.find("input#team-folder-option").is(":checked")){return ba.SharedFolderActivityLogger.log("web","shared_folder_type_team_folder",fm.user)}else{return ba.SharedFolderActivityLogger.log("web","shared_folder_type_shared_folder",fm.user)}}})(this))};T.prototype.on_confirm_button_click=function(fq){var fm,fo,fp,fn;fq.preventDefault();fm=(function(fr){return function(fu,fs){var ft;fu.preventDefault();fs.hide();ft=new fr.constructor(fr.user,fr.options);return ft.show()}})(this);fo=this.$modal_window.find("input#team-folder-option").is(":checked");if(fo){fp=new dW({element_id:"new-team-folder-modal",open_created_folder:true,back_fn:fm});fn="team_folder"}else{fp=new cd(this.user,{element_id:"share-new-folder-wizard-modal",back_fn:fm});fn="shared_folder"}ba.SharedFolderActivityLogger.log("web","shared_folder_type_next_button",this.user,{selection:fn});this.hide();return fp.show()};return T})(a0);eL=D.InlineModalValidationError=(function(){function T(){}T.show_validation_error=function(fs,fo){var fp,fq,fn,fm,fr,fl;if(fs.responseText.indexOf("err:{")===0){fl=fs.responseText.substr(4);fr=JSON.parse(fl);for(fq in fr){fp=fr[fq];if("message_text" in fp){fm=fo.find("span.error-message");if(fm.length===0){fm=bE("<span/>").addClass("error-message");fo.prepend(fm)}fm.text(fp.message_text);return}}fo.find("span.error-message").remove();return ae.error()}else{fo.find("span.error-message").remove();if(fs.responseText.indexOf("err:")===0){fn=fs.responseText.substr(4);return ae.error(fn)}else{return ae.error()}}};return T})();cX=D.TeamSharedFolderWizardModalPage1=(function(T){cN(fl,T);function fl(fm,fn){this.user=fm;this.options=fn;this.__fix_position=du(this.__fix_position,this);fl.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page1 input[type=text]";this.base_title=eA("Now, let's set up your team");this.options.vertical_offset=5}fl.prototype.on_show=function(){var fn,fp,fm,fo;fo=this.$modal_window.find(".suggestion-input");for(fp=0,fm=fo.length;fp<fm;fp++){fn=fo[fp];c4.register($(fn))}this.$modal_window.find("#validate-team-name").submit((function(fq){return function(fr){fr.preventDefault();return fq.on_confirm_button_click(fr)}})(this));if(this.options.error_msg){ae.error(this.options.error_msg)}return ba.SharedFolderActivityLogger.log("web","team_shared_group_name_land",this.user)};fl.prototype.on_confirm_button_click=function(fp){var fn,fm,fo;fp.preventDefault();fo=this.$modal_window.find("#new-team-shared-folder-name-input").val();fm=(function(fq){return function(){var fr;fr=new cW(fq.user,{team_name:fo,element_id:"team-shared-folder-wizard-modal-page2"});fq.hide();return fr.show()}})(this);fn=(function(fq){return function(fr){ba.SharedFolderActivityLogger.log("web","team_shared_group_name_folder_exists",fq.user);return eL.show_validation_error(fr,fq.$modal_window.find("#validate-team-name"))}})(this);return this.sharing_api.validate_new_sf_path(fo,fm,fn)};fl.prototype.__fix_position=function(fn){var fm;fm=this.$modal_window.find(".db-modal");return fm.css({margin:"0",position:"fixed"})};return fl})(a0);cW=D.TeamSharedFolderWizardModalPage2=(function(T){cN(fl,T);function fl(fm,fn){this.user=fm;this.options=fn;this.__fix_position=du(this.__fix_position,this);this.on_confirm_button_click=du(this.on_confirm_button_click,this);fl.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-email1 input[type=text]";this.base_title=eA("Invite teammates");this.folder_name=this.options.team_name}fl.prototype.before_show=function(){var fm;fm=eA("Add people to %(folder_name)s").format({folder_name:this.folder_name});return this.format({"#figcaption_headline":fm})};fl.prototype.on_show=function(){ba.SharedFolderActivityLogger.log("web","team_shared_group_emails_land",this.user);return this.$modal_window.find("#enter-email-invites").submit((function(fm){return function(fn){fn.preventDefault();return fm.on_confirm_button_click(fn)}})(this))};fl.prototype.on_confirm_button_click=function(fq){var fo,fn,fs,fm,fr,fp;fq.preventDefault();fs={emails:[]};ba.SharedFolderActivityLogger.log("web","team_shared_group_emails_submit",this.user);for(fm=fp=1;fp<=10;fm=++fp){fo=this.$modal_window.find("#new-team-shared-folder-email"+fm).val();if(fo){fs.emails.push(fo)}}fn=d3.getForRole(cr.active_user.role);if(!fn.verified_or_show()){ba.SharedFolderActivityLogger.log("web","team_shared_group_not_email_verified",this.user);return fn.send_email("share_folder",(function(ft){return function(){var fu;fu=new cU(ft.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:ft.folder_name,invitees:fs,from_email_verification:true});ft.hide();return fu.show()}})(this))}else{ba.SharedFolderActivityLogger.log("web","team_shared_group_email_verified",this.user);fr=new cU(this.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:this.folder_name,invitees:fs,from_email_verification:true});this.hide();return fr.show()}};fl.prototype.__fix_position=function(fn){var fm;fm=this.$modal_window.find(".db-modal");fm.css;return{margin:"0",position:"fixed"}};return fl})(a0);cU=D.TeamSharedFolderWizardModalPage3=(function(fl){cN(T,fl);function T(fm,fn){this.user=fm;this.options=fn;this.__fix_position=du(this.__fix_position,this);T.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page3 input[type=text]";this.base_title=eA("Creating %(folder_name)s team and sending invites!").format({folder_name:this.options.folder_name})}T.prototype.on_show=function(){var fr,fp,fo,fn,ft,fs,fq,fm;ba.SharedFolderActivityLogger.log("web","team_shared_group_interstitial",this.user);this.$modal_window.find("#db-modal-close-x").click((function(fu){return function(fv){fv.preventDefault();return fu.on_close_button_click(fv)}})(this));ft="";fs=true;fp=false;fn="all";fq=false;fr=null;fm=(function(fu){return function(fx){var fv,fw;fv=JSON.parse(fx.responseText);ae.success(fv.success_msg);fw=new cS(fu.user,{element_id:"team-shared-folder-wizard-modal-page4",folder_name:fu.options.folder_name,invitees:fu.options.invitees,from_email_verification:true});fu.hide();return fw.show()}})(this);fo=(function(fu){return function(fv){return fu.hide()}})(this);return this.sharing_api.share_folder(fs,this.options.folder_name,this.options.invitees,ft,fp,fn,fq,fr,false,fm,fo)};T.prototype.on_confirm_button_click=function(fm){fm.preventDefault();return this.hide()};T.prototype.__fix_position=function(fn){var fm;fm=this.$modal_window.find(".db-modal");return fm.css({margin:"0",position:"fixed"})};return T})(a0);cS=D.TeamSharedFolderWizardModalPage4=(function(fl){cN(T,fl);function T(fm,fn){this.user=fm;this.options=fn;this.__fix_position=du(this.__fix_position,this);T.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page4 input[type=text]";this.base_title=eA("%(folder_name)s created and invites sent!").format({folder_name:this.options.folder_name})}T.prototype.before_show=function(){var fm;fm=this.$modal_window.find("#back_to_home");fm.attr("href","/home/"+this.options.folder_name);return this.format({"#figcaption_headline":this.base_title})};T.prototype.on_show=function(){return ba.SharedFolderActivityLogger.log("web","team_shared_group_final",this.user)};T.prototype.__fix_position=function(fn){var fm;fm=this.$modal_window.find(".db-modal");return fm.css({margin:"0",position:"fixed"})};return T})(a0);cd=D.ShareNewFolderWizardModal=(function(fl){cN(T,fl);function T(fm,fn){this.user=fm;this.options=fn;this.options.focus="#new-shared-folder-wizard input[type=text]";T.__super__.constructor.call(this,this.user,this.options);this.base_title=eA("Create a new shared folder");this.personal_title=eA("Create a shared folder in your personal Dropbox");this.work_title=eA("Create a shared folder in your %(team_name)s Dropbox")}T.prototype.on_show=function(){var fn,fp,fm,fo;fo=this.$modal_window.find(".suggestion-input");for(fp=0,fm=fo.length;fp<fm;fp++){fn=fo[fp];c4.register($(fn))}this.$modal_window.find("#validate-folder-name").submit((function(fq){return function(fr){fr.preventDefault();return fq.on_confirm_button_click(fr)}})(this));if(this.options.error_msg){ae.error(this.options.error_msg)}return this.$modal_window.find("a.back").on("click",(function(fq){return function(fr){if(fq.options.back_fn){return fq.options.back_fn(fr,fq)}else{fr.preventDefault();fq.hide();return r.start_wizard_for_user(fq.user)}}})(this))};T.prototype.on_confirm_button_click=function(fp){var fo,fq,fn,fm;fp.preventDefault();fq=this.$modal_window.find("#new-shared-folder-name-input").val();fn={folder_name:fq};ba.SharedFolderActivityLogger.log("web","name_new_folder_modal_next_button",this.user,fn);bE(document).trigger("db:share_new_folder:next");fm=(function(fr){return function(){var fs;fs=new cn(fr.user,{folder_name:fq,element_id:"invite-to-new-sf-wizard-modal-"+fr.user.id});fr.hide();fs.new_folder=true;fs.show();return ba.SharedFolderActivityLogger.log("web","name_new_folder_modal_success",fr.user,fn)}})(this);fo=(function(fr){return function(fs){var ft;ft=cf.extract_errors(fs.responseText);ba.SharedFolderActivityLogger.log("web","name_new_folder_modal_fail",fr.user,fn);if(ft===false){}else{if(typeof ft==="string"){return ae.error(ft)}else{bE("#new-shared-folder-name-input .error-message").remove();return cf.fill_errors(bE("#validate-folder-name"),ft)}}}})(this);return this.sharing_api.validate_new_sf_path(fq,fm,fo)};return T})(a0);da=D.ShareExistingFolderWizardModal=(function(fl){cN(T,fl);function T(fm,fn){this.user=fm;this.options=fn;this._hide=du(this._hide,this);this.on_show=du(this.on_show,this);T.__super__.constructor.call(this,this.user,this.options);this.base_title=eA("Choose folder to share");this.personal_title=eA("Choose a folder from your personal Dropbox");this.work_title=eA("Choose a folder from your %(team_name)s Dropbox")}T.prototype.on_show=function(){this.treeview_id="copy-move-treeview";this.treeview_parent_id=bE("#"+this.treeview_id).parent().attr("id");b2.schedule_reset();b2.move(this.treeview_id,"share-existing-treeview",{onSuccess:((function(fm){return function(){var fn;bE(document).on("db:treeview_selected",function(fp,fo){return fm.folder_name=fo});fn=bE(".first-treeview-link");if(!d5.ie){return fn.click()}}})(this)),user:this.user});return this.$modal_window.find("a.back").on("click",(function(fm){return function(fn){fn.preventDefault();fm.hide();return r.start_wizard_for_user(fm.user)}})(this))};T.prototype._hide=function(){b2.move(this.treeview_id,this.treeview_parent_id,{user:this.user});return T.__super__._hide.apply(this,arguments)};T.prototype.on_hide=function(){return bE(document).off("db:treeview_selected")};T.prototype.on_confirm_button_click=function(fp){var fo,fn,fm;fn={folder_name:this.folder_name};fp.preventDefault();if(this.folder_name&&this.$modal_window.find("#copy-move-treeview .highlight .s_web_folder_user").length){this.hide();ba.SharedFolderActivityLogger.log("web","choose_folder_modal_shared_next",this.user,fn);return r.show_shared_folder_options_modal(this.folder_name,this.user)}else{fm=(function(fq){return function(){var fr;fr=new cn(fq.user,{folder_name:fq.folder_name,element_id:"invite-to-new-sf-wizard-modal-"+fq.user.id});fq.hide();ba.SharedFolderActivityLogger.log("web","choose_folder_modal_not_shared_next",fq.user,fn);fr.new_folder=false;return fr.show()}})(this);fo=(function(fq){return function(fr){return eL.show_validation_error(fr,fq.$modal_window.find("#choose-existing-folder"))}})(this);return this.sharing_api.validate_existing_sf_path(this.folder_name,fm,fo)}};return T})(a0);a1=D.CreateOrShareNewFolderWizardModal=(function(fl){cN(T,fl);function T(fm,fn){this.user=fm;this.options=fn;this.on_confirm_button_click=du(this.on_confirm_button_click,this);this._extract_invitees=du(this._extract_invitees,this);this._toggle_send_button_state=du(this._toggle_send_button_state,this);T.__super__.constructor.call(this,this.options);this.destination_dir=this.options.destination_dir;this.sharing_api=new bl(this.user);this.state="Create"}T.prototype.on_show=function(){var fn,fo,fq,fp,fm;this.$send_button=this.$modal_window.find(".confirm-button");this.$cancel_button=this.$modal_window.find(".cancel-button");fq="create-and-share-new-folder-invite-wizard-"+this.user.id;this.file_name_input=this.$modal_window.find("#create-and-share-new-folder-name-input");this.file_name_input.focus();fo=fq+"-new-collab-input";this.collab_input=this.$modal_window.find("#"+fo);fn={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:this.user.id,max_textbox_height:30};this.autocompleter=new Autocompleter.ContactsTokenizer(this.user,fo,fq+"-new-whobulk",fq+"-hidden-input",fn);if((fp=this.file_name_input)!=null){fp.keyup(this._toggle_send_button_state)}if((fm=this.collab_input)!=null){fm.keyup(this._toggle_send_button_state)}if(this.collab_input[0]){this.collab_input[0].on("token:remove",this._toggle_send_button_state);this.collab_input[0].on("token:add",this._toggle_send_button_state)}return this._toggle_send_button_state()};T.prototype._toggle_send_button_state=function(){var fo,fn,fm,fp;fm=((fp=this.autocompleter)!=null?fp.token_manager.tokens.length:void 0)===0;fm=fm&&this.collab_input.val()==="";fo=this.file_name_input.val();fn=fo==="";this.$send_button.prop("disabled",fn);if(fm){this.$send_button.text(eA("Create folder"));return this.state="Create"}else{this.$send_button.text(eA("Share folder"));return this.state="Share"}};T.prototype._extract_invitees=function(){var fq,fo,fp,fn,ft,fs,fm,fr;fp=this.$modal_window.find(".tokenized_autocompleter_container");ft={};fr=["emails","fb_ids","group_ids","new_style_group_ids"];for(fs=0,fm=fr.length;fs<fm;fs++){fo=fr[fs];fn=fp.find("input[name="+fo+"]");ft[fo]=(function(){var fw,fv,fu;fu=[];for(fw=0,fv=fn.length;fw<fv;fw++){fq=fn[fw];fu.push(bE(fq).val())}return fu})()}return ft};T.prototype.on_confirm_button_click=function(fx){var fo,fu,fr,fz,fs,fv,fp,fq,fm,ft,fw,fy,fn;fx.preventDefault();fm=this.file_name_input.val();fz=eA("We can\u2019t create folder '%(folder_name)s'");fz=fz.format({folder_name:fm});fr=function(){return ae.error(fz)};if(this.state==="Create"){fn="/cmd/new"+d5.urlquote(this.destination_dir);ft={to_path:fm};ft[Constants.UID_PARAM_NAME]=this.user.id;fy=function(){var fA;fA=eA("Created new folder '%(folder_name)s'");fA=fA.format({folder_name:fm});return ae.success(fA)};new cC.WebRequest({url:fn,data:ft,success:fy,error:fr})}else{this.autocompleter.tokenize_emails_input(true);fv=this._extract_invitees();fy=function(){var fA;fA=eA("Shared new folder '%(folder_name)s'");fA=fA.format({folder_name:fm});return ae.success(fA)};fq="";fu=false;fp="all";fw=false;fo=null;fs=this.destination_dir+"/"+fm;this.sharing_api.share_path(fs,fv,fq,fu,fp,fw,fo,false,fy,fr)}return this.hide()};return T})(d7);dY=D.CreateLinkOrInviteToFolderWizardModal=(function(fl){cN(T,fl);function T(fm,fn){this.user=fm;this.options=fn;T.__super__.constructor.call(this,this.options);this.sharing_api=new bl(this.user)}T.prototype.before_show=function(){var fm;this.sharing_api.loading_elem=this.$modal_window;fm=eA("Share '%(folder_name)s' with others");fm=fm.format({folder_name:bU.em_snippet(ay.filename(this.options.path),16)});return this.format({".db-modal-title-text":fm})};T.prototype.on_show=function(){var fm,fo,fn;fm="edu_modal";fo=(fn=this.options.target_item)!=null?fn:null;ba.ShmodelUILogger.log("view",fm,fo);this.$modal_window.find(".option-to-share-folder").on("click",(function(fp){return function(fr){var fq;if(fp.options.existing_sf){ba.ShmodelUILogger.log("sf_options",fm,fo);fq=new df(cr.active_user,fp.options.path)}else{ba.ShmodelUILogger.log("sf_invite",fm,fo);fq=new cn(fp.user,{folder_name:fp.options.path,element_id:"invite-to-new-sf-wizard-modal-"+fp.user.id})}fp.hide();return fq.show()}})(this));this.$modal_window.find(".option-to-share-link").on("click",(function(fp){return function(fq){ba.ShmodelUILogger.log("token_share",fm,fo);dv.shmodel(fp.options.path,"create_link_or_invite_to_folder_modal");return fp.hide()}})(this));return this.$modal_window.find(".learn-more").on("click",(function(fp){return function(fq){fq.preventDefault();ba.ShmodelUILogger.log("clicked_learn_more",fm,fo);return window.open("/help/274","_blank")}})(this))};return T})(d7);cn=D.InviteToNewSharedFolderWizardModal=(function(fl){cN(T,fl);function T(fm,fn){this.user=fm;this.options=fn;this.insert_folder_settings=du(this.insert_folder_settings,this);this.share_folder=du(this.share_folder,this);this.on_confirm_button_click=du(this.on_confirm_button_click,this);this.show_settings_modal=du(this.show_settings_modal,this);this.show_m2_settings_modal=du(this.show_m2_settings_modal,this);this._toggle_get_link_button_visibility=du(this._toggle_get_link_button_visibility,this);this.options.focus=".new-collab-input";T.__super__.constructor.call(this,this.options);this.sharing_api=new bl(this.user);this.folder_name=this.options.folder_name;this.is_file=this.options.is_file;this.must_check_verified=(this.options.must_check_verified!=null)||false;this.progress_ever_blocked_by_verify=false;this.has_inviter_restriction=this.options.has_inviter_restriction}T.prototype.before_show=function(){var fm;this.sharing_api.loading_elem=this.$modal_window;fm=eA("Share '%(folder_name)s' with others");fm=fm.format({folder_name:bU.em_snippet(ay.filename(this.folder_name),16)});return this.format({".db-modal-title-text":fm})};T.prototype.on_show=function(){var fn,fo,fr,fq,fm,fp;fp=this.$modal_window.find(".suggestion-input");for(fq=0,fm=fp.length;fq<fm;fq++){fo=fp[fq];c4.register($(fo))}fn=this.$modal_window.find(".invite-more-form");if(!this.invite_form_controller){fr="invite-wizard-"+this.user.id;this.invite_form_controller=new de(this.user,fn,[],[],[],fr);if(this.invite_form_controller.team_only){this.insert_folder_settings("team")}}else{this.invite_form_controller.listen()}this.get_link_button=this.$modal_window.find(".get-editable-link-invite");if(this.get_link_button.length>0){ba.SimpleSharingLogger.log(this.user.id,27)}this.collab_input=this.$modal_window.find(".new-collab-input");this.collab_input.focus();this.collab_input.keyup(this._toggle_get_link_button_visibility);if(this.collab_input[0]){this.collab_input[0].on("token:remove",this._toggle_get_link_button_visibility);this.collab_input[0].on("token:add",this._toggle_get_link_button_visibility)}this.$modal_window.find(".change-new-folder-settings").on("click",(function(fs){return function(ft){ft.preventDefault();return fs.show_settings_modal()}})(this));this.$modal_window.find(".m2-settings-link").on("click",(function(fs){return function(ft){ft.preventDefault();return fs.show_m2_settings_modal()}})(this));this.$modal_window.find(".get-editable-link-invite").on("click",(function(fs){return function(fx){var fy,fw,fu,ft,fv;fx.preventDefault();ft=fs.$modal_window.find(".m2-settings-link");if(ft.length>0){fs.inviter_restriction=fs.has_inviter_restriction?"me":"all"}ba.SimpleSharingLogger.log(fs.user.id,28);fy=fs.$modal_window.find(".get-link-invite-loading");if(fy!=null){fy.show()}fv=function(fA){var fC,fB,fE,fD,fz,fF;if(fy!=null){fy.hide()}fz=bb.parse_response(fA),fD=fz[0],fE=fz[1];if(fD){return eF.createAndShowM2InbandModal(fs.user,fs.folder_name)}else{fF=bb.parse_error(fE),fB=fF[0],fC=fF[1];if(fB){return ae.error(fC)}else{return ae.error(eA("Failed to create link."))}}};fu=function(){if(fy!=null){fy.hide()}return ae.error(eA("Failed to create link."))};fw={path:fs.folder_name,emails:[],fb_ids:[],new_style_group_ids:[],custom_message:"",access_type:2,is_simple_sharing:true,folder_settings:1,shared_link_policy:fs.shared_link_policy_restriction,audience:fs.audience_restriction,inviter:fs.inviter_restriction};if(fs.audience_restriction||fs.inviter_restriction){fw.custom_folder_settings=1}return cC.FormWebRequest({subject_user:fs.user.id,url:"/share_ajax/existing_no_recipient",data:fw,success:fv.bind(fs),error:fu.bind(fs)})}})(this));this.log_extras={path:this.folder_name};ba.SharedFolderActivityLogger.log("web","share_folder_modal_displayed",this.user,this.log_extras);if(this.is_file){return ba.SharedFolderActivityLogger.log("web","single_file_unshared_invite_modal_displayed",this.user,this.log_extras)}};T.prototype._toggle_get_link_button_visibility=function(){var fp,fn,fo,fm,fq;if(this.shared_link_policy_restriction==="1"){if((fo=this.get_link_button)!=null){fo.hide()}return}fn=this.invite_form_controller.get_token_count()===0;fp=this.collab_input.val()==="";if(fn&&fp){return(fm=this.get_link_button)!=null?fm.show():void 0}else{return(fq=this.get_link_button)!=null?fq.hide():void 0}};T.prototype.show_m2_settings_modal=function(){var fn,fm;fn=this.folder_name;fm=function(fo){var fp;fp=new T(cr.active_user,{folder_name:fn,element_id:"invite-to-new-share-file-wizard-modal-"+cr.active_user.id,has_inviter_restriction:!fo});return fp.show()};d0.pop();return ac.showInstance(dA.createElement(ac,{user:this.user,fq_path:this.folder_name,is_shared_folder:false,initial_allows_editor_manage_membership:!this.has_inviter_restriction,done_callback:fm}))};T.prototype.show_settings_modal=function(){var fn,fm;fm=eA("'%(folder_name)s' settings");fm=fm.format({folder_name:bU.em_snippet(ay.filename(this.folder_name),13)});fn={folder_name:this.folder_name};if(this.audience_restriction){fn.audience=this.audience_restriction}if(this.inviter_restriction){fn.inviter=this.inviter_restriction}if(this.shared_link_policy_restriction){fn.shared_link_policy=this.shared_link_policy_restriction}fn[Constants.UID_PARAM_NAME]=this.user.id;if(this.is_file){fn.is_file=this.is_file}d0.register(cz.SAVED_PERMISSIONS,(function(fo){return function(fq,fp){fo.insert_folder_settings(fp.audience,fp.inviter,fp.shared_link_policy);return fo.invite_form_controller.reset_options()}})(this));return d0.push(new cB({element_id:"folder-permissions-modal",title:fm,endpoint_url:"/share_ajax/default_folder_settings",parameters:fn}))};T.prototype.on_confirm_button_click=function(fq){var fp,fo,fs,fn,fm,fr;fq.preventDefault();this.invite_form_controller.tokenize();fs=this.invite_form_controller.extract_invitees();fr=this.invite_form_controller.get_custom_message();fp=this.invite_form_controller.get_access_type();fn=this.$modal_window.find("input#allow_other_members_to_share");if(fn.length>0){this.inviter_restriction=fn.is(":checked")?"all":"me"}fm=this.$modal_window.find(".m2-settings-link");if(fm.length>0){this.inviter_restriction=this.has_inviter_restriction?"me":"all"}if(this.is_file){fo=new eV(this.user,{element_id:"confirm-share-new-file-wizard-modal",invitees:fs,msg:fr,access_type:fp,audience_restriction:this.audience_restriction,inviter_restriction:this.inviter_restriction,shared_link_policy_restriction:this.shared_link_policy_restriction,file_path:this.folder_name});this.hide();fo.show();return ba.SharedFolderActivityLogger.log("web","single_file_unshared_invite_modal_continued",this.user,this.log_extras)}else{return this.share_folder(fs,fr,fp,true,false)}};T.prototype.share_folder=function(fr,fo,fm,fs,fq,fn){var fw,fp,ft,fv,fu;if(fs==null){fs=true}if(fq==null){fq=false}if(fn==null){fn=false}fp=(function(fx){return function(fy){return eL.show_validation_error(fy,fx.$modal_window.find(".tokenized_autocompleter_container"))}})(this);fv=(function(fx){return function(fA){var fz,fy;fy=JSON.parse(fA.responseText);ae.success(fy.success_msg);if(fx.progress_ever_blocked_by_verify){ba.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_share_succeess",fx.user,ft)}document.fire(aF.SF_NEW,{sf_info:bZ.decode_sort_key(fy.sf_info)});if(fs){fx.hide()}if(fn){fz=new df(fx.user,ay.normalize(fx.folder_name));return fz.show()}}})(this);if(this.must_check_verified&&!this.user.is_email_verified){this.progress_ever_blocked_by_verify=true;ba.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_blocked_on_verify",this.user,ft);this.$modal_window.find(".confirm-button").prop("disabled",true);fu=eA("Verification email sent to %(email)s").format({email:this.user.email});fw=d3.get_for_user(this.user);fw.send_email("share_folder",function(){return ae.success(fu)});bE("#resend-email-verification-link").click(function(){return fw.send_email("share_folder",function(){return ae.success(fu)})});this.$modal_window.find(".email-verify-message").show();return fw.ensure_polling((function(fx){return function(){ba.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_unblocked",fx.user,ft);ae.success(eA("Email verified. Try sharing your folder again."));fx.$modal_window.find(".confirm-button").prop("disabled",false);return fx.$modal_window.find(".email-verify-message").hide()}})(this))}else{this.sharing_api.share_folder(this.new_folder,this.folder_name,fr,fo,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,fm,fq,fv,fp);ft={path:this.folder_name,access_type:fm};ba.SharedFolderActivityLogger.log("web","invite_modal_share_folder_button",this.user,ft);return bE(document).trigger("db:invite_to_new_folder:share")}};T.prototype.insert_folder_settings=function(fn,fm,fp){var fo;this.audience_restriction=fn;this.inviter_restriction=fm;this.shared_link_policy_restriction=fp;fo=this.$modal_window.find(".invite-more-form, .external-invite-message,.folder-settings");if(this.audience_restriction==="team"){this.invite_form_controller.set_team_only(true);fo.addClass("team-only")}else{this.invite_form_controller.set_team_only(false);fo.removeClass("team-only")}return this._toggle_get_link_button_visibility()};return T})(d7);eV=D.ConfirmShareNewFileWizardModal=(function(T){cN(fl,T);function fl(fm,fn){this.user=fm;this.options=fn;fl.__super__.constructor.call(this,this.options);this.file_path=this.options.file_path;this.file_name=ay.filename(this.file_path);this.folder_name=ay.filename_without_extension(this.file_name);this.folder_path=ay.parent_dir(this.file_path)+"/"+this.folder_name;this.invitees=this.options.invitees;this.msg=this.options.msg;this.audience_restriction=this.options.audience_restriction;this.inviter_restriction=this.options.inviter_restriction;this.shared_link_policy_restriction=this.options.shared_link_policy_restriction;this.access_type=this.options.access_type;this.sharing_api=new bl(this.user);this.log_extras={path:this.file_path}}fl.prototype.before_show=function(){this.format({".confirm-share-file-invitees":this.format_invitees(),".confirm-share-file-name":this.file_name,".confirm-share-folder-name":this.folder_name});return ba.SharedFolderActivityLogger.log("web","single_file_unshared_info_modal_displayed",this.user,this.log_extras)};fl.prototype.on_confirm_button_click=function(fo){var fn,fm;fn=(function(fp){return function(fs){var fq,fr,ft;ba.SharedFolderActivityLogger.log("web","single_file_unshared_sharing_failed",fp.user,fp.log_extras);ft=cf.extract_errors(fs.responseText);if(ft===false){return}else{if(typeof ft==="string"){ae.error(ft)}else{if(typeof ft==="object"){for(fr in ft){fq=ft[fr];if("message_text" in fq){ae.error(fq.message_text);break}}}}}return fp.hide()}})(this);fm=(function(fp){return function(){var fq;ba.SharedFolderActivityLogger.log("web","single_file_unshared_sharing_succeeded",fp.user,fp.log_extras);fq=eA("%(folder_name)s was shared successfully.").format({folder_name:fp.folder_name});ae.success(fq);return fp.hide()}})(this);this.sharing_api.share_file(this.folder_path,this.file_path,this.invitees,this.msg,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,this.access_type,fm,fn);return ba.SharedFolderActivityLogger.log("web","single_file_unshared_info_modal_confirmed",this.user,this.log_extras)};fl.prototype.format_invitees=function(){var fr,fq,fo,fn,fm,fp;if(!this.invitees){return eA("others")}fr=this.invitees.emails[0];fq=this.invitees.fb_ids[0];fo=this.invitees.group_ids[0];fn=this.invitees.new_style_group_ids[0];if(!fr.length){return eA("others")}fm=fr[0];fp=fr.length+fq.length+fo.length+fn.length;if(fp>1){fm=fm+eA(" and others")}return fm};return fl})(d7);d6=D.ConfirmShareExistingFileWizardModal=(function(fl){cN(T,fl);function T(fm,fn){this.user=fm;this.options=fn;T.__super__.constructor.call(this,this.options);this.folder_name=this.options.folder_name;this.folder_path=this.options.folder_path;this.log_extras={path:this.folder_name}}T.prototype.before_show=function(){this.format({".confirm-share-existing-folder-name":this.folder_name});return ba.SharedFolderActivityLogger.log("web","single_file_shared_info_modal_displayed",this.user,this.log_extras)};T.prototype.on_confirm_button_click=function(fn){var fm;ba.SharedFolderActivityLogger.log("web","single_file_shared_info_modal_confirmed",this.user,this.log_extras);fm=new df(this.user,this.folder_path);this.hide();return fm.show()};return T})(d7);cz=D.NewSharedFolderPermissionsContent=(function(){T.SAVED_PERMISSIONS="new_sf_permissions:saved";function T(fl){this.$form=fl;this._submit=du(this._submit,this);this._listen()}T.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};T.prototype._cancel=function(){return d0.pop()};T.prototype._submit=function(fo){var fm,fn,fl;fo.preventDefault();fm=this.$form.find("input[name=audience]:checked").val();fn=this.$form.find("input[name=inviter]:checked").val();fl=this.$form.find("input[name=shared_link_policy]:checked").val();d0.trigger(T.SAVED_PERMISSIONS,{audience:fm,inviter:fn,shared_link_policy:fl});return d0.pop()};return T})();var dv;dv=D.SharingShmodel=(function(){function T(){}T.shmodel=function(fm,fl){return new dg(cr.active_user.id,fm,fl).show()};return T})();var bZ;bZ=INLINE_JS.Sharing=D.Sharing={init:function(fr,fl,fq,fn,fp,fo,fm,T){this.is_merged=fq;this.simple_sharing_enabled=T;if(!fl){this._decode_sort_keys(fr)}this._state={sf_info:fr,cmp:{"#sf-current":this._modified_cmp,"#sf-past":this._modified_cmp},is_ascending:{"#sf-current":false,"#sf-past":false},inbox_counts:{},sf_loading:fl,delay_reload_folder:false,pending_new_folders:[]};if(fq){this.role_picker=B.controller(bE("#role-selector"));this.role_picker.on_state_change=this._render.bind(this);bO.set_during_login_callback((function(fs){return function(fu,ft){dE.set_not_logged_in_role_and_email(null,null);return fs._reload_folder_info(function(){return ft()},function(fv){ft(eA("Error displaying shared folders"));return window.location.reload()})}})(this))}dE.set_is_merged(fq);dE.set_not_logged_in_role_and_email(fn,fp);dE.set_team_name(fo);dE.set_show_inbox(fm);this._listen();this._tmpl=fg.tmpl("sf_list_item_tmpl");if(!fl){this._render()}else{this._display_spinner();cC.WebRequest({url:"/share_ajax/list_folders",dataType:"json",success:(function(fs){return function(ft){fs._load_and_render_sf_list(ft);return eh.mark_time_to_interactive()}})(this),error:(function(fs){return function(ft){return fs._sf_list_error()}})(this)})}this.refresh_inbox_counts(true);this._display_view();return bE(document).on(bl.REQUEST_SUCCEEDED_EVENT,(function(fs){return function(ft,fu){if(fu.request_url==="/share_ajax/cancel_invite"||fu.request_url==="/share_ajax/invite_more"||fu.request_url==="/share_ajax/kick_user"){return fs._reload_folder_info()}}})(this))},_load_and_render_sf_list:function(T){this._decode_sort_keys(T);this._state.sf_info=T;this._state.sf_loading=false;this._hide_spinner();if(this._state.pending_new_folders.length>0){this._state.sf_info.current.push.apply(this._state.sf_info.current,this._state.pending_new_folders);this._state.pending_new_folders=[]}this._render();if(this._state.delay_reload_folder){this._state.delay_reload_folder=false;return this._reload_folder_info()}},_sf_list_error:function(){this._hide_spinner();return ae.error(eA("We weren\u2019t able to load the list of shared folders. Please refresh the page to try again."))},is_share_page:function(){return this._state!=null},_decode_sort_keys:function(T){return[T.current,T.past].each((function(fl){return function(fm){return fm.each(function(fn){return fl.decode_sort_key(fn)})}})(this))},decode_sort_key:function(T){cJ((T.encoded_sort_key!=null)&&(T.sort_key==null),"expected encoded sort keys on each elm");T.sort_key=d5.decode_sort_key(T.encoded_sort_key);delete T.encoded_sort_key;return T},reload_folder_info_if_two_account:function(){if(this._showing_two_accounts()){return this._reload_folder_info()}},_reload_folder_info:function(fm,T){var fl;if(!this.is_share_page()){return}fl=(function(fn){return function(fo){var fp;fp=JSON.parse(fo.responseText);fn._decode_sort_keys(fp);fn._state.sf_info=fp;fn._render();return typeof fm==="function"?fm():void 0}})(this);if(this._state.sf_loading){return this._state.delay_reload_folder=true}else{return new cp().get_folder_info(fl,T)}},refresh_inbox_counts:function(T){return new cp().get_inbox_counts((function(fl){return function(fm){return fl._update_inbox_counts(fm,T)}})(this))},_update_inbox_counts:function(fl,fo){var fr,fm,T,fq,fp,fn;fn=0;for(fq in fl){fr=fl[fq];fn+=fr}bE("#inbox-count").text(fn);bE("#inbox-count").toggleClass("show",fn>0);if(!this.is_share_page()){return}fm=function(ft,fs){var fu;for(fq in ft){fu=ft[fq];if(fs[fq]!==ft[fq]){return false}}return true};if((!fo)&&this._state&&fm(this._state.inbox_counts,fl)){return}this._state.inbox_counts=fl;if(fn){T=new Element("a",{id:"new-invites-link",href:"#"});T.__sert(cv.make("web","email_32",{"class":"link-img"}));fp=bc("%(total_count)d new shared folder invitation","%(total_count)d new shared folder invitations",fn);fp+=" \n";fp=fp.format({total_count:fn});T.__sert(fp);T.observe("click",(function(fs){return function(ft){Event.stop(ft);return fs.show_invites()}})(this));$("invites-box").show();$("invites-box").__date(T)}else{$("invites-box").hide()}if(fn>0&&dE.show_inbox){dE.set_show_inbox(false);return this.show_invites()}},register_accept:function(T){bE(T).closest(".sf-invite-action").addClass("loading");new by(bE(T),T.action,{data:bT.collect_form_vars(T),complete:(function(fl){return function(fn,fm){bE(T).closest(".sf-invite-action").removeClass("loading");fl.refresh_inbox_counts();return fl._reload_folder_info()}})(this),success:(function(fl){return function(fq,fm,fs){var fn,fp,fr,fo;fq=(fo=JSON.parse(fs.responseText))!=null?fo.data:void 0;fn=bE(T).closest(".sf-invite-action");fn.addClass("sf-accepted");if(fq!=null?fq.redirect:void 0){if(fl._state&&fl._state.current_total_count>1){fp=fn.find(".view-folder-button");return fp.click(function(){return window.location.href=fq!=null?fq.redirect:void 0})}else{return window.location.href=fq!=null?fq.redirect:void 0}}else{fr=bE(T).closest(".invitation-row").attr("data-invite-id");return fl._remove_invite_row(fr)}}})(this)});return false},register_decline:function(fl,fn,fo){var T,fm;T=bE(fl).closest("form");if((fm=T.closest(".sf-invite-action"))!=null){fm.addClass("loading")}if(T.length){new by(T,T[0].action,{data:bT.collect_form_vars(T[0]),complete:(function(fp){return function(fs,fr){var fq;if((fq=T.closest(".sf-invite-action"))!=null){fq.removeClass("loading")}fp._remove_invite_row(fn);fp.refresh_inbox_counts();fp._reload_folder_info();if(fo){return fo()}}})(this)})}return false},_remove_invite_row:function(fo){var T,fn,fm,fl;T=bE("#invites-container");fn=T.find('[data-invite-id="'+fo+'"]');if(fn){fl=fn.parent("tbody");fn.remove();if(fl.children().length===0){T.find(".invitation-table-container").hide();T.find(".message-bottom").removeClass("message-bottom");T.find(".message-top").removeClass("message-top");if(T.find(".invites-message").length===0){fm=d7.get_containing_modal(T);return fm!=null?fm.hide():void 0}}}},_quietly_reload_content:function(){return cC.WebRequest({url:"/share_ajax/list_folders",dataType:"json",success:(function(T){return function(fl){return T._load_and_render_sf_list(fl)}})(this),error:(function(T){return function(fl){return T._sf_list_error()}})(this)})},_listen:function(){var fm,fl,T;this.listen_modals();fm=(function(fn){return function(fp,fx,fs){var ft,fo,fw,fv,fu,fz,fq,fy,fr;fr=fn._get_current_sf_list_info(fs),fv=fr[0],fw=fr[1];cJ(fx,"SF _transfer w/o target_ns_id");for(ft=fq=0,fy=fv.length;fq<fy;ft=++fq){fo=fv[ft];if(fo.target_ns_id===fx&&fo.user_id===fp){fu=fo;fz=ft;break}}cJ(fz!=null,"SF _transfer w/o js obj");return[fu,fz]}})(this);T=(function(fn){return function(ft,fy,fv){var fw,fu,fz,fx,fs,fp,fr,fq,fo;fr=fn._get_current_sf_list_info(fy),fw=fr[0],fp=fr[1];fq=fn._get_current_sf_list_info(fv),fx=fq[0],fs=fq[1];fo=fm(ft.memo.user_id,ft.memo.target_ns_id,fy),fu=fo[0],fz=fo[1];fw.splice(fz,1);fn._empty_check(fy);if(ft.memo.filename!=null){fu.filename=ft.memo.filename}if(ft.memo.mount_point!=null){fu.mount_point=ft.memo.mount_point}fx.push(fu);return fn._render()}})(this);fl=(function(fn){return function(ft,fq){var fv,fs,fu,fp,fr,fo;fr=fn._get_current_sf_list_info(fq),fv=fr[0],fp=fr[1];fo=fm(ft.memo.user_id,ft.memo.target_ns_id,fq),fs=fo[0],fu=fo[1];fv.splice(fu,1);return fn._render()}})(this);document.observe(aF.SF_UNSHARE,(function(fn){return function(fo){return fl(fo,"#sf-current")}})(this));document.observe(aF.SF_LEAVE,(function(fn){return function(fo){return T(fo,"#sf-current","#sf-past")}})(this));document.observe(aF.SF_REJOIN,(function(fn){return function(fo){T(fo,"#sf-past","#sf-current");return fn._quietly_reload_content()}})(this));document.observe(aF.SF_IGNORE,(function(fn){return function(fo){return fl(fo,"#sf-past")}})(this));document.observe(aF.SF_NEW,(function(fn){return function(fp){var fo;fo=fp.memo.sf_info;cJ(fo,"SF_NEW without info");if(fn._state.sf_loading){return fn._state.pending_new_folders.push(fo)}else{fn._state.sf_info.current.push(fo);return fn._render()}}})(this));$("create-share").observe("click",(function(fn){return function(fo){ba.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);if(!$("create-share").hasClassName("disabled")){Event.stop(fo);return r.start_wizard_without_user()}}})(this));bE("#learn-more-link").click((function(fn){return function(fo){return ba.SharedFolderActivityLogger.log("web","sharing_view_learn_more",null,{},true)}})(this));if($("new-invites-link")){$("new-invites-link").observe("click",(function(fn){return function(fo){Event.stop(fo);return fn.show_invites()}})(this))}bE("#sf-current, #sf-past").each((function(fn){return function(fo,fp){var fq;fq=["#sf-current","#sf-past"][fo];bE(".sf-list",fp).on("click","a.options-link",function(fs){var fw,fu,fy,ft,fz,fx,fv,fr;fs.preventDefault();fw=bE(fs.target).closest("a.options-link");ft=fw.attr("data-type");fy=fw.attr("data-mount");fv=parseInt(fw.attr("data-nsid"),10);fr=cK.get_viewer().get_user_by_id(fw.attr("data-user_id"));fx=bE(fs.target).closest("li.sf-folder").data("role");fz=fw.attr("data-sf-perm-role");if(fx!=null){dE.set_role(fx)}if(ft==="normal"){if(fn.simple_sharing_enabled){if(d3.get_for_user(fr).verified_or_show()){eF.createAndShowInbandModal(fr,fy,true,fv,true,false,fz)}}else{r.show_shared_folder_options_modal(fy,fr)}}else{if(ft==="remove"){r.show_ignore_modal(fr,fy,fv)}else{if(ft==="rejoin"){r.show_rejoin_modal(fr,fy,fv)}}}fu={option_type:ft};if(fv){fu.ns_id=fv}if(fy){fu.path=fy}return ba.SharedFolderActivityLogger.log("web","sharing_view_share_existing",fr.id,fu,true)});bE(".sf-sort",fp).on("click","a.sort-option",function(ft){var fs,fr,fu;ft.preventDefault();fs=bE(ft.target).closest("a.sort-option");fu={SF_BY_NAME:fn._name_cmp,SF_BY_MODIFIED:fn._modified_cmp};fr=fu[fs.attr("data-sort")];if(fn._state.cmp[fq]===fr){fn._state.is_ascending[fq]=!fn._state.is_ascending[fq]}else{fn._state.cmp[fq]=fr;fn._state.is_ascending[fq]=true}d5.add_sort_arrow_mouseover_j(fs,fn._state.is_ascending[fq],fq+" .sf-sort a.sort-option",true);return fn._render_list_id(fq)});return d5.add_sort_arrow_mouseover_j(bE(".modified-sorter",fp),fn._state.is_ascending[fq],fq+" .sf-sort a.sort-option",false)}})(this));return bE(".empty-share-button").click((function(fn){return function(fo){fo.preventDefault();ba.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);return r.start_wizard_without_user()}})(this))},listen_modals:function(){return bE("#new-or-existing-sf li").click((function(T){return function(fm){var fl;bE("#new-or-existing-sf li").removeClass("active");fl=bE(fm.target).closest("li");fl.find("input").prop("checked",true);return fl.addClass("active")}})(this))},_showing_two_accounts:function(){var T;return this.is_merged&&((T=this.role_picker)!=null?T.get_state():void 0)===d1.ALL},_render:function(){cJ(!this._state.sf_loading);this._render_list_id("#sf-current");this._render_list_id("#sf-past");if(bE("#sf-current").hasClass("empty-list")&&bE("#sf-past").hasClass("empty-list")){bE("#page-content").addClass("no-shares");return bE("#empty-content").show()}else{bE("#page-content").removeClass("no-shares");return bE("#empty-content").hide()}},_render_list_id:function(fm){var ft,fq,fr,fo,fp,fn,fs,T,fu,fl;fl=this._get_current_sf_list_info(fm),fo=fl[0],fr=fl[1];fs=this._showing_two_accounts();ft=(function(fv){return function(fw,fy){var fx;fx=fv._state.is_ascending[fm]?1:-1;return fx*fv._state.cmp[fm](fw,fy,fs)}})(this);fo.sort(ft);fp=bE(".sf-list",fm);fp.empty();for(T=0,fu=fo.length;T<fu;T++){fn=fo[T];if(this._should_render(fn)){fq=this._tmpl({options_str:eA("Options"),remove_str:eA("Remove"),rejoin_str:eA("Rejoin"),is_past:fr,sf:fn,Sprite:cv,Emstring:bU,Util:d5,_:eA});fp.append(fq.toHTML())}}return this._empty_check(fm)},_should_render:function(T){if(this.role_picker!=null){return this.role_picker.is_role_visible(T.role)}else{return true}},_empty_check:function(fn){var fm,T,fl;fl=this._get_current_sf_list_info(fn),fm=fl[0],T=fl[1];if(bE(".sf-list",fn).children().length){return bE(fn).removeClass("empty-list")}else{return bE(fn).addClass("empty-list")}},_get_current_sf_list_info:function(T){switch(T){case"#sf-current":return[this._state.sf_info.current,false];case"#sf-past":return[this._state.sf_info.past,true];default:return cJ(false,"invalid sf list id")}},_name_cmp:function(fl,fm,T){if(T){return d5.sort_by_key(fl,fm)}else{return d5.sort_by_rank_or_key(fl,fm)}},_modified_cmp:function(fl,fm,T){return fl.modified_ts-fm.modified_ts},include_fb:false,use_fb_profile_pics:true,show_invites:function(){var fm,T,fl;this._state.current_total_count=0;fl=this._state.inbox_counts;for(T in fl){fm=fl[T];this._state.current_total_count+=fm}if(this._state.current_total_count>0){return r.show_invites()}},_display_view:(function(T){return function(){return bE("#sf-view").show()}})(this),_hide_view:(function(T){return function(){return bE("#sf-view").hide()}})(this),_display_spinner:function(){this._hide_view();return bE(".sf-spinner").show()},_hide_spinner:function(){return bE(".sf-spinner").hide()}};var br;Autocompleter.Contacts=Class.create(Autocompleter.Base,{initialize:function(fo,fp,fn,fu){var ft,fm,fr,fs,T,fl,fq;this.user=fo;this.baseInitialize(fp,fn,fu);this.options.array=false;this.options.larray=false;this.options.frequency=0.1;this._num_contacts_shown=0;this._num_query_results=0;fm=this.options.include_fb===true;if(this.options.include_team==null){this.options.include_team=true}fq=this.options.include_team===true;fr=this.options.include_groups===true;T=this.options.include_new_style_groups===true;fs=this.options.include_me===true;fl=this.options.include_rooms===true;this.profile_services=bj.get_linked_profile_services_for_user(this.user.id,this.update_import_contacts_link);this.link_handler=new ea();this._autocompleter_profile_services_item_tmpl=fg.tmpl("autocompleter_item_tmpl");this.listen();this.possible_email_pattern=/[.@_-]/;ft=(function(fv){return function(fw){if(fv.options.include_from_linked_accounts&&fv.options.viewer){fw=fw.includeForViewer(fv.options.viewer)}else{fw=fw.includeForUser(fv.user.id)}if(fv.options.contact_filter){fw=fv.options.contact_filter(fw)}else{if(!fm){fw=fw.excludeFacebook()}if(!fr){fw=fw.excludeGroups()}if(!T){fw=fw.excludeNewStyleGroups()}if(!fq){fw=fw.excludeTeamMembers()}if(!fs){fw=fw.excludeMe()}if(!fl){fw=fw.excludeRooms()}}return fv.setContacts(fw)}})(this);(function(){var fv;return b0.load_contacts(fv=false,fl=fl,(function(fw){ft(fw);return b0.register_for_updates("autocompleter_contacts",ft)}))}).defer();return this.options.onShow=function(fv,fw){if(!fw.style.position||fw.style.position==="absolute"){fw.style.position="absolute";bE(fw).clonePosition(bE(fv),{setHeight:false,setTop:false,setLeft:false})}return bE(fw).fadeTo(150,1)}},link_callback:function(T){return ea.show_import_notifications(T)},getToken:function(){var T;T=this.getTokenBounds();return this.element.value.substring(T[0],T[1])},listen:function(){var T;this.install_profile_services_link_listener();T=(function(fl){return function(fm){if(fl.profile_services.has_connected_services()){return}if(bE(fl.element).val()){return}fl.activate();setTimeout(function(){var fn;return(fn=fl.get_entry_container())!=null?fn.show():void 0},300);return true}})(this);return bE(this.element).click(T)},install_profile_services_link_listener:function(){var T;Event.stopObserving(this.element,"blur");T=(function(fl){return function(fn){var fm;fm=fl.get_entry_container();if(bE(fn.target).hasClass("new-collab-input")&&bE(fm).hasClass("people-default-show-import-shmodal-experiment")){return}if(!bE(fn.target).closest("li").hasClass("profile-services-link-handler")){if(bE(fm).hasClass("people-default-show-import-shmodal-experiment")){bE(fm).removeClass("people-default-show-import-shmodal-experiment");ba.PeopleExperimentsLogger.log(ba.PeopleExperimentsLogger.DEFAULT_SHOW_IMPORT_LINK_DISMISS,fl.user.id)}return fm!=null?fm.hide():void 0}}})(this);bE(this.element).closest(".db-modal-box").click(T);return bE(this.element).closest("#modal-box").click(T)},get_entry_container:function(){var T;return(T=this.element.up(".tokenized_autocompleter_container"))!=null?T.down(".autocomplete"):void 0},profile_services_show:function(){var fm,fl,T,fn;fm=this.get_entry_container();if(((fl=fm.firstChild)!=null?(T=fl.firstChild)!=null?T.value:void 0:void 0)>0){this.old_display=fm.style.display}else{this.old_contents="<ul></ul>";this.old_display="none"}this.profile_services_render_buttons();if((fn=$("flash_copy_container"))!=null){fn.hide()}return this.element.focus()},profile_services_render_buttons:function(){var T;T=this.get_profile_services_button_list();this.hasFocus=true;return this.updateChoices("<ul>"+(T.join(""))+"</ul>")},get_profile_services_button_list:function(){var fl,fp,fm,fo,T,fn;fm=[];fn=c0.contact_services();for(fo=0,T=fn.length;fo<T;fo++){fp=fn[fo];cJ(this.profile_services.is_updated,"profile_services has not been updated");fl="";if(this.profile_services.service_is_connected(fp)){fl=eA("Connected")}else{if(this.profile_services.service_was_connected(fp)){fl=eA("Reconnect")}}fm.push(this._autocompleter_profile_services_item_tmpl({email_provider_num:fp,email_provider_img:c0.to_img(fp),email_provider_name:c0.to_name(fp),bottom_text:fl}).toHTML())}return fm},update_import_contacts_link:(function(T){return function(fl){T.profile_services=fl;if(T.profile_services.has_unconnected_services(true)){return bE(T.element).closest("form").find(".import-contacts-link").show()}else{return bE(T.element).closest("form").find(".import-contacts-link").hide()}}})(this),hide_containing_modal:function(){this.$hidden_modals=bE(".db-modal-wrapper:visible").first();if(this.$hidden_modals.length){return this.$hidden_modals.css("display","none")}else{this.$hidden_modals=bE("#modal:visible, #modal-overlay:visible");return this.$hidden_modals.hide()}},show_containing_modal:function(){this.$hidden_modals.show();return this.$hidden_modals=null},setContacts:function(T){this.options.array=T.contacts;this.options.larray=T.lcontacts;if(this.active||this.getToken()){return this.getUpdatedChoices()}},getUpdatedChoices:function(){return this.updateChoices(this.options.selector())},selectEntry:function(){var fm,fl,T;fl=this.getCurrentEntry();fm=this.options.array[fl.value];if(fm.type===V.FB||fm.type===V.NEW_STYLE_GROUP){fl.innerHTML=fm.name}else{fl.innerHTML=fm.email}if(this.options.tokens.length>1){T=this.options.tokens[0]+" "}else{T=""}fl.innerHTML+=T;this.active=false;this.updateElement(fl);return bE(this.element).trigger("db:autocompleted")}},br=function(T,fl){var fm;fm=bE("<div>");fm.addClass(T);if(typeof fl==="string"||fl instanceof String){fm.text(fl)}else{fm.append(fl)}return fm},{getNumContactsShown:function(){return this._num_contacts_shown},getNumQueryResults:function(){return this._num_query_results},setOptions:function(fl){var T;if(fl==null){fl={}}T={choices:5,selector:(function(fm){return function(){var fq,fH,fG,fz,fB,fT,fs,ga,gb,fv,fR,f6,fL,fD,fA,fS,fQ,fy,f2,fr,fP,f9,fM,fV,fN,fU,f0,fn,fZ,f7,fx,fE,fO,fo,fX,fI,fK,fY,fp,fF,f8,fJ,f5,f4,f3,f1,fC,fw,fu,ft,fW;fI=[];fR=fm.getToken().toLowerCase();f2=fm.options.array.length;fB=fm.options.array;fV=fm.options.larray;fX=[];if(fR.indexOf(" ")===-1){fX.push("\\s+")}if(fR.indexOf("+")===-1){fX.push("\\+")}if(fR.indexOf("@")===-1){fX.push("@")}if(fR.indexOf(".")===-1){fX.push("\\.")}if(fR.indexOf("&lt;")===-1){fX.push("&lt;")}fo=RegExp("("+fX.join("|")+")");fS=0;while(fR.length>0&&fS<f2){fz=fB[fS];fM=fV[fS];f6=-1;fv=[];fU=[];fA="";switch(fz.type){case V.EMAIL:fv.push(fz.name,fz.email_snippet);fU.push(fM.name,fM.email);fA="/static/images/icons/mail28-vflHfHPJ0.png";break;case V.FB:fv.push(fz.name);fU.push(fM.name);if(bZ.use_fb_profile_pics){fA="https://graph.facebook.com/"+fM.fb_id+"/picture"}else{fA="/static/images/icons/fb24-vflGnjfAv.png"}break;case V.USER_GROUP:fv.push(fz.name,fz.members);fU.push(fM.name,"");fA="";fL=fz.group_avatar;break;case V.NEW_STYLE_GROUP:fv.push(fz.name,fz.members);fU.push(fM.name,"");fA="";if(__CIRCULAR_DEPENDENCY__.GroupsListController!=null){fH=__CIRCULAR_DEPENDENCY__.GroupsListController.string_to_hsl(fz.name);fG=__CIRCULAR_DEPENDENCY__.GroupsListController.get_initials(fz.name);fL=bE("<span class='group-icon'>").css("border-color",fH).css("color",fH).text(fG)}break;case V.CAROUSEL_ROOM:fv.push("",fz.name);fF=fM.name;fW=fz.members;for(f5=0,fC=fW.length;f5<fC;f5++){f0=fW[f5];fF+="."+f0.contact_vector_data.toLowerCase();fF+="."+f0.display_name.toLowerCase()}fU.push("",fF);fA=fz.avatar_url||"/static/images/carousel/icon-57px-vfluuaZ5j.png";break;default:cJ(false,"should never get here due to type: "+(""+fz.type+", "+fz.name+", "+fz.email+", "+fz))}for(fy=f4=0,fw=fU.length;f4<fw;fy=++f4){fN=fU[fy];f7=fX.length?fN.split(fo):[fN];fs=0;for(f3=0,fu=f7.length;f3<fu;f3++){fZ=f7[f3];if(!fZ){continue}if(fZ.indexOf(fR)===0){f6=fs;break}fs+=fZ.length}if(f6!==-1){fO=((fR.length/fZ.length)*9.4).toFixed(0);if(fz.sort_key!=null){fO+=fz.sort_key}fr=document.createTextNode(fv[fy].substr(0,f6));fn=bE("<strong>").text(fv[fy].substr(f6,fR.length));fY=document.createTextNode(fv[fy].substr(f6+fR.length));fv[fy]=[fr,fn,fY];break}}if(fz.type===V.FB){fv.push(eA("Facebook message"))}if(f6!==-1){if(fA){fD=bE('<img width="28px" height="28px">').attr("src",fA)}else{if(fL){fD=fL}}fx=br("autocomplete-line",fv[0]);fJ=br("autocomplete-line autocomplete-secondary",fv[1]);fP=br("autocomplete-left",fD);fp=br(null,[fx,fJ]);f9=bE("<li>").attr("value",fS).append(fP,fp);fI.push([fO,f9])}fS++}fI.sort(function(gd,gc){if(gd[0]<gc[0]){return 1}else{if(gd[0]>gc[0]){return -1}else{return 0}}});fm._num_query_results=fI.length;fI=fI.slice(0,fm.options.choices);fK=bE("<ul>");for(f1=0,ft=fI.length;f1<ft;f1++){f8=fI[f1];fK.append(f8[1])}fm._num_contacts_shown=fI.length;if(!bE(fm.element).hasClass("no-profile-services-link-handler")){if(fm.profile_services.has_unconnected_services(true)){fT=bE(fm.element).closest(".tokenized_autocompleter_container");fE=fT.attr("data-provider");fQ=fE===c0.GOOGLE?eA("Select from your Gmail contacts"):fE===c0.YAHOO?eA("Select from your Yahoo contacts"):eA("Select from your contacts");ga=false;if((fE===c0.GOOGLE||fE===c0.YAHOO)&&!fm.profile_services.service_is_connected(fE)){ga=true}else{if(fm.profile_services.has_connected_services()){ga=false;fQ=eA("Import Contacts")}}if(ga){gb=fm._autocompleter_profile_services_item_tmpl({email_provider_num:fE,email_provider_img:c0.to_img(fE),email_provider_name:fQ,bottom_text:""}).toHTML();fK.append(gb)}else{fD=cv.make("web","user_add");fx=br("autocomplete-line autocomplete-line-center",fQ);fP=br("autocomplete-left",fD);fp=br(null,[fx]);f9=bE("<li>").addClass("profile-services-link-handler").append(fP,fp);fK.append(f9)}}}fq=fK.wrap("<span>").parent().html();fm.old_contents=fq;return fq}})(this)};return this.options=Object.extend(T,fl)}});var cM;cM=D.Token=Class.create({initialize:function(fl,T,fm,fn){this.element=$(fl);this.token_manager=fm;this.hidden_input=T;this.element.token=this;this.selected=false;this.info=fn;return bE(this.element).closest(".tokenized_autocompleter_container").click(this.onclick.bindAsEventListener(this))},select:function(){var T;this.token_manager.token=this;if((T=this.hidden_input)!=null){T.element.activate()}this.selected=true;return this.element.addClassName("token_selected")},deselect:function(){if(this.token_manager.token===this){this.token_manager.token=null}this.selected=false;return this.element.removeClassName("token_selected")},onclick:function(T){if(T&&T.preventDefault){T.preventDefault()}if(this.detect(T)&&!this.selected){return this.select()}else{return this.deselect()}},remove:function(T){return this.token_manager.remove(this)},detect:function(fn){var fl,fm,T;fm=fn.target?fn.target:fn.srcElement;T=fm.token;fl=fm;while((T==null)&&fl.parentNode){fl=fl.parentNode;T=fl.token}return(T!=null)&&T.element===this.element}});var P;P=D.TokenManager=Class.create({initialize:function(fm,fn,fl,T){this.contact_search_logger=T;this.shift_boundary_right_func=fn;this.shift_boundary_left_func=fl;this.element=fm;this.tokens=[];return this.token=null},add:function(T){this.tokens.push(T);return this.element.fire("token:add",T.info)},populate:function(){var fq,fm,fo,fn,fp,fl,T;fn=this.element.select(".token");T=[];for(fp=0,fl=fn.length;fp<fl;fp++){fo=fn[fp];fq=fo.hasClassName("token-warn");fm=new cM(fo,null,this,{external:fq});T.push(this.add(fm))}return T},remove:function(fl){var T;if(fl==null){fl=this.token}if(fl!=null){this.contact_search_logger.flag_record_as_removed(fl.info.value);T=this.tokens.indexOf(fl);this.tokens.splice(T,1);fl.element.remove();if(this.token===fl&&T<this.tokens.length){this.tokens[T].select()}else{this.token=null;if(this.shift_boundary_right_func!=null){this.shift_boundary_right_func()}}return this.element.fire("token:remove",fl.info)}},removeAll:function(){var fm,fo,fn,fl,T;fo=this.tokens.slice(0);this.tokens.clear();T=[];for(fn=0,fl=fo.length;fn<fl;fn++){fm=fo[fn];fm.element.remove();T.push(this.element.fire("token:remove",fm.info))}return T},shift_left:function(){var T;T=this.token?this.tokens.indexOf(this.token):this.tokens.length;if(T>0){if(this.token){this.token.deselect()}return this.tokens[T-1].select()}else{if(this.shift_boundary_left_func!=null){return this.shift_boundary_left_func()}}},shift_right:function(){var T;T=this.tokens.indexOf(this.token);if(this.token){this.token.deselect()}if(T+1<this.tokens.length){return this.tokens[T+1].select()}else{if(this.shift_boundary_right_func!=null){return this.shift_boundary_right_func()}}}});var d9;d9=D.HiddenInput=Class.create({initialize:function(T,fm,fl){this.element=$(T);this.auto_complete_element=fm;this.token_manager=fl;return Event.observe(this.element,"keydown",this.onKeyPress.bindAsEventListener(this))},onKeyPress:function(T){switch(T.keyCode){case Event.KEY_LEFT:T.preventDefault();this.token_manager.shift_left();break;case Event.KEY_TAB:T.preventDefault();this.token_manager.shift_right();break;case Event.KEY_RIGHT:T.preventDefault();this.token_manager.shift_right();break;case Event.KEY_BACKSPACE:case Event.KEY_DELETE:this.token_manager.remove()}return false}});var bK=[].indexOf||function(fm){for(var fl=0,T=this.length;fl<T;fl++){if(fl in this&&this[fl]===fm){return fl}}return -1};Autocompleter.ContactsTokenizer=Class.create(Autocompleter.Contacts,{initialize:function($super,T,fn,fp,fm,fl){var fo;this.user=T;$super(T,fn,fp,fl);this.contact_search_logger=new ba.ContactSearchLogger;this.token_manager=new P(this.element,this.generate_shift_boundary_right_func(),null,this.contact_search_logger);this.hidden_input=new d9(fm,this.element,this.token_manager);this.textbox_height=0;if(!this.element.hacks){this.element.should_use_borderless_hack=Prototype.Browser.WebKit;this.element.should_use_shadow_hack=Prototype.Browser.IE||Prototype.Browser.Opera;this.element.hacks=true}if(this.element.should_use_borderless_hack||this.element.should_use_shadow_hack){bE(this.element).parent().addClass("tokenizer_input_borderless")}this.options.onShow=function(fq,fr){bE(fr).clonePosition(bE(fq.parentNode.parentNode),{setHeight:false,setTop:false,setLeft:false});return fr.show()};this.options.onHide=function(fq,fr){fr.hide();if(bE(fr).hasClass("people-default-show-import-shmodal-experiment")){return bE(fr).removeClass("people-default-show-import-shmodal-experiment")}};this.max_textbox_height=270;if(fl.max_textbox_height!=null){this.max_textbox_height=fl.max_textbox_height}this.members=[];if(fl.members!=null){this.members=fl.members}this.invitees=[];if(fl.invitees!=null){this.invitees=fl.invitees}this.new_style_groups=[];if(fl.new_style_groups!=null){this.new_style_groups=fl.new_style_groups}this.contacts_only=false;if(fl.contacts_only!=null){this.contacts_only=fl.contacts_only}if(eD.get_url().indexOf("/referrals")!==-1){fo=bE("#retrieve-contacts-button")}else{fo=bE(this.element).closest("form").find(".tokenizer-submit-button")[0]}bE(fo).on("mousedown",this.beforeSubmit.bindAsEventListener(this));bE(this.element).on("focus",this.onFocus.bindAsEventListener(this));this.import_links=[];if(!fl.hide_import_contacts){this.import_links=bE(".import-contacts-link")}this.calculate_input_size();this.dynamically_resize_input();this.check_populated();return setInterval(this.check_populated.bind(this),100)},onClick:function(fl){var T,fm;T=fl.findElement("li");this.index=T.autocompleteIndex;fm=this.selectEntry();if(!fm){return this.hide()}},onBlur:function($super,T){$(this.element.parentNode).removeClassName("focused");this.element.up(".tokenizer").removeClassName("focused");return $super(T)},onFocus:function(T){$(this.element.parentNode).addClassName("focused");return this.element.up(".tokenizer").addClassName("focused")},beforeSubmit:function(T){return this.tokenize_emails_input(true)},clearTokens:function(T){this.token_manager.removeAll();this.calculate_input_size();return this.dynamically_resize_input()},getTokenCount:function(){return this.token_manager.tokens.length},getEmails:function(){var fl,T;fl=bE(this.element).closest(".tokenized_autocompleter_container").find(".token-valid").find('[name="emails"]');return((function(){var fo,fn,fm;fm=[];for(fo=0,fn=fl.length;fo<fn;fo++){T=fl[fo];fm.push(bE(T).val())}return fm})()).join(", ")},check_populated:function(){var fl,T;fl=$(this.element.parentNode);T=(this.element.value==="")&&(this.token_manager.tokens.length===0);if(fl.hasClassName("populated")&&T){return fl.removeClassName("populated")}else{if(!fl.hasClassName("populated")&&!T){return fl.addClassName("populated")}}},clean_email_addr:function(fo,fm){var fl,fn,T;for(fn=0,T=fo.length;fn<T;fn++){fl=fo[fn];fm=fm.sub(fl,"")}return fm.strip()},get_regexp_from_delimiters:function(fo){var fl,fn,fm,T;fn="";for(fm=0,T=fo.length;fm<T;fm++){fl=fo[fm];fn+=fl+"|"}return new RegExp("["+fn+"\\r\\n|\\r|\\n|\\t]+")},createTokenInfo:function(fn,fm,T){var fo,fl;fl=true;fo=fm;if(T===V.FB){fo=fn}if(T===V.EMAIL&&!d5.validate_email(fm)){fl=false}else{if(bK.call(this.members,fm)>=0){fl=false;fo=eA("Already member")}else{if(bK.call(this.invitees,fm)>=0){fl=false;fo=eA("Already invited")}else{if(T===V.NEW_STYLE_GROUP){if(bK.call(this.new_style_groups,fm)>=0){fl=false;fo=eA("Already member group")}else{fl=true;fo=eA("Group")}}}}}if(fm===this.user.email||fm===this.user.id){fo=eA("You");fl=!this.contacts_only}if(!fn&&fm){fn=fm.toString()}return{display:fn,value:fm,type:T,valid:fl,bubble_title:fo}},COMPOUND_EMAIL_REGEX:/([^<>]+)<([^@>]+@[^@>]+)>/,parse_compound_email:function(fl){var T,fm;T=fl.match(this.COMPOUND_EMAIL_REGEX);if(T){fm=this.createTokenInfo(T[0],T[2],V.EMAIL);return fm}return null},tokenize_emails_input:function(ft,fo){var fy,fs,fp,fx,fm,fC,fz,fw,fv,fq,fE,fr,fn,fl,T,fA,fD,fB,fu;fs=this.options.tokens;fv=this.get_regexp_from_delimiters(fs);if(this.options.single_token){fx=[this.element.value]}else{fx=this.element.value.split(fv)}fE="";if(!ft){fE=fx[fx.length-1];fw=this.clean_email_addr(fs,fE);fx=fx.slice(0,fx.length-1);if((fu=fE[fE.length-1])===" "||fu===">"){if(fw.match(this.COMPOUND_EMAIL_REGEX)||d5.validate_email(fw)){fx.push(fw);fE=""}}}fy=false;fr=[];if(fx.length>0){for(fn=0,fA=fx.length;fn<fA;fn++){fp=fx[fn];fq=this.parse_compound_email(fp);if(fq!=null?fq.valid:void 0){fy=true;this.set_input_size(1);if(this.addContact(fq)){fC={sort_variant:b0.sort_variant,context:"legacy_tokenizer",contact_type:V.EMAIL,contact_id:fq.value,contact_name:fq.display,did_select_suggestion:false};this.contact_search_logger.add_record(fC)}}else{fr.push(fp)}}}fx=fr;if(!this.options.single_token){fz=[];for(fl=0,fD=fx.length;fl<fD;fl++){fp=fx[fl];fz.push.apply(fz,fp.split(" "))}fx=fz}if(fx.length>0){for(T=0,fB=fx.length;T<fB;T++){fp=fx[T];fp=this.clean_email_addr(fs,fp);if(fp){fq=this.createTokenInfo(fp,fp,V.EMAIL);if(fq.valid){fy=true}else{if(fo){continue}}this.set_input_size(1);if(this.addContact(fq)){fC={sort_variant:b0.sort_variant,context:"legacy_tokenizer",contact_type:V.EMAIL,contact_id:fp,did_select_suggestion:false};this.contact_search_logger.add_record(fC)}}}}if(this.element.value!==fE){this.element.value=fE}fm=this.element.up("form");if(fy){bT.clear_errors(fm)}return this.dynamically_resize_input()},generate_shift_boundary_right_func:function(){var fl,T;fl=this.element;T=function(){return fl.focus()};return T},set_input_size:function(T){if((T==null)||T<0){T=20}return this.element.setStyle({width:""+T+"px"})},calculate_input_size:function(){if(this.import_links.length){this.import_links_width=this.import_links.width();return this.import_links_visible=this.import_links.is(":visible")}},dynamically_resize_input:function(){var fw,fA,fq,fo,fD,fr,fx,fz,fv,fn,ft,fp,fu,fy,fm,T,fB,fC,fs,fl;fv=$(this.element.parentNode.parentNode);ft=parseInt(fv.getStyle("width"),10)-15;fn=parseInt(fv.getStyle("height"),10);if(fn!==this.textbox_height){this.textbox_height=fn;if(fn>=this.max_textbox_height){fv.setStyle({"overflow-y":"auto"})}else{fv.setStyle({"overflow-y":"hidden"})}}fD=ft;fw=bE(".tokenizer-link",fv.parentNode);if(fw.length>0){fD-=fw.width()}fu=this.token_manager.tokens;fr=false;fy=0;for(fm=0,fB=fu.length;fm<fB;fm++){fp=fu[fm];fo=fp.element;fq=parseInt(fo.getStyle("width"),10)+parseInt(fo.getStyle("margin-right"),10);fz=fy+fq;if(fz>ft){fy=fq;fr=true}else{if(fq>ft){fy=0;fr=true}else{fy=fz}}}fx=fD-fy;fA=this.element.value.length*7;if(fA>fx){fx=ft}this.set_input_size(fx);if(this.import_links.length&&this.import_links_visible){if(fr||ft-fy-fA<1.25*this.import_links_width){this.import_links_visible=false;fs=this.import_links;fl=[];for(T=0,fC=fs.length;T<fC;T++){fo=fs[T];fl.push(bE(fo).fadeOut(100))}return fl}}},onKeyPress:function(fl){var fm,T;this.dynamically_resize_input();if(this.active){switch(fl.keyCode){case 44:case 188:case 59:case 186:if(!fl.shiftKey){if(this.has_selected_contact_importer_entry()||this.has_selected_contact_importer()){this.tokenize_emails_input(true)}}this.reset_observer();return;case Event.KEY_TAB:case Event.KEY_RETURN:if(this.has_selected_profile_services_entry()||this.has_selected_profile_services()){this.tokenize_emails_input(true);this.hide();Event.stop(fl);return}this.selectEntry();this.hide();this.active=false;Event.stop(fl);return;case Event.KEY_ESC:this.hide();this.active=false;Event.stop(fl);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious();this.render();Event.stop(fl);return;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(fl);return}}else{this.tokenize_emails_input(false);if(fl.keyCode===Event.KEY_TAB||fl.keyCode===Event.KEY_RETURN){if(this.element.value&&fl.preventDefault){fl.preventDefault()}this.tokenize_emails_input(true);return}else{if(this.element.value===""){if((fm=fl.keyCode)===Event.KEY_LEFT||fm===Event.KEY_BACKSPACE){this.token_manager.shift_left()}}else{if((T=fl.keyCode)===Event.KEY_LEFT||T===Event.KEY_RIGHT||T===Event.KEY_UP||T===Event.KEY_DOWN){return}}}}this.update_typeahead();return this.reset_observer()},update_typeahead:function(){this.changed=true;return this.hasFocus=true},reset_observer:function(){if(this.observer){clearTimeout(this.observer)}return this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000)},onObserverEvent:function($super){var fl,fm,fp,fo,T,fn;if(this.active){fp=this.element.value;fn=this.options.tokens;for(fo=0,T=fn.length;fo<T;fo++){fl=fn[fo];fm=fp.indexOf(fl);if(fm!==-1){if(this.has_selected_profile_services_entry()){this.tokenize_emails_input(true);this.hide();return}this.element.value=fp.substr(0,fm);this.selectEntry();this.hide();this.active=false;this.element.value=fp.substr(fm+1);break}}this.update_typeahead()}this.tokenize_emails_input(false);return $super()},has_selected_profile_services:function(T){if(T==null){T=this.getCurrentEntry()}return bE(T).hasClass("profile-services-link-handler")},has_selected_profile_services_entry:function(T){var fl;if(T==null){T=this.getCurrentEntry()}return T.value===0&&((fl=T.id)!=null?fl.length:void 0)!==0},selectEntry:function(){var fm,fq,T,fo,fn,fp,fs,fr,fl;fq=this.getCurrentEntry();if(this.has_selected_profile_services(fq)){ba.SharedFolderActivityLogger.log("web","import_contacts_button_clicked",this.user);this.profile_services_show();return true}else{if(this.has_selected_profile_services_entry(fq)){fp="suggestion";if(bE(this.get_entry_container()).hasClass("people-default-show-import-shmodal-experiment")){fp=fp+" people-default-show-import-shmodal-experiment";ba.PeopleExperimentsLogger.log(ba.PeopleExperimentsLogger.DEFAULT_SHOW_IMPORT_CLICK,this.user.id,{provider:T})}T=fq.id.split("_")[0];cJ((bK.call(c0.contact_services(),T)>=0),"The 'id-value' of an autocompleter-entry is not a valid Third Party contact import service");fr=c0.to_name(T);if(this.profile_services.service_is_connected(T)){ae.success(eA("You're already connected to %(service_name)s").format({service_name:fr}));return}if(bK.call(c0.contact_services(),T)>=0){return this.link_handler.auth_service_with_user(T,this.user.id,((function(ft){return function(fu){return ft.link_callback(fu)}})(this)),fp)}else{return cJ(false,"Should never get here. entry_value: "+T)}}else{fm=this.options.array[fq.value];fo=fm.type===V.FB?fm.fb_id:fm.type===V.USER_GROUP?fm.group_id:fm.type===V.NEW_STYLE_GROUP?fm.group_id:fm.type===V.CAROUSEL_ROOM?fm.members:fm.email;this.set_input_size(1);fs=this.element.value;fl=this.createTokenInfo(fm.name.strip(),fo,fm.type);if(this.addContact(fl)){fn={sort_variant:b0.sort_variant,context:"legacy_tokenizer",search_expr:fs,selected_pos:this.index,num_query_results:this.getNumQueryResults(),contact_type:fm.type,contact_id:fo,contact_name:fm.name.strip(),did_select_suggestion:true};this.contact_search_logger.add_record(fn)}bT.clear_errors(this.element.up("form"));this.dynamically_resize_input();this.index=0;return this.element.focus()}}},addContact:function(fu){var fF,fE,fz,fG,fv,fI,fr,fC,fl,fw,fA,fH,fL,fm,fs,fy,fB,ft,fD,fo,fn,T,fJ,fM,fK,fx,fq,fp;if(fu.type===V.CAROUSEL_ROOM&&!fu.processed){fF=false;fx=fu.value;for(fo=0,fJ=fx.length;fo<fJ;fo++){fE=fx[fo];fl=this.createTokenInfo(fG=fE.display_name,fD=JSON.stringify([fE.contact_vector_type,fE.contact_vector_data]),ft=V.CAROUSEL_ROOM);fl.processed=true;fl.bubble_title=fE.contact_vector_data;fF=fF||this.addContact(fl)}return fF}fB=this.token_manager.tokens;for(fn=0,fM=fB.length;fn<fM;fn++){fw=fB[fn];if(fu.value===fw.info.value){return false}}this.element.value="";switch(fu.type){case V.FB:fC="fb_ids";fI=new Element("img",{src:"/static/images/icons/fb_16-vflbiYTkC.png"});break;case V.EMAIL:fC="emails";fI=new Element("img",{src:"/static/images/icons/email_16-vflcFyDTl.png"});break;case V.USER_GROUP:fC="group_ids";fI=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif","class":"sprite sprite_groups s_groups_group"});break;case V.NEW_STYLE_GROUP:fC="new_style_group_ids";fI=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif","class":"sprite sprite_groups s_groups_group"});break;case V.CAROUSEL_ROOM:fC="carousel_rooms";fI=new Element("img",{src:"/static/images/carousel/icon-57px-vfluuaZ5j.png"});break;case V.INVALID:fC="invalids";fI=new Element("span",{"class":"hidden"});break;default:cJ(false,"should never get here due to type: "+fu.type)}fA=this.getTokenClass(fu);fy=bE("<span class='x'>").addClass(fA);fy.on("click",function(fN){this.parentNode.parentNode.parentNode.parentNode.parentNode.token.remove(fN);return false});fL=new Element("input",{type:"hidden",name:fC,value:fu.value.toString()});fw=new Element("a",{"class":"title_bubble token "+fA,href:"#",tabindex:"-1",title:fu.bubble_title});fr=new Element("span");if(this.options.wrap_name){fm=new Element("div",{"class":"token-display-text"});fm.__sert(fu.display);fH=fm;fz=1}else{fH=fu.display;fz=0}fq=[fL,fI,fH];for(T=0,fK=fq.length;T<fK;T++){fv=fq[T];fr.__sert(fv)}bE(fr).append(fy);fw.__date(new Element("span").__date(new Element("span").__date(new Element("span").__date(fr))));if((fp=$(fw).down(5).next(fz))!=null){fp.innerHTML="&nbsp;"}fs=new cM(fw,this.hidden_input,this.token_manager,fu);this.token_manager.add(fs);this.element.up().__sert({before:fw});return true},getTokenClass:function(T){if(!T.valid){return"token-error"}return"token-valid"},isTeamOnly:function(){return false}});var bK=[].indexOf||function(fm){for(var fl=0,T=this.length;fl<T;fl++){if(fl in this&&this[fl]===fm){return fl}}return -1};Autocompleter.TeamTokenizer=Class.create(Autocompleter.ContactsTokenizer,{initialize:function($super,T,fn,fo,fm,fl){$super(T,fn,fo,fm,fl);this.warn_only=!fl.team_only;this.element.observe("token:remove",this.notifyExternal.bind(this));this.element.observe("token:add",this.notifyExternal.bind(this));this.team_contacts={};return this.suspended_contacts={}},isTeamOnly:function(){return !this.warn_only},setTeamOnly:function(T){this.warn_only=!T;return this.reloadContacts()},reloadContacts:function(){var fl,T;return b0.load_contacts(fl=false,T=false,(function(fm){return function(fn){return fm.setContacts(fn)}})(this))},setContacts:function($super,fo){var T,fn,fl,fm;this.team_contacts={};this.team_contacts[cK.get_viewer().work_email]=1;fo=fo.excludeSuspended();fo=fo.sortByTeamFirst();fm=fo.contacts;for(fn=0,fl=fm.length;fn<fl;fn++){T=fm[fn];if(T.team&&T.join_state==="active"){this.team_contacts[T.email]=1}if(T.team&&T.join_state==="suspended"){this.suspended_contacts[T.email]=1}}if(this.options.autocomplete_filter){return $super(this.options.autocomplete_filter(fo))}else{return $super(fo)}},createTokenInfo:function(fo,fm,T){var fq,fp,fn,fl;fl=true;fp=false;fq=fm;if(T===V.FB){fq=fo}if(T===V.EMAIL&&!d5.validate_email(fm)){fl=false}else{if(bK.call(this.members,fm)>=0){fl=false;fq=eA("Already member")}else{if(bK.call(this.invitees,fm)>=0){fl=false;fq=eA("Already invited")}else{if(T===V.EMAIL&&!this.team_contacts[fm]){fl=this.warn_only;fp=true}else{if(T===V.FB){fl=this.warn_only;fp=true}else{if(T===V.NEW_STYLE_GROUP){if(bK.call(this.new_style_groups,fm)>=0){fl=false;fq=eA("Already member group")}else{fl=true;fq=eA("Group")}}}}}}}if(fm===this.user.email||fm===this.user.id){fq=eA("You");fl=!this.contacts_only}if(!fo&&fm){fo=fm.toString()}return fn={display:fo,value:fm,type:T,valid:fl,external:fp,bubble_title:fq}},getTokenClass:function(T){if(!T.valid){return"token-error"}if(T.external){return"token-warn"}return"token-valid"},notifyExternal:function(fl){var T,fm,fn;fn=fl.memo;if(fn.external){fm=this.token_manager.tokens.filter(function(fo){return fo.info.external});T=fm?fm.length:0;return this.element.fire("sf:token:external",{count:T})}}});var j;j=D.TeamSharedFolderInviteController=(function(){function T(fl){var fm;this.element=$(fl[0]);fm=this.element.down(".new-collab-input");fm.observe("sf:token:external",this.handle_external.bind(this))}T.prototype.handle_external=function(fm){var fl,fn;fl=fm.memo.count;fn=this.element.down(".external-invite-message");if(fl>1){ds.fillVal(fl,"external-invite-num");if(fn!=null){fn.removeClassName("single")}return fn!=null?fn.show():void 0}else{if(fl===1){if(fn!=null){fn.addClassName("single")}return fn!=null?fn.show():void 0}else{return fn!=null?fn.hide():void 0}}};return T})();var aj;aj=INLINE_JS.SharingModel=D.SharingModel={ALBUM_THUMB_SIZE:260,ALBUM_PADDING:40,THUMBS_BATCH_SIZE:12,filename:null,c2d_vars:{},is_folder:false,is_album:false,gallery_enabled:false,gallery_showing:false,file_viewer_files:[],send_link_autocompleter:null,team_only_shmodel:false,owner_name:null,init:function(fl,T,fm){this.filename=fl;this.c2d_vars=T;this.c2d_url=fm!=null?fm:"/sm/c2d";this.init_logger();bE(".nav-close").on("click",this.close_embedded_fileviewer.bind(this));return on_script_loaded((function(fn){return function(){var fq,fp,fo;fp=$("login-create-an-account");if(fp){fp.writeAttribute("href","/register?signup_tag=shmodel")}scrollTo(1,0);scrollTo(0,0);bE("#download_button_link[data-dl-link]").on("click",fn.download_zip);fn.set_viewport_size();fq=function(fs,fr){return fn.do_c2d(fr.id)};bE("#c2d-modal .login-form").on("db:login:success",fq);bE("#c2d-modal .register-form").on("db:register:success",fq);fo=F.parse(window.location.href);if(fo.getQuery()["force_dl"]){fo.updateQuery({force_dl:0,dl:1});return window.location=fo.toString()}}})(this))},init_folder:function(fl,fn,fm,T){this.is_folder=true;this.gallery_enabled=fl;this.gallery_showing=fn;this.file_viewer_files=fm;this.file_view_mode=T;return on_script_loaded((function(fo){return function(){fo.load_thumbs();bE("#gallery-toggle").click(function(){return fo.switch_mode("gallery")});bE("#list-toggle").click(function(){return fo.switch_mode("list")});bE(".file-link").click(function(fp){return fo.open_file_viewer(bE(fp.currentTarget).data("mediaIndex"))});return bE(document).on(aF.FILE_ACTIVITY_UPDATE,function(fq,fp,fr){return bE("[data-file-activity-key='"+fr.activity_key+"']").find(".comment-count-bubble-wrapper").each(function(){var fs;return(fs=this.reactComponent)!=null?fs.setProps({unresolvedCommentCount:fr.unresolvedCommentCount(),unseenCommentCount:fr.unseenCommentCount()}):void 0})})}})(this))},open_file_viewer:function(T){if(!bx.isNumber(T)||T<0){return}m.show(this.file_viewer_files[T],cK.get_viewer(),{files:this.file_viewer_files,file_view_mode:this.file_view_mode});m.set_preview_url();return false},init_album:function(){this.is_album=true;this._resize_album_view();Event.observe(window,"resize",this._resize_album_view.bind(this));return on_script_loaded((function(T){return function(){return bE("#add_to_my_dropbox_link").on("click",function(){return T.show_c2d_modal()})}})(this))},init_file:function(){this.is_folder=false;if(!this.c2d_vars.subpath&&(this.c2d_vars.item_id==null)&&!this.c2d_vars.is_package){return this.c2d_vars.subpath="/"+this.filename}},get_thumbnail_for_file:function(fl){var fm,T;T=fl.icon.split("_");T.pop();fm=T.join("_");return"/static/images/icons128/"+fm+".png"},init_logger:function(){on_script_loaded((function(T){return function(){var fl;fl=$("login-hover-link");if(fl){fl.observe("click",function(){return aN.log(aN.CLICK_SIGN_IN)});fl.observe("click",function(){return dK.log("click_sign_in")})}if($("download_button_link")){aN.attachLogListener(aN.CLICK_DOWNLOAD,$("download_button_link"))}fl=$("add_to_my_dropbox_link");if(fl){aN.attachLogListener(aN.CLICK_ADD_TO_MY_DROPBOX,fl);dK.attachLogListener("click_add_to_my_dropbox",fl)}if($$(".remove-link").length){aN.attachLogListener(aN.REMOVE_LINK,$$(".remove-link")[0])}if($$(".shmodel-filename").length){aN.attachLogListener(aN.CLICK_FILENAME,$$(".shmodel-filename")[0])}fl=$("default_content_download_button");if(fl){aN.attachLogListener(aN.CLICK_DOWNLOAD,fl)}fl=$("default_content_a2md");if(fl){aN.attachLogListener(aN.CLICK_ADD_TO_MY_DROPBOX,fl)}fl=bE("#login-create-an-account")[0];aN.attachLogListener(aN.CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN,fl);fl=bE("#login-hover-cont .login-form")[0];aN.attachLogListener(aN.LOGIN_THRU_DEFAULT_DROPDOWN,fl);return bE("#share-button").click(function(fm){return aN.log(aN.CLICK_SHARE)})}})(this));return document.observe(aJ.ACTIONS_ADDED,(function(T){return function(){var fo,fn,fl,fm;fm=$("view_original");if(fm){aN.attachLogListener("shmodel_lightbox_click_vieworiginal",fm)}fn=$("lightbox_share_link");if(fn){aN.attachLogListener("shmodel_lightbox_click_getlink",fn)}fl=bE("lightbox-share-link");if(fl[0]){aN.attachLogListener("shmodel_lightbox_click_getlink",fl[0])}fo=$("lightbox_download_link");if(fo){return aN.attachLogListener("shmodel_lightbox_click_download",fo)}}})(this))},set_team_only_shmodel:function(fl,T){this.team_only_shmodel=fl;return this.owner_name=T},_resize_album_view:function(){var T;T=Math.floor((B.viewport_dimensions().width-2*this.ALBUM_PADDING)/this.ALBUM_THUMB_SIZE)*this.ALBUM_THUMB_SIZE;return $("content-wrapper").setStyle({display:"block",width:""+T+"px"})},load_thumbs:function(){var fl,T;T=this.gallery_showing?$$(".gallery-icon-view img"):$$(".browse-files .icon");fl=function(fm){if(!fm.src.endsWith(cv.SPACER)){return fm.addClassName("thumbnail")}};return bs.batch_load_thumbs(T,this.THUMBS_BATCH_SIZE,fl)},switch_mode:function(fq){var fm,fr,fp,T,fo,fl,fn;fn=$A(["gallery","list"]);for(fo=0,fl=fn.length;fo<fl;fo++){T=fn[fo];fr=$(T+"-view-container");fm=$(T+"-toggle");if(fq===T){fr.show();fm.addClassName("selected")}else{fr.hide();fm.removeClassName("selected")}}if(history.replaceState){fp=window.location.pathname;if(fq==="list"){fp+="?lst"}history.replaceState({},"",fp)}this.gallery_showing=!this.gallery_showing;return this.load_thumbs()},set_viewport_size:function(){var T;if($(document.body).hasClassName("mobile")){T=new Element("meta",{name:"viewport",content:"width = 480"});return document.head.appendChild(T)}},toggle_dropdown:function(fn,fo,fm){var T,fl;if(fn){Event.extend(fn).preventDefault()}if(!fo.visible()){if(this.is_album){return eU.show(fo,fm,null,true)}else{fl=$$(".nav-header").first().getHeight();T=$$(".nav-header .buttons").first().cumulativeOffset().top-4;if(T<0&&d5.ie8){T=4}return eU.show(fo,fm,fl-T,true)}}},prepare_confirm_remove_modal:function(fl,fn,T,fp,fu,fq,ft,fr){var fm,fo,fs;if(T){fs=fp?eA("Unshare?"):eA("Unshare album?");fm=bE("#album-disable-token-modal")[0];ds.fillVal(fl.escapeHTML(),"album_unshare_name")}else{if(fq){fs=eA("Remove link created by %(name)s").format({name:ft});if(fn){fo=eA('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this folder.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}else{fo=eA('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this file.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}fo=fo.format({fname:bU.em_snippet(fl,17),owner:ft,owner_email:fr})}else{fs=eA("Remove link to '%(name)s'").format({name:bU.em_snippet(fl,17)});if(fn){fo=eA("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this folder.")}else{fo=eA("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this file.")}}fm=bE("#disable-token-modal")[0];ds.fillVal(fo,"disable-token-desc")}return{title:fs,contents:fm}},confirm_remove:function(fl,fp,fm,T,fn,ft,fq,fs,fr){var fo;if(fm==null){fm=false}if(T==null){T=false}if(fn==null){fn=false}if(ft==null){ft=null}if(fq==null){fq=false}if(fs==null){fs=null}if(fr==null){fr=null}cJ(fp,"confirm_remove missing tkey");cJ(fl,"confirm_remove missing name");cJ(ft,"confirm_remove missing user_id");cJ(!fq||!T,"admin removal of collections not supported");cJ(!fq||fs,"missing link owner name for admin removal");cJ(!fq||fr,"missing link owner email for admin removal");if(!cK.get_viewer().is_uid_signed_in(ft)){bO.show_modal({user_id:ft,on_success:(function(fu){return function(){return fu.confirm_remove(fl,fp,fm,T,fn,ft,fq,fs,fr)}})(this)});return}fo=aj.prepare_confirm_remove_modal(fl,fm,T,fn,ft,fq,fs,fr);return fc.show(fo.title,fo.contents,{token:fp,name:fl,is_album:T,user_id:ft})},confirm_remove_from_event_gid:function(T,fs,fm,fr,fo,fq,fp,fl){var fn;if(fo==null){fo=false}if(fq==null){fq=null}if(fp==null){fp=null}if(fl==null){fl=null}cJ(fs,"confirm_remove missing event gid");cJ(T,"confirm_remove missing name");cJ(fr,"confirm_remove missing user_id");cJ(cK.get_viewer().is_uid_signed_in(fr),"user not logged in");cJ(!fo||fq,"missing link owner name for admin removal");cJ(!fo||fp,"missing link owner email for admin removal");fn=aj.prepare_confirm_remove_modal(T,fm,false,false,fr,fo,fq,fp);return fc.show(fn.title,fn.contents,{name:T,user_id:fr,activity_log_event_gid_dbase64:fs,redirect_to_member_id:fl})},do_remove:function(fn){var T,fm,fl;cJ(fn.token||fn.activity_log_event_gid_dbase64,"missing token or event gid_dbase64");T=bE("#modal-content input").first();T.attr("disabled",true);bE("#modal-content").addClass("ajax-loading");fl=window.location.pathname;if((fl==="/links"||fl==="/links/your_links"||fl==="/recents")||fl.match("^/home|^/work|^/personal")){return new Ajax.DBRequest("/sm/disable/"+fn.token,{subject_user:fn.user_id,onSuccess:(function(fo){return function(){var fp;fc.hide();if(fn.is_album){fp=eA("Unshared '%(name)s'")}else{fp=eA("Removed link for '%(name)s'")}fp=fp.format({name:fn.name});ae.success(fp);return document.fire(aF.LINKS_REMOVE,{token:fn.token})}})(this),onComplete:(function(fo){return function(){T.attr("disabled",false);return bE("#modal-content").removeClass("ajax-loading")}})(this)})}else{if(fn.token){fm=F({path:"/sm/disable/"+fn.token})}else{fm=F({path:"/sm/disable_by_event_gid/"+fn.activity_log_event_gid_dbase64});fm.updateQuery("redirect_to_member_id",fn.redirect_to_member_id).toString()}return bT.postRequest(fm.updateQuery(Constants.UID_PARAM_NAME,fn.user_id).toString())}},show_shmodal_onload:function(fm,fn,fl,T){if(T==null){T=null}return bE((function(fo){return function(){eD.remove_query_param("m");if(!cK.get_viewer().is_uid_signed_in(T)){bO.show_modal({user_id:T,on_success:function(){return fo.show_shmodal_onload(fm,fn,fl,T)}});return}if((T!=null)&&d3.get_for_user(cK.get_viewer().get_user_by_id(T)).verified_or_show()){return fo.show_shmodal(fm,fn,fl,T)}else{if(T==null){cJ(cK.get_viewer().is_paired,"Expected viewer to be paired.");return fo.show_share_shmodel_role_chooser(fm,fn,fl)}}}})(this))},show_shmodal:function(fl,fr,T,fx){var fw,ft,fv,fs,fp,fq,fn,fm,fu,fo;this.url=fl;this.short_url=fr;if(!cK.get_viewer().is_uid_signed_in(fx)){bO.show_modal({user_id:fx,on_success:(function(fy){return function(){return fy.show_shmodal(fl,fr,T,fx)}})(this)});return}fn=cK.get_viewer().get_user_by_id(fx);if(d3.get_for_user(fn).verified_or_show()){fq="shmodal-user-"+fx;fc.show(this._get_shmodal_title(fn.is_team),ds.fromElm($(fq)));fp={};fp[Constants.UID_PARAM_NAME]=fx;bT.add_vars("shmodal-send-form",fp);if(this._get_thumbnail_type()){fo=$$(".shmodal-image");for(fm=0,fu=fo.length;fm<fu;fm++){fs=fo[fm];fs.addClassName("thumbnail")}}if(T==="contacts"){fv=Autocompleter.ContactsTokenizer}else{fv=Autocompleter.TeamTokenizer}this.send_link_autocompleter=new fv(fn,fq+"-new-collab-input",fq+"-new-whobulk",fq+"-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true,team_only:T==="team_only",user_id:fx});this.configure_dropdown();if(!this.disabled){if(FlashDetect.installed){fw=s.clipboard_overlay(fl,bE("#"+fq+"-copy-link"),aj.copied_to_clipboard);fw.css({position:"fixed",zIndex:1001});fw.children().height(fw.height());clearInterval(this.follow_freshbutton);ft=(function(fy){return function(){return fw.clonePosition(bE("#"+fq+"-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);this.follow_freshbutton=setInterval(ft,500)}else{$(fq+"-copy-link").hide()}}ch._create($("modal").down(".custom-message-container"));ch._create($("modal").down(".fb-post-sickinput"));ch._create($("modal").down(".twitter-post-sickinput"));this._populate_twitter_info(fr,fx);$(fq+"-new-collab-input").focus();return aN.log("shmodal_show")}},configure_dropdown:function(){var fo,fl,fn,T,fm;fm=$$(".dropdown-menu-container");for(fn=0,T=fm.length;fn<T;fn++){fo=fm[fn];fl=fo.down(".dropdown-menu-trigger");if(fl!=null){fl.observe("click",(function(fp){return function(fr){var fq;fq=fr.target.up(".dropdown-menu-container");return fq.toggleClassName("dropdown-shown")}})(this))}}return document.on("click",(function(fp){return function(fv){var ft,fu,fs,fq,fr;if(fv.target.hasClassName("dropdown-menu-trigger")||fv.target.up(".dropdown-menu-trigger")){return}fq=$$(".dropdown-shown");fr=[];for(fu=0,fs=fq.length;fu<fs;fu++){ft=fq[fu];fr.push(ft.removeClassName("dropdown-shown"))}return fr}})(this))},copied_to_clipboard:function(){ae.success(eA("Link copied to clipboard"));fc.hide();aN.log("shmodal_copy_link");return ba.ViralLogger.log(cK.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_copy_link",file_type:aj.is_album?"collection":aj.is_folder?"folder":aj.filename.indexOf(".")===-1?"file":cR.EXTENSION_TO_CATEGORY[ay.file_extension(aj.filename).toLowerCase()]||"file"})},get_shmodel_send_recipients:function(fm){var fn,fv,fs,fw,fx,fq,ft,T,fp,fo,fu,fl,fr;cJ(fm,"Must pass the shmodal send form into get_shmodel_send_recipients");fn=fm.select('input[name="emails"]');fv=fm.select('input[name="fb_ids"]');fs=fm.select('input[name="group_ids"]');fq=fm.select('input[name="new_style_group_ids"]');T=[];fr=[fn,fv,fs,fq];for(fp=0,fu=fr.length;fp<fu;fp++){fx=fr[fp];for(fo=0,fl=fx.length;fo<fl;fo++){fw=fx[fo];ft=fw.up().innerHTML.stripTags().escapeHTML();T.push(ft.substring(0,ft.indexOf("&")))}}return T},close_embedded_fileviewer:function(fl){var T;fl.preventDefault();T=new ev();T.configureParentMessaging(function(){},["parent-ready"]);T.startListening();return T.postMessageToParent("close-fileviewer")},send_shmodel_link:function(fn){var fm,fl,fo,T;fm=$("shmodal-send-form");cJ(fm,"Couldn't find the shmodal send form.");T=this.get_shmodel_send_recipients(fm);fo=(function(fp){return function(fq){var fr;fr=aY.success_string_for_recipients(T);ae.success(fr);fc.hide();return aN.log("shmodal_send")}})(this);fl=(function(fp){return function(fq){return bT.remove_loading()}})(this);return bT.ajax_submit(fm,"/sm/share",fo,fl,fm.down(".tokenizer-submit-button"))},show_content:function(fl){var fo,fn,T,fm;$("shmodal-title-text").__date(dn.to_title_str(fl));fm=dn.list;for(fn=0,T=fm.length;fn<T;fn++){fo=fm[fn];if(fo!==fl){$(dn.to_toggle_str(fo)).removeClassName("toggled");$(dn.to_content_str(fo)).hide()}}$(dn.to_content_str(fl)).show();$(dn.to_toggle_str(fl)).addClassName("toggled");return bE("#modal .focusarea").focus()},show_send_content:function(){return this.show_content(dn.SEND)},show_fb_content:function(){return this.show_content(dn.FB)},show_twitter_content:function(){return this.show_content(dn.TWITTER)},start_fb_post:function(fo,fl){var fp,fm,T,fn;fm=(function(fq){return function(){return es.do_auth(fq.do_fb_post.curry(fo,fl),fl)}})(this);fp=bE("#modal:visible, #modal-overlay:visible");T=function(){return fp.show()};if(es.authed_user_id===fl){return this.do_fb_post(fo,fl)}else{if(cK.get_viewer().is_uid_associated(es.authed_user_id)){fp.hide();fn=new ed(cK.get_viewer().get_user_by_id(fl),T,fm.bind(this));return fn.show()}else{return fm()}}},start_twitter_post:function(T){if(cD.is_authed(T)){return this.do_twitter_post(T)}else{return cD.do_auth(this.do_twitter_post,T)}},do_fb_post:function(fl,T){es.custom_show_posting=function(){return bT.add_loading($("shmodal-fb-post-submit"))};es.custom_show_complete=function(){fc.hide();ae.success(eA("Successfully posted to Facebook"));aN.log("shmodal_fb_post");return ba.ViralLogger.log(cK.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_fb_post",file_type:aj.is_album?"collection":aj.is_folder?"folder":aj.filename.indexOf(".")===-1?"file":cR.EXTENSION_TO_CATEGORY[ay.file_extension(aj.filename).toLowerCase()]||"file"})};return es.post($F("shmodal-fb-post-input"),fl,null,null,null,function(){return fc.hide()},T)},do_twitter_post:function(T){var fl;fl=$F("shmodal-twitter-post-input");if(!fl){ae.error(eA("Please enter a Twitter post"));return}else{if(fl.length>140){ae.error(eA("Your post must be 140 characters or less"));return}}cD.custom_show_posting=function(){$("twitter-chars").hide();return bT.add_loading($("shmodal-twitter-post-submit"))};return cD.custom_post(fl,(function(fm){return function(){fc.hide();ae.success(eA("Successfully posted to Twitter"));aN.log("shmodal_tweet");return ba.ViralLogger.log(cK.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_twitter",file_type:aj.is_album?"collection":aj.is_folder?"folder":aj.filename.indexOf(".")===-1?"file":cR.EXTENSION_TO_CATEGORY[ay.file_extension(aj.filename).toLowerCase()]||"file"})}})(this),T)},_get_shmodal_title:function(T){if(T==null){T=false}return this.generate_title_content(this._get_shmodal_title_text(),((function(fl){return function(){return fl.show_send_content()}})(this)),((function(fl){return function(){return fl.show_fb_content()}})(this)),((function(fl){return function(){return fl.show_twitter_content()}})(this)),T)},generate_title_content:function(fl,fs,fp,fu,fn){var fo,fq,T,ft,fm,fr;if(fn==null){fn=false}ft=bE("<div/>",{id:"shmodal-title"});fm=bE("<div/>",{id:"shmodal-title-text",text:fl});ft.append(fm);if(!fn){T=bE("<a/>",{id:"shmodal-send-toggle","class":"freshtoggle ft-left toggled"});T.html(cv.make("web","email_20"));T.on("click",fs);fq=bE("<a/>",{id:"shmodal-fb-toggle","class":"freshtoggle ft-middle"});fq.html(cv.make("web","fb_20"));fq.on("click",fp);fr=bE("<a/>",{id:"shmodal-twitter-toggle","class":"freshtoggle ft-right"});fr.html(cv.make("web","twitter_20"));fr.on("click",fu);ft.append([T,fq,fr])}fo=bE("<div/>",{"class":"clear"});ft.append(fo);return ft[0]},_get_shmodal_title_text:function(){var fl,T;if(this.is_folder){fl=eA("Share link to \u2018%(folder_name)s\u2019");return fl=fl.format({folder_name:bU.em_snippet(this.filename,15)})}else{T=this._get_thumbnail_type();if(T===cR.CATEGORY_TO_TRANSLATION.IMAGE){return eA("Share this image")}else{if(T===cR.CATEGORY_TO_TRANSLATION.VIDEO){return eA("Share this video")}else{return eA("Share '%(filename)s'").format({filename:bU.em_snippet(this.filename,18)})}}}},_get_thumbnail_type:function(){var fl,T;if(this.filename.indexOf(".")===-1){return false}T=ay.file_extension(this.filename).toLowerCase();fl=cR.EXTENSION_TO_CATEGORY[T];if(fl&&(fl==="IMAGE"||fl==="VIDEO")){return cR.CATEGORY_TO_TRANSLATION[fl]}return false},_populate_twitter_info:function(fm,T){var fn,fl;fn=this.is_folder?eA("Just shared some files using @Dropbox"):(fl=this._get_thumbnail_type(),fl&&fl===cR.CATEGORY_TO_TRANSLATION.IMAGE?eA("Just shared an image using @Dropbox"):eA("Just shared a file using @Dropbox"));$("shmodal-twitter-post-input").setValue(fn+" "+fm);d5._track_twitter_chars_left("shmodal-twitter-post-input",140);if(cD.is_authed(T)){return cD.get_user_info(function(fo){$("shmodal-twitter-profile").down(".profile-pic").__date(new Element("img",{src:fo.profile_image_url_https}));$("shmodal-twitter-profile").down(".name").__date(fo.name);$("shmodal-twitter-profile").down(".username").__date("@"+fo.screen_name);$("modal").down(".twitter-post-sickinput").addClassName("shrank");return $("shmodal-twitter-profile").show()},T)}},download_zip:function(fn){var fl,fm,fo,T,fp;fl=bE("#download_button_link").attr("data-dl-link");fp=bE("#download_button_link").attr("data-test-link");T=bE("#download_button_link").attr("data-owner")==="true";fo=(function(fq){return function(fr){var fs;if(fr==="OK"){window.location=fl}else{if(fr.indexOf("err:")===0){if(T){fs=eA("The zip file is too large.")}else{fs=eA("The zip file is too large. Please add it to your Dropbox.")}ae.error(fs)}else{ae.error(eA("Failed to download zip file."))}}return false}})(this);fm=(function(fq){return function(fr){ae.error(eA("Failed to download zip file."));return false}})(this);if(fp&&bE.support.cors===true){bE.ajax({url:fp,type:"POST",success:fo,error:fm})}else{window.location=fl}return false},show_share_shmodel_role_chooser:function(fl,fm,T){if(this.shmodel_select_role_modal==null){this.shmodel_select_role_modal=new dx({element_id:"share-shmodel-select-role-modal",link_url:fl,short_url:fm,tokenizer_type:T})}return this.shmodel_select_role_modal.show().set_title(this._get_shmodal_title_text())},prompt_login_then_share:function(fl,fm,T,fo){var fn;fn=(function(fp){return function(){var fq;fc.hide();bE("#role-selector option").removeClass("disabled");fq=cK.get_viewer().get_uid_by_role(fo);cK.get_viewer().sign_in_user_by_id(fq);ba.ShmodelUILogger.log("via-shmodel-viewer");return aj.show_shmodal(fl,fm,T,fq)}})(this);if(!cK.get_viewer().is_role_signed_in(fo)){dE.not_logged_in_role=fo;return bO.show_modal({role:fo,on_success:fn})}else{return fn()}},show_c2d_modal:function(fq,fl){var fp,T,fo,fm,fn;if(fq==null){fq=""}if(fl==null){fl=false}if(fq){if(fq===Constants.ROLE_PERSONAL){cJ(this.team_only_shmodel!=="forbid","Can't copy to personal Dropbox if restricted")}if(!cK.get_viewer().is_role_signed_in(fq)){bO.show_modal({role:fq,on_success:(function(fr){return function(){return fr.show_c2d_modal(fq)}})(this)});return}}else{if(cK.get_viewer().is_paired){new aQ({element_id:"select-role-modal"}).show();return}}if(fq){fm="#c2d-modal-"+fq}else{fm="#c2d-modal"}fn=this._c2d_modal_msg(fq,cK.get_viewer().team_name);fp=this._c2d_modal_button_msg(fq,cK.get_viewer().team_name);T=this._c2d_modal_desc(fq,cK.get_viewer().team_name);if(fl){T=this._c2d_modal_team_only_desc(cK.get_viewer().team_name)+"<br/><br/>"+T}fo=this._c2d_modal_login_desc(fq,cK.get_viewer().team_name);ds.fillVal(T,"c2d-desc");ds.fillVal(fo,"c2d-login-desc");bE(".c2d-submit-button").val(fp);bE(".c2d-login-register-desc").hide();if(this.is_album){bE(".c2d-login-register-album-desc").show()}else{if(this.is_folder){bE(".c2d-login-register-folder-desc").show()}else{bE(".c2d-login-register-file-desc").show()}}return fc.show(fn,bE(fm)[0],false,false,false,false)},_c2d_modal_msg:function(fn,fl){var T,fm;if(fn==null){fn=""}if(fl==null){fl=""}if(this.c2d_vars.title){return fm=this.c2d_vars.title}else{if(fn===Constants.ROLE_PERSONAL){fm=eA("Save '%(filename)s' to my personal Dropbox");return fm.format({filename:bU.em_snippet(this.filename,10)})}else{if(fn===Constants.ROLE_WORK){fm=eA("Save '%(filename)s' to my %(team_name)s Dropbox");T=Math.max(10,15-new bU(fl).length);return fm.format({filename:bU.em_snippet(this.filename,T),team_name:fl})}else{fm=eA("Save '%(filename)s' to my Dropbox");return fm.format({filename:bU.em_snippet(this.filename,15)})}}}},_c2d_modal_button_msg:function(fm,T){var fl;if(fm==null){fm=""}if(T==null){T=""}if(fm===Constants.ROLE_PERSONAL){return fl=eA("Save to my personal Dropbox")}else{if(fm===Constants.ROLE_WORK){fl=eA("Save to my %(team_name)s Dropbox");return fl.format({team_name:T})}else{return eA("Save to my Dropbox")}}},_c2d_modal_team_only_desc:function(T){var fl;if(this.is_album){fl=eA("You can only add this album to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the album to members of <b>%(team_name)s</b>.")}else{if(this.is_folder){fl=eA("You can only add this folder to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the folder to members of <b>%(team_name)s</b>.")}else{fl=eA("You can only add this file to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the file to members of <b>%(team_name)s</b>.")}}return fl.format({owner_name:this.owner_name,team_name:T})},_c2d_modal_desc:function(fm,T){var fl;if(fm==null){fm=""}if(T==null){T=""}if(fm===Constants.ROLE_PERSONAL){if(this.is_album){if(this.team_only_shmodel==="warn"){fl=eA("The photos and videos in this album were sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy them to your personal Dropbox?");return fl.format({owner_name:this.owner_name,team_name:T})}else{return fl=eA("The photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.is_folder){if(this.team_only_shmodel==="warn"){fl=eA("This folder was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return fl.format({owner_name:this.owner_name,team_name:T})}else{return fl=eA("This folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.team_only_shmodel==="warn"){fl=eA("This file was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return fl.format({owner_name:this.owner_name,team_name:T})}else{return fl=eA("This file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}}else{if(fm===Constants.ROLE_WORK){if(this.is_album){fl=eA("The photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){fl=eA("This folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{fl=eA("This file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return fl.format({team_name:T})}else{if(this.is_album){return eA("The photos and videos in this album will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{if(this.is_folder){return eA("This folder will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{return eA("This file will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}}}}},_c2d_modal_login_desc:function(fm,T){var fl;if(fm==null){fm=""}if(T==null){T=""}if(fm===Constants.ROLE_PERSONAL){if(this.is_album){return fl=eA("Once you sign in to your personal Dropbox, the photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{if(this.is_folder){return fl=eA("Once you sign in to your personal Dropbox, this folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{return fl=eA("Once you sign in to your personal Dropbox, this file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}else{if(fm===Constants.ROLE_WORK){if(this.is_album){fl=eA("Once you sign in to your %(team_name)s Dropbox, the photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){fl=eA("Once you sign in to your %(team_name)s Dropbox, this folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{fl=eA("Once you sign in to your %(team_name)s Dropbox, this file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return fl.format({team_name:T})}}},do_c2d:function(T){var fl;cJ(T,"Must specify a user_id for saving to Dropbox.");fl=eA("Saving to your Dropbox...");if(cK.get_viewer().is_paired){if(cK.get_viewer().get_user_by_id(T).is_team){fl=eA("Saving to your %(team_name)s Dropbox...");fl=fl.format({team_name:cK.get_viewer().team_name})}else{fl=eA("Saving to your personal Dropbox...")}}ae.success(fl);fc.hide();return new Ajax.DBRequest(this.c2d_url,{parameters:this.c2d_vars,job:this.is_folder,progress_text:fl,subject_user:T,onSuccess:(function(fm){return function(fn){if(fn.responseText){return b1.redirect(fn.responseText)}}})(this)})},c2d_show_twofactor_error:function(fl){var T;T=$("c2d-twofactor-error");T.__date(fl);return T.show()},c2d_hide_twofactor_error:function(T){return $("c2d-twofactor-error").__date()},c2d_show_twofactor_error500:function(){return this.c2d_show_twofactor_error(eA("Sorry, an error occured. Please try again later."))},c2d_show_twofactor_error_bad_carrier:function(){return this.c2d_show_twofactor_error(eA("Unfortunately, your carrier is not supported at this time."))},c2d_show_twofactor_error_invalid_number:function(){return this.c2d_show_twofactor_error(eA("That is not a valid phone number."))},c2d_show_twofactor_error_not_a_mobile:function(){return this.c2d_show_twofactor_error(eA("That phone number does not appear to be a valid mobile number."))},c2d_show_twofactor_error_unreachable:function(){return this.c2d_show_twofactor_error(eA("We couldn't reach your phone number. Are you sure it's correct?"))},c2d_show_twofactor_error_invalid:function(){return this.c2d_show_twofactor_error(eA("Invalid code."))},c2d_is_resending:function(){return $("c2d-resend-link").hasClassName("resending")},c2d_show_resending:function(){return $("c2d-resend-link").addClassName("resending")},c2d_hide_resending:function(){return $("c2d-resend-link").removeClassName("resending")},c2d_hide_resending_with_delay:function(){return setTimeout(this.c2d_hide_resending.bind(this),3000)}};var dn;dn=D.ShmodalPanes={SEND:0,FB:1,TWITTER:2,list:[0,1,2],_content_str:["shmodal-send-content","shmodal-fb-content","shmodal-twitter-content"],_toggle_str:["shmodal-send-toggle","shmodal-fb-toggle","shmodal-twitter-toggle"],_title_str:["Share by Email",eA("Share on Facebook"),eA("Share on Twitter")],to_content_str:function(T){return this._content_str[T]},to_toggle_str:function(T){return this._toggle_str[T]},to_title_str:function(T){if(T===0){return aj._get_shmodal_title_text()}return this._title_str[T]},to_focus_str:function(T){return this._focus_str[T]}};var Y,dg,bL,du=function(T,fl){return function(){return T.apply(fl,arguments)}},au={}.hasOwnProperty,cN=function(fn,fl){for(var T in fl){if(au.call(fl,T)){fn[T]=fl[T]}}function fm(){this.constructor=fn}fm.prototype=fl.prototype;fn.prototype=new fm();fn.__super__=fl.prototype;return fn};dg=INLINE_JS.ShareLinkModal=D.ShareLinkModal=(function(T){cN(fl,T);function fl(fm,fp,fn,fr,fq){var fo,fs;this.user_id=fm;if(fr==null){fr=false}if(fq==null){fq=void 0}this.before_show=du(this.before_show,this);this.show=du(this.show,this);this.prompt_login_then_show=du(this.prompt_login_then_show,this);fs={origin:fn};fs[Constants.UID_PARAM_NAME]=this.user_id;if(fq){fo=F({path:"/sm/get_link_modal_content/"+fq}).toString()}else{fo=F({path:"/sm/share_link"+fp}).toString()}fl.__super__.constructor.call(this,{element_id:"share-link-modal",endpoint_url:fo,parameters:fs})}fl.prototype.prompt_login_then_show=function(){var fm;fm=(function(fn){return function(){fc.hide();bE("#role-selector option").removeClass("disabled");cK.get_viewer().sign_in_user_by_id(fn.user_id);ba.ShmodelUILogger.log("via-shmodel-viewer");return fn.show()}})(this);if(!cK.get_viewer().is_uid_signed_in(this.user_id)){return bO.show_modal({user_id:this.user_id,on_success:fm})}else{return fm()}};fl.prototype.show=function(){var fm;fm=cK.get_viewer().get_user_by_id(this.user_id);if(d3.get_for_user(fm).verified_or_show(et.SHMODAL)){return fl.__super__.show.call(this)}};fl.prototype.before_show=function(){var fp,fo,fm,fn;fn=this.$modal_window.find(".share-link-modal-content").length;if(fn){fp={"class":"ajax-loading-indicator",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"};fm=bE("<img />",fp);fo=bE("<div />",{"class":"loading-spinner"}).append(fm);return this.$modal_window.find(".dynamic-content").html(fo)}};return fl})(cB);bL=D.ShareLinkModalContent=(function(){function T(fq,fr,fs,ft,fl,fm,fw,fp,fu){var fv,fx,fo,fn;this.owner_id=fq;this.tkey=fr;this.fq_path=fs;this.link=ft;this.filename=fl;this.tokenizer_type=fm;this.tokenizer_ctx_str=fw;this.fq_path_of_restricting_sf=fu;this._send_link=du(this._send_link,this);this._show_shared_link_settings_modal=du(this._show_shared_link_settings_modal,this);this._show_shared_folder_settings_modal=du(this._show_shared_folder_settings_modal,this);this._select_all_text=du(this._select_all_text,this);this._toggle_send_link_button=du(this._toggle_send_link_button,this);this._toggle_recipients_outside_team_warning=du(this._toggle_recipients_outside_team_warning,this);this._toggle_close_button_text=du(this._toggle_close_button_text,this);this._listen=du(this._listen,this);this._init_autocompleter=du(this._init_autocompleter,this);this.$content=bE(".share-link-modal-content");this.modal=d7.get_containing_modal(this.$content);if(!this.modal){return}if(this.tokenizer_type==="shared_folder"){this.shared_folder_members=n.create_contacts_list(fp)}fv={filename:this.filename,fq_path:this.fq_path,tkey:this.tkey,user_id:this.owner_id};document.fire(aF.LINKS_ADD,fv);this.modal.set_title(eA("Share link to \u2018%(filename)s\u2019").format({filename:bU.em_snippet(this.filename,15)}));this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);this.$send_link_button=this.$content.find(".confirm-button");this.$share_link_url_input=this.$content.find(".copy-link-input-container input[type='text']");this.$cancel_button=this.$content.find(".cancel-button");this._init_autocompleter();this._listen();if((fo=this.$share_link_url_input[0])!=null){fo.select()}if(((fn=ax.getGandalfRule("people-link-profile-on-share-experiment"))===null||fn==="CONTROL")&&ax.isGandalfInVariant("people-default-show-import-shmodal-experiment","EXPERIMENT")&&this.tokenizer_type!=="shared_folder"){fx=(function(fy){return function(fz){var fA;fA=bE(fy.autocompleter.element).closest(".tokenized_autocompleter_container").attr("data-provider");fy.autocompleter.activate();bE(fy.autocompleter.get_entry_container()).addClass("people-default-show-import-shmodal-experiment");if(container.find("#autocompleter_item_tmpl")!=null){return ba.PeopleExperimentsLogger.log(ba.PeopleExperimentsLogger.DEFAULT_SHOW_IMPORT_SHOW,fy.owner_id,{provider:fA})}}})(this);bj.get_linked_profile_services_for_user(this.owner_id,fx)}}T.prototype._init_autocompleter=function(){var fl,fm;fl={tokens:[",",";"],include_fb:true,include_team:true,team_only:this.tokenizer_type==="team_only",user_id:this.owner_id};if(this.tokenizer_type==="shared_folder"){this.autocompleter=new Autocompleter.SharedFolderTokenizer(cK.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",fl,this.shared_folder_members)}else{if(this.tokenizer_type==="contacts"){this.autocompleter=new Autocompleter.ContactsTokenizer(cK.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",fl)}else{this.autocompleter=new Autocompleter.TeamTokenizer(cK.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",fl)}}fm=(function(fn){return function(fo){return function(){return fn.autocompleter.contact_search_logger.log_records(fn.owner_id,fo)}}})(this);this.modal.logger_keydown_close_handler=fm(true);this.modal.$overlay.on("click",fm(true));this.modal.$db_modal_x.on("click",fm(true));this.$send_link_button.on("click",fm(false));this.$cancel_button.on("click",fm(true));ch.init();return this.$collab_input.focus()};T.prototype._listen=function(){var fn,fl,fq,fp,fo,fm;this.$send_link_button.on("click",this._send_link);this.$share_link_url_input.on("click",this._select_all_text);this.$cancel_button.on("click",(function(fr){return function(fs){return d0.pop()}})(this));this.$content.find("#shared-link-permissions-link").on("click",this._show_shared_link_settings_modal);this.$content.find("#shared-folder-options-link").on("click",this._show_shared_folder_settings_modal);if((fn=this.$collab_input)!=null){fn.keyup(this._toggle_send_link_button)}if((fl=this.$collab_input)!=null){fl.on("input",this._toggle_send_link_button)}if((fq=this.$collab_input[0])!=null){fq.observe("token:remove",this._toggle_send_link_button)}if((fp=this.$collab_input[0])!=null){fp.observe("token:add",this._toggle_close_button_text)}if((fo=this.$collab_input[0])!=null){fo.observe("token:remove",this._toggle_close_button_text)}return(fm=this.$collab_input[0])!=null?fm.observe("sf:token:external",this._toggle_recipients_outside_team_warning):void 0};T.prototype._toggle_close_button_text=function(fn){var fl,fm;fl=((fm=this.autocompleter)!=null?fm.token_manager.tokens.length:void 0)===0;if(fl){return this.$cancel_button.text(eA("Close"))}else{return this.$cancel_button.text(eA("Cancel"))}};T.prototype._toggle_recipients_outside_team_warning=function(fn){var fl,fm;fl=bE(".external-recipient-warning-message");if(fl.length){fm=fn.memo.count;if(fn.memo.shared_folder_warning){if(fm>0){return fl.show()}else{return fl.hide()}}else{if(fm>1){fl.find(".external-recpient-num").text(fm);return fl.removeClass("single").show()}else{if(fm===1){return fl.addClass("single").show()}else{return fl.hide()}}}}};T.prototype._toggle_send_link_button=function(fn){var fl,fm;fl=((fm=this.autocompleter)!=null?fm.token_manager.tokens.length:void 0)===0;fl=fl&&bE.trim(this.$collab_input.val())==="";return this.$send_link_button.prop("disabled",fl)};T.prototype._select_all_text=function(fl){return bE(fl.currentTarget)[0].select()};T.prototype._show_shared_folder_settings_modal=function(fm){var fl;fm.preventDefault();fl=cK.get_viewer().get_user_by_id(this.owner_id);return r.show_shared_folder_options_modal(this.fq_path_of_restricting_sf,fl)};T.prototype._show_shared_link_settings_modal=function(fm){var fl;fm.preventDefault();fl=new dX(this.owner_id,this.tkey);return d0.push(fl)};T.prototype._send_link=function(fp){var fn,fm,fo,fl,fq;fo=this.$content.find(".share-link-modal-send-form")[0];fl=this.get_shmodel_send_recipients(fo);fq=(function(fr){return function(fs){var ft;ft=aY.success_string_for_recipients(fl);ae.success(ft);d0.pop();return aN.log("shmodal_send")}})(this);fm=(function(fr){return function(fs){return bT.remove_loading()}})(this);fn=this.$content.find(".tokenizer-submit-button")[0];return bT.ajax_submit(fo,"/sm/share",fq,fm,fn)};T.prototype.get_shmodel_send_recipients=function(fn){var fo,fw,ft,fx,fy,fr,fu,fl,fq,fp,fv,fm,fs;cJ(fn,"Must pass the shmodal send form into get_shmodel_send_recipients");fo=fn.select('input[name="emails"]');fw=fn.select('input[name="fb_ids"]');ft=fn.select('input[name="group_ids"]');fr=fn.select('input[name="new_style_group_ids"]');fl=[];fs=[fo,fw,ft,fr];for(fq=0,fv=fs.length;fq<fv;fq++){fy=fs[fq];for(fp=0,fm=fy.length;fp<fm;fp++){fx=fy[fp];fu=fx.up().innerHTML.stripTags().escapeHTML();fl.push(fu.substring(0,fu.indexOf("&")))}}return fl};return T})();Y=INLINE_JS.QuickSend=D.QuickSend={_files:{},_uploading_fileids:{},init:function(T,fl,fn){var fm;this.owner_id=T;this.tokenizer_ctx_str=fl;this.keep_visible=fn;this.$content=bE("#browse-root-quick-send");this.$content[0].writeAttribute("dropzone","copy move");this.$content[0].writeAttribute("quicksend","true");this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);if((fm=this.$collab_input)!=null){fm.keyup(this._toggle_send_button_state)}if(this.$collab_input[0]){this.$collab_input[0].on("token:remove",this._toggle_send_button_state);this.$collab_input[0].on("token:add",this._toggle_send_button_state)}this.$send_button=this.$content.find("#quick-send-submit");this.$send_button.on("click",this._send_link);this.$cancel_button=this.$content.find("#quick-send-cancel");this.$cancel_button.on("click",this._cancel_button_clicked);this.$import_services=this.$content.find(".autocomplete");bE("#browse-files").addClass("quicksend-collapsed");Y._update_location();this.has_autocompleter_inited=false;ba.SharedFolderActivityLogger.log("web","quick_send_displayed",cr.active_user,{});this.$collab_input.on("blur",function(){return setTimeout(function(){var fo;return(fo=Y.$import_services)!=null?fo.hide():void 0},100)});bE("#quick-send-top-choose-button-send").click(function(){return bE("#quick-send-file-box").click()});bE("#quick-send-choose-button").click(function(){return bE("#quick-send-file-box").click()});bE(".quick-send-choose-file-link").click(function(){return bE("#quick-send-file-box").click()});bE("#quick-send-file-box").on("change",function(){var fp,fo;fo=bE("#quick-send-file-box")[0].files;fp=function(){if(!cr.active_user){cr.active_user=cK.get_viewer().get_user_by_id(Y.owner_id)}return bp.upload(Y.DEST_FOLDER+"/",fo)};return Y.get_folder_name(fp)});document.on(cA.COMPLETE_EVT,Y._file_upload_completed);document.on(cA.ERROR_EVT,Y._file_upload_errored);return document.on(cr.UPDATE_EVT,Y._update_location)},_cancel_button_clicked:function(T){ba.SharedFolderActivityLogger.log("web","quick_send_cancel_button_clicked",cr.active_user,{});return Y._reset()},_init_autocompleter:function(){var T;if(Y.has_autocompleter_inited){return}Y.has_autocompleter_inited=true;T={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:Y.owner_id,max_textbox_height:30,viewer:cK.get_viewer(),include_from_linked_accounts:true};return Y.autocompleter=new Autocompleter.ContactsTokenizer(cK.get_viewer().get_user_by_id(Y.owner_id),Y.collab_input_id,Y.tokenizer_ctx_str+"-new-whobulk",Y.tokenizer_ctx_str+"-hidden-input",T)},_send_link:function(fr){var fo,fn,fp,fm,fl,fs,ft,T,fq;ba.SharedFolderActivityLogger.log("web","quick_send_send_button_clicked",cr.active_user,{});Y.autocompleter.tokenize_emails_input(true);T=Y.autocompleter.getTokenCount();fm=bE(".quick-send-left-form")[0];fl=[];ft=0;for(fp in Y._files){ft+=1;fn=Y._files[fp];fl.push(fn.fq_path)}fs={num_recipients:T,num_files:ft};ba.SharedFolderActivityLogger.log("web","quick_send_send_attempted",cr.active_user,fs);fq=(function(fu){return function(fv){Y._reset();Y._toggle_top_area_view();return ba.SharedFolderActivityLogger.log("web","quick_send_send_succeeded",cr.active_user,{})}})(this);fo=(function(fu){return function(fv){return ba.SharedFolderActivityLogger.log("web","quick_send_send_failed",cr.active_user,{})}})(this);return bT.ajax_submit(fm,"/sm/quick_send",fq,fo,null,{fq_paths:fl.join(",")})},_update_file_area_view:function(){if(Object.keys(Y._files).length){bE("#quick-send-drop-area").hide();bE("#quick-send-files-area").show()}else{bE("#quick-send-drop-area").show();bE("#quick-send-files-area").hide()}return Y._toggle_send_button_state()},_toggle_top_area_view:function(){bE("#quick-send-top-part-send").hide();bE("#quick-send-top-part-confirm").show();return setTimeout(function(){bE("#quick-send-top-part-send").show();return bE("#quick-send-top-part-confirm").hide()},3000)},_update_location:function(){var T;T=Y.keep_visible||!!cr.inside_root_folder;return Y._toggle_quick_send_module(T)},_toggle_quick_send_module:function(fm){var T,fl;if(Y._visible===fm){return}fl=Y.$content;if(fm){Y._visible=true;fl.show();return Y._update_collapsed_state()}else{Y._visible=false;fl.hide();fl.removeClass("collapsed expanded");T=bE("#browse-files");return T.removeClass("quicksend-collapsed quicksend-expanded")}},_update_collapsed_view:function(fo){var fl,fn,T,fm;fn=Y.$content;fm=fo?"collapsed":"expanded";if(fn.hasClass(fm)){return}T=fo?"expanded":"collapsed";fn.removeClass(T);fn.addClass(fm);fl=bE("#browse-files");fm=fo?"quicksend-collapsed":"quicksend-expanded";T=fo?"quicksend-expanded":"quicksend-collpased";fl.removeClass(T);fl.addClass(fm);if(!fo){return Y._init_autocompleter()}},_update_collapsed_state:function(){var T;T=Object.keys(Y._files).length;return Y._update_collapsed_view(T===0)},_remove_file:function(fl,T){var fm;fm=false;if(fl in Y._uploading_fileids){fm=true;document.fire(cA.CANCEL_EVT,{file:T});bE(document).trigger(cA.CANCEL_EVT,{file:T});delete Y._uploading_fileids[fl]}if(fl in Y._files){$(fl).remove();delete Y._files[fl];Y._update_upload_list_scroll();Y._update_file_area_view();return Y._update_collapsed_state()}},_reset:function(){var fl,fn,fm,T;Y.autocompleter.clearTokens();fm=bE(".quick-send-left-form")[0];fm.reset();T=[];for(fn in Y._files){fl=Y._files[fn];T.push(Y._remove_file(fn,fl.file_obj))}return T},_has_added_fq_path:function(fm){var T,fl;for(fl in Y._files){T=Y._files[fl];if(T.fq_path===fm){return true}}return false},_update_upload_list_scroll:function(){var fl,T;fl=Object.keys(Y._files).length;T=bE("#quick-send-upload-files-list");if(fl<3){return T.removeClass("scroll")}else{T.addClass("scroll");return T.scrollTop=T.scrollHeight}},_add_file:function(fn,T){var fu,fm,ft,fr,fs,fo,fl,fv,fq,fp;fs={size:fn.bytes,source:T};ba.SharedFolderActivityLogger.log("web","quick_send_file_added",cr.active_user,fs);fu=fn.dest||Y.DEST_FOLDER;fv=aD.format_bytes(fn.bytes||0);fp=fg.tmpl("upload_list_item_tmpl");fm=fp({file:fn,icon:ay.file_icon(fn.name),filename_snippet:bU.em_snippet(fn.name,d2.FILENAME_SNIPPET_LENGTH),size:fv,dest:fu,dest_snippet:bU.em_snippet(eA("Dropbox")+fu,d2.DEST_SNIPPET_LENGTH,0),Sprite:cv});fl=cY.sanitize(fm.toHTML());bE("#quick-send-upload-files-list").append(fl);ft=bE("#"+fn.id);Y._update_upload_list_scroll();ft.find(".dest-col").hide();ft.find(".time-col").hide();fq=ft.find(".status-col").find("a.small-x-button");fr=fn.id;fq.on("click",function(fw){return Y._remove_file(fr,fn)});fo=ft.find(".remove-link");fo.on("click",function(fw){return Y._remove_file(fr,fn)});ft.on("mouseenter",(function(fw){return function(fx){ft.find(".status-col").hide();return fo.show()}})(this));ft.on("mouseleave",(function(fw){return function(fx){ft.find(".status-col").show();return fo.hide()}})(this));Y._files[fn.id]={file_div:fm,fq_path:fn.fq_path,bytes:fn.size,file_obj:fn};Y._update_file_area_view();return Y._update_collapsed_state()},_toggle_send_button_state:function(){var fm,T,fl;T=((fl=Y.autocompleter)!=null?fl.token_manager.tokens.length:void 0)===0;T=T&&Y.$collab_input.val()==="";fm=Object.keys(Y._files).length===0||Object.keys(Y._uploading_fileids).length>0;return Y.$send_button.prop("disabled",T||fm)},_file_upload_errored:function(fm){var fl,T;fl=fm.memo.file;if(fl.id in Y._uploading_fileids){T={message:fm.memo.message};ba.SharedFolderActivityLogger.log("web","quick_send_file_errored",cr.active_user,T);return delete Y._uploading_fileids[fl.id]}},_file_upload_completed:function(fl){var T;T=fl.memo.file;if(T.id in Y._uploading_fileids){ba.SharedFolderActivityLogger.log("web","quick_send_file_uploaded",cr.active_user,{});delete Y._uploading_fileids[T.id];return Y._toggle_send_button_state()}},get_folder_name:function(fn){var fl,fm,T;if(Y.DEST_FOLDER){fn();return}T=function(fp){var fo;fo=JSON.parse(fp);Y.DEST_FOLDER=fo.folder_name;return fn()};fl=function(){return ae.error(eA("We couldn\u2019t upload your file. Please try again."))};fm={};fm[Constants.UID_PARAM_NAME]=Y.owner_id;return new cC.WebRequest({url:"/share/quick_send_folder_name",data:fm,success:T,error:fl})},is_quicksend_dest:function(T){var fl;fl=ay.normalize(T);return fl===Y.DEST_FOLDER},add_external_file:function(T){var fm,fl;fl=T.dest+T.name;if(Y._has_added_fq_path(fl)){ae.success(eA("You\u2019ve already added this file."));document.fire(cA.CANCEL_EVT,{file:T});bE(document).trigger(cA.CANCEL_EVT,{file:T});return}T.fq_path=fl;T.bytes=T.size;Y._uploading_fileids[T.id]=true;Y._add_file(T,"external");fm=bE("#"+T.id);return fm.find(".upload-progress-bar").css({width:"0"})},add_dropbox_file:function(T){var fl;if(T.dir){ae.error(eA("Please select files instead of folders."));return}if(Y._has_added_fq_path(T.fq_path)){ae.success(eA("You\u2019ve already added this file."));return}T.name=T.filename;Y._add_file(T,"dropbox");fl=bE("#"+T.id);fl.find(".upload-progress-bar").css({width:"100%"});fl.addClass("complete");return setTimeout(function(){var fm;fm=fl.find(".status-col");fm.empty();return fm.append(cv.make("web","s_check"))},0)}};var dX,cs,au={}.hasOwnProperty,cN=function(fn,fl){for(var T in fl){if(au.call(fl,T)){fn[T]=fl[T]}}function fm(){this.constructor=fn}fm.prototype=fl.prototype;fn.prototype=new fm();fn.__super__=fl.prototype;return fn},du=function(T,fl){return function(){return T.apply(fl,arguments)}};dX=D.SharedLinkSettingsModal=(function(fl){cN(T,fl);function T(fm,fo,fn){var fp;this.owner_id=fm;this.tkey=fo;this.dismiss_callback=fn;fp={tkey:this.tkey};fp[Constants.UID_PARAM_NAME]=this.owner_id;T.__super__.constructor.call(this,{element_id:"shared-link-settings-modal",endpoint_url:"/sm/shared_link_settings",parameters:fp});if(this.dismiss_callback){this.on_hide=this.dismiss_callback}}return T})(cB);cs=D.SharedLinkSettingsModalContent=(function(){function T(fm,fn,fl,fp){var fq,fo;this.owner_id=fm;this.tkey=fn;this.filename=fl;this.saved_password_placeholder_value=fp;this._save_settings=du(this._save_settings,this);this._toggle_password_input=du(this._toggle_password_input,this);this._enable_password_input_for_editing=du(this._enable_password_input_for_editing,this);this._date_change_callback=du(this._date_change_callback,this);this._show_calendar=du(this._show_calendar,this);this._hide_calendar=du(this._hide_calendar,this);this._future_date=du(this._future_date,this);this._enable_save_button=du(this._enable_save_button,this);this._custom_expiry_click_handler=du(this._custom_expiry_click_handler,this);this._hide_custom_expiry_label=du(this._hide_custom_expiry_label,this);this._show_custom_expiry_label=du(this._show_custom_expiry_label,this);this._toggle_expiration=du(this._toggle_expiration,this);this._expiry_picker_callback=du(this._expiry_picker_callback,this);this._listen=du(this._listen,this);this._detect_and_handle_blur_when_password_empty=du(this._detect_and_handle_blur_when_password_empty,this);this._is_clicked=du(this._is_clicked,this);this._change_password_click=du(this._change_password_click,this);this._init_expiration_section=du(this._init_expiration_section,this);this.MS_PER_DAY=1000*60*60*24;this.$content=bE(".sharing-settings-modal-content");this.modal=d7.get_containing_modal(this.$content);if(!this.modal){return}fo=eA("'%(filename)s' permissions").format({filename:bU.em_snippet(this.filename,18)});this.modal.set_title(fo);this.$form=this.$content.find(".shared-link-settings-modal-form");this.$save_button=this.$form.find(".confirm-button");this.$password_field_container=this.$form.find(".password-field-container");this.$password=this.$form.find(".link-password-container");this.$password_input=this.$password.find("input[name='password']");this.$password_label=this.$password.find("label");this.$change_password=this.$form.find(".change-link-password-container");this.$selected_expiry=this.$form.find(".selected-expiration");this.$unselected_expiry=this.$form.find(".unselected-expiration");this.$custom_expiry=this.$form.find(".custom-expiration");this.$selected_date_box=this.$form.find(".selected-date");this.$selected_date=this.$form.find(".selected-date-text");this.$calendar=this.$form.find("#expiration-calendar-container");this.$expiry_posix=this.$form.find("#expiration-posix");this.$static_expiry=this.$form.find(".static-expiration");this.loaded_with_saved_password=this.$password_input.data("is-saved-password")==="yes";if(this.loaded_with_saved_password){this._show_password_input(fq=true)}this._init_expiration_section();this._listen()}T.prototype._init_expiration_section=function(){var fl;this.$form.find(".expiration-selection").show();if(this.$expiry_posix.val()){bE("#expiration-yes").prop("checked",true);fl=this._posix_time_to_date(parseInt(this.$expiry_posix.val()));this._set_selected_date_text(fl);return this._show_custom_expiry_label()}else{this.$selected_expiry.hide();this._hide_custom_expiry_label();return this.$unselected_expiry.show()}};T.prototype._change_password_click=function(fl){fl.preventDefault();return this._enable_password_input_for_editing()};T.prototype._is_clicked=function(fl,fm){return fl.is(fm.target)||fl.has(fm.target).length};T.prototype._detect_and_handle_blur_when_password_empty=function(fl){if(!this.$password.is(":visible")||this.$password_input.val()||this._is_clicked(this.$password_field_container,fl)){return}return this._show_password_input(true)};T.prototype._listen=function(){if(this.loaded_with_saved_password){bE(window).on("click",this._detect_and_handle_blur_when_password_empty);this.$change_password.find(".change-link-password").on("click",this._change_password_click)}this.$form.on("change",this._enable_save_button);this.$form.on("submit",this._save_settings);this.$save_button.on("click",this._save_settings);this.$content.find(".cancel-button").on("click",(function(fl){return function(fm){return d0.pop()}})(this));this.$content.find(".audience-selection input[type=radio]").on("change",this._toggle_password_input);this.$content.find(".expiration-selection input[type=radio]").on("change",this._toggle_expiration);return bE(window).on(bA.CHANGED,this._expiry_picker_callback)};T.prototype._expiry_picker_callback=function(fo,fn){var fl,fm;if(fn.clicked_val===fn.old_val){return}fl=fn.clicked_val;if(fl!=="custom"){fm=this._future_date(parseInt(fl));return this._set_expiration(fm)}else{this.$selected_expiry.hide();this._show_custom_expiry_label();this._set_selected_date_text(this._future_date(30));return this._show_calendar()}};T.prototype._toggle_expiration=function(fn){var fm,fl;if(bE(fn.currentTarget).attr("id")==="expiration-yes"){this.$selected_expiry.show();this._hide_custom_expiry_label();this.$unselected_expiry.hide();B.controller(bE(".expiration-picker")).set_value(30);fl=30;fm=this._future_date(fl);this._set_expiration(fm);return this._set_selected_date_text(fm)}else{this.$expiry_posix.val("");this.$unselected_expiry.show();this.$selected_expiry.hide();this.$static_expiry.hide();this._hide_custom_expiry_label();return this._hide_calendar()}};T.prototype._show_custom_expiry_label=function(){this.$custom_expiry.show();this.$selected_expiry.hide();this.$unselected_expiry.hide();return bE(window).on("click",this._custom_expiry_click_handler)};T.prototype._hide_custom_expiry_label=function(){this.$custom_expiry.hide();return bE(window).off("click",this._custom_expiry_click_handler)};T.prototype._custom_expiry_click_handler=function(fl){if(this._is_clicked(this.$calendar,fl)){return}if(this.$selected_date_box.is(fl.target)||this.$selected_date_box.has(fl.target).length){if(this.$calendar.is(":visible")){return this.$calendar.hide()}else{return this._show_calendar()}}else{if(this.$calendar.is(":visible")){return this.$calendar.hide()}}};T.prototype._enable_save_button=function(fl){return this.$save_button.removeAttr("disabled")};T.prototype._future_date=function(fl){var fm;fm=d5.start_of_day(new Date());fm.setDate(fm.getDate()+fl);return fm};T.prototype._hide_calendar=function(){return this.$calendar.hide()};T.prototype._show_calendar=function(){var fn,fm,fl;bE(".selected-date").off("click");if(!this.calendar){if(this.$expiry_posix.val()){fl=this._posix_time_to_date(parseInt(this.$expiry_posix.val()))}else{fl=this._future_date(30)}fm={disable_past:true,first_day:this._future_date(1),last_day:this._future_date(365),selected_date:fl,onDateChange:bE.proxy(this._date_change_callback,this)};this.calendar=new H("expiration-calendar-container",fm)}else{this.$calendar.show()}fn=this.$selected_date_box.offset().left;return this.$calendar.show().offset({left:fn})};T.prototype._posix_time_to_date=function(fl){return new Date(fl*1000)};T.prototype._set_selected_date_text=function(fl){return this.$selected_date.text(N.localize(fl))};T.prototype._set_expiration=function(fm){var fl,fn;cJ(fm.getMilliseconds()===0);cJ(fm.getSeconds()===0);cJ(fm.getMinutes()===0);cJ(fm.getHours()===0);fn=(fm.getTime()+this.MS_PER_DAY)/1000;fl=fn-1;return this.$expiry_posix.val(fl)};T.prototype._date_change_callback=function(fl){this._set_selected_date_text(fl);this._set_expiration(fl);this._enable_save_button();return this._hide_calendar()};T.prototype._show_password_input=function(fq){var fp,fn,fm,fo,fl;if(fq==null){fq=false}fp=this.$content.find("label[for=audience-password]").position().left;fo=this.$content.find("#audience-password").position().left;fn=fp-fo+10;this.$password.show().css({left:fn});this.$password_input.val("");if(fq){this.$password_input.addClass("disabled").attr("readonly","true");this.$password_input.data("is-saved-password","yes");fl="\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf";this.$password_label.text(fl).show();fm=this.$password.position();return this.$change_password.css({left:fm.left,top:fm.top}).show()}else{return this._enable_password_input_for_editing()}};T.prototype._enable_password_input_for_editing=function(){this.$change_password.hide();this.$password_input.removeAttr("readonly").removeClass("disabled");this.$password_input.data("is-saved-password","no");this.$password_label.text(eA("Set password")).show();this.$password_input.focus();return this._enable_save_button()};T.prototype._toggle_password_input=function(fl){var fm;if(bE(fl.currentTarget).attr("id")==="audience-password"){return this._show_password_input(fm=this.loaded_with_saved_password)}else{this.$password.hide();this.$change_password.hide();return this.$password_input.data("is-saved-password","no")}};T.prototype._save_settings=function(fo){var fm,fl,fn,fp;if(this.$password_input.data("is-saved-password")==="yes"){fn={type:"hidden",name:"password",value:this.saved_password_placeholder_value};fm=bE("<input />",fn);this.$form.append(fm);this.$password_input.attr("name","inoperative_password")}fp=(function(fq){return function(fr){d0.pop();return ae.success(eA("Settings saved."))}})(this);fl=(function(fq){return function(fr){if(fq.$password.length&&fq.$password.is(":visible")){fq.$password_input.focus()}return bT.remove_loading()}})(this);return bT.ajax_submit(this.$form[0],"/sm/change_shared_link_settings",fp,fl,this.$save_button[0])};return T})();var eF;eF=D.SimpleSharing=(function(){function T(){}T.createAndShowInbandModalFromBrowseFile=function(fl,fm){return T.createAndShowInbandModal(fl,fm.fq_path,fm.dir,fm.target_ns,fm.is_shared_folder(),fm.could_be_shared_folder(),parseInt(fm.sf_perm_role))};T.createAndShowM2InbandModal=function(fm,fn){var fo,fl;fl=function(fp,fr,fq){return d0.push(new dX(fp,fr,fq))};fo=function(fq){var fp;fp=new df(cr.active_user,fq);return fp.show()};return aG.showInstance(aG({needsFetchingTokenInfo:true,user:fm,fqPath:fn,isDir:true,canReaderSync:false,isSharedFolder:true,couldBeSharedFolder:false,canEdit:true,editableLinksM2Enabled:true,showSharedLinkSettingsModal:fl,onGoBackButtonClicked:fo}))};T.createAndShowInbandModal=function(fo,ft,fs,fu,fr,fw,fx){var fn,fv,fm,fq,fp,fl;fn=function(fz,fA,fy){return window.INLINE_JS.DBModalStack.push(new df(fz,fA,false,false,fy))};fl=function(fz,fA,fy){return window.INLINE_JS.DBModalStack.push(new b3(fz,{element_id:"unshare-confirm-modal",team_shared_folder:false,ns_id:fy,folder_path:fA}))};fm=function(fz,fA,fy,fC,fB){return window.INLINE_JS.DBModalStack.push(new eS(fz,{element_id:"kick-confirm-modal",ns_id:fy,user_name:fB,folder_path:fA,user_id:fC}))};fv=function(fz,fB,fy,fA,fC){return window.INLINE_JS.DBModalStack.push(new aS(fz,{element_id:"kick-group-confirm-modal",ns_id:fy,group_name:fC,folder_path:fB,group_id:fA}))};fp=function(fz,fA,fy,fC,fB){return window.INLINE_JS.DBModalStack.push(new aH(fz,{element_id:"uninvite-confirm-modal",email_or_fbname:fB,ns_id:fy,invite_id:fC,folder_path:fA}))};fq=function(fz,fA,fy){return d0.push(new dt(fz,{element_id:"leave-confirm-modal",ns_id:fy,folder_path:fA}))};return dO.createAndShowModal(fo,ft,fn,fl,fm,fv,fp,fq,Boolean(fs),fu,fr,fw,parseInt(fx),cr.simple_sharing_react_member_list_enabled)};return T})();var ez,ew;ew=D.FoshmodalPanes=Object.clone(dn);ew.to_title_str=function(){var T,fl,fp,fn,fo,fm;if(ez.sharing_collection){fn=bU.em_snippet(ez.collection_to_share.name,18,1);return eA("Share '%(snippeted_name)s'").format({snippeted_name:fn})}else{T=ez._selection;fm=c8.categorize_files(T),fl=fm[0],fp=fm[1];if(fl&&fp){fo=bc("Share %(file_count)s item","Share %(file_count)s items",T.length)}else{if(fl){fo=bc("Share %(file_count)s photo","Share %(file_count)s photos",T.length)}else{fo=bc("Share %(file_count)s video","Share %(file_count)s videos",T.length)}}fo=fo.format({file_count:T.length});return fo}};ez=INLINE_JS.Foshmodal=D.Foshmodal={current_shmodel_url:null,current_short_url:null,callback_for_when_we_have_shmodel_url:null,current_foshmodal_pane:ew.SEND,send_link_autocompleter:null,sharing_collection:false,num_photos_to_share:null,working:false,collection_to_share:null,have_real_tkey:false,current_tkey:null,current_album_name:null,previous_album_name:null,_selection:null,lock:function(){if(this.working){return false}this.working=true;return this.working},unlock:function(){return this.working=false},clear_message_inputs:function(){$("shmodal-send-content").down(".custom-message-container").down(".textinput").setValue("");$("shmodal-fb-post-input").setValue("");return $("shmodal-twitter-post-input").setValue("")},refresh:function(){this.current_shmodel_url=null;this.current_short_url;this.callback_for_when_we_have_shmodel_url=null;this.current_foshmodal_pane=ew.SEND;this.sharing_collection=false;this.have_real_tkey=false;this.current_tkey=null;this.current_album_name=null;this.previous_album_name=null;eW.clear();this.clear_message_inputs();this.send_link_autocompleter.clearTokens();this.unlock();bE(".link-image").attr("src","static/images/empty_album_big.png");bT.remove_loading(bE("#modal").find(".tokenizer-submit-button")[0]);bT.remove_loading(bE("#modal").find(".foshmodal-copy-link")[0]);bT.remove_loading(bE("#shmodal-twitter-post-submit")[0]);return bT.remove_loading(bE("#shmodal-fb-post-submit")[0])},create_album_from_selected_photos:function(T){var fl;cJ(this._selection.length,"This should never be called with an empty selection");cJ(this.current_tkey!=null,"Missing tkey");cJ(this.current_shmodel_url!=null,"Missing shmodel url");cJ(this.current_short_url!=null,"Missing short url");cJ(T!=null,"Missing collection info");T.is_anonymous=this.creating_anonymous_collection();T.share_tkey=this.current_tkey;T.shmodel_url=this.current_shmodel_url;T.short_url=this.current_short_url;return fl=new ab(T)},set_shmodel_url:function(fl,T){if(this.have_real_tkey){this.current_shmodel_url=this.collection_to_share.shmodel_url;this.current_short_url=this.collection_to_share.short_url;this.current_tkey=this.collection_to_share.share_tkey;return typeof fl==="function"?fl():void 0}else{return new Ajax.DBRequest("/collection_create_dummy_token",{onSuccess:(function(fm){return function(fo){var fn;fn=JSON.parse(fo.responseText);fm.current_shmodel_url=fn.token_link;fm.current_short_url=fn.short_link;fm.current_tkey=fn.tkey;if(typeof fl==="function"){fl()}return typeof fm.callback_for_when_we_have_shmodel_url==="function"?fm.callback_for_when_we_have_shmodel_url():void 0}})(this),onFailure:function(){return typeof T==="function"?T():void 0}})}},attach_collection_to_token:function(fl,T){cJ(this.collection_to_share!=null,"Should get called only when there is an existing collection");cJ(this.current_shmodel_url!=null,"Should have a shmodel url before you call attach_collection_to_token");if(this.have_real_tkey){if(typeof fl==="function"){fl(this.collection_to_share.gid)}return}cJ(this.current_tkey!=null,"should have tkey");return this.collection_to_share.attach_to_token(this.current_tkey,this.current_shmodel_url,this.current_short_url,fl,T)},create_collection_and_attach_to_token:function(fp,T){var fm,fo,fn,fl;cJ(this.sharing_collection===false,"Should not get called when we already have a collection");cJ(this.current_shmodel_url!=null,"Should have a shmodel url before you call create_collection_and_attach_to_token");fo=(function(fq){return function(fr){var fs;fs=JSON.parse(fr.responseText);fq.create_album_from_selected_photos(fs);return typeof fp==="function"?fp(fs.gid):void 0}})(this);fm=function(fq){return typeof T==="function"?T(fq):void 0};fn={tkey:this.current_tkey,collection_name:this.creating_anonymous_collection()?"":this.current_album_name,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var ft,fr,fs,fq;fs=this._selection;fq=[];for(ft=0,fr=fs.length;ft<fr;ft++){fl=fs[ft];fq.push(fl.item_counter)}return fq}).call(this)),source_collection_gid:bQ.get_current_collection_gid()};return new Ajax.DBRequest("/collection_create_and_attach_to_dummy_token",{onSuccess:fo,onFailure:fm,parameters:fn})},alert_if_album_name_invalid:function(){if(this.creating_anonymous_collection()){return false}if(this.current_album_name.strip().length===0){ae.error(eA("Please enter a name for this album"));this.unlock();return true}if(cG.collection_name_in_use(this.current_album_name)){ae.error(eA("You already have an album named '%(current_album_name)s'").format({current_album_name:this.current_album_name}));this.unlock();return true}return false},send_button_onclick:function(fm){var fl,T;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}fl=$("shmodal-send-form");cJ(fl,"Couldn't find the shmodal send form.");if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.send_button_onclick.bind(this);return}T=(function(fn){return function(fo){fn.unlock();if(!fo.responseText.startsWith("err:")){ae.error(eA("We couldn't send this album. Please try again."));fc.hide();return fn.refresh()}}})(this);if(this.sharing_collection){this.send_collection(fl,T)}else{this.send_selection(fl,T)}return i.log_interaction(en.SEND,db.FOSHMODAL,{num_photos:this.num_photos_to_share})},get_send_success_text:function(){var fn,fl,fm,T,fo;fn=this.get_current_display_name();T=aj.get_shmodel_send_recipients($("shmodal-send-form"));fl=T[0].split(" ")[0];if(T.length===1){fo=eA("Shared %(album_name)s with %(first_name_of_recipient)s").format({album_name:fn,first_name_of_recipient:fl})}else{if(T.length===2){fm=T[1].split(" ")[0];fo=eA("Shared %(album_name)s with %(first_name_of_recipient)s and %(first_name_of_second_recipient)s").format({album_name:fn,first_name_of_recipient:fl,first_name_of_second_recipient:fm})}else{fo=eA("Shared %(album_name)s with %(first_name_of_recipient)s and %(num_other_recipients)s others").format({album_name:fn,first_name_of_recipient:fl,num_other_recipients:T.length-1})}}return fo},send_selection:function(fm,fl){var fo,fn,T;fo=(function(fp){return function(fq){var fr;fr=JSON.parse(fq.responseText);fp.create_album_from_selected_photos(fr);ae.success(fp.get_send_success_text());fp.refresh();return fc.hide()}})(this);fn={shmodel_url:this.current_shmodel_url,tkey:this.current_tkey,num_items:this.num_photos_to_share,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var fs,fq,fr,fp;fr=this._selection;fp=[];for(fs=0,fq=fr.length;fs<fq;fs++){T=fr[fs];fp.push(T.item_counter)}return fp}).call(this)),source_collection_gid:bQ.get_current_collection_gid()};if(this.creating_anonymous_collection()){fn.collection_name=""}else{if(this.current_album_name.trim().length===0){fn.collection_name=cG.get_default_album_name()}}return bT.ajax_submit(fm,"/collection_create_and_send_link",fo,fl,fm.down(".tokenizer-submit-button"),fn)},send_collection:function(fl,T){var fm;cJ(this.current_tkey!=null,"tkey should be set");cJ(this.current_shmodel_url!=null,"shmodel url should be set");fm=(function(fn){return function(){ae.success(fn.get_send_success_text());fc.hide();return fn.refresh()}})(this);return this.collection_to_share.send_link(fl,this.current_tkey,this.current_shmodel_url,this.current_short_url,fm,T)},get_link_button_onclick:function(){var T,fm,fl;if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.get_link_button_onclick.bind(this);return}fl=$("modal").down(".tokenizer-submit-button");fm=(function(fn){return function(fp){var fo;fo=fn.get_current_display_name();if(FlashDetect.installed){ae.success(eA("The link to %(album_name)s was copied to your clipboard",{comment:"name of a photo/video album"}).format({album_name:fo}))}fn.show_get_link_modal(fn.current_shmodel_url,fo,fp);ba.ViralLogger.log(cK.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_copy_link",file_type:"collection"});if(fn.collection_to_share!=null){cy.log_share("share_link",fp,fn.num_photos_to_share,fn.creating_anonymous_collection(),!fn.sharing_collection)}return fn.refresh()}})(this);T=(function(fn){return function(fo){fn.unlock();bT.remove_loading(fl);if(!fo.responseText.startsWith("err")){ae.error(eA("We couldn't create a link to this album. Please try again."));fc.hide();return fn.refresh()}}})(this);if(this.sharing_collection){bT.add_loading(fl);this.attach_collection_to_token(fm,T)}else{if(this.alert_if_album_name_invalid()){return}bT.add_loading(fl);this.create_collection_and_attach_to_token(fm,T)}return i.log_interaction(en.GET_LINK,db.FOSHMODAL,{num_photos:this.num_photos_to_share})},initialize_get_link_button:function(){var T,fl;if(FlashDetect.installed){T=s.clipboard_overlay(this.current_shmodel_url,bE("#foshmodal-copy-link"),ez.get_link_button_onclick.bind(this));T.css({position:"fixed",zIndex:1001});clearInterval(this.follow_freshbutton);fl=(function(fm){return function(){return T.clonePosition(bE("#foshmodal-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);return this.follow_freshbutton=setInterval(fl,500)}else{$("foshmodal-copy-link").stopObserving();return $("foshmodal-copy-link").observe("click",this.get_link_button_onclick.bind(this))}},facebook_button_onclick:function(fp,fl){var fo,fm,T,fn;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.facebook_button_onclick.bind(this).curry(fp,fl);return}fo=bE("#modal:visible, #modal-overlay:visible");T=function(){return fo.show()};fm=(function(fq){return function(){fq.lock();setTimeout(fq.unlock.bind(fq),750);return es.do_auth((function(){return fq.do_fb_post(fl)}),fl)}})(this);if(es.authed_user_id===fl){this.do_fb_post(fl)}else{if(cK.get_viewer().is_uid_associated(es.authed_user_id)){this.unlock();fo.hide();fn=new ed(cK.get_viewer().get_user_by_id(fl),T,fm.bind(this));fn.show()}else{fm()}}return i.log_interaction(en.FB_SHARE,db.FOSHMODAL,{num_photos:this.num_photos_to_share})},twitter_button_onclick:function(fl,T){if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.twitter_button_onclick.bind(this).curry(fl,T);return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(cD.is_authed(T)){this.do_twitter_post(T)}else{setTimeout(this.unlock.bind(this),750);cD.do_auth(((function(fm){return function(){return fm.do_twitter_post(T)}})(this)),T)}return i.log_interaction(en.TWITTER_SHARE,db.FOSHMODAL,{num_photos:this.num_photos_to_share})},do_fb_post:function(T){var fl,fm;fl=(function(fn){return function(){ae.error(eA("We couldn't share this album on Facebook. Please try again."));fc.hide();return fn.refresh()}})(this);fm=(function(fn){return function(fp){var fo;es.custom_show_posting=function(){return bT.add_loading($("shmodal-fb-post-submit"))};es.progress_container=$("modal").down(".modal-buttons");fo=fn.get_current_display_name();es.custom_show_complete=function(){fc.hide();ae.success(eA("Shared %(album_name)s on Facebook!",{comment:"name of a photo/video album"}).format({album_name:fo}));return fn.refresh()};es.post($F("shmodal-fb-post-input"),fn.current_shmodel_url,null,null,null,fl,T);ba.ViralLogger.log(cK.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_fb_post",file_type:"collection"});return cy.log_share("share_facebook",fp,fn.num_photos_to_share,fn.creating_anonymous_collection(),!fn.sharing_collection)}})(this);if(this.sharing_collection){return this.attach_collection_to_token(fm,fl)}else{return this.create_collection_and_attach_to_token(fm,fl)}},do_twitter_post:function(T){var fn,fl,fm;fn=$F("shmodal-twitter-post-input");if(!fn){ae.error(eA("Please enter a tweet"));this.unlock();return}if(fn.length>140){ae.error(eA("Your tweet must be 140 characters or less"));this.unlock();return}fm=(function(fo){return function(fp){cD.custom_show_posting=function(){$("twitter-chars").hide();return bT.add_loading($("shmodal-twitter-post-submit"))};cD.custom_post(fn,function(){fc.hide();ae.success(eA("Your tweet has been posted!"));return fo.refresh()},T);ba.ViralLogger.log(cK.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_twitter",file_type:"collection"});return cy.log_share("share_twitter",fp,fo.num_photos_to_share,fo.creating_anonymous_collection(),!fo.sharing_collection)}})(this);fl=(function(fo){return function(){ae.error(eA("We couldn't share this album on Twitter. Please try again."));fc.hide();return fo.refresh()}})(this);if(this.sharing_collection){return this.attach_collection_to_token(fm,fl)}else{return this.create_collection_and_attach_to_token(fm,fl)}},show_get_link_modal:function(fl,T,fm){var fn;fc.show(eA("Link to %(album_name)s").format({album_name:T.escapeHTML()}),$("get-link-modal"));fn=$("get-link-modal").down(".link-input");fn.setValue(fl);fn.select();$("get-link-modal").down(".view-button").onclick=function(){window.open(fl,"_blank");return fc.hide()};return $("get-link-modal").down(".done-button").onclick=function(){if(fm!=null){cG.flash_sidebar_album(fm)}return fc.hide()}},update_current_album_name_text:function(T){this.current_album_name=$(ew.to_content_str(this.current_foshmodal_pane)).down(".album-name-input").value;if(this.current_foshmodal_pane===ew.FB){return this.set_fb_post_title(this.current_album_name)}},set_fb_post_title:function(fo){var fl,fn,fm,T;T=this.sharing_collection?bQ.get_timeline().get_photos():this._selection;if(fo){if(this.num_photos_to_share===1){fl=fo}else{fl=eA("%(album_name_text)s (%(album_desc)s)",{comment:'e.g. album_desc is "5 photos and 1 video" and album_name_text is "my_album"'}).format({album_name_text:fo,album_desc:c8.file_desc(T)})}}else{if(T.length===1){fm=T[0];if(fm.preview_type==="photo"){fn=eA("Photo from %(date_taken)s")}else{fn=eA("Video from %(date_taken)s")}fl=fn.format({date_taken:b4.nice_date_with_month_name(new Date(fm.time_taken),true,true,true)})}else{fl=c8.file_desc(T)}}return $(ew.to_content_str(ew.FB)).down(".link-name").__date(fl)},set_current_album_name_text:function(fl,T){$(ew.to_content_str(fl)).down(".album-name-input").value=T;if(fl===ew.FB){return this.set_fb_post_title(T)}},show_content:function(fo){var fl,fn,T,fm;if(this.working){return}$("shmodal-title-text").__date(ew.to_title_str());fm=ew.list;for(fn=0,T=fm.length;fn<T;fn++){fl=fm[fn];if(fl!==fo){$(ew.to_toggle_str(fl)).removeClassName("toggled");$(ew.to_content_str(fl)).hide()}}$(ew.to_content_str(fo)).show();$(ew.to_toggle_str(fo)).addClassName("toggled");if(!this.sharing_collection){this.set_current_album_name_text(fo,this.current_album_name)}switch(fo){case ew.FB:$("shmodal-fb-post-input").focus();break;case ew.TWITTER:$("shmodal-twitter-post-input").focus();break;case ew.SEND:$("foshmodal-new-collab-input").focus()}return this.current_foshmodal_pane=fo},_get_foshmodal_title:function(){return aj.generate_title_content(ew.to_title_str(),((function(T){return function(){return T.show_content(ew.SEND)}})(this)),((function(T){return function(){return T.show_content(ew.FB)}})(this)),((function(T){return function(){return T.show_content(ew.TWITTER)}})(this)))},creating_anonymous_collection:function(){return !$("shmodal").hasClassName("saving-as-album")},get_current_display_name:function(){if(this.sharing_collection){return"'"+this.collection_to_share.name+"'"}else{if(this.creating_anonymous_collection()){return c8.file_desc(this._selection,true)}else{return"'"+this.current_album_name+"'"}}},set_twitter_message:function(){var T,fm,fl,fo,fn;T=this.sharing_collection?bQ.get_timeline().get_photos():this._selection;if(T.length===1){fn=c8.categorize_files(T),fl=fn[0],fo=fn[1];if(fl){fm=eA("Just shared a photo using @Dropbox")}else{if(fo){fm=eA("Just shared a video using @Dropbox")}else{cJ(false,"We shouldn't have non-photo, non-video files in timeline")}}}else{fm=eA("Just shared an album using @Dropbox")}return $("shmodal-twitter-post-input").setValue(""+fm+" "+this.current_short_url)},update_shmodal_image_text:function(){var fr,fu,ft,fp,fo,fs,T,fq,fn,fm,fl;if(this.sharing_collection){fu=this.collection_to_share.num_items;ft=c8.album_desc(this.collection_to_share,false,true)}else{fu=this._selection.length;ft=c8.file_desc(this._selection,false,true)}if(fu>1){fq=$$(".shmodal-image");fm=[];for(fp=0,fs=fq.length;fp<fs;fp++){fr=fq[fp];fr.down("span").__date(ft);fm.push(fr.down(".share-file-count").show())}return fm}else{fn=$$(".shmodal-image");fl=[];for(fo=0,T=fn.length;fo<T;fo++){fr=fn[fo];fl.push(fr.down(".share-file-count").hide())}return fl}},show:function(fs,fz){var ft,fw,fx,fu,fy,fq,fp,fn,fv,fl,T,fr,fo,fm;this.unlock();fc.onHide=(function(fA){return function(){var fC,fB;if((fC=$("flash_copy_container"))!=null){fC.remove()}if((fB=fA.send_link_autocompleter)!=null){fB.hide()}bE("#modal").find(".new-collab-input").val("");clearInterval(fA.follow_freshbutton);bQ.disable_selection();delete fc.onHide;return fc.hide()}})(this);this.sharing_collection=fz;fy=this.sharing_collection?fs.thumbnail_url_256:fs[0].thumbnail_url;fr=$$(".link_image");for(fq=0,fv=fr.length;fq<fv;fq++){fw=fr[fq];if(fy!=null){fw.src=fy}else{fw.src="static/images/empty_album_big.png"}}this.current_foshmodal_pane=ew.SEND;this.have_real_tkey=this.sharing_collection&&(fs.share_tkey!=null);if(this.sharing_collection){this.collection_to_share=fs;this.num_photos_to_share=this.collection_to_share.num_items;$("shmodal").addClassName("sharing-collection");this.set_fb_post_title(this.collection_to_share.name)}else{this._selection=fs.sort(function(fB,fA){return fB.time_taken-fA.time_taken});this.num_photos_to_share=this._selection.length;this.current_album_name="";this.set_current_album_name_text(this.current_foshmodal_pane,this.current_album_name);$("shmodal").removeClassName("sharing-collection");$("shmodal").removeClassName("saving-as-album");fo=$$(".save-as-album-checkbox");for(fp=0,fl=fo.length;fp<fl;fp++){ft=fo[fp];ft.checked=false;fu=(function(fA){return function(fJ){var fK,fG,fE,fC,fB,fF,fD,fI,fH;if(fJ.target.checked){$("shmodal").addClassName("saving-as-album");fA.current_album_name=fA.previous_album_name||cG.get_default_album_name();fA.set_current_album_name_text(fA.current_foshmodal_pane,fA.current_album_name);fK=$(ew.to_content_str(fA.current_foshmodal_pane)).down(".album-name-input");fK.focus();fK.select();fF=$$(".save-as-album-checkbox");fI=[];for(fG=0,fC=fF.length;fG<fC;fG++){ft=fF[fG];fI.push(ft.checked=true)}return fI}else{$("shmodal").removeClassName("saving-as-album");fA.previous_album_name=fA.current_album_name;fA.current_album_name="";fA.set_current_album_name_text(fA.current_foshmodal_pane,fA.current_album_name);fD=$$(".save-as-album-checkbox");fH=[];for(fE=0,fB=fD.length;fE<fB;fE++){ft=fD[fE];fH.push(ft.checked=false)}return fH}}})(this);ft.observe("change",fu);if(b1.msie_version_at_most(8)){ft.observe("click",fu)}}fm=$$(".album-name-input");for(fn=0,T=fm.length;fn<T;fn++){fx=fm[fn];fx.observe("keyup",this.update_current_album_name_text.bind(this))}}bQ.enable_selection();fc.show(this._get_foshmodal_title(),$("shmodal"));this.clear_message_inputs();this.show_content(this.current_foshmodal_pane);this.set_shmodel_url(((function(fA){return function(){fA.initialize_get_link_button();return fA.set_twitter_message()}})(this)),(function(){ae.error(eA("This request could not be completed.  Please try again."));return fc.hide()}));this.update_shmodal_image_text();if(!this.send_link_autocompleter){this.send_link_autocompleter=new Autocompleter.ContactsTokenizer(cK.get_viewer().get_user_by_role(Constants.ROLE_PHOTOS),"foshmodal-new-collab-input","foshmodal-new-whobulk","foshmodal-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true})}this.send_link_autocompleter.clearTokens();U.register(false,$("modal"));if(this.num_photos_to_share<=1){$("shmodal-send-content").down(".collection-thumb-stack").hide();$("shmodal-twitter-content").down(".collection-thumb-stack").hide()}else{$("shmodal-send-content").down(".collection-thumb-stack").show();$("shmodal-twitter-content").down(".collection-thumb-stack").show()}return d5._track_twitter_chars_left("shmodal-twitter-post-input",140)}};var eE,an,cZ,dS,cA,d2,bp,bK=[].indexOf||function(fm){for(var fl=0,T=this.length;fl<T;fl++){if(fl in this&&this[fl]===fm){return fl}}return -1};cA=INLINE_JS.Upload=D.Upload={QUEUE_EVT:"db:upload:queue",QUEUE_ERROR_EVT:"db:upload:queue_error",UPDATE_EVT:"db:upload:update",COMPLETE_EVT:"db:upload:complete",ERROR_EVT:"db:upload:error",CANCEL_EVT:"db:upload:cancel",CHOOSE_FILE_BASIC:"db:upload:choose_file_basic",APPLE_PACKAGE_EXTENSIONS:["pages","key","app","numbers","band","photolibrary","rcproject","rtfd","graffle","logic","logicx","lpdf","sketch","screenflow","scriv","dvdproj","mindnode","cmproj","xcodeproj","imovielibrary","mpkg","imovieproject","1password","agilekeychain","fcpbundle","abbu","mindnode","theater","gameproj","aplibrary","itlp","lrdata","ydevice","bundle","framework","plugin","kext","pkg"],APPLE_PACKAGE_ERROR:-54321,current_dest:"",runtimes:(function(){var fm,fl,fn,T;fn={"MSIE 8.0":"flash","MSIE 9.0":"flash"};fl="html5";for(fm in fn){T=fn[fm];if(navigator.userAgent.indexOf(fm)!==-1){fl=T}}return fl})(),choose_button_id:"choose-button",set_dest:function(T){ds.fillVal(T,"dest-folder");return this.current_dest=T},init:function(fm,fn,fo,fl){var T;this.set_dest(fm);T=this.initPLU(fo,fl);if(!fn){ak.window_load(T)}else{T()}bE("#flash-upload-container > .moxie-shim").each(function(fp){if(fp.observe){d5.freshbutton_overlay(fp,$("choose-button"));return d5.freshbutton_overlay(fp,$("add-button"))}});return an.clear()},init_basic:function(){d5.freshbutton_overlay($("file-box"),$("basic-choose-button"));$("file-box").observe("click",function(T){return document.fire(cA.CHOOSE_FILE_BASIC)});$("basic-choose-button").observe("mousemove",function(fm){var fl,T,fn;fl=$("modal").cumulativeOffset();fn=fm.clientY-fl.top-3;T=fm.clientX-fl.left-$("file-box").getWidth()+3;return $("file-box").setStyle({top:fn+"px",left:T+"px"})});return $("file-box").observe("change",function(){var fo,fm,fp,fn,T,fl;fc.hide=function(){};$("modal-x").hide();$("basic-upload-desc").hide();$("basic-upload-buttons").hide();$("file-box").hide();fm=$("file-box").getValue().split("\\").pop();fn=cv.make("web",ay.file_icon(fm));$("basic-upload-status").down(".icon").__date(fn);fo=eA("Uploading %(filename)s").format({filename:bU.em_snippet(fm,25)});$("basic-upload-status").down(".file-desc").__date(fo);$("basic-upload-status").show();$("basic-uploading-message").show();fp=$("file-box").files;fl=0;if(fp){T=fp[0].lastModifiedDate;if(T){fl=Math.round(Date.parse(T)/1000)||0}}if(!fl){fl=Math.round(Date.parse(new Date)/1000)}$("mtime-utc").value=fl;return $("basic-upload-form").submit()})},initPLU:function(fl,T){return(function(fm){return function(){var fo,fn;fo={url:"https://"+Constants.BLOCK_CLUSTER+"/chunked_upload",file_data_name:"file",runtimes:fm.runtimes,multipart_params:{},multipart:false,max_file_size:"10000mb",chunk_size:"8mb",max_retries:2,browse_button:fm.choose_button_id,container:"flash-upload-container",preinit:{PostInit:function(){if(fl){fl()}return fm.uploaderLoaded()},Error:fm.uploadError.bind(fm)},init:{FilesAdded:fm.fileQueued.bind(fm),UploadProgress:fm.uploadProgress.bind(fm),FileUploaded:fm.uploadSuccess.bind(fm),BeforeUpload:fm.prepareFileForUploading.bind(fm),ChunkUploaded:fm.chunkUploaded.bind(fm),UploadComplete:an.finished.bind(an),Refresh:function(){if(fm.PLU.runtime==="flash"&&$("upload-running-buttons").visible()){bE("#flash-upload-container").clonePosition(bE("#add-button"));bE("#flash-upload-container > .moxie-shim")[0].style.width="100%";return bE("#flash-upload-container > .moxie-shim")[0].style.height="100%"}}},flash_swf_url:aK.UrlConstants.MOXIE_SWF_URL};if(T!=null){bE.extend(fo,T)}fn=new o.Uploader(fo);fm.PLU=fn;return fm.PLU.init()}})(this)},reset:function(){if(an.uploading&&an.current_file){this.PLU.removeFile(an.current_file)}return cZ.hide()},show_upload:function(){$("upload-desc").hide();$("dnd-upload-desc").hide();$("upload-files-list").show();$("upload-start-buttons").hide();$("upload-running-buttons").show();$("hide-button").show();$("done-button").hide();if(!$("modal-overlay").visible()){return cZ.show()}},updatePostParams:function(fm){var fl,T;T=this.PLU.settings.multipart_params;for(fl in fm){if(fm.hasOwnProperty(fl)){T[fl]=fm[fl]}}return this.PLU.settings.multipart_params=T},fileQueued:function(fl,fp){var fo,fn,T,fm;for(fn=0,T=fp.length;fn<T;fn++){fo=fp[fn];if((typeof fo.getNative==="function"?(fm=fo.getNative())!=null?fm.dest:void 0:void 0)===void 0){fo.dest=cA.current_dest}else{fo.dest=fo.getNative().dest}}document.fire(this.QUEUE_EVT,{files:fp});bE(document).trigger(this.QUEUE_EVT,{files:fp});if(Y.is_quicksend_dest(fo.dest)){return}return this.show_upload()},uploadNext:function(){var fo,fm,T,fl,fp,fn;fl=an.next();T=(bx.contains(cA.APPLE_PACKAGE_EXTENSIONS,ay.file_extension_for_logging(fl.name))&&fl.size%34===0)||(ay.file_extension_for_logging(fl.name)===""&&fl.size%34===0&&fl.size<=3400);if(T){fl.status=o.FAILED;fm={file:fl,code:cA.APPLE_PACKAGE_ERROR,message:eA("Can\u2019t Upload"),tooltip_text:eA('To upload a package file via the web, try zipping it first, or <a href="https://www.dropbox.com/help/6691" target="_blank">learn more</a>.'),response:"",responseHeaders:"",status:400};this.uploadError(this.PLU,fm);return false}fp={dest:an.next().dest,t:bw.read(Constants.JS_CSRF_COOKIE)};fp[Constants.UID_PARAM_NAME]=cr.active_user;if((fn=ay.file_extension(fl.name,fo=true))==="url"||fn==="webloc"||fn==="website"){fp.overwrite=0}cA.updatePostParams(fp);this.PLU.start();an.last_update_time=0;an.last_update_size=0;return true},pause:function(){return cA.PLU.stop()},uploadProgress:function(fl,T){if(!an.cancelled_files[T.id]){document.fire(this.UPDATE_EVT,{file:T,percent_complete:T.loaded/T.size});return bE(document).trigger(this.UPDATE_EVT,{file:T,percent_complete:T.loaded/T.size})}},generateUploadId:function(){var T,fl,fn,fm;T="";for(fl=fm=0;fm<=15;fl=++fm){T+=String.fromCharCode(Math.floor(Math.random()*256))}fn=ai.encode(T);fn=fn.replace(/\+/g,"-");fn=fn.replace(/\//g,"_");fn=fn.replace(/\=*$/,"");return fn},chunkUploaded:function(fl,fm,fn){var T;T=JSON.parse(fn.response||"");return this.updatePostParams({offset:T.offset})},prepareFileForUploading:function(){var T;T=an.next();return this.updatePostParams({reported_total_size:T.size,dest:T.dest,t:bw.read(Constants.JS_CSRF_COOKIE),upload_id:this.generateUploadId(),offset:0})},uploadSuccess:function(fo,fn,fm){var fl,T;try{T=JSON.parse(fm.response)}catch(fp){fl=fp;T=null}if(fm.response==="{'error': 'quota'}"){document.fire(this.ERROR_EVT,{file:fn,message:eA("Quota exceeded"),tooltip_text:eA("Your upload failed because you are over quota.")});return bE(document).trigger(this.ERROR_EVT,{file:fn,message:eA("Quota exceeded"),tooltip_text:eA("Your upload failed because you are over quota.")})}else{if(fm.response==="{'error': 'empty'}"){document.fire(this.CANCEL_EVT,{file:fn,message:eA("Empty File")});return bE(document).trigger(this.CANCEL_EVT,{file:fn,message:eA("Empty File")})}else{if(fm.response==="{'error': 'ignored'}"){document.fire(this.CANCEL_EVT,{file:fn,message:eA("File Ignored")});return bE(document).trigger(this.CANCEL_EVT,{file:fn,message:eA("File Ignored")})}else{if((T!=null?T.status:void 0)==="complete"){document.fire(this.COMPLETE_EVT,{file:fn});return bE(document).trigger(this.COMPLETE_EVT,{file:fn})}else{document.fire(this.ERROR_EVT,{file:fn});return bE(document).trigger(this.ERROR_EVT,{file:fn})}}}}},uploadComplete:function(fl,T){document.fire(this.COMPLETE_EVT,{file:T});return bE(document).trigger(this.COMPLETE_EVT,{file:T})},uploadError:function(fo,T){var fn,fl,fm;if((fm=T.file.id,bK.call(an.file_ids(),fm)<0)&&T.code!==cA.APPLE_PACKAGE_ERROR){document.fire(this.QUEUE_EVT,{files:[T.file]});bE(document).trigger(this.QUEUE_EVT,{files:[T.file]})}fl=(function(){switch(T.code){case o.FILE_SIZE_ERROR:return eA("File too large");default:return eA("Upload Error")}})();this.show_upload();fn={file:T.file,error_code:T.code,message:fl};if(T!=null?T.tooltip_text:void 0){fn.tooltip_text=T.tooltip_text}document.fire(this.ERROR_EVT,fn);return bE(document).trigger(this.ERROR_EVT,fn)},grabURL:function(){var T;T=$F("file-box");if(/(^http|^https|^ftp):\/\//.match(T)){$("url").value=T}return true},treeview_handler:function(fl,T){var fm;ds.fillVal(fl,"dest-folder");fm=$("basic-uploader-url");if(fm){fm.href=fm.href.replace(/(\/upload)(.*)(\?basic=1)/,function(fp,fo,fq,fn){return fo+d5.urlquote(fl)+fn})}return an.clear()},new_folder:function(){b2.hide();fc.show(eA("Create new folder..."),ds.fromElm("create-folder"),{action:this.do_new_folder.bind(this,cr.active_user),wit_group:"new-folder-confirm"});if(!d5.ie){return bE("#first-treeview-link").trigger("click")}},do_new_folder:function(T){var fm,fl;if(!fc.vars.selected_path){ae.error(eA("Please select a parent folder."));return}fl=$F("entered-name");fm=fc.vars.selected_path;return new Ajax.DBRequest("/cmd/new"+d5.urlquote(fm)+"?to_path="+d5.urlquote(fl),{subject_user:T,onSuccess:(function(fn){return function(fo){fn.treeview_handler(ay.normalize(fm)+"/"+fl);return b2.schedule_reset()}})(this),cleanUp:function(){}})},uploaderLoaded:function(){$("upload-loading").hide();$("choose-button").show();if(cA.PLU.runtime==="flash"){bE("#flash-upload-container").clonePosition(bE("#choose-button"));bE("#flash-upload-container > .moxie-shim")[0].style.top="0px";bE("#flash-upload-container > .moxie-shim")[0].style.left="0px";bE("#flash-upload-container > .moxie-shim")[0].style.width="100%";return bE("#flash-upload-container > .moxie-shim")[0].style.height="100%"}else{bE("#"+this.choose_button_id).click((function(T){return function(fl){return bE("#"+T.PLU.id+"_html5").click()}})(this));return bE("#add-button").click((function(T){return function(fl){return bE("#choose-button").click()}})(this))}}};an=D.FileQueue={init:function(){return an._listen()},_listen:function(){document.observe(cA.QUEUE_EVT,an._file_queued.bind(this));document.observe(cA.QUEUE_ERROR_EVT,an._file_queue_errored.bind(this));document.observe(cA.UPDATE_EVT,an._file_updated.bind(this));document.observe(cA.COMPLETE_EVT,an._file_completed.bind(this));document.observe(cA.ERROR_EVT,an._file_errored.bind(this));return document.observe(cA.CANCEL_EVT,an._file_cancelled.bind(this))},_file_queued:function(fp){var fm,fo,fl,fn,T;fn=fp.memo.files;T=[];for(fo=0,fl=fn.length;fo<fl;fo++){fm=fn[fo];this.files[fm.id]=fm;if(!an.uploading){this._start_uploading()}this.current_file=fm;T.push(eJ("File queued:",fm.name))}return T},_file_queue_errored:function(T){this._file_queued(T);return setTimeout(((function(fl){return function(){return fl._file_errored(T)}})(this)),250)},_file_updated:function(fs){var fn,T,fl,fm,fq,fp,fo,fr,ft;fm=fs.memo.file;fp=fs.memo.percent_complete;fq=fp*fm.size;ft=fq+this.completed_size();fl=new Date().getTime();if(this.last_update_time){fo=(fl-this.last_update_time)/1000;if(cA.PLU.total.bytesPerSec){this.average_bps=cA.PLU.total.bytesPerSec}else{T=fq-this.last_update_size;fn=T/fo;this.average_bps=((ft-T)*this.average_bps+T*fn)/ft}fr=(this.queue_size()-ft)/this.average_bps;this.formatted_time=b4.format_time(fr+this.num_left())}this.current_file=fm;this.last_update_time=new Date().getTime();return this.last_update_size=fq},_file_completed:function(fl){var T;T=fl.memo.file;this.completed_files[T.id]=true;eJ("File completed:",T.name);return this._check_if_finished(T)},_file_errored:function(fl){var T;T=fl.memo.file;this.errored_files[T.id]=true;eE.update_errors();cZ.update_errors();eJ("File errored:",T.name);return this._check_if_finished(T)},_file_cancelled:function(fl){var T;T=fl.memo.file;this.cancelled_files[T.id]=true;if(T.status===o.UPLOADING){cA.PLU.stop();cA.PLU.removeFile(T);cA.PLU.start()}else{cA.PLU.removeFile(T)}eJ("File cancelled:",T.name);return this._check_if_finished(T)},_start_uploading:function(){var T;this.uploading=cA.uploadNext();if(this.uploading){this.all_cancelled=false;return window.onbeforeunload=T=(function(fl){return function(){return eA("Leaving this page will cancel your uploads.")}})(this)}},finished:function(){return this._finished_uploading()},_check_if_finished:function(T){if(this.empty()){if(this.uploading){return this._finished_uploading()}}else{return cA.uploadNext()}},_finished_uploading:function(){var fl,fm,fn,T;this.uploading=false;if(!this.num_files()){eE.cancelled()}else{if(this.errors()){eE.errored();cZ.errored()}else{eE.completed();cZ.completed()}}T=$("inline-upload-status").visible();cr.select_fq_paths=[];if(cr.inside_dir){for(fn in this.completed_files){fm=this.files[fn];fl=ay.normalize(fm.dest);cr.select_fq_paths.push(""+fl+"/"+fm.name)}cr.force_reload()}else{if(cr.in_search_mode()){b9.force_reload()}}if(T){cZ.show()}fc.onHide=null;return window.onbeforeunload=null},empty:function(){return !this.num_left()},num_files:function(){return this.file_ids().length},num_non_cancelled_files:function(){return this.file_ids().length-this.cancels()},next:function(){return bx(this.files).filter((function(T){return function(fl){return !(T.cancelled_files[fl.id]||T.errored_files[fl.id]||T.completed_files[fl.id])}})(this))[0]},cancels:function(){return bx(this.cancelled_files).keys().length},errors:function(){return bx(this.errored_files).keys().length},queue_size:function(){var fl,fp,fm,fo,T,fn;fm=0;fn=this.file_ids();for(fo=0,T=fn.length;fo<T;fo++){fp=fn[fo];fl=this.files[fp];if(!this.errored_files[fp]&&!this.cancelled_files[fp]&&typeof fl.size!=="undefined"){fm+=fl.size}}return fm},completed_size:function(){var fo,fl,fn,T,fm;fl=0;fm=bx(this.completed_files).keys();for(fn=0,T=fm.length;fn<T;fn++){fo=fm[fn];if(typeof this.files[fo].size!=="undefined"){fl+=this.files[fo].size}}return fl},file_ids:function(){return bx(this.files).map((function(T){return function(fl,fm){return fm}})(this))},totalPercentage:function(){return this.completed_size()/this.queue_size()},num_left:function(){return bx(this.file_ids()).filter((function(T){return function(fl){return !(T.cancelled_files[fl]||T.errored_files[fl]||T.completed_files[fl])}})(this)).length},clear:function(){this.files={};this.cancelled_files={};this.all_cancelled=false;this.errored_files={};this.completed_files={};this.last_update_time=0;this.last_update_size=0;this.average_bps=0;this.formatted_time="";this.uploading=false;window.onbeforeunload=null;if(typeof fc!=="undefined"&&fc!==null){return fc.onHide=null}}};an.clear();d2=D.UploadFile={FILENAME_SNIPPET_LENGTH:15,DEST_SNIPPET_LENGTH:13,_tmpl:null,init:function(){d2._tmpl=fg.tmpl("upload_list_item_tmpl");return d2._listen()},_listen:function(){document.observe(cA.QUEUE_EVT,d2._file_queued);document.observe(cA.QUEUE_ERROR_EVT,d2._file_queue_errored);document.observe(cA.UPDATE_EVT,d2._file_updated);document.observe(cA.COMPLETE_EVT,d2._file_completed);document.observe(cA.ERROR_EVT,d2._file_errored);return document.observe(cA.CANCEL_EVT,d2._file_cancelled)},_file_queued:function(fp){var fm,fo,fl,fn,T;fn=fp.memo.files;T=[];for(fo=0,fl=fn.length;fo<fl;fo++){fm=fn[fo];T.push((function(fr){var fx,fq,fu,fw,fv,fy,fs,ft;fx=fr.dest;if(Y.is_quicksend_dest(fx)){Y.add_external_file(fr);return}fy=aD.format_bytes(fr.size||0);fq=d2._tmpl({file:fr,icon:ay.file_icon(fr.name),filename_snippet:bU.em_snippet(fr.name,d2.FILENAME_SNIPPET_LENGTH),size:fy,dest:fx,dest_snippet:bU.em_snippet(eA("Dropbox")+fx,d2.DEST_SNIPPET_LENGTH,0),Sprite:cv});$("upload-files-list").__sert(fq);fw=$(fr.id);fv=an.num_files();if(dv.show_share_button_in_file_uploader){fu=bE("#"+fr.id);fu.find(".dest-col").hide()}fs=$("upload-files-list");if(fv<=6){fs.removeClassName("scroll")}else{fs.addClassName("scroll")}fs.scrollTop=fs.scrollHeight;fw.down(".dest").observe("click",function(){cr.reload_fqpath(fw.readAttribute("data-dest"),true);return fc.hide()});ft=fw.down(".status-col").down("a.small-x-button");ft.stopObserving("click");ft.observe("click",function(fz){document.fire(cA.CANCEL_EVT,{file:fr});return bE(document).trigger(cA.CANCEL_EVT,{file:fr})});return fw.down(".upload-progress-bar").setStyle({width:"0"})})(fm))}return T},_file_queue_errored:function(T){d2._file_queued(T);return d2._file_errored(T)},_file_updated:function(fn){var fm,fo,fl,T;fm=fn.memo.file;fo=$(fm.id);if(an.num_files()===1){T=eA("%(time_left)s left").format({time_left:an.formatted_time});fo.down(".time-col").__date(T)}fl=parseInt(fm.percent,10)+"%";if(fl==="100%"){fo.down(".time-col").__date();fo.down(".status-col").__date(new Element("img",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"}))}return fo.down(".upload-progress-bar").setStyle({width:fl})},_file_completed:function(fl){var T,fm,fn;T=fl.memo.file;T.completed=true;fn=$(T.id);fn.addClassName("complete");if(dv.show_share_button_in_file_uploader&&!Y.is_quicksend_dest(T.dest)){fm=bE("#"+T.id);fm.find(".share-link").show();ba.SharedFolderActivityLogger.log("web","share_button_in_uploader_impression",cr.active_user,{});fm.on("click",function(fq){var fp,fo;fc.hide();ba.SharedFolderActivityLogger.log("web","share_button_in_uploader_click",cr.active_user,{});fp=T.dest+"/"+T.name;fo="file_uploader";return dv.shmodel(fp,fo)})}setTimeout(function(){return fn.down(".status-col").__date(cv.make("web","s_check"))},0);return fn.down(".upload-progress-bar").setStyle({width:"100%"})},_file_errored:function(fl){var T,fm;T=fl.memo.file;fm=$(T.id);if(fm){return d2._actual_file_errored(fl)}else{return setTimeout((function(fn){return function(){return d2._actual_file_errored(fl)}})(this),0)}},_actual_file_errored:function(fo){var T,fm,fl,fp,fn;fl=fo.memo.file;fp=$(fl.id);fp.addClassName("error");fp.down(".dest-col").hide();fp.down(".time-col").__date();fp.down(".status-col").__date(cv.make("web","nosync"));fp.down(".upload-progress-bar").setStyle({width:"100%"});if(Y.is_quicksend_dest(fl.dest)){return}fm=fo.memo.message||eA("Upload Error");T=void 0;if(fo.memo.tooltip_text){T=fo.memo.tooltip_text}else{T=eA('Something went wrong with the advanced uploader. If the problem persists, please use the <a id="basic_link">basic uploader</a> to upload via the website.');bE(document).on("click","a#basic_link",function(){dC.show_basic_upload();return false})}fp.down(".error-msg").__date(fm);fn=fp.down(".error-details");fn.observe("mouseover",function(){return ej.show(fn,T)});return fp.down(".error-col").show()},_file_cancelled:function(fl){var T,fm;T=fl.memo.file;fm=$(T.id);fm.addClassName("cancelled");fm.down(".dest-col").__date(eA(fl.memo.message||"Canceled"));fm.down(".time-col").__date();fm.down(".status-col").__date(cv.make("web","cancelsync"));return fm.down(".upload-progress-bar").setStyle({width:"100%"})}};eE=D.BulkUpload={init:function(){this.elem=$("bulk-upload-status");return eE._listen()},_listen:function(){document.observe(cA.QUEUE_EVT,eE._file_queued.bind(this));return document.observe(cA.UPDATE_EVT,eE._file_updated.bind(this))},_file_queued:function(fl){var T;T=new Element("a",{"class":"small-x-button"});T.observe("click",function(){var fo,fq,fp,fn,fm;an.all_cancelled=true;fo=an.file_ids().slice(0);fm=[];for(fp=0,fn=fo.length;fp<fn;fp++){fq=fo[fp];if(!an.completed_files[fq]&&!an.errored_files[fq]){document.fire(cA.CANCEL_EVT,{file:an.files[fq]});fm.push(bE(document).trigger(cA.CANCEL_EVT,{file:an.files[fq]}))}else{fm.push(void 0)}}return fm});return this.elem.down(".status").__date(T)},_file_updated:function(fn){var fm,fl,T;if(an.num_files()>1){this.elem.removeClassName("error");this.elem.removeClassName("complete");this.elem.removeClassName("cancelled");fm=bc("%d file","%d files",an.num_non_cancelled_files()).format(an.num_non_cancelled_files());this.elem.down(".num-files").__date(fm);fl=eA("- %(size)s").format({size:aD.format_bytes(cA.PLU.total.size)});this.elem.down(".size").__date(fl);if(an.formatted_time){T=eA("%(time_left)s left").format({time_left:an.formatted_time});this.elem.down(".time-left").__date(T)}this.elem.down(".upload-progress-bar").style.width=Math.min(100,(an.totalPercentage()*100||0).toFixed(2))+"%";this.elem.show();if(cA.PLU.runtime==="flash"){return bE("#flash-upload-container").clonePosition(bE("#add-button"))}}},update_errors:function(){var T;T=bc("- %d error","- %d errors",an.errors()).format(an.errors());return $("bulk-upload-status").down(".num-errors").__date(T)},completed:function(){var fl,T;$("hide-button").hide();$("done-button").show();if(an.num_files()>1){this.elem.addClassName("complete");fl=bc("Uploaded %d file","Uploaded %d files",an.num_non_cancelled_files()).format(an.num_non_cancelled_files());this.elem.down(".num-files").__date(fl);T=eA("- %(size)s").format({size:aD.format_bytes(an.completed_size())});this.elem.down(".size").__date(T);this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(cv.make("web","s_check"));return this.elem.down(".upload-progress-bar").style.width="100%"}},errored:function(){var T;$("hide-button").hide();$("done-button").show();this.completed();T=bc("- %d error","- %d errors",an.errors()).format(an.errors());return this.elem.down(".num-errors").__date(T)},cancelled:function(){$("hide-button").hide();$("done-button").show();if(an.num_files()>1){this.elem.addClassName("cancelled");this.elem.down(".num-files").__date(eA("All uploads canceled"));this.elem.down(".size").__date();this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(cv.make("web","cancelsync"));return this.elem.down(".upload-progress-bar").style.width="100%"}}};cZ=D.InlineUploadStatus={FILENAME_SNIPPET_LENGTH:30,init:function(){return this._listen()},_listen:function(){document.observe(cA.QUEUE_EVT,cZ._file_queued.bind(this));return document.observe(cA.UPDATE_EVT,cZ._file_updated.bind(this))},_file_queued:function(fm){var fl,T;fl=$("inline-upload-status");fl.removeClassName("error");fl.removeClassName("complete");fl.down(".icon").__date(cv.make("web","s_sync"));fl.down(".file-desc").__date(eA("Starting upload..."));fl.down(".num-errors").__date();T=bc("%d file","%d files",an.num_left()).format(an.num_left());fl.down(".view-details").__date(T);fl.down(".status").__date();return fl.down(".inline-upload-progress").style.width="0%"},_file_updated:function(fq){var fp,fm,fn,fo,fl,T;fp=$("inline-upload-status");fm=fq.memo.file;fp.down(".icon").__date(cv.make("web","s_sync"));fn=eA("Uploading %(filename)s").format({filename:bU.em_snippet(fm.name,this.FILENAME_SNIPPET_LENGTH)});fp.down(".file-desc").__date(fn);if(an.num_left()>1){T=bc("%d file left","%d files left",an.num_left()-1).format(an.num_left()-1);fp.down(".view-details").__date(T)}else{fp.down(".view-details").__date(eA("View details"))}if(an.formatted_time){fl=eA("%(time_left)s left").format({time_left:an.formatted_time});fp.down(".status").__date(fl)}fo=fm.percent+"%";return fp.down(".inline-upload-progress").style.width=fo},update_errors:function(){var T,fl;T=$("inline-upload-status");fl=bc("- %d error","- %d errors",an.errors()).format(an.errors());return T.down(".num-errors").__date(fl)},add_x_button:function(){var T,fl;fl=new Element("a",{"class":"small-x-button"});fl.observe("click",function(){cZ.hide();return cA.reset()});T=$("inline-upload-status");return T.down(".status").__date(fl)},completed:function(){var fl,T;fl=$("inline-upload-status");fl.addClassName("complete");fl.removeClassName("error");fl.down(".icon").__date(cv.make("web","s_check"));if(an.num_files()>1){T=eA("Uploaded %(num_files)d files").format({num_files:an.num_non_cancelled_files()})}else{T=eA("Uploaded %(filename)s").format({filename:bU.em_snippet(an.current_file.name,this.FILENAME_SNIPPET_LENGTH)})}fl.down(".file-desc").__date(T);fl.down(".num-errors").__date();fl.down(".view-details").__date(eA("View details"));this.add_x_button();return fl.down(".inline-upload-progress").style.width="100%"},errored:function(){var fm,fl,T,fn;fm=$("inline-upload-status");fm.addClassName("error");fm.removeClassName("complete");fm.down(".icon").__date(cv.make("web","nosync"));fl=void 0;if(an.num_files()>1){fl=eA("Uploaded %(num_completed)d of %(num_files)d files").format({num_completed:an.num_non_cancelled_files()-an.errors(),num_files:an.num_non_cancelled_files()});fm.down(".file-desc").__date(fl);fn=bc("- %d error","- %d errors",an.errors()).format(an.errors());fm.down(".num-errors").__date(fn)}else{if(an.current_file!=null){T=bU.em_snippet(an.current_file.name,this.FILENAME_SNIPPET_LENGTH)}fl=T?eA("Unable to upload %(filename)s").format({filename:T}):eA("Unable to upload file");fm.down(".file-desc").__date(fl);fm.down(".num-errors").__date()}fm.down(".view-details").__date(eA("View details"));this.add_x_button();return fm.down(".inline-upload-progress").style.width="100%"},show:function(T){return $("inline-upload-status").show()},hide:function(){return $("inline-upload-status").hide()}};bp=D.UploadPrep={_drop_indicators:false,_drop_dest_folder:null,file_counter:0,current_req:null,_notifications_cleared:false,supported:function(){return Prototype.BrowserFeatures.DB_CORS},enabled:function(){return bp.supported()&&cr.inside_dir&&!(cr.in_search_mode()&&b9.fulltext_search_enabled)},browse_indicators_enabled:function(){var fn,fl,fm,T;if(!bp.enabled()){return false}fl=["modal-overlay"];if(cA.choose_button_id.startsWith("wizard-")){fl.push("wizard-overlay")}for(fm=0,T=fl.length;fm<T;fm++){fn=fl[fm];if($(fn).visible()){return false}}return true},modal_indicators_enabled:function(){var T;return bp.enabled()&&bE("#modal #upload-modal-dropzone").length&&bE("#modal").visible()&&((T=bE("#modal").offset())!=null?T.left:void 0)>0},_show_border_drop_indicators:function(){return $$(".external-drop-indicator").each(function(T){return bE(T).css("opacity",0).fadeTo(500,0.6)})},_hide_border_drop_indicators:function(){return $$(".external-drop-indicator").invoke("hide")},show_drop_indicators:function(fl){var T;if(!bp._drop_indicators){if(bp.modal_indicators_enabled()){T=$("upload-modal-dropzone");bE(T).clonePosition(bE("#modal"),{setLeft:false,setTop:false});bE(T).fadeIn(500);bp._show_border_drop_indicators()}else{if(bp.browse_indicators_enabled()){bR._add_drop_indicators(fl)}else{return}}$("drag-status").removeClassName("active");return bp._drop_indicators=true}},hide_drop_indicators:function(){if(bp._drop_indicators){bp._hide_border_drop_indicators();bR._remove_drop_indicators();if(!bp._notifications_cleared){ae.clear()}$("upload-modal-dropzone").hide();$("drag-status").addClassName("active");setTimeout((function(){bp._drop_indicators=false;bp._drop_dest_folder=null;return bp._notifications_cleared=false}),500)}return bp._notifications_cleared=true},folder_dragover:function(T){var fl;if(bp.browse_indicators_enabled()&&bp._drop_indicators){if(dS.disabled){if(bp._drop_dest_folder==null){fl=eA("You can't upload files because you're out of space.");ae.error(fl,60);bp._notifications_cleared=false;bp._show_border_drop_indicators()}}else{if(T!==bp._drop_dest_folder){if(T===cr.containing_fq_path()){if(cr.inside_read_only_shared_folder){fl=eA("You don't have permission to add to this folder.");ae.error(fl,60)}else{fl=eA("Drop your file to %(upload_action)s",{comment:"upload_action is a phrase like 'upload to folder 'XYZ'"}).format({upload_action:dC.upload_plain_snippet()});ae.success(new fg(fl),60);bp._show_border_drop_indicators()}bp._notifications_cleared=false}else{ae.clear();bp._hide_border_drop_indicators()}}}return bp._drop_dest_folder=T}},supports_recursive_upload:function(T){var fl;return window.File&&window.FileReader&&window.FileList&&window.Blob&&(T!=null?(fl=T[0])!=null?fl.webkitGetAsEntry:void 0:void 0)},upload:function(fm,fo,fl){var fn,fq,fp,T;if(fl==null){fl=null}if(cr.inside_read_only_shared_folder){return}if(dS.disabled){fq=eA("You can't upload files because you're out of space.");return ae.error(fq)}else{if(bp.supports_recursive_upload(fl)){return bp._recursive_upload(fm,fl)}else{for(fp=0,T=fo.length;fp<T;fp++){fn=fo[fp];fn.dest=fm}return bp._upload(fo,fl)}}},_recursive_upload:function(fv,fs){var fx,fm,fn,fu,fq,fy,fl,fw,fp,fr,T,fo,ft;fl=[];fp=[];fr=function(fz,fA){fz.dest=fv+ay.parent_dir(fA.fullPath);return fl.push(fz)};for(fo=0,ft=fs.length;fo<ft;fo++){fw=fs[fo];fu=fw.webkitGetAsEntry();if(fu!==null){if(fu.isDirectory){if(Y.is_quicksend_dest(fv)){ae.error(eA("Please select files instead of folders."))}else{fp.push(fu)}}else{fr(fw.getAsFile(),fu)}}}fn=0;fy=0;T=function(fz,fB){var fA;fA=eA('The drag and drop uploader can\'t upload %(name)s because it contains Unicode characters. Use the <a id="use-advanced-uploader"> advanced uploader</a> instead.').format({name:fB.name});ae.error(new fg(fA));return bE("#use-advanced-uploader").on("click",function(fC){fC.preventDefault();return dC.show_upload()})};fx=3000;fq=0;fm=function(){var fz;while(fp.length){fu=fp.pop();if(fu!==null){if(fu.isDirectory){(function(fB){var fA;fA=fB.createReader();fn+=1;return fA.readEntries(function(fC){var fF,fE,fD;if(fC.length!==0){for(fE=0,fD=fC.length;fE<fD;fE++){fF=fC[fE];fp.push(fF)}return fA.readEntries(arguments.callee)}else{return fn-=1}},function(fC){fn-=1;return T(fC,fB)})})(fu)}else{fy+=1;fz=function(fA){return function(fB){fr(fB,fA);return fy-=1}};fu.file(fz(fu),function(fA){fy-=1;return T(fA,fu)})}}}if(fl.length>fx&&!fq){fq=1;ae.error(eA("The Dropbox website can't upload more than %(max_files)s files.").format({max_files:fx}));return}if(fn||fy){return fm.defer()}else{if(fl.length){return bp._upload(fl)}}};return fm()},_upload:function(fn,fl){var T,fm;if(fl==null){fl=null}if(fl){T=this._parse_upload_items(fl)}fm=function(){var fq,fs,fp,fr,fo;fo=[];for(fs=0,fp=fn.length;fs<fp;fs++){fq=fn[fs];if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1&&(T!=null?(fr=T[fq.name])!=null?fr.isDirectory:void 0:void 0)){fq.is_directory=true}fq.id=o.guid();fo.push(cA.PLU.addFile(fq))}return fo};if($("modal").visible()){return fm()}else{dC.show_upload(fm);return fc.hide(null,true)}},_parse_upload_items:function(fl){var fm,fn,fo,T;fm={};for(fo=0,T=fl.length;fo<T;fo++){fn=fl[fo];if(fn.getAsEntry){fn=fn.getAsEntry()}else{if(fn.webkitGetAsEntry){fn=fn.webkitGetAsEntry()}}fm[fn.name]=fn}return fm}};dS=D.OverQuotaUploads={disabled:false,init:function(T){this.disabled=T;if(this.disabled){return bE("body").addClass("uploads-disabled")}}};var dC;dC=INLINE_JS.FileOps=D.FileOps={NOTIFICATION_SNIPPET_LEN:40,SHOW_UPLOAD_EVT:"db:fileops:show_upload",_find_app_by_id:function(fl){var fo,fn,T,fm;fm=fc.vars.apps;for(fn=0,T=fm.length;fn<T;fn++){fo=fm[fn];if(fo.app_id!==fl){continue}return fo}return null},create_album_from_folder:function(fl,T){return new Ajax.DBRequest("/collection_from_folder",{parameters:{path:fl,album_name:T},job:true,job_user:cK.get_viewer().photos_user,dont_hide_progress_on_complete:true,progress_text:eA("Creating album..."),onSuccess:function(fm){var fn;fn=JSON.parse(fm.responseText);return window.location.href=fn.url}})},dir_handler:function(fn,fm){var fl,T;if(typeof fm==="string"){fm=$(fm)}fl=$$(".treeview .highlight")[0];if(fl){fl.removeClassName("highlight")}T=fm.up("div");T.addClassName("highlight");fc.selected_div=T;if(fc.shown()){fm.blur()}document.fire("db:dir_click",{path:fn});return fc.vars.selected_path=fn},show_folder_pick:function(fp,fn,fm,fo,T){var fl;ds.fillVal(ay.filename(fn).escapeHTML(),"folder-pick-file");b2.move("copy-move-treeview","folder-pick-treeview",{user:cr.active_user});fl=(T?eA("Move"):eA("Copy"));ds.fillVal(fl,"folder-pick-action-text");fc.show(fp,$("folder-pick"),{fq_path:fn,action:fm,folder:fo});return bE("#first-treeview-link").trigger("click")},show_bulk_folder_pick:function(fq,fp,fn,fo){var fl,T,fm;fm=a5.profile_files(fn);T=a5.profile_summary(fm);ds.fillVal(T,"bulk-folder-pick-file");b2.move("copy-move-treeview","bulk-folder-pick-treeview",{user:cr.active_user});if(fp==="move"){fl=eA("Move")}else{if(fp==="copy"){fl=eA("Copy")}else{fl=eA("Restore")}}ds.fillVal(fl,"bulk-folder-pick-action-text");fc.show(fq,$("bulk-folder-pick"),{files:fn,action:fo});return bE("#first-treeview-link").trigger("click")},show_copy:function(T,fl){var fm;fm=(fl?eA("Copy folder to..."):eA("Copy file to..."));b2.set_params({disable_read_only:true});return dC.show_folder_pick(fm,T,dC.do_copy,fl,false)},show_copy_bulk:function(T){var fl;fl=bc("Copy %(item_count)s item to...","Copy %(item_count)s items to...",T.length).format({item_count:T.length});b2.set_params({disable_read_only:true});return dC.show_bulk_folder_pick(fl,"copy",T,dC.do_bulk_copy)},show_compress_bulk:function(T,fl){b2.set_params({disable_read_only:true});return dM.show({title_text:bc("Compress file?","Compress files?",fl.length),body_html:bc("Do you want to compress <strong>%(filename)s</strong>?<br/>This might take a while.","Do you want to compress %(file_count)s files?<br/>This might take a while.",fl.length).format({file_count:fl.length,filename:bx.escape(fl.first().filename)}),confirm_text:eA("Compress"),cancel_text:eA("Cancel"),confirm_callback:function(){return dC.do_bulk_compress(T,fl)}})},do_bulk_compress:function(T,fm){var fl;ae.clear();fl=fm.pluck("fq_path");return cC.WebProgressRequest({url:"/cmd/compress",data:{files:fl},subject_user:T,progress_text:eA("Compressing..."),success:function(fq){var fp,fo,fn;fn=JSON.parse(fq);fp=fn.compressed_files;cJ(fp.length>0,"Must have at least 1 compressed file");fo=bx.escape(ay.filename(fp.first().fq_path));ae.success(bc("Compressed successfully to %(filename)s","Compressed %(file_count)s files successfully.",fp.length).format({file_count:fp.length,filename:fo}));return bE(document).trigger(aF.COMPRESS,{original_files:fm,compressed_files:fp})}})},show_move_bulk:function(T){var fl;fl=bc("Move %(item_count)s item to...","Move %(item_count)s items to...",T.length).format({item_count:T.length});b2.set_params({disable_read_only:true});return dC.show_bulk_folder_pick(fl,"move",T,dC.do_bulk_move)},show_move:function(T,fl){var fm;fm=(fl?eA("Move folder to..."):eA("Move file to..."));b2.set_params({disable_read_only:true});return dC.show_folder_pick(fm,T,dC.do_move,fl,true)},show_delete:function(T,fm,fn,fl){var fo;fo=eA("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:ay.filename(fm).escapeHTML()});return dM.show({title_text:fn?eA("Delete folder?"):eA("Delete file?"),body_html:'<div class="simple-modal-word-wrap-content">'+fo+"</div>",confirm_text:eA("Delete"),cancel_text:eA("Cancel"),confirm_callback:function(){if(fl){return dC.do_nonbrowse_delete(T,[fm])}else{return dC.do_delete(T,fm)}}})},show_bulk_delete:function(T,fl){return dM.show({title_text:bc("Delete %(item_count)s item?","Delete %(item_count)s items?",fl.length).format({item_count:fl.length}),body_html:bc("Are you sure you want to delete %(item_count)s item from your Dropbox?","Are you sure you want to delete %(item_count)s items from your Dropbox?",fl.length).format({item_count:fl.length}),confirm_text:eA("Delete"),cancel_text:eA("Cancel"),confirm_callback:function(){return dC.do_bulk_delete(T,fl)}})},show_purge:function(T,fl){return dM.show({title_text:fl?eA("Permanently delete folder?"):eA("Permanently delete file?"),body_html:eA("Are you sure you want to permanently delete <strong>%(items)s</strong> from your Dropbox?").format({items:ay.filename(T).escapeHTML()}),confirm_text:eA("Permanently delete"),cancel_text:eA("Cancel"),confirm_callback:function(){return dC.do_purge(cr.find_file(T))}})},show_bulk_purge:function(T){return dM.show({title_text:bc("Permanently delete %d item?","Permanently delete %d items?",T.length).format(T.length),body_html:bc("Are you sure you want to permanently delete %(item_count)s item from your Dropbox?","Are you sure you want to permanently delete %(item_count)s items from your Dropbox?",T.length).format({item_count:T.length}),confirm_text:eA("Permanently delete"),cancel_text:eA("Cancel"),confirm_callback:function(){return dC.do_bulk_purge(T)}})},show_bulk_restore:function(fl,T){return dM.show({title_text:bc("Restore %d item...","Restore %d items...",fl.length).format(fl.length),body_html:bc("Are you sure you want to restore %(item_count)s item?","Are you sure you want to restore %(item_count)s items?",fl.length).format({item_count:fl.length}),confirm_text:eA("Restore"),cancel_text:eA("Cancel"),confirm_callback:function(){return dC.do_bulk_restore(fl)}})},wrap_strong:function(T){if(cr.containing_fq_path()===""){return T.escapeHTML()}else{return"<strong>"+T.escapeHTML()+"</strong>"}},upload_snippet:function(fm){var T,fl;if(fm==null){fm=1000}if(cK.get_viewer().is_paired&&cr.active_user.is_team){fl=bU.em_snippet(cK.get_viewer().team_name,fm).escapeHTML()}if(cr.containing_fq_path()===""){if(cK.get_viewer().is_paired){if(cr.active_user.is_team){return eA(" upload to your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({team_name:fl})}else{return eA(" upload to your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"})}}else{return eA(" upload to your Dropbox")}}else{T=bU.em_snippet(ay.filename(cr.containing_fq_path()),fm).escapeHTML();if(cK.get_viewer().is_paired){if(cr.active_user.is_team){return eA(" upload to the folder <strong>%(folder)s</strong> in your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:T,team_name:fl})}else{return eA(" upload to the folder <strong>%(folder)s</strong> in your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:T})}}else{return eA(" upload to the folder <strong>%(folder)s</strong>",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:T})}}},upload_short_snippet:function(fm){var fl,T;if(fm==null){fm=1000}T=cr.containing_fq_path();if(!T){return eA("Upload to Dropbox",{comment:"Upload a file to the root Dropbox folder"})}fl=bU.em_snippet(ay.filename(T),fm);return eA("Upload to '%(folder_name)s'",{comment:"Upload a file to some folder on the website"}).format({folder_name:fl})},upload_plain_snippet:function(T){if(T==null){T=1000}return this.upload_snippet(T).replace("<strong>","'").replace("</strong>","'")},show_upload:function(fs,T,fp){var fm,fq,fl,fn,fr,fo;fm=cr.containing_fq_path();if(dS.disabled){ds.fillVal(this.wrap_strong(ay.filename(fm)),"disabled-upload-foldername");fl=this.upload_short_snippet(20);fc.show(fl,$("disabled-upload-modal"),{},false);return}bE(document).trigger(this.SHOW_UPLOAD_EVT,{source:T,has_callback:fs!=null});if((!FlashDetect.versionAtLeast(9))&&cA.runtimes==="flash"){dC.show_basic_upload();$("enhanced-upload-toggle").hide();return}ds.fillVal(this.upload_snippet(20),"upload-foldername");ds.fillVal(this.upload_plain_snippet(10),"dnd-upload-foldername");if($("upload-desc").visible()&&bp.supported()){$("upload-desc").hide();$("dnd-upload-desc").show()}fl=this.upload_short_snippet(20);fc.show(fl,ds.fromElm("advanced-upload-modal"),{wit_group:"advanced-uploader"},false,false,an.num_files());fo=[$("modal").down(".basic-link-start"),$("modal").down(".basic-link-running")];for(fn=0,fr=fo.length;fn<fr;fn++){fq=fo[fn];if(fq!=null){fq.observe("click",function(){dC.show_basic_upload();return false})}}if(!an.num_files()){cA.init(ay.normalize(fm),true,fs,fp)}else{cA.set_dest(ay.normalize(fm))}return cZ.hide()},show_basic_upload:function(){ds.fillVal(this.upload_snippet(20),"basic-upload-foldername");fc.show(this.upload_short_snippet(20),$("basic-upload-modal"),{},false);$("modal").down(".enhanced-link").observe("click",function(){dC.show_upload();return false});cA.set_dest(ay.normalize(cr.containing_fq_path()));return cA.init_basic()},show_undelete:function(T){var fl,fm,fn;ds.fillVal(T.filename.escapeHTML(),"undelete_filename");fl=cv.make("web",T.icon,{});fl.addClassName("link-img");fl.style.backgroundColor="transparent";fm=dC.build_revisions_uri(T.fq_path,cr.active_user,{undelete:1});$$(".undelete-icon").invoke("update",fl);$$(".undelete-other-versions")[0].href=fm;$$(".undelete-link")[0].href=fm;fn=eA("Restore file?");return fc.show(fn,$("undelete-modal"),{file:T})},do_undelete:function(fl){var T,fm;T=fc.vars.file;fm=eA("Restored '%(file_name)s'").format({file_name:T.filename});new Ajax.DBRequest("/cmd/restore",{parameters:{files:[T.fq_path]},subject_user:cr.active_user,job:true,html_in_error_msg:true,progress_text:eA("Restoring..."),onSuccess:function(fn){fc.hide();ae.success(fm);return document.fire(aF.RESTORE,{files:[T]})}});return false},do_copy:function(fm,fl){var T;fm=fm||fc.vars.fq_path;fl=fl||fc.vars.selected_path;T=cr.find_file(fm);cJ(T,"Trying to copy a file we couldn't find.");return dC.do_bulk_copy([T],fl)},do_bulk_copy:function(fp,fl){var fn,fo,fm,fq,T;cr.pre_action_selection=eX.get_selected_fq_paths();fp=fp||fc.vars.files;cJ(fp.length>0,"Tried to copy 0 files");if(typeof fl==="undefined"){if(typeof fc.vars.selected_path==="undefined"){ae.error(eA("You need to select a destination for the file."));return}else{fl=fc.vars.selected_path}}fl=ay.normalize(fl);fm=0;for(fq=0,T=fp.length;fq<T;fq++){fn=fp[fq];if(fn.dir){if((fl+"/").indexOf(fn.fq_path+"/")===0){ae.error(eA("You cannot copy a folder into itself."));return}}}fo=fp.pluck("fq_path");ae.clear();return new Ajax.DBRequest("/cmd/copy",{parameters:{files:fo,to_path:fl},subject_user:cr.active_user,job:true,html_in_error_msg:true,progress_text:eA("Copying..."),onSuccess:function(fy){var fu,fx,fr,fz,ft,fv,fs,fw;fu=fy.responseText.evalJSON().changesets;fx=fo.length;fz=bU.em_snippet(ay.filename(fl),dC.NOTIFICATION_SNIPPET_LEN).escapeHTML();ft=bc("Copied %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Copied %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",fx);ft=ft.format({count:fx,location:fz});W.notifyWithUndo(new fg(ft),fu,dC.do_rollback);fr=[];fw=fy.responseText.evalJSON().new_browse_files;for(fv=0,fs=fw.length;fv<fs;fv++){fn=fw[fv];fr.push(fn.fq_path)}cr.select_fq_paths=fr;$("reload-link").observe("click",function(){return a3.set_path_url(null,fl)});b2.schedule_reset();return document.fire(aF.COPY,{files:fp,to_fq_path:fl})}})},bulk_move_error:function(T,fs){var fq,fn,ft,fo,fu,fp,fl,fm,fr;ft=cr.find_file(fs);fo=a5.profile_files(T);fm=void 0;fp=void 0;fr=void 0;if(ft){fp=ft.dir;fm=ft.fq_path;fr=ft.target_ns||ft.ns_id}else{if(cr.inside_dir&&cr.can_get_details_from_fq_path(fs)){fn=cr.details_from_fq_path(fs);fp=true;fm=fn.fq_path;fr=fn.ns_id}else{fp=true;fm=fs;fr=void 0}}fu=T.pluck("fq_path").collect(ay.normalize);if(-1!==fu.indexOf(ay.normalize(fm))){return eA("You cannot copy a folder into itself.")}fq=fl=function(fv){var fw;fw=ay.parent_dir(fv.fq_path);return fw===(fm||"/")};if(T.all(fq)){return bc("That file already exists in that folder.","Those files already exist in that folder.",T.length)}if(!fp){return eA("You cannot put files inside one another.")}if(fo.target_namespaces>0&&fr&&fr!==Constants.root_ns){if(fo.sandboxes>0){if(ft.is_sandbox()){return eA("You're not allowed to put an application folder inside another application folder.")}else{if(ft.is_shared_folder()){return eA("You're not allowed to put an application folder inside a shared folder.")}}}else{if(fo.shared_folders>0){if(ft.is_sandbox()){return eA("You're not allowed to put a shared folder inside an application folder.")}else{if(ft.is_shared_folder()){return eA("You're not allowed to put a shared folder inside another shared folder.")}}}}return eA("You're not allowed to nest special folders.")}if(cr.public_folder_enabled){if(fm==="/Public"&&fo.target_namespaces>0){return eA("You're not allowed to move shared folders to your Public folder.")}}if(fo.public_folder>0){return eA("You're not allowed to move your Public folder.")}if(fo.deleted>0){return eA("Moving deleted folders or files is not allowed.")}},do_move:function(fm,fl){var T;fm=fm||fc.vars.fq_path;fl=fl||fc.vars.selected_path;T=cr.find_file(fm);cJ(T,"Trying to move a file we couldn't find.");return dC.do_bulk_move([T],fl)},do_nonbrowse_move:function(fn,fo,fl){var T,fm;T=bE.Deferred();fm="/cmd/move";new Ajax.DBRequest(fm,{parameters:{files:fo,to_path:fl},subject_user:fn,job:true,html_in_error_msg:true,progress_text:eA("Moving\u2026"),onSuccess:T.resolve,onFailure:T.reject});return T.promise()},do_bulk_move:function(fn,fp){var fl,fm,fo,T;cr.pre_action_selection=eX.get_selected_fq_paths();fn=fn||fc.vars.files;if(!fn){return}cJ(fn.length>0,"Tried to move 0 files");T=fp||fc.vars.selected_path||"";T=ay.normalize(T);fl=dC.bulk_move_error(fn,T);if(fl){ae.error(fl);return}fm=fn.pluck("fq_path");ae.clear();fo=function(ft){var fs,fr,fq,fu;fs=ft.responseText.evalJSON().changesets;fr=fm.length;fq=bU.em_snippet(ay.filename(T),dC.NOTIFICATION_SNIPPET_LEN).escapeHTML();fu=bc('Moved %(count)d item to \u2018<a id="reload-link">%(location)s</a>\u2019.','Moved %(count)d items to \u2018<a id="reload-link">%(location)s</a>\u2019.',fr);fu=fu.format({count:fr,location:fq});W.notifyWithUndo(new fg(fu),fs,dC.do_rollback);$("reload-link").observe("click",function(){return a3.set_path_url(null,T)});b2.schedule_reset();return document.fire(aF.MOVE,{files:fn,to_fq_path:T})};return dC.do_nonbrowse_move(cr.active_user.id,fm,T).then(fo)},do_rollback:function(T){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(T)},subject_user:cr.active_user,job:true,html_in_error_msg:true,progress_text:eA("Undoing..."),onSuccess:function(fl){var fm;fm=eA("Undo complete.");ae.success(fm);cJ(cr.pre_action_selection instanceof Array,"Expected a selection from before the action to be undone");if(cr.in_search_mode()){b9.select_fq_paths=cr.pre_action_selection;b9.force_reload()}else{cr.select_fq_paths=cr.pre_action_selection;cr.force_reload()}return cr.pre_action_selection=false}})},do_bulk_delete:function(T,fn){var fl,fm;cr.pre_action_selection=eX.get_selected_fq_paths();fn=fn||fc.vars.files;cJ(fn.length>0,"Tried to delete 0 files");fm=(function(){var fq,fp,fo;fo=[];for(fq=0,fp=fn.length;fq<fp;fq++){fl=fn[fq];fo.push(fl.fq_path)}return fo})();ae.clear();return new Ajax.DBRequest("/cmd/delete",{parameters:{files:fm},subject_user:T,job:true,html_in_error_msg:true,progress_text:eA("Deleting..."),onSuccess:function(fo){var fq,fp;fp=fo.responseText.evalJSON();fq=bc("Deleted %d item.","Deleted %d items.",fm.length).format(fm.length);W.notifyWithUndo(fq,fp.changesets,dC.do_rollback);b2.schedule_reset();return document.fire(aF.DELETE,{files:fn})}})},do_delete:function(T,fm){var fl;fl=cr.find_file(fm||fc.vars.fq_path);cJ(fl,"Trying to delete a file we couldn't find.");return dC.do_bulk_delete(T,[fl])},do_nonbrowse_delete:function(fl,fm){var T;T=bE.Deferred();new Ajax.DBRequest("/cmd/delete",{parameters:{files:fm},subject_user:fl,html_in_error_msg:true,onSuccess:function(fn){var fo;fo=bc("Deleted %(file_count)s item","Deleted %(file_count)s items",fm.length);fo=fo.format({file_count:fm.length});ae.success(fo);document.fire(aF.DELETE,{fq_paths:fm});return T.resolve(fn)},onFailure:function(fn){return T.reject(fn)}});return T.promise()},do_nonbrowse_rename:function(fm,fn,fl){var T;T=bE.Deferred();new Ajax.DBRequest("/cmd/rename"+encodeURIComponent(fn),{parameters:{to_path:fl},subject_user:fm,html_in_error_msg:true,onSuccess:function(fo){return T.resolve(fo)},onFailure:function(fo){return T.reject(fo)}});return T.promise()},do_purge:function(T){cJ(T,"Trying to purge a file we couldn't find.");return dC.do_bulk_purge([T])},do_bulk_purge:function(fl){var T,fm;cJ(fl.length>0,"Tried to purge 0 files");T=fl.collect(function(fn){return fn.fq_path});fm=bc("Permanently deleted %d item","Permanently deleted %d items",T.length).format(T.length);return new Ajax.DBRequest("/cmd/purge",{parameters:{files:T},subject_user:cr.active_user,job:true,html_in_error_msg:true,progress_text:eA("Deleting..."),onSuccess:function(fn){ae.success(fm);b2.schedule_reset();return document.fire(aF.PURGE,{files:fl})}})},do_bulk_restore:function(fm){var fl,fn,T;fm=fm||fc.vars.files;T=fc.vars.user;cJ(fm.length>0,"Tried to restore 0 files");fl=fm.collect(function(fo){return fo.fq_path});fn=bc("Restored %d item","Restored %d items",fl.length,{comment:"meaning, successfully restored x files and folders"}).format(fl.length);return new Ajax.DBRequest("/cmd/restore",{parameters:{files:fl},subject_user:cr.active_user,job:true,html_in_error_msg:true,progress_text:eA("Restoring..."),onSuccess:function(fo){ae.success(fn);b2.schedule_reset();return document.fire(aF.RESTORE,{files:fm})}})},do_folder_restore:function(fl,T){var fm;fm=function(fn){var fp,fo;fp=eA("Restoring '%(folder_name)s'").format({folder_name:ay.filename(fl)});fo=fn.responseText;if(fo.startsWith("err:")){fo=fo.substring(4);bE("#async-result").html(fo);ae.error(new fg(fo),60)}else{fp=eA("Restored '%(folder_name)s'").format({folder_name:ay.filename(fl)});bE("#status-of-files").text(eA("Restored files"));ae.success(fp,60)}bE("#restore-done-heading").text(fp);bE(".pre-restore").hide();return bE(".post-restore").show()};return new Ajax.DBRequest("/cmd/restore",{parameters:{files:[fl]},job:true,html_in_error_msg:true,progress_text:eA("Restoring..."),onSuccess:fm,onFailure:fm,subject_user:T})},do_bulk_download:function(fm){var fo,fl,fn,T;fo=new Element("form",{action:F({scheme:"https",authority:Constants.BLOCK_CLUSTER,path:"/zip_batch"}).updateQuery(Constants.UID_PARAM_NAME,cr.active_user.id).toString(),method:"post"});for(fn=0,T=fm.length;fn<T;fn++){fl=fm[fn];bT.add_vars(fo,{files:fl.fq_path})}bT.add_vars(fo,{parent_path:cr.block_hash_param||"/",w:cr.block_hash});$(document.body).__sert(fo);return fo.submit()},do_bulk_photo_view:function(fm,T){var fp,fo,fl,fn;if(T==="carousel"||T==="carousel_as_dropbox_photos"){fn={};fn[a9.UID_PARAM_NAME]=cK.get_viewer().personal_user.id;fp=String(F({scheme:"https",authority:fj.WEBSERVER,path:"/app/view_in_timeline",query:fn}))}else{fp=String(F({scheme:"https",authority:fj.WEBSERVER,path:"/photos"}))}fo=new Element("form",{action:fp,method:"post"});bT.add_vars(fo,{t:bw.read(Constants.JS_CSRF_COOKIE),ns_ids:JSON.stringify((function(){var fs,fr,fq;fq=[];for(fs=0,fr=fm.length;fs<fr;fs++){fl=fm[fs];fq.push(fl.ns_id)}return fq})()),ns_paths:JSON.stringify((function(){var fs,fr,fq;fq=[];for(fs=0,fr=fm.length;fs<fr;fs++){fl=fm[fs];fq.push(fl.ns_path)}return fq})())});$(document.body).__sert(fo);return fo.submit()},build_revisions_uri:function(fm,T,fl){if(fl==null){fl={}}fl[Constants.UID_PARAM_NAME]=String(T);if(ax.getGandalfRule("revision-history-web")){return F({path:"/history"+fm}).updateQuery(fl)}else{return F({path:"/revisions"+fm}).updateQuery(fl)}}};var bT,au={}.hasOwnProperty;bT=__CONDITIONAL_JS__.Forms=INLINE_JS.Forms=D.Forms={submitOnlyOnce:function(){var T;T=bT.submitted!==true;bT.submitted=true;return T},disable:function(T){if(T){return setTimeout((function(){return T.disabled=true}),0)}},enable:function(T){if(T){return setTimeout((function(){return T.disabled=false}),0)}},show_button_on_change:function(T,fn){var fm,fo,fp,fl;fm=bE(T);fm.hide();if(fn==null){fn=fm.closest("form")}fo=fn[0];if(this.next_id==null){this.next_id=0}fp=this.next_id++;if(this.initial_vars==null){this.initial_vars={}}this.initial_vars[fp]=this.collect_form_vars(fo);fm.attr("data-id",fp);fn.data("button-id",fp);fl=(function(fq){return function(){var ft,fs,fr;fm.hide();fs=fq.collect_form_vars(fo);if(Object.keys(fs).length!==Object.keys(fq.initial_vars[fp]).length){fm.show()}fr=[];for(ft in fs){if(fs[ft]!==fq.initial_vars[fp][ft]){fr.push(fm.show())}else{fr.push(void 0)}}return fr}})(this);fn.change(fl);fn.find("input").filter(":text").on("input",fl);return fn.find("textarea").on("input",fl)},add_vars:function(fm,fn){var fo,fl,T;fm=$(fm);T=[];for(fl in fn){if(!au.call(fn,fl)){continue}fo=new Element("input",{type:"hidden",name:fl});fo.setValue(fn[fl]);T.push(fm.__sert(fo))}return T},collect_form_vars:function(fo,fn){var fr,fm,fl,fq,fp,T;if(fn==null){fn=false}fo=fo||$(document.body);fm=fo.select("input").concat(fo.select("textarea")).concat(fo.select("select"));fl={};for(fp=0,T=fm.length;fp<T;fp++){fr=fm[fp];if(fr.name&&fr.name!=="t"){fq=fr.getValue();if(fq||fn){if(typeof fq!=="string"){fq=fq.join(",")}if(fl[fr.name]!=null){if(typeof fl[fr.name]==="string"){fl[fr.name]=[fl[fr.name],fq]}else{fl[fr.name].push(fq)}}else{fl[fr.name]=fq}}}}return fl},add_loading:function(fm,T){var fl;if(fm){fm=$(fm);fl=new Element("img",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"});fl.addClassName("text-img ajax_submit_loading");if(T==="after"){return bE(fm).after(fl)}else{return bE(fm).before(fl)}}},remove_loading:function(T){return bE(".ajax_submit_loading").remove()},ui_form_submit:function(fl,T){T=T||fl.action;if(fl.ajax_submitted){return false}fl.ajax_submitted=true;return new by(bE(fl),T,{data:bT.collect_form_vars(fl),success:(function(fm){return function(fq,fn,fr){var fp,fo;fo=bE(fl).data("button-id");if(fo!=null){fp=bE(fl).find("*[type='submit'][data-id='"+fo+"']");fm.initial_vars[fo]=fm.collect_form_vars(fl);return fp.hide()}}})(this),complete:(function(fm){return function(fo,fn){return fl.ajax_submitted=false}})(this)})},ajax_submit_obj:function(fp){var ft,fv,fm,fn,fl,fo,fr,fs,fq,fu,T;fn=fp.form,T=fp.url,fu=fp.success_callback,fm=fp.fail_callback,ft=fp.button,fr=fp.more_vars,fs=fp.position,fo=fp.job,fl=fp.html_response,fv=fp.complete_callback,fq=fp.progress_text;return bT.ajax_submit(fn,T,fu,fm,ft,fr,fs,fo,fl,fv,fq)},ajax_submit:function(fn,fl,fw,fm,fu,fr,fv,fo,T,fz,fp){var fx,fq,fs,fy,ft;if(T==null){T=false}if(fn.ajax_submitted){return false}fn.ajax_submitted=true;ft=bE(fn).find(".suggestion-input");for(fs=0,fy=ft.length;fs<fy;fs++){fx=ft[fs];c4.blank(fx.identify())()}if(fu){bT.add_loading(fu,fv)}fq=bT.collect_form_vars(fn);if(fr){Object.extend(fq,fr)}new Ajax.DBRequest(fl||fn.action,{noAutonotify:true,parameters:fq,job:fo,progress_text:fp,evalJSON:false,onSuccess:function(fA){bT.remove_loading();if(fw&&typeof fw==="function"){return fw(fA)}},onFailure:function(fC){var fA,fB;if(fC){if(fC.responseText.indexOf("err:")===0){fA=fC.responseText.substr(4);if(fA.indexOf("{")===0){fB=fA.evalJSON(true);bT.fill_errors(fn,fB)}else{if(T){fA=new fg(fA)}ae.error(fA)}}else{ae.error()}bT.remove_loading();if(fm&&typeof fm==="function"){return fm(fC)}}},onComplete:function(fD){var fC,fB,fA;fA=fn.select(".suggestion-input");for(fC=0,fB=fA.length;fC<fB;fC++){fx=fA[fC];c4.blur_elm(fx)}fn.ajax_submitted=false;if(fz&&typeof fz==="function"){return fz(fD)}}});return false},clear_errors:function(T){T=T||$(document.body);this.hide_errors(T);return T.select(".error-removable").invoke("remove")},fill_errors:function(fp,fo){var fm,fr,fl,fn,fq,T;fo=fo||{};fp=fp||$(document.body);bT.clear_errors(fp);for(fq in fo){if(!au.call(fo,fq)){continue}fr=fp.down("[data-error-field-name='"+fq+"']")||fp.down("[name='"+fq+"']");if(fr){fm=new Element("br",{"class":"error-removable"});fl=new Element("span",{"class":"error-message error-removable"});fn=fo[fq];cJ(fn.message_html||fn.message_text,"Error message must have a message_html or message_text property");if(fn.message_html){fl.update(fn.message_html)}else{fl.__date(fn.message_text)}bE(fr).before(fl);bE(fr).before(fm);T=bE(fp).find("input[name='"+fq+"'], textarea[name='"+fq+"']");if(T){T.addClass("input-error")}}}return this.show_errors(fp)},value:function(fn){var fm,fl,fp,fo,T;fl=$$('input[name="'+fn+'"]');fp=null;for(fo=0,T=fl.length;fo<T;fo++){fm=fl[fo];fp=$(fm).getValue()||fp}return fp},postRequest:function(fm,fn,T){var fl;if(fn==null){fn={}}if(T==null){T={}}cJ(fm!=null,"postRequest missing action");fn.t=bw.read(Constants.JS_CSRF_COOKIE);fl=new Element("form",{action:fm,method:"POST"});if(T.target){fl.target=T.target}document.body.appendChild(fl);bT.add_vars(fl,fn);return fl.submit()},hide_errors:function(fm){var fp,fo,fn,fl,T;fp=this.get_errors(fm);T=[];for(fn=0,fl=fp.length;fn<fl;fn++){fo=fp[fn];if(fo.down("span.error-message")){T.push(fo.hide())}else{T.push(void 0)}}return T},show_errors:function(fl){var fo,fn,fm,T;fo=this.get_errors(fl);for(fm=0,T=fo.length;fm<T;fm++){fn=fo[fm];if(fn.down("span.error-message")){fn.show()}}return bE(".sick-input").find("label").css("top","")},get_errors:function(fl){var fm,T;T=".error-bubble, .error-plain-text";fm=fl?fl.select(T):$$(T);return fm}};bE(function(){return bT.show_errors()});var U;U=D.ActAsBlock={elm_list:["margin-left","margin-right","padding-left","padding-right","border-left-width","border-right-width"],parent_list:["padding-left","padding-right","border-left-width","border-right-width"],register:function(fo,fp){var fn,fl,fm,T;if(fp==null){fp=document.body}fm=$(fp).getElementsByClassName("act_as_block");T=[];for(fn=0,fl=fm.length;fn<fl;fn++){fo=fm[fn];T.push(this.resize(fo))}return T},resize:function(fo){var T,fm,fn,fl;fo=$(fo);fm=fo.up();T=d5.sumStyles(fo,this.elm_list);fn=d5.sumStyles(fm,this.parent_list);fo.style.width="1px";fl=fm.getWidth()-T-fn;if(fl>0){return fo.style.width=fl+"px"}}};var be;be=D.BrowseStyleRows={register_all:function(){var fn,fm,T,fl;fl=$$(".bs-row");for(fm=0,T=fl.length;fm<T;fm++){fn=fl[fm];this.register(fn)}Event.observe(document,"click",this.kill_current.bind(this));return bE(document).on("dropdown-opened",this.kill_current.bind(this))},register:function(fl){var T;fl=$(fl);fl.db_observe("mouseover",this.mouseover.bind(this));fl.db_observe("mouseout",this.mouseout.bind(this));T=fl.down(".action-button");if(T){return T.db_observe("click",this.click.bind(this))}},mouseover:function(fl,T){if(!T.hasClassName("no-hover")){return T.addClassName("hover")}},mouseout:function(fl,T){return T.removeClassName("hover")},click:function(fn,fl){var T,fo,fm;if(fn.target.tagName==="A"){return}fo=fl.up(".bs-row");Event.stop(fn);if(fo.hasClassName("selected")){this.kill_current(false);return}bE(document).trigger("dropdown-opened");this.kill_current(false);fm=$(fn.target);if(!fm.match(".bs-actions-list *")){fo.addClassName("selected")}T=(fm.hasClassName("bs-row")?fm:fm.up(".bs-row"));return T.style.zIndex=9},kill_current:function(fo){var fp,fn,fl,fm,T;fm=$$(".bs-row.selected");T=[];for(fn=0,fl=fm.length;fn<fl;fn++){fp=fm[fn];fp.removeClassName("selected");T.push(fp.style.zIndex="")}return T}};var eo;eo=D.Bubble={make:function(fx,fI,fA,fv,fr){var fo,fy,fF,fn,fm,fH,fC,fw,fu,fp,ft,fz,fE,fs,T,fq,fl,fG,fD,fB;if(fI==null){fI="left"}fr=fr!=null?fr:{};if(["left","right"].contains(fI)){fA=fA||"middle";cJ(["top","middle","bottom"].contains(fA),"expected tail position ['top', 'middle', 'bottom'], got "+fA)}else{if(["bottom","top"].contains(fI)){fA=fA||"center";cJ(["left","center","right"].contains(fA),"expected tail position ['left', 'center', 'right'], got "+fA)}else{if(!["none"].contains(fI)){cJ(false,"unexpected tail side, got "+fI)}}}fz=new Element("table");if(fr.style==="titled"){fz.addClassName("bluebubble");fE="bluebubble"}else{fz.addClassName("bubble");fE="bubble"}if(fv){fz.style.width=fv+"px"}T=new Element("tbody");fG=new Element("tr");fq=new Element("td");fq.addClassName("tl");ft=new Element("td");ft.addClassName("t");if(fr.style==="titled"){if(fv){ft.style.width=(fv-42)+"px"}}fl=new Element("td");fl.addClassName("tr");if(fI==="top"){fs=new Element("img",{src:"/static/images/"+fE+"_arrow_top.png"});fs.addClassName("tarrow");if(fr.style==="titled"){fs.addClassName("arrow-"+fA);fy=new Element("div");fy.addClassName("arrow-container");if(fv){fy.style.width=(fv-42)+"px"}fy.__sert(fs);ft.__sert(fy)}else{ft.style.textAlign=fA;ft.__sert(fs)}}fG.__sert(fq);fG.__sert(ft);fG.__sert(fl);T.__sert(fG);fD=new Element("tr");fw=new Element("td");fw.addClassName("l");if(fI==="left"){if(fr.style==="titled"){fo=new Element("img",{src:"/static/images/bluebubble_arrow_left-vfl8zzy_-.png"})}else{fo=new Element("img",{src:"/static/images/bubble_arrow-vfl8m7tk-.png"})}fo.addClassName("arrow");fw.__sert(fo);fw.vAlign=fA}fC=new Element("td");fC.addClassName("c");fC.update(fx);fu=new Element("td");fu.addClassName("r");if(fI==="right"){fp=new Element("img",{src:"/static/images/bubble_arrow_right-vflmW3_2s.png"});fp.addClassName("rarrow");fu.__sert(fp);fu.vAlign=fA}fD.__sert(fw);fD.__sert(fC);fD.__sert(fu);T.__sert(fD);fB=new Element("tr");fm=new Element("td");fm.addClassName("bl");fF=new Element("td");fF.addClassName("b");if(fI==="bottom"){fn=new Element("img",{src:"/static/images/"+fE+"_arrow_bottom.png"});fn.addClassName("barrow");if(fr.style==="titled"){fn.addClassName("arrow-"+fA);fy=new Element("div");fy.addClassName("arrow-container");if(fv){fy.style.width=(fv-42)+"px"}fy.__sert(fn);fF.__sert(fy)}else{fF.style.textAlign=fA;fF.__sert(fn)}}fH=new Element("td");fH.addClassName("br");fB.__sert(fm);fB.__sert(fF);fB.__sert(fH);T.__sert(fB);fz.__sert(T);return fz}};var eU;eU=INLINE_JS.FreshDropdown=D.FreshDropdown={show:function(fq,fn,fm,fl){var fp,fo,fr,T;if(fl==null){fl=false}bE(document).trigger("dropdownOpened",[1]);fp=bE(fn);if(!fm){fm=fp[0].offsetHeight+10}this.hide_all();fo=bE(fq).show();T=fo[0].offsetWidth;fr=fp[0].offsetWidth;fo.clonePosition(fp,{setHeight:false,setWidth:false,offsetLeft:-1*(T-fr)+22,offsetTop:fm});if(fl){fo.width(T)}fp.addClass("pressed");return((function(fs){return function(){return document.observe("click",eU.hide_all)}})(this)).defer()},hide_all:function(fm){var fl,T;T=bE(".freshdropdown-menu");fl=0;T.each(function(){if(bE(this).is(":visible")){return fl+=1}});T.hide();bE(document).trigger("dropdownClosed",[fl]);$$(".freshdropdown-button").invoke("removeClassName","pressed");return document.stopObserving("click",eU.hide_all)}};var aa;aa=D.JumpWatcher={inverval:null,last_hash:null,last_page_offset:0,check:function(){if(window.location.href.endsWith("#")&&window.pageYOffset===0&&aa.last_page_offset!==0){return this.report()}else{this.last_page_offset=window.pageYOffset;return this.last_hash=F.parse(window.location.href).fragment}},report:function(){clearInterval(aa.interval);return cJ(0.1+0.2===0.3,"Hash jump detected, last hash = "+this.last_hash+". You may have an onclick handler that isn't firing, or you are not preventing the default action (eg. by returning false in your handler)")}};var e6,bm,au={}.hasOwnProperty,cN=function(fn,fl){for(var T in fl){if(au.call(fl,T)){fn[T]=fl[T]}}function fm(){this.constructor=fn}fm.prototype=fl.prototype;fn.prototype=new fm();fn.__super__=fl.prototype;return fn};e6=D.LocaleSelectorModal=(function(fl){cN(T,fl);function T(){return T.__super__.constructor.apply(this,arguments)}T.prototype.action="https://"+Constants.WEBSERVER+"/set_locale";T.prototype.on_show=function(){return this.$modal_window.on("click",".locale-option",(function(fm){return function(fn){fn.preventDefault();fm.hide();return fm.set_locale(bE(fn.target).attr("data-locale"))}})(this))};T.prototype.on_hide=function(){return this.$modal_window.off("click")};T.prototype.set_locale=function(fm,fo){var fn;if(fo==null){fo=false}fn=bE("<form />",{action:this.action,method:"post"});bT.add_vars(fn[0],{locale:fm,locale_cont:fo||window.location.href,t:bw.read(Constants.JS_CSRF_COOKIE)});bE(document.body).append(fn);return fn.submit()};return T})(d7);bm=D.TeamLocaleSelectorModal=(function(T){cN(fl,T);function fl(){return fl.__super__.constructor.apply(this,arguments)}fl.prototype.action="https://"+Constants.WEBSERVER+"/team/admin/set_locale";return fl})(e6);var dN;dN=D.LoginDropdown={init:function(){var T;T=bE("#login-hover-link");if(!(T.length>0)){return}this.login_link=T;return this.register()},register:function(T){this.login_link.on("click",this.click.bind(this));this.login_link.on("mousedown",this.mousedown.bind(this));this.login_link.on("focus",this.click.bind(this));return $(document.body).on("click",this.unclick.bind(this))},mousedown:function(T){return this.clicking=true},click:function(T){T.preventDefault();if(this.clicking&&T.type==="focus"){return}this.clicking=false;if(this.down){return this.unclick()}bE(document).trigger("dropdownOpened",[1]);this.down=true;this.login_link.parent().addClass("down");return bE("input[name='login_email']").focus()},unclick:function(fl){var T;if(fl){T=bE(fl.target);if(T[0].match("#top-login-wrapper, #top-login-wrapper *")){return}}if(this.down){bE(document).trigger("dropdownClosed",[1])}this.down=false;return this.login_link.parent().removeClass("down")}};var fc;fc=__CONDITIONAL_JS__.Modal=INLINE_JS.Modal=D.Modal={KEY_SCOPE:"modal",width:640,vertical_offset:90,show:function(fw,fs,ft,fy,fm,fu,fq,fr,fx){var fl,fo,fv,T,fn,fp;if(ft==null){ft=false}if(fy==null){fy=false}if(fm==null){fm=false}if(fu==null){fu=false}if(fq==null){fq=""}if(fr==null){fr=true}if(fx==null){fx=false}if(fc.shown()){fc._cleanup()}fm=fm||this.width;fo="#modal-content .error-message, #modal-content .error-removable, #modal-content .error-bubble";$$(fo).invoke("hide");if(an.uploading&&!fu){b8(eA("You can't do this while uploading."));return false}cJ(fs,"Missing modal content!");fn=this.vars._prev_scope;this.vars=ft||{};this.vars._prev_scope=fn;$("modal").setStyle({width:""+fm+"px",margin:"0 0 0 "+(Math.floor(-fm/2).toString())+"px"});this.vars.extra_class="";if(fq){$("modal").addClassName(fq);this.vars.extra_class=fq}if(!fu){if(an.num_files()){cA.reset();an.clear()}T=d5.childElement($("modal-content"),0);if(T&&T!==fs){$("grave-yard").__sert(T)}fl=new Element("div");fl.update(fs);$("modal-content").__sert(fl);if(fs.show){fs.show()}Element.show("modal")}bE("#modal-overlay").off("click");if(fr){bE("#modal-overlay").on("click",function(fz){fc.hide(null,false,true);fz.preventDefault();return fz.stopPropagation()})}else{bE("#modal-overlay").on("click",function(fz){fz.preventDefault();return fz.stopPropagation()})}this.fix_position();$("modal-overlay").show();$("modal-behind").setStyle({width:""+(fm+20)+"px",margin:"0 0 0 "+(Math.floor(-fm/2-10).toString())+"px"});bE("#modal-behind").css("opacity",0.2);$("modal-behind").show();if(fy){$("modal-content").select("#"+fy.id).first().focus()}else{if(!d5.ie){fv=$("modal").down("input[type=submit]")||$("modal").down("input[type=button]");if(fv){fv.focus()}}}if(!this.track_id){this.track_resizes()}if(fw){if(d5.isElm(fw)){bE("#modal-title").html(fw)}else{bE("#modal-title").text(fw)}bE("#modal-title").show();fp=bE("#modal-title").text();eJ("Modal.show:",fp)}else{bE("#modal-title").hide();eJ("Modal.show")}U.register(false,"modal");this.keydownHandler=this.keydown.bind(this);document.observe("keydown",this.keydownHandler);$("modal-content").style.height="auto";if(key.getScope()!==this.KEY_SCOPE){this.vars._prev_scope=key.getScope()}key.setScope(this.KEY_SCOPE);this.prevent_hide_if_loading=fx;bE("#modal").find("input").filter(":visible:first").focus();if(this.in_viewport()){this.scroll_locked=true;B.scroll_lock_document()}bE(document).trigger("modalOpened",[1]);return false},in_viewport:function(){var fm,T,fl,fo,fn;fm=bE("#modal");T=fm.height();fn=fm.width();fl=B.viewport_dimensions();fo=B.viewport_offset(fm);return fo.left>0&&fo.top>0&&fo.left+fn<fl.width&&fo.top+T<fl.height},fix_position:function(fm){var fl,T;T=document.viewport.getScrollOffsets().top+this.vertical_offset;fl=parseInt($("modal").getStyle("height"),10);if(fl+this.vertical_offset<document.viewport.getHeight()){$("modal").setStyle({position:"fixed",top:this.vertical_offset+"px"});return $("modal-behind").setStyle({position:"fixed",height:(fl+20)+"px",top:(this.vertical_offset-10)+"px"})}else{$("modal").setStyle({position:"absolute",top:T+"px"});return $("modal-behind").setStyle({position:"absolute",height:(fl+20)+"px",top:(T-10)+"px"})}},keydown:function(fn){var fo,T,fm,fl;fm=fn.keyCode||fn.which||fn.charCode;if(fm===27||(fm===8&&!B.focus_in_input())){fn.preventDefault();this.hide(null,false,true)}if(fm===9&&!B.focus_in_input()){T=$("modal").down("input[type=text], input[type=email]");fl=$("modal").down(".modal-tabs");fo=fl;while(fo&&fo.next()){fo=fo.next();if(fo.visible()){T=fo.down("input[type=text], input[type=email]");break}}if(T){fn.preventDefault();return T.focus()}}},shown:function(){return $("modal").visible()},hide:function(fm,T,fl){if(fm){Event.stop(fm)}if(this.should_prevent_hide()){return false}this.prevent_hide_if_loading=false;if(this.onHide){this.onHide(fl);return}this.onHide=null;Element.hide("modal-behind");Element.hide("modal-overlay");$("modal").removeClassName(this.vars.extra_class);if(!T&&!an.num_files()){Element.hide("modal")}else{$("modal").style.marginLeft="-10000000px";if(an.uploading){cZ.show()}}fc._cleanup();if(this.track_id){clearInterval(this.track_id);this.track_id=false}document.stopObserving("keydown",this.keydownHandler);if(document.activeElement&&[document,window,document.body].indexOf(document.activeElement)===-1){$(document.activeElement).blur()}key.setScope(this.vars._prev_scope);return eJ("Modal.hide")},_cleanup:function(){bE(document).trigger("modalClosed",[1]);if(this.scroll_locked){return B.scroll_unlock_document()}},should_prevent_hide:function(){return this.prevent_hide_if_loading&&bx.some(bE("#modal form"),function(T){return T.ajax_submitted})},track_resizes:function(){return this.track_id=setInterval(this.on_resize.bind(this),150)},on_resize:function(){var T;T=$("modal").getHeight();if(this.old_height!==T||$("modal-behind").getHeight()<T){this.old_height=T;return this.fix_position()}},vars:{}};var e3,e1,d1,eg,du=function(T,fl){return function(){return T.apply(fl,arguments)}},bK=[].indexOf||function(fm){for(var fl=0,T=this.length;fl<T;fl++){if(fl in this&&this[fl]===fm){return fl}}return -1},au={}.hasOwnProperty,cN=function(fn,fl){for(var T in fl){if(au.call(fl,T)){fn[T]=fl[T]}}function fm(){this.constructor=fn}fm.prototype=fl.prototype;fn.prototype=new fm();fn.__super__=fl.prototype;return fn};d1=D.RolePickerState={ALL:"all",PERSONAL:Constants.ROLE_PERSONAL,WORK:Constants.ROLE_WORK};e1=D.RolePicker=(function(){function T(fo){var fp,fl,fn,fm,fr,fq;if(fo==null){fo={}}this._actually_set_state=du(this._actually_set_state,this);this._do_login=du(this._do_login,this);this.is_user_visible=du(this.is_user_visible,this);this.is_role_visible=du(this.is_role_visible,this);this.ensure_role_is_visible=du(this.ensure_role_is_visible,this);this.update_picker_ui=du(this.update_picker_ui,this);this.set_state=du(this.set_state,this);this.get_state=du(this.get_state,this);this._allow_merged_state=fo.allow_merged_state!=null?fo.allow_merged_state:true;this._limit_to_role=fo.limit_to_role!=null?fo.limit_to_role:null;fr=cK.get_viewer();fl=fr.is_role_signed_in(d1.PERSONAL)&&fr.is_role_signed_in(d1.WORK);if(fo.initial_state){fn=bx.values(d1);cJ((fq=fo.initial_state,bK.call(fn,fq)>=0),"RolePicker requires initial_state to be one of: "+fn);this.set_state(fo.initial_state)}else{if(this._allow_merged_state&&fl){this.set_state(d1.ALL)}else{fp=fr.get_users();cJ(fp.length,"tried to use RolePicker on a page with no users");fm=fp[0];this.set_state(fm.role)}}}T.prototype.get_state=function(){return this._state};T.prototype.set_state=function(fm){var fp,fo,fl,fn;cJ(this._allow_merged_state||(fm!==d1.ALL),"tried to set merged state in non-merged picker");if(this._limit_to_role!=null){cJ((fm===d1.ALL)||(fm===this._limit_to_role))}if(fm===d1.ALL){fn=[Constants.ROLE_PERSONAL,Constants.ROLE_WORK,Constants.ROLE_PHOTOS];for(fo=0,fl=fn.length;fo<fl;fo++){fp=fn[fo];if(!cK.get_viewer().is_role_signed_in(fp)){this._do_login(fp,fm);return}}}else{fp=fm;if(!cK.get_viewer().is_role_signed_in(fp)){this._do_login(fp,fm);return}}return this._actually_set_state(fm)};T.prototype.update_picker_ui=function(){};T.prototype.ensure_role_is_visible=function(fl){if(!this.is_role_visible(fl)){if(this._allow_merged_state){return this.set_state(d1.ALL)}else{return this.set_state(fl)}}};T.prototype.is_role_visible=function(fl){return this._state===d1.ALL||this._state===fl};T.prototype.is_user_visible=function(fl){return this.is_role_visible(fl.role)};T.prototype._do_login=function(fl,fm){return bO.show_modal({role:fl,on_success:(function(fn){return function(){return fn._actually_set_state(fm)}})(this)})};T.prototype._actually_set_state=function(fl){if(fl===this._state){return}this._state=fl;this.update_picker_ui();return typeof this.on_state_change==="function"?this.on_state_change(fl):void 0};return T})();eg=D.RoleSelect=(function(fl){cN(T,fl);function T(fn,fm){if(fm==null){fm={}}this.limit_to_role=du(this.limit_to_role,this);this.update_picker_ui=du(this.update_picker_ui,this);this.on_ui_change=du(this.on_ui_change,this);this.$container=fn;this.$bubble_picker=this.$container.find(".bubble-picker");this.$bubble_picker.on(bA.CHANGED,this.on_ui_change);T.__super__.constructor.call(this,fm)}T.prototype.on_ui_change=function(fm,fo){var fn;fn=fo.clicked_val;if(fn!==this._state){B.controller(this.$bubble_picker).set_value(this._state);return this.set_state(fn)}};T.prototype.update_picker_ui=function(){B.controller(this.$bubble_picker).set_value(this._state);return this.$bubble_picker.find(".bubble-picker-label .role-option").addClass("title_bubble")};T.prototype.limit_to_role=function(fp,fn){var fm,fo;if(fp!=null){this.ensure_role_is_visible(fp);for(fm in d1){fo=d1[fm];if(fo===fp||fo===d1.ALL){continue}B.controller(this.$bubble_picker).disable_option(fo,fn)}}else{for(fm in d1){fo=d1[fm];B.controller(this.$bubble_picker).enable_option(fo)}}return this._limit_to_role=fp};return T})(e1);e3=D.PageRoleSelect=(function(fl){cN(T,fl);function T(fn,fm){if(fm==null){fm={}}fm.allow_merged_state=false;T.__super__.constructor.call(this,fn,fm)}T.prototype.on_state_change=function(fn){var fm;fm=(function(){switch(fn){case d1.PERSONAL:return Constants.ROLE_PERSONAL;case d1.WORK:return Constants.ROLE_WORK}})();return a6.emit(fm)};return T})(eg);var ch;ch=D.SickInput={init:function(){var fo,fn,fl,fm,T;fm=$$(".sick-input");T=[];for(fn=0,fl=fm.length;fn<fl;fn++){fo=fm[fn];if(!fo.hasClassName("sickified")){T.push(this._create(fo))}}return T},_create:function(fn){var fm,T,fl;if(fn==null){return}fm=fn.identify();T=fn.down("input")||fn.down("textarea")||fn.down("select");T.observe("focus",function(){return fn.addClassName("focused")});T.observe("blur",function(){return fn.removeClassName("focused")});fl=function(){if(fn.hasClassName("populated")&&T.getValue()===""){fn.removeClassName("populated")}else{if(!fn.hasClassName("populated")&&T.getValue()!==""){fn.addClassName("populated")}}if(fm in ch._handler_map){return ch._handler_map[fm]()}};bT.show_errors();fl();return setInterval(fl,100)},_handler_map:{},add_interval_handler:function(fl,T){var fm;fm=fl.identify();return this._handler_map[fm]=T},remove_interval_handler:function(fl,T){var fm;fm=fl.identify();if(this._handler_map[fm]===T){return delete this._handler_map[fm]}}};var c4;c4=D.SuggestionInput={register:function(fl){var T;fl=$(fl);T=fl.up("form");if(c4.defaulted(fl)||fl.getValue()===""){fl.setValue(fl.title)}else{fl.addClassName("suggestion-input-unfaded")}fl.observe("blur",this.blur.bind(this));fl.observe("focus",this.focus.bind(this));fl.observe("db:value_change",this.focus.bind(this));if(T){if(!fl.id){fl.id="r_elm_id_"+(Math.random().toString())}return T.observe("submit",c4.blank(fl.id).bind(this))}},register_all:function(){var fm,fo,fl,fn,T;fn=$$(".suggestion-input");T=[];for(fo=0,fl=fn.length;fo<fl;fo++){fm=fn[fo];T.push(this.register(fm))}return T},blank:function(T){return(function(fl){return function(){var fm;fm=$(T);if(!fm){return}if(fl.defaulted(fm)){return fm.setValue("")}}})(this)},defaulted:function(T){T=$(T);return T.getValue()===T.title},do_blank:function(T){return this.blank(T)()},clear:function(T){var fl;fl={target:T};return this.focus(fl)},focus:function(T){var fl;fl=$(T.target);if(!fl){return}if(this.defaulted(fl)){fl.addClassName("suggestion-input-unfaded");return fl.setValue("")}},blur_elm:function(T){if(T.getValue()===""){T.removeClassName("suggestion-input-unfaded");T.setValue(T.title)}return T.blur()},blur:function(T){var fl;fl=$(T.target);if(!fl){return}return this.blur_elm(fl)},reset:function(fl){var T;T=$(fl);if(!T){return}T.removeClassName("suggestion-input-unfaded");T.setValue(T.title);T.defaulted=true;return T.blur()},setValue:function(T,fl){var fm;fm=$(T);if(!fm){return}fm.addClassName("suggestion-input-unfaded");fm.setValue(fl);return fm.defaulted=false}};var bo;bo=D.TitleBubble=(function(){var fm,fl,fq,fn,fo,T,fp;fp=0;fm=0;T=function(fr){return fp=fr};fo=function(fx){var fC,fA,fu,fy,ft,fr,fz,fw,fs,fv,fB;fy=bE(fx.currentTarget);fB=fy.attr("title");if(fB!=null?fB.length:void 0){fy.attr("data-title",fB);fy.removeAttr("title")}fu=parseInt(fy.data("title-delay"));fA="title-bubble-"+(fm++);fy.data("bubble-id",fA);fC=bE("<div/>",{id:fA,"class":"title_bubble_container"});if(!fu){fC.css({opacity:0});fC.addClass("has-transition")}if(fy.hasClass("white")){fC.addClass("white")}if(fy.hasClass("black")){fC.addClass("black")}fC.text(fy.attr("data-title"));fz=fy.attr("data-title-html");fC.html(fz);fs=fy.attr("data-title-hide-tail")!=="yes";if(fs){fv=bE("<div/>",{"class":"tail"});fC.append(fv)}bE(document.body).append(fC);fr=fq(fy[0],fC[0]);ft=fl(fr,fC[0],fy[0]);fC.clonePosition(fy,{setWidth:false,setHeight:false,offsetTop:ft.top-fp,offsetLeft:ft.left});fC.addClass("position-"+fr);if(fs){fv.clonePosition(fy,{setWidth:false,setHeight:false,setTop:false,offsetLeft:ft.left+ft.tail_offset_left+(bE(fC).outerWidth()/2)})}fw=function(){var fD;if(!((fC.data("pending-delay"))&&(fy.data("bubble-id")===fA))){return}fD=(parseInt(fy.data("title-fade-time")))||400;return fC.fadeIn(fD)};if(fu){fC.hide();fC.data("pending-delay",true);return setTimeout(fw,fu)}else{return fC.css({opacity:""})}};fq=function(fv,fr){var fu,ft,fs;fv=$(fv);fs=fv.getAttribute("data-title-position");fu=document.viewport.getDimensions();ft=fv.viewportOffset();if(!(fs==="above"||fs==="below"||fs==="right"||fs==="left")){fs="above"}if(fs==="left"){if(ft.left<fr.width){return"right"}}else{if(fs==="right"){if(fu.width-(ft.left+fv.getWidth())<fr.width){return"left"}}else{if(fs==="below"){if(fu.height-(ft.top+fv.getHeight())<fr.height){return"above"}}else{if(fs==="above"){if(ft.top<fr.height){return"below"}}}}}return fs};fl=function(ft,fA,fw){var fy,fu,fB,fx,fz,fv,fr,fD,fC,fs;fA=$(fA);fw=$(fw);fB=document.viewport.getDimensions();fy=fA.getDimensions();fx=fw.viewportOffset();fu=6;fz=0;fv=0;fC=0;fs=0;if(ft==="below"||ft==="above"){if(ft==="below"){fv=fw.getHeight()+fu}else{fv=(-1*fy.height)-fu}fr=fw.getWidth()/2-fy.width/2;if(fx.left+fr+fy.width>fB.width){fz=fB.width-fx.left-fy.width;fC=fr-fz-5}else{fz=fr;fC=-5}}if(ft==="left"||ft==="right"){if(ft==="right"){fz=fw.getWidth()+fu}else{fz=(-1*fy.width)-fu}fD=fw.getHeight()/2-fy.height/2;if(fx.top+fD+fy.height>fB.height){fv=fB.height-fx.top-fy.height;fs=fD-fv-5}else{fv=fD;fs=-5}}return{left:fz,top:fv,tail_offset_left:fC,tail_offset_top:fs}};fn=function(fs){var fr,ft,fu;fu=bE(fs!=null?fs.currentTarget:void 0);fr=bE("#"+fu.data("bubble-id"));if(fr.data("pending-delay")){fr.removeData("pending-delay");ft=(parseInt(fu.data("title-fade-time")))||400;return fr.fadeOut(ft,function(){return fr.remove()})}else{return fr.remove()}};return{init:function(){bE(document).on("mouseenter",".title_bubble",fo);bE(document).on("mouseleave",".title_bubble",fn).on("mouseup",".title_bubble",fn);bE(document).on("mouseenter",".title_bubble_sticky",fo);return bE(document).on("mouseleave",".title_bubble_sticky",fn)},set_vertical_space:T,hide_all:function(){return bE(".title_bubble_container").remove()}}})();var ej;ej=INLINE_JS.Tooltip=D.Tooltip={attach:function(fp,fm,T,fl){var fo,fn;if(fl==null){fl={}}fp=$(fp);T=(T?$(T):null);fo=eo.make(fm,fp.tail_position,fl.tail_position,fl.width,fl);fo.setStyle({display:"none",position:"absolute"});$("floaters").__sert(fo);if(fp.match("#modal-content *")||fp.match(".db-modal-content *")){fo.style.zIndex="13001"}else{fo.style.zIndex=""}if(fp.tail_position==="right"){fn=(d5.ie?32:12);fo.style.marginLeft=-(fo.getWidth()+fp.getWidth()+fn)+"px"}fp.tooltip=fo;fp.out_target=(T?true:false);fp.observe("mouseout",this.mouseout("target",fp));fp.observe("mouseover",this.mouseover("target",fp));fp.out_trigger=(T?false:true);if(T){T.observe("mouseout",this.mouseout("trigger",fp));T.observe("mouseover",this.mouseover("trigger",fp))}fp.out_tooltip=true;fo.observe("mouseout",this.mouseout("tooltip",fp));return fo.observe("mouseover",this.mouseover("tooltip",fp))},update:function(fl,T){if(fl.tooltip){return $(fl.tooltip).update(T)}},mouseover:function(T,fl){return function(){return fl["out_"+T]=false}},mouseout:function(T,fl){return function(){fl["out_"+T]=true;return ej.hide_if_out.defer(fl)}},show_by:function(fl){var fm,T;fm=bE(fl.tooltip);fl=bE(fl);fm.show();T=Math.floor(fm[0].offsetHeight/2);return fm.clonePosition(fl,{setWidth:false,setHeight:false,offsetTop:Math.floor(fl[0].offsetHeight/2)-T,offsetLeft:fl[0].offsetWidth+1})},hide_if_out:function(T){var fl;if(!T.out_target||!T.out_trigger||!T.out_tooltip){return}fl=$(T.tooltip);return fl.hide()},show:function(fo,fn,fl,T,fm){if(T==null){T="left"}fo=$(fo);if(!fo.tail_position){fo.tail_position=T}fl=(fl?$(fl):null);if(!fo.tooltip){this.attach(fo,fn,fl,fm)}return this.show_by(fo)}};var b2;b2=INLINE_JS.TreeView=D.TreeView={tv:{},loaded:false,user:null,role_icon:"",set_params:function(T){return this.ajax_params=T},init:function(fm,T,fn){var fl;if(fn==null){fn="treeview"}this.tv[fn]={};fl=this.tv[fn];fl.autohide=(T===null?true:T);fl.handler=fm;fl.viewdiv=$(fn);fl.hidefunc=this.hide.bindAsEventListener(this);this.ajax_params={};document.observe(bD.ADD,(function(fo){return function(fp){return fo.schedule_reset()}})(this));document.observe(bD.REMOVE,(function(fo){return function(fp){return fo.schedule_reset()}})(this));return document.observe(bD.MOVE,(function(fo){return function(fp){return fo.schedule_reset()}})(this))},schedule_reset:function(){return this.loaded=false},reset:function(fp){var fm,fn,fl,fr,T,fo,fq;fm={url:"/ajax_subtreeview",type:"post",data:bE.extend({},this.ajax_params),success:(function(fs){return function(fu){var fv,ft;ft=[];for(fv in fs.tv){if(fs.tv.hasOwnProperty(fv)){fs.tv[fv].viewdiv.down(".treeview-folders").update(fu);if(fp&&fp.onSuccess){ft.push(fp.onSuccess(fu))}else{ft.push(void 0)}}else{ft.push(void 0)}}return ft}})(this)};if(fp!=null?fp.user:void 0){if(fp.user.id!==((fq=this.user)!=null?fq.id:void 0)){fr=bE("<p />",{id:"treeview-loading"});T=bE("<img />",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"});fr.append(T);fo=" "+eA("Loading your folders");fr.append(fo);bE("#dest-treeview .treeview-folders").html(fr);this.user=fp.user}fm.subject_user=fp.user;fl=cK.get_role_title(fp.user);if(cK.get_viewer().is_paired){if(fp.user.is_team){fn="s_briefcase"}else{fn="s_house"}}else{fn="dropbox"}if(!fl){fl=eA("Dropbox")}bE("#first-treeview-link span").text(fl);cv.replace(bE("#root-img")[0],"web",this.role_icon,fn);this.role_icon=fn}else{bE("#first-treeview-link span").text(eA("Dropbox"))}return bE.ajax(fm)},toggle:function(fm,fl){var T;Event.stop(fm);T=this.tv[fl||"treeview"];if(T.shown){T.shown=false;this.hide(fm,fl)}else{T.shown=true;this.show(fm.target,fl)}return false},hide:function(fm,fl){var T;T=this.tv[fl||"treeview"];if(!fm||!$(fm.target).descendantOf(T.viewdiv)){T.viewdiv.hide();Event.stopObserving(window,"click",T.hidefunc);return T.shown=false}},show:function(fm,fl){var fn,T;T=this.tv[fl||"treeview"];fm=$(fm);fm.blur();fn=fm.cumulativeOffset();T.viewdiv.setStyle({top:(fn.top+fm.getHeight())+"px",left:(fn.left-4)+"px"});T.viewdiv.show();return Event.observe(window,"click",T.hidefunc)},toggleNode:function(fl){var T;fl=$(fl);T=fl.down("img");if(T.className.match("bullet_plus")){cv.replace(T,"web","bullet_plus","bullet_minus")}else{cv.replace(T,"web","bullet_minus","bullet_plus")}fl.up().next("div").toggle();fl.blur();return false},toggleNodeAjax:function(fn,T,fl){var fm,fo;if(fn.fetched_children){return this.toggleNode(fn)}fn=$(fn);fm=fn.down("img");fo=cv._get(fm);fm.src="/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif";bE.ajax({url:"/ajax_subtreeview"+T,type:"post",data:bE.extend({},this.ajax_params),subject_user:fl,success:(function(fp){return function(fq){var fr;fr=new Element("div",{style:"display: none;"}).update(fq);fn.up().__sert({after:fr});fn.fetched_children=true;cv._set(fm,fo);return fp.toggleNode(fn)}})(this),complete:function(){if(/loading/.match(fm.src)){return cv._set(fm,fo)}}});return false},handle:function(fm,fl){var fn,T;fn=$H(this.tv).keys();T=$(fl).ancestors().find(function(fo){return fn.include(fo.id)});if(!T){return}T=this.tv[T.id];bE(document).trigger("db:treeview_selected",[fm]);if(T.handler){T.handler(fm,fl)}if(T.autohide){this.hide(T.id)}return false},move:function(fm,fn,fl){var T;T=$(fm);if(!this.loaded){this.reset({onSuccess:(function(fo){return function(){fo.loaded=1;return fo.move(fm,fn,fl)}})(this),user:fl!=null?fl.user:void 0})}else{if(fl&&fl.onSuccess){fl.onSuccess()}}cJ(T,"Couldn't find tree_id");cJ($(fn),"Couldn't find location_id");$(fn).appendChild(T);return T.show()}};var aP;aP=D.ULSelectMenu=(function(){var fn,fr,fm,fs,ft,fo,fq,T,fp,fl,fu;fn=function(fv){return fv.removeClassName("shown")};fu=function(fv){return fv.toggleClassName("shown")};fq=function(){return this.removeClassName("hover")};fo=function(){return this.addClassName("hover")};T=function(fz,fy){var fv,fA,fx,fw;fw=[];for(fA=0,fx=fy.length;fA<fx;fA++){fv=fy[fA];fw.push(fz.insert(fv))}return fw};fs=function(fx,fv,fw){T(fx,fw);if(fx.firstChild!==fv){return fx.__sert({top:fv})}};fp=function(fw,fx){var fv;fv="selected";bE(fw).find("."+fv).removeClass(fv);return bE(fx).addClass(fv)};fl=function(fx,fA){var fB,fz,fw,fy,fv;fy=fx.select("li");fv=[];for(fz=0,fw=fy.length;fz<fw;fz++){fB=fy[fz];if(fB.getAttribute("data-value")===fA){fv.push(fp(fx,fB))}else{fv.push(void 0)}}return fv};ft=function(fv,fx,fw){return function(fy){if(!fv.hasClassName("selected")){fp(fx,fv);fx.fire("db:change",fv.getAttribute("data-value"));return fn(fx)}else{fs(fx,fv,fw);return fu(fx)}}};fr=function(fx){var fA,fD,fz,fw,fC,fv,fy,fB;fD=fx.select("li");cJ(fD.length,"Empty list of options "+fx.identify());fz=void 0;if(fD.length===1){fx.addClassName("one")}else{for(fy=0,fB=fD.length;fy<fB;fy++){fA=fD[fy];fC=fA.getAttribute("data-value");cJ(fC,fA.identify()+" missing data value");fA.observe("click",ft(fA,fx,fD));fA.observe("mouseenter",fo);fA.observe("mouseleave",fq);if(fA.hasClassName("selected")){fz=fA}}$(document.body).observe("click",function(fE){if($(fE.target).up(".ul_select_menu")===fx){return}return fn(fx)})}if(!fz){fz=fD[0]}fz.addClassName("selected");fv=new Element("span");fw=fz.getDimensions();fv.setStyle({width:fw.width+"px",height:fw.height+"px",position:"relative",display:"inline-block"});return fx.wrap(fv)};fm=function(){var fz,fy,fw,fx,fv;fx=$$(".ul_select_menu");fv=[];for(fy=0,fw=fx.length;fy<fw;fy++){fz=fx[fy];fv.push(fr(fz))}return fv};bE(fm);return{init:function(fv){return fr(fv)},set_selected_by_value:fl}})();var H;H=D.DBCalendar=Class.create({initialize:function(fl,T){this.options=T||{};this.container=$(fl);cJ(this.container,"Couldn't find the element");this.today=new Date();if(this.options.disable_future){this.options.last_day=d5.start_of_day(this.options.last_day||this.today)}if(this.options.disable_past){this.options.first_day=d5.start_of_day(this.options.first_day||this.today)}this.view_date=d5.start_of_day(this.options.selected_date||this.today);this.selected_date=d5.start_of_day(this.options.selected_date||this.today);return this.render()},_change_month:function(fl,T){Event.stop(fl);this.view_date.setMonth(T);return this.render()},is_valid_date:function(fn,fp,fo,fm,T){var fl;fn=parseInt(fn,10);fp=parseInt(fp,10);fo=parseInt(fo,10);fm=parseInt(fm,10);T=parseInt(T,10);fm=fm||1970;T=T||(new Date()).getFullYear()+1;fp+=1;if(fo<fm){return false}if(fo>T){return false}if(fp<1||fp>12){return false}if(fn<=0){return false}if(fp===2){fl=((fo%4)===0)&&(((fo%100)!==0)||((fo%400)===0));if(fl){return fn<=29}else{return fn<=28}}else{if(fp===4||fp===6||fp===9||fp===11){return fn<=30}else{return fn<=31}}},change_date:function(T,fn,fl){var fm;if(!this.is_valid_date(T,fn,fl)){return}fm=fl!==this.view_date.getFullYear()||fn!==this.view_date.getMonth();this.selected_date=new Date(fl,fn,T);if(fm){this.view_date.setMonth(fn);this.view_date.setFullYear(fl);this.render()}else{bE(this.container).find(".selected").removeClass("selected");bE(this.container).find("a#day"+T+"-"+fn).addClass("selected")}if(this.options.onDateChange){return this.options.onDateChange(this.selected_date)}},render:function(){var fn,ft,fr,fp,fo,fl,fq,fm,fs,T;ft=this.render_days();fp=bE(".current-month",ft);fq=fp.first().data("date");fl=fp.last().data("date");T=fq<=this.options.first_day;fs=fl>=this.options.last_day;fn=new Element("div");fn.addClassName("calendar clearfix");if(!fs){this._next_month=(function(fu){return this._change_month(fu,this.view_date.getMonth()+1)}).bind(this);fo=new Element("a");fo.addClassName("changemonth next");fo.update(cv.make("web","arrowright",{}));Event.observe(fo,"click",this._next_month);fn.__sert(fo)}if(!T){this._prev_month=(function(fu){return this._change_month(fu,this.view_date.getMonth()-1)}).bind(this);fm=new Element("a");fm.addClassName("changemonth prev");fm.update(cv.make("web","arrowleft",{}));Event.observe(fm,"click",this._prev_month);fn.__sert(fm)}fr=new Element("h5");fr.update(eA("%(month)s %(year)s",{comment:"For example 'January 2010'. This is used as part of a calendar."}).format({month:b4.month_name(this.view_date.getMonth()),year:this.view_date.getFullYear()}));fn.__sert(fr);fn.__sert(ft);return this.container.__date(fn)},render_days:function(){var fr,fq,T,fp,fl,fo,fn,fm;fq=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);fn=fq.getDay();fr=new Element("div");fr.addClassName("days");for(T=fm=fn;fn<=0?fm<0:fm>0;T=fn<=0?++fm:--fm){fo=new Date(fq.getFullYear(),fq.getMonth(),fq.getDate());fo.setDate(fo.getDate()-T);fr.__sert(this.render_day(fo,true))}fp=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);while(fp.getMonth()===this.view_date.getMonth()){fr.__sert(this.render_day(fp));fp=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),fp.getDate()+1)}fl=new Date(this.view_date.getFullYear(),this.view_date.getMonth()+1,0);while(fl.getDay()!==6){fl=new Date(fl.getFullYear(),fl.getMonth(),fl.getDate()+1);fr.__sert(this.render_day(fl,true))}return fr},render_day:function(fl,fn){var T,fm;fm=!fn;if(this.options.last_day){fn=fn||fl>this.options.last_day}if(this.options.first_day){fn=fn||fl<this.options.first_day}T=new Element(fn?"span":"a");bE(T).data("date",fl);if(fm){T.addClassName("current-month")}T.update(fl.getDate());T.addClassName("date");T.writeAttribute("id","day"+fl.getDate()+"-"+fl.getMonth());if(this.selected_date.getDate()===fl.getDate()&&this.selected_date.getMonth()===fl.getMonth()&&this.selected_date.getFullYear()===fl.getFullYear()){T.addClassName("selected")}if(fn){T.addClassName("inactive")}else{this._handler=(function(fp){var fo;fo=fp.target.identify().substr(3).split("-");return this.change_date(fo[0],this.view_date.getMonth(),this.view_date.getFullYear())}).bind(this);Event.observe(T,"click",this._handler)}return T}});var aR;aR=D.DatePickerInput=Class.create({initialize:function(T,fm){var fp,fn,fo,fl;this.container=T;this.options={};Object.extend(this.options,fm||{});this.input=this.container.down(".input-date");this.display=this.container.down(".visible-date");fl=(this.input.value?d5.from_mysql_date(this.input.value):new Date());if(this.container.hasAttribute("data-first")){fo=d5.from_mysql_date(this.container.getAttribute("data-first"))}fp=this.options.disable_future!=null?this.options.disable_future:true;fn=this.options.disable_past!=null?this.options.disable_past:true;this.cal_container=this.container.down(".cal-container");this.calendar=new H(this.cal_container,{onDateChange:this.onDateChange.bind(this),first_day:fo,disable_future:fp,disable_past:fn,selected_date:fl});this.container.observe("click",this.show_cal.bindAsEventListener(this));$(document.body).observe("click",this.hide_cal.bind(this));return this.onDateChange(fl)},show_cal:function(fl){var T;if(fl){Event.stop(fl)}T=$(fl.target);if(T.match(".cal-container")||T.up(".cal-container")){return}bE(".cal-container").hide();return this.cal_container.show()},hide_cal:function(){return this.cal_container.hide()},onDateChange:function(T){this.input.value=d5.to_mysql_date(T,false);this.display.update(N.localize(T));return this.hide_cal()}});var fh;fh=D.TextInputDatePicker=Class.create({initialize:function(fn,fm){var fp,fo,fl,T;this.options={include_seconds:true,include_microseconds:true,choose_eod:false};Object.extend(this.options,fm||{});this.input=$(fn);cJ(this.input,"Couldn't find the element "+fn.toString());fl=new Date();T=(this.input.value?d5.from_mysql_date(this.input.value):false);fo=new Date(fl.getUTCFullYear(),fl.getUTCMonth(),fl.getUTCDate());this.cal_icon=cv.make("web","calendar_view_month",{align:"absmiddle"});this.cal_container=new Element("div",{id:"cal_container_"+fn,style:"display: none; position: absolute; z-index: 1"});this.calendar=new H(this.cal_container,{onDateChange:this.onDateChange.bind(this),last_day:fo,selected_date:T});this.input.__sert({after:this.cal_icon});this.cal_icon.observe("click",this.toggle_cal.bindAsEventListener(this));fp=bE(this.input);bE(this.cal_container).clonePosition(fp,{setWidth:false,setHeight:false,offsetTop:fp[0].offsetHeight});return this.cal_icon.__sert({after:this.cal_container})},toggle_cal:function(T){if(T){Event.stop(T)}return this.cal_container.toggle()},hide_cal:function(T){if(T){Event.stop(T)}return this.cal_container.hide()},onDateChange:function(T){if(this.options.choose_eod){T.setTime(d5.start_of_day(T).getTime()+86399999)}this.input.value=d5.to_mysql_date(T,this.options.include_seconds,this.options.include_microseconds);return this.hide_cal()}});ak.window_load(U.register.bind(U));bE(ch.init.bind(ch));bE(c4.register_all.bind(c4));Event.observe(window,"scroll",function(){return bo.hide_all()});bE(function(){aa.interval=setInterval(aa.check.bind(aa),500);dN.init();return bo.init()});var aU;aU=D.LocaleSelector={init:function(){bE(document).on("click",".modal-locale-link",(function(T){return function(fl){fl.preventDefault();return T.show()}})(this));return bE(document).on("click",".modal-team-locale-link",(function(T){return function(fl){fl.preventDefault();return T.show_team_modal()}})(this))},show:function(){if(!this.modal){this.modal=new e6({element_id:"locale-selector-modal"})}return this.modal.show()},show_team_modal:function(){if(!this.team_modal){this.team_modal=new bm({element_id:"locale-selector-modal"})}return this.team_modal.show()}};bE(function(){return aU.init()});var bf,au={}.hasOwnProperty,cN=function(fn,fl){for(var T in fl){if(au.call(fl,T)){fn[T]=fl[T]}}function fm(){this.constructor=fn}fm.prototype=fl.prototype;fn.prototype=new fm();fn.__super__=fl.prototype;return fn};bf=INLINE_JS.ChangeNameModal=D.ChangeNameModal=(function(T){cN(fl,T);function fl(){fl.__super__.constructor.call(this,{element_id:"change-name-modal"});this.on_confirm_button_click=(function(fm){return function(fq){var fp,fn,fo;fq.preventDefault();fp=bE(fq.target);fn=fp.closest("form");fo=function(){fm.hide();return location.reload()};return bT.ajax_submit(fn[0],false,fo,null,fp[0])}})(this)}return fl})(d7);var bW,eu,du=function(T,fl){return function(){return T.apply(fl,arguments)}},au={}.hasOwnProperty,cN=function(fn,fl){for(var T in fl){if(au.call(fl,T)){fn[T]=fl[T]}}function fm(){this.constructor=fn}fm.prototype=fl.prototype;fn.prototype=new fm();fn.__super__=fl.prototype;return fn};eu=D.ManageAliasModal=(function(fl){cN(T,fl);function T(fm){this.options=fm;this._poll_until_verified=du(this._poll_until_verified,this);this._get_params_from_target=du(this._get_params_from_target,this);this._on_load=du(this._on_load,this);this._show_action_panel=du(this._show_action_panel,this);this._input_enter_handler=du(this._input_enter_handler,this);this.resend_verify=du(this.resend_verify,this);this.remove_alias=du(this.remove_alias,this);this.add_alias=du(this.add_alias,this);this.refresh_alias=du(this.refresh_alias,this);this.on_show=du(this.on_show,this);T.__super__.constructor.call(this,this.options)}T.prototype.before_show=function(fm){T.__super__.before_show.call(this,fm);this.polling=0;fm.find(".alias-action").on("click",this._show_action_panel);fm.find(".alias-action-submit").on("click",this.add_alias);fm.find("form").submit(function(){return false});return fm.find(".alias-action-inputs input").on("keyup",this._input_enter_handler)};T.prototype.on_show=function(){return this.refresh_alias(true,this._poll_until_verified)};T.prototype.refresh_alias=function(fn,fm){if(fn==null){fn=true}if(fn){bT.clear_errors()}return new Ajax.DBRequest("/account/alias/get",{subject_user:this.options.subject_user,onSuccess:(function(fo){return function(fp){fo.$modal_window.find(".dynamic-content").html(fp.responseText);fo._on_load(fp);if(typeof fm==="function"){return fm()}}})(this),onFailure:(function(fo){return function(fp){return fo.hide()}})(this)})};T.prototype.add_alias=function(fp){var fo,fm,fn,fq;fp.preventDefault();fm=bE(fp.currentTarget).closest("form");fo=fm.find(".alias-action-submit");fq={};fq[Constants.UID_PARAM_NAME]=this.options.subject_user.id;fn=(function(fr){return function(){var fs;fr.$modal_window.find(".alias-action-inputs input").val("");fr.polling=0;fs=fr.polling?null:fr._poll_until_verified;return fr.refresh_alias(true,fs)}})(this);return bT.ajax_submit(fm[0],false,fn,false,fo[0],fq,"before")};T.prototype.remove_alias=function(fm){var fn;fm.preventDefault();fn=this._get_params_from_target(fm.currentTarget);return new Ajax.DBRequest("/account/alias/remove",{subject_user:this.options.subject_user,parameters:fn,onSuccess:(function(fo){return function(fp){return fo.refresh_alias()}})(this)})};T.prototype.resend_verify=function(fm){var fn;fm.preventDefault();fn=this._get_params_from_target(fm.currentTarget);return new Ajax.DBRequest("/account/alias/send_verify",{subject_user:this.options.subject_user,parameters:fn,onSuccess:(function(fo){return function(fp){return fo.refresh_alias()}})(this)})};T.prototype._input_enter_handler=function(fm){fm.preventDefault();fm.stopPropagation();if(fm.which===13){return this.add_alias(fm)}};T.prototype._show_action_panel=function(fo){var fn,fm;fo.preventDefault();fm=bE(fo.currentTarget).data("target");this.$modal_window.find(".alias-action-panel").hide();fn=this.$modal_window.find("#"+fm).show();return fn.find("input:visible:enabled:first").focus()};T.prototype._on_load=function(fm){be.register_all();this.$dynamic=this.$modal_window.find("#alias-list-container");this.$dynamic.on("click",".alias-remove",(function(fn){return function(fo){return fn.remove_alias(fo)}})(this));return this.$dynamic.on("click",".alias-verify",(function(fn){return function(fo){return fn.resend_verify(fo)}})(this))};T.prototype._get_params_from_target=function(fo){var fm,fn,fp;fm=bE(fo);fp=fm.data("alias-type");fn=fm.closest(".alias-row").find(".alias-text").text();return{alias:fn,alias_type:fp}};T.prototype._poll_until_verified=function(){var fo,fp,fn,fm;fp=5;fo=60;fn=(function(fq){return function(){return fq.refresh_alias(false,fq._poll_until_verified)}})(this);fm=this.$dynamic.find(".alias-verify").length;if(fm&&this.polling<fo){this.polling++;return setTimeout(fn,fp*1000)}else{return this.polling=0}};return T})(d7);bW=INLINE_JS.AliasManager=D.AliasManager={show:function(fo){var fm,fn,fl,T;T=cK.get_viewer().get_user_by_role(fo);if(T==null){return}if(!T.is_email_verified){if(fo===Constants.ROLE_PERSONAL){personal_email_verification.verified_or_show()}else{work_email_verification.verified_or_show()}return}fl=cK.get_viewer().is_paired?fo:"";fn=eA("Manage your %(role_show)s contact methods").format({role_show:fl});fm=new eu({element_id:"manage-alias",title:fn,subject_user:T,role:T.role});fm.show()}};var dw;dw=INLINE_JS.BonusTable=D.BonusTable={_tmpl:null,_inited:null,_next_page:0,_fetching_page:false,init:function(T){this.user_id=T;if(dw._inited){return}dw._inited=true;$("bonus-loading").show();dw._tmpl=fg.tmpl("bonus_row_tmpl");dw.listen();return dw.get_next_page()},_render:function(fn){var fl,fo,fm,T;fl=[];for(fm=0,T=fn.length;fm<T;fm++){fo=fn[fm];fl.push(dw._tmpl({row:fo,Sprite:cv}))}return $("bonus-table").__sert(fl)},get_next_page:function(){if(dw._fetching_page){return}dw._fetching_page=true;return new Ajax.DBRequest("/account/bonus_page/"+dw._next_page,{onSuccess:function(fl){var fn,T,fm;fn=fl.responseText.evalJSON();fm=fn.rows;T=fn.has_more;dw._render(fm);$("bonus-loading").hide();if(T){dw._next_page+=1;$("load-more-bonus").show()}else{$("load-more-bonus").hide()}return dw._fetching_page=false},subject_user:this.user_id})},_max_referral_over:function(fl){var T,fn,fm;fn=bE(fl.currentTarget);fm=eA("You've earned the maximum amount of referral space. Thanks for inviting people to Dropbox!");T=bE(eo.make(fm,"right","middle"));Element.absolutize(T[0]);fn.append(T);T.clonePosition(fn,{setWidth:false,setHeight:false});return T.css({width:"200px",left:(parseInt(T.css("left"),10)-210)+"px",top:(parseInt(T.css("top"),10)-55)+"px"})},_max_referral_out:function(fp){var T,fo,fm,fn,fl;fn=bE(".reached-max-referral-bonus .bubble");fl=[];for(fo=0,fm=fn.length;fo<fm;fo++){T=fn[fo];fl.push(T.remove())}return fl},listen:function(){bE("#load-more-bonus").on("click",dw.get_next_page.bind(dw));bE(document).on("mouseenter",".reached-max-referral-bonus",dw._max_referral_over);return bE(document).on("mouseleave",".reached-max-referral-bonus",dw._max_referral_out)},toggle:function(){if(bE("#bonus-list").is(":visible")){this.hide();return bE("#space-earned-link").text(eA("View all space earned"))}else{this.show();return bE("#space-earned-link").text(eA("Hide space earned"))}},show:function(){return bE("#bonus-list").slideDown(150)},hide:function(){return bE("#bonus-list").slideUp(150)}};var C,u,c;C=INLINE_JS.DowngradeReasons=D.DowngradeReasons={reasons:{},addReason:function(T){return this.reasons[T]=true},addReasons:function(T){var fn,fo,fm,fl;fl=[];for(fo=0,fm=T.length;fo<fm;fo++){fn=T[fo];fl.push(this.addReason(fn))}return fl},change:function(fp,fm,T){var fq,fs,fr,fn,fl,fo;fp=parseInt(fp,10);fs=$(fm);cJ(fs,"Couldn't find container for DowngradeReason");fq=false;fo=this.reasons;for(fn in fo){fr=fo[fn];fl=$(T+fn);cJ(fl,"Couldn't find container for ",T+fn);if(fr&&parseInt(fn,10)===fp){fl.show();fq=true}else{fl.hide()}}if(fq){return fs.show()}else{return fs.hide()}}};u=D.DowngradeReasons2={init:function(){var fl,fn,T,fm;fm=["input[name=downgrade_reason_id]","input[name=other_reason_id]"];for(fn=0,T=fm.length;fn<T;fn++){fl=fm[fn];bE(fl).change(function(fp){var fo;fo=fp.target.id.indexOf("other")>=0;return u.change(fo,fp.target.getValue())})}return bE(".shared-additional-info").attr("name","shared_additional_info")},change:function(fm,T){var fl;bE(".downgrade-other-reason .error-message").hide();if(fm){return}fl="#downgrade-info-"+T;bE(".downgrade-info").hide();bE(fl).show();bE(".downgrade-info textarea").removeAttr("name");bE(fl+" textarea").attr("name","additional_info");return bE("input[name=other_reason_id]").removeAttr("checked")}};c=D.DowngradeSurvey={init:function(){var T;T="#downgrade-survey-form";return bE(""+T).on("submit",(function(fl){return function(fo){var fn,fm;fm=bE(""+T+" input[name=other_reason_id]:checked").length;fn=bE(""+T+" input[id=downgrade-radio-8]");if(fn.is(":checked")&&fm===0){bE(".downgrade-other-reason .error-message").show();return fo.preventDefault()}}})(this))}};var ca;ca=INLINE_JS.GetSpace=D.GetSpace={_current_space:null,_why_msg:null,_twitter_url:null,offer_highlight_color:"#ffa",init:function(fm,fl,fn){var T;ca._current_space=fm;ca._why_msg=fl;ca._twitter_url=fn;$("space-actions").on("click",".space-action",ca.perform_action);T=F.parse(window.location.href).fragment;if(T){return ca.highlight_offer(T)}},highlight_offer:function(fl){var T,fm;T=bE("#"+fl);fm=T.css("background-color");return T.css("background-color",ca.offer_highlight_color).delay(2000).animate({"background-color":fm}).queue(function(){return T.css("background-color","")})},perform_action:function(fl){var fm,T;T={contact_sales:ca._contact_sales,contact_support:ca._contact_support,teams:ca._teams,upgrade:ca._upgrade,plans:ca._plans,refer:ca._refer,get_started:ca._get_started,fb_link:ca._fb_link,twitter_link:ca._twitter_link,twitter_follow:ca._twitter_follow,why_like:ca._why_like,mailbox_link:ca._mailbox_link};fm=$(fl.target);if(!fm.hasClassName("space-action")){fm=fm.up(".space-action")}return T[fm.id]()},_teams:function(){return window.location.href="/business?tk=dropbox&ag=getspace&ad=v1"},_contact_sales:function(){return window.location.href="mailto:sales@dropbox.com"},_contact_support:function(){return window.location.href="/support"},_plans:function(){return window.location.href="/plans"},_upgrade:function(){return window.location.href="/upgrade"},_refer:function(){return window.location.href="/referrals"},_get_started:function(){return window.location.href="/gs"},_fb_link:function(){return es.do_auth(function(){ca._refresh_link_bonuses();return ca._completed($("fb_link"))},cK.get_viewer().personal_user.id)},_twitter_link:function(){return cD.do_auth(function(){ca._refresh_link_bonuses();cD.set_is_authed(cK.get_viewer().personal_user.id,true);return ca._completed($("twitter_link"))},cK.get_viewer().personal_user.id)},_twitter_follow:function(){if(cD.is_authed(cK.get_viewer().personal_user.id)){return ca.follow_dropbox()}else{return cD.do_auth(ca.follow_dropbox,cK.get_viewer().personal_user.id)}},_why_like:function(){fc.show(eA("Tell us why you love Dropbox"),$("why-i-like-modal"));$("why-i-like-input").focus();return d5._track_twitter_chars_left("why-i-like-input",90)},_mailbox_link:function(){return window.location.href="http://www.mailboxapp.com/"},follow_dropbox:function(){if(!cD.is_authed(cK.get_viewer().personal_user.id)){ca._refresh_link_bonuses();cD.set_is_authed(cK.get_viewer().personal_user.id,true)}return cD.follow_dropbox({showWorking:function(){return $("twitter_follow").down(".title").__date(eA("Following Dropbox on Twitter..."))},onFailure:function(){return $("twitter_follow").down(".title").__date(eA("Follow Dropbox on Twitter"))},onSuccess:function(){if($("twitter_link")&&$("twitter_link").visible()){ca._completed($("twitter_link"))}return ca._completed($("twitter_follow"))}},cK.get_viewer().personal_user.id)},submit_why:function(){ca._why_msg=$F("why-i-like-input");return bT.ajax_submit($("why-i-like-form"),false,(function(){fc.hide();return ca._completed($("why_like"))}),false,$("why-i-like-submit"))},_completed:function(fl){var T;fl.addClassName("completed");fl.down(".icon-col").__date(cv.make("web","check_36"));bE(fl).css("opacity",0.5).fadeTo(500,1);setTimeout((function(){return bE(fl).css("opacity",1).slideUp().animate({opacity:0},{queue:false,duration:"normal"})}),1500);T=parseInt(fl.down(".space").readAttribute("data-space"),10);ca._current_space+=T;$("current-space").__date(aD.format_bytes(ca._current_space));$("current-space").addClassName("updated");return setTimeout((function(){return $("current-space").removeClassName("updated")}),5000)},_refresh_link_bonuses:function(){return new Ajax.DBRequest("/social_recheck")}};var bz;bz=D.Help={toggle_more_help:false,show_os:function(fl,fm,T){fm=$(fm);$$(".os-filter").invoke("removeClassName","selected");fm.addClassName("selected");$$(".help-os-section").invoke("hide");$$(".help-os-"+T).invoke("show");return Event.stop(fl)},vote:function(T,fl){new Ajax.DBRequest("/help/"+T+"/vote/"+fl);bE("#help-vote-cont").fadeOut();return ae.success(eA("Thanks for your feedback!"))}};var ex,dU,ad,t,du=function(T,fl){return function(){return T.apply(fl,arguments)}},au={}.hasOwnProperty,cN=function(fn,fl){for(var T in fl){if(au.call(fl,T)){fn[T]=fl[T]}}function fm(){this.constructor=fn}fm.prototype=fl.prototype;fn.prototype=new fm();fn.__super__=fl.prototype;return fn};dU=INLINE_JS.Hosts=D.Hosts={attach_host_listener:function(fo,fm){var fl,fn,fp,T;fl=bE("#"+fo);fp=fl.data("host-ids");fn=fl.data("display-name");T=function(){return new ad(fp,fn,fm,null,null).show()};bE(".unlink-host-link",fl).on("click",T);return fl.on("dblclick",(function(){return dU.edit(fp,fo)}))},edit:function(fp,fm){var fl,fq,fr,fo,fn,T;fr=bE("#"+fm+" .host-item .sprite-text");if(fr.data("editing")==="true"){return false}fr.data("editing","true");fq=fr.text();fr.data("previous",fq);fp=bx.values(fp);fo=bE('<input type="text" class="name-input skinny-input" size="20" maxlength="256" style="word-wrap: break-word;" />').val(fq);T=bE('<input type="button" class="button">').val(eA("Save"));T.on("click",function(){return dU.doneEditing(fp,fm)});fl=bE('<input type="button" class="button grayed">').val(eA("Cancel"));fl.on("click",function(){return dU.cancelEditing(fm)});fr.empty();fr.append(fo,"&nbsp;",T,"&nbsp;",fl);fn=bE("input",fr);fn.on("keydown",function(){return dU.checkKey(fp,fm)});fn.focus();return false},doneEditing:function(fm,fl){var fn,T;fn=bE("#"+fl+" .host-item .sprite-text");T=bE("input",fn).val();return bE.ajax({url:"/account/change_host_name",data:{host_ids:JSON.stringify(fm),name:T},type:"POST"}).success(function(fo){return dU.unedit(fn,JSON.parse(fo).display_name)})},cancelEditing:function(T){var fl;fl=bE("#"+T+" .host-item .sprite-text");return dU.unedit(fl,fl.data("previous"))},unedit:function(fl,T){fl.data("editing","false");return fl.text(T)},dismiss:function(fm,fl,fn,T,fo){new bE.ajax("/account/dismiss_unlink",{type:"POST",data:{host_id:fm,user_id:fl,team_id:fn},subject_user:fo,success:function(fp){return T.remove()}});return false},checkKey:function(fl,T){return function(fm){fm=fm||window.event;if(fm.keyCode===Event.KEY_RETURN){dU.doneEditing(fl,T)}if(fm.keyCode===Event.KEY_ESC){return dU.cancelEditing(T)}}},show_device_unlink_modal:function(fl,fm,T,fr,fo,fn){var fq,fp;fq=bE("#unlink-device-modal-"+fo);fp={both:bx.values(fr),personal:[fr[Constants.ROLE_PERSONAL]],work:[fr[Constants.ROLE_WORK]]};fc.show(T,fq[0]);if(bx.values(fr).length>1){fq.addClass("show-selector")}return bE("form input[type=submit]",fq).on("click",function(fs){fs.preventDefault();fr=fp[bE(".unlink-select select",fq).val()];bT.add_vars(bE("form",fq)[0],{user_ids:JSON.stringify(fr),app_id:fm,device_id:JSON.stringify(fl),device_name:fn});return bE("form",fq).submit()})}};ex=D.DeleteFailuresModal=(function(T){cN(fl,T);function fl(){this.on_show=du(this.on_show,this);this.on_confirm_button_click=du(this.on_confirm_button_click,this);return fl.__super__.constructor.apply(this,arguments)}fl.prototype.on_confirm_button_click=function(fm){fm.preventDefault();window.location.href="/delete_failures?host_id="+this.host_id;return this.hide()};fl.prototype.on_show=function(fn){var fm;fm=bc("Dropbox couldn't delete %(num_failures)d file from the computer <strong>%(host_name)s</strong>. You can download the name of this file and the reason why it couldn't be deleted.","Dropbox couldn't delete %(num_failures)d files from the computer <strong>%(host_name)s</strong>. You can download the names of these files and the reasons why they couldn't be deleted.",this.num_failures).format({host_name:this.name.escapeHTML(),num_failures:this.num_failures});return this.$modal_window.find(".failures_message").html(fm)};return fl})(d7);t=INLINE_JS.show_delete_failures_modal=D.show_delete_failures_modal=function(fm,fl,T){var fn;fn=new ex({element_id:"delete-failures-modal"});fn.host_id=fm;fn.name=fl;fn.num_failures=T;fn.show();return false};ad=INLINE_JS.UnlinkHostModal=D.UnlinkHostModal=(function(fl){cN(T,fl);function T(fq,fo,fm,fn,fp){this.host_ids=fq;this.name=fo;this.delete_support_type=fm;this.owner_id=fn;this.team_id=fp;this.on_show=du(this.on_show,this);this._set_delete_text=du(this._set_delete_text,this);this.fail_callback=du(this.fail_callback,this);this.success_callback=du(this.success_callback,this);this.on_confirm_button_click=du(this.on_confirm_button_click,this);T.__super__.constructor.call(this,{element_id:"unlink-host-modal"});this.show_host_selector=bx(this.host_ids).values().length>1}T.prototype.on_confirm_button_click=function(fp){var fn,fo,fm;fp.preventDefault();fo=this.$modal_window.find(".unlink_host_form")[0];fn=$(this.$modal_window.find(".confirm-button")[0]);this.$modal_window.find("[type=button]").attr("disabled","");fm={host_ids:JSON.stringify(this.get_selected_hosts())};return bT.ajax_submit(fo,false,this.success_callback,this.fail_callback,fn,fm)};T.prototype.success_callback=function(){return window.location.reload()};T.prototype.fail_callback=function(){return this.$modal_window.find("[type=button]").removeAttr("disabled")};T.prototype._set_delete_text=function(fm){return this.$modal_window.find(".delete_data_label").text(fm)};T.prototype._get_unlink_select=function(){return this.$modal_window.find(".unlink-select select").val()};T.prototype._clear_delete_checkbox=function(){return this.$modal_window.find(".delete_data").prop("checked",false)};T.prototype.on_show=function(fn){var fm;this._clear_delete_checkbox();if(this.delete_support_type===Constants.DELETE_ON_UNLINK_OLD_CLIENT){this.$modal_window.find(".unlink_host_modal_content").addClass("show_old_client_modal")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_UNSUPPORTED){this.$modal_window.find(".unlink_host_modal_content .unlink_host_form").addClass("hidden")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_TEAM_ONLY){this.$modal_window.find(".unlink-choice").change((function(fo){return function(fp){if(fo._get_unlink_select()===Constants.ROLE_PERSONAL){return fo.$modal_window.find(".new_client").hide()}else{return fo.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(eA("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cK.get_viewer().team_name}))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_PERSONAL_ONLY){this.$modal_window.find(".unlink-choice").change((function(fo){return function(fp){if(fo._get_unlink_select()===Constants.ROLE_WORK){return fo.$modal_window.find(".new_client").hide()}else{return fo.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(eA("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED){this._set_delete_text(eA("Delete files from these Dropboxes the next time this computer comes online."));this.$modal_window.find(".unlink-choice").change((function(fo){return function(fp){if(fo._get_unlink_select()===Constants.ROLE_PERSONAL){return fo._set_delete_text(eA("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(fo._get_unlink_select()===Constants.ROLE_WORK){return fo._set_delete_text(eA("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cK.get_viewer().team_name}))}else{return fo._set_delete_text(eA("Delete files from these Dropboxes the next time this computer comes online."))}}}})(this))}}}}}if(this.show_host_selector){fm="<span class='host_name'></span>";this.$modal_window.find(".unlink-select").removeClass("hidden");this.$modal_window.find(".unlink-modal-text").html(eA("Which Dropboxes do you want to unlink from %(host_name)s? Any Dropbox you unlink will immediately stop syncing.").format({host_name:fm}))}this.$modal_window.find("[name=host_id]").attr("value",this.host_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=user_id]").attr("value",this.owner_id);return this.$modal_window.find(".host_name").text(this.name)};T.prototype.get_selected_hosts=function(){var fm;if(bx.values(this.host_ids).length===1){return bx.values(this.host_ids)}fm=bE(".unlink-choice").val();if(fm==="both"){return bx.values(this.host_ids)}else{return[this.host_ids[fm]]}};return T})(d7);var eM;eM=D.News={DEFAULT_TAB:"recent-news",init:function(){$("news-home").on("click","#nav a",function(fl,fm){var T;if(fm.hasAttribute("data-div")){fl.preventDefault();T=fm.readAttribute("data-div");return eD.push_state("/news/"+T)}});return eD.add_callback("/news",eM.history_change)},change_tab:function(T){var fl;fl=$$("#nav a[data-div="+T+"]").first();if($(fl)){$$(".section").invoke("removeClassName","selected");$$("#nav a").invoke("removeClassName","selected");$(fl).addClassName("selected");return $(T).addClassName("selected")}},history_change:function(T){T=T||eM.DEFAULT_TAB;return eM.change_tab(T)}};var dH;dH=D.Recover={init:function(){var T;T=$("recover-form");return T.observe("submit",this.form_submit.bind(this))},form_submit:function(T){this.clear_error();T.preventDefault();return bT.ajax_submit($("recover-form"),null,this.submit_response.bind(this))},submit_response:function(fl){var T;T=JSON.parse(fl.responseText);if(T.status==="error"){this.show_error(T.msg)}if(T.status==="ok"){this.show_hosts(T)}if(T.status==="redirect"){return window.location.href=T.url}},show_hosts:function(fr){var fo,fm,fn,T,fq,fl,fp;bT.add_vars($("recover-form"),{check_file:"true"});$("filename-to-create").update(fr.filename);fm=$("trusted-hosts");fm.update();fp=fr.hosts;for(fq=0,fl=fp.length;fq<fl;fq++){fo=fp[fq];T=new Element("li");fn="lnx";if(fo.platform==="mac"){fn="osx"}if(fo.platform==="win"){fn="win"}T.__sert(cv.make("web",fn));T.__sert(new fg(fo.display_name.escapeHTML()));fm.appendChild(T)}$("login-step").hide();return $("hosts-step").show()},show_error:function(T){$("error-messages").update(T);return $("error-messages").show()},clear_error:function(){return $("error-messages").update()}};var dm;dm=D.Restore={next:function(T,fn){var fm,fl;fl=bE("ul.selected");fm=fl.next("ul");fm.addClass("selected");fl.removeClass("selected");if(fm.next("ul").length){bE("#next-page").show()}else{bE("#next-page").hide()}bE("#prev-page").show();return dm.inc_page(1)},prev:function(T,fn){var fm,fl;fl=bE("ul.selected");fm=fl.prev("ul");fm.addClass("selected");fl.removeClass("selected");if(fm.prev("ul").length){bE("#prev-page").show()}else{bE("#prev-page").hide()}bE("#next-page").show();return dm.inc_page(-1)},inc_page:function(fm){var fl,T;fl=parseInt(bE("#page_num").text(),10);T=fl+fm;return bE("#page_num").text(T)},init:function(fn,T,fl){var fm;fm=cK.get_viewer().get_user_by_id(fl);bE("#next-page").on("click",function(fo){dm.next(fo);return false});bE("#prev-page").on("click",function(fo){dm.prev(fo);return false});bE("#restore-submit-button").on("click",function(fo){dC.do_folder_restore(fn,fm);return false});bE("#restore-cancel-button").on("click",function(fo){return b1.redirect(T)});return bE("#restore-back-button").on("click",function(fo){return b1.redirect(T)})}};var ce,dx,cF,aQ,du=function(T,fl){return function(){return T.apply(fl,arguments)}},au={}.hasOwnProperty,cN=function(fn,fl){for(var T in fl){if(au.call(fl,T)){fn[T]=fl[T]}}function fm(){this.constructor=fn}fm.prototype=fl.prototype;fn.prototype=new fm();fn.__super__=fl.prototype;return fn};ce=D.SelectRoleModal=(function(T){cN(fl,T);function fl(){this.on_show=du(this.on_show,this);return fl.__super__.constructor.apply(this,arguments)}fl.prototype.on_select_role=null;fl.prototype.on_show=function(){return bE(".role-options li").click((function(fm){return function(fo){var fn,fp;fn=bE(fo.target).closest("li");fp=fn.data("role");cJ(fm.on_select_role,"missing on_select_role implementation");fm.on_select_role(fp);return fm.hide()}})(this))};return fl})(d7);cF=D.SharedFolderSelectRoleModal=(function(T){cN(fl,T);function fl(){return fl.__super__.constructor.apply(this,arguments)}fl.prototype.on_select_role=function(fn){var fm;fm=function(){bZ.role_picker.ensure_role_is_visible(fn);dE.set_role(fn);return r.start_wizard_for_user(cK.get_viewer().get_user_by_role(fn))};if(fn===bO.logged_out_role){return bO.show_modal({role:fn,on_success:fm})}else{return fm()}};return fl})(ce);aQ=D.ShmodelC2DSelectRoleModal=(function(T){cN(fl,T);function fl(){return fl.__super__.constructor.apply(this,arguments)}fl.prototype.on_select_role=function(fn){var fm;fm=function(){return aj.show_c2d_modal(fn)};if(!cK.get_viewer().is_role_signed_in(fn)){return bO.show_modal({role:fn,on_success:fm})}else{return fm()}};return fl})(ce);dx=D.ShareShmodelSelectRoleModal=(function(T){cN(fl,T);function fl(){this.on_select_role=du(this.on_select_role,this);return fl.__super__.constructor.apply(this,arguments)}fl.prototype.on_select_role=function(fm){return aj.prompt_login_then_share(this.options.link_url,this.options.short_url,this.options.tokenizer_type,fm)};return fl})(ce);var cP;cP=D.TabController=Class.create({initialize:function(fm,fl){var T;T=$(fm);cJ(T,fm+" is missing.");this.container=T;this.options={killEvent:true};Object.extend(this.options,fl);return this.listen()},listen:function(){var fp,fm,fo,fl,fn,T;fm=this;fn=this.container.select("a");T=[];for(fo=0,fl=fn.length;fo<fl;fo++){fp=fn[fo];cJ(fp.id&&fp.id.length>0,"Element is missing an id");T.push(fp.observe("click",(function(fq){return this.click(fq)}).bindAsEventListener(fm)))}return T},click:function(T){if(this.options.killEvent){Event.stop(T)}return this.toggle($(T.target))},toggle:function(fl){var fo,T,fn,fp,fm;fm=this.container.down("a.selected");if(fm){fp=$(fm.id+"-content");if(fp){fp.hide()}}this.container.select(".selected").invoke("removeClassName","selected");T=false;if(!fl){fl=this.container.down("a");T=true}fl.addClassName("selected");fo=$(fl.id+"-content");if(fo){fo.show()}if(this.options.onTabChange){this.options.onTabChange(fl,fm)}if(this.options.url_prefix){fn=this.options.url_prefix;if(!T){fn+="/"+fl.id}return eD.push_state(fn)}}});var dP;dP=D.InviteForm={initialized:false,init:function(){if(this.initialized){return}return bE((function(T){return function(){T.add_auto_completer=new Autocompleter.ContactsTokenizer(cK.get_viewer().get_user_by_role(Constants.ROLE_WORK),"team-invite-new-collab-input","team-invite-new-whobulk","team-invite-hidden-input",{tokens:[",",";"],hide_import_contacts:true,suggestions_disabled:true,contact_filter:function(fl){return fl.excludeTeamMembers().excludeFacebook().excludeGroups().excludeNewStyleGroups().excludeRooms().excludeMe()}});T.add_auto_completer.clearTokens();T.tokenAdd=bE.proxy(T._tokenAdd,T);T.tokenRemove=bE.proxy(T._tokenRemove,T);bE("#team-invite-new-collab-input")[0].on("token:add",T.tokenAdd);bE("#team-invite-new-collab-input")[0].on("token:remove",T.tokenRemove);T.reset_licenses();T.update_free_licenses_message();T.initialized=true;T.setup_tab_support(bE);return ch.init()}})(this))},set_emails:function(T){if(T==null){return}return bE((function(fl){return function(){var fo,fq,fp,fn,fm;fl.init();fm=[];for(fp=0,fn=T.length;fp<fn;fp++){fo=T[fp];fq=fl.add_auto_completer.createTokenInfo(null,fo,V.EMAIL);fm.push(fl.add_auto_completer.addContact(fq))}return fm}})(this))},rebind_modal_submit_autocompleter:function(){var T,fl;T=this.invite_modal.$modal_window;fl=T.find(".tokenizer-submit-button");fl.on("mousedown",(function(fm){return function(){return fm.add_auto_completer.beforeSubmit()}})(this));return this.setup_tab_support(T)},setup_tab_support:function(T){return T.find("#team-invite-new-collab-input").first().on("keyup change",function(){var fl;fl=T.find(".new-collab-input").first();if(fl.val()!==""){return fl.attr("tabindex",-1)}else{return fl.removeAttr("tabindex")}})},reset_modal_licenses:function(){var fl,fm,T;fl=__CIRCULAR_DEPENDENCY__.Dashboard!=null?__CIRCULAR_DEPENDENCY__.Dashboard.get_licensed_members():__CIRCULAR_DEPENDENCY__.MembersReact!=null?__CIRCULAR_DEPENDENCY__.MembersReact.get_licensed_members():window.active_team_member_table.get_licensed_members();this.total_licenses=(fm=(T=__CIRCULAR_DEPENDENCY__.MembersReact)!=null?typeof T.get_total_licenses==="function"?T.get_total_licenses():void 0:void 0)!=null?fm:this.total_licenses;this.update_used_licenses(fl);this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},reset_licenses:function(){this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},get_new_users:function(){return this.new_users},_tokenAdd:function(T){this.available_licenses--;bE(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users++},_tokenRemove:function(T){this.available_licenses++;bE(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users--},already_invited_user:function(fl){var fm,T,fn;if(window.active_team_member_table){fn=window.active_team_member_table.data.users;for(T in fn){fm=fn[T];if(fm.email===fl){return true}}}},update_license_count:function(){var T,fl;T=bE("#license-count-message");if(this.available_licenses<0){fl=eA("You need more licenses for this invitation.");T.addClass("over")}else{if(this.available_licenses===0){fl=eA("You have no remaining licenses.");T.removeClass("over")}else{if(this.available_licenses>0){fl=bc("You have %(invites)d remaining license.","You have %(invites)d remaining licenses.",this.available_licenses).format({invites:this.available_licenses});T.removeClass("over")}else{fl="You have \u00a0 remaining licenses."}}}return T.text(fl)},init_modal_licenses:function(fm,fl,T){if(!this.invite_modal){this.invite_modal=new v(T)}this.total_licenses=fm;this.is_trial=fl;return bE("body").trigger("invite-modal-initialized")},update_used_licenses:function(T){this.used_licenses=T;return this.reset_licenses()},init_form_licenses:function(fm,T,fl){this.total_licenses=fm;this.used_licenses=T;this.is_trial=fl;return dP.reset_licenses()},add_total_licenses:function(T){T=T||0;if(T>0){this.total_licenses+=T;this.available_licenses+=T;this.update_license_count();if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){return __CIRCULAR_DEPENDENCY__.Dashboard.add_licenses(T)}}},on_add_licenses_exit:function(fl,T){var fm;if((fm=this.invite_modal)!=null?fm.$modal_window:void 0){this.rebind_modal_submit_autocompleter()}return this.add_total_licenses(T)},reset_modal:function(){var T;T=this.invite_modal.$modal_window;c4.reset(T.find("#team-invite-message")[0]);if(this.add_auto_completer){this.add_auto_completer.clearTokens()}this.reset_modal_licenses();return T.find(".new-collab-input").val("")},on_add_licenses_click:function(fl){var T;fl.preventDefault();if(this.is_trial){if((T=this.invite_modal)!=null){T.hide()}return __CIRCULAR_DEPENDENCY__.add_more_licenses_to_trial()}else{if(this.add_licenses_cb!=null){d0.unregister(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb)}this.add_licenses_cb=bE.proxy(this.on_add_licenses_exit,this);d0.register(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb);return d0.push(new __CIRCULAR_DEPENDENCY__.AddLicensesModal())}},update_free_licenses_message:function(){var T;T=this.invite_as_limited();bE(".team-invite-add-licenses").toggle(!T);bE("#license-count-message").toggle(!T);return bE("#license-free-message").toggle(T)},invite_as_limited:function(){var T;T=bE('input[name="membership_type"]');return T&&T.is(":checked")}};var v,du=function(T,fl){return function(){return T.apply(fl,arguments)}},au={}.hasOwnProperty,cN=function(fn,fl){for(var T in fl){if(au.call(fl,T)){fn[T]=fl[T]}}function fm(){this.constructor=fn}fm.prototype=fl.prototype;fn.prototype=new fm();fn.__super__=fl.prototype;return fn};v=D.InviteModal=(function(fl){cN(T,fl);function T(fm){this.transition_view_model=fm;this._reset=du(this._reset,this);this._update_form_pricing_information=du(this._update_form_pricing_information,this);this._update_remaining_licenses_message=du(this._update_remaining_licenses_message,this);this._make_transition_info_request=du(this._make_transition_info_request,this);this._handle_token_change=du(this._handle_token_change,this);this._licenses_total=du(this._licenses_total,this);this.on_hide=du(this.on_hide,this);this.on_show=du(this.on_show,this);T.__super__.constructor.call(this,{element_id:"team-invite-wizard",focus:".new-collab-input"});this.inline_add_license=this.transition_view_model!=null;if(this.inline_add_license){this.transition_info_fetcher=new ff([fm]);this.probability=Math.random()}this.skip_reset=false}T.prototype.on_confirm_button_click=function(fn){var fm;if(dP.invite_as_limited()){fm=0}else{fm=this.add_qty}return dT.add_users(fn,fm)};T.prototype.on_show=function(){var fn,fm;this._reset();fm=bE('input[name="membership_type"]');if(fm!=null){fm.attr("checked",false)}if(fm!=null){fm.click((function(fo){return function(){dP.update_free_licenses_message();return fo._updated_charges_messages(dP.invite_as_limited())}})(this))}fn=bE("#team-invite-wizard .team-invite-add-licenses");fn.on("click",bE.proxy(dP.on_add_licenses_click,dP));bE(window).on("token:changed",this._handle_token_change);if(dP.initialized){dP.update_license_count();dP.update_free_licenses_message()}return d0.register(d0.CLEAR,function(){return dP.reset_modal()})};T.prototype.on_hide=function(){return bE(window).off("token:changed",this._handle_token_change)};T.prototype._licenses_to_add=function(){return -1*dP.available_licenses};T.prototype._licenses_total=function(){return dP.total_licenses+this._licenses_to_add()};T.prototype._handle_token_change=function(fn,fm){this._update_remaining_licenses_message(fm.remaining_licenses);if(this.inline_add_license){clearTimeout(this.fetch_transition_timeout_id);return this.fetch_transition_timeout_id=setTimeout((function(fo){return function(){fo._make_transition_info_request();return fo.fetch_transition_timeout_id=null}})(this),100)}};T.prototype._make_transition_info_request=function(){var fo,fn,fm,fp;fn=Math.floor(Math.random()*1000000);this.current_callback_token=fn;fo=this._licenses_to_add();fm=this._licenses_total();fp=(function(fq){return function(fr){return fq._update_form_pricing_information(fn,fo,fm,fr!=null?fr[0]:void 0)}})(this);if(fo>0){return this.transition_info_fetcher.get(fp,{total_users:this._licenses_total()})}else{return fp(null)}};T.prototype._update_remaining_licenses_message=function(fm){var fn;this.remaining_licenses=fm;fn=this._get_remaining_licenses_message(fm);return this.$modal_window.find("#license-count-message").text(fn)};T.prototype._get_remaining_licenses_message=function(fm){var fn;if(fm<0){fn=eA("You need more licenses for this invitation.")}else{if(fm===0){fn=eA("After this invitation, you'll have no remaining licenses.")}else{fn=bc("After this invitation, you'll have %(count)d remaining license.","After this invitation, you'll have %(count)d remaining licenses.",fm).format({count:fm})}}return fn};T.prototype._update_form_pricing_information=function(fp,fq,fm,ft){var fn,fs,fr,fo;if(fp!==this.current_callback_token){return}if(ft&&fq>0){this.add_qty=fq;fn=this.transition_view_model.state.currency;fr=ft.current_total.amount;fs=fe.formatCurrency(fr,fn);fo=fe.formatCurrency(ft.recurring_total.amount,fn);bE(".new-amount").text(fs);bE(".add-qty").text(fq);bE(".recurring-amount").text(fo);bE(".total-qty").text(fm);bE("#expected_price").val(fr);return this._updated_charges_messages(dP.invite_as_limited())}else{return this._reset()}};T.prototype._reset=function(){this.add_qty=0;bE(".charges-section").hide();bE("#expected_price").val(0);return bE(".team-invite-buttons .confirm-button").val(eA("Invite to team"))};T.prototype._updated_charges_messages=function(fm){if(this.inline_add_license&&this.add_qty>0&&!fm){bE(".charges-section").show();return bE(".team-invite-buttons .confirm-button").val(eA("Invite and buy"))}else{bE(".charges-section").hide();return bE(".team-invite-buttons .confirm-button").val(eA("Invite to team"))}};return T})(d7);var bI,at,az,S,ee,e0,bu,eK,dT,fb,bg,cq,p,du=function(T,fl){return function(){return T.apply(fl,arguments)}},au={}.hasOwnProperty,cN=function(fn,fl){for(var T in fl){if(au.call(fl,T)){fn[T]=fl[T]}}function fm(){this.constructor=fn}fm.prototype=fl.prototype;fn.prototype=new fm();fn.__super__=fl.prototype;return fn};dT=INLINE_JS.Team=D.Team={_use_async_reset:false,team_id:cK.get_viewer().team_id,set_team_id:function(T){this.team_id=T},setup_beta_modal_listeners:function(){var fp,fs,fq,T,fo,fn,fr,fl,fm;fs=bE(".feature-list .enroll-button");T=bE(".feature-list .feedback-button");for(fo=0,fr=fs.length;fo<fr;fo++){fp=fs[fo];fq=bE(fp).data("feature");bE(fp).click((function(ft){return function(){return new at(ft).show()}})(fq));fp.disabled=false}fm=[];for(fn=0,fl=T.length;fn<fl;fn++){fp=T[fn];fq=bE(fp).data("feature");fm.push(bE(fp).click((function(ft){return function(){return new az(ft).show()}})(fq)))}return fm},invite_modal_show:function(T){if(!dP.invite_modal){return bE("body").one("invite-modal-initialized",(function(fl){return function(){return fl.invite_modal_show(T)}})(this))}if(!this.invite_modal_already_initialized){dP.invite_modal.show();dP.init();this.invite_modal_already_initialized=true}else{dP.invite_modal.show();dP.rebind_modal_submit_autocompleter()}if(window.active_team_member_table!=null){dP.update_used_licenses(window.active_team_member_table.get_licensed_members())}return dP.set_emails(T)},init_admin:function(){bo.set_vertical_space(2);return bE("form.activity-report-generator").submit(this.submit_report_form.bind(this))},init_team_name_change_notice:function(){return bE(".team_name_change_notice .hide_link").click((function(T){return function(fl){return T.hide_team_name_change_banner()}})(this))},add_users:function(fm,T){var fo,fl,fn;Event.stop(fm);fl=$("team-invite-form");cJ(fl,"Couldn't find the team invite form.");fo=bE(fl).find("input[name='emails']");if(fo.length===0){ae.error(eA("You haven't included anyone to invite! Please invite at least one person."));return}fn=bT.collect_form_vars(fl);bE.extend(fn,{team_id:this.team_id});bT.add_loading(fm.target);return new Ajax.DBRequest("/account/team/add_users",{parameters:fn,subject_user:cK.get_viewer().work_user,progress_text:eA("Inviting members..."),noAutonotify:true,onSuccess:function(fu){var fs,fr,fq,ft,fp;bT.remove_loading();dP.reset_modal();dP.add_total_licenses(T);dP.invite_modal.hide();ft=bE(".team_admin_members_table");fq=JSON.parse(fu.responseText);if(fq){if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.add_users(fq!=null?fq.users:void 0)}else{if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){__CIRCULAR_DEPENDENCY__.Dashboard.set_num_invited(fq!=null?fq.num_invited:void 0)}}}fs=(function(){var fw,fv;fw=fq!=null?fq.users:void 0;fv=[];for(fr in fw){fp=fw[fr];fv.push(fp)}return fv})();if(fs.length===1){return ae.success(eA("Invited %(user_email)s.").format({user_email:fs[0].email}))}else{if(fs.length>1){return ae.success(eA("Invited %(user_count)d people.").format({user_count:fs.length}))}else{return ae.error(bc("Skipped %(num_skipped)d person who is already a member of the team.","Skipped %(num_skipped)d people who are already members of the team.",fo.length).format({num_skipped:fo.length}))}}}else{return ae.error()}},onFailure:function(fr){var fp,fq;if(fr){if(fr.responseText.indexOf("err:")===0){fp=fr.responseText.substr(4);if(fp.indexOf("{")===0){fq=fp.evalJSON(true);bT.fill_errors(fl,fq)}else{fp=new fg(fp);ae.error(fp)}}else{ae.error()}}bT.remove_loading();return bE("input[type='submit']").prop("disabled",false)},cleanUp:function(){bT.remove_loading();dP.reset_modal();return dP.invite_modal.hide()}})},show_demo_signup_modal:function(fm,fn,fo,fl,fp){var T,fs,fr,fq;this.webinar_key=fm;this.webinar_iso_datetime=fn;this.webinar_date=fo;this.webinar_title=fl;this.tab_url=fp;fq=eA("Register for a webinar on %(start_time)s").format({start_time:this.webinar_date});fs=new S({element_id:"demo-signup-modal",title:fq});fs.show();fs.$modal_window.find("input[name=webinar_key]").attr("value",this.webinar_key);fs.$modal_window.find("input[name=webinar_title]").attr("value",this.webinar_title);fs.$modal_window.find("input[name=Sales_Webinar_Topic__c]").attr("value",this.webinar_title);fs.$modal_window.find("input[name=Sales_webinar_date__c]").attr("value",this.webinar_iso_datetime);fr=fs.$modal_window.find("input[name=retURL]");fr.attr("value",fr.val()+"#"+this.tab_url);T=fs.$modal_window.find("#demo-signup-form")[0];return T.on("submit",fs.on_confirm_button_click)},show_unsuspend_modal:function(fm,T,fl){var fn;fn=new bu({element_id:"dfe-unsuspend-modal",focus:"confirm"});fn.user_name=fm||fl;fn.email=fl;fn.user_id=T;fn.team_id=this.team_id;fn.show();return false},show_remove_or_deactivate_modal:function(fm,fp,T,fl,fq,fo){var fn;fn=new ee({element_id:"dfe-remove-or-deactivate-user-modal",focus:".new-collab-input"});fn.user_name=fp||fl;fn.email=fl;fn.user_id=T;fn.team_id=this.team_id;fn.invited=fq;fn.hide_transfer_wipe=fo;fn.show();return false},show_remove_modal:function(fn,fq,T,fl,fr,fm,fp){var fo;fo=new e0({element_id:"dfe-remove-user-modal",focus:".new-collab-input"});fo.user_name=fq||fl;fo.email=fl;fo.user_id=T;fo.team_id=this.team_id;fo.invited=fr;fo.num_api_apps=fm;fo.hide_transfer_wipe=fp;fo.show();return false},remove_user:function(fn,fo){var fm,fl,T;alert("in remove_user");Event.stop(fn);fl=bE("input[type=submit]","#remove-user-modal");fl.attr("disabled",1);T=fc.vars.user_id;if(fo){fm=true}else{fm=bE("input[name=should_disable]:checked","#remove-user-modal").val()}return new Ajax.DBRequest("/account/team/remove_user",{parameters:{team_id:this.team_id,user_id:T,should_disable:fm},onSuccess:(function(fp){return function(fs){var fr,ft,fq;fr=JSON.parse(fs.responseText);if((ft=window.active_team_member_table)!=null){ft.remove_user(fc.vars.user_id)}if((fq=window.removed_team_member_table)!=null){fq.add_users(fr)}fp.decrement_used_licenses();return ae.success(eA("User removed."))}})(this),cleanUp:function(){fc.hide();return fl.removeAttr("disabled")}})},show_reinvite_modal:function(fm,fn,T,fl){var fo;ds.fillVal(fl,"reinvite-user-email");ds.fillVal(fn,"reinvite-user-team");fo=eA("Resend invite to '%(email_address)s'").format({email_address:bU.em_snippet(fl,18)});return fc.show(fo,$("reinvite-user-modal"),{user_id:T,button:fm})},reinvite_user:function(fl){var T;Event.stop(fl);T=fc.vars.user_id;return new Ajax.DBRequest("/account/team/reinvite_user",{parameters:{team_id:this.team_id,user_id:T},onSuccess:function(fp){var fn,fo,fm,fq;ae.success(eA("Invite sent."));if((fq=$("team-member-info"))!=null){fq.update(fp.responseText)}fn=window.active_team_member_table;if(fn){fm=fn.data.users[T];fm.invite_expired=false;fo={};fo[T]=fm;return fn.update_user_data(fo)}},cleanUp:function(){return fc.hide()}})},show_request_license_modal:function(fl,T){var fm;fm=eA("Send upgrade request?");return fc.show(fm,$("request-license-modal"),{user_id:T,button:fl})},request_license:function(fl){var T;Event.stop(fl);T=fc.vars.user_id;return new Ajax.DBRequest("/team/request_license",{parameters:{team_id:this.team_id,user_id:T},onSuccess:function(fm){bE("#request_license_text").hide();bE("#request-license-section").hide();return ae.success(eA("Request sent."))},cleanUp:function(){return fc.hide()}})},show_user_activity_log_modal:function(T,fm,fn){var fl;fl=bE("#activity-log-modal");fl.find(".activity-log-email").text(fm);fl.find(".activity-log-name").text(fn);fl.find("#activity-log-user-message").show();return fc.show(eA("Create activity report"),fl[0],{user_id:T})},show_team_activity_log_modal:function(fl,fm){var T;T=bE("#activity-log-modal");T.find(".activity-log-email").text(fl);T.find(".activity-log-name").text(fm);T.find("#activity-log-team-message").show();return fc.show(eA("Create full activity report"),T[0])},generate_activity_log:function(fr){var fp,fn,fq,fo,T,fm,fl;Event.stop(fr);fn=bE("#activity-log-modal");fq=fn.find("input[name='from_date']").val();T=fn.find("input[name='to_date']").val();if(fq>T){ae.error(eA("Your start date is after your end date."));return}fo=this.team_id;fl=fc.vars.user_id;fm=new Date().getTimezoneOffset().toString();fp=bE(".activity-report-generator .freshbutton-blue");fp.prop("disabled",true);return new Ajax.DBRequest("/team/events_report/csv",{parameters:{from_date:fq,to_date:T,team_id:fo,user_id:fl,tzoffset:fm},onSuccess:function(fs){return ae.success(eA("Report started. We'll email you when it's ready."))},cleanUp:function(){fc.hide();return fp.prop("disabled",false)}})},show_reset_password_modal:function(fl,fm,T){var fn;bE("#reset-password-modal .member-name").text(fm);fn=eA("Reset password for '%(user_name)s'").format({user_name:fm});return fc.show(fn,$("reset-password-modal"),{user_id:T,button:fl})},reset_password:function(fl){var T;Event.stop(fl);T=fc.vars.user_id;return new Ajax.DBRequest("/account/team/reset_password",{parameters:{team_id:this.team_id,user_id:T},onSuccess:function(fm){return ae.success(eA("User's password reset."))},cleanUp:function(){return fc.hide()}})},show_reset_all_passwords_modal:function(){return fc.show(eA("Reset all passwords"),$("reset-all-passwords-modal"))},set_async_password_reset:function(T){return this._use_async_reset=T},reset_all_passwords:function(){return new Ajax.DBRequest("/account/team/reset_all_passwords",{parameters:{team_id:this.team_id},job:this._use_async_reset,subject_user:cK.get_viewer().work_user,progress_text:eA("Resetting all passwords..."),onSuccess:function(T){return ae.success(eA("All passwords reset."))},cleanUp:function(){return fc.hide()}})},show_admin_status_modal:function(fm,fr,ft,fo,fs,fp){var fl,T,fn,fq;T=fs.strip()||fo;fn=void 0;fl=void 0;fq=void 0;if(fp){fq=eA("Add admin permissions for '%(person_name)s'").format({person_name:T.escapeHTML()});fn=eA("Are you sure you want to add admin permissions for <strong>%(person_name)s</strong>?").format({person_name:T.escapeHTML()});fl=eA("Add admin permissions",{comment:"make this user an admin; give them the permissions an admin has"})}else{fq=eA("Remove admin privileges from '%(person_name)s'").format({person_name:T.escapeHTML()});fn=eA("Are you sure you want to remove admin permissions from <strong>%(person_name)s</strong>?").format({person_name:T.escapeHTML()});fl=eA("Remove admin permissions",{comment:"clicking this button completes the action: it removes a person's admin status"})}ds.fillVal(fo,"admin-status-email");ds.fillVal(fn,"admin-status-action");ds.fillVal(fl,"admin-status-button-action");fc.show(fq,$("admin-status-modal"),{user_id:ft,button:fm,admin_on:fp});return false},set_admin_status:function(fl){var T;Event.stop(fl);T=fc.vars.user_id;return new Ajax.DBRequest("/account/team/set_admin_status",{parameters:{team_id:this.team_id,user_id:T,on:(fc.vars.admin_on?"yes":"no")},onSuccess:function(fn){var fo,fm;fo=(fc.vars.admin_on?eA("User's admin status granted."):eA("User's admin status removed."));if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){return __CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){fm=JSON.parse(fn.responseText);window.active_team_member_table.update_user_data(fm);return ae.success(fo)}else{if(fc.vars.admin_on){return window.location="/team/admin/member?id=%d&msg=granted".format(fc.vars.user_id)}else{return window.location="/team/admin/member?id=%d&msg=removed".format(fc.vars.user_id)}}}},cleanUp:function(){return fc.hide()}})},show_disable_2fa_modal:function(fm,T,fl){bE("#disable-2fa-modal .member-name").text(fl);return fc.show(eA("Disable two-step verification"),$("disable-2fa-modal"),{user_id:T,elm:fm})},show_reset_2fa_modal:function(fm,T,fl){bE("#reset-2fa-modal .member-name").text(fl);return fc.show(eA("Reset two-step verification"),$("reset-2fa-modal"),{user_id:T,user_name:fl,elm:fm})},reset_2fa:function(){return new Ajax.DBRequest("/account/team/reset_2fa",{parameters:{team_id:this.team_id,user_id:fc.vars.user_id},onSuccess:function(fl){var T;bE(".tfa_enabled").replaceWith(eA("Disabled"));T=JSON.parse(fl.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(T)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",T)}}}ae.success(eA("Two-step verification reset for %(user_name)s").format({user_name:fc.vars.user_name}));return fc.hide()}})},disable_2fa:function(){return new Ajax.DBRequest("/account/team/disable_2fa",{parameters:{team_id:this.team_id,user_id:fc.vars.user_id},onSuccess:function(fl){var T;bE(".tfa_enabled").replaceWith(eA("Disabled"));T=JSON.parse(fl.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(T)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",T)}}}ae.success(eA("Two-step verification disabled."));return fc.hide()}})},show_sso_preview_email:function(T){return fc.show(eA("Email preview"),$(T))},show_sso_sample_email:function(T){return fc.show(eA("Sample email"),$(T))},show_user_message_modal:function(fm,fl,T){var fn;ds.fillVal(T,"user-message-email");fn=eA("Send email to '%(user_name)s'").format({user_name:fm});$("user-message").value="";fc.show(fn,$("user-message-modal"),{user_name:fm,user_id:fl});return d5.focus.defer("user-message")},send_user_message:function(){var fl,T;T=fc.vars.user_id;fl=$F("user-message").strip();return new Ajax.DBRequest("/account/team/send_user_message",{parameters:{user_id:T,team_id:this.team_id,message:fl},onSuccess:function(){var fm;fm=fc.vars.user_name;ae.success(eA("Message successfully sent to %(user_name)s.").format({user_name:fm}));return fc.hide()}})},hide_team_name_change_banner:function(){new Ajax.DBRequest("/account/team/name_change_notice_received",{parameters:{team_id:this.team_id}});bE(".team_name_change_notice").hide();return false},hide_pin_banner:function(){new Ajax.DBRequest("/team/invalidate_pin");return bE(".pin_notice").hide()},hide_pin_banner_with_user_id:function(T,fl){var fm;fm=function(fn){return bE(fl).closest("span").removeClass("on").addClass("off")};if(T===null){return new Ajax.DBRequest("/team/invalidate_pin",{onSuccess:fm})}else{return new Ajax.DBRequest("/team/invalidate_pin",{parameters:{user_id:T},onSuccess:fm})}},get_pin_with_user_id:function(T,fm,fl){var fn;if(fl==null){fl=null}if(fl===null){fl=function(fp,fo){bE(fo).closest("span").find(".pin-value").text(fp.pin+" -");return bE(fo).closest("span").removeClass("off").addClass("on")}}fn=function(fp){var fo;fo=JSON.parse(fp.responseText);return fl(fo,fm)};if(T===null){return new Ajax.DBRequest("/team/generate_pin",{onSuccess:fn})}else{return new Ajax.DBRequest("/team/generate_pin",{parameters:{user_id:T},onSuccess:fn})}},send_team_message:function(fl){var T;Event.stop(fl);T=$F("team-message").strip();if(T){return new Ajax.DBRequest("/account/team/send_team_message",{parameters:{team_id:this.team_id,message:T},onSuccess:function(fm){ae.success(eA("Message successfully sent to team."));return fc.hide()}})}},show_security_message_modal:function(){return new fb().show()},send_team_security_message:function(fm){var fl,T;Event.stop(fm);T=$F("team-security-message").strip();fl=$("team-security-message-form");return new Ajax.DBRequest("/account/team/send_team_message",{parameters:fl.serialize(true),onSuccess:function(fn){ae.success(eA("Message successfully sent."));return fc.hide()}})},used_licenses:0,total_licenses:0,set_used_licenses:function(T,fl){this.used_licenses=T;return this.total_licenses=fl},decrement_used_licenses:function(){return this.set_used_licenses(this.used_licenses-1,this.total_licenses)},show_migration_link:function(T,fl){$("migration-url").value=fl;fc.show(eA("Migration link for '%(email)s'").format({email:bU.em_snippet(T,18)}),$("migrate-url-modal"));return $("migration-url").select()},show_end_session_modal:function(fl,T,fm){bo.hide_all();bE("#end-session-modal .member-name").text(bE("#member-name").text());return fc.show(eA("Close web session",{comment:"Log out of your current Dropbox web session"}),$("end-session-modal"),{login_id:fl,user_id:T,elm:fm})},end_session:function(){return new Ajax.DBRequest("/logout_remote_session",{parameters:{remote_login_id:fc.vars.login_id,team_id:this.team_id,user_id:fc.vars.user_id},onSuccess:function(){fc.hide();dT.remove_closest_row(fc.vars.elm);return ae.success(eA("Web session closed."))}})},unlink_device:function(T,fn,fr,fl,fs,fm,fo){var fq,fp;bo.hide_all();fq=$("unlink-device-modal-"+fm);fp=eA("Unlink %(device_name)s").format({device_name:fr});return fc.show(fp,fq,{app_id:fn,user_id:fs,elm:fo,device_id:T,display_name:fr})},unlink_device_submit:function(){return new Ajax.DBRequest("/account/unlink_team_device",{parameters:{app_id:fc.vars.app_id,team_id:this.team_id,user_id:fc.vars.user_id,device_id:JSON.stringify(fc.vars.device_id)},subject_user:cK.get_viewer().work_user,onSuccess:function(){fc.hide();dT.remove_closest_row(fc.vars.elm);return ae.success(eA("%(device_name)s unlinked.").format({device_name:fc.vars.display_name}))}})},disable_app:function(fl,fm,T,fn){bo.hide_all();bE("#disable-app-modal .app-name").text(fm);bE("#disable-app-modal .member-name").text(bE("#member-name").text());return fc.show(eA("Disable '%(app_name)s'?").format({app_name:fm}),$("disable-app-modal"),{app_id:fl,user_id:T,elm:fn})},disable_app_submit:function(){return new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:fc.vars.app_id,keep_sandbox_files:true,team_id:this.team_id,user_id:fc.vars.user_id},subject_user:cK.get_viewer().work_user,onSuccess:function(T){fc.hide();dT.remove_closest_row(fc.vars.elm);return ae.success(T.responseText)}})},remove_closest_row:function(fn){var fm,fl,T;fm=bE(fn).closest(".team_admin_table_row");fl=bE(fm).closest(".team_admin_table");if(fl.find(".team_admin_table_row").length===1){T=fl.prev(".team_admin_table_title");if(!T.length){T=bE(".team_apps_table_panel")}T.remove();return fl.remove()}else{return fm.remove()}},submit_report_form:function(T){bE(T.target.elements.tzoffset).val(""+new Date().getTimezoneOffset());return true}};at=D.BetaEnrollConfirmationModal=(function(fl){cN(T,fl);function T(fm){this.feature_name=fm;this.on_confirm_button_click=du(this.on_confirm_button_click,this);T.__super__.constructor.call(this,{element_id:"beta-enroll-confirmation-modal"})}T.prototype.on_confirm_button_click=function(fm){bE("<input>").attr({type:"hidden",name:"feature_name",value:this.feature_name}).appendTo("#beta-enroll-confirmation-modal form");return this.$modal_window.addClass("ajax-loading")};return T})(d7);az=D.BetaFeedbackModal=(function(fl){cN(T,fl);function T(fm){this.feature_name=fm;this.success=du(this.success,this);T.__super__.constructor.call(this,{element_id:"beta-feedback-modal"});this.on_confirm_button_click=(function(fn){return function(fr){var fq,fp,fo;fr.preventDefault();fq=bE(fr.target);fp=fq.closest("form");fo={feature_name:fn.feature_name};return bT.ajax_submit(fp[0],false,fn.success,fn.error,fq[0],fo)}})(this)}T.prototype.success=function(fm){ae.success(eA("Thank you for your feedback."));return this.$modal_window.hide()};T.prototype.error=function(fm){if(fm.status!==200){return ae.error(eA("Failed to submit feedback. Please try again."))}};return T})(d7);S=D.DemoSignupModal=(function(T){cN(fl,T);function fl(){this.on_show=du(this.on_show,this);this.on_confirm_button_click=du(this.on_confirm_button_click,this);return fl.__super__.constructor.apply(this,arguments)}fl.prototype.on_confirm_button_click=function(fq){var fy,fv,fr,fm,ft,fo,fx,fw,fn,fu,fs,fp;fq.preventDefault();fs=$("demo-signup-form");fw=$("1210");fo=bE(fs).find("input[name='first_name']").val();bE(fw).find("input[name='FirstName']").attr("value",fo);fx=bE(fs).find("input[name='last_name']").val();bE(fw).find("input[name='LastName']").attr("value",fx);ft=bE(fs).find("input[name='email']").val();bE(fw).find("input[name='Email']").attr("value",ft);fu=bE(fs).find("input[name='phone_number']").val();bE(fw).find("input[name='Phone']").attr("value",fu);fy=bE(fs).find("input[name='company_name']").val();bE(fw).find("input[name='Company']").attr("value",fy);fr=bE(fs).find("select[name='company_size']");fv=fr.find("option:selected").val();bE(fw).find("input[name='Company_size__c']").attr("value",fv);fm=$(this.$modal_window.find(".confirm-button")[0]);fp=(function(fz){return function(fA){fz.$modal_window.hide();return fw.submit()}})(this);fn=bT.collect_form_vars(fs,true);return bT.ajax_submit(fs,false,fp,false,fm,fn,true)};fl.prototype.on_show=function(fm){this.$modal_window.find(".db-modal-content").css({"overflow-y":""});return ch.init()};return fl})(d7);bI=D.AccountTransferBaseModal=(function(fl){cN(T,fl);function T(fm,fo,fn){this.file_action_selector=fo;this.transfer_choice_selector=fn;this._clearInput=du(this._clearInput,this);this._markInputInvalid=du(this._markInputInvalid,this);this._markInputValid=du(this._markInputValid,this);this._tokenRemove=du(this._tokenRemove,this);this._tokenAdd=du(this._tokenAdd,this);this._selectChange=du(this._selectChange,this);this._isTransferSelected=du(this._isTransferSelected,this);this.handleAjaxFailure=du(this.handleAjaxFailure,this);T.__super__.constructor.call(this,fm,this.file_action_selector,this.transfer_choice_selector)}T.prototype.on_show=function(){if(this.$modal_window.find("#manage-files-new-collab-input").length===0){return}this.auto_completer=new Autocompleter.TeamTokenizer(cK.get_viewer().get_user_by_role(Constants.ROLE_WORK),"manage-files-new-collab-input","manage-files-new-whobulk","manage-files-hidden-input",{hide_import_contacts:true,suggestions_disabled:true,wrap_name:true,single_token:true,contact_filter:(function(fm){return function(fn){return fn.excludeNonTeam().excludeGroups().excludeNewStyleGroups().excludeRooms().excludeByEmail(fm.email?[fm.email.toLowerCase()]:[])}})(this)});this.tokenAdd=bE.proxy(this._tokenAdd,this);this.tokenRemove=bE.proxy(this._tokenRemove,this);this.$collab_input=this.$modal_window.find("#manage-files-new-collab-input")[0];this.$collab_input.on("token:add",this.tokenAdd);this.$collab_input.on("token:remove",this.tokenRemove);this.$textinput=this.$modal_window.find(".tokenized_autocompleter_container .textinput");this.selectChange=bE.proxy(this._selectChange,this);return this.$modal_window.find(this.file_action_selector).on("change",this.selectChange)};T.prototype.handleAjaxFailure=function(fm){if(fm.status===200&&this._isTransferSelected()){return this._markInputInvalid()}};T.prototype._isTransferSelected=function(){return bE(this.transfer_choice_selector).prop("checked")};T.prototype._selectChange=function(fm){if(this._isTransferSelected()){return this.$textinput.removeClass("unselected")}else{return this.$textinput.addClass("unselected")}};T.prototype._tokenAdd=function(fm){this.$collab_input.hide();if(fm.memo.valid){return this._markInputValid()}else{return this._markInputInvalid()}};T.prototype._tokenRemove=function(fm){this.$collab_input.show();return this._clearInput()};T.prototype._markInputValid=function(){this._clearInput();return this.$textinput.addClass("valid")};T.prototype._markInputInvalid=function(){this._clearInput();return this.$textinput.addClass("invalid")};T.prototype._clearInput=function(){this.$textinput.removeClass("valid");return this.$textinput.removeClass("invalid")};return T})(d7);fb=D.TwoFactorMessageModal=(function(fl){cN(T,fl);function T(){T.__super__.constructor.call(this,{element_id:"team-security-message-modal",focus:"#team-security-message"})}T.prototype.on_confirm_button_click=function(fm){dT.send_team_security_message(fm);return this.hide()};return T})(d7);bu=D.DfeUnsuspendUserModal=(function(T){cN(fl,T);function fl(fm){this.on_confirm_button_click=du(this.on_confirm_button_click,this);this.success_callback=du(this.success_callback,this);fl.__super__.constructor.call(this,fm)}fl.prototype.before_show=function(){var fm;fl.__super__.before_show.call(this);fm=eA("Unsuspend %(user_name)s").format({user_name:this.user_name});this.$modal_window.find(".db-modal-title-text").text(fm);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=email]").attr("value",this.email);this.$modal_window.find(".unsuspended_name").text(this.user_name);return this.$modal_window.find(".unsuspended_email").text(this.email)};fl.prototype.success_callback=function(fm){var fn;ae.success("User unsuspended");if((fn=__CIRCULAR_DEPENDENCY__.MembersReact)!=null){fn.refresh_member_stats()}return this.hide()};fl.prototype.on_confirm_button_click=function(fo){var fm,fn;fo.preventDefault();fn=this.$modal_window.find(".dfe-unsuspend-modal")[0];fm=$(this.$modal_window.find(".confirm-button")[0]);return bT.ajax_submit(fn,false,this.success_callback,false,fm)};return fl})(d7);ee=D.DfeRemoveOrDeactivateUserModal=(function(fl){cN(T,fl);function T(fm){this.on_confirm_button_click=du(this.on_confirm_button_click,this);this.success_callback=du(this.success_callback,this);this.on_show=du(this.on_show,this);this.handle_change_action=du(this.handle_change_action,this);this.switch_to_uninvite_mode=du(this.switch_to_uninvite_mode,this);this.switch_to_removal_mode=du(this.switch_to_removal_mode,this);this.switch_to_deactivation_mode=du(this.switch_to_deactivation_mode,this);this.show_removal_content=du(this.show_removal_content,this);this.show_deactivation_content=du(this.show_deactivation_content,this);this.set_modal_class=du(this.set_modal_class,this);T.__super__.constructor.call(this,fm,"input[name=transfer_files]","#transfer_files_on")}T.prototype.set_form_action_to_deactivate=function(){return bE(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/suspend_user")};T.prototype.set_form_action_to_remove=function(){return bE(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/remove_user")};T.prototype.set_modal_class=function(fo){var fn,fm;fn="suspending deleting";fm=this.$modal_window.find(".dfe-remove-or-deactivate-user-modal");fm.removeClass(fn);return fm.addClass(fo)};T.prototype.show_deactivation_content=function(){return this.set_modal_class("suspending")};T.prototype.show_removal_content=function(){return this.set_modal_class("deleting")};T.prototype.switch_to_deactivation_mode=function(){this.show_deactivation_content();return this.set_form_action_to_deactivate()};T.prototype.switch_to_removal_mode=function(){this.show_removal_content();return this.set_form_action_to_remove()};T.prototype.switch_to_uninvite_mode=function(){this.set_form_action_to_remove();this.set_modal_class("invited");this.$modal_window.find(".transfer_data_on_remove_setting").remove();return this.$modal_window.find(".remote_wipe_setting").remove()};T.prototype.handle_change_action=function(fm){fm.preventDefault();if(bE("#deactivate_option").is(":checked")){return this.switch_to_deactivation_mode()}else{return this.switch_to_removal_mode()}};T.prototype.on_show=function(fm){var fn;T.__super__.on_show.call(this);bE("input[name=deactivate_or_remove]").on("change",this.handle_change_action);this.$modal_window.find(".deleted_user_name").text(this.user_name);if(this.invited){fn=eA("Uninvite %(user_name)s").format({user_name:this.user_name});this.switch_to_uninvite_mode()}else{fn=eA("Remove %(user_name)s").format({user_name:this.user_name});bE("#deactivate_option").attr("checked","checked");this.switch_to_deactivation_mode()}this.$modal_window.find(".db-modal-title-text").text(fn);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.hide_transfer_wipe){this.$modal_window.find(".transfer_data_on_remove_setting").remove();return this.$modal_window.find(".remote_wipe_setting").remove()}};T.prototype.success_callback=function(fm){if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}if(this.invited){ae.success(eA("User uninvited"))}else{if(bE("#deactivate_option").is(":checked")){ae.success(eA("User suspended"))}else{ae.success(eA("User deleted"))}}return this.hide()};T.prototype.on_confirm_button_click=function(fo){var fm,fn;fo.preventDefault();fn=this.$modal_window.find(".dfe-remove-or-deactivate-user-modal")[0];fm=$(this.$modal_window.find(".confirm-button")[0]);return bT.ajax_submit(fn,false,this.success_callback,this.handleAjaxFailure,fm)};return T})(bI);e0=D.DfeRemoveUserModal=(function(T){cN(fl,T);function fl(fm){this.on_confirm_button_click=du(this.on_confirm_button_click,this);this.success_callback=du(this.success_callback,this);this.on_show=du(this.on_show,this);fl.__super__.constructor.call(this,fm,"input[name=transfer_files]","#transfer_files_on")}fl.prototype.on_show=function(fn){var fm,fo;fl.__super__.on_show.call(this);this.$modal_window.find(".remove_user_name").text(this.user_name);if(this.invited){fo=eA("Uninvite %(user_name)s").format({user_name:this.user_name})}else{fo=eA("Delete %(user_name)s").format({user_name:this.user_name})}this.$modal_window.find(".db-modal-title-text").text(fo);if(this.num_api_apps){fm=bc("%(num)s API app","%(num)s API apps",this.num_api_apps).format({num:this.num_api_apps});this.$modal_window.find(".num_api_app").text(fm)}else{this.$modal_window.find(".api_app_warning").hide()}this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.invited){this.$modal_window.find(".active_user_remove_setting").remove();this.$modal_window.find(".dfe-remove-user-modal").addClass("invited")}if(this.hide_transfer_wipe){return this.$modal_window.find(".active_user_remove_setting").remove()}};fl.prototype.success_callback=function(fo){var fn,fp,fm;fn=JSON.parse(fo.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if((fp=window.active_team_member_table)!=null){fp.remove_user(this.user_id)}if((fm=window.removed_team_member_table)!=null){fm.add_users(fn)}}if(this.invited){ae.success(eA("User uninvited."))}else{ae.success(eA("User removed."))}dT.decrement_used_licenses();return this.hide()};fl.prototype.on_confirm_button_click=function(fo){var fm,fn;fo.preventDefault();fn=this.$modal_window.find(".dfe-remove-user-modal")[0];fm=$(this.$modal_window.find(".confirm-button")[0]);return bT.ajax_submit(fn,false,this.success_callback,this.handleAjaxFailure,fm)};return fl})(bI);eK=D.ManageFilesModal=(function(fl){cN(T,fl);function T(fn,fo,fm){this.source_user_id=fn;this.source_user_name=fo;this.options=fm;this.on_confirm_button_click=du(this.on_confirm_button_click,this);this.success_callback=du(this.success_callback,this);T.__super__.constructor.call(this,this.options,"input[name=file_action]","#move-files")}T.prototype.get_form=function(){return this.$modal_window.find("form")[0]};T.prototype.on_show=function(){var fm;T.__super__.on_show.call(this);this.$modal_window.find("[name='source_user_id']").attr("value",this.source_user_id);this.$modal_window.find(".source-user-name").text(this.source_user_name);fm=eA("Manage %(team_member)s's files").format({team_member:this.source_user_name});this.$modal_window.find(".db-modal-title-text").text(fm);return this.get_form().on("submit",this.on_confirm_button_click)};T.prototype.success_callback=function(fn){var fm;fm=JSON.parse(fn.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.removed_team_member_table){window.removed_team_member_table.update_user_data(fm)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu!=null){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",fm)}}}if(bE("#move-files").prop("checked")){ae.success(eA("Transfer started",{comment:"This refers to the start of a file transfer from one Dropbox to another"}))}else{ae.success(eA("Permanently deleted files"))}return this.hide()};T.prototype.on_confirm_button_click=function(fo){var fm,fn;fo.preventDefault();fn=this.get_form();fm=$(this.$modal_window.find(".confirm-button")[0]);return bT.ajax_submit(fn,false,this.success_callback,this.handleAjaxFailure,fm)};return T})(bI);cq=D.show_manage_files_modal=function(T,fl){var fm;fm=new eK(T,fl,{element_id:"manage-files-modal",focus:".new-collab-input"});return fm.show()};p=function(){var T;T=function(fn,fm){var fl,fo;bE(fm).css("display","none");fl=bE(fm).closest("#user_generate_liveops_pin");fo=fl.find(".user_generate_liveops_pin_value");fo.text(fn.pin);bE(fm).addClass("liveops_pin_elem_invisible");return fl.find(".user_generate_liveops_pin_text").removeClass("liveops_pin_elem_invisible")};dT.get_pin_with_user_id(null,this,T);return false};bE("#user_generate_liveops_pin_button").click(p);bg=function(){bE("#help_callus_title").hide();bE("#help_callus_details").show();return false};bE("#help_callus_trigger").click(bg);var bD;bD=D.UpdateEvents={ADD:"db:add_file_objects",REMOVE:"db:remove_file_objects",MOVE:"db:move_file_objects"};var b7;b7=D.FileTypes={FILE:1,FOLDER:2,PACKAGE:3,SHARED_FOLDER:4,SANDBOX:5,TEAM_SHARED_FOLDER:6};var a5;a5=D.BrowseUtil={THUMBS_BATCH_SIZE:16,make_browsefile:function(fl,fm){var T;if(fm==null){fm=null}T=Object.clone(fl);if(T.is_dir){T.ago="";T.ts=0}else{T.target_ns=false}T.sort_key=d5.decode_sort_key(T.sort_key);T.request_id=fm!=null?fm:null;return new cR(T)},filepreview_from_selected:function(fp,fo,fn,fm){var T,fq,fl;if(fo==null){fo=false}if(fn==null){fn=false}if(fm==null){fm=Constants.BROWSE_UNKNOWN}if(fp.bytes<0||fp.preview_type==="download"){window.open(fp.href,"_blank");return}fl=eD.get_url();fq=eD.deconstruct_url(fl);T=fl.indexOf("/s/")===0;m.show(fp,cr.active_user,{files:cr.files,file_view_mode:aV.FileViewModeType.BROWSE,should_focus_comment_input:fn},fm);if(!(fo||T||fq.qargs.preview===fp.filename)){m.set_preview_url()}},profile_files:function(fl){var fm,fn,fp,T,fo;fn={files:0,folders:0,shared_folders:0,deleted:0,public_folder:0,rejoinables:0,sandboxes:0,target_namespaces:0,in_root_coll:0,compressible_count:0,can_permanently_delete:0};for(fp=0,T=fl.length;fp<T;fp++){fm=fl[fp];if(fm.dir){fn.folders+=1}else{fn.files+=1}if(fm.is_sandbox()){fn.sandboxes+=1}if(fm.is_shared_folder()){fn.shared_folders+=1}if(fm.bytes===-1){fn.deleted+=1}if(fm.target_ns){fn.target_namespaces+=1}if(fm.fq_path.toLowerCase()==="/public"&&cr.public_folder_enabled){fn.public_folder=1}if(fm.in_root_coll){fn.in_root_coll+=1}if(fm.compressible){fn.compressible_count+=1}if(!((fo=cr.permanent_delete_is_disabled_by_ns_id)!=null?fo[fm.ns_id]:void 0)){fn.can_permanently_delete+=1}}return fn},profile_summary:function(fl){var fm,T;fm=bc("%d file","%d files",fl.files,{comment:"used in a phrase such as 'x files and y folders'"}).format(fl.files);T=bc("%d folder","%d folders",fl.folders,{comment:"used in a phrase such as 'x files and y folders'"}).format(fl.folders);if(fl.files&&fl.folders){return eA("%(x_files)s and %(y_folders)s",{comment:"x_files will either be '1 file' or 'd files', similar for x_folders"}).format({x_files:fm,y_folders:T})}else{if(fl.files){return fm}else{if(fl.folders){return T}else{return""}}}},BROWSE_MODE:"browse",SEARCH_MODE:"search",SPECIAL_MODES:["search"],set_browse_mode:function(){var fr,fp,fm,fl,fq,fo,T,fn;fr=bE("#browse");fm=fr.find("#browse-root-actions");fl=fr.find("#browse-sort");fp=fr.find("#browse-header-status");fn=this.SPECIAL_MODES;for(fo=0,T=fn.length;fo<T;fo++){fq=fn[fo];fr.removeClass(fq);fm.removeClass(fq);fl.removeClass(fq);fp.removeClass(fq)}if(b9.sparky_search_ui_enabled){b9.reset_fulltext_search(true);fr.removeClass("fulltext_search");fm.removeClass("fulltext_search");fl.removeClass("fulltext_search");fp.removeClass("fulltext_search");bE("#fulltext-search-loading").hide();return bE("#fulltext-search-all-link").hide()}},set_special_mode:function(fq){var fl,fm,fs,T,fp,fn,fr,fo;fl=bE("#browse");fs=fl.find("#browse-root-actions");T=fl.find("#browse-sort");fm=fl.find("#browse-header-status");cJ(this.SPECIAL_MODES.indexOf(fq)!==-1,"unknown mode");fo=this.SPECIAL_MODES;for(fn=0,fr=fo.length;fn<fr;fn++){fp=fo[fn];if(fp!==fq){fl.removeClass(fp);fs.removeClass(fp);T.removeClass(fp);fm.removeClass(fp)}}fl.addClass(fq);fs.addClass(fq);T.addClass(fq);fm.addClass(fq);if(fq===this.SEARCH_MODE){if(b9.sparky_search_ui_enabled){fl.addClass("fulltext_search");fs.addClass("fulltext_search");T.addClass("fulltext_search");return fm.addClass("fulltext_search")}}},get_mode:function(){var fo,T,fn,fl,fm;T=this.BROWSE_MODE;fm=this.SPECIAL_MODES;for(fn=0,fl=fm.length;fn<fl;fn++){fo=fm[fn];if(bE("#browse").hasClass(fo)){T=fo}}return T},load_visible_thumbs:function(){var fu,fx,fn,ft,fy,fz,fv,fm,fr,fl,fq,fp,fw,T,fs,fo;fm=this.get_files_in_view();fx=fm[1]-fm[0];fv=[Math.max(fm[0]-fx,0),fm[0]];fz=[Math.min(fm[1],cr.files.length),Math.min(fm[1]+fx,cr.files.length)];fu=[];fs=[fm,fz,fv];for(fq=0,fw=fs.length;fq<fw;fq++){fy=fs[fq];ft=fy[0],fr=fy[1];fo=cr.files.slice(ft,+fr+1||9000000000);for(fp=0,T=fo.length;fp<T;fp++){fn=fo[fp];if(fn.get_div()){fu.push(fn.get_div().down("img"))}}}fl=function(fA){if(!fA.src.endsWith(cv.SPACER)){fA.addClassName("thumbnail");return fA.__sert({before:new Element("div",{"class":"thumbnail-border"})})}};return bs.batch_load_thumbs(fu,this.THUMBS_BATCH_SIZE,fl)},get_files_in_view:function(){var fq,fn,fs,fo,fp,fm,T,ft,fr,fl,fu;T=[0,cr.files.length-1];fl=B.viewport_dimensions().height;fu=B.scroll_offsets().top;fm=this._get_elm_height();if(!fm){return T}fq=bE("#browse-files");fo=parseInt(fq.css("padding-top"),10);if(!fq.length||isNaN(fo)){return T}if(bE("body").hasClass("absolutize")){fn=fq.offset().top+fo;fs=fn-fu;if(fs>0){ft=0;fp=fl-fs;fr=fp/fm}else{ft=Math.abs(fs/fm);fr=Math.abs(fl-fs)/fm}}else{ft=fu/fm;fp=fl-fo;fr=(fp+fu)/fm}ft=Math.max(Math.floor(ft),0);fr=Math.min(Math.floor(fr),cr.files.length-1);return[ft,fr]},_get_elm_height:function(){var fl,T;if(cr.files.length>=3&&cr.files[1].get_div()){fl=bE(cr.files[1].get_div());T=fl.outerHeight()+parseInt(fl.css("margin-bottom"))+parseInt(fl.css("margin-top"));return T}else{return null}},append_ellipsis:function(T){return eA("%(action_text)s\u2026","web","action which requires further user interaction").format({action_text:T})}};var bq;bq=D.Sort=(function(){var fq,T,fn,fp,fo,fm,fl;fn=function(fs){var fr;fr=fs?1:-1;return function(ft,fu){return fr*d5.sort_by_rank_or_key(ft,fu)}};fp=function(fs){var fr;fr=fs?1:-1;return function(ft,fu){if(ft.bytes>fu.bytes){return fr}else{if(ft.bytes<fu.bytes){return -fr}else{return fr*bq.FILES_BY_NAME(ft,fu)}}}};fq=function(fs){var fr;fr=fs?1:-1;return function(ft,fu){return fr*(ft.fq_path.toLowerCase()>fu.fq_path.toLowerCase()?1:-1)}};T=function(fs){var fr;fr=fs?1:-1;return function(fu,fv){var ft;ft=fu.ts===fv.ts?0:fu.ts>fv.ts?1:-1;return fr*ft}};fm=function(fr){return function(fu){var ft,fs;fs=fr(fu);ft=fn(true);return function(fv,fw){if(fv.dir^fw.dir){return(fv.dir?1:0)-(fw.dir?1:0)}else{return fs(fv,fw)||ft(fv,fw)}}}};fo=function(fr){return function(fu){var fs,ft;if(!bq.FOLDERS_FIRST){return fr(fu)}ft=fr(fu);fs=fu?1:-1;return function(fw,fx){var fv;if(fw.dir^fx.dir){fv=(fw.dir?0:1)-(fx.dir?0:1);return fs*fv}else{return ft(fw,fx)}}}};fl=function(fr){return function(fu){var fs,ft;ft=bq.FILES_BY_NAME(fu);fs=fu?1:-1;return function(fw,fx){var fv;if(fw.is_deleted^fx.is_deleted){return(fw.is_deleted?1:0)-(fx.is_deleted?1:0)}fv=0;if(fr){if(fw.get_category()!==fx.get_category()){fv=fw.get_category()<fx.get_category()?-1:1}else{if(fw.get_extension()!==fx.get_extension()){fv=fw.get_extension()<fx.get_extension()?-1:1}}}else{if(fw.get_extension()!==fx.get_extension()){fv=fw.get_extension()<fx.get_extension()?-1:1}else{if(fw.get_category()!==fx.get_category()){fv=fw.get_category()<fx.get_category()?-1:1}}}return(fs*fv)||ft(fw,fx)}}};return{FILES_BY_NAME:fo(fn),SHARED_WITH:fo(fn),FILES_BY_SIZE:fm(fp),FILES_BY_LOCATION:fm(fq),FILES_BY_KIND:fm(fl(true)),FILES_BY_EXTENSION:fm(fl(false)),FILES_BY_MODIFIED:fm(T),FOLDERS_FIRST:!d5.is_mac(),ALL_BY_MODIFIED:T}})();var dp,bK=[].indexOf||function(fm){for(var fl=0,T=this.length;fl<T;fl++){if(fl in this&&this[fl]===fm){return fl}}return -1};dp=D.FlexColumn=(function(){var fp,fl,fs,fo,fr,fm,T,fn,fq;fp=[{label:"FILES_BY_KIND",func:bq.FILES_BY_KIND,display:eA("Kind"),is_asc:true},{label:"FILES_BY_EXTENSION",func:bq.FILES_BY_EXTENSION,display:eA("Extension"),is_asc:true},{label:"FILES_BY_SIZE",func:bq.FILES_BY_SIZE,display:eA("Size"),is_asc:false}];fr={label:"SHARED_WITH",func:bq.FILES_BY_NAME,display:eA("Shared With"),is_asc:true};fl={};fs={};fm=[];fo=[];for(fn=0,fq=fp.length;fn<fq;fn++){T=fp[fn];fm.push(T.func);fl[T.label]=T.display;fs[T.label]=T.is_asc;fo.push(T.label)}fs[fr.label]=fr.is_asc;return{SORT_FUNCTIONS:fm,DISPLAY:fl,IS_ASC:fs,LABELS:fo,has_label:function(ft){return(bK.call(this.LABELS,ft)>=0)||ft===fr.label},has_sort:function(ft){return bK.call(this.SORT_FUNCTIONS,ft)>=0},next:function(fv,fu){var ft;if(fu==null){fu=false}ft=dp.LABELS.indexOf(fv)+1;if(ft===dp.LABELS.length){if(fu){return fr}else{ft=0}}return fp[ft]}}})();var b9,eC;eC=D.SearchType={COMPLETION:"completion",DELETED:"deleted",FULLTEXT:"full-text"};b9=D.FileSearch={MAX_RESULTS:100,SHORT_PREFIX_LEN:2,SHORT_PREFIX_DELAY_TIME:250,_cache:{},_cache_ts:{},CACHE_TIME:60000,last_state:false,last_fq_path:null,scoped_search:true,last_new_search_ts:{},is_loaded:false,init:function(fy,ft,fu){var fx,fl,fw,fs,fm,fq,fp,fv,T,fr,fo,fn;this.sparky_search_ui_enabled=fy;this.firefly_enabled=ft;this.fulltext_search_enabled=fu;if(this.sparky_search_ui_enabled){return}fs=$("browse-search");fw=$("browse-search-input");ch.add_interval_handler(fs,this.search_with_delay.bind(this));$("advanced-search-box").observe("submit",(function(fz){return function(fA){fz.search();return Event.stop(fA)}})(this));$("exit-search-xclose").observe("click",(function(fz){return function(){return fz.exit_search()}})(this));key("/",cr.KEY_SCOPE,function(){if(O.is_active()){return}if(!fs.hasClassName("focused")){fw.focus();return false}});key("escape",cr.KEY_SCOPE,(function(fz){return function(){if(cr.in_search_mode()){fz.exit_search();return false}if(fw.getValue().strip()===""){fw.blur();return false}}})(this));key("tab",cr.KEY_SCOPE,(function(fz){return function(fA){if(document.activeElement===fw){fA.preventDefault();fw.blur();if(cr.files.length){eX.set_selected_files(cr.files[0])}else{if(cr.in_search_mode()){fz.toggle_advanced()}}return false}}})(this));fm="#advanced-search-link, #advanced-search-exit, #advanced-search-cancel";$(document.body).on("click",fm,this.toggle_advanced.bind(this));bE(document).on(aF.RENAME,(function(fz){return function(){return fz.clear_cache()}})(this));fr=[aF.DELETE,aF.COPY,aF.MOVE,aF.PURGE,aF.RESTORE,aF.UPLOAD,aF.SF_NEW,aF.SF_LEAVE,aF.SF_UNSHARE,aF.SF_REJOIN,aF.SF_IGNORE,aF.LINKS_REMOVE];for(fq=0,fv=fr.length;fq<fv;fq++){fl=fr[fq];fx=(function(fz){return function(fA){if(!cr.inside_dir){return fz.force_reload()}}})(this);document.observe(fl,fx);bE(document).on(fl,fx)}fo=[bD.ADD,bD.MOVE,bD.REMOVE];fn=[];for(fp=0,T=fo.length;fp<T;fp++){fl=fo[fp];fn.push(document.observe(fl,(function(fz){return function(fA){return fz._update_number_results(cr.files.length)}})(this)))}return fn},get_state:function(){var fq,fm,fp,fl,fo,T,fn;fq=bE("#browse-search");if(this.sparky_search_ui_enabled){fp={is_advanced:false}}else{fp={is_advanced:fq.length&&!fq.visible()}}if(fp.is_advanced){fn=["all_terms","any_terms","excluded_terms","exact"];for(fo=0,T=fn.length;fo<T;fo++){fm=fn[fo];fl=bE("#"+fm).val();if(fl){fp[fm]=fl}}fp.include_files=bE("#include_files").prop("checked");fp.include_folders=bE("#include_folders").prop("checked");fp.include_deleted=!Constants.can_see_trash&&bE("#include_deleted").prop("checked")}else{fp.query_unnormalized=this.get_basic_query();fp.query=fp.query_unnormalized.toLowerCase().strip().split(RegExp(" +")).join(" ");if(this.sparky_search_ui_enabled){fp.last_fq_path=this.last_fq_path!=null?this.last_fq_path:""}}return fp},set_state:function(fo){var fl,fn,T,fm;if(fo.is_advanced){fm=["all_terms","any_terms","excluded_terms","exact"];for(fn=0,T=fm.length;fn<T;fn++){fl=fm[fn];if(fo[fl]){$(fl).setValue(fo[fl])}}bE("#include_files").prop("checked",fo.include_files);bE("#include_folders").prop("checked",fo.include_folders);if(!Constants.can_see_trash){bE("#include_deleted").prop("checked",fo.include_deleted)}this.show_advanced();return this.search()}else{if(this.sparky_search_ui_enabled){this.last_fq_path=fo.last_fq_path!=null?fo.last_fq_path:"";this.scoped_search=this.last_fq_path!=="";cr.inside_dir=this.scoped_search}this.set_basic_query(fo.query_unnormalized);this.show_basic();if(this.sparky_search_ui_enabled){return this.do_search(false,true)}else{return this.search()}}},state_changed:function(){var fl,T;fl=this.get_state();T=this.last_state;if(this.sparky_search_ui_enabled){if(T===false){return !!fl.query}return(fl.is_advanced!==T.is_advanced)||(fl.query!==T.query)||(fl.last_fq_path!==T.last_fq_path)}else{if(T===false){return !!fl.query}return(fl.is_advanced!==T.is_advanced)||(fl.query!==T.query)}},get_basic_query:function(){return this._get_browse_search_input().val()},set_basic_query:function(T){if(T===this.get_basic_query()){return}this._get_browse_search_input().val(T);if(!this.sparky_search_ui_enabled){$("browse-search").show()}return $("advanced-search-link").__date(eA("Advanced search"))},set_title:function(){var T,fl;T=this.get_state();fl=eA("Search - Dropbox");if(T.query_unnormalized){fl=""+T.query_unnormalized+" - "+fl}return document.title=fl},_pending_search_q:"",search_with_delay:function(){var fl,fm,T;fm=this.search.bind(this);T=this.get_state();if(T.is_advanced){return}fl=T.query;if(fl.length===0&&cr.in_search_mode()){fm();return}if(fl.length<=this.SHORT_PREFIX_LEN){if(fl!==this._pending_search_q){this._pending_search_q=fl;clearTimeout(this._pending_search_timer);return this._pending_search_timer=setTimeout(fm,this.SHORT_PREFIX_DELAY_TIME)}}else{this._pending_search_q="";if(this.state_changed()){return fm()}}},_set_scope_path_to_browse_location:function(){if(cr.inside_dir){return this.last_fq_path=cr.containing_fq_path()}else{return this.last_fq_path=""}},do_search:function(fm,T){var fo,fp,fn,fl;if(T==null){T=false}if(typeof cr.entered_search==="function"){cr.entered_search()}fl=!T&&!cr.in_search_mode();if(this.sparky_search_ui_enabled&&fl){this._set_scope_path_to_browse_location()}fn=this.get_state();fp=""===this.get_basic_query();if(!fn.is_advanced&&fp){if(cr.in_search_mode()){this._clear_on_reload=false;this.exit_search()}return}this.last_state=fn;this._clear_on_reload=true;if(!(cr.in_search_mode()&&!this.sparky_search_ui_enabled)){eX.deselect_all();cr.clear();a5.set_special_mode("search");if(!this.sparky_search_ui_enabled){this._set_scope_path_to_browse_location()}this.scoped_search=this.last_fq_path!=="";if(!T){fo=null;if(this.sparky_search_ui_enabled){eD.push_state("/search/"+cr.active_user.role,fn)}else{eD.push_state("/search")}}}this._prune_cache();this.set_title();if(fn.is_advanced){this.ask_server_advanced()}else{if(this.sparky_search_ui_enabled){this.reset_fulltext_search(this.scoped_search);this.last_new_search_ts=new Date();bE("#fulltext-search-loading").show();this.ask_server("/ajax_fulltext_search",fm,0,this.MAX_RESULTS,false)}else{if(fn.query in this._cache){this.update_results()}else{if(!this.attempt_cache_filter()){this.ask_server("/ajax_search",false)}}}}return eJ("search")},build_search_url:function(T,fl){return eD.construct_url("/search/"+T.role,fl)},search:function(T){if(T==null){T=false}if(T!==this.scoped_search){this.last_state=false}this.scoped_search=this.scoped_search&&T;if(this.sparky_search_ui_enabled&&!this.scoped_search){this.last_fq_path=""}return this.do_search(false)},load_more_results:function(){var T;if(this.sparky_search_ui_enabled&&!this.end_of_results){T=this.search_pos;if(this.end_of_active_results){T=this.deleted_search_pos}return this.ask_server("/ajax_fulltext_search",false,T,this.MAX_RESULTS,this.end_of_active_results)}},firefly_filename_search:function(){return this.do_search(true)},_prune_cache:function(){var fm,fn,fp,fo,fl,T;fm=new Date();fn=[];for(fp in this._cache_ts){if(fm-this._cache_ts[fp]>this.CACHE_TIME){fn.push(fp)}}T=[];for(fo=0,fl=fn.length;fo<fl;fo++){fp=fn[fo];delete this._cache[fp];T.push(delete this._cache_ts[fp])}return T},update_empty:function(){var T;T=eA("No results found");if(this.scoped_search&&this.sparky_search_ui_enabled){T=eA("No results found in '%(path)s'").format({path:ay.filename(this.last_fq_path)})}bE("#noresults-header").text(T);bE("#fulltext-search-all-link").hide();bE("#noresults-directions").toggle(!(this.scoped_search&&this.sparky_search_ui_enabled));return bE("#noresults-search-all-link").toggle(this.scoped_search&&this.sparky_search_ui_enabled)},show_empty:function(){this.update_empty();return $("search-empty").show()},hide_empty:function(){return $("search-empty").hide()},reset_fulltext_search:function(T){eX.deselect_all();cr.clear();cr.reset_state();cr.update_header_status("");this.search_pos=0;this.deleted_search_pos=0;this.end_of_active_results=false;this.end_of_results=false;this.scoped_search=T;return bE("#fulltext-search-all-link").hide()},exit_search:function(){var fo,fl,fn,T,fm;if(cr.in_search_mode()&&this.sparky_search_ui_enabled){fo=[cr.inside_deleted_dir,cr.inside_deleted_sandbox,cr.inside_deleted_shared_folder];if(!bx.any(fo)){cr.deleted_shown=false}}fm=$$("#advanced-search-box .sick-input input");for(fn=0,T=fm.length;fn<T;fn++){fl=fm[fn];fl.setValue("");fl.blur()}this.show_basic();$("browse").removeClassName("pending-search");this.hide_empty();return a3.set_path_url(null,this.last_fq_path,cr.deleted_shown)},clear_cache:function(){this._cache={};return this._cache_ts={}},force_reload:function(){this.clear_cache();return this.search()},create_completion_log_dict:function(fl,fq,fn,fo,fp,T,fm){if(fl==null){fl=null}if(fq==null){fq=null}if(fn==null){fn=null}if(fo==null){fo=null}if(fp==null){fp=null}if(T==null){T=null}if(fm==null){fm=null}if(fl==null){return}if(fq!=null){fl.request_id=fq}if(fn!=null){fl.latency=(new Date().getTime())-fn}if(fo!=null){fl.query_string=fo.query;if((T==null)||T===200){fl.displayed=this.last_state.query===fo.query?true:false}}if(fp!=null){fl.result_count=fp}if((T!=null)&&T!==200){fl.failure_type=T}if(fm!=null){fl.file_nsid=fm.ns_id;fl.file_sjid=fm.sjid}return fl},ask_server:function(fl,fq,fm,fr,fo){var fp,fu,fs,fn,ft,T;T=this.get_state();ft=null;if(this.sparky_search_ui_enabled){fn=new Date();if(fo){ft=eC.DELETED}else{if(fq){ft=eC.COMPLETION}else{ft=eC.FULLTEXT}}}fp={firefly:this.firefly_enabled,infinite_scroll:fm>0?true:false,path_scoped:false,search_type:ft,query_string:T.query};ba.SearchClientActivityLogger.log("query_started",cr.active_user.id,fp);cJ(!T.is_advanced,"expected to be in basic search mode");if(!fm){bE("#web-search-results").html(eA("Searching..."))}bE("#browse").addClass("pending-search");fu={query:T.query};if(this.sparky_search_ui_enabled){if(fm){fu.start=fm}if(fr){fu.max_results=fr}if(fo){fu.deleted=fo}if(this.scoped_search){fu.fq_path=this.last_fq_path}if(!fq){this.last_fulltext_query=T.query}}if(fq){fu.filename_only=true}fs=false;return new Ajax.DBRequest(fl,{no_watch:true,evalJSON:false,parameters:fu,log_timing:true,onSuccess:(function(fv){return function(fx){var fy,fw,fA,fz;if(!cr.in_search_mode()){return}fA=fx.request.parameters.parent_request_id;fy=JSON.parse(fx.responseText);fz=fy.file_info.length;if(fv.sparky_search_ui_enabled){if(T.query===fv.last_fulltext_query&&fn>=fv.last_new_search_ts){fv.search_pos=fv.search_pos+fz;if(fv.end_of_active_results){fv.deleted_search_pos=fv.deleted_search_pos+fz}if(fz<fv.MAX_RESULTS){fv.end_of_results=true&&fv.end_of_active_results;fv.end_of_active_results=true;if(!fv.end_of_results){fs=true}else{bE("#fulltext-search-loading").hide()}}fv.update_results(fy,fs,fA)}}else{fv._cache[T.query]=fy;fv._cache_ts[T.query]=new Date();if(!fv.last_state.is_advanced&&(fv.last_state.query===T.query)){fv.update_results(null,false,fA)}}if(fy.file_info.length>0){fw=fy.file_info[0]}else{fw=null}fp=fv.create_completion_log_dict(fp,fA,fx.request.start_time,T,fz,null,fw);return ba.SearchClientActivityLogger.log("query_completed",cr.active_user.id,fp)}})(this),onFailure:(function(fv){return function(fw){fp=fv.create_completion_log_dict(fp,fw.request.parameters.parent_request_id,fw.request.start_time,T,null,fw.status);return ba.SearchClientActivityLogger.log("query_failed",cr.active_user.id,fp)}})(this),cleanUp:(function(fv){return function(){if(fs){return fv.load_more_results()}else{return bE("#browse").removeClass("pending-search")}}})(this),subject_user:cr.active_user})},ask_server_advanced:function(){var T,fl;fl=this.get_state();T={firefly:this.firefly_enabled,query_string:fl.query};ba.SearchClientActivityLogger.log("query_started",cr.active_user.id,T);cJ(fl.is_advanced,"expected to be in advanced search mode");cJ(!fl.query,"expected advanced search params only");delete fl.is_advanced;$("web-search-results").__date(eA("Searching..."));$("browse").addClassName("pending-search");return new Ajax.DBRequest("/ajax_advanced_search",{no_watch:true,evalJSON:false,parameters:fl,log_timing:true,onSuccess:(function(fm){return function(fo){var fn,fp;if(!cr.in_search_mode()){return}fp=fo.request.parameters.parent_request_id;fm.advanced_results=JSON.parse(fo.responseText);fm.update_results(null,false,fp);if(fm.advanced_results.file_info.length>0){fn=fm.advanced_results.file_info[0]}else{fn=null}T=fm.create_completion_log_dict(T,fo.request.parameters.parent_request_id,fo.request.start_time,fl,fm.advanced_results.file_info.length,null,fn);return ba.SearchClientActivityLogger.log("query_completed",cr.active_user.id,T)}})(this),onFailure:(function(fm){return function(fn){T=fm.create_completion_log_dict(T,fn.request.parameters.parent_request_id,fn.request.start_time,fl,null,fn.status);return ba.SearchClientActivityLogger.log("query_failed",cr.active_user.id,T)}})(this),cleanUp:function(fm){return $("browse").removeClassName("pending-search")},subject_user:cr.active_user})},attempt_cache_filter:function(){var T,fn,fl,fr,fm,fq,fp,fo;fq=this.get_state().query;fr=this._query_to_regex(fq);fl=function(fs){return fr.match(ay.filename(fs.ns_path).toLowerCase())};if(fq.length<=1){return false}for(fm=fp=fo=fq.length-1;fo<=1?fp<=1:fp>=1;fm=fo<=1?++fp:--fp){fn=fq.substr(0,fm).strip();if(fn in this._cache){if(this._cache[fn].file_info.length<this.MAX_RESULTS){T=Object.clone(this._cache[fn]);T.file_info=T.file_info.findAll(fl);this.update_results(T);return true}else{return false}}}return false},_query_to_regex:function(T){return new RegExp(RegExp.escape(T).split(new RegExp(" +")).join(".*"))},update_results:function(fl,T,fp){var fo,fn,fm;if(T==null){T=false}if(fp==null){fp=null}if(!this.sparky_search_ui_enabled){cr.reset_state();cr.reset_sort()}fm=this.get_state();if(!fl&&fm.is_advanced){fl=this.advanced_results}if(!fl){fn="the only way to get to advanced is through basic -- expected last_state to exist and not be advanced!";cJ(this.last_state&&!this.last_state.is_advanced,fn);cJ(this.last_state.query in this._cache,("update() called w/o a cache entry: q="+this.last_state.query)+(fl=this._cache[this.last_state.query]))}cr.update(fl,fp);cr.set_selection_from_fq_paths_or_index(b9);fo=fm.is_advanced?eA("Basic search"):eA("Advanced search");$("advanced-search-link").__date(fo);if(!T){if(this.sparky_search_ui_enabled){this._update_number_results(this.search_pos)}else{this._update_number_results(cr.files.length)}if(cr.files.length){return this.hide_empty()}else{return this.show_empty()}}},_update_number_results:function(fl){var T,fm;if(this.sparky_search_ui_enabled){if(fl===0){T=""}else{if(this.end_of_results){T=this.fulltext_search_enabled?bc("%(num_results)s result in files, folders, and content.","%(num_results)s results in files, folders, and content.",fl).format({num_results:fl}):bc("%(num_results)s result in files and folders.","%(num_results)s results in files and folders.",fl).format({num_results:fl})}else{T=this.fulltext_search_enabled?bc("Over %(num_results)s result in files, folders, and content.","Over %(num_results)s results in files, folders, and content.",fl).format({num_results:fl}):bc("Over %(num_results)s result in files and folders.","Over %(num_results)s results in files and folders.",fl).format({num_results:fl})}}}else{if(fl===0){T=eA("No Results")}else{if(fl>=this.MAX_RESULTS){fl=fl+"+"}T=bc("%(num_results)s result","%(num_results)s results",fl).format({num_results:fl})}}fm=eA("Search")+" - "+T;if(this.sparky_search_ui_enabled){cr.update_header_status(T);fm=eA("Results for '%(query)s'").format({query:this.get_state().query});if(this.scoped_search){fm=eA("Results for '%(query)s' in '%(path)s'").format({query:this.get_state().query,path:ay.filename(this.last_fq_path+"'")})}}bE("#web-search-results").text(fm);if(this.sparky_search_ui_enabled&&this.scoped_search){return bE("#fulltext-search-all-link").show()}},show_advanced:function(){$("browse").addClassName("advanced-search");$("browse-search").hide();$("advanced-search-link").__date(eA("Basic search"));$("advanced-search-box").show();return $("all_terms").focus()},show_basic:function(T){$("browse").removeClassName("advanced-search");$("advanced-search-box").hide();$("advanced-search-link").__date(eA("Advanced search"));if($("browse-search")){$("browse-search").show();if(!T){return $("browse-search-input").focus()}}},toggle_advanced:function(){var T,fl;fl=$("advanced-search-link");fl.toggleClassName("selected");if(fl.hasClassName("selected")){bE("#all_terms").val(this.get_basic_query());return this.show_advanced()}else{T=bE("#all_terms").val();if(T){this.set_basic_query(T);return this.show_basic()}else{return this.exit_search()}}},history_change_handler:function(T,fn){var fo,fl,fm;fl=typeof this._get_browse_search_input().find("input").attr("value")==="string";fm=fl&&!this.is_loaded;if(this.sparky_search_ui_enabled&&fn){this.last_state=fn;this.last_state.is_advanced=false}if(!this.last_state){a3.set_path_url(Constants.root_ns,"");return}if(this.state_changed()||fm){this.set_state(this.last_state)}if(!m.shown()){key.setScope(cr.KEY_SCOPE)}if(eX.get_selected_files().length){fo=eX.get_selected_files()[0].get_div();cr.scrollToWithPadding(fo,fo.getHeight()*2)}return this.is_loaded=true},clear_searchbox:function(){return this._get_browse_search_input().val("")},_get_browse_search_input:function(){return bE("#browse-search-input")}};var ep;ep=D.BrowseKeys={_handlers:{},init:function(){},init_advanced:function(){var fm,T,fl;fl=this.advanced_dict;for(T in fl){fm=fl[T];key(fm.key,cr.KEY_SCOPE,fm.onPress)}this.customize_chart();if(d5.is_mac()&&Prototype.Browser.Gecko){return document.observe("keypress",(function(fn){return function(fo){if(fo.charCode===63&&!B.focus_in_input()){return fn.advanced_dict.help.onPress()}}})(this))}},customize_chart:function(){var fn,fl,fm,T;fn=(d5.is_mac()?".key-windows":".key-macos");fm=0;fl=void 0;T=[];while(true){fl=$("keys-chart").down(fn,fm++);if(!fl){break}T.push(fl.hide())}return T},toggle_chart:function(){if($("keys-chart").style.display==="none"){return this.show_chart()}else{return this.hide_chart()}},show_chart:function(){var T,fl;T=$("keys-chart");T.style.position="fixed";fl=$("browse-sort");if(b9.sparky_search_ui_enabled&&cr.in_search_mode()){fl=$("browse-header-wrapper")}else{if(fl.getStyle("display")==="none"){fl=$("browse-root-actions")}}bE(T).clonePosition(bE(fl),{setHeight:false});T.style.top=fl.cumulativeOffset()[1]+fl.getHeight()+"px";T.setOpacity(0.9);return T.show()},hide_chart:function(){return $("keys-chart").hide()},advanced_dict:{rename:{title:eA("Rename selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"f2",onPress:function(fl,fm){var T;T=eX.get_selected_files();if(T.length){return T.first().edit()}}},"delete":{title:eA("Delete selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"delete, command+backspace, backspace",onPress:function(fn,fo){var T,fm,fl;Event.stop(fn);if(cr.inside_read_only_shared_folder){ae.warning(eA("You don't have permission to delete files in this folder."))}fl=eX.get_selected_files();if(fl.length===1){T=fl.first();if(T.is_deleted){return dC.show_purge(T.fq_path,T.dir)}else{return dC.show_delete(cr.active_user,T.fq_path,T.dir)}}else{if(fl.length>1){fm=a5.profile_files(fl);if(fm.deleted===fl.length){return dC.show_bulk_purge(fl)}else{if(fm.deleted===0){return dC.show_bulk_delete(cr.active_user,fl)}}}}}},help:{title:eA("Show/hide keyboard shorcuts"),key:"shift+/, "+(key.main_modifier())+"+/",onPress:function(){return ep.toggle_chart()}},close_help:{title:eA("Hide keyboard shorcuts"),key:"escape",onPress:function(){return ep.hide_chart()}},up_dir:{title:eA("Up a folder",{comment:"meaning, go from the current folder to its containing (parent) folder. this is one step up only -- the parent, not the root."}),key:"left",onPress:function(){var T,fl;cr.keyboard_nav=true;if(!cr.reloading){if(cr.inside_dir){if(!cr.containing_ns_path()&&cr.containing_ns_id()!==Constants.root_ns){fl=Constants.root_ns;T=ay.normalize(ay.parent_dir(cr.containing_fq_path()))}else{fl=cr.containing_ns_id();T=ay.normalize(ay.parent_dir(cr.containing_ns_path()))}if(cr.containing_ns_path()!==T||cr.containing_ns_id()!==fl){cr.select_fq_paths=[cr.containing_fq_path()];return a3.set_path_url(fl,T)}else{return eX.flicker_selected()}}else{return eX.flicker_selected()}}}},open_file:{title:eA("Open highlighted file"),key:"enter",onPress:function(){var T,fl;fl=eX.get_selected_files();if(fl.length===1){T=fl[0];cr.open_file(T,false,false,Constants.OREF_CONSTANTS.BROWSE_FILE_OPEN)}return false}},open_dir:{title:eA("Open highlighted folder"),key:"right",onPress:function(){var T,fl;cr.keyboard_nav=true;fl=eX.get_selected_files();if(fl.length===1){T=fl[0];if(T.dir){cr.select_index=0;cr.open_folder(T)}else{eX.flicker_selected()}}return false}},undo:{title:eA("Undo recent move/copy/rename/delete"),key:""+(key.main_modifier())+"+z",onPress:function(){W.perform_undo();return false}},search:{title:eA("Search"),key:"/",onPress:function(){bE(document).trigger("db:searchbar:focus");return false}}}};var ag;ag=D.BrowseSharedLink={store_shared_link_info:function(fm,T,fl){if(fm.charAt(0)==="/"){fm=fm.substring(1)}this._shared_link_fq_dir=fm;this._shared_link_file=fl;return this._shared_link_url=T},shared_link_handler:function(T,fl){if(ag._shared_link_url==="/s/"+T||(ag._shared_link_url==="/member_link/"+T&&T.indexOf("fi")===0)){a3.load_browse_view(void 0,encodeURIComponent(ag._shared_link_fq_dir));cr.open_preview(ag._shared_link_file)}else{if(ag._shared_link_url==="/sh/"+T||(ag._shared_link_url==="/member_link/"+T&&T.indexOf("fo")===0)){a3.load_browse_view(void 0,encodeURIComponent(ag._shared_link_fq_dir));if(ag._shared_link_file){cr.open_preview(ag._shared_link_file)}}else{location.reload()}}return ag.highlight_user()},close_shared_link_view:function(){if(window.location.pathname===this._shared_link_url){return a3.set_path_url(null,"/"+this._shared_link_fq_dir)}},highlight_user:function(){if(cr.active_user.role===Constants.ROLE_WORK){bE("#work-nav-item").addClass("selected");return bE("#personal-nav-item").removeClass("selected")}else{bE("#personal-nav-item").addClass("selected");return bE("#work-nav-item").removeClass("selected")}}};var a3;a3=D.BrowseURL={_DEFAULTS:{d:false,select:false,open_preview:false},_get_helper:function(T){var fl;fl=eD.deconstruct_url().qargs;if(T in fl){return !!fl[T]}else{cJ(T in this._DEFAULTS,"bad query param in BrowseURL");return this._DEFAULTS[T]}},get_del:function(){return this._get_helper("d")},ns_to_fq_path:function(T,fm){var fl;if(T!==cr.active_user.root_ns&&(!(T in cr.ns_id_to_mount_point))){T=cr.active_user.root_ns}if(T===cr.active_user.root_ns){return fm}else{fl=cr.ns_id_to_mount_point[T];return fl+fm}},_make_url:function(T,fp,fq){var fr,fo,fl,fn,fm;if(fq==null){fq={}}if(!T){T=cr.active_user.root_ns}cJ(typeof T==="number","expected ns_id as a number");cJ(typeof fp==="string","expected explicit ns_path string");fr=this.ns_to_fq_path(T,fp);fn=F({path:fi.get_browse_root(cr.active_user)+fr});fl=eD.deconstruct_url().qargs;for(fo in fq){fm=fq[fo];if(fo in this._DEFAULTS&&!!fm!==this._DEFAULTS[fo]){fl[fo]=fm}}for(fo in fl){if(!(fo in this._DEFAULTS)){delete fl[fo]}}return eD.construct_url(String(fn),fl)},set_path_url:function(T,fp,fn){var fo,fm,fl;if(!T){T=cr.active_user.root_ns}else{fm=parseInt(T,10);T=!isNaN(fm)?fm:Constants.root_ns}fp=ay.normalize(fp);fl=fn!=null?this._make_url(T,fp,{d:fn?1:0}):this._make_url(T,fp);fo=eD.deconstruct_url(fl);return eD.push_state(fo.path,fo.qargs)},set_del_url:function(T){var fm,fn,fl;fl=eD.deconstruct_url();fm=fl.path;fn=fl.qargs;if(T){fn.d="1"}else{delete fn.d}return eD.push_state(fm,fn)},_first_load:true,_last_ns_dir:null,_last_ns_id:null,load_browse_view:function(T,fn,fl){var fo,fp,fm;if(fl==null){fl=false}key.setScope(cr.KEY_SCOPE);fn=ay.normalize(fn);fm=false;if(!this._first_load){fm=(!cr.inside_dir)||(fn!==this._last_ns_dir)||(T!==this._last_ns_id)||(cr.in_search_mode()&&b9.sparky_search_ui_enabled)}fo=fl!==cr.deleted_shown;cr.deleted_shown=fl;if(this._first_load||fm||fo){cr.reload(T,fn,true)}b9.show_basic(true);this._first_load=false;this._last_ns_dir=fn;this._last_ns_id=T;if(eX.get_selected_files().length){fp=eX.get_selected_files()[0].get_div();if(fp){return cr.scrollToWithPadding(fp,fp.getHeight()*2)}}},history_change_handler:function(fo,fp){var fm,fn,T,fl;if(cr.show_inline_share){cr.reset_browse_exp()}T=fp.ns;fl=fp.d==="1";this.load_browse_view(T,fo,fl);if(fp.preview!=null){fn="/"+F.encode(fp.preview);if(!!fo){fn="/"+fo+fn}fm=cr.find_file(F.decode(fn));if(fm!=null){if(!(m.shown()&&m.file===fm)){return cr.open_preview(fm,Constants.OREF_CONSTANTS.BROWSE_UNKNOWN,true)}}else{ba.UserActivityLogger.log("web","browse_preview_does_not_exist");return eD.replace_state(fi.get_browse_root(cr.active_user))}}else{if(m.shown()){return m.hide()}}},parse_b2_hash:function(fo){var fm,fl,fn,T,fp;T=fo.split(":");if(T.length!==4){return false}fn=T[0];fm=T[2]==="1";fl=T[3];fp=!fl||d5.isNumber(fl);if(!fp){return false}fl=parseInt(fl,10)||Constants.root_ns;return{ns_id:fl,ns_path:fn,deleted:fm}}};var cR;cR=D.BrowseFile=Class.create({initialize:function(fm){var fl,fn,T,fo;fl=ay.filename(fm.fq_path);this.icon=fm.icon;this.filename=fl;this.filename_highlights=(fn=fm.filename_highlights)!=null?fn:[];this.unresolved_comment_count=fm.unresolved_comment_count;this.unseen_comment_count=fm.unseen_comment_count;this.update_caption();this.ns_id=fm.ns_id;this.ns_path=fm.ns_path;this.fq_path=fm.fq_path;this.mount_point=fm.mount_point;this.hash=fm.hash;this.href=fm.href;this.size=fm.size!=="None"?fm.size:"";this.bytes=fm.bytes;this.is_deleted=this.bytes===-1;this.ago=fm.ago;this.ts=fm.ts;this.dir=fm.is_dir?1:0;this.target_ns=fm.target_ns;this.sort_rank=fm.sort_rank;this.sort_key=fm.sort_key||[""];this.sjid=fm.sjid;this.tkey=void 0;this.thumbnail_url_tmpl=fm.thumbnail_url_tmpl;this.large_thumbnail_url_tmpl=fm.large_thumbnail_url_tmpl;this.type=fm.type;this.preview_type=fm.preview_type;if(fm.last_modified_fname){this.last_modified_fname=bU.em_snippet(fm.last_modified_fname,cT)}this.htmlified_link=fm.htmlified_link;this.linkfile_link=fm.linkfile_link;this.direct_blockserver_link=fm.direct_blockserver_link;this.doc_preview_status=fm.doc_preview_status;this.in_root_coll=fm.in_root_coll;this.compressible=fm.compressible;this.user_id=fm.user_id;this.sf_perm_role=fm.sf_perm_role;this.fulltext_search=fm.fulltext_search;this.read_only=fm.read_only?true:false;this.is_read_only_mount=fm.is_read_only_mount?true:false;this.request_id=(T=fm.request_id)!=null?T:null;return this.match_type=(fo=fm.match_type)!=null?fo:"UNKNOWN_MATCH"},track_in_browse:function(){if(!(this.to_key() in cR._file_index)){cr.add_file(this);return cR._file_index[this.to_key()]=this}},is_shared_folder:function(){return this.type===b7.SHARED_FOLDER},could_be_shared_folder:function(){var fm,fn,T,fl;fn=cr.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");fl=cr.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";T=this.target_ns;fm=this.ns_id!==Constants.root_ns;return this.type===b7.FOLDER&&!T&&!fn&&!fl&&!this.is_sandbox()&&(cr.golden_gate_aware||!fm)},is_shared_single_file:function(){var T;T=this.ns_id!==Constants.root_ns;return this.type===b7.FILE&&T},could_be_shared_single_file:function(){var fl,fm,T;fm=cr.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");T=cr.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";fl=this.ns_id!==Constants.root_ns;return this.type===b7.FILE&&!(fl||fm||T)},is_sandbox:function(){return this.type===b7.SANDBOX},video_transcode_url:function(){return bt.video_transcode_url(this.fq_path,this.hash,cr.active_user)},get_div:function(){return $("f_"+(this.to_key()))},rename:function(fo,fq,fm,fn,fp,fr){var fs,T,fl;T=this.fq_path;cr.pre_action_selection=[T];fs=cr.find_file(fo);if(fs){cr.remove_file(fs)}this.filename=ay.filename(fo);this.update_caption();this.fq_path=fo;this.ns_path=fq;this.htmlified_link=fr;this.hash=fm;this.sort_key=fn;this.sort_rank=null;this.last_modified_fname=null;if(!this.dir){fl=this.href.split("/");fl[fl.length-1]=d5.urlquote(this.filename)+("?w="+fm);this.href=fl.join("/");this.icon=fp}else{this.href="/home"+d5.urlquote(fo);if(this.target_ns){cr.ns_id_to_mount_point[this.target_ns]=fo}}if(cr.in_search_mode()&&b9.sparky_search_ui_enabled){this.filename_highlights=[]}cR._file_index[this.to_key()]=this;cr.update_file_pos(this);return bE(document).trigger(aF.RENAME,{old_fq_path:T,file:this})},edit:function(){var fm,T,fn,fl,fo;this.editing=true;cr.selectable();fo=(function(fp){return function(fx){var fr,fq,fu,fz,fw,ft,fA,fy,fv,fs;fs=fx.responseText.evalJSON(true);cJ(fs.new_browse_files.length===1,"No new file data returned.");fu=fs.new_browse_files.first();fz=fu.fq_path;fw=fu.hash;fv=d5.decode_sort_key(fu.sort_key);fA=fu.icon;fy=fu.ns_path;ft=fu.htmlified_link;fr=fs.changesets;fq=eA("Rename complete.");W.notifyWithUndo(fq,fr,dC.do_rollback);fp.rename(fz,fy,fw,fv,fA,ft);eX.set_selected_files([fp]);fp.get_div().smoothScrollIntoView();a5.load_visible_thumbs();return cr.fire_visible_change_callbacks()}})(this);T=F({path:"/cmd/rename"+this.fq_path}).updateQuery(Constants.UID_PARAM_NAME,cr.active_user).toString();fn=b9.sparky_search_ui_enabled&&cr.in_search_mode()?".filename-col":".filename-col a";fm=new Ajax.InPlaceEditor(this.get_div().down(fn),T,{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.filename,cancelIfSame:true,clickToEdit:false,onComplete:(function(fp){return function(){return fp.editing=false}})(this),onFailure:function(){},savingText:eA("Saving..."),ajaxOptions:{job:true,subject_user:cr.active_user,html_in_error_msg:true,progress_text:eA("Renaming..."),method:"POST",onCreate:ae.clear,onSuccess:fo,onUninitialized:cr.unselectable},callback:(function(fp){return function(fq,fr){return{to_path:fr||"",folder:(fp.dir?"yes":"")}}})(this)});fm.enterEditMode();fl=this.get_div().down(".editor_field");if("selectionEnd" in fl&&this.filename.lastIndexOf(".")>-1){return fl.selectionEnd=this.filename.lastIndexOf(".")}},to_key:function(){return""+this.ns_id+"_"+this.sjid},get_category:function(){var fl,T;if(this.dir){if(cr.inside_dir&&cr.containing_fq_path()===""){if(this.filename.toLowerCase()==="public"&&cr.public_folder_enabled){fl="PUBLIC_FOLDER"}}if(fl==null){if(this.type===b7.FOLDER){fl="FOLDER"}else{if(this.type===b7.PACKAGE){fl="FOLDER"}else{if(this.type===b7.TEAM_SHARED_FOLDER){fl="TEAM_SHARED_FOLDER"}else{if(this.type===b7.SHARED_FOLDER){fl="SHARED_FOLDER"}else{if(this.type===b7.SANDBOX){fl="SANDBOX"}else{if(this.target_ns){fl="SHARED_FOLDER"}else{fl="FOLDER"}}}}}}}}if(fl==null){fl=cR.EXTENSION_TO_CATEGORY[this.get_extension()]||"FILE"}T=this.is_deleted?cR.CATEGORY_TO_DELETED_TRANSLATION[fl]:cR.CATEGORY_TO_TRANSLATION[fl];cJ(T,"CATEGORY MISSING FOR "+fl);return T},get_extension:function(){if(this.dir||this.filename.indexOf(".")===-1){return}return ay.file_extension(this.filename).toLowerCase()},is_shmodelable:function(){return !this.is_deleted&&cr.is_shmodelable_path(this.fq_path)},update_caption:function(){var T;T=cr.inside_dir?dl:ck;if(this.unresolved_comment_count>0){T-=aI}return this.caption=bU.em_snippet(this.filename,T)}});cR._CATEGORIES={IMAGE:"bmp cr2 gif ico jpeg jpg nef png psd tif tiff svg svgz",VIDEO:"3gp 3gpp 3gpp2 avi dv flv m2t m4v mkv mov mp4 mpeg mpg mts ts vob wmv",AUDIO:"aif flac m4a m4p mp3 ogg wav wma",DOCUMENT:"ai cdr csv dbxlink doc docx docm eps fla indd keynote numbers otf pages pdf ppt pptx pptm pps ppsx ppsm ps rtf swf txt wpd xls xlsx xlsm",COMPRESSED_FILE:"7z bz2 gz gzip rar tar zip",CODE:"as as3 c coffee cpp cs css cxx h html html java js less php py rb sass scss sh sql vb xhtml xml",DISK_IMAGE:"dmg iso",EXECUTABLE:"exe",SHORTCUT:"lnk",LINK:"url webloc",FONT:"ttf"};cR.EXTENSION_TO_CATEGORY={};cR.CATEGORY_TO_TRANSLATION={FILE:eA("file"),FOLDER:eA("folder"),SHARED_FOLDER:eA("shared folder"),TEAM_SHARED_FOLDER:eA("team folder"),PUBLIC_FOLDER:eA("folder"),IMAGE:eA("image"),VIDEO:eA("video"),AUDIO:eA("audio"),DOCUMENT:eA("document"),COMPRESSED_FILE:eA("archive"),CODE:eA("code"),DISK_IMAGE:eA("disk image"),EXECUTABLE:eA("executable"),SHORTCUT:eA("shortcut"),LINK:eA("link"),FONT:eA("font"),SANDBOX:eA("app folder")};cR.CATEGORY_TO_DELETED_TRANSLATION={FILE:eA("deleted file"),FOLDER:eA("deleted folder"),SHARED_FOLDER:eA("deleted shared folder"),TEAM_SHARED_FOLDER:eA("deleted team folder"),PUBLIC_FOLDER:eA("deleted folder"),IMAGE:eA("deleted image"),VIDEO:eA("deleted video"),AUDIO:eA("deleted audio"),DOCUMENT:eA("deleted document"),COMPRESSED_FILE:eA("deleted archive"),CODE:eA("deleted code"),DISK_IMAGE:eA("deleted disk image"),EXECUTABLE:eA("deleted executable"),SHORTCUT:eA("deleted shortcut"),LINK:eA("deleted link"),FONT:eA("deleted font"),SANDBOX:eA("deleted app folder")};(function(){var fm,fo,fl,fn,T;fn=cR._CATEGORIES;T=[];for(fm in fn){fl=fn[fm];T.push((function(){var fs,fq,fp,fr;fp=fl.trim().split(" ");fr=[];for(fs=0,fq=fp.length;fs<fq;fs++){fo=fp[fs];fr.push(cR.EXTENSION_TO_CATEGORY[fo]=fm)}return fr})())}return T})();cR._file_index={};cR.from_key=function(T){return cR._file_index[T]};cR.from_elem=function(fl){var T;if(!fl){return}T=fl.readAttribute("data-identity");if(T){return cR.from_key(T)}else{return cR.from_elem(fl.up("[data-identity]"))}};var a,eH,ah,e9,bN,dG,bK=[].indexOf||function(fm){for(var fl=0,T=this.length;fl<T;fl++){if(fl in this&&this[fl]===fm){return fl}}return -1};a=INLINE_JS.BrowseActions=D.BrowseActions=Class.create({initialize:function(T){return this._set_files(T)},firefly_logging_helper:function(T){if(cr.in_search_mode()&&T){this._firefly_log_values.action_type=T;return ba.SearchClientActivityLogger.log("result_action",cr.active_user.id,this._firefly_log_values)}},unlisten:function(){},get_action_names:function(){var T;T=this.get_files();if(T.length<2){return this._get_actions_single(T.first())}else{return this._get_actions_multi(T)}},get_files:function(){return this._files},get_action_by_name:function(T){return this.evaluate_action(a.option_dict[T],T)},evaluate_action:function(fm,fl){var fn,fo,T;fn=(function(fp){return function(fr,fq){if((fq!=null)&&(fr==null)){return fq}if(bE.isFunction(fr)){return fr.call(fp)}else{if(fr!=null){return fr}else{return fq}}}})(this);T={icon_href:fm.icon_href,target:fm.target,click_handler:fm.click_handler,type:fm.type,name:fl||fm.name,is_dropdown:!!fm.is_dropdown,icon:fn(fm.icon),text:fn(fm.text),detail_text:fn(fm.detail_text),href:fn(fm.href,""),kind:fn(fm.kind,"icon"),button_label:fn(fm.button_label,fm.text)};if(bE.isFunction(fm.subactions)){T.subactions=fm.subactions.call(this)}else{if(bE.isArray(fm.subactions)){T.subactions=(function(){var fs,fq,fr,fp;fr=fm.subactions;fp=[];for(fs=0,fq=fr.length;fs<fq;fs++){fo=fr[fs];fp.push(this.get_action_by_name(fo))}return fp}).call(this)}else{if(fm.subactions){cJ(0,"subactions must be a function or an array of actions")}}}return T},_set_files:function(fl){var T;this._files=$A(fl);this._log_extras={};if(this.get_files().length>0){T=fl.first();this._log_extras={path:T.fq_path,ns_id:T.ns_id};return this._firefly_log_values={file_nsid:T.ns_id,file_sjid:T.sjid,firefly:b9.firefly_enabled,match_type:T.match_type,position:T.sort_rank,request_id:T.request_id,viewport:"full-view"}}},_get_actions_single:function(fC){var fr,fv,fw,fz,fn,fu,fo,fE,fs,fy,fp,fq,fA,fB,fx,T,fD,ft,fm,fl;fv=[];if(!fC){return[]}fz=cr.public_folder_enabled&&fC.fq_path.toLowerCase().startsWith("/public/");fy=cr.public_folder_enabled&&fC.fq_path.toLowerCase()==="/public";fE=fC.target_ns;fw=fC.ns_id!==Constants.root_ns;fq=fC.type===b7.SHARED_FOLDER;fp=fC.type===b7.SANDBOX;fs=fC.type===b7.PACKAGE;fo=fC.in_root_coll;fu=fC.compressible;if(fC.is_deleted){fv=fv.concat(["restore"]);if(!((ft=cr.permanent_delete_is_disabled_by_ns_id)!=null?ft[fC.ns_id]:void 0)){fv.push("purge")}if(!fC.dir){fv.push("revisions")}}else{fx=(__CONDITIONAL_JS__.UnityFeatures!=null)&&((fm=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fm.is_cached_and_locally_available(fC.ns_id,fC.ns_path):void 0);fA=fx?"open":"download";if(fC.dir){if(fp){fv.push("app_info")}else{if(cr.simple_sharing_enabled){fv.push("share_folder_and_token")}else{if(fq){fv.push("sharing_options")}else{if(!(fw||fE||fz||fy)){fv.push("share")}}}}if(fC.is_shmodelable()&&!cr.simple_sharing_enabled){fv.push("token_share")}fv.push(fA);if(!fy){fv=fv.concat(["delete","rename","move"]);if(!(fs||fE)){fv.push("copy")}}if(cr.can_use_photos_features){if(cr.can_use_photos_features){fv.push("album_from_folder")}}}else{if(fz||cr.public_app_token){fv.push("copy_url")}else{if(cr.simple_sharing_react_member_list_enabled){fv.push("share_folder_and_token")}else{if(fC.is_shmodelable()){fv.push("token_share")}}}fv.push(fA);if(cr.can_show_preview(fC)&&cr.browser_supports_comments){fv.push("comment")}fv=fv.concat(["delete","rename","move","copy","revisions"]);if(fo&&cr.can_use_photos_features){if(cr.photos_experience==="carousel"){fv.push("view_in_carousel")}else{fv.push("view_in_photos")}}if(fu){fv.push("compress")}}if(!cr.simple_sharing_enabled){fB=false;fl=["sharing_options","share","token_share"];for(T=0,fD=fl.length;T<fD;T++){fr=fl[T];fn=fv.indexOf(fr);if(fn>-1){fv.splice(fn,1);fB=true}}if(fC.is_shared_folder()||fC.could_be_shared_folder()){fv.unshift("single_entry_share_dropdown_variant_menu")}else{fv.unshift("single_entry_share_dropdown_variant_token_share_only")}}}return fv},_get_actions_multi:function(fm){var T,fl,fn;if(Constants.send_a_copy_enabled){T=["send_copy","download"]}else{T=["download"]}T=T.concat(["delete","move","copy","restore","purge"]);if(cr.photos_experience==="carousel"){T.push("view_in_carousel")}else{T.push("view_in_photos")}fl=a5.profile_files(fm);if(fl.deleted>0||fl.public_folder>0){T.removeItem("move");T.removeItem("copy");T.removeItem("delete")}if(fl.shared_folders>0){T.removeItem("copy")}if(fl.deleted>0){T.removeItem("send_copy");T.removeItem("delete");T.removeItem("download")}if(!cr.inside_dir){T.removeItem("download")}if(!(fl.deleted===fm.length&&(fl.shared_folders===0||((fl.shared_folders===(fn=fm.length)&&fn===1))))){T.removeItem("restore")}if(!(fl.deleted===fm.length&&fl.can_permanently_delete===fm.length)){T.removeItem("purge")}if(fl.in_root_coll!==fm.length||!cr.can_use_photos_features){T.removeItem("view_in_photos");T.removeItem("view_in_carousel")}return T},_show_appropriate_sharing_modals:function(fl,T){var fm;if((cr.simple_sharing_enabled&&fl.dir)||cr.simple_sharing_react_member_list_enabled){if(d3.get_for_user(cr.active_user).verified_or_show()){eF.createAndShowInbandModalFromBrowseFile(cr.active_user,fl)}return}if(fl.is_shared_folder()){ba.ShmodelUILogger.log_with_target_file("sf_options",T,fl);return r.show_shared_folder_options_modal(fl.fq_path,cr.active_user)}else{if(fl.could_be_shared_folder()){ba.ShmodelUILogger.log_with_target_file("sf_invite",T,fl);return r.show_share_existing_modal(fl.fq_path,cr.active_user)}else{ba.ShmodelUILogger.log_with_target_file("token_share",T,fl);fm=fl.fq_path;cJ(fm,"token_share: expected non-root fq_path");return dv.shmodel(fm,T+"_token_share")}}},get_disabled_action_names:function(){var T,fm,fo,fl,fn;T=false;fn=this.get_files();for(fo=0,fl=fn.length;fo<fl;fo++){fm=fn[fo];T=true;if(!fm.read_only){T=false;break}}if(cr.inside_read_only_shared_folder||T){return["move","rename","delete","restore","purge","upload","new_folder","compress"]}else{return[]}},show_disabled_action_warning:function(T){if(cr.inside_read_only_shared_folder){if(T==="move"){return ae.warning(eA("You don't have permission to move files in this folder."))}else{if(T==="rename"){return ae.warning(eA("You don't have permission to rename files in this folder."))}else{if(T==="delete"){return ae.warning(eA("You don't have permission to delete files in this folder."))}else{if(T==="restore"){return ae.warning(eA("You don't have permission to restore files in this folder."))}else{if(T==="purge"){return ae.warning(eA("You don't have permission to permanently delete files in this folder."))}else{if(T==="upload"){return ae.warning(eA("You don't have permission to upload files into this folder."))}else{if(T==="new_folder"){return ae.warning(eA("You don't have permission to create a new folder in this folder."))}else{if(T==="compress"){return ae.warning(eA("You don't have permision to create a compressed file in this folder."))}else{return ae.warning(eA("You only have permission to view this folder."))}}}}}}}}}else{return ae.warning(eA("You do not have permission to perform the requested action."))}}});Object.extend(a,{PUBLIC_FOLDER_PATH_LENGTH:7,showCopyPublicUrlModal:function(fl){var T,fm;fc.show(a5.append_ellipsis(eA("Copy public link")),ds.fromElm("copy-public-url"),{wit_group:"copy_public_link"});fc.onHide=function(){$("flash_copy_container").remove();delete fc.onHide;return fc.hide()};T=s.clipboard_overlay(fl,bE("#real_copy"),function(){ae.success(eA("Link copied to clipboard!"));return fc.hide()});T.css({zIndex:1001});fm=$("modal-content").down("#public_url");cJ(fm,"Text element not found for copy pulic link");fm.setValue(fl);return fm.select()},shortenPublicLink:function(){var T;d5.shorten_url($F("public_url"),a.updatePublicLink);T=new Element("img",{id:"publink_loading",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif",className:"right"});return $("modal-content").down("a").__date(T)},updatePublicLink:function(fl){var T;$("public_url").setValue(fl);$("public_url").select();$("publink_loading").remove();$("flash_copy_container").remove();T=s.clipboard_overlay(fl,bE("#real_copy"),function(){ae.success(eA("Link copied to clipboard!"));return fc.hide()});return T.css({zIndex:1001})},option_dict:{new_folder:{icon:"folder_add",text:eA("New folder"),click_handler:function(T){return cr.new_folder()}},global_restore:{icon:"restore",text:function(){cJ(cr.inside_deleted_dir,"Global restore from not a deleted dir");if(cr.inside_deleted_shared_folder){return a5.append_ellipsis(eA("Rejoin shared folder"))}else{if(cr.inside_deleted_sandbox){return eA("Restore app folder")}else{return eA("Restore folder")}}},click_handler:function(){var fn,fo,fl,T,fm;fn=cr.containing_fq_path();fl=fn.toLowerCase();if(cr.inside_deleted_sandbox){cJ(cr.old_path_to_ns_id[fl],"Deleted sandbox missing nsid");return bh.restore_sandbox(cr.active_user,fn,cr.old_path_to_ns_id[fl])}else{if(cr.inside_deleted_shared_folder){cJ(cr.old_path_to_ns_id[fl],"Deleted shared folder missing nsid");return r.show_rejoin_modal(cr.active_user,fn,cr.old_path_to_ns_id[fl])}else{fo=F.parse(location.href).setFragment("").toString();T={prev:fo};T[Constants.UID_PARAM_NAME]=cr.active_user;fm=F({path:"/restore"+fn}).updateQuery(T);return window.location.href=String(fm)}}}},restore:{icon:"restore",text:function(){var fl,T;fl=this.get_files();T=a5.profile_files(fl);if(T.shared_folders===fl.length){return a5.append_ellipsis(bc("Rejoin shared folder","Rejoin shared folders",fl.length,{comment:"BUTTON"}))}else{return a5.append_ellipsis(eA("Restore",{comment:"Restore a previously-deleted file"}))}},click_handler:function(){var fm,fp,fl,fq,fo,T,fn;fp=this.get_files();if(fp.length===0){}else{if(fp.length===1){fm=fp.first();if(!fm.is_deleted){return}fq=fm.fq_path;fl=fq.toLowerCase();if(fm.type===b7.SANDBOX){cJ(cr.old_path_to_ns_id[fl],"Restore missing ns");bh.restore_sandbox(cr.active_user,fq,cr.old_path_to_ns_id[fl])}else{if(fm.type===b7.SHARED_FOLDER){cJ(cr.old_path_to_ns_id[fl],"Rejoin missing ns");r.show_rejoin_modal(cr.active_user,fq,cr.old_path_to_ns_id[fl])}else{if(fm.dir){fo=F.parse(location.href).updateQuery({select:fm.filename});T={prev:String(fo)};T[Constants.UID_PARAM_NAME]=cr.active_user;fn=F({path:"/restore"+fm.fq_path}).updateQuery(T);window.location=String(fn)}else{dC.show_undelete(fm)}}}}else{return dC.show_bulk_restore(fp,cr.active_user)}}}},global_share:{icon:"rainbow_16",text:function(){if(cr.inside_shared_folder){return a5.append_ellipsis(eA("Shared folder options",{comment:"BUTTON. please keep this as short as possible."}))}else{if(cr.containing_fq_path()===""){return a5.append_ellipsis(eA("Share a folder",{comment:"BUTTON. this initiates a wizard that lets the user select a folder to share."}))}else{return a5.append_ellipsis(eA("Share this folder",{comment:"BUTTON. this button lets the user share the current folder that they're viewing."}))}}},click_handler:function(fm){var fl,T;fm.preventDefault();if(cr.containing_fq_path()===""){return r.start_wizard_for_user(cr.active_user)}else{if(cr.simple_sharing_enabled){if(d3.get_for_user(cr.active_user).verified_or_show()){fl=cr.inside_shared_folder&&!cr.containing_ns_path();T=fl?cr.containing_ns_id():void 0;return eF.createAndShowInbandModal(cr.active_user,cr.containing_fq_path(),true,T,fl,!cr.inside_shared_folder,cr.containing_sf_perm_role())}}else{if(cr.inside_shared_folder){return r.show_shared_folder_options_modal(cr.containing_mount_point(),cr.active_user)}else{return r.show_share_existing_modal(cr.containing_fq_path(),cr.active_user)}}}}},sharing_options:{icon:"rainbow_16",text:a5.append_ellipsis(eA("Shared folder options",{comment:"BUTTON"})),click_handler:function(fm,T){var fl;fl=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("sf_options",T,fl);return r.show_shared_folder_options_modal(fl.fq_path,cr.active_user)}},share:{icon:"rainbow_16",text:a5.append_ellipsis(eA("Invite to folder",{comment:"BUTTON"})),click_handler:function(fm,T){var fl;fl=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("sf_invite",T,fl);return r.show_share_existing_modal(fl.fq_path,cr.active_user)}},share_folder_and_token:{icon:"rainbow_16",text:a5.append_ellipsis(eA("Share",{comment:"BUTTON"})),click_handler:function(fm,T){var fl;fl=this.get_files().first();return this._show_appropriate_sharing_modals(fl,T)}},revisions:{icon:"s_clock",click_handler:function(){return window.location.href=dC.build_revisions_uri(this.get_files().first().fq_path,cr.active_user)},text:eA("Previous versions",{comment:"BUTTON"})},token_share:{icon:"s_link",text:a5.append_ellipsis(eA("Share link",{comment:"BUTTON"})),click_handler:function(fn,T){var fl,fm;fl=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("token_share",T,fl);fm=fl.fq_path;cJ(fm,"token_share: expected non-root fq_path");return dv.shmodel(fm,T+"_token_share")}},global_token_share:{icon:"s_link",text:a5.append_ellipsis(eA("Share link",{comment:"BUTTON"})),click_handler:function(fl,T){ba.ShmodelUILogger.log("via-global-toolbar");return dv.shmodel(cr.containing_fq_path(),T+"_global_token_share")}},copy_url:{icon:"world_link",text:a5.append_ellipsis(eA("Copy public link",{comment:"BUTTON"})),click_handler:function(fm){var fl,T;fl=this.get_files().first();if(cr.public_app_token){T="/spa/"+cr.public_app_token+fl.ns_path}else{T="/u/"+cr.active_user.id+fl.fq_path.substring(a.PUBLIC_FOLDER_PATH_LENGTH)}return a.showCopyPublicUrlModal(String(new F({scheme:"https",authority:Constants.PUBSERVER,path:T})))}},download:{icon:"download",text:function(){return eA("Download",{comment:"BUTTON"})},click_handler:function(){var fn,fm,T,fq,fs,fr,fo,fl,fp;T=this.get_files();if(T.length===1&&!T[0].dir){fm=T.first();fp=[Constants.protocol,Constants.BLOCK_CLUSTER,fm.fq_path,fm.hash],fr=fp[0],fn=fp[1],fs=fp[2],fq=fp[3];fo={w:fq,dl:1};fl=F({scheme:fr,authority:fn,path:"/get"+fs,query:fo});return window.location=String(fl.updateQuery(Constants.UID_PARAM_NAME,cr.active_user))}else{return dC.do_bulk_download(T)}}},view:{href:function(){var fp,T,fn,fm,fo,fl;T=this.get_files().first();fl=[Constants.protocol,Constants.BLOCK_CLUSTER,d5.urlquote(T.fq_path),T.hash],fo=fl[0],fp=fl[1],fm=fl[2],fn=fl[3];return""+fo+"://"+fp+"/get"+fm+"?w="+fn},icon:"page_white_magnify",text:eA("View file",{comment:"BUTTON"})},ignore:{click_handler:function(){return r.show_ignore_modal(this.get_files().first().fq_path)},icon:"folder_user_delete",text:eA("Permanently remove",{comment:"BUTTON"})},show_del:{click_handler:function(T){return cr.toggle_deleted()},icon:"trash-can",text:eA("Show deleted files",{comment:"BUTTON"})},hide_del:{click_handler:function(T){return cr.toggle_deleted()},icon:"trash-can-open",text:eA("Hide deleted files",{comment:"BUTTON"})},copy:{icon:"copy",text:a5.append_ellipsis(eA("Copy",{comment:"BUTTON"})),click_handler:function(fm){var T,fl;fl=this.get_files();if(fl.length===1){T=fl.first();return dC.show_copy(T.fq_path,T.dir)}else{if(fl.length>1){return dC.show_copy_bulk(fl)}}}},move:{icon:"move_16",text:a5.append_ellipsis(eA("Move",{comment:"BUTTON"})),click_handler:function(fm){var T,fl;fl=this.get_files();if(fl.length===1){T=fl.first();return dC.show_move(T.fq_path,T.dir)}else{if(fl.length>1){return dC.show_move_bulk(fl)}}}},rename:{icon:"rename",text:eA("Rename",{comment:"BUTTON"}),click_handler:function(){return this.get_files().first().edit()}},"delete":{icon:"delete_16",text:a5.append_ellipsis(eA("Delete",{comment:"BUTTON"})),click_handler:function(fm){var T,fl;fl=this.get_files();if(fl.length>1){return dC.show_bulk_delete(cr.active_user,fl)}else{if(fl.length===1){T=fl.first();return dC.show_delete(cr.active_user,T.fq_path,T.dir)}}}},global_purge:{icon:"cancel",text:a5.append_ellipsis(eA("Permanently delete folder")),click_handler:function(){return dC.show_purge(cr.containing_fq_path(),true)}},purge:{icon:"cancel",text:a5.append_ellipsis(eA("Permanently delete",{comment:"BUTTON"})),click_handler:function(fm){var T,fl;fl=this.get_files();if(fl.length===1){T=fl.first();return dC.show_purge(T.fq_path,T.dir)}else{return dC.show_bulk_purge(fl)}}},upload:{icon:"upload_16",text:a5.append_ellipsis(eA("Upload")),click_handler:function(T){return dC.show_upload()}},app_info:{icon:"application_double",text:a5.append_ellipsis(eA("Application info")),click_handler:function(T){return window.location.href="/account/security"}},more_actions:{is_dropdown:true,text:eA("More",{comment:"Show more options"}),click_handler:Prototype.emptyFunction},more_global_actions:{text:eA("More actions"),click_handler:function(){bN.show_secondary();return document.body.observe("click",bN.hide_secondary)}},view_in_photos:{icon:"s_photo",text:function(){return eA("View in Photos")},click_handler:function(){var T;T=this.get_files();return dC.do_bulk_photo_view(T,cr.photos_experience)}},compress:{icon:"s_photo",text:function(){return eA("Compress (experimental)")},click_handler:function(){var T;T=this.get_files();return dC.show_compress_bulk(cr.active_user,T)}},view_in_carousel:{icon:"s_carousel",text:function(){return eA("View in Timeline")},click_handler:function(){var T;T=this.get_files();return dC.do_bulk_photo_view(T,"carousel")}},album_from_folder:{icon:"create-album",text:function(){return eA("Create album")},click_handler:function(){var fl,T;fl=this.get_files();T=fl.first();return dC.create_album_from_folder(T.fq_path,T.filename)}},open:{icon:"open",text:function(){return eA("Open")},click_handler:function(){var T;T=this.get_files().first();return __CONDITIONAL_JS__.UnityFeatures.open_file(T.ns_id,T.ns_path,T.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(fl){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})}},comment:{icon:"s_file_comment",text:function(){return eA("Comment",{comment:"BUTTON"})},click_handler:function(T){var fl;fl=this.get_files().first();return cr.open_preview(fl,T,false,true)}},single_entry_share_dropdown_variant_token_share_only:{icon:"s_rainbow",text:a5.append_ellipsis(eA("Share")),click_handler:function(fm,T){var fl;fl=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("single_entry_share_click",T,fl);return dv.shmodel(fl.fq_path,T)}},single_entry_share_dropdown_variant_menu:{icon:"s_rainbow",text:a5.append_ellipsis(eA("Share")),is_dropdown:true,subactions:["single_entry_share_dropdown_variant_menu_invite_option","single_entry_share_dropdown_variant_menu_token_share_option"],click_handler:function(){},hover_handler:function(fm,T){var fl;fl=this.get_files().first();return ba.ShmodelUILogger.log_with_target_file("single_entry_share_hover",T,fl)}},single_entry_share_dropdown_variant_menu_invite_option:{icon:"user_add",text:a5.append_ellipsis(eA("Invite people to collaborate")),click_handler:function(fp,T){var fm,fn,fo,fl;fm=this.get_files().first();if(fm.is_shared_folder()){if(d3.get_for_user(cr.active_user).verified_or_show()){ba.ShmodelUILogger.log_with_target_file("sf_options",T,fm);fn=new df(cr.active_user,fm.fq_path);return fn.show()}}else{fl=cr.verify_email_after_share_experiment_variant;fo=fl&&fl==="VERIFY_LAST";if(fo){ba.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(fl){ba.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(fo||d3.get_for_user(cr.active_user).verified_or_show()){ba.ShmodelUILogger.log_with_target_file("sf_invite",T,fm);fn=new cn(cr.active_user,{folder_name:fm.fq_path,element_id:"invite-to-new-sf-wizard-modal-"+cr.active_user.id,must_check_verified:fo});return fn.show()}}}},single_entry_share_dropdown_variant_menu_token_share_option:{icon:"s_link",text:a5.append_ellipsis(eA("Send link")),click_handler:function(fm,T){var fl;fl=this.get_files().first();ba.ShmodelUILogger.log_with_target_file("token_share",T,fl);return dv.shmodel(fl.fq_path,T)}}}});ah=D.BrowseActionsContext=Class.create(a,{initialize:function($super,T){$super(T);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");bE("#context-menu-container").off("mouseenter");$("context-menu-container").on("click",".action button",this._click.bind(this));$("context-menu-container").on("contextmenu",".action button",this._click.bind(this));bE("#context-menu-container").on("mouseover","li.primary",this._over.bind(this));bE("#context-menu-container").on("mouseout","li.primary",this._out.bind(this));return bE("#context-menu-container").on("mouseenter",".action button",this._enter.bind(this))},_click:function(fn,fl){var fm,T;fm=fl.readAttribute("data-value");if(bK.call(this.get_disabled_action_names(),fm)>=0){this.show_disabled_action_warning(fm);return false}this.firefly_logging_helper(fm);T=a.option_dict[fm];ba.BrowseActionsContextMenuLogger.log(this.get_files(),fm);if(!T.is_dropdown||fl.hasAttribute("submenu-index")){bn.hide()}fn.preventDefault();T.click_handler.call(this,Constants.OREF_CONSTANTS.BROWSE_COMMENT_CONTEXTMENU,fn,"browse_actions_context");if(fm==="sharing_options"){ba.SharedFolderActivityLogger.log("web","browse_view_options",cr.active_user,this._log_extra,true)}if(fm==="share"){return ba.SharedFolderActivityLogger.log("web","browse_view_share_existing",cr.active_user,this._log_extras,true)}},_reset_all_submenus:function(){return bE("#context-menu-container .hover").removeClass("hover")},_reset_submenu:function(T){return bE(T).removeClass("hover")},_enter:function(fn){var fm,T,fl;fm=bE(fn.currentTarget).data("value");cJ(fm);T=a.option_dict[fm];cJ(T,"Action info is missing for "+fm);return(fl=T.hover_handler)!=null?fl.call(this,fn,"browse_actions_context"):void 0},_over:function(T){if(bE(T.currentTarget).children(".secondary").length){clearTimeout(this.timeoutID);this._reset_all_submenus();return bE(T.currentTarget).addClass("hover")}},_out:function(T){if(bE(T.currentTarget).children(".secondary").length){return this.timeoutID=setTimeout((function(fl){return function(){return fl._reset_submenu(T.currentTarget)}})(this),300)}}});eH=D.BrowseActionsBasic=Class.create(a,{initialize:function($super){var T;T=eX.get_selected_files();$super(T);this._render();return this._listen()},_listen:function(){var T;this.bound_update=this._update.bind(this);this.bound_disable=this._disable.bind(this);this.bound_enable=this._enable.bind(this);this.bound_click=this._click.bind(this);document.observe(eX.UPDATED_EVT,this.bound_update);document.observe(bn.SHOW_EVT,this.bound_disable);document.observe(bn.HIDE_EVT,this.bound_enable);T=$("browse-root-actions");T.stopObserving("click");return T.on("click",".action button",this.bound_click)},unlisten:function(){document.stopObserving(eX.UPDATED_EVT,this.bound_update);document.stopObserving(bn.SHOW_EVT,this.bound_disable);document.stopObserving(bn.HIDE_EVT,this.bound_enable);return $("browse-root-actions").stopObserving("click",this.bound_click)},_update:function(){this._set_files(eX.get_selected_files());return this._render()},_disable:function(){$("browse-root-actions").stopObserving("click");if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").addClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"default"})},_disable_action:function(fm){var fl,T;T="#browse-root-actions #"+fm+"_action_button";fl=bE(T);fl.addClass("disabled");return fl.click((function(fn){return function(fo){fn.show_disabled_action_warning(fm);return false}})(this))},_enable:function(){$("browse-root-actions").stopObserving("click");$("browse-root-actions").on("click",".action button",this._click.bind(this));if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").removeClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"pointer"})},_render:function(){var fL,fE,fG,fw,fI,fM,fO,fD,fF,fz,T,fs,ft,fv,fu,fH,fr,fP,fB,fp,fy,fx,fA,fC,fq,fo,fm,fl,fJ,fN,fK,fn;fs=this.get_files();fG=this.get_action_names();if(!cr.simple_sharing_enabled){fx=["single_entry_share_dropdown_variant_token_share_only","single_entry_share_dropdown_variant_menu"];for(fo=0,fJ=fx.length;fo<fJ;fo++){fE=fx[fo];fu=fG.indexOf(fE);if(fu>-1){fG.splice(fu,1);break}}}fL=13.5;fF="";ft="";if(fs.length===1){fF=bU.em_snippet(fs[0].filename,fL);if(!fs[0].dir&&fs[0].bytes>=0){ft=fs[0].size}}else{if(1<fs.length){fp=a5.profile_files(fs);fH=[];if(fp.files){fr=bc("%d file","%d files",fp.files).format(fp.files);fH.push(fr)}if(fp.folders){fr=bc("%d folder","%d folders",fp.folders).format(fp.folders);fH.push(fr)}fF=d5.nice_list(fH)}}fM=$("browse-root-actions");fI=fM.getLayout().get("width");fv=fM.getStyle("font-size");cJ(fv.endsWith("px"),"Invalid font size "+fv);fv=parseInt(fv,10);fz=new bU(fF).length*fv;fA=new bU(ft).length*fv;fI-=fz+fA;fC=[];fy=[];fI-=30;for(fm=0,fN=fG.length;fm<fN;fm++){fP=fG[fm];fE=this.get_action_by_name(fP);fq=new bU(fE.text).length*fv;fO=fq+16+8+10+9;if(fI>fO){fC.push(fP)}else{if(fy.length===0){fB=fC.pop();fy.push(fB)}fy.push(fP)}fI-=fO}if(fy.length){fC.push("more_actions")}fw=(function(){var fS,fQ,fR;fR=[];for(fS=0,fQ=fC.length;fS<fQ;fS++){fP=fC[fS];fR.push(this.get_action_by_name(fP))}return fR}).call(this);if(fy.length){fw[fw.length-1].subactions=(function(){var fS,fQ,fR;fR=[];for(fS=0,fQ=fy.length;fS<fQ;fS++){fP=fy[fS];fR.push(this.get_action_by_name(fP))}return fR}).call(this)}fD=fg.tmpl("actions_bar_tmpl",{context:this,description:fF,filesize:ft,has_actions:!!fG.length,actions:fw,_:eA,Sprite:cv});$("browse-root-actions").__date(fD);T=this.get_disabled_action_names();fn=[];for(fl=0,fK=T.length;fl<fK;fl++){fE=T[fl];fn.push(this._disable_action(fE))}return fn},_click:function(fn,fl){var fm,T;fm=fl.readAttribute("data-value");cJ(fm);this.firefly_logging_helper(fm);T=a.option_dict[fm];cJ(T,"Action info is missing for "+fm);fn.preventDefault();T.click_handler.call(this,Constants.OREF_CONSTANTS.BROWSE_COMMENT_BUTTON,fn,"browse_actions_basic");if(fm==="sharing_options"){ba.SharedFolderActivityLogger.log("web","browse_view_select_folder_options",cr.active_user,this._log_extras,true)}if(fm==="share"){return ba.SharedFolderActivityLogger.log("web","browse_view_select_share_existing",cr.active_user,this._log_extras,true)}}});Object.extend(eH,{STANDARD_ACTIONS:["share","sharing_options","app_info","token_share","copy_url","download","delete","rename","restore","purge","view_in_photos","view_in_carousel","compress"]});e9=D.GlobalActions=Class.create(a,{initialize:function($super){return $super()},get_action_names:function(){var T;if(!cr.inside_dir){return[]}T=[];if(!cr.inside_deleted_dir){T=T.concat(["upload","new_folder"]);if(this._should_show_shared_folder_options()){T.push("global_share")}if(this._should_show_share_link()){T.push("global_token_share")}if(!Constants.can_see_trash){T.push((cr.deleted_shown?"hide_del":"show_del"))}}else{T=T.concat(["global_restore"])}return T},_should_show_shared_folder_options:function(){return !cr.is_in_subfolder_of_shared_folder()&&!cr.inside_sandbox},_should_show_share_link:function(){return cr.is_shmodelable_path(cr.containing_fq_path())}});bN=D.GlobalActionsBasic=Class.create(e9,{initialize:function($super){$super();this._listen();return this._render()},_listen:function(){$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));document.observe(bn.SHOW_EVT,this._disable.bind(this));return document.observe(bn.HIDE_EVT,this._enable.bind(this))},_render:function(){var fn,fp,fr,fu,fw,T,fl,fq,ft,fs,fo,fv,fm;fp=this.get_action_names();fs=fp.intersect(bN.STANDARD_ACTIONS);fq=fp.without.apply(fp,bN.STANDARD_ACTIONS);if(fq.length===1){fs=fp;fq=[]}if(fq.length){fs.push("more_global_actions")}ft=(function(){var fz,fy,fx;fx=[];for(fz=0,fy=fs.length;fz<fy;fz++){T=fs[fz];fx.push(this.get_action_by_name(T))}return fx}).call(this);fr=(function(){var fz,fy,fx;fx=[];for(fz=0,fy=ft.length;fz<fy;fz++){fn=ft[fz];if(fn.kind==="button"){fx.push(fn)}}return fx})();fl=(function(){var fz,fy,fx;fx=[];for(fz=0,fy=ft.length;fz<fy;fz++){fn=ft[fz];if(fn.kind!=="button"){fx.push(fn)}}return fx})();fu=fg.tmpl("global_actions_tmpl",{context:this,standard_actions:fr.concat(fl),secondary_actions:(function(){var fz,fy,fx;fx=[];for(fz=0,fy=fq.length;fz<fy;fz++){T=fq[fz];fx.push(this.get_action_by_name(T))}return fx}).call(this),Sprite:cv});$("global-actions").__date(fu);bE(document).trigger("db:browse:ga_rendered");fw=this.get_disabled_action_names();fm=[];for(fo=0,fv=fw.length;fo<fv;fo++){fn=fw[fo];fm.push(this._disable_action(fn))}return fm},_disable:function(){$("global-actions").stopObserving("click");$$("#global-actions .action a").invoke("removeClassName","title_bubble");return $$("#global-actions .action a").invoke("addClassName","disabled")},_disable_action:function(fm){var fl,T;T="#global-actions #"+fm+"_button";fl=bE(T);fl.addClass("disabled");return fl.click((function(fn){return function(fo){fn.show_disabled_action_warning(fm);return false}})(this))},_enable:function(){var fn,fo,fm,fl,T;$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));$$("#global-actions .action a").invoke("removeClassName","disabled");$$("#global-actions .action a").invoke("addClassName","title_bubble");fo=this.get_disabled_action_names();T=[];for(fm=0,fl=fo.length;fm<fl;fm++){fn=fo[fm];T.push(this._disable_action(fn))}return T},_click:function(fn,fl){var fm,T;fm=fl.readAttribute("data-value");cJ(fm);T=a.option_dict[fm];cJ(T,"Action info is missing for "+fm);bN.hide_secondary();eX.deselect_all();fn.preventDefault();T.click_handler.call(this,fn,"global_actions_basic");if(fm==="global_share"){if(this._log_extras.path===""){return ba.SharedFolderActivityLogger.log("web","browse_view_share_button",cr.active_user,this._log_extras,true)}else{return ba.SharedFolderActivityLogger.log("web","folder_view_share_button",cr.active_user,this._log_extras,true)}}}});Object.extend(bN,{STANDARD_ACTIONS:["upload","new_folder","global_share","global_token_share","global_restore","global_purge"],show_secondary:function(){var T,fl;fl=$("secondary-actions");T=$("more_global_actions_button");fl.show();return T.addClassName("down")},hide_secondary:function(){var T,fl;fl=$("secondary-actions");if(!fl){return}T=$("more_global_actions_button");fl.hide();return T.removeClassName("down")}});dG=D.GlobalActionsContext=Class.create(e9,{initialize:function($super,T){$super(T);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fn,fl){var fm,T;fm=fl.readAttribute("data-value");if(bK.call(this.get_disabled_action_names(),fm)>=0){this.show_disabled_action_warning(fm);return false}this.firefly_logging_helper(fm);T=a.option_dict[fm];eX.deselect_all();if(!T.is_dropdown){bn.hide()}fn.preventDefault();T.click_handler.call(this,fn,"global_actions_context");if(fm==="global_share"){if(this._log_extras.path===""){return ba.SharedFolderActivityLogger.log("web","browse_view_right_click_share",cr.active_user,this._log_extras,true)}else{if(cr.inside_shared_folder){return ba.SharedFolderActivityLogger.log("web","folder_view_right_click_options",cr.active_user,this._log_extras,true)}else{return ba.SharedFolderActivityLogger.log("web","folder_view_right_click_share",cr.active_user,this._log_extras,true)}}}}});var y;y=D.BrowseClipboard=(function(){var fs,fp,fm,fq,fo,fu,fw,fr,fl,T,ft,fn,fv;fs=0;fp=1;fo=[];fm=null;fv=function(){var fz,fB,fy,fC,fA,fx;if(B.focus_in_input()){return}fy=eX.get_selected_files();if(fy&&fy.length){for(fA=0,fx=fy.length;fA<fx;fA++){fB=fy[fA];if(fB.bytes<0){ae.error(eA("Deleted files cannot be added to the clipboard"));return false}else{if(fB.target_ns){fC=eA("'%(filename)s' cannot be added to the clipboard");fC=fC.format({filename:fB.filename});ae.error(fC);return false}}}fo=fy;fz=fy.length;fC=bc("Added %d item to clipboard","Added %d items to clipboard",fz).format(fz);ae.success(fC);return true}};fu=function(){if(fv()){fm=fs;return false}};fw=function(){if(fv()){fm=fp;return false}};fr=function(fx){var fy;cJ(typeof fx!=="undefined","BrowseClipboard _paste got an undefined path");if(fo.length){fy=fm===fs?dC.do_bulk_copy:dC.do_bulk_move;fy(fo,fx);return true}};fn=function(fx){var fy;if(B.focus_in_input()||cr.in_search_mode()||cr.inside_deleted_dir){return}fy=fr(cr.containing_fq_path());if(fy){return false}};fq=function(){return fo=[]};T=function(fE){var fD,fz,fB,fC,fA,fy,fx;fB=fE.memo.files;for(fC=0,fy=fB.length;fC<fy;fC++){fz=fB[fC];for(fA=0,fx=fo.length;fA<fx;fA++){fD=fo[fA];if(fD.fq_path===fz.fq_path||fD.fq_path.startsWith(fz.fq_path+"/")){fq();return}}}};fl=function(fx){cJ((fx.memo.file!=null)&&(fx.memo.files==null));fx.memo.files=[fx.memo.file];return T(fx)};ft=function(){var fB,fx,fA,fy,fz;bE(document).on(aF.RENAME,(function(fC){return function(fD,fE){fD.memo=fE;return fl(fD)}})(this));fz=[aF.DELETE,aF.MOVE];for(fA=0,fy=fz.length;fA<fy;fA++){fB=fz[fA];document.observe(fB,T)}fx=key.main_modifier();key(""+fx+"+c",cr.KEY_SCOPE,fu);key(""+fx+"+x",cr.KEY_SCOPE,fw);return key(""+fx+"+v",cr.KEY_SCOPE,fn)};return{init:function(){return ft()}}})();var eX,aW,aC;eX=D.BrowseSelection=(function(){var fo,fq,fG,fv,fJ,T,fC,fu,fR,fz,fD,fr,fw,fE,fO,fN,fs,fx,fn,fF,fA,fH,fP,fp,fK,fI,fQ,fM,fL,fB,fT,fm,fy,ft,fl,fS;fL=[];fv=null;fz=null;fu=null;T=[];ft=function(){$$("#browse-files li.browse-file.file-select").invoke("removeClassName","file-select").invoke("removeClassName","file-select-one");eX.get_selected_files().invoke("get_div").findAll(function(fU){return fU}).invoke("addClassName","file-select");if(eX.get_selected_files().length===1){return eX.get_selected_files().invoke("get_div").findAll(function(fU){return fU}).invoke("addClassName","file-select-one")}};fl=function(){if(fu){return}$$("#browse-files li.browse-file[draggable]").invoke("writeAttribute","draggable",false);if(cr.in_search_mode()&&b9.sparky_search_ui_enabled){return}return eX.get_selected_files().filter(function(fU){return !fU.editing}).invoke("get_div").findAll(function(fU){return fU}).invoke("writeAttribute","draggable","true")};fS=function(fU){fU.apply(null,$A(arguments).slice(1));return document.fire(eX.UPDATED_EVT)};fB=function(fW,fV){var fX,fU;fU=fL.length;fL=(fW instanceof cR?[fW]:$A(fW));if(fL.length!==fU){eJ("Selected",fL.length,"files")}fX=fV||fL.last();cJ(!fX||fX instanceof cR,"Invalid anchor type"+fX);return fv=fX};fB=fB.wrap(fS);fo=function(fV,fU){if(fV){fL.push(fV)}return fv=fU||fV};fo=fo.wrap(fS);fK=function(fU){var fV;fV=fL.indexOf(fU);if(fV===-1){return}return fL.splice(fV,1)};fK=fK.wrap(fS);fI=function(){return fL=[]};fI=fI.wrap(fS);fT=function(fU){T=fU;$$("#browse-files li.browse-file.context-select").invoke("removeClassName","context-select");return fU.invoke("get_div").findAll(function(fV){return fV}).invoke("addClassName","context-select")};fx=function(f3){var f0,fY,fX,fZ,f6,fW,f5,f7,fU,f2,f4,f1,fV;f1=$(f3.target);f7=f1.match("li.browse-file")?f1:f1.up("li.browse-file");f0=f1.match("a")?f1:f1.up("a");fX=cR.from_elem(f7);if(f3.isRightClick()||!f7||f0||f7.hasClassName("unselectable")){return}cr.keyboard_nav=false;if(T.length){return}fW=d5.is_mac();if((fW&&f3.metaKey)||(!fW&&f3.ctrlKey)){if(fL.indexOf(fX)===-1){return fo(fX)}else{return fK(fX)}}else{if(f3.shiftKey){fY=cr.files.indexOf(fv);fV=cr.files.indexOf(fX);f5=cr.files.indexOf(fL.last());f2=fL.slice(0);f6=f5<fY?-1:1;fZ=fY;while(fZ!==f5){fZ+=f6;f4=f2.indexOf(cr.files[fZ]);if(f4!==-1){f2.splice(f4,1)}}f6=fV<fY?-1:1;fZ=fY;while(fZ!==fV){fZ+=f6;fU=f2.indexOf(cr.files[fZ]);if(fU!==-1){f2.splice(fU,1)}f2.push(cr.files[fZ])}return fB(f2,fv)}else{return fB(fX)}}};fn=function(fZ){var f3,fW,f2,f0,fV,fU,fY,fX,f1;if(fZ.isRightClick()||T.length||d5.in_scrollbar(fZ.pointerX())){return}f0=$(fZ.target);if(Element.match(f0,"object")){f0=f0.parentNode}fY=["browse-box","context-menu-container","modal","modal-overlay"];fV=false;for(fX=0,f1=fY.length;fX<f1;fX++){fU=fY[fX];if(f0.descendantOf(fU)||f0.match("#"+fU)){fV=true;break}}if(!fV){fB();return}f2=f0.match("li.browse-file")?f0:f0.up("li.browse-file");fW=cR.from_elem(f2);f3=f0.match("[draggable]")||f0.up("[draggable]");if(fW&&!f3){fz=fv;if(!fZ.shiftKey){if(fW){fz=fW}else{if(f0.match("#browse-files")){fz=cr.files.last()}}}fu=[];if(fZ.metaKey||fZ.ctrlKey){return fu=eX.get_selected_files()}}};fm=function(fW){var fV,fU;fV=cR.from_elem(fN(fW));fW.preventDefault();if(!fV){return}fU="browse_file_row";ba.ShmodelUILogger.log_with_target_file("token_share",fU,fV);return dv.shmodel(fV.fq_path,fU)};fN=function(fV){var fU;fU=$(fV.target);if(fU.match("li.browse-file")){return fU}else{return fU.up("li.browse-file")}};fO=(function(fU){return function(f3){var f6,fW,fV,fX,f5,f4,f1,f7,f2,fZ,f0,fY;f2=cr.sharing_single_file_collaboration&&cr.sharing_single_file_collaboration==="SINGLE_FILE_SHARING";f5=fN(f3);fW=cR.from_elem(f5);f3.preventDefault();if(!fW){return}f4="browse_file_row";f0=ba.ShmodelUILogger.get_target_item(fW);ba.ShmodelUILogger.log("single_entry_share",f4,f0);fX=cr.simple_sharing_enabled;f1=bE(f5).find(".inline-share-button")[0];if(cr.show_shared_with&&!cr.show_inline_share&&!cr.in_search_mode()){f1=bE(f5).find(".sharing .inline-share-button")[0]}fZ=fW.dir&&(fW.is_shared_folder()||fW.could_be_shared_folder());f6=d3.get_for_user(cr.active_user).verified_or_show();if(cr.simple_sharing_react_member_list_enabled&&f6){return eF.createAndShowInbandModalFromBrowseFile(cr.active_user,fW)}else{if(fZ){if(fX){if(f6){return eF.createAndShowInbandModalFromBrowseFile(cr.active_user,fW)}}else{return aC.open(fW.fq_path,fW.is_shared_folder(),f1,cr.active_user,f0)}}else{if(cr.simple_sharing_to_file_enabled&&((fY=__CONDITIONAL_JS__.OpenWith)!=null?fY.file_supported(fW):void 0)){if(f6){return eF.createAndShowInbandModalFromBrowseFile(cr.active_user,fW)}}else{if(f2&&(fW.is_shared_single_file()||fW.could_be_shared_single_file())&&!fX){return aC.open(fW.fq_path,fW.is_shared_single_file(),f1,cr.active_user,f0,fV=true,fW.mount_point)}else{f7=function(){return dv.shmodel(fW.fq_path,f4)};eX.firefly_logging_helper(fW,"single_entry_share_button_file_link");return cw.show_modal(f3,cr.active_user.id,f7)}}}}}})(this);fp=(function(fU){return function(fX){var fW,fV;fV=fN(fX);fW=cR.from_elem(fV);return aW.recipients_click(fW,cr.active_user)}})(this);fs=(function(fU){return function(fX){var fW,fV;fV=fN(fX);fW=cR.from_elem(fV);return aW.link_click(fW,cr.active_user)}})(this);fJ=function(fX){var fV,fU,fW;fW=$(fX.target);fU=fW.match("li.browse-file")?fW:fW.up("li.browse-file");fV=cR.from_elem(fU);if(fV){return fx(fX)}};fE=null;fD=function(){var fU;clearInterval(fE);fU=function(){cr.keyboard_nav=false;return $("browse-files").addClassName("mouse-active")};return fE=setTimeout(fU,100)};fC=function(){if(!cr.keyboard_nav){cr.keyboard_nav=true;return $("browse-files").removeClassName("mouse-active")}};fF=function(f0){var fX,fW,fV,fZ,f2,fU,fY,f1;fD();if(!eX.is_selecting()){return}fX=cr.files.indexOf(fz);fU=cr.files.indexOf(cR.from_elem(f0.target));cJ(fX<cr.files.length&&fX>=0,"anchor_index: "+fX+" "+fz);cJ(fU<cr.files.length&&fU>=0,"target_index: "+fU);fW=cr.files.slice(Math.min(fX,fU),Math.max(fX,fU)+1);fV=fu.slice(0);for(fY=0,f1=fW.length;fY<f1;fY++){f2=fW[fY];fZ=fV.indexOf(f2);if(fZ===-1){fV.push(f2)}else{fV.splice(fZ,1)}}return fB(fV)};fR=function(fU){fz=null;return fu=null};fP=function(fW){var fU,fV;if(typeof O!=="undefined"&&O!==null){O.reset()}fC();if(fW){Event.extend(fW).preventDefault()}fV=fL.length?fL.last()===cr.files.first()?cr.files.first():(fU=cr.files.indexOf(fL.last())-1,cr.files[fU]):cr.files.last();fB(fV);if(fV){return cr.scrollTo(fV.get_div())}};fA=function(fW){var fU,fV;if(typeof O!=="undefined"&&O!==null){O.reset()}fC();if(fW){Event.extend(fW).preventDefault()}fV=fL.length?fL.last()===cr.files.last()?cr.files.last():(fU=cr.files.indexOf(fL.last())+1,cr.files[fU]):cr.files.first();fB(fV);if(fV){return cr.scrollTo(fV.get_div())}};fG=function(f2){var fU,fV,f0,f1,fX,fY,fZ,fW;if(typeof O!=="undefined"&&O!==null){O.reset()}fC();if(f2){Event.extend(f2).preventDefault()}if(fL.length>0){f1=cr.files.indexOf(fL.last());fU=cr.files.indexOf(fv);if(fv===fL.last()||fU>f1){if(f1>0){fW=[];for(f0=fY=fZ=f1-1;fZ<=0?fY<=0:fY>=0;f0=fZ<=0?++fY:--fY){fV=cr.files[f0];fX=fL.indexOf(fV);fo(fV,fv);if(fX!==-1){fW.push(fL.splice(fX,1))}else{cr.scrollTo(fV.get_div());break}}return fW}}else{fK(fL.last());return cr.scrollTo(fL.last().get_div())}}else{return fP()}};fq=function(f3){var fU,fV,f1,f2,fY,fZ,f0,fX,fW;if(typeof O!=="undefined"&&O!==null){O.reset()}fC();if(f3){Event.extend(f3).preventDefault()}if(fL.length>0){f2=cr.files.indexOf(fL.last());fU=cr.files.indexOf(fv);if(fv===fL.last()||fU<f2){fW=[];for(f1=fZ=f0=f2+1,fX=cr.files.length;f0<=fX?fZ<fX:fZ>fX;f1=f0<=fX?++fZ:--fZ){fV=cr.files[f1];fY=fL.indexOf(fV);fo(fV,fv);if(fY!==-1){fW.push(fL.splice(fY,1))}else{cr.scrollTo(fV.get_div());break}}return fW}else{fK(fL.last());return cr.scrollTo(fL.last().get_div())}}else{return fA()}};fQ=function(){if(typeof O!=="undefined"&&O!==null){O.reset()}fB(cr.files);return false};fM=function(){if(typeof O!=="undefined"&&O!==null){O.reset()}return fB(null,null,null)};fw=function(){$$(".file-select").invoke("removeClassName","file-select").invoke("removeClassName","file-select-one");return setTimeout(ft,100)};fH=function(fU){return fU.memo.files.each(function(fV){var fW;fW=fL.indexOf(fV[0]);if(fW!==-1){fL.splice(fW,1);return fo(fV[1])}})};fr=function(fU,fV){var fW;if(cr.in_search_mode()&&fU&&fV){fW={file_nsid:fU.ns_id,file_sjid:fU.file_sjid,firefly:b9.firefly_enabled,match_type:fU.match_type,position:fU.sort_rank,request_id:fU.request_id,viewport:"full-view",action_type:fV};return ba.SearchClientActivityLogger.log("result_action",cr.active_user.id,fW)}};fy=function(fV,fU,fW,fY,f2){var f1,f0,fZ,fX;f0="file_row_sharing_menu";if(fU){if(d3.get_for_user(fV).verified_or_show()){ba.ShmodelUILogger.log("sf_options",f0,fW);fr("single_entry_share_button_folder_options");f1=new df(fV,fY);if(typeof f2==="function"){f2()}return f1.show()}}else{fX=cr.verify_email_after_share_experiment_variant;fZ=fX&&fX==="VERIFY_LAST";if(fZ){ba.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(fX){ba.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(fZ||d3.get_for_user(fV).verified_or_show()){ba.ShmodelUILogger.log("sf_invite",f0,fW);fr("single_entry_share_button_folder_invite");f1=new cn(fV,{folder_name:fY,element_id:"invite-to-new-sf-wizard-modal-"+fV.id,must_check_verified:fZ});if(typeof f2==="function"){f2()}return f1.show()}}};document.observe(bD.REMOVE,function(fU){return fU.memo.files.each(fK)});document.observe(bD.MOVE,fH);return{UPDATED_EVT:"db:select:updated",init:function(){var fU;document.observe("click",fJ);document.observe("mousedown",fn);document.observe("mouseup",fR);document.observe("dragend",fR);document.observe("mouseup",fl);$("browse-files").on("mouseover","li.browse-file",fF);$("browse-files").on("click",".shmodel-file",fm);$("browse-files").on("click",".inline-share-button",fO);$("browse-files").on("click",".more-link",fO);document.observe(eX.UPDATED_EVT,ft);document.observe(eX.UPDATED_EVT,fl);document.observe(cr.RENDER_EVT,ft);document.observe(cr.RENDER_EVT,fl);document.observe(cr.UPDATE_EVT,fB.bind(null,null,null));fU=key.main_modifier();key("up",cr.KEY_SCOPE,fP);key("down",cr.KEY_SCOPE,fA);key(fU+"+a",cr.KEY_SCOPE,fQ);key("escape",cr.KEY_SCOPE,fM);key("shift+up",cr.KEY_SCOPE,fG);return key("shift+down",cr.KEY_SCOPE,fq)},set_selected_files:function(fU){return fB(fU)},get_selected_files:function(){return fL.slice(0)},get_selected_fq_paths:function(){return fL.map(function(fU){return fU.fq_path})},has_selected_files:function(){return fL.length},is_selected:function(fU){return fL.indexOf(fU)!==-1},is_selecting:function(){return !!fz},deselect_all:fI,set_context_selected:function(fU){return fT(fU)},flicker_selected:fw,firefly_logging_helper:function(fU,fV){return fr(fU,fV)},show_share_modal_if_email_verified:fy,recipients_click:function(fU){return fp(fU)},link_click:function(fU){return fs(fU)}}})();aC=D.SharingGrowthExperimentsDropdown={open:function(fp,fm,fn,fl,fq,fr,fo){var T;this.fq_path=fp;this.existing_sf=fm;this.button=fn;this.user=fl;this.target_item=fq;this.is_file=fr;this.mount_point=fo;this.$menu=bE("#sharing-growth-experiments-dropdown-menu");T=this.$button&&this.$button.length;if(T){if(this.$button[0]===this.button){this._hide();return}else{this._hide()}}return this._show()},_show:function(){var T;this.$menu.show();this.$button=bE(this.button);this.$button.addClass("pressed");if(cr.show_inline_share){this.$button.parent(".sharing-actions").addClass("pressed")}T={offsetLeft:-1*Math.abs(this.$button.outerWidth()-this.$menu.outerWidth())+6,offsetTop:46,setWidth:false,setHeight:false};B.clone_position(this.$menu,this.$button,T);bE("#browse-box").addClass("dropdown-menu-open");if(this.is_file){this._add_share_file_logging("single_file_shared_entry_button_displayed","single_file_unshared_entry_button_displayed")}return this._listen()},_listen:function(){this.$menu.on("click dblclick",function(T){return T.stopPropagation()});bE(document).on("mousedown",bE.proxy(this._click_outside_menu_callback,this));this.$menu.find(".option-to-share-folder").on("click",bE.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").on("click",bE.proxy(this._share_link_click,this))},_unlisten:function(){this.$menu.hide().off("click dblclick");bE(document).off("mousedown",this._click_outside_menu_callback);this.$menu.find(".option-to-share-folder").off("click",bE.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").off("click",bE.proxy(this._share_link_click,this))},_add_share_file_logging:function(fm,fn){var fl,T;T={path:this.fq_path};fl=this.existing_sf?fm:fn;return ba.SharedFolderActivityLogger.log("web",fl,this.user,T)},_sf_click:function(fl){var T;T=(function(fm){return function(){var fn;if(fm.is_file){if(d3.get_for_user(fm.user).verified_or_show()){fm._add_share_file_logging("single_file_shared_collaboration_clicked","single_file_unshared_collaboration_clicked");if(fm.existing_sf){fn=new d6(fm.user,{folder_name:ay.filename(fm.mount_point),folder_path:fm.mount_point,element_id:"confirm-share-existing-file-wizard-modal"})}else{fn=new cn(fm.user,{folder_name:fm.fq_path,is_file:true,element_id:"invite-to-new-share-file-wizard-modal-"+fm.user.id})}return fn.show()}}else{return eX.show_share_modal_if_email_verified(fm.user,fm.existing_sf,fm.target_item,fm.fq_path)}}})(this);this._hide();return cw.show_modal(fl,this.user.id,T)},_share_link_click:function(fl){var T;T=(function(fm){return function(){var fn;fn="file_row_sharing_menu";ba.ShmodelUILogger.log("token_share",fn,fm.target_item);fm._firefly_logging_helper("single_entry_share_button_folder_link");dv.shmodel(fm.fq_path,fn);if(fm.is_file){return fm._add_share_file_logging("single_file_shared_link_clicked","single_file_unshared_link_clicked")}}})(this);this._hide();return cw.show_modal(fl,cr.active_user.id,T)},_firefly_logging_helper:function(T){return eX.firefly_logging_helper(cr.find_file(this.fq_path),T)},_clicked:function(T,fl){return T.is(fl.target)||T.has(fl.target).length},_click_outside_menu_callback:function(T){if(!(this._clicked(this.$menu,T)||this._clicked(this.$button,T))){return this._hide()}},_hide:function(T){this._unlisten();bE("#browse-box").removeClass("dropdown-menu-open");this.$button.removeClass("pressed");if(cr.show_inline_share){this.$button.parent(".sharing-actions").removeClass("pressed")}return this.$button=null}};aW=D.SharingGrowthExperimentsAutocomplete={init:function(){return this.autocomplete=new Autocompleter.ContactsTokenizer(cr.active_user,"growth-browse-inline-new-collab-input","growth-browse-inline-new-whobulk","growth-browse-inline-hidden-input",{tokens:[",",";"],include_fb:false,include_team:false,hide_import_contacts:false,suggestions_disabled:true})},recipients_click:function(fl,T){var fm;this.file=fl;this.user=T;this.mode="recipients";this._activate();this.$sharing_actions.find(".get-link").hide();this.$sharing_actions.find(".send-button").show();fm=this._autocomplete_div();this.$sharing_actions.prepend(fm);fm.show();this.autocomplete.dynamically_resize_input();bE(this.autocomplete.element).val("");this.autocomplete.clearTokens();bE(this.autocomplete.get_entry_container()).hide();bE(this.autocomplete.element).focus();return false},link_click:function(fm,fl){var T;this.file=fm;this.user=fl;if(!d3.get_for_user(this.user).verified_or_show(et.SHMODAL)){return}T="file_row_sharing_menu";ba.ShmodelUILogger.log("token_share",T,this.target_item);return dv.shmodel(this.file.fq_path,T)},_activate:function(){this.$sharing_div=bE(this.file.get_div()).find(".sharing");this.$sharing_actions=this.$sharing_div.find(".sharing-actions");this.$sharing_actions.find(".recipients").hide();this.$sharing_div.addClass("pressed");bE("#browse-box").addClass("dropdown-menu-open");return this._listen()},_send:function(){var fl,fq,fr,ft,fw,fn,fm,fo,fs,fv,fp,T,fu;this.sharing_api=new bl(this.user);this.autocomplete.tokenize_emails_input(true);ft=this.emails=this.autocomplete.getEmails().split(", ");fw=this.file.fq_path;T={emails:ft};fr="";fq="";fl="";fo=this.file.target_ns;fm="";fu="";fl="";fn=false;this._hide();fv=(function(fx){return function(){return fx._complete(eA("Sent!"),"success")}})(this);fs=(function(fx){return function(fC){var fB,fA,fz,fy;fy=fC.responseText.substr(4);if(fy[0]==="{"){fB=JSON.parse(fy);if(fB.emails){fA=fB.emails["message_text"]}if(fB.path){fA=fB.path["message_text"]}}else{fA=fy}if(!fA){fA="Unknown"}fz=eA("Error: %(msg)s").format({msg:fA});return fx._complete(fz,"error")}})(this);if(!d3.get_for_user(this.user).verified_or_show(et.SHMODAL)){return}fp=this.file.read_only||this.file.is_read_only_mount;if(this.file.is_shared_folder()&&!fp){return this.sharing_api.invite_more_to_folder(fo,T,fr,fl,fv,fs)}else{if(this.file.could_be_shared_folder()&&!fp){return this.sharing_api.share_folder(false,fw,T,fr,fq,fm,fu,fl,fn,fv,fs)}else{return this._get_shmodel_link(function(fy){var fx;fx=F.parse(fy);return cC.WebRequest({url:"/sm/share",data:{emails:ft,shmodel_path:fx.path},subject_user:cr.active_user.id,success:fv,error:fs})})}}},_get_shmodel_link:function(T){return cC.WebRequest({url:"/growth/find_or_create_shmodel_link",data:{path:this.file.fq_path},subject_user:cr.active_user.id,dataType:"json",success:(function(fl){return function(fm){if(fm.error!=null){return fl._complete(eA("Error"),"error")}else{return T(fm.shmodel_link)}}})(this),error:(function(fl){return function(){return fl._complete(eA("Error"),"error")}})(this)})},_complete:function(fl,fq){var T,fp,fr,fs,fn,fo,fm;this.$sharing_div.addClass("complete");T=this.$sharing_div.find(".sharers");if(fq==="success"&&this.emails){fo=bc("Sent to %(number)d person","Sent to %(number)d people",this.emails.length).format({number:this.emails.length});ae.success(fo);fp=T.text();if(fp==="--"){fp=""}if(fp.length===""||fp.length+this.emails.join(", ").length<28){fr=[];fm=0;fn=0;while(fn<this.emails.length&&fm+this.emails[fn].length<(30-fp.length)){fr.push(this.emails[fn]);fm+=this.emails[fn].length;fn++}if(this.emails.length>fr.length){fr.push("+"+(this.emails.length-fr.length))}if(fp!==""){fr.push(fp)}fs=fr.join(", ");T.text(fs)}}else{if(fq==="error"){ae.error(fl)}}return setTimeout(this._removeComplete,2000)},_removeComplete:function(){return bE("div.sharing.complete").removeClass("complete")},_autocomplete_div:function(){return bE("#browse-inline-autocomplete")},_listen:function(){if(this.mode==="recipients"){this._autocomplete_div().on("click dblclick",function(T){return T.stopPropagation()});this.$sharing_actions.find(".send-button").on("click",bE.proxy(this._send,this))}return bE(document).on("mousedown",bE.proxy(this._click_outside_autocompleter_callback,this))},_unlisten:function(){if(this.mode==="recipients"){this._autocomplete_div().off("click dblclick");this.$sharing_actions.find(".send-button").off("click",bE.proxy(this._send,this))}return bE(document).off("mousedown",this._click_outside_autocompleter_callback)},_click_outside_autocompleter_callback:function(T){if(!(this.$sharing_actions.is(T.target)||bE(T.target).parents(".sharing-actions").length)){return this._hide()}},_hide:function(T){var fl;this._unlisten();bE("#browse-box").removeClass("dropdown-menu-open");this.$sharing_actions.find(".recipients, .get-link").show();this.$sharing_actions.find(".send-button, .link-field").hide();this.$sharing_div.removeClass("pressed");fl=this._autocomplete_div().hide();return bE("#browse-sort").append(fl)}};var A;A=D.DragScroll={_timer:null,_mouse_y:0,_initial_mouse_y:null,_scroll_amount:40,_scroll_window:50,_min_drag_distance:20,_exclude_move_event:null,init:function(T,fl){this._exclude_move_event=T;if(fl!=null){return this._scroll_window=fl}},start:function(){this._initial_mouse_y=null;this._listen();return this._timer=setInterval(this._check_for_scroll.bind(this),100)},end:function(){this._unlisten();return clearInterval(this._timer)},_mousemove:function(fl){var T;if(typeof this._exclude_move_event==="function"?this._exclude_move_event(fl):void 0){return this._mouse_y=0}else{T=fl.pointerY();return this._mouse_y=T-B.scroll_offsets().top}},_listen:function(){document.observe("mousemove",this._mousemove.bind(this));return document.observe("dragover",this._mousemove.bind(this))},_unlisten:function(){document.stopObserving("mousemove",this._mousemove.bind(this));return document.stopObserving("dragover",this._mousemove.bind(this))},_check_for_scroll:function(){var T;if(this._initial_mouse_y===null){this._initial_mouse_y=this._mouse_y}if(Math.abs(this._mouse_y-this._initial_mouse_y)<this._min_drag_distance){return}T=0;if(this._mouse_y<this._scroll_window){T=-1*this._scroll_amount}else{if(this._mouse_y>B.viewport_dimensions().height-this._scroll_window){T=this._scroll_amount}}if(T){return B.scroll_to(B.scroll_offsets().left,B.scroll_offsets().top+T)}}};var bR;bR=D.BrowseDrag={_BODY_DRAG_CLASS:"external_drag",_STATUS_CLASS:"dragging",_STATUS_OFFSET:10,_SELECTION_CONST:"SELECTION",_current_item_key:null,_drag_from_window:false,init:function(){var T;if(!Modernizr.draganddrop){return}this.listen();T=function(fm){var fl;fl=bE(fm.target);return fl.closest("#browse-location").length||fl.attr("id")==="browse-location"};return A.init(T,bE("#browse-header").height())},listen:function(){var T;T=$(document.body);document.observe(cr.UPDATE_EVT,this._update_body_data.bind(this));T.on("dragleave","[dropzone]",this._dropzone_dragleave.bind(this));T.on("dragend",this._body_dragend.bind(this));T.on("dragover","[dropzone]",this._dropzone_dragover.bind(this));if(Prototype.Browser.IE){T.on("dragenter","[dropzone]",this._dropzone_dragover.bind(this));T.on("mousedown",this._ie_start_drags.bind(this));T.on("mouseover","a.filename-link",this._ie_mouseover.bind(this))}T.observe("dragover",this._body_dragover.bind(this));T.observe("dragleave",this._body_dragleave.bind(this));T.observe("dragstart",this._body_dragstart.bind(this));T.observe("mousemove",this._body_mousemove.bind(this));T.on("dragstart","li.browse-file",this._file_dragstart.bind(this));document.observe(eX.UPDATED_EVT,this._build_selected_drag_icon.bind(this));document.observe(cr.RENDER_EVT,this._build_selected_drag_icon.bind(this));T.on("mousedown","li.browse-file",this._build_file_drag_icon.bind(this));return T.on("drop","[dropzone]",this._drop.bind(this))},_file_mousemove:function(fl){var T;if(!window.event||window.event.button!==1){return}T=fl.findElement("[draggable]");if(T&&T!==document&&T.dragDrop){T.dragDrop();return bR._ie_end_drags()}},_ie_start_drags:function(T,fl){if(fl.tagName!=="OBJECT"&&$(fl).match("[draggable]")){return $("browse-files").observe("mousemove",this._file_mousemove)}},_ie_end_drags:function(){return $("browse-files").stopObserving("mousemove")},_update_body_data:function(){var fl,T;fl=cr.inside_dir?"copy move":false;T=cr.inside_dir?cr.containing_fq_path():false;$(document.documentElement).writeAttribute("dropzone",fl);return $(document.documentElement).writeAttribute("data-fq_path",T)},_body_dragover:function(fl){var T;T=this._get_event_browse_files();if(T.length){return this._update_status_position(fl,T)}else{if(!this._drag_from_window&&this._can_drop_transfer(fl.dataTransfer)){return bp.show_drop_indicators(fl)}}},_body_dragleave:function(fm){var fl,T,fn;T=fm.x||fm.clientX;fn=fm.y||fm.clientY;fl=B.viewport_dimensions();if(!((0<T&&T<fl.width)&&(0<fn&&fn<fl.height))){return bp.hide_drop_indicators()}},_body_dragstart:function(){return this._drag_from_window=true},_body_dragend:function(){if($("breadcrumb-dropdown")){$("breadcrumbs-box").removeClassName("down");$("breadcrumb-dropdown").hide()}this._clear_event_browse_files();this._remove_drop_indicators();bp.hide_drop_indicators();A.end();return this._drag_from_window=false},_body_mousemove:function(){return bp.hide_drop_indicators()},_ie_mouseover:function(fl,T){if(!B.focus_in_input()){return T.focus()}},_dropzone_dragover:function(fp,T){var fl,fm,fn,fo;if(!cL.isFileDragEnabled()){return true}fp.preventDefault();fn=this._get_event_browse_files();fo=this._target_fq_path(T);if(!fn.pluck("fq_path").indexOf(fo===-1)){return}if(!this._can_drop(fp,T)){T.addClassName("drag_nodrop");return}try{fm=fp.dataTransfer.effectAllowed}catch(fq){}if(fm==="move"||fm==="copyMove"||fm==="linkMove"||fm==="all"){fp.dataTransfer.dropEffect="move"}else{fp.dataTransfer.dropEffect="copy"}fp.preventDefault();fl=$$(".dragover");fl.removeItem(T);fl.invoke("removeClassName","dragover");if(!dS.disabled){T.addClassName("dragover")}return bp.folder_dragover(fo)},_dropzone_dragleave:function(fl,T){return this._clear_hover_state(T)},_file_dragstart:function(fq,ft){var fu,T,fv,fl,fp,fo,fn,fr,fm;d5.clear_selected();if(eX.is_selecting()){return fq.preventDefault()}fq.dataTransfer.effectAllowed="copyMove";fq.dataTransfer.setData("URL","about:blank");fp=cR.from_elem(ft);this._set_event_browse_files(fp);fo=this._get_event_browse_files();if(fo.length<=1&&!fp.dir){fm=fp.href;fn=(fp.filename||eA("file")).replace(/:/g,"-");fr="application/octet-stream";try{fq.dataTransfer.setData("DownloadURL",[fr,fn,fm].join(":"))}catch(fs){}}fv=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif",width:1,height:1});fu=true;try{fq.dataTransfer.setDragImage(fv,150,150)}catch(fs){fl=fs;fu=d5.ie8}this._add_drop_indicators(fq);A.start();if(fu){this._update_status_position(fq,fo);T=$("drag-status");T.removeClassName("rotatein").removeClassName("fadein").removeClassName("selection");if(fo.length>1){T.addClassName("rotatein")}if(this._is_dragging_selection()){T.addClassName("selection")}return T.addClassName("fadein")}},_add_drop_indicators:function(fo){var fp,fn,fl,fm,T;$(document.body).addClassName(this._STATUS_CLASS);if(!dS.disabled){fm=$$('[dropzone="copy move"]');T=[];for(fn=0,fl=fm.length;fn<fl;fn++){fp=fm[fn];if(this._can_drop(fo,fp)){T.push(fp.addClassName("can_drop"))}else{T.push(void 0)}}return T}},_remove_drop_indicators:function(){this._clear_hover_state();$(document.body).removeClassName(this._STATUS_CLASS);return $$(".can_drop").invoke("removeClassName","can_drop")},_build_selected_drag_icon:function(){var T,fn,fs,fm,fq,ft,fr,fl,fo,fu,fp;fl=eX.get_selected_files();fs=new Element("div",{id:"drag-selection-status"});fp=fl.slice(0,4);for(fq=fo=0,fu=fp.length;fo<fu;fq=++fo){fn=fp[fq];T=fn.get_div();if(!T){continue}fr=T.down(".icon");fr.stopObserving("load");fr.observe.bind(fr).defer("load",bR._build_selected_drag_icon);ft=fr.cloneNode(false);Element.addClassName(ft,"icon icon"+fq);fs.__sert(ft)}fm=new Element("span",{className:"badge"});fm.__date(fl.length);fs.appendChild(fm);return $("drag-selection-status").replace(fs)},_build_file_drag_icon:function(fo,T){var fl,fp,fn,fm;fl=cR.from_elem(T);fm=fl.get_div().down(".icon").cloneNode(false);Element.addClassName(fm,"icon icon0");fn=new Element("span",{className:"badge"});fn.__date("1");fp=new Element("div",{id:"drag-file-status"});fp.__date(fm).__sert(fn);return $("drag-file-status").replace(fp)},_drop:function(fs,fw){var ft,fo,fz,fx,fA,fr,fy,fq,fn,fl,fu,T,fm,fp,fv;fo=this._get_event_browse_files();if(this._linkfile_drop_enabled()){fr=cL.getDraggedLink(fs.dataTransfer)}if(fr!=null){T=cL.buildUrlLinkfileContents(fr);fu=new Blob([T],{type:"text/plain"});fl=F.parse(fr).getAuthority();fu.name=cr.unused_filename(fl+".url");fu.overwrite=false;fy=[fu];ba.LinkfileActivityLogger.log("droplink","url",fl,true,"browse",{})}else{fy=fs.dataTransfer.files;fq=fs.dataTransfer.items}fs.preventDefault();if(fw.readAttribute("quicksend")){if(fy&&fy.length){fz=function(){return bp.upload(Y.DEST_FOLDER,fy,fq)};Y.get_folder_name(fz)}else{if(fo.length){for(fp=0,fv=fo.length;fp<fv;fp++){fn=fo[fp];fn.id=o.guid();Y.add_dropbox_file(fn)}}}return}if(this._is_read_only(fw)){fm=eA("You don't have permission to add to this folder.");ae.error(fm);return}fx=null;fA=cR.from_elem(fw);ft=fw.readAttribute("data-fq_path");if(fA){fx=fA.fq_path}else{if(ft||ft===""){fx=ft}}if(fy&&fy.length){if(!bp.supported()){ae.error(eA("Drag and drop not supported. Please try the simple uploader."))}else{if(!bp.browse_indicators_enabled()&&!bp.modal_indicators_enabled()){if(cA.choose_button_id.startsWith("wizard-")){ae.error(eA("You'll be able to drag and drop files once you finish this tutorial. For now, choose a file to upload."))}else{ae.error(eA("You can't drag and drop upload right now."))}}else{bp.upload(fx,fy,fq)}}}else{if(fo.length){if((fs.dataTransfer.dropEffect==="copy")||(fs.dataTransfer.effectAllowed==="copy")){dC.do_bulk_copy(fo,fx)}else{if(!cr.inside_dir||cr.containing_fq_path()!==fx){dC.do_bulk_move(fo,fx)}}}}this._remove_drop_indicators();return bp.hide_drop_indicators()},_set_event_browse_files:function(T){var fl;fl=eX.is_selected(T);return this._current_item_key=fl?this._SELECTION_CONST:T.to_key()},_clear_event_browse_files:function(){return this._current_item_key=null},_get_event_browse_files:function(){var fm,fl,T;try{T=this._current_item_key;if(this._is_dragging_selection()){return eX.get_selected_files()}else{if(T){fl=cR.from_key(T);return(fl?[fl]:[])}}}catch(fn){fm=fn;console.log(fm)}return[]},_is_dragging_selection:function(){return this._current_item_key&&this._current_item_key===this._SELECTION_CONST},_is_read_only:function(T){if(T.readAttribute("read_only")){return true}if(T.readAttribute("is_read_only_mount")){return true}return false},_linkfile_drop_enabled:function(){return ax.getGandalfRule("docpreview-linkfile-drop")&&(typeof Blob!=="undefined"&&Blob!==null)},_can_drop_transfer:function(fl){var T;T=["Files"];if(this._linkfile_drop_enabled()){T.push.apply(T,["text/x-moz-url","text/uri-list","Url"])}return bx.intersection(fl!=null?fl.types:void 0,T).length>0},_can_drop:function(fn,fl){var T,fm;if(fl.readAttribute("quicksend")){return true}if(this._is_read_only(fl)){return false}T=this._target_fq_path(fl);fm=this._get_event_browse_files();if(fm.length){return !dC.bulk_move_error(fm,T)}else{if(this._can_drop_transfer(fn.dataTransfer)){bp.supported();return true}else{return false}}},_target_fq_path:function(T){var fl;fl=cR.from_elem(T);if(fl){return fl.fq_path}else{return T.readAttribute("data-fq_path")}},_clear_hover_state:function(fl){var fo,fn,T,fm;fm=$$("#browse .dragover");for(fn=0,T=fm.length;fn<T;fn++){fo=fm[fn];if(fo!==fl){fo.removeClassName("dragover")}}return $$("#browse .drag_nodrop").invoke("removeClassName","drag_nodrop")},_update_status_position:function(T){T=Event.extend(T);return d5.scry("drag-status").setStyle({left:(T.pointerX()-B.scroll_offsets().left+this._STATUS_OFFSET)+"px",top:(T.pointerY()-B.scroll_offsets().top+this._STATUS_OFFSET)+"px"})}};var O;O=D.BrowseJump={_active:"",_listening:false,_RESET_WAIT:1000,_RESET_TIMER_ID:null,_CODEPOINTS:null,_BLACKLIST:["/","\\",":","?","*","<",">","|"].map(function(T){return T.charCodeAt(0)}),update:function(){var fm,fp,fl,fo,T,fn;if(!O._listening){O.listen();O._listening=true}fm=[];fn=cr.files;for(fo=0,T=fn.length;fo<T;fo++){fl=fn[fo];fp=O.to_codepoint_list(fl.filename);fm.push([fp,fl])}fm.sort(function(fr,fq){return O.cmp_codepoints(fr[0],fq[0])});return O._CODEPOINTS=fm},reset:function(){return O._active=""},is_active:function(){return O._active},jump:function(T){if(T){eX.set_selected_files([T]);return cr.scrollTo(T.get_div())}},listen:function(){var fo,fn,fl,fm,T;document.observe("keypress",function(fq){var fp;if(key.getScope()!==cr.KEY_SCOPE){return}if(B.focus_in_input()||fq.metaKey||fq.altKey||fq.altGraphKey||fq.ctrlKey){return}fp=fq.charCode||fq.keyCode;if(fp<32){return}if((33<=fp&&fp<=40)){return}if(fp===32){if(O._active){fq.preventDefault()}else{return}}if(O._BLACKLIST.indexOf(fp)!==-1){return}clearTimeout(O._RESET_TIMER_ID);O._active+=String.fromCharCode(fp).toLowerCase();O.jump(O.nearest_file(O._active));return O._RESET_TIMER_ID=setTimeout(O.reset,O._RESET_WAIT)});fm=[aF.DELETE,aF.COPY,aF.MOVE,aF.RENAME,aF.PURGE,aF.RESTORE,aF.UPLOAD,aF.SF_NEW,aF.SF_LEAVE,aF.SF_UNSHARE,aF.SF_REJOIN,aF.SF_IGNORE,aF.LINKS_REMOVE,bD.ADD,bD.REMOVE,bD.MOVE];T=[];for(fn=0,fl=fm.length;fn<fl;fn++){fo=fm[fn];document.observe(fo,function(fp){return O.update()});T.push(bE(document).on(fo,function(fp){return O.update()}))}return T},nearest_file:function(fs){var fp,fl,T,fo,fr,fq,fn,fm;if((fq=O._CODEPOINTS)!=null?fq.length:void 0){fp=O.to_codepoint_list(fs);fn=O._CODEPOINTS;for(fo=0,fr=fn.length;fo<fr;fo++){fm=fn[fo],T=fm[0],fl=fm[1];if(O.cmp_codepoints(fp,T)<1){return fl}}O._CODEPOINTS.last()[1]}return null},cmp_codepoints:function(fo,fn){var T,fm,fl;cJ(fo.length>0&&fn.length>0,"bad input to cmp_codepoints");for(T=fm=0,fl=fo.length;0<=fl?fm<fl:fm>fl;T=0<=fl?++fm:--fm){if(fn[T]==null){return 1}if(fo[T]!==fn[T]){return(fo[T]<fn[T]?-1:1)}}if(fn.length>fo.length){return -1}else{return 0}},to_codepoint_list:function(fl){var fm,T,fo,fn;fl=fl.toLowerCase();T=[];for(fm=fo=0,fn=fl.length;0<=fn?fo<fn:fo>fn;fm=0<=fn?++fo:--fo){T.push(fl.charCodeAt(fm))}return T}};var bn;bn=D.ContextMenu={KEY_SCOPE:"context",SHOW_EVT:"db:contextmenu:show",HIDE_EVT:"db:contextmenu:hide",_prev_key_scope:null,listen:function(){bE(document).click(this.hide_on_click);bE(document).on(cr.UPDATE_EVT,this.hide_on_click);return key("esc",this.KEY_SCOPE,(function(T){return function(fl){return bn.hide()}})(this))},unlisten:function(){bE(document).off("click",this.hide_on_click);return bE(document).off(cr.UPDATE_EVT,this.hide_on_click)},hide_on_click:function(T){if(!(T.which===3||bE(T.target).parents("#context-menu").length)){return bn.hide()}},show_for_file:function(T,fn,fm){var fo,fl;cr.keyboard_nav=false;this.hide();fo=cR.from_elem(fm);fl=eX.is_selected(fo)?eX.get_selected_files():(eX.deselect_all(),[fo]);eX.set_context_selected(fl);return this._show(fn,new T(fl))},show_global:function(T,fl){this.hide();return this._show(fl,new T())},show_shmodel:function(fq){var fp,fl,T,fm,fn,fo;fp=["get_original"];fn=fq.findElement("img");if((fn.readAttribute("enable-download"))==="true"){fm=fn.readAttribute("data-original-href");fl=[]}else{fm="";fl=["get_original"]}this.hide();fo={get_original:{icon:"download",text:eA("Download original"),href:fm}};T=Class.create({get_action_names:function(){return fp},get_disabled_action_names:function(){return fl},get_action_by_name:function(fr){var fs;fs=fo[fr];fs.name=fr;return fs}});return this._show(fq,new T())},show_for_lightbox:function(fr){var fq,fl,T,fo,fm,fp,fn;fq=["download","view_original"];this.hide();fm=fr.findElement("img");if((fm.readAttribute("enable-download"))==="false"){fl=["download","view_original"];fo="";fn=""}else{fl=[];fo=F.parse(fm.readAttribute("data-original-href")).updateQuery({dl:1}).toString();fn=fm.readAttribute("data-original-href")}fp={download:{icon:"download",text:eA("Download"),href:fo},view_original:{icon:"view_original",text:a5.append_ellipsis(eA("View original")),href:fn,target:"_blank"}};T=Class.create({initialize:function(){return this._listen()},_listen:function(){var fs;fs=$("context-menu-container");fs.stopObserving("click");fs.stopObserving("contextmenu");fs.on("click",".action button",this._click.bind(this));return fs.on("contextmenu",".action button",this._click.bind(this))},_click:function(fw,ft){var fv,fs,fu;fv=ft.readAttribute("data-value");fs=fp[fv];bn.hide();fw.preventDefault();return(fu=fs.click_handler)!=null?fu.call(this,fw):void 0},get_action_names:function(){return fq},get_disabled_action_names:function(){return fl},get_action_by_name:function(fs){var ft;ft=fp[fs];ft.name=fs;return ft}});return this._show(fr,new T())},show_photos:function(fs,fw){var fv,fl,fp,fn,fu,ft,T,fm,fq,fr,fo;this.hide();fn={divider:{type:"divider"},choose_album:{icon:"album_16",text:a5.append_ellipsis(eA("Add %(num_photos)s to album").format({num_photos:fw.length})),click_handler:function(fx){cG.show_add_to_album_modal(fx,fw);return i.log_interaction(en.ADD_TO_OTHER_ALBUM,db.PCM,{num_photos:fw.length})}},remove:{icon:"album_delete_16",text:eA("Remove %(num_photos)s from album").format({num_photos:fw.length}),click_handler:function(){cG.show_remove_photos_modal(bQ.get_current_collection(),fw);return i.log_interaction(en.REMOVE,db.PCM,{num_photos:fw.length})}},set_cover:{icon:"album_16",text:eA("Set as cover"),click_handler:function(){bQ.get_current_collection().set_cover(fw[0]);return i.log_interaction(en.SET_AS_COVER,db.PCM,{num_photos:1})}},edit_timestamp:{text:"Edit timestamp",click_handler:function(){return bQ.show_timestamps_modal(fw)}}};if(bQ.in_single_collection_view()){fv=["share","choose_album","remove"];if(fw.length===1){fv.unshift("divider");fv.unshift("set_cover")}}else{fv=["share","choose_album"];fv.push("divider");fv.push("delete");if(bQ.timestamp_edit_enabled){fu=(function(){var fz,fy,fx;fx=[];for(fz=0,fy=fw.length;fz<fy;fz++){fm=fw[fz];if(fm.time_taken==null){fx.push(fm)}}return fx})();if(fu.length===0){fv.push("edit_timestamp")}else{if(fu.length===fw.length){fn.edit_timestamp.text="Set timestamp";fv.push("edit_timestamp")}}}}if(fw.length===1){fr=c8.categorize_files(fw),ft=fr[0],T=fr[1];if(ft){fq=a5.append_ellipsis(eA("Share photo"))}else{fq=a5.append_ellipsis(eA("Share video"))}Object.extend(fn,{share:{icon:"s_link",text:fq,click_handler:function(fx){ez.show(fw,false);return i.log_interaction(en.SHARE,db.PCM,{num_photos:1})}},"delete":{text:a5.append_ellipsis(eA("Delete")),click_handler:function(){bQ.show_delete_photos_modal(fw);return i.log_interaction(en.DELETE,db.PCM,{num_photos:1})}},show_in_folder:{text:a5.append_ellipsis(eA("Show in folder")),click_handler:function(){bQ.show_in_folder(fw[0]);return i.log_interaction(en.SHOW_IN_FOLDER,db.PCM,{num_photos:1})}}});if(bQ.in_single_collection_view()){fv.push("divider")}fv.push("show_in_folder")}else{fo=c8.categorize_files(fw),ft=fo[0],T=fo[1];if(ft&&T){fq=bc("Share %(file_count)s item","Share %(file_count)s items",fw.length);fp=bc("Delete %(file_count)s item","Delete %(file_count)s items",fw.length)}else{if(ft){fq=bc("Share %(file_count)s photo","Share %(file_count)s photos",fw.length);fp=bc("Delete %(file_count)s photo","Delete %(file_count)s photos",fw.length)}else{fq=bc("Share %(file_count)s video","Share %(file_count)s videos",fw.length);fp=bc("Delete %(file_count)s video","Delete %(file_count)s videos",fw.length)}}fq=fq.format({file_count:fw.length});fp=fp.format({file_count:fw.length});Object.extend(fn,{share:{icon:"s_link",text:fq,click_handler:function(fx){bQ._share_selected();return i.log_interaction(en.SHARE,db.PCM,{num_photos:fw.length})}},"delete":{text:fp,click_handler:function(fx){bQ.show_delete_photos_modal(fw);return i.log_interaction(en.DELETE,db.PCM,{num_photos:fw.length})}}})}fl=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fA,fy){var fz,fx,fB;fz=fy.readAttribute("data-value");fx=fn[fz];if(fA.clientX===0&&fA.clientY===0){return}bn.hide();return(fB=fx.click_handler)!=null?fB.call(this,fA):void 0},get_action_names:function(){return fv},get_disabled_action_names:function(){return[]},get_action_by_name:function(fx){var fy;fy=fn[fx];fy.name=fx;return fy}});return this._show(fs,new fl())},show_photo_collection:function(fn,fo,fp){var fm,T,fl;this.hide();if(fo.is_anonymous){fm=["go_to_link","unshare"]}else{if(fo.is_creator){fm=["share","rename"];if(fo.share_tkey!=null){fm.push("unshare")}fm.push("delete")}else{fm=["share"]}}fl={share:{icon:"s_link",text:a5.append_ellipsis(eA("Share album")),click_handler:function(fq){if(fo.num_items===0){ae.error(eA("This album is empty. Add some photos before you share it!"));return}ez.show(fo,true);return i.log_interaction(en.SHARE_ALBUM,db.CCM,{num_photos:fo.num_photos})}},unshare:{icon:"lock",text:a5.append_ellipsis(fo.is_anonymous?eA("Unshare"):eA("Unshare album")),click_handler:function(fq){cG.show_unshare_modal(fo);return i.log_interaction(en.UNSHARE_ALBUM,db.CCM,{num_photos:fo.num_photos})}},rename:{icon:"pencil",text:eA("Rename album"),click_handler:function(fq){fo.rename(fp.down(".collection-name"));return i.log_interaction(en.RENAME_ALBUM,db.CCM,{num_photos:fo.num_photos})}},"delete":{icon:"album_delete_16",text:a5.append_ellipsis(eA("Delete album")),click_handler:function(fq){cG.show_delete_modal(fo);return i.log_interaction(en.DELETE_ALBUM,db.CCM,{num_photos:fo.num_photos})}},go_to_link:{icon:"s_link",text:eA("Go to link"),click_handler:function(fq){cG.go_to_link(fo);return i.log_interaction(en.GO_TO_ALBUM_LINK,db.CCM,{num_photos:fo.num_photos})}}};T=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fu,fr){var ft,fq,fs;ft=fr.readAttribute("data-value");fq=fl[ft];bn.hide();return(fs=fq.click_handler)!=null?fs.call(this):void 0},get_action_names:function(){return fm},get_disabled_action_names:function(){return[]},get_action_by_name:function(fq){var fr;fr=fl[fq];fr.name=fq;return fr}});return this._show(fn,new T())},_show:function(fx,fr,fw){var fv,fo,fy,T,fu,ft,fA,fs,fm,fl,fz,fB,fq,fp,fn;if(fw==null){fw=false}fs=((fx!=null?(fq=fx.target)!=null?fq.tagName.toUpperCase():void 0:void 0)==="INPUT")&&((fx!=null?(fp=fx.target)!=null?fp.type.toUpperCase():void 0:void 0)==="TEXT")||((fx!=null?(fn=fx.target)!=null?fn.tagName.toUpperCase():void 0:void 0)==="TEXTAREA");fu=["#page-footer","#account-header","#browse-global-actions-bar","#modal","#modal-overlay","#file-preview-modal","#file-viewer","#notify-wrapper",".db-modal-wrapper","#sharing-growth-experiments-dropdown-menu",".inline-share-button","#wizard-overlay","#react-bubble-dropdown-root",".preview-sf-members-box",".db-modal",".db-modal-overlay",".waiting_for_items"];fA=$(fx.target);if(bE(fA).parents("#context-menu").length){return}fv=bE("#file-preview-modal");if(!(fv.find(fA).length&&bE(fA).is("img"))){for(fm=0,fz=fu.length;fm<fz;fm++){T=fu[fm];fy=$$(T);if(fy){for(fl=0,fB=fy.length;fl<fB;fl++){fo=fy[fl];if(fA.descendantOf(fo)||fA.match(T)){return}}}}}if((fx!=null?fx.shiftKey:void 0)||fs){return}else{Event.stop(fx)}if(this._context_menu_tmpl==null){this._context_menu_tmpl=fg.tmpl("context_menu_tmpl")}if(!fr.get_action_names().length){return}eU.hide_all();$("context-menu-container").__date(this._context_menu_tmpl({context:fr,actions:(function(){var fE,fC,fF,fD;fF=fr.get_action_names();fD=[];for(fE=0,fC=fF.length;fE<fC;fE++){ft=fF[fE];fD.push(fr.get_action_by_name(ft))}return fD})(),disabled_actions:fr.get_disabled_action_names(),big:fw,Sprite:cv}));this.position_at(fx.clientX,fx.clientY);$("context-menu-container").show();this.listen();this._prev_key_scope=key.getScope();key.setScope(this.KEY_SCOPE);return document.fire(this.SHOW_EVT)},position_at:function(fm,fp){var fl,T,fn,fo;fo=B.viewport_dimensions();T=parseInt($("context-menu").getStyle("width"),10);fl=parseInt($("context-menu").getStyle("height"),10);fn=15;if(fm+T>fo.width-fn){$("context-menu").setStyle({left:(fo.width-T-fn)+"px"})}else{$("context-menu").setStyle({left:fm+"px"})}if(fp+fl>fo.height-fn){return $("context-menu").setStyle({top:(fo.height-fl-fn)+"px"})}else{return $("context-menu").setStyle({top:fp+"px"})}},hide:function(){if(!$("context-menu-container").empty()){this.unlisten();eX.set_context_selected([]);$("context-menu-container").__date();if(key.getScope()===this.KEY_SCOPE){key.setScope(this._prev_key_scope)}return document.fire(this.HIDE_EVT)}}};var dl,cr,k,aI,aw,cT,ck,bK=[].indexOf||function(fm){for(var fl=0,T=this.length;fl<T;fl++){if(fl in this&&this[fl]===fm){return fl}}return -1};dl=D.BROWSE_SNIPPET_LEN=25;ck=D.SEARCH_SNIPPET_LEN=20;aI=D.COMMENT_COUNT_SNIPPET_LEN=3;cT=D.LAST_MODIFIED_FNAME_SNIPPET=4;aw=[bq.FILES_BY_NAME,true,"FILES_BY_NAME"];cr=INLINE_JS.Browse=D.Browse={KEY_SCOPE:"browse",RENDER_EVT:"db:browse:render",BEFORE_UPDATE_EVT:"db:browse:before_update",UPDATE_EVT:"db:browse:update",NEW_PAGE_EVT:"db:browse:new_page",SCROLL_DURATION:0.5,msg:false,files:[],reloading:false,creating_folder:false,first_load:true,last_sort:aw,folder_loading_notification:null,folder_loading_timeout:null,keyboard_nav:false,paginating:false,is_initialized:false,init:function(fl,fq,fn,fp,T,fo,fm){this.browse_actions_ctor=fq;this.global_actions_ctor=fn;this.browse_actions_context_ctor=fp;this.global_actions_context_ctor=T;this.ns_id_to_mount_point=fo;cJ(typeof fm==="number","a user_id was not passed into Browse.init",true,[],false);this.active_user=cK.get_viewer().get_user_by_id(fm);__CIRCULAR_DEPENDENCY__.active_user_loaded=true;cJ(this.active_user,"No active_user was found in Browse.init",true,[],false);this.unselectable();this.listen();B.viewport_dimensions();if(b1.chrome){this.browser_supports_previews=fl&&d5.pdf_plugins().length}else{this.browser_supports_previews=fl}if(cK.get_viewer().is_paired){dE.set_role(this.active_user.role)}this.subscribe_sfj_callbacks={};this.compiled_search_tmpl=fg.tmpl("search_list_item_tmpl");this.add_visible_change_callback((function(fr){return function(){return fr.show_inline_sharing_on_browse_exp()}})(this));cC.AuthenticatedRequest({url:F({path:"/flash_detect_log"}),data:{installed:FlashDetect.installed,major:FlashDetect.major,minor:FlashDetect.minor,revision:FlashDetect.revision,revisionStr:FlashDetect.revisionStr,raw:FlashDetect.raw}});return this.is_initialized=true},setup:function(fl,fq){var fp,fo,fn,T,fm;if(fq==null){fq=null}this.ns_id_to_mount_point=fl.ns_id_to_mount_point;this.old_path_to_ns_id=fl.old_path_to_ns_id;this.compiled_tmpl=fg.tmpl("list_item_tmpl");this.render_timeout=null;this.inside_root_folder=fl.containing_fq_path==="";this.inside_dir=fl.inside_dir;this.inside_deleted_dir=fl.inside_deleted_dir;this.inside_shared_folder=fl.inside_shared_folder;this.inside_read_only_shared_folder=fl.inside_read_only_shared_folder;this.inside_sandbox=fl.inside_sandbox;this.public_app_token=fl.public_app_token;this.public_folder_enabled=fl.public_folder_enabled;this.inside_deleted_sandbox=fl.inside_deleted_sandbox;this.inside_deleted_shared_folder=fl.inside_deleted_shared_folder;this.inside_team_folder=fl.inside_team_folder;this.golden_gate_aware=fl.golden_gate_aware;this.is_read_only=fl.is_read_only;this.ns_map=fl.ns_map;this.permanent_delete_is_disabled_by_ns_id=fl.permanent_delete_is_disabled_by_ns_id;this.contents_cache_key=fl.contents_cache_key;fo="inside_deleted_dir";if(this.inside_deleted_dir){$("browse").addClassName(fo)}else{$("browse").removeClassName(fo)}this.block_hash=fl.block_hash;this.block_hash_param=fl.block_hash_param;if(this.inside_dir){$("advanced-search-box").hide();$("advanced-search-link").removeClassName("selected");this._containing_ns_id=fl.containing_ns_id;this._containing_ns_path=fl.containing_ns_path;this._containing_fq_path=fl.containing_fq_path;this._containing_mount_point=fl.containing_mount_point;this._containing_sf_perm_role=fl.containing_sf_perm_role;this.breadcrumb();fm=[this.browse_actions,this.global_actions];for(fn=0,T=fm.length;fn<T;fn++){fp=fm[fn];if(fp!=null){fp.unlisten()}}this.browse_actions=new this.browse_actions_ctor();this.global_actions=new this.global_actions_ctor();if(!(fl.file_info||fl.paginated)){this.show_message(eA('<h3>This folder is empty</h3> Add files using the <a href="/install">desktop application</a> or the upload button above.'))}}if(fl.paginated){return this._start_pagination(fl.first_page)}else{return this._push_files(fl.file_info,fq)}},entered_search:function(){return this._stop_pagination()},_start_pagination:function(fl){var T;if(fl.unsupported_sort!=null){this.reset_sort()}this.paginating=true;T=cr.active_user.id;this.pagination_manager=new fk();this.pagination_manager.initialize(fl,"sjid","/browse_get_next",T,(function(fm){return function(fn,fo){return fm._new_data_available(fn,fo)}})(this));this.pagination_manager.startAutoFetching();bE("#more-loading").show();return this.disable_sorting()},_stop_pagination:function(){if(!this.paginating){return}this.paginating=false;this.pagination_manager.stopAutoFetching();this.pagination_manager=null;bE("#more-loading").hide();this.enable_sorting();return this._stop_waiting_for_items()},_new_data_available:function(fn,fl){var fm,T;if(!this.paginating){return}T=this._push_files(fl);if(!this.in_search_mode()){this.smartfill();a5.load_visible_thumbs();this.fire_visible_change_callbacks()}fm=fn.loadedPageCount()===1;if(!fm){if(this._is_item_selection_needed()){if(this._are_all_selected_items_fetched()||fn.areAllItemsReady()){this._stop_waiting_for_items();this.set_selection_from_fq_paths_or_index(cr)}}document.fire(this.NEW_PAGE_EVT,{page_files:T});bE(document).trigger(this.NEW_PAGE_EVT,{page_files:T})}if(fn.areAllItemsReady()){return this._stop_pagination()}},_is_item_selection_needed:function(){return(this.select_fq_paths&&this.select_fq_paths.length>0)||(this.select_index>-1)},_are_all_selected_items_fetched:function(fl){var fr,ft,fq,fm,fo,fn,fs,T,fp;if(fl==null){fl=this.files}if(this.select_fq_paths&&this.select_fq_paths.length>0){fp=this.select_fq_paths;for(fo=0,fs=fp.length;fo<fs;fo++){fr=fp[fo];fq=false;fm=fr.toLowerCase();for(fn=0,T=fl.length;fn<T;fn++){ft=fl[fn];if(ft.fq_path.toLowerCase()===fm){fq=true;break}}if(!fq){return false}}return true}else{if(this.select_index>-1){return this.select_index<fl.length}}return cJ(0,"Expected something to select (@select_index or @select_fq_paths)")},_wait_for_items:function(){bE("#waiting-for-items").show();bE("#global-actions").addClass("disabled");return bE("body").addClass("waiting_for_items")},_stop_waiting_for_items:function(){bE("body").removeClass("waiting_for_items");bE("#global-actions").removeClass("disabled");return bE("#waiting-for-items").hide()},_push_files:function(fm,fq){var fp,fl,fn,fo,T;if(fq==null){fq=null}fl=[];for(fo=0,T=fm.length;fo<T;fo++){fn=fm[fo];fp=a5.make_browsefile(fn,fq);fp.track_in_browse();fl.push(fp)}O.update();return fl},_get_helper:function(T){cJ(this.inside_dir,"accessed "+T+", but not inside a directory");return cr[T]},containing_ns_id:function(){return this._get_helper("_containing_ns_id")},containing_ns_path:function(){return this._get_helper("_containing_ns_path")},containing_mount_point:function(){return this._get_helper("_containing_mount_point")},containing_fq_path:function(){if(!this.inside_dir){return""}return this._get_helper("_containing_fq_path")},containing_sf_perm_role:function(){return this._get_helper("_containing_sf_perm_role")},listen:function(){var fw,fn,fo,fr,fz,fl,fu,ft,fq,fx,fm,T,fy,fv,fs,fp;bE("#fulltext-search-all-link").click(this.unscoped_search);bE("#noresults-search-all-link").click(this.unscoped_search);$("browse-files").on("click","li.browse-file",this.click.bind(this));$("browse-files").on("dblclick","li.browse-file",this.dblclick.bind(this));$("browse-files").on("contextmenu","li.browse-file",bn.show_for_file.bind(bn,this.browse_actions_context_ctor));this.enable_sorting();fr="#browse-sort a.sortable-column-header";d5.add_sort_arrow_mouseover($("name-sorter"),true,fr,false);Event.observe(window,"scroll",this.window_scroll.bind(this));Event.observe(window,"resize",this.updateOffset.bind(this));$(document.body).on("click","a.crumb",this.crumb_click.bind(this));$("browse-files").on("click","a.parent-dir",this.parent_click.bind(this));document.observe("contextmenu",bn.show_global.bind(bn,this.global_actions_context_ctor));document.observe(eX.UPDATED_EVT,this.selection_handler.bind(this));document.observe(aF.COPY,(function(fA){return function(fB){if(fA.inside_dir&&fB.memo.to_fq_path===fA.containing_fq_path()){return fA.force_reload()}}})(this));fv=[aF.MOVE,aF.RESTORE,aF.UPLOAD,aF.SF_NEW,aF.SF_REJOIN,aF.SF_IGNORE,aF.LINKS_REMOVE,aF.LINKS_ADD];for(fu=0,fx=fv.length;fu<fx;fu++){fn=fv[fu];fo=(function(fA){return function(fB){if(fA.inside_dir&&!(b9.sparky_search_ui_enabled&&cr.in_search_mode())){return fA.force_reload()}}})(this);document.observe(fn,fo);bE(document).on(fn,fo)}fs=[aF.SF_LEAVE,aF.SF_UNSHARE];for(ft=0,fm=fs.length;ft<fm;ft++){fn=fs[ft];document.observe(fn,(function(fA){return function(fB){if(fA.inside_dir){if(fB.memo.target_ns_id===fA.containing_ns_id()){if(fB.memo.folder_deleted){return fA.reload_fqpath("")}else{return fA.reload_fqpath(fA.containing_fq_path())}}else{return fA.force_reload()}}}})(this))}fp=[aF.DELETE,aF.PURGE];for(fq=0,T=fp.length;fq<T;fq++){fn=fp[fq];document.observe(fn,(function(fA){return function(fJ){var fG,fI,fC,fH,fB,fE,fF,fD;if(fA.inside_dir){if(fJ.eventName===aF.PURGE||(fJ.eventName===aF.DELETE&&!a3.get_del())){for(fI=fH=fF=fA.files.length-1;fF<=0?fH<=0:fH>=0;fI=fF<=0?++fH:--fH){if(fJ.memo.files.indexOf(fA.files[fI])===-1){fC=fA.files[fI]}else{break}}eX.deselect_all();fD=fJ.memo.files;for(fE=0,fB=fD.length;fE<fB;fE++){fG=fD[fE];fG.get_div().remove();fA.files.removeItem(fG)}if(fA.files.length){if(fC!=null){return eX.set_selected_files(fC)}else{return eX.set_selected_files(fA.files.last())}}else{return fA.show_empty()}}else{if(fA.keyboard_nav){fA.select_fq_paths=[fA.containing_fq_path()+"/"+fJ.memo.files.last().filename]}return fA.force_reload()}}}})(this))}document.observe(bn.SHOW_EVT,this.disable_sorting.bind(this));document.observe(bn.HIDE_EVT,this.enable_sorting.bind(this));fy=function(){var fB,fA;fB=$("browse-header");fA=fB.cumulativeOffset().top+fB.getHeight();return B.viewport_dimensions().height-fA};key("pagedown",this.KEY_SCOPE,function(fA){Event.extend(fA).preventDefault();return window.scrollBy(0,fy())});key("pageup",this.KEY_SCOPE,function(fA){Event.extend(fA).preventDefault();return window.scrollBy(0,-1*fy())});fz=function(){var fA;fA=cr.in_search_mode()?b9:cr;if(cr.files.length===0){return fA.show_empty()}else{return fA.hide_empty()}};document.observe(bD.ADD,(function(fA){return function(fD){var fC,fB,fF,fE;fE=fD.memo.files;for(fB=0,fF=fE.length;fB<fF;fB++){fC=fE[fB];fA.insert_file(fC,true)}return fz()}})(this));document.observe(bD.REMOVE,(function(fA){return function(fD){var fC,fB,fF,fE;fE=fD.memo.files;for(fB=0,fF=fE.length;fB<fF;fB++){fC=fE[fB];fA.remove_file(fC)}return fz()}})(this));document.observe(bD.MOVE,(function(fA){return function(fG){var fJ,fH,fI,fK,fE,fB,fD,fC,fF;fH=fA.in_search_mode()&&b9.sparky_search_ui_enabled;fD=fG.memo.files;fF=[];for(fE=0,fB=fD.length;fE<fB;fE++){fC=fD[fE],fJ=fC[0],fK=fC[1];if(fH){if(fJ!=null){fI=fA.get_file_pos(fJ)}else{continue}}fA.remove_file(fJ);fA.insert_file(fK);if(fH&&fI>=0){fF.push(fA.update_file_pos(fK,fI))}else{fF.push(void 0)}}return fF}})(this));bE(document).on(aF.COMPRESS,(function(fA){return function(fD,fC){var fB;fA.force_reload();if(fC.compressed_files.length===1&&fC.original_files.length===1){fB=a5.make_browsefile(fC.compressed_files.first());return fA.preview_compressed(fB,fC.original_files.first())}}})(this));fw=this.fire_visible_change_callbacks.bind(this);bE(window).on("resize",fw);this._last_visible_change_timeout_id=null;fl=(function(fA){return function(fB){clearTimeout(fA._last_visible_change_timeout_id);return fA._last_visible_change_timeout_id=setTimeout(fw,250)}})(this);return bE(window).on("scroll",fl)},add_subscribe_sfj_callback:function(T){return this.subscribe_sfj_callbacks[this.subsribe_sfj_count]=T},remove_sfj_callback:function(T){return delete this.subscribe_sfj_callbacks[T]},disable_sorting:function(){$("browse-sort").stopObserving("click");return $$("#browse-sort *").invoke("setStyle",{cursor:"default"})},enable_sorting:function(){$("browse-sort").stopObserving("click");$("browse-sort").on("click","#browse-sort a.sortable-column-header",this.sort_handler.bind(this));return $$("#browse-sort *").invoke("setStyle",{cursor:"pointer"})},click:function(fm,fo){var T,fl,fn;T=bE(fm.target);if(T.is("img.icon")||T.closest("a.filename-link").length>0||T.closest(".filename-col__comment-count-bubble").length>0){this._click(fm,fo)}if(T.is("a.parent-dir")){fl=cR.from_elem(fo);if(fl){fn={file_nsid:fl.ns_id,file_sjid:fl.sjid,firefly:b9.firefly_enabled,match_type:fl.match_type,position:fl.sort_rank,request_id:fl.request_id,viewport:"full-view",action_type:"click_path_link"};return ba.SearchClientActivityLogger.log("result_action",cr.active_user.id,fn)}}},dblclick:function(T,fl){if($(T.target).match("a")){return}return this._click(T,fl)},open_file:function(fn,T,fm,fl){var fo,fp;if(fm==null){fm=false}if(fl==null){fl=Constants.OREF_CONSTANTS.BROWSE_UNKNOWN}fo={user_id:cr.active_user.id,context:aV.FileViewContextType.PRIVATE,platform:aV.FileViewPlatformType.WEB,ns_id:fn.ns_id,sjid:fn.sjid,ns_path:fn.ns_path,shared_link_url:null,extra:{mode:aV.FileViewModeType.BROWSE,file_ext:ay.file_extension_for_logging(fn.filename),file_bytes:fn.bytes,file_mtime:fn.ts}};fp={file_nsid:fn.ns_id,file_sjid:fn.sjid,firefly:b9.firefly_enabled,match_type:fn.match_type,position:fn.sort_rank,request_id:fn.request_id,viewport:fm?"dropdown-view":"full-view"};if(fn.dir){if(this.in_search_mode()||fm){fp.action_type="folder_open";ba.SearchClientActivityLogger.log("result_action",cr.active_user.id,fp)}if(T){return this.open_folder_in_new_window(fn)}else{return this.open_folder(fn)}}else{if(!T&&this.can_show_preview(fn)){if(this.in_search_mode()||fm){fp.action_type="file_view";ba.SearchClientActivityLogger.log("result_action",cr.active_user.id,fp)}return this.open_preview(fn,fl,fm)}else{if(this.in_search_mode()||fm){fp.action_type="file_view";ba.SearchClientActivityLogger.log("result_action",cr.active_user.id,fp)}ba.FileViewLogger.log(fo);return window.open(fn.href,"_blank")}}},close_preview_callback:function(){bE(document).off("db:filepreview:close",this.close_preview_callback);ag.close_shared_link_view();return cr.set_title()},preview_compressed:function(fl,T){return m.show(fl,cr.active_user,{files:[fl,T],file_view_mode:aV.FileViewModeType.BROWSE,hide_comments:true})},open_preview:function(fm,T,fn,fl){if(T==null){T=Constants.OREF_CONSTANTS.BROWSE_UNKNOWN}if(fn==null){fn=false}if(fl==null){fl=false}if(this.can_show_preview(fm)){a5.filepreview_from_selected(fm,fn,fl,T);return bE(document).on("db:filepreview:close",this.close_preview_callback)}},_click:function(fm,fn){var fl,T;this.keyboard_nav=false;fl=cR.from_elem(fn);if(fl.editing){return}T=(fm.which===2)||(d5.is_mac()&&fm.metaKey);cr.open_file(fl,T,false,Constants.OREF_CONSTANTS.BROWSE_FILE_OPEN);fm.preventDefault()},crumb_click:function(fn,T){var fm,fl;this.keyboard_nav=false;fn.preventDefault();fl=T.readAttribute("data-fq_path");fm=this.details_from_fq_path(fl);return a3.set_path_url(fm.ns_id,fm.ns_path)},parent_click:function(fo,fn){var fm,fp,T,fl;this.keyboard_nav=false;fo.preventDefault();fl=fn.readAttribute("data-parent_ns_path");T=parseInt(fn.readAttribute("data-parent_ns_id"),10);a3.set_path_url(T,fl);fm=cR.from_elem(fn);if(fm){fp={file_nsid:fm.ns_id,file_sjid:fm.sjid,firefly:b9.firefly_enabled,match_type:fm.match_type,position:fm.sort_rank,request_id:fm.request_id,viewport:"full-view",action_type:"click_path_link"};return ba.SearchClientActivityLogger.log("result_action",cr.active_user.id,fp)}},selection_handler:function(){if(eX.get_selected_files().length){return $("browse-box").addClassName("selected")}else{return $("browse-box").removeClassName("selected")}},POST_SCROLL_WAIT:100,_last_scroll_timeout:null,window_scroll:function(){var T,fl,fn,fm;if(b9.sparky_search_ui_enabled&&this.in_search_mode()&&!b9.end_of_results){fm=a5.get_files_in_view(),fn=fm[0],fl=fm[1];T=this.files.length-(fn+fl);if(T<=50&&!$("browse").hasClassName("pending-search")){b9.load_more_results()}}clearTimeout(this._last_scroll_timeout);return this._last_scroll_timeout=setTimeout(a5.load_visible_thumbs.bind(a5),this.POST_SCROLL_WAIT)},unscoped_search:function(){return b9.search(false)},updateOffset:function(){if(!this.div_parent){return}this._cumulativeOffset=this.div_parent.cumulativeOffset();return this.viewportOffset()},reset_sort:function(){var fl,T;this.last_sort=aw;T="#browse-sort a.sortable-column-header";fl=$$(T)[0];d5.add_sort_arrow_mouseover(fl,true,T,false);$("kind-sorter-label").__date(dp.DISPLAY.FILES_BY_KIND);return cv.src(fl.down("img"),"web","arrow-up-gray")},sort_handler:function(fr,fn,fq){var fl,fp,fo,T,fm;fn=$(fn);fn.blur();fm=fn.readAttribute("data-sort");if(fq!=null){}else{if(this.last_sort[0]===bq[fm]){fq=fn.readAttribute("data-ascending")==="false"}else{fq=fm!=="FILES_BY_MODIFIED"}}if(dp.has_label(fm)){if(dp.has_sort(this.last_sort[0])||this.show_shared_with){fo=dp.next(fm,this.show_shared_with);fl=this.show_shared_with?"sharing-sorter-label":"kind-sorter-label";$(fl).__date(fo.display);fm=fo.label}fn.writeAttribute("data-sort",fm);fq=dp.IS_ASC[fm]}else{fn.writeAttribute("data-ascending",(fq?"true":"false"))}T="#browse-sort a.sortable-column-header";d5.add_sort_arrow_mouseover(fn,fq,T,true);fp=bq[fm];this.sort(fp,fq,fm);if(fr){return fr.stop()}},toggle_deleted:function(){var T;T=!a3.get_del();return a3.set_del_url(T)},unused_filename:function(fv,fy){var fm,fz,fn,ft,fu,fp,fw,fo,fr,fq,fB,fx,T,fA,fs,fl;if(fy==null){fy=false}fx=ay.filename_without_extension(fv);fB=ay.file_extension(fv,fm=true);ft=[];fs=cr.files;for(T=0,fA=fs.length;T<fA;T++){fz=fs[T];fq=ay.filename_without_extension(fz.filename);fr=ay.file_extension(fz.filename,fm=true);fp=fq.toLowerCase().indexOf(fx.toLowerCase())===0;fu=fB.toLowerCase()===fr.toLowerCase();fo=!fy||fz.dir;if(fp&&fu&&fo){ft.push(fz.filename.toLowerCase())}}if(fB){fB="."+fB}else{fB=""}fn=fx+fB;fw=1;while(true){if(fl=fn.toLowerCase(),bK.call(ft,fl)<0){break}fn=""+fx+" ("+fw+")"+fB;fw++}return fn},new_folder:function(){var fv,fn,fm,fo,fs,T,fl,fq,ft,fu,fp,fr;if(this.reloading||this.creating_folder){return}if(cr.sharing_create_and_share_new_folder_enabled&&!this.inside_shared_folder){fs=new a1(cr.active_user,{element_id:"create-and-share-new-folder-modal-"+cr.active_user.id,destination_dir:this.containing_fq_path()});fs.show();return}this.hide_empty();this.selectable();fm=this.unused_filename(eA("New folder"),ft=true);fr=fg.tmpl("new_folder_tmpl",{name:fm,Sprite:cv,_:eA});fo=-1;if(this.files.length){fp=B.scroll_offsets();if(fp.top>0){fu=this.files[0].get_div().getLayout().get("margin-box-height");fo=Math.floor(fp.top/fu)}}if(fo>0){this.files[fo].get_div().__sert({after:fr})}else{$("browse-files").__sert({top:fr})}T=$$("#browse-files .browse-new-folder .name").first();cJ(T!=null,"expected new_folder_name to be defined");fv=this.containing_fq_path();fq=(function(fw){return function(fz){var fy,fx,fA;fA=fz.responseText.evalJSON(true);cJ(fA.new_browse_files.length===1,"No new file data returned.");fy=ay.filename(fA.new_browse_files.first().fq_path);fx=eA("Created folder '%(folder_name)s'");fx=fx.format({folder_name:bU.em_snippet(fy,25)});ae.success(fx);fw.select_fq_paths=[fA.new_browse_files.first().fq_path];return fw.force_reload()}})(this);fl=(function(fw){return function(fy){var fx;fx=$$("#browse-files li.browse-new-folder").first();if(fx){fx.remove()}return fw.creating_folder=false}})(this);fn=new Ajax.InPlaceEditor(T,"/cmd/new"+(d5.urlquote(fv)),{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,onFailure:function(){},onComplete:fl,savingText:eA("Creating folder..."),onLeaveEditMode:this.unselectable,ajaxOptions:{method:"POST",onSuccess:fq,subject_user:cr.active_user},callback:(function(fw){return function(fx,fy){fw.creating_folder=true;return{to_path:fy||"",folder:"yes"}}})(this)});return fn.enterEditMode()},open_folder:function(fl){var fn,T,fm;cJ(fl.dir,"Only open directories, not files");if(cr.inside_dir&&cr.containing_ns_path()===fl.ns_path&&!(this.in_search_mode()&&b9.sparky_search_ui_enabled)){return}if(!(eX.get_selected_files().length===1&&eX.get_selected_files().indexOf(fl)===0)){eX.deselect_all();fn=fl.get_div();if(fn){fn.addClassName("file-select")}}clearTimeout(this.folder_loading_timeout);this.folder_loading_timeout=setTimeout((function(fo){return function(){var fp;if(!fo.reloading){return}fp=eA("Loading %(filename)s...");fp=fp.format({filename:bU.em_snippet(fl.filename,50)});return fo.folder_loading_notification=ae.success(fp,60,true)}})(this),1000);if(fl.target_ns){T=fl.target_ns;fm=""}else{T=fl.ns_id;fm=fl.ns_path}if(fl.is_deleted){return a3.set_path_url(T,fm,true)}else{return a3.set_path_url(T,fm)}},open_folder_in_new_window:function(T){return window.open(a3._make_url(T.ns_id,T.ns_path),"_blank")},show_message:function(fm){var fl,T;if((typeof fm)!==(typeof"string")){T=$("browse-files").down(".browse-message");if(T){T.show()}return}this.msg=fm;fl=new Element("div",{"class":"browse-message"});fl.__date(fm);return $("browse-files").__sert(fl)},sort:function(fl,fo,T,fn){var fm;if(!fn&&fl===this.last_sort[0]&&fo===this.last_sort[1]){return}this.last_sort=[fl,fo,T];fm=fl(fo);this.files.sort(fm);this.smartfill();a5.load_visible_thumbs();return this.fire_visible_change_callbacks()},resort:function(){var fn,T,fm,fl;T=this.last_sort;fm=T[0];fn=T[1];fl=T[2];return this.sort(fm,fn,fl,true)},in_search_mode:function(){return bE("#browse").hasClass("search")},flex_column:function(){if(this.show_shared_with){return $("sharing-sorter").readAttribute("data-sort")}else{return $("kind-sorter").readAttribute("data-sort")}},smartfill:function(){var fl,fo,fm,fp,fn,fr,T,fq;fl=$("browse-files");fn=[];fp=this.in_search_mode();fq=this.files;for(fr=0,T=fq.length;fr<T;fr++){fo=fq[fr];fm=this.flex_column();fn.push(this.compiled_tmpl({file:fo,in_search_mode:fp,flex_column:fm,Browse:cr,Sprite:cv,Constants:Constants,FilePath:ay,Emstring:bU,GandalfUtil:ax,_:eA}))}fl.__date(fn);document.fire(this.RENDER_EVT);return bE(document).trigger(this.RENDER_EVT)},search_smartfill:function(fs,fm){var T,fr,fp,fl,fo,fn,fq;if(fm==null){fm=null}fo=[];for(fn=0,fq=fs.length;fn<fq;fn++){fr=fs[fn];fl=a5.make_browsefile(fr,fm);fl.track_in_browse();fp=this.compiled_search_tmpl({file:fl,BrowseInterface:fi,Browse:cr,Sprite:cv,Constants:Constants,_:eA,searchHelpers:am,HTML:fg,FilePath:ay,Emstring:bU,Util:d5});T=bE(fp.toHTML());fo.push(T)}bE("#browse-files").append(fo);document.fire(this.RENDER_EVT);bE(document).trigger(this.RENDER_EVT);a5.load_visible_thumbs();return this.fire_visible_change_callbacks()},add_file:function(T){this.files.push(T);if(T.target_ns){cr.ns_id_to_mount_point[T.target_ns]=T.fq_path}if(T.bytes<0){return this.deleted_shown=true}},insert_file:function(fm,fl){var T;if(!fm){return}fl=fl||0;T=this.find_file(fm.fq_path);if(T&&T!==fm){this.remove_file(T)}cR._file_index[fm.to_key()]=fm;this.update_file_pos(fm);if(fl){fm.get_div().setStyle({display:"none"})}document.fire(this.RENDER_EVT);return bE(document).trigger(this.RENDER_EVT)},add_files:function(T){return cr._push_files(T.file_info)},get_file_pos:function(T){var fl;fl=this.files.indexOf(T);cJ(fl!==-1,"file not present in @files");cJ(T.to_key() in cR._file_index,"file not present in BrowseFile._file_index");return fl},remove_file:function(T){var fm,fl;if(!T){return}fm=this.files.indexOf(T);if(fm!==-1){this.files.splice(fm,1);delete cR._file_index[T.to_key()];return(fl=T.get_div())!=null?fl.remove():void 0}},update_file_pos:function(fp,fr){var T,ft,fn,fo,fq,fm,fl,fs;if(fr==null){fr=-1}fs=this.files.indexOf(fp);if(fs!==-1){this.files.splice(fs,1)}delete fp.sort_rank;fm=this.last_sort[0];fq=this.last_sort[1];if(fr>=0){fs=fr}fo=this.in_search_mode()&&b9.sparky_search_ui_enabled?fs:d5.bsearch(this.files,fp,fm(fq),true);this.files.splice(fo,0,fp);fn=fp.get_div();T=$("browse-files");if(fn){fn.remove()}if(this.in_search_mode()&&b9.sparky_search_ui_enabled){fl=this.compiled_search_tmpl({file:fp,Browse:cr,BrowseInterface:fi,Constants:Constants,Emstring:bU,FilePath:ay,HTML:fg,searchHelpers:am,Sprite:cv,Util:d5,_:eA})}else{fl=this.compiled_tmpl({file:fp,in_search_mode:this.in_search_mode(),flex_column:this.flex_column(),Browse:cr,Constants:Constants,Emstring:bU,FilePath:ay,Sprite:cv,GandalfUtil:ax,_:eA})}ft=T.childElements();if(fo<ft.length){return T.childElements()[fo].__sert({before:fl})}else{return T.__sert(fl)}},find_file:function(T){return this.files.find(function(fl){return fl.fq_path.toLowerCase()===T.toLowerCase()})},reset_state:function(){this.msg=false;this.dragging=false;this.files=[];this.selected_files=[];this.selection=[];cR._file_index={};return bR._body_dragend()},clear:function(){$("browse-files").__date();this.hide_empty();return b9.hide_empty()},show_empty:function(){var T;this.hide_empty();if(bE("#browse-empty-team-folder").length&&this.inside_team_folder&&!this.is_in_subfolder_of_team_folder()){T="#browse-empty-team-folder"}else{T="#browse-empty"}bE(""+T+" .drag-prompt").toggle(!this.is_read_only);if(!(cr.in_search_mode()&&b9.sparky_search_ui_enabled)){return bE(T).show()}},hide_empty:function(){return bE("#browse-empty, #browse-empty-team-folder").hide()},update:function(T,fl){if(fl==null){fl=null}$("browse-box").show();if(b9.sparky_search_ui_enabled&&this.in_search_mode()){return this.search_smartfill(T.file_info,fl)}else{this.clear();if(typeof T==="string"){T=JSON.parse(T)}this.setup(T,fl);this.resort();document.fire(this.UPDATE_EVT);return bE(document).trigger(this.UPDATE_EVT)}},show_inline_sharing_on_browse_exp:function(){var fm,fp,fl,fo,T,fn;if(!cr.show_inline_share){return}if(this.in_search_mode()){bE("#browse-box").removeClass("show-inline-share");return}bE("#browse-box").addClass("show-inline-share");fn=cr.files;for(fo=0,T=fn.length;fo<T;fo++){fm=fn[fo];fl=bE(fm.get_div()).find(".sharing");fl.find(".recipients").off().on("click",eX.recipients_click);if((fm.is_shared_folder()||fm.could_be_shared_folder())&&!(fm.read_only||fm.is_read_only_mount)){fp=eA("Who do you want to collaborate on this folder with?")}else{if(fm.type===b7.FOLDER){fp=eA("Who do you want to send this folder to?")}else{fp=eA("Who do you want to send this file to?")}}fl.find(".recipients").attr("placeholder",fp);fl.find(".get-link").off().on("click",eX.link_click)}if(!this.show_sharing_init_done){this.show_sharing_init_done=true;return aW.init()}},reset_browse_exp:function(){var T;T=bE("#browse-inline-autocomplete");T.hide().off();bE("#browse-sort").append(T);return bE("#browse-box").removeClass("dropdown-menu-open")},reload_fqpath:function(fl,T){return this.reload(null,d5.urlquote(fl),T)},force_reload:function(){return this.reload(this.containing_ns_id(),d5.urlquote(this.containing_ns_path()),true)},set_title:function(){var T;if(cr.in_search_mode()){b9.set_title();return}if(!cr.inside_dir){return}T=this.containing_fq_path();return document.title=T?ay.filename(T)+" - Dropbox":cK.get_viewer().is_paired&&cr.active_user.role===Constants.ROLE_WORK?cK.get_viewer().team_name+" - Dropbox":cK.get_viewer().is_paired&&cr.active_user.role===Constants.ROLE_PERSONAL?eA("Personal")+" - Dropbox":eA("Home")+" - Dropbox"},set_selection_from_fq_paths_or_index:function(fs){var fm,fl,fq,fp,T,fn,fo,fr;T=fs.select_fq_paths;fn=fs.select_index;if(T||fn>-1){fl=[];if(T){for(fo=0,fr=T.length;fo<fr;fo++){fq=T[fo];fp=this.find_file(fq);if(fp){fl.push(fp)}}}if(!fl.length&&fn>-1){fm=this.files[fn];if(fm){fl.push(fm)}}if(fl.length){eX.set_selected_files(fl);this.scrollToWithPadding(fl.first().get_div(),100)}fs.select_fq_paths=false;return fs.select_index=-1}else{if(!b9.sparky_search_ui_enabled){return window.scrollTo(0,0)}}},set_selection_from_item_counters:function(){var fl,fr,fo,ft,fp,fn,fs,T,fq,fm;if(this.select_item_counters!=null){fo={};fq=this.select_item_counters;for(fp=0,fs=fq.length;fp<fs;fp++){fr=fq[fp];fo[fr]=true}ft=[];fm=this.files;for(fn=0,T=fm.length;fn<T;fn++){fl=fm[fn];if(fl.root_coll_item_counter in fo){ft.push(fl)}}eX.set_selected_files(ft);return this.select_item_counters=null}},reload:function(fn,fs,fl){var fu,fo,ft,fm,fq,fp,fr,T;fm="Browse.reload ns_path contains an invalid character: # ; ? : @ & = + $ (ns_path = "+fs+")";cJ(fs.search(eD.URL_ESCAPE_REGEX)===-1,fm);if(fn==null){fn=cr.active_user.root_ns}fs=ay.normalize(fs);if(a5.get_mode()!==a5.BROWSE_MODE){this.clear();a5.set_browse_mode()}if(b9._clear_on_reload){b9.clear_searchbox()}if(!an.uploading){cZ.hide()}this._stop_pagination();if(this.reloading){return}if(this.inside_dir&&fs===this.containing_ns_path()&&fn===this.containing_ns_id()&&!fl){return}fr=this.first_load?Constants.referrer:"";ft=this.deleted_shown?"?show_deleted=yes":"";fp={ns_id:fn,referrer:fr,delays_parent_request_rendering:this.first_load,sort_label:this.last_sort[2],sort_is_ascending:this.last_sort[1],sort_folders_first:bq.FOLDERS_FIRST};fp=Object.extend(fp,this.extra_reload_args);eJ("Browse.reload:",fs);this.reloading=true;T="/browse"+fs+ft;fu=2;fo=["browse",fn,fs,ft,cr.active_user.id,fu];fq=(function(fv){return function(fw){fv.reset_state();fv.update(fw);(fv.files.length?fv.hide_empty.bind(fv):fv.show_empty.bind(fv))();clearTimeout(fv.folder_loading_timeout);if(ae.isShown()&&ae.current()===fv.folder_loading_notification){ae.clear()}B.scroll_clear_cache();if(fv._is_item_selection_needed()){if(fv.paginating&&!fv._are_all_selected_items_fetched()){fv._wait_for_items()}else{fv.set_selection_from_fq_paths_or_index(cr)}}if(!m.shown()){return fv.set_title()}}})(this);bE(document).trigger(this.BEFORE_UPDATE_EVT,{ns_id:fn,ns_path:F.decode(fs)});new Ajax.DBRequest(T,{allow_retries:true,subject_user:cr.active_user,parameters:fp,log_timing:true,on304:function(fv){},onSuccess:(function(fv){return function(fB){var fz,fw,fE,fx,fA,fD,fy,fC;if(fv.in_search_mode()){return}fE=JSON.parse(fB.responseText);fD=null;fA=null;fq(fE);if(fD){fx=[];for(fy=0,fC=fD.length;fy<fC;fy++){fz=fD[fy];fx.push(cr.find_file(fz.fq_path))}eX.set_selected_files(fx);window.scrollTo(fA[0],fA[1])}else{cr.set_selection_from_item_counters()}if(cr.sharing_autoselect_first_file_enabled&&!eX.has_selected_files()){fw=fv.files[0];eX.set_selected_files([fw])}return eh.mark_time_to_interactive()}})(this),onFailure:(function(fv){return function(){if(fv.first_load){fv.reload.bind(fv).defer(Constants.root_ns,"")}return clearTimeout(fv.folder_loading_timeout)}})(this),cleanUp:(function(fv){return function(){fv.first_load=false;return fv.reloading=false}})(this),no_feed_reload:true,evalJSON:false});return true},is_in_subfolder_of_shared_folder:function(){return cr.inside_shared_folder&&cr.containing_ns_path()},is_in_subfolder_of_team_folder:function(){return cr.inside_team_folder&&cr.containing_ns_path()},is_shmodelable_path:function(T){var fl;if(cr.public_app_token){return false}if(T===""){return false}if(cr.public_folder_enabled){fl=T.toLowerCase();if(fl.startsWith("/public/")){return false}}return true},can_show_preview:function(T){var fl;return this.browser_supports_previews||((fl=T.preview_type)==="photo"||fl==="video")},can_get_details_from_fq_path:function(fm){var fl,T;fl=this.containing_fq_path();T=this.containing_mount_point();return(T&&fm.startsWith(T))||fl.startsWith(fm)},details_from_fq_path:function(fn){var fo,fl,T,fm;cJ(this.can_get_details_from_fq_path(fn));fl=this.containing_mount_point();if(fl&&fn.startsWith(fl)){T=this.containing_ns_id();fm=fn.slice(fl.length);fo=ay.filename(fn,this._get_root_name())}else{T=Constants.root_ns;fm=fn;fo=ay.filename(fn,this._get_root_name())}return{ns_id:T,ns_path:fm,fq_path:fn,folder_name:fo||this._get_root_name(),url:String(fi.browse_uri_for_fq_path(cr.active_user,fn)),icon:(fn.length?"folder_32":this._get_root_icon())}},update_header_status:function(T){return bE("#browse-header-status").text(T)},update_header_height:function(){var fl,fn,fm,T;fn=bE("#browse-header");fl=bE("#browse-files");T=0;if(fn.css("position")==="fixed"){T=bE(window).scrollTop()}if(!B.is_page_scrollable()){T=Math.abs(parseFloat(bE("html").css("top"))||0)}fm=fn.offset().top+fn.height()-fl.offset().top-T;return fl.css("padding-top",fm)},_make_breadcrumbs_data:function(){var fp,fq,fl,fo,T,fn,fm;fq=this.containing_fq_path();fp=[];T=fq.split("/");for(fl=fn=0,fm=T.length;0<=fm?fn<fm:fn>fm;fl=0<=fm?++fn:--fn){fo=ay.normalize(T.slice(0,fl+1).join("/"));fp.push(this.details_from_fq_path(fo))}return fp},_get_root_icon:function(){if(!cK.get_viewer().is_paired){return"glyph"}if(cr.active_user.role===Constants.ROLE_WORK){return"work_icon"}else{if(cr.active_user.role===Constants.ROLE_PERSONAL){return"personal_icon"}}},_get_root_name:function(){return cK.get_root_name(cr.active_user)},_get_max_breadcrumb_width:function(fn){var fl,fm,T;fm=fn?this._DROPDOWN_WIDTH:new bU(this._get_root_name()).length;if(this.use_shorter_breadcrumbs){fl=bE("#browse-rightmenu").width();T=bE("#browse-global-actions-bar").width();return((T-fl)*this._FUDGE_FACTOR/this._PX_TO_EM)-fm}else{return this._MAX_BREADCRUMB_WIDTH-fm}},_PX_TO_EM:16,_FUDGE_FACTOR:0.75,_DROPDOWN_WIDTH:2.625,_MAX_BREADCRUMB_WIDTH:20,_CONNECT_WIDTH:1.64,breadcrumb:function(){var ft,fl,fn,fu,fq,fs,T,fv,fr,fm,fo,fp;fl=this._make_breadcrumbs_data();fm=fl.collect(function(fw){return new bU(fw.fq_path?fw.folder_name:"").length});fr=0;fn=0;cJ(fl.length>0,"expected at least one breadcrumb");fv=this._get_max_breadcrumb_width();for(fq=fo=fp=fl.length-1;fp<=0?fo<=0:fo>=0;fq=fp<=0?++fo:--fo){fr+=fm[fq];if(fr>fv){break}fn+=1;fr+=this._CONNECT_WIDTH}fu=fl.slice(0,fl.length-Math.max(1,fn));fl=fl.slice(fu.length,fl.length);if(!fu.length&&fl.length>1){fl.shift()}fs=fl.pop();ft=fg.tmpl("breadcrumb_tmpl",{breadcrumbs:fl,dropdown:fu,containing_fq_path:this.containing_fq_path(),url_root:fi.get_browse_root(cr.active_user),root_name:this._get_root_name(),Sprite:cv});T=fs.folder_name;if(fs.fq_path!==""){T=bU.em_snippet(T,this._get_max_breadcrumb_width(fu.length>1))}$("browse-location").__date(ft);$("browse-location").__sert(" "+T);if(fu.length>1){return this._render_breadcrumbs_dropdown(fu)}},_render_breadcrumbs_dropdown:function(fo){var T,fm,fl,fn;T=$("breadcrumbs-box");fo.reverse();fl=fg.tmpl("breadcrumb_li_tmpl",{breadcrumbs:fo,Sprite:cv,Emstring:bU});$("browse-location").__sert(fl);fm=$("breadcrumb-dropdown");fn=function(fq){var fp;fq.stopPropagation();fm.show();fp=bE(T);return bE(fm).clonePosition(fp,{setWidth:0,setHeight:0,offsetTop:fp[0].offsetHeight,offsetLeft:parseInt(fp.css("padding-left"),10)})};T.observe("click",fn);T.observe("dragover",fn);return document.observe("click",function(){T.removeClassName("down");return fm.hide()})},viewportOffset:function(){var T,fm,fl;if(!this.files.length){return}if(!this.div_parent){fm=this.files[0].get_div().offsetParent;if(!fm){return}this._viewportOffset={};this.div_parent=$(fm);this._cumulativeOffset=this.div_parent.cumulativeOffset()}T=d5.scrollLeft(this.div_parent);fl=d5.scrollTop(this.div_parent);if(!this.scrollTop||!this.scrollLeft||this.scrollTop!==fl||this.scrollLeft!==T){this._viewportOffset.top=this._cumulativeOffset.top-fl;this._viewportOffset.left=this._cumulativeOffset.left-T;this.scrollLeft=T;this.scrollTop=fl}return this._viewportOffset},selectable:function(){return d5.enableSelection($("browse-files"))},unselectable:function(){return d5.disableSelection($("browse-files"))},_header_offset:(function(){var T;T=$("browse-header");return T.getHeight()+T.cumulativeOffset().top}).cached(1000),scrollTo:function(T){return this.scrollToWithPadding(T,3)},scrollToWithPadding:function(fn,fp){var fm,fq,fl,fo,T;if(!fn){return}fo=B.viewport_dimensions();T=B.scroll_offsets();fq=fn.cumulativeOffset().top-T.top;fm=fn.getHeight();fl=this._header_offset();if(fq<fl){B.scroll_to(0,T.top+fq-fl-fp)}else{if(fq+fm>fo.height){B.scroll_to(0,T.top+fq+fm-fo.height+fp)}}if($("modal-overlay").visible()&&$("modal").getStyle("position")==="absolute"){return fc.fix_position()}},_visible_change_callbacks:{},_next_visible_change_callback_id:0,add_visible_change_callback:function(T){this._visible_change_callbacks[this._next_visible_change_callback_id]=T;return this._next_visible_change_callback_id++},remove_visible_change_callback:function(T){return delete this._visible_change_callbacks[T]},fire_visible_change_callbacks:function(){var fm,fq,fn,fp,fo,T,fl;if(!bE.isEmptyObject(this._visible_change_callbacks)){fo=a5.get_files_in_view(),fp=fo[0],fm=fo[1];T=this._visible_change_callbacks;fl=[];for(fn in T){fq=T[fn];fl.push(fq(this.files,this.active_user.id,fp,fm))}return fl}}};k=D.BrowseUpdate=(function(){var T,fr,fq,fn,fp,fo,fm,fl;fm=function(ft){var fu,fv,fs;if(!cr.inside_dir){return}fv=ft.parent_changes;if(fv.change_to_fq_path!=null){if(fv.change_type==="moved"){if(fv.is_changing_view){fu=eA("The folder '%s' has been moved. <a href=\"/home%s\">View</a>");fu=fu.format(fv.old_fq_path.escapeHTML(),d5.urlquote(fv.new_fq_path))}else{fu=eA("This folder has been moved")}}else{if(fv.change_type==="renamed"){if(fv.is_changing_view){fu=eA("The folder '%s' has been renamed. <a href=\"/home%s\">View</a>");fu=fu.format(fv.old_fq_path.escapeHTML(),d5.urlquote(fv.new_fq_path))}else{fu=eA("This folder has been renamed to '%s'.");fs=fv.change_to_fq_path.split("/");fu=fu.format(fs[fs.length-1].escapeHTML())}}else{fu=eA("The folder '%s' has been deleted.");fu=fu.format(fv.old_fq_path.escapeHTML())}}if(fv.is_changing_view){ae.error(new fg(fu))}else{if(fv.old_fq_path===cr.containing_fq_path()){ae.success(new fg(fu))}}cr.reload_fqpath(fv.change_to_fq_path);return}return fo(ft)};fl=function(fx){var ft,fA,fz,fs,fC,fy,fv,fB,fw,fu;fA=[];fy=[];if(!cr.in_search_mode()){return}b9.clear_cache();for(fs in cr.ns_id_to_mount_point){if(!(fs in fx.mount_points)){fx.mount_points[fs]=null}}fw=fx.mount_points;for(fs in fw){fz=fw[fs];fs=parseInt(fs,10);fC=cr.ns_id_to_mount_point[fs];if(fz===fC){continue}if(fz){cr.ns_id_to_mount_point[fs]=fz}else{delete cr.ns_id_to_mount_point[fs]}fu=cr.files;for(fv=0,fB=fu.length;fv<fB;fv++){ft=fu[fv];if(ft.fq_path.indexOf(fC)===0&&ft.target_ns!==fs){if(fz){ft.fq_path=fz+ft.fq_path.slice(fC.length);ft.href=fi.get_browse_root(cr.active_user)+fz+ft.href.slice(5+fC.length);fA.push([ft,ft])}else{fy.push(ft)}}}}return fo(fx,[],fy,fA)};fo=function(fP,fA,fJ,fz){var fE,fy,fK,fF,fI,fB,fH,fG,fM,fC,fv,ft,fs,fL,fO,fN,fD,fx,fw,fu;if(fA==null){fA=[]}if(fJ==null){fJ=[]}if(fz==null){fz=[]}fD=fP.added;for(fv=0,fL=fD.length;fv<fL;fv++){fK=fD[fv];fy=ay.normalize(ay.parent_dir(fK.ns_path));if(cr.in_search_mode()||(fK.ns_id===cr.containing_ns_id()&&fy===cr.containing_ns_path())){fE=a5.make_browsefile(fK);fE.track_in_browse();fA.push(fE)}}fx=fP.removed;for(ft=0,fO=fx.length;ft<fO;ft++){fF=fx[ft];fJ.push(cr.find_file(fF))}fw=fP.moved;for(fs=0,fN=fw.length;fs<fN;fs++){fu=fw[fs],fI=fu[0],fC=fu[1];fM=ay.normalize(ay.parent_dir(fC.ns_path));fG=null;fH=cr.in_search_mode()||(fC.ns_id===cr.containing_ns_id()&&fM===cr.containing_ns_path());fB=cr.in_search_mode()&&b9.sparky_search_ui_enabled;if(fH&&!(fB&&cr.find_file(fC.ns_path))){fG=a5.make_browsefile(fC);fG.track_in_browse()}fz.push([cr.find_file(fI),fG])}document.fire(bD.ADD,{files:fA});bE(document).trigger(bD.ADD,{files:fA});document.fire(bD.MOVE,{files:fz});a5.load_visible_thumbs();cr.fire_visible_change_callbacks();return fp(fA,fJ,fz)};T=function(fv,ft,fu,fs){fv.css("background","");bE(document).trigger("db:browse:update_rendered");return document.fire(bD.REMOVE,{files:fu})};fp=function(fC,fB,fD){var fu,fF,fz,fG,fy,fx,fv,fE,ft,fs,fA,fw;fz=(fC.length+fB.length)<=10;for(fy=0,fE=fC.length;fy<fE;fy++){fu=fC[fy];if(!(fu&&fu.get_div())){continue}fr(fu,fz,fC,fB,fD)}for(fx=0,ft=fB.length;fx<ft;fx++){fu=fB[fx];if(!(fu&&fu.get_div())){continue}fn(fu,fz,fC,fB,fD)}fw=[];for(fv=0,fs=fD.length;fv<fs;fv++){fA=fD[fv],fF=fA[0],fG=fA[1];if(fF){fn(fF,fz,fC,fB,fD)}if(fG){fw.push(fr(fG,fz,fC,fB,fD))}else{fw.push(void 0)}}return fw};fq=function(fs){var ft;ft=eX.is_selected(fs)?"#83B8DC":"#CCEAFF";return bE(fs.get_div()).css("background-color",ft)};fn=function(fs,fv,fu,fw,ft){var fx;fq(fs);fx=bE(fs.get_div());if(fv){return fx.show().slideUp("normal",function(){return T(fx,fu,fw,ft)})}else{fx.hide();return T(fx,fu,fw,ft)}};fr=function(fs,fv,fu,fw,ft){var fx;fq(fs);fx=bE(fs.get_div());if(fv){return fx.hide().slideDown("normal",function(){return T(fx,fu,fw,ft)})}else{fx.show();return T(fx,fu,fw,ft)}};return{init:function(){var ft,fs;fs=d8[cr.active_user.id];return ft=fs.subscribe_sfj({name:"BrowseUpdater",handler:function(){var fC,fx,fz,fB,fy,fD,fw,fv,fu,fA;fD=cr.in_search_mode();fC=fD?fl:fm;fu=fD?"/update/list_search":"/update/list_dir";if(!(cr.inside_dir||fD)){fs.handler_failure(ft);return}if(fD){fv=b9.get_state();if(fv.is_advanced){fy=fv}else{fy={all_terms:fv.query}}}else{fy={fq_dir:cr.containing_fq_path(),show_deleted:cr.deleted_shown}}fy.ns_map=((function(){var fF,fE;fF=fs.get_ns_map();fE=[];for(fB in fF){fw=fF[fB];fE.push(""+fB+"_"+fw)}return fE})()).join(",");cJ(cr.active_user,"No active_user was set before calling "+fu+". Active user loaded? "+(__CIRCULAR_DEPENDENCY__.active_user_loaded||false)+". Error before loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_before_loading||false)+". Error after loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_after_loading||false)+".",true,[],false);fA=cr.subscribe_sfj_callbacks;for(fz in fA){fx=fA[fz];fx()}return new bE.ajax(fu,{data:fy,dataType:"json",type:"POST",subject_user:cr.active_user,success:function(fE){fC(fE);return fs.handler_success(ft,{ns_map:fE.ns_map})},error:function(){return fs.handler_failure(ft)}})}})}}})();var aF;aF=D.FileEvents={DELETE:"db:bulk_delete",COPY:"db:bulk_copy",MOVE:"db:bulk_move",RENAME:"db:bulk_rename",PURGE:"db:bulk_purge",RESTORE:"db:bulk_restore",UPLOAD:"db:upload",COMPRESS:"db:compress",SF_NEW:"db:sf_new",SF_LEAVE:"db:sf_leave",SF_UNSHARE:"db:sf_unshare",SF_REJOIN:"db:sf_rejoin",SF_INVITE:"db:sf_invite",SF_IGNORE:"db:sf_ignore",LINKS_REMOVE:"db:link_remove",LINKS_ADD:"db:link_add",FILE_ACTIVITY_UPDATE:"db:file_activity_update"};var ec;ec=D.ProgressWatcher={job_info:{},INIT_POLL_INT:1000,FAILS_MEAN_FAIL:3,MODAL_WAIT_MS:1000,watch:function(T,fo){var fn,fm,fl;if(T.async_task_id){if(!T.async_task_id.match(/^[A-Za-z0-9_\-=]*$/)){return}fm=T.async_task_id}else{fm=T.job_id}ec.job_info[fm]={};fn=ec.job_info[fm];fn.subject_user=T.subject_user||((fl=T.parameters)!=null?fl[Constants.UID_PARAM_NAME]:void 0);fn.req=T;fn.is_async_task=!!T.async_task_id;fn.poll_int=ec.INIT_POLL_INT;fn.poll_count=0;fn.int_id=setInterval(ec.update_for(fm),fn.poll_int);fn.failures=0;fn.start_time=b4.time();return fn.dont_hide=fo},update_for:function(T){return function(){return ec.update(T)}},backoff:function(fl){var T;T=ec.job_info[fl];clearInterval(T.int_id);T.poll_int=Math.min(Math.floor(T.poll_int*1.5),30000);return T.int_id=setInterval(ec.update_for(fl),T.poll_int)},update:function(fm){var T,fl;fl=ec.job_info[fm];if(dj.peek(fm)){return ec.done(fm)}fl.poll_count++;if(fl.poll_count%10===0){ec.backoff(fm)}if(!fl.modaled&&b4.time()-fl.start_time>ec.MODAL_WAIT_MS){T=fl.req.options;eB.show(T.progress_text);T.onProgress=eB.update;if(T.on_modal_shown!=null){T.on_modal_shown()}fl.modaled=true}if(fl.is_async_task){return ec.get_async_task_status(fm)}else{return ec.get_job_status(fm)}},get_job_status:function(T){return new Ajax.DBRequest("/job_status/"+T,{method:"post",subject_user:ec.job_info[T].subject_user,onSuccess:function(fm){var fn,fl;fn=ec.job_info[T];fl=fm.responseText;if(fl.indexOf("err")===0){ec.done(T);if(fn.req.options.onFailure&&!dj.handled(T)){fn.req.options.onFailure(fm)}return}if(fl.indexOf("done")===0){fn.req.options.job=false;if(!dj.peek(T)){new Ajax.Request("/job_results/"+T,{method:"post",parameters:{t:bw.read(Constants.JS_CSRF_COOKIE)},onSuccess:function(fp){if(dj.handled(T)){return}ao.clearWorkingMessage();if(fn.req.options.onSuccess){return fn.req.options.onSuccess(fp)}},onFailure:function(fp){if(dj.handled(T)){return}ao.clearWorkingMessage();if(fn.req.options.onFailure){return fn.req.options.onFailure(fp)}}})}return ec.done(T)}else{try{if(fn.req.options.onProgress){return fn.req.options.onProgress(fm.responseText)}}catch(fo){}}},onFailure:function(fl){var fm;fm=ec.job_info[T];fm.failures++;if(fm.failures>=ec.FAILS_MEAN_FAIL){if(fm.req.options.onFailure){fm.req.options.onFailure(fl,true)}ao.remove(fm.req);return ec.done(T)}}})},get_async_task_status:function(T){return new Ajax.DBRequest("/async_task_status/"+T,{method:"post",subject_user:ec.job_info[T].subject_user,onSuccess:function(fm){var fn,fl;fn=ec.job_info[T];fl=fm.responseText;if(fl.indexOf("done:")===0||fl.indexOf("err:")===0){dj.handled(T);ao.clearWorkingMessage();if(fl.indexOf("done:")===0){fm.responseText=fl.substr(5)}if(fn.req.options.onSuccess){fn.req.options.onSuccess(fm)}if(fn.req.options.onComplete){fn.req.options.onComplete(fm)}return ec.done(T)}else{if(fl.indexOf("async_task_err:")===0){ae.error(new fg(fl.substr(15)));dj.handled(T);ao.clearWorkingMessage();ec.done(T);return cr.force_reload()}else{try{if(fn.req.options.onProgress){return fn.req.options.onProgress(fm.responseText)}}catch(fo){}}}},onFailure:function(fl){var fm;fm=ec.job_info[T];fm.failures++;if(fm.failures>=ec.FAILS_MEAN_FAIL){try{if(fm.req.options.onFailure){fm.req.options.onFailure(fl,true)}}catch(fn){}ao.remove(fm.req);return ec.done(T)}}})},done:function(fl){var T;T=ec.job_info[fl];clearInterval(T.int_id);if(!T.dont_hide){delete ec.job_info[fl];if(!(T.req.async_task_id&&T.req.async_task_id!==fl)){return eB.hide(fl)}}else{return eB.update("1/1")}}};var dr,bY,bC,bK=[].indexOf||function(fm){for(var fl=0,T=this.length;fl<T;fl++){if(fl in this&&this[fl]===fm){return fl}}return -1};bC=D.NamespaceEvents=(function(){function T(fl){this.ns_id=fl;this.earliest=Number.MAX_VALUE;this.events=[];this.seen={};this.done=false}return T})();dr=D.EventDatePicker=(function(){function T(fm){var fl,fn,fo;this.on_change=fm;bE(document.body).on("click",(function(fp){return function(fq){return fp.hide_calendar(fq)}})(this));fo=new Element("div",{id:"cal_container"});bE(fo).bind("click",function(fp){return fp.preventDefault()});bE(document.body).append(fo);this.calendar=new H("cal_container",{onDateChange:(function(fp){return function(fq){return fp.on_change(fq)}})(this),disable_future:true});bE(fo).css("position","fixed");fn=bE("#cal_date");fl=bE("#cal_container");fl.clonePosition(fn,{setWidth:false,setHeight:false,offsetTop:fn.height(),offsetLeft:fn.width()-fl.children().first()[0].offsetWidth});this.hide_calendar()}T.prototype.show_calendar=function(fl){if(this.shown){bE("#cal_container").hide();this.shown=false;return}bE("#cal_container").show();return this.shown=true};T.prototype.hide_calendar=function(fl){if(fl&&bE(fl.target).closest("#cal_date").length>0){return}bE("#cal_container").hide();this.shown=false;return true};return T})();bY=INLINE_JS.Events=D.Events={ns:null,role:"all",now:Number(new Date()),timestamp:d5.start_of_day(new Date(Number(new Date())+60*60*24*1000)),request_in_flight:false,one_day:60*60*24*1000,user_navigated_away:false,init:function(T,fp,fr,fm,fq){var fn,fo,fl;if(fq==null){fq=false}this.awaitingFirstRender=true;fl=eD.deconstruct_url();this.first_event_map=T;this.roles=fp;this.rss_data=fr;this.role_has_events=fm;this.deletions_only=fq;this.role_picker=B.controller(bE("#role-selector"));if(this.roles.length===1){this.role=this.roles[0].role}else{if(fl.qargs.role){this.role=fl.qargs.role;this.role_picker.set_state(this.role)}else{if(this.deletions_only){this.role=this.roles[this.roles.length-1].role}}}this.date_picker=new dr((function(fs){return function(ft){fs.change_date(ft);fs.set_url();return ba.WebMiscActivityLogger.log("filter_events_date")}})(this));this._init_state();this.role_picker.on_state_change=(function(fs){return function(){fs.role=fs.role_picker.get_state();if(fs.ns&&!bx(fs.valid_roles()).any(function(ft){return ft.ns_ids.contains(fs.ns.ns_id)})){fs.ns=null;aP.set_selected_by_value(bE("#namespace-list")[0],"false")}fs.set_url();return fs.get_more(true)}})(this);bO.set_during_login_callback((function(fs){return function(fu,ft){return window.location.reload()}})(this));bE(window).bind("beforeunload",(function(fs){return function(){fs.user_navigated_away=true;return void 0}})(this));if(bE("#namespace-list-container")[0]){bE("#namespace-list-container")[0].observe("db:change",(function(fs){return function(ft){fs.ns=fs.namespaces[JSON.parse(ft.memo)];fs.set_url();fs.get_more(true);return ba.WebMiscActivityLogger.log("filter_events_shared_folder")}})(this))}bE(window).on("scroll",(function(fs){return function(){document.body.scrollTop=Math.min(document.body.scrollTop,document.body.scrollHeight-B.viewport_dimensions().height-10);return fs.get_more()}})(this));if(fl.qargs.ns){aP.set_selected_by_value(bE("#namespace-list")[0],fl.qargs.ns);this.ns=this.namespaces[fl.qargs.ns]}if(fl.qargs.date){fo=fl.qargs.date.split("-").map(Number);fn=new Date(fo[2],fo[1]-1,fo[0]);this.date_picker.calendar.selected_date=fn;this.change_date(fn)}this.update_calendar_first_day();return this.get_more()},_init_state:function(){var fl,fo,fr,fp,fn,fm,fq,T;this.namespaces={};fq=bx(this.roles).values();for(fr=0,fn=fq.length;fr<fn;fr++){fo=fq[fr];T=fo.ns_ids;for(fp=0,fm=T.length;fp<fm;fp++){fl=T[fp];this.namespaces[fl]=new bC(fl)}}if(this.ns){return this.ns=this.namespaces[this.ns.ns_id]}},change_date:function(T){this.timestamp=Number(T)+this.one_day;if(this.timestamp<this.earliest()||this.timestamp>this.latest){this.latest=this.timestamp;this._init_state()}bE("#cur_date_text").text(N.localize(T));return this.get_more(true)},is_scrolled_down:function(){var T,fm,fl;fl=B.scroll_offsets().top;fm=B.viewport_dimensions().height;T=bE("#events").height();return fl+fm+50>=T},get_more:function(fn){var T,fl,fm;if(this.request_in_flight){return}if(bx(this.valid_nss()).all(function(fo){return fo.done})){this.render();return}if(!(fn||this.is_scrolled_down())){this.render();return}this.request_in_flight=true;this.render();fl=(function(fo){return function(){return bx(fo.valid_nss()).map(function(fp){return fp.ns_id}).join(",")}})(this);T=Math.min(this.earliest(),this.timestamp/1000,Math.floor(this.now/1000));fm={page_size:25,ns_ids:fl(),timestamp:T};if(this.deletions_only){fm.deletions_only=true}return new Ajax.DBRequest("/events/ajax",{method:"POST",parameters:fm,onSuccess:(function(fo){return function(fB){var fz,fq,fC,fs,fA,fx,fw,fu,fD,fr,fp,fy,fv,ft;fz=JSON.parse(fB.responseText);fo.request_in_flight=false;fy=fz.events;for(fx=0,fD=fy.length;fx<fD;fx++){fq=fy[fx];fq.html=bE(fq.html)[0];fA=fq.pkey+" "+(fq.html.textContent||fq.html.innerText);fC=fo.namespaces[fq.ns_id];if(!fC.seen[fA]){fC.events.push(fq);fC.seen[fA]=true;fC.earliest=fq.timestamp}}if(fz.events.length>0){fv=fz.ns_ids;for(fw=0,fr=fv.length;fw<fr;fw++){fs=fv[fw];fo.namespaces[fs].earliest=bx(fz.events).map(function(fE){return fE.timestamp}).min()}}fo.render();if(fz.events.last()){fo.get_more()}else{if(bx(fz.ns_ids).join(",")!==fl()){fo.get_more()}else{ft=fz.ns_ids;for(fu=0,fp=ft.length;fu<fp;fu++){fs=ft[fu];fo.namespaces[fs].done=true}}}return ap.configureAllLinks("#event-table",".inline-restore","events")}})(this),onError:(function(fo){return function(){fo.request_in_flight=false;if(!fo.user_navigated_away){return ae.error(eA("We had problems loading your events feed; please try again later."))}}})(this)})},valid_roles:function(){if(this.role!=="all"){return bx(this.roles).filter((function(T){return function(fl){return fl.role===T.role}})(this))}else{return this.roles}},valid_nss:function(){if(this.ns){return[this.ns]}else{return bx(this.valid_roles()).map((function(T){return function(fl){return fl.ns_ids}})(this)).flatten().map((function(T){return function(fl){return T.namespaces[fl]}})(this)).uniq()}},earliest:function(){return bx(this.valid_nss()).map((function(T){return function(fl){return fl.earliest}})(this)).max()},latest:Number.MAX_VALUE,update_calendar_first_day:function(){this.date_picker.calendar.options.first_day=d5.start_of_day(new Date(bx(this.valid_nss()).map((function(T){return function(fl){return T.first_event_map[fl.ns_id]}})(this)).min()));if(this.date_picker.calendar.selected_date<this.date_picker.calendar.options.first_day){this.date_picker.calendar.selected_date=d5.start_of_day(new Date(Number(this.date_picker.calendar.options.first_day)+this.one_day));this.change_date(this.date_picker.calendar.selected_date)}return this.date_picker.calendar.render()},set_url:function(){var fm,fn,fl,T;fl=new Date(this.timestamp-this.one_day);fn=this.now-this.timestamp>0;fm={};if(this.ns){fm.ns=this.ns.ns_id}if(this.role!=="all"){fm.role=this.role}if(fn){fm.date=""+(fl.getDate())+"-"+(fl.getMonth()+1)+"-"+(fl.getFullYear())}T=this.deletions_only?"/deleted_files":"/events";return eD.push_state(T,fm)},on_preview_open:function(fl){var T;T=cK.get_viewer().get_user_by_id(fl.user_id);bE(document).on("db:filepreview:close",this.on_preview_close);m.show(fl,T);return false},on_preview_close:function(){bE(document).off("db:filepreview:close",this.on_preview_close);return document.title=eA("Recent events - Dropbox")},render:function(){var T,fA,fC,fB,fu,fD,ft,fG,fy,fm,fs,fw,fr,fx,fz,fl,fq,fo,fn,fE,fF,fv,fp;if(this.role_has_events[this.role]){this.update_calendar_first_day()}T=bx(this.valid_nss()).map((function(fH){return function(fI){return fI.events}})(this)).flatten();fA=this.earliest();fl=bx(T).sortBy(function(fH){return -fH.timestamp});fu=bx(fl).filter((function(fH){return function(fI){return fI.timestamp>=fA&&fI.timestamp<fH.timestamp/1000&&(fH.ns!==null||!fI.is_dup)}})(this));if(this.role_has_events[this.role]){bE("#event-table").empty();for(fo=0,fE=fu.length;fo<fE;fo++){fs=fu[fo];fC=bE(fs.html);fw=bx(this.valid_roles()).filter((function(fH){return function(fI){return fI.ns_ids.contains(fs.ns_id)}})(this)).map((function(fH){return function(fI){return fI.name}})(this)).join(" & ");if(this.deletions_only){fC.find("span.role-path").text(fw)}else{fC.find("span.role-label > span").text(fw)}bE("#event-table").append(fC);if(fs.preview_jsinfo!=null){fB=fs.preview_jsinfo;ft=fC.find("#prev_link");ft.on("click",this.on_preview_open.bind(this,fB));fz=fC.find(".inline-button");fz.on("click",this._inline_share_button.bind(this,fB))}}bE("#events-container").show();bE("#events-sub-header").show();bE("#events-sub-header").css("visibility","visible");bE("#events-empty-state").hide();bE(".empty-explanation").hide()}else{if(!this.request_in_flight){bE("#events-container").hide();bE("#events-sub-header").hide();bE("#events-empty-state").show();bE(".empty-explanation").show()}}if(!this.request_in_flight){if(this.awaitingFirstRender){this.awaitingFirstRender=false;ba.WebMiscActivityLogger.log("events-first-load",{time:Number(new Date())-this.now})}bE("#more-loading").hide()}else{bE("#more-loading").show()}bE("#more-loading").css("marginTop",this.earliest()===Number.MAX_VALUE?"140px":"20px");fv=bE("#namespace-list > li");for(fn=0,fF=fv.length;fn<fF;fn++){fD=fv[fn];fm=bx(this.valid_roles()).map((function(fH){return function(fI){return fI.ns_ids}})(this)).flatten().any((function(fH){return function(fI){return fI===bE(fD).data("value")}})(this));fy=bE(fD).data("value")===false;fq=fy||fm;bE(fD).css("display",fq?"":"none")}fx=bK.call((function(){var fK,fI,fH,fJ;fH=this.valid_roles();fJ=[];for(fK=0,fI=fH.length;fK<fI;fK++){fG=fH[fK];fJ.push(fG.ns_ids.length>1)}return fJ}).call(this),true)>=0;if(!this.request_in_flight){if(fx){bE("#namespace-list-container").css("visibility","visible");bE("#namespace-list-container").show()}else{bE("#namespace-list-container").hide()}fr=this.rss_data[(fp=this.ns)!=null?fp.ns_id:void 0]||this.rss_data[this.role];if(fr&&this.role_has_events[this.role]){bE("#rss-feed a").attr("data-title",fr.title);bE("#rss_url").val(fr.url);bE("#reset-rss-link").on("click",(function(fH){return function(fI){new Ajax.DBRequest("/reset_rss",{parameters:{ns_id:fr.ns_id},onSuccess:function(){ae.success(eA("RSS feed url successfully reset."));return b1.redirect("/events")}});return false}})(this));bE("#rss_url").focus();bE("#rss-feed").show();return bE("#rss-feed").css("visibility","visible")}else{return bE("#rss-feed").hide()}}},show_rss_modal:function(){var T,fl;fc.show(eA("Subscribe to this RSS feed"),bE("#rss-modal")[0]);fl=bE("#rss_url").val();T=s.clipboard_overlay(fl,bE("#real_copy"),function(){ae.success(eA("Link copied to clipboard!"));return fc.hide()},bE(".modal-buttons"));return T.css({zIndex:1001})},_inline_share_button:function(fl,fn){var T,fm;fn.preventDefault();T="events_table_row";fm=ba.ShmodelUILogger.get_target_item(fl);ba.ShmodelUILogger.log("single_entry_share",T,fm);return new dg(fl.user_id,fl.fq_path,T).show()}};var N;N=D.DateUtil={fromSecondsSinceEpochUTC:function(T){var fl;fl=new Date(1970,0,1);fl.setSeconds(T);return fl},applyTimezoneOffset:function(fl,fn){var T,fm;T=parseInt(fn,10);fm=60*(fn-T);fl.setHours(fl.getHours()+T);return fl.setMinutes(fl.getMinutes()+fm)},contextualFormat:function(fl){var fn,fp,T,fm,fo;T=new Date(Date.now());fm=(T.getTime()-fl.getTime())/1000;fn=0;if(fm<8*3600){return b4.ago(fl)}this.applyTimezoneOffset(T,Constants.TIMEZONE_OFFSET);this.applyTimezoneOffset(fl,Constants.TIMEZONE_OFFSET);fo=new Date(Date.now());this.applyTimezoneOffset(fo,Constants.TIMEZONE_OFFSET);fo.setDate(fo.getDate()-1);if(fl.getYear()===T.getYear()&&fl.getMonth()===T.getMonth()&&fl.getDate()===T.getDate()){fp=eA("Today %(time)s");return fp.format({time:N.format(fl,Constants.time_format)})}else{if(fl.getYear()===fo.getYear()&&fl.getMonth()===fo.getMonth()&&fl.getDate()===fo.getDate()){fp=eA("Yesterday %(time)s");return fp.format({time:N.format(fl,Constants.time_format)})}else{return N.format(fl,Constants.datetime_format)}}},toUTCDate:function(T){return new Date(T.getUTCFullYear(),T.getUTCMonth(),T.getUTCDate(),T.getUTCHours(),T.getUTCMinutes(),T.getUTCSeconds(),T.getUTCMilliseconds())},differenceStr:function(fn,fq){var fs,fr,fl,fm,fo,T,fp;fo=(fn.getTime()-fq.getTime())/1000;if(fo<60){return bc("%d sec","%d secs",fo).format(fo)}else{if(fo<3600){fl=parseInt(fo/60,10);return bc("%d min","%d mins",fl).format(fl)}else{if(fo<86400){fr=parseInt(fo/3600,10);return bc("%d hour","%d hours",fr).format(fr)}else{if(fo<2592000){fs=parseInt(fo/(60*60*24),10);return bc("%d day","%d days",fs).format(fs)}else{if(fo<4838400){T=parseInt(fo/(60*60*24*7),10);return bc("%d week","%d weeks",T).format(T)}else{if(fo<31536000){fm=parseInt(fo/(60*60*24*30),10);return bc("%d month","%d months",fm).format(fm)}else{fp=parseInt(fo/(60*60*24*365),10);return bc("%d year","%d years",fp).format(fp)}}}}}}},localize:function(T){cJ(Constants.date_format!=null,"Date format missing.");return N.format(T,Constants.date_format)},format:function(T,fl){var fm;cJ(typeof fl==="string","Date format requires a format string");fm={yy:(function(fn){return function(){return T.getFullYear().toString().substring(2)}})(this),yyyy:(function(fn){return function(){return T.getFullYear().toString()}})(this),M:(function(fn){return function(){return(T.getMonth()+1).toString()}})(this),MM:(function(fn){return function(){return(T.getMonth()+1).toString().lpad(2)}})(this),d:(function(fn){return function(){return T.getDate().toString()}})(this),dd:(function(fn){return function(){return T.getDate().toString().lpad(2)}})(this),h:(function(fn){return function(){return(T.getHours()%12||12).toString()}})(this),H:(function(fn){return function(){return T.getHours().toString()}})(this),HH:(function(fn){return function(){return T.getHours().toString().lpad(2)}})(this),m:(function(fn){return function(){return T.getMinutes().toString()}})(this),mm:(function(fn){return function(){return T.getMinutes().toString().lpad(2)}})(this),a:(function(fn){return function(){if(T.getHours()>11){return eA("PM",{comment:"PM as in evening"})}else{return eA("AM",{comment:"AM as in morning"})}}})(this)};return fl.replace(/([a-zA-Z]+)/g,function(fn){if(fm[fn]!=null){return fm[fn]()}else{return fn}})}};var eR;eR=INLINE_JS.Timezone=D.Timezone={check_timezone:function(){var T;if(!cK.get_viewer().is_signed_in){return}T=eR.get_current_timezone();if((Constants.auto_timezone_offset==null)||Constants.auto_timezone_offset!==T){return eR.update(T)}},get_current_timezone:function(){var fn,fm,T,fl;fm=new Date();fm.setSeconds(0);fm.setMilliseconds(0);fl=fm.toGMTString();fn=new Date(fl.substring(0,fl.lastIndexOf(" ")));T=(fm-fn)/(1000*60*60);return T},update:function(T){cJ(typeof T==="number","Timezone offset was not a number: "+T);return new Ajax.DBRequest("/set_timezone",{parameters:{offset:T},noAutonotify:true})},update_timezones_dropdown:function(fl,fn){var fm,T;if(fn==null){fn=null}T=eR.timezones_by_country[fl];bE("#timezone_id").empty();return bE("#timezone_id").append((function(){var fq,fp,fo;fo=[];for(fq=0,fp=T.length;fq<fp;fq++){fm=T[fq];fo.push(bE('<option value="'+fm.id+'">'+fm.name+"</option>").prop("selected",fm.id===fn))}return fo})())},auto:function(){var T;T=$F("timezone_auto");if(T){return bE("#tz").hide()}else{if(eR.default_country){bE("#timezone_country").val(eR.default_country);eR.update_timezones_dropdown(eR.default_country)}return bE("#tz").show()}},load_data:function(fl,T){eR.timezones_by_country=fl;return eR.default_country=T}};var bh,bJ;bJ=D.CreateApp={init:function(fn,fl){var fm,fo,T;this.accepted_tos_by_uid=fn;this.form=fm=bE("#create-app-form");this.email_verification=null;if(!cK.get_viewer().is_paired){T=cK.get_viewer().get_users()[0];this.select_user(T.id)}fo=(function(fp){return function(fq){var fr;fr=fq.target.name;return fm.find("input[name="+fr+"]").each(function(){bE(this).parents("label").removeClass("active");return fm.removeClass(bE(this).data("next"))})}})(this);fm.find("input[type=radio]").change(function(fp){fo(fp);bE(fp.target).parents("label").addClass("active");return fm.addClass(bE(this).data("next"))});fm.find("input[type=checkbox]").change(function(fp){var fq;if(bE(this).filter("#accept-tos").length){return}bE(fp.target).parents("label").toggleClass("active");fq=fm.find("input[name="+(bE(this).attr("name"))+"]:checked");fm.toggleClass(bE(this).data("next"),fq.length!==0)});fm.find(".role-choice input").change((function(fp){return function(fr){var fq,fs;fq=fm.find(".role-choice input:checked");fs=fq.val();if(!cK.get_viewer().is_uid_signed_in(fs)){fq.prop("checked",false);fo(fr);bO.show_modal({user_id:fs,on_success:function(){return fq.prop("checked",true).trigger("change")}});return false}else{return fp.select_user(fs)}}})(this));fm.find("input:checked").trigger("change");fm.find("input[name=tos_accept]").change((function(fp){return function(fq){return fp.update_submit_enabled()}})(this));fm.find("#send-verify-email, #resend-verify-email").click((function(fp){return function(fq){fp.email_verification.send_email(fl,function(){fm.addClass("verify-email-sent");fp.email_verification.flash_email_sent_notification();return fp.email_verification.ensure_polling(function(){if(!fp.email_verification.user.is_email_verified){return}fm.addClass("email-verified");fm.removeClass("verifiy-email-sent");return fp.update_submit_enabled()})});return false}})(this));return fm.submit(function(fp){fm=bE(fp.target);bT.ajax_submit(fm[0],false,(function(fq){return window.location.href=fq.responseText}));return false})},select_user:function(T){this.email_verification=d3.get_for_user(cK.get_viewer().get_user_by_id(T));this.form.find("#accept-tos-wrapper").toggle(!this.accepted_tos_by_uid[T]);this.form.find("input[name=tos_accept]").prop("checked",false);this.form.removeClass("verify-email-sent");this.form.find("#verify-email-wrapper").toggle(!this.email_verification.user.is_email_verified);this.form.toggleClass("email-verified",this.email_verification.user.is_email_verified);return this.update_submit_enabled()},update_submit_enabled:function(){var fl,T;T=this.email_verification.user;fl=this.accepted_tos_by_uid[T.id]||this.form.find("input[name=tos_accept]").prop("checked");return this.form.find("#create-button").prop("disabled",!fl)}};bh=INLINE_JS.Apps=D.Apps={init_apps:function(){return bE("#show-disabled-apps").click(function(){bE(this).parent().hide();bE("#disabled-apps").show();return false})},init_app_info:function(fl,fm,T){this.user_email=T;bE("#app-info .icon-container").each(function(fo,fp){var fn;fn=bE(fp);return fn.append(Dropbox.createChooseButton({success:function(fq){fn.find(".icon").attr("src",fq[0].thumbnailLink);return fn.find("input[type=hidden]").val(fq[0].link)},linkType:"direct",extensions:["images"]}))});this._hoverable_tmpl=fg.tmpl("hoverable_tmpl");this._webhook_info_row_tmpl=fg.tmpl("webhook_info_row_tmpl");bE("#domain-list").on("click",".img-container",function(fn){bh.remove_domain(fn.currentTarget.parentNode,fl)});bE("#oauth-uri-list").on("click",".img-container",function(fn){bh.remove_oauth_uri(fn.currentTarget.parentNode,fl)});bE("#webhook-list").on("click",".img-container",function(fn){bh.remove_webhook(fn.currentTarget.parentNode,fl)});bE("#webhook-list").on("click",".webhook-actions.enabled .webhook_disable",function(fn){bh.update_webhook_url(fn.currentTarget,fl,false)});bE("#webhook-list").on("click",".webhook-actions.disabled .webhook_enable",function(fn){bh.update_webhook_url(fn.currentTarget,fl,true)});bE("#generate-token-button").on("click",function(fn){bh.generate_access_token(fl)});bE("#delete-app-button").on("click",function(fn){bh.confirm_disable(fm,fl,0)});bE("#webhook_url").on("click change paste focus",function(fn){bE("#webhook-form").removeClass("error")});this.init_app_info_add_redirect_uri();return bE("#oauth2-allow-implicit-grant").on("change",function(fn){return bh.set_oauth2_allow_implicit_grant(fn.currentTarget,fl)})},init_app_info_add_redirect_uri:function(){var T,fl,fm,fn;fl=/^\#?add_redirect_uri=(.*)$/.exec(window.location.hash||"");if(!fl){return}fn=window.decodeURIComponent(fl[1]);T=bE("#oauth-add-uri-form");bE("input[name=oauth_uri]",T).val(fn);fm=bE("#add-redirect-uri-modal")[0];bE("#add-redirect-uri-modal-uri").text(fn);fc.show(eA("Add OAuth redirect URI"),fm,{doit:function(){var fo;if(window.history&&window.history.replaceState){fo=window.location.href;fo=fo.substring(0,fo.indexOf("#"));window.history.replaceState({},document.title,fo)}else{window.location.hash=""}fc.hide();return bh.submit_new_oauth_uri(bE("#oauth-add-uri-form")[0])}})},init_app_datastores_browse:function(T){this.ds_info=T;if(cK.get_viewer().is_paired){this.role_picker=B.controller(bE("#role-selector"));this.role_picker.on_state_change=this.app_datastores_browse_render.bind(this);return bO.set_during_login_callback((function(fl){return function(fn,fm){return fl.app_datastores_browse_reload_info(function(){return fm()},function(){fm("Error displaying datastores");return window.location.reload()})}})(this))}},app_datastores_browse_reload_info:function(fl,T){bE.ajax({url:"/developers/apps/datastores/info",success:(function(fm){return function(fn){fm.ds_info=fn;fm.app_datastores_browse_render();return typeof fl==="function"?fl():void 0}})(this),error:(function(fm){return function(fn){return typeof T==="function"?T(fn):void 0}})(this)});return false},app_datastores_browse_render:function(){this.app_datastores_browse_render_id("#apps_developed_container");this.app_datastores_browse_render_id("#apps_used_container");return this.app_datastores_browse_render_empty()},app_datastores_browse_render_empty:function(){var fm,fl,T,fn;fl=bE("#no_apps_container").empty();if(bE("#apps_developed_container").children().length!==0||bE("#apps_used_container").children().length!==0){return}fm=bE("<div class='empty-state'></div>").appendTo(fl);switch((fn=this.role_picker)!=null?fn.get_state():void 0){case d1.PERSONAL:case d1.WORK:T=cK.get_viewer().get_user_by_role(this.role_picker.get_state());return fm.append("You don't have any datastores in your "+cK.get_role_title(T)+" Dropbox.");default:return fm.append("You don't have any datastores in your Dropbox.")}},app_datastores_browse_render_id:function(fr){var fl,fq,fn,fp,fo,fm,T;fp=this.app_datastores_browse_get_id_info(fr);fq=bE(fr);fq.empty();fl="";for(fm=0,T=fp.length;fm<T;fm++){fn=fp[fm];if(this.app_datastores_should_render(fn.uid)){fl+=fn.html}}if(fl){fq.append(this.app_datastores_browse_get_id_header(fr));fo=bE("<div class='app-list clearfix'/>").appendTo(fq);return fo.html(fl)}},app_datastores_should_render:function(fl){var T;if(this.role_picker!=null){T=cK.get_viewer().get_user_by_id(fl);return this.role_picker.is_role_visible(T.role)}else{return true}},app_datastores_browse_get_id_info:function(T){switch(T){case"#apps_developed_container":return this.ds_info.apps_developed;case"#apps_used_container":return this.ds_info.apps_used;default:return cJ(false,"invalid ds group id")}},app_datastores_browse_get_id_header:function(T){switch(T){case"#apps_developed_container":return bE("<h2>Apps you develop</h2>");case"#apps_used_container":return bE("<h2>Apps you use</h2>");default:return cJ(false,"invalid ds group id")}},generate_access_token:function(fl){var fn,fm,T;T=this;fn=bE("#generate-token-button");fm=bE("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");fn.replaceWith(fm);return bE.ajax({url:"/developers/apps/generate_access_token",type:"POST",data:{app_id:fl},dataType:"json",success:function(fp){var fo;if(fp.status==="ok"){fo=bE("<div>").append(bE("<div>").attr("id","generated-token").addClass("text").css("padding-top",0).text(fp.token));fo.append(bE("<div>").addClass("detail-text").text(fp.warning))}else{if(fp.status==="error"){fo=bE("<div>").addClass("detail-text").addClass("error").text(fp.msg)}}return fm.replaceWith(fo)},error:function(){return ae.error("Unable to complete your request.")}})},confirm_disable:function(fn,fm,fl){var fo,T;fo=(fl?eA("Are you sure you want to disable '%(app_name)s'?"):eA("Are you sure you want to delete '%(app_name)s'?"));ds.fillVal(fo.format({app_name:fn.escapeHTML()}),"app-disable-text");fc.show((fl?eA("Confirm disable"):eA("Confirm delete")),$("app-disable-modal"));T="/developers/disable_app/"+fm;$("app-disable-modal").down("form").action=T;return $("disable-app-button").setValue((fl?eA("Disable"):eA("Delete")))},enable_app:function(fl){var T;T="/developers/enable_app/"+fl;return window.location.href=T},show_uninstall:function(fp,fo,fm,fl,fn,T){var fq;if(fp){Event.stop(fp)}fc.vars={app_id:fm,user_id:T};fq=bE("#delete-"+fl+"-app-confirm");if(fl==="sandbox"){if(!fn){bh.do_uninstall();return}bE(".app_folder",fq).text(fn)}bE(".app_name",fq).text(fo);fc.show(eA("Remove %(app_name)s?").format({app_name:bU.em_snippet(fo,22)}),fq[0],fc.vars);return null},do_uninstall:function(){var T;T=fc.vars.user_id;new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:fc.vars.app_id,keep_sandbox_files:$F("keep_sandbox_files")},onSuccess:function(fl){var fm;ae.success(fl.responseText);fm=bE(".apps-"+T);bE("#inst-app-"+fc.vars.app_id+"-row",fm).hide().removeClass("active_app");if(bE(".active_app",fm).length===0){fm.hide()}if(bE(".active_app").length===0){bE("#empty-explanation").text(eA("You have no apps linked to your Dropbox."));return bE("#applications-explanation",fm).remove()}},subject_user:T});return fc.hide()},enable_users_in_dev:function(T,fl){new Ajax.DBRequest("/developers/enable_users_in_dev/"+T,{onSuccess:function(fm){fc.show(eA("Limit raised to %d users").format(fl),$("increased-dev-user-limit-modal"));bE("#users-in-dev-none, #users-in-dev-some").hide();return bE("#users-in-dev-max").show()}});return false},unlink_all_users_in_dev:function(T){fc.show(eA("Unlink all users"),$("confirm-unlink-all-users"),{doit:function(){return new Ajax.DBRequest("/developers/unlink_all_users/"+T,{onSuccess:function(fl){bE("#current-app-users-1, #current-app-users-2").text("0");return fc.hide()}})}});return false},unlink_all_teams_in_dev:function(T){fc.show(eA("Unlink all teams"),$("confirm-unlink-all-teams"),{doit:function(){return bE.ajax({url:"/developers/unlink_all_teams/"+T,type:"POST",success:function(fl){bE("#current-app-teams").text("0");return fc.hide()}})}});return false},restore_sandbox:function(fl,fn,T){var fp,fm,fo;fp=bE("#restore-sandbox")[0];fc.show(eA("Restore app folder '%(filename)s'").format({filename:bU.em_snippet(ay.filename(fn),17)}),fp);fo=bE("#restore-sandbox-form")[0];fm={ns_id:T};fm[Constants.UID_PARAM_NAME]=fl.id;return bT.add_vars(fo,fm)},submit_restore_sandbox:function(fl){var T;T=$("restore-sandbox-form");bT.ajax_submit(T,false,(function(fm){fc.hide();ae.success(eA("Restored app folder"));if(fm.responseText.length){return cr.reload_fqpath(fm.responseText)}else{return cr.reload("","",true)}}),false,fl.target);return false},submit_app_info:function(T){var fl;fl=bE(T).find("input[name=name]").val();bT.clear_errors(T);return bT.ajax_submit(T,false,(function(){ae.success("App info updated.");if(fl){return bE("#app-info h1").text(fl)}}))},submit_folder_name:function(T){var fl;fl=bE(T).find("input[name=folder]").val();bT.clear_errors(T);return bT.ajax_submit(T,false,(function(){ae.success("App folder name updated.");bE("#folder-name .text").text(fl);return bh.hide_folder_input()}))},submit_new_webhook:function(fl){var fm,fw,fu,fp,fs,fr,fv,ft,fn,T,fq,fo;fw=bE(fl);fs=bE("#webhook-list");fp=bE("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");fu=fw.find("input[name=webhook_url]");fn=function(fy,fx){if(fx){fx.remove()}if(fs.find(".hoverable-url").length===0){fs.addClass("hide-status")}bE("#webhook-form-error").text(fy);return bE("#webhook-form").addClass("error")};fv=fu.val();if(fv===""){fn("Empty URI");return}ft=F.parse(fv);if((fq=ft.scheme)!=="http"&&fq!=="https"){fn("URI scheme must be http or https");return}if(!ft.authority){fn("Improperly formatted URI (typo maybe?)");return}if(((fo=ft.authority)==="localhost"||fo==="127.0.0.1")||ft.authority.indexOf("[::1]")===0){fn("Webhooks doesn't support localhost as Dropbox can't contact your local server. Please use an internet accessible URI.");return}if(fs.find("tbody").length>=Constants.MAX_WEBHOOKS_PER_APP){fn("You can register a maximum of %d webhook URIs per app.".format(Constants.MAX_WEBHOOKS_PER_APP));return}fm=bE(this._webhook_info_row_tmpl({url:fv,status:"Verifying"}).toHTML());fm.find(".status").append(fp);fm.find(".webhook-actions").removeClass("disabled").addClass("enabled");fs.append(fm);fs.removeClass("hide-status");bE("#webhook-form").removeClass("error");fr=bT.collect_form_vars(fl);fu.val("");T=new Date().getTime();return bE.ajax({url:"/developers/apps/update/add_webhook",type:"POST",dataType:"json",data:fr,success:function(fz){var fx,fy;if(fz.status==="invalid"){fn(fz.failure_text,fm);return fu.val(fv)}else{fy=new Date().getTime()-T;fx=Math.max(0,1000-fy);return setTimeout((function(){if(fz.status==="ok"){return fm.find(".status").text("Enabled")}else{if(fz.status==="error"){fm.find("textarea").text(fz.failure_text);fm.find(".status").text(fz.status_text).addClass("error");fm.find(".timestamp").text("Just now");return fm.find(".webhook-failure-info").css("display","")}}}),fx)}},error:function(){ae.error("Unable to complete your request.");fm.remove();return fu.val(fv)}})},remove_webhook:function(fm,fl){var fn,T;bE("#webhook-form").removeClass("error");T=bE(fm).find(".value").text();fn=bE("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");bE(fm).find(".status").text("Removing").removeClass("error").append(fn);return bE.ajax({url:"/developers/apps/update/remove_webhook",type:"POST",data:{app_id:fl,webhook_url:T},dataType:"json",success:function(fq){var fo,fp;fo=fm.parentNode;fp=fo.parentNode;fp.removeChild(fo);if(fp.getElementsByClassName("hoverable-url").length===0){bE(fp).addClass("hide-status")}if(!bE("#webhook_url").val()){return bE("#webhook_url").val(T)}},error:function(){return ae.error("Unable to complete your request.")}})},update_webhook_url:function(fp,fn,fm){var fq,T,fo,fr,fl;fl=bE(fp.parentNode.parentNode).find(".value").text();bE("#webhook-form").removeClass("error");fo=fp.parentNode.parentNode.parentNode;fq=bE("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");T=bE(fo).find(".status").text();fm=T==="Disabled";fr=fm?"Enabling":"Disabling";bE(fo).find(".status").text(fr).removeClass("error").append(fq);return bE.ajax({url:"/developers/apps/update/update_webhook_url",type:"POST",data:{app_id:fn,webhook_url:fl,enable:fm},dataType:"json",success:function(ft){var fs;T=bE(fo).find(".status").text();fs=T==="Disabling"?"Disabled":"Enabled";bE(fo).find(".status").text(fs).removeClass("error").removeClass("img");if(T==="Disabling"){return bE(fo).find(".webhook-actions").removeClass("enabled").addClass("disabled")}else{return bE(fo).find(".webhook-actions").removeClass("disabled").addClass("enabled")}},error:function(fs){return ae.error("Unable to complete your request.")}})},set_oauth2_allow_implicit_grant:function(fl,T){return bE.ajax({url:"/developers/apps/update/oauth2_allow_implicit_grant",type:"POST",data:{app_id:T,allow:bE(fl).val()},dataType:"json",success:function(fm){return ae.success("OAuth 2 allow implicit grant updated.")},error:function(){return ae.error("Error updating OAuth 2 allow implicit grant.")}})},submit_new_oauth_uri:function(fl){var T;T=bE(fl).find("input[name=oauth_uri]").val();bT.clear_errors(fl);return bT.ajax_submit(fl,false,(function(){ae.success("OAuth URI added.");bh.add_oauth_uri(T);return bE(fl).find("input[name=oauth_uri]").val("")}))},add_oauth_uri:function(fl){var T;T=bE("#oauth-uri-list");T.append(this._hoverable_tmpl({value:fl}).toHTML());return T.show()},remove_oauth_uri:function(fl,T){var fn,fm;fn=bE(fl).find(".value").text();fm=function(fp){var fo;ae.success("OAuth URI removed.");fo=fl.parentNode;fo.removeChild(fl);if(fo.getElementsByTagName("div").length===0){return fo.hide()}};return bE.ajax({url:"/developers/apps/update/remove_oauth_uri",type:"POST",data:{app_id:T,oauth_uri:fn},dataType:"json",success:fm,error:function(){return ae.error("Unable to complete your request.")}})},submit_new_domain:function(T){var fl;fl=bE(T).find("input[name=domain_name]").val();bT.clear_errors(T);return bT.ajax_submit(T,false,(function(){ae.success("Domain added.");bh.add_domain(fl);return bE(T).find("input[name=domain_name]").val("")}))},add_domain:function(fl){var T;T=bE("#domain-list");T.append(this._hoverable_tmpl({value:fl}).toHTML());return T.show()},remove_domain:function(fl,T){var fn,fm;fn=bE(fl).find(".value").text();fm=function(fp){var fo;ae.success("Domain removed.");fo=fl.parentNode;fo.removeChild(fl);if(fo.getElementsByTagName("div").length===0){return fo.hide()}};return bE.ajax({url:"/developers/apps/update/remove_domain",type:"POST",data:{app_id:T,domain_name:fn},dataType:"json",success:fm,error:function(){return ae.error("Unable to complete your request.")}})},show_need_users_modal:function(T){fc.show(eA("Please test this app",{comment:"Error message"}),$("app-need-users-modal"));return false},show_need_teams_modal:function(T){return fc.show(eA("Please test this app",{comment:"Error message"}),$("app-need-teams-modal"))},show_name_branding_modal:function(T){fc.show(eA("Please rename this app",{comment:"Error message"}),$("app-name-branding-modal"));return false},show_need_icon_modal:function(T){fc.show(eA("Please add an icon for this app",{comment:"Error message"}),$("app-need-icon-modal"));return false},hide_folder_input:function(){bE("#folder-name").show();return bE("#folder-input").hide()},show_folder_input:function(){bE("#folder-name").hide();bE("#folder-input").show();return bE("#folder-input input[name=folder]").focus()}};var cD,dF;dF=INLINE_JS.twitter_auth_complete=function(T){cJ(T!=null,"user_id must be provided");if(cD.onLoginSuccessCallback){cD.onLoginSuccessCallback(T)}else{window.location.reload()}return false};cD=D.Twitter={is_authed:function(T){T=parseInt(T);if(cD._authed_users==null){cD._authed_users={}}return cD._authed_users[T]},set_is_authed:function(T,fl){T=parseInt(T);if(cD._authed_users==null){cD._authed_users={}}return cD._authed_users[T]=fl},get_progress_container:function(){var T;cJ(cD.progress_container,"Twitter is missing progress_container");T=$(cD.progress_container);cJ(T,"Missing progress_container elm");return T},follow_dropbox:function(fl,T){var fm;cJ(T!=null,"user_id must be provided");if(fl.showWorking){fl.showWorking()}fm=function(){if(fl.onFailure){return fl.onFailure()}else{return window.location.reload()}};return new Ajax.DBRequest("/twitter/follow_us",{onSuccess:function(fn){if(!fn.responseText.startsWith("ok")){return fm()}else{if(fl.onSuccess){return fl.onSuccess()}}},onFailure:function(){return fm()},subject_user:T})},do_auth:function(fn,T){var fm,fl;cJ(T!=null,"user_id must be provided");fl=F({path:"/twitter/request_token"}).updateQuery(Constants.UID_PARAM_NAME,T).toString();window.open(fl,"twitter_auth","width=800,height=400");fm=function(fo){cD.set_is_authed(fo,true);return typeof fn==="function"?fn(fo):void 0};return cD.onLoginSuccessCallback=fm},show_auth:function(T){if(T){cD.onLoginSuccessCallback=T}return ds.updateFromElm(cD.get_progress_container(),"inline-twitter-auth")},show_posting:function(){if(cD.should_hide_modal()){fc.hide()}return cD.get_progress_container().update(ds.fromElm("sharing-progress"))},show_complete:function(fl){var T;T=cD.get_progress_container();T.update(ds.fromElm("sharing-posted"));return cD.show_complete_into(fl,T)},show_complete_into:function(fq,T){var fn,fo,fm,fp,fl;fn="twitter";fp=eA("View tweet");fl=void 0;if(fq.startsWith("ok")){fl="http://www.twitter.com/"}else{fl=fq}fo=T.down("#view-post");fo.href=fl;fo.update(fp);fm=cv.make("web",fn);return fo.__sert({top:fm})},post:function(fn,fp,fm,T){var fo,fl;cJ(T!=null,"user_id must be provided");cJ(fn,"Twitter message is empty");fo={message:fn,from_referrals:cD.from_referrals,from_getspace:cD.from_getspace};new Ajax.DBRequest("/twitter_post",{parameters:fo,onSuccess:function(fq){var fr,fs;if(fq.responseText==="login"){cD.onLoginSuccessCallback=function(){return cD.post(fn,null,null,T)};fr=cD.custom_show_auth||cD.show_auth;return fr()}else{if(cD.should_hide_modal()){fc.hide()}fs=cD.onPostSuccessCallback||cD.show_complete;return fs(fq.responseText)}},subject_user:T});fl=cD.custom_show_posting||cD.show_posting;return fl()},custom_post:function(fl,fm,T){cJ(T!=null,"user_id must be provided");if(fm){cD.onPostSuccessCallback=fm}if(!fl){return}cJ(fl,"Twitter message doesn't exist");if(!cK.get_viewer().is_signed_in){return window.open("http://www.twitter.com/home?status="+encodeURI(fl))}else{return cD.post(fl,null,null,T)}},get_user_info:function(fl,T){cJ(T!=null,"user_id must be provided");return new Ajax.DBRequest("/twitter/user_info",{noAutonotify:1,parameters:{},onSuccess:function(fm){return fl(JSON.parse(fm.responseText))},subject_user:T})},should_hide_modal:function(){if(typeof cD.hide_modal==="undefined"){return true}else{return cD.hide_modal}}};var dq,e2,dD,X,eT,aq,bG,al,x,em,au={}.hasOwnProperty,cN=function(fn,fl){for(var T in fl){if(au.call(fl,T)){fn[T]=fl[T]}}function fm(){this.constructor=fn}fm.prototype=fl.prototype;fn.prototype=new fm();fn.__super__=fl.prototype;return fn},du=function(T,fl){return function(){return T.apply(fl,arguments)}};dD=D.LightboxPreviewBase=(function(){function T(fl){this.link_hash=fl.link_hash;this.filename=fl.filename;this.fq_path=fl.fq_path;this.thumbnail_url_tmpl=fl.thumbnail_url_tmpl;this.dl_url=fl.dl_url;this.ns_id=fl.ns_id;this.ns_path=fl.ns_path;this.display_time=fl.display_time||null;this.more_actions_item_tmpl=fg.tmpl("lightbox_more_actions_item_tmpl")}T.prototype.shutdown=function(){};T.prototype.preload=function(){};T.prototype.render=function(){};T.prototype.image_size=function(){var fl;fl=document.viewport.getDimensions();return aE(fl.width,fl.height)};T.prototype.get_more_actions_above_divider=function(fm){var fn,fl;fl=[];fn=this.more_actions_item_tmpl({_id:"lightbox_download_link",_href:this.dl_url,_ns_id:this.ns_id,_ns_path:this.ns_path,sprite_name:"lightbox_download",item_text:eA("Download"),more_classes:"more-actions-item",Sprite:cv});fl.push(fn);return fl};T.prototype.get_more_actions_below_divider=function(fl){return[]};T.prototype.is_a_timeline_preview=function(){return this instanceof eT||this instanceof dq||this instanceof aq||this instanceof e2};T.prototype.is_an_album_preview=function(){return this instanceof eT||this instanceof aq};T.prototype.is_a_photo_preview=function(){return this instanceof X};T.prototype.is_a_video_preview=function(){return this instanceof bG};T.prototype.get_actions=function(fn){var fp,fr,fs,fm,fq,fl,fo;fm=[];if(!this.is_a_timeline_preview()&&fn.enable_sublinks){if(fn.share_button_experiment_variant==="WHITE_BUTTON"){fs=bE("#lightbox-share-action-base").clone().attr("id","lightbox-share-button");if(this.shmodel_link){fo=(function(ft){return function(fu){ba.ShmodelUILogger.log("via-shmodel-lightbox");return window.open(F.parse(ft.shmodel_link).updateQuery("m","1"))}})(this)}else{fo=(function(ft){return function(fu){fu.preventDefault();ba.ShmodelUILogger.log("via-browse-lightbox");return dv.shmodel(ft.fq_path,"browse_lightbox")}})(this)}}else{fs=bE("<a />",{id:"lightbox_share_link","class":"title_bubble black"});fs.html(cv.make("web","link_white"));if(this.is_a_photo_preview()){fs.attr("title",eA("Share link to photo"))}else{if(this.is_a_video_preview()){fs.attr("title",eA("Share link to video"))}else{cJ(false,"preview needs to be a photo or video")}}if(this.shmodel_link){fs.attr("href",F.parse(this.shmodel_link).updateQuery("m","1"));fs.attr("target","_blank");fo=(function(ft){return function(fu){return ba.ShmodelUILogger.log("via-shmodel-lightbox")}})(this)}else{fs.attr("href","#");fo=(function(ft){return function(fu){fu.preventDefault();ba.ShmodelUILogger.log("via-browse-lightbox");return dv.shmodel(ft.fq_path,"browse_lightbox")}})(this)}}fs.on("click",fo);fm.push(fs[0])}if(fn.include_delete){fq=bQ.in_single_collection_view()?eA("Remove"):eA("Delete");if(fn.share_button_experiment_variant==="WHITE_BUTTON"){fp=bE("#lightbox-delete-action-base").clone().attr("id","lightbox-delete-link");fp.find(".sprite-text-inner").text(fq);fp.on("click",(function(ft){ft.preventDefault();return aJ.delete_current()}))}else{fp=bE("<a />",{id:"lightbox-delete-button",href:"#","class":"title_bubble black",title:fq});fp.html(cv.make("web","lightbox_delete_16"));fp.on("click",(function(ft){ft.preventDefault();return aJ.toggle_delete()}))}fm.push(fp[0])}if(fn.share_button_experiment_variant==="WHITE_BUTTON"){fl=(function(ft){return function(fu){fu.preventDefault();return aJ.toggle_more_actions_menu()}})(this);fr=bE("#lightbox-more-actions-base").clone().attr("id","lightbox-more-actions-button").on("click",fl);fm.push(fr[0])}else{cJ(aJ.more_actions_button!=null,"Lightbox should have a more_actions_button added on init");fm.push(aJ.more_actions_button)}return fm};T.prototype.delete_pressed=function(){var fl;fl=eA("Deleting...");if(this.is_a_timeline_preview()){if(bQ.in_single_collection_view()){fl=eA("Removing...");bQ.get_current_collection().remove_photos([this.photo])}else{bQ._delete_photos([this.photo])}}else{document.fire(aJ.PHOTO_DELETE_EVT,this)}return ae.success(fl)};T.prototype.set_more_actions_event_handlers=function(fl){};T.prototype.replace_dl_action_with_open_action_if_file_available=function(){var fm,fn,fl,fo;if(__CONDITIONAL_JS__.UnityFeatures==null){return}fl=cr.active_user.id;fn=(function(fp){return function(fq,ft,fr){var fu,fs;fu=bE("#lightbox_download_link");if(!(fu.data("ns-id")===fq&&fu.data("ns-path")===ft)){return}fs=bE(fp.more_actions_item_tmpl({_id:"unity_open_action",_href:"#",_ns_id:fq,_ns_path:ft,sprite_name:"lightbox_open",item_text:eA("Open"),more_classes:"more-actions-item",Sprite:cv}).toHTML());fu.replaceWith(fs);return fs.on("click",function(fv){return __CONDITIONAL_JS__.UnityFeatures.open_file(fq,ft,fr,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(fw){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})})}})(this);if((fo=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fo.is_cached_and_locally_available(this.ns_id,this.ns_path):void 0){return fn(this.ns_id,this.ns_path,fl)}else{fm=(function(fp){return function(fq){if(fq.is_locally_available){return fn(fp.ns_id,fp.ns_path,fl)}}})(this);return __CONDITIONAL_JS__.UnityFeatures.check_file(this.ns_id,this.ns_path,fl,fm)}};return T})();X=INLINE_JS.PhotoPreview=D.PhotoPreview=(function(fl){cN(T,fl);function T(fm){T.__super__.constructor.call(this,fm);this.original_url=String(F.parse(fm.original_url).updateQuery(Constants.UID_PARAM_NAME,cr.active_user));this.shmodel_link=fm.shmodel_link;this.fail_image_src="/static/images/preview_fail-vflc3IDxf.png";if(this.is_gif()){this.thumbnail_url_tmpl=this.original_url}this.loaded=false;this.enable_download=fm.enable_download}T.prototype.show_fail=function(fn){var fm;return fm=bE(fn).find(".lightbox_fail_text").text(eA("Unable to preview this item."))};T.prototype.fallback=function(fn){var fm,fo;fm=$(fn.target);fm.writeAttribute({src:this.fail_image_src,width:128,height:128});fo=fm.up("div.content-item");if(fo){return this.show_fail(fo)}};T.prototype.is_gif=function(){return"gif"===ay.file_extension(this.filename).toLowerCase()};T.prototype.preload=function(fo){var fn,fp,fm;fm=F.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();if(this.is_gif()){fm=this.thumbnail_url_tmpl}fp=(function(fq){return function(){if(typeof fo==="function"){fo()}return fq.loaded=true}})(this);d5.preload_image(fm,this.fallback.bind(this),fp);fn=$(d5.preloaded_images[fm]);fn.writeAttribute("data-original-href",this.original_url);fn.setAttribute("enable-download",this.enable_download);fn.writeAttribute("class","thumbnail");return fn};T.prototype.render=function(fr,fo){var fp,fn,fq,fm,fs;if(this.loaded){fo()}fn=this.preload(fo);fs=bE("<div />",{"class":"content-item"}).append(fn);fp=bE("<div />",{"class":"lightbox_fail_text"});fs.append(fp);fq=fn.getAttribute("src").length;fm=fn.getAttribute("src").substring(fq-this.fail_image_src.length,fq);if(fm===this.fail_image_src){this.show_fail(fs)}fr.appendChild(fs[0]);return fs[0]};T.prototype.advance_on_click=true;T.prototype.get_more_actions_above_divider=function(fo){var fn,fm;fm=T.__super__.get_more_actions_above_divider.call(this,fo);fn=this.more_actions_item_tmpl({_id:"view_original",_href:this.original_url,_target:"_blank",sprite_name:"lightbox_view_original",item_text:eA("View original"),more_classes:"more-actions-item",Sprite:cv});fm.push(fn);return fm};return T})(dD);bG=D.VideoPreview=(function(T){cN(fl,T);function fl(fm){this._player_error=du(this._player_error,this);this._player_ready=du(this._player_ready,this);fl.__super__.constructor.call(this,fm);this.preview_url=fm.preview_url;this.shmodel_link=fm.shmodel_link;this.thumbnail_div=null;this.metadata_link=fm.metadata_link!=null?fm.metadata_link:void 0;this.metadata=null;this.player=null}fl.prototype.render_error=function(fp){var fr,fn,fm,fo,fq;fn=bE("<div/>");fm=bE("<img/>",{src:"/static/images/preview_fail-vflc3IDxf.png","class":"video-preview-fail"});fo=bE("<div/>",{"class":"video-preview-fail"});if(fp==="needflash"){fo.html(eA('Install <a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a> to view this video.'))}else{fo.text(eA("Unable to preview this item.",fq="web",fr="preview means showing the item in the same browser window without downloading a copy."))}fn.append(fm,fo);return fn[0]};fl.prototype._player_ready=function(){var fm;fm=function(){bE(".vjs-poster").show();bE(".vjs-big-play-button").show();return bE(".vjs-big-play-button").focus()};return fm.defer()};fl.prototype._onPlay=function(){bE(".vjs-poster").hide();return bE(".vjs-big-play-button").hide()};fl.prototype._onEnded=function(){bE(".vjs-poster").show();bE(".vjs-big-play-button").show();return bE(".vjs-loading-spinner").hide()};fl.prototype._player_error=function(fm){this.shutdown();this.div=this.render_error(fm);return bE("#file-preview-modal .content-item").html(this.div)};fl.prototype.preload=function(){};fl.prototype.render=function(fn,fm){this.div=this.render_video(fn);return this.div};fl.prototype.render_video=function(fs){var fm,fq,fo,fn,fr,fp;fp=new Element("div",{"class":"video-player content-item"});fr=this.image_size().split("x")[0]*0.8;fn=parseInt(fr*0.55,10);fq=false;fo=F.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();fm=(function(ft){return function(fu){return ft.metadata=fu}})(this);this.player=bt.embed(fp,{src:this.preview_url,type:Constants.transcoder_hls4web?"application/vnd.apple.mpegurl":"video/flv",width:fr,height:fn,controls:true,preload:"auto",poster:fo,onError:this._player_error,onReady:this._player_ready,metadata:this.metadata,metadata_link:this.metadata_link,metadata_cb:fm});fs.appendChild(fp);bE(".vjs-poster").hide();bE(".vjs-big-play-button").hide();this.player.on("play",this._onPlay);this.player.on("ended",this._onEnded);return fp};fl.prototype.shutdown=function(){var fn,fm;bE(".vjs-big-play-button").blur();if(this.player){try{this.player.trigger("shutdown");if(this.player.techName==="Hls"){if((fm=this.player.tech.sourceBuffer)!=null){fm.abort()}}this.player.dispose()}catch(fo){fn=fo}return this.player=null}};return fl})(dD);al=function(fm){var T,fl;T=(function(fo){cN(fn,fo);function fn(fp){fp.ns_id=fp.photo.ns_id;fp.ns_path=fp.photo.ns_path;fn.__super__.constructor.call(this,fp);this.photo=fp.photo;bo.set_vertical_space(3);if(bQ.in_single_collection_view()){bE("#lightbox-delete-photo").val(eA("Remove"))}else{bE("#lightbox-delete-photo").val(eA("Delete"))}}fn.prototype.get_more_actions_above_divider=function(fr){var fq,fp;fp=fn.__super__.get_more_actions_above_divider.call(this,fr);fq=this.more_actions_item_tmpl({_id:"lightbox_add_to_album",sprite_name:"lightbox_add_to_album",item_text:eA("Add to album"),more_classes:"more-actions-item",Sprite:cv});fp.push(fq);return fp};fn.prototype.toggle_select_button_off=function(fp){if(this.is_a_photo_preview()){fp.attr("title",eA("Select photo"))}else{if(this.is_a_video_preview()){fp.attr("title",eA("Select video"))}}fp.html(cv.make("web","lightbox_unselected"));fp.removeClass("selected");fp.addClass("elbboggiw");return setTimeout((function(){return fp.removeClass("elbboggiw")}),540)};fn.prototype.toggle_select_button_on=function(fp){if(this.is_a_photo_preview()){fp.attr("title",eA("Un-select photo"))}else{if(this.is_a_video_preview()){fp.attr("title",eA("Un-select video"))}}fp.html(cv.make("web","lightbox_selected"));fp.addClass("selected");fp.addClass("wiggobble");return setTimeout((function(){return fp.removeClass("wiggobble")}),540)};fn.prototype.toggle_select=function(fq){var fp;fq.preventDefault();fp=bE("#lightbox-select-button");bo.hide_all();if(eW.contains(this.photo)){eW._remove(this.photo);return this.toggle_select_button_off(fp)}else{eW._add(this.photo);return this.toggle_select_button_on(fp)}};fn.prototype.get_actions=function(fr){var fq,fp,fs;fq=[];fs=bE("<a />",{id:"lightbox_share",href:"#","class":"lightbox-button lightbox-not-important"});aJ.update_share_button_text(null,bE(fs));fs.on("click",((function(ft){return function(fv){var fu;fv.preventDefault();fu=eW.get();if(fu.length===0){return ez.show([ft.photo],false)}else{return ez.show(eW.get(),false)}}})(this)));fp=bE("<a />",{id:"lightbox-select-button",href:"#","class":"title_bubble black",title:eA("Select this photo")});if(eW.contains(this.photo)){fp.html(cv.make("web","lightbox_selected"))}else{fp.html(cv.make("web","lightbox_unselected"))}fp.on("click",this.toggle_select.bind(this));fq.push(fs[0]);fq.push(fp[0]);return fq.concat(fn.__super__.get_actions.call(this,fr))};fn.prototype.set_more_actions_event_handlers=function(fp){$("lightbox_add_to_album").observe("click",((function(fq){return function(fr){fr.preventDefault();return cG.show_add_to_album_modal(fr,[fq.photo])}})(this)));$("lightbox_show_in_folder").observe("click",((function(fq){return function(fr){fr.preventDefault();return bQ.show_in_folder(fq.photo)}})(this)));return fn.__super__.set_more_actions_event_handlers.call(this,fp)};fn.prototype.get_more_actions_below_divider=function(fr){var fq,fp;fq=[];fp=this.more_actions_item_tmpl({_id:"lightbox_show_in_folder",sprite_name:"lightbox_show_in_folder",item_text:eA("Show in folder"),more_classes:"more-actions-item",Sprite:cv});fq.push(fp);fq=fq.concat(fn.__super__.get_more_actions_below_divider.call(this,fr));return fq};return fn})(fm);fl=(function(fo){cN(fn,fo);function fn(){return fn.__super__.constructor.apply(this,arguments)}fn.prototype.get_more_actions_below_divider=function(fr){var fp,fq;fq=[];fp=this.more_actions_item_tmpl({_id:"lightbox_remove_from_album",sprite_name:"lightbox_remove_from_album",item_text:eA("Remove from album"),more_classes:"more-actions-item",Sprite:cv});fq.push(fp);fq=fq.concat(fn.__super__.get_more_actions_below_divider.call(this,fr));return fq};fn.prototype.set_more_actions_event_handlers=function(fp){$("lightbox_remove_from_album").observe("click",((function(fq){return function(fr){fr.preventDefault();return cG.show_remove_photos_modal(bQ.get_current_collection(),[fq.photo])}})(this)));return fn.__super__.set_more_actions_event_handlers.call(this,fp)};return fn})(T);return[T,fl]};x=al(X),dq=x[0],eT=x[1];em=al(bG),e2=em[0],aq=em[1];var aJ;aJ=INLINE_JS.Lightbox=D.Lightbox=(function(){var fF,fD,gb,ga,fX,ft,fl,fK,fT,gf,fn,f9,fs,fS,f4,fA,f3,fP,fY,ge,fz,fQ,fx,f2,f6,fr,f5,fq,fI,f8,fC,fR,fu,fL,fZ,fM,fV,fo,fE,T,fU,f7,gd,f1,fB,fH,fp,fG,fW,fm,fv,f0,fN,fO,fy,fJ,fw,gc;ga=[];fF=0;fX=false;gb=true;fN=void 0;fl=/^\d+\-\d+\-\d+\s+\d+\.\d+\.\d+/;ft=false;f8=void 0;f4=void 0;fW=-1;fm=null;fY=null;fQ=false;T=false;fr=false;fx=null;fz=function(gg){return gg.complete!==false};fp=function(){var gg;if($$("#file-preview-modal .loading-image").length){return}gg=new Element("img",{"class":"loading-image",src:"/static/images/icons/ajax-loader-black-vflweQQeE.gif"});return $$("#file-preview-modal .preview-content").first().__sert(gg)};fP=function(){return $$("#file-preview-modal .loading-image").invoke("remove")};fM=function(){var gm,gl,gi,gg,gk,gj,gh;gl=$$("#file-preview-modal .content-item").first().down("img.thumbnail");if(!gl||!fz(gl)){return}gg=$$("#file-preview-modal .preview").first().getDimensions();gm=void 0;if(!gl.naturalHeight){gm=gl.getDimensions();gl.naturalHeight=gm.height;gl.naturalWidth=gm.width}else{gm={width:gl.naturalWidth,height:gl.naturalHeight}}gi=gm.width/gg.width;gh=gm.height/gg.height;gj=Math.max(gi,gh);gl.style.visibility="";if(gj<1){gl.style.width="";gl.style.height=""}else{gl.style.width=Math.floor(gm.width/gj)+"px";gl.style.height=Math.floor(gm.height/gj)+"px"}gk=bE("#file-preview-modal .paging-block").position().left-16;return bE("#file-preview-modal .filename").css("max-width",gk)};fS=void 0;f5=function(){var gn,gi,gm,gl,gk,gh,gj,gg;gi=$("file-preview-modal");gl=gi.down(".menu");gm=gi.down(".header");gj=$$(".lightbox-not-important");gg=[];for(gk=0,gh=gj.length;gk<gh;gk++){gn=gj[gk];gg.push(gn.addClassName("opacity-zero"))}return gg};fG=function(){var gk,gj,gh,gi,gg;if(fS){clearTimeout(fS)}gi=$$(".lightbox-not-important");gg=[];for(gj=0,gh=gi.length;gj<gh;gj++){gk=gi[gj];gg.push(gk.removeClassName("opacity-zero"))}return gg};fV=function(gh){var gg;fG();gg=gh&&$(gh.target).descendantOf("file-preview-menu");if(fS!=null){clearTimeout(fS)}if(gb){if(!ft&&!gg){return fS=setTimeout(f5,3112)}}};f0=function(){if(fS!=null){clearTimeout(fS)}return gb=false};fv=function(){gb=true;return fV()};ge=function(gh){var gg;gg=ga.length;return(gg+(fF+gh)%gg)%gg};fR=function(gh){var gg,gi;if(f8.no_preload){return}gg=fB.bind(null,gh);return typeof(gi=ga[gh]).preload==="function"?gi.preload(gg):void 0};fu=function(){var gi,gk,gh,gj,gg;gj=[1,2,3,4,5,6,-1,-2];gg=[];for(gk=0,gh=gj.length;gk<gh;gk++){gi=gj[gk];if(Math.abs(gi)<ga.length){gg.push(fR(ge(gi)))}else{gg.push(void 0)}}return gg};fE=function(gg){if(!f8.filename_in_url){return}if(gg!=null){a2.replace_hash("lh",gg)}else{a2.replace_hash("")}return fx=gg};fZ=function(){var gg,gh;gg=bE("#file-preview-modal");gh=(f8!=null?f8.num_previews:void 0)||ga.length;if(fQ&&T&&fr){gg.find(".lightbox-index-text-container").text(eA("Could not load folder",{comment:"Error shown when a folder fails to load"}))}else{if(fQ){if(T){gg.find(".lightbox-index-text-container").text(eA("Loading...",{comment:"Shown while waiting for photos/videos to load"}))}else{gg.find(".lightbox-index-text-container").text("")}}else{gg.find(".lightbox-index-text-container").text(eA("%(cur_file_num)s of %(num_total_files)s",{comment:"Indicating which we're viewing, like '3 of 10'"}).format({cur_file_num:fF+1,num_total_files:gh}))}}if(ga.length===1){gg.find(".prev").addClass("opacity-zero");return gg.find(".next").addClass("opacity-zero")}else{if(fF===0&&f8.no_wrap){gg.find(".prev").addClass("opacity-zero");return gg.find(".next").removeClass("opacity-zero")}else{if(fF===ga.length-1&&f8.no_wrap){gg.find(".prev").removeClass("opacity-zero");return gg.find(".next").addClass("opacity-zero")}else{gg.find(".prev").removeClass("opacity-zero");return gg.find(".next").removeClass("opacity-zero")}}}};fn=function(gk,gh,gj,gg,gi){var gl;gl={user_id:null,context:gh,platform:aV.FileViewPlatformType.WEB,ns_id:gk.ns_id,sjid:null,ns_path:gk.ns_path,shared_link_url:gj,extra:{mode:gg,file_ext:gi}};return gl};fU=function(gi,gE){var gt,gu,gv,gA,gp,gj,gr,gk,gm,gw,gg,gn,gD,gC,gz,gq,gy,go,gx,gB,gh,gF,gs,gl;fW=b4.time();cJ(fF<ga.length,"Invalid index "+fF);gx=ga[fF];if(typeof gx!=="object"){if(fm){clearTimeout(fm)}fm=setTimeout((function(){if((aJ.shown!=null)&&aJ.shown){return fU(gi,gE)}}),100);return}bE("#file-preview-modal").trigger(aJ.LIGHTBOX_SHOW_EVT,{preview:gx});gj=ay.file_extension_for_logging(gx.filename);gk=aV.FileViewModeType.PHOTOS_LIGHTBOX;gr=aV.FileViewContextType.PRIVATE;gm=null;gn="lightbox";if(gx.fq_path!=null){gk=aV.FileViewModeType.BROWSE_LIGHTBOX;gr=aV.FileViewContextType.PRIVATE;gn="browse_lightbox"}else{if(gx.shmodel_link!=null){gk=aV.FileViewModeType.SHARED_LINK_LIGHTBOX;gr=aV.FileViewContextType.SHARED_LINK;gm=gx.shmodel_link;gn="shmodel_lightbox"}}gw=fn(gx,gr,gm,gk,gj);ba.FileViewLogger.log(gw);ba.WebLightboxLogger.log(ba.WebLightboxLogger.VIEW,{context:gn,file_ext:gj});gC=bE("#file-preview-modal");gB=gC.find(".preview-content");go=gi?f1:fB;gB.empty();gp=gx.render(gB[0],go);gC=gC[0];if(!fY){fY=gC.on("contextmenu","img.thumbnail",bn.show_for_lightbox.bind(bn))}fE(gx.link_hash);fZ();if(gx.display_time){if(gx.filename.match(fl)){gC.down(".filename").__date(gx.display_time)}else{gC.down(".filename").__date(gx.display_time+" - "+gx.filename)}}else{gC.down(".filename").__date(gx.filename)}gC.down(".filename").writeAttribute("title",gx.filename);if(bQ.in_single_collection_view()&&((gs=bQ.get_current_collection().member_fnames)!=null?gs.length:void 0)>1&&(((gl=gx.photo)!=null?gl.item_owner_fname:void 0)!=null)){gA="&nbsp;&nbsp;&middot;&nbsp;&nbsp;";gA+=eA("Added by %(fname)s").format({fname:bU.em_snippet(gx.photo.item_owner_fname,7)});gC.down(".added-by").__date(new fg(gA));gC.down(".added-by").show()}else{gC.down(".added-by").hide()}gq=fg.tmpl("lightbox_more_actions_item_tmpl");gz=gx.get_more_actions_above_divider(f8);gv=gx.get_more_actions_below_divider(f8);if(gv.length){gz.push(gq({divider:true,Sprite:cv}));gz=gz.concat(gv)}$("lightbox-more-actions-list").__date(gz);gx.set_more_actions_event_handlers(f8);if(bE(gC).data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)){gx.replace_dl_action_with_open_action_if_file_available()}gu=gx.get_actions(f8);gg=document.createDocumentFragment();for(gh=0,gF=gu.length;gh<gF;gh++){gt=gu[gh];gg.appendChild(gt)}gC.down(".actions").__date();gC.down(".actions").appendChild(gg);if(f8.share_button_experiment_variant==="WHITE_BUTTON"){gy=bE("#lightbox-more-actions-button .sprite-div").width();bE("#lightbox-more-actions-menu").css("right",gy/2)}document.fire(aJ.ACTIONS_ADDED);if(bQ.in_single_collection_view()){gC.down(".album-name").show().__date(bU.em_snippet(bQ.get_current_collection().name,15,1));gC.down(".filename").addClassName("faded")}else{gC.down(".album-name").hide();gC.down(".filename").removeClassName("faded")}gp=gp.down("img.thumbnail");if(gp){if(!fz(gp)){gp.hide();fp();gp.observe("load",function(){fP();gp.style.visibility="hidden";gp.show();return fM()})}else{gp.show();fM()}}gD={preview_obj:gx,index:fF,direction:gE};return document.fire(aJ.PHOTO_CHANGE_EVT,gD)};gd=function(gl){var gh,gi,gg,gj,gk;if(fW===-1){return}gk=b4.time()-fW;if(typeof i!=="undefined"&&i!==null){gh=i.get_current_view()}else{if(typeof aj!=="undefined"&&aj!==null?aj.is_album:void 0){gh="album_shmodel"}else{gh="not_photos"}}gi={current_view:gh};gg=bE("#file-preview-modal .content-item img.thumbnail")[0];if((gg!=null)&&(gg.src!=null)){gj=F.parse(gg.src).getQuery();if("size" in gj){gi.size=gj.size}}eh.log_ajax_transition(gk,gl,gi);fW=-1;return fu()};f1=function(){return gd("file-preview-lightbox-load-initial")};fB=function(gg){var gh;if(typeof gg==="number"){if((gh=ga[gg])!=null){gh.loaded=true}if(gg===fF){return gd("file-preview-lightbox-load")}}else{return gd("file-preview-lightbox-load")}};f7=function(gg){var gh;gh=bE("#lightbox-click-catcher");if(!gh.length){gh=bE("<div />",{id:"lightbox-click-catcher",style:"position: absolute; width: 100%; height: 100%; top: 0px; left: 0px; z-index: 2;"});gh.appendTo("#file-preview-modal .modal-preview-content");if(b1.msie_version_at_most(10)){gh.css("background","black");gh.fadeTo(0,0)}}gh.off("click");gh.on("click",(function(gi){gi.preventDefault();return gg()}));return gh.show()};fA=function(){return bE("#lightbox-click-catcher").hide()};gf=function(){var gg;gg=bE("#lightbox-more-actions-button");if(gg.hasClass("toggled")){fA();gg.removeClass("toggled");$("lightbox-more-actions-menu").hide();bE(document).trigger("dropdownClosed",[1]);fv();return true}return false};fI=function(){var gg;gg=bE("#lightbox-more-actions-button");if(!gg.hasClass("toggled")){f3();gg.addClass("toggled");bo.hide_all();bE("#lightbox-more-actions-menu").show();bE(document).trigger("dropdownOpened",[1]);f0();return f7(aJ.close_more_actions_menu)}};fy=function(){if(bE("#lightbox-more-actions-button").hasClass("toggled")){return gf()}else{return fI()}};fq=function(gh){var gg;if(fQ){T=true;fZ()}gf();if(gh){gh.preventDefault()}if(fF===ga.length-1&&f8.no_wrap){return}if((gg=ga[fF])!=null){gg.shutdown()}fF=ge(1);if(fF===0){fV()}return fU(null,aJ.NEXT)};fL=function(gh){var gg;if(fQ){T=true;fZ()}gf();if(gh){gh.preventDefault()}if(fF===0&&f8.no_wrap){return}if((gg=ga[fF])!=null){gg.shutdown()}fF=ge(-1);return fU(null,aJ.PREV)};fT=function(gg){if(gg){gg.preventDefault()}if(ga[fF].advance_on_click){if(gg.clientX<bE(window).width()/10){return fL()}else{return fq()}}};f9=function(gm){var gj,gi,gl,gn,gk,gh,gg;gj=ga.dict_by("fq_path");gn=void 0;if(gm.memo.files){gn=gm.memo.files.collect(function(go){return go.fq_path})}else{gn=gm.memo.fq_paths}gg=[];for(gk=0,gh=gn.length;gk<gh;gk++){gl=gn[gk];if(gj[gl]){gi=ga.indexOf(gj[gl]);ga.splice(gi,1);if(f8.num_previews){f8.num_previews--}if(!f8.num_previews&&!ga.length){gg.push(f4())}else{if(gi===ga.length){gg.push(fL())}else{gg.push(fU())}}}else{gg.push(void 0)}}return gg};fo=function(gg){if(ga[fF].is_a_timeline_preview()){return ga[fF].toggle_select(gg)}};fJ=function(){Event.stopObserving(document,"mousemove",fV);Event.stopObserving(document,"click",fV);document.stopObserving(aJ.PHOTO_DELETE_EVT,fC);document.stopObserving(aF.DELETE,f9);document.stopObserving(eW.CHANGE_EVT,fw);return clearInterval(fN)};f4=function(gj){var gh,gi,gg,gk;if(gj){gj.preventDefault()}if(!aJ.shown){return}if((gi=ga[fF])!=null){gi.shutdown()}gh=$("file-preview-modal");gh.hide();gh.down(".preview-content").__date();B.scroll_unlock_document();fJ();fE();aJ.shown=0;gh.stopObserving("click",aJ.back);if((gg=$$(".preview-content"))!=null){if((gk=gg.first())!=null){gk.stopObserving("click")}}return bE("#file-preview-modal").trigger(aJ.LIGHTBOX_HIDE_EVT)};fD="db:filepreview:exitselect";fK=function(gh){var gg;if(f8.keep_url){f4()}else{if((gg=ga[fF])!=null){gg.shutdown()}window.history.go(-1)}if(gh!=null){if(gh.originalEvent){gh=gh.originalEvent}Event.extend(gh).stop()}return document.fire(fD,ga[fF])};fC=function(gg){return dC.do_delete(cr.active_user,gg.memo.fq_path)};f6=function(){var gg;if(!fX){gg=bE("#file-preview-modal");gg.on("click",".close",fK);key("esc",aJ.KEY_SCOPE,(function(gh){if(bE("#lightbox-more-actions-button").hasClass("toggled")){return gf()}else{if(ft){return f3()}else{return fK(gh)}}}));gg.on("click",".next",fq);gg.on("click",".prev",fL);gg.on("click",".preview-container",fT);key("left, k",aJ.KEY_SCOPE,function(gh){return fL()});key("right, j",aJ.KEY_SCOPE,function(gh){fq();return false});key("up, down",aJ.KEY_SCOPE,function(gh){return false});key("x, s, space",aJ.KEY_SCOPE,function(gh){fo(gh);return false});if(f8.include_delete&&f8.share_button_experiment_variant!=="WHITE_BUTTON"){key("delete, command+backspace, backspace",aJ.KEY_SCOPE,function(gh){Event.extend(gh).preventDefault();return aJ.toggle_delete()});bE("#lightbox-delete-photo").on("click",(function(gh){fO();return ga[fF].delete_pressed()}));bE("#lightbox-delete-cancel").on("click",f3)}eD.add_exit_callback("/lightbox",function(){return f4()});d5.disableSelection(gg.find(".preview-container")[0]);d5.disableSelection(gg.find(".header")[0]);fX=true}Event.observe(document,"mousemove",fV);Event.observe(document,"click",fV);document.observe(aF.DELETE,f9);document.observe(aJ.PHOTO_DELETE_EVT,fC);document.observe(eW.CHANGE_EVT,fw);key.setScope(aJ.KEY_SCOPE);return fN=setInterval(fM,500)};f2=function(){var gi,gk,gj,gh,gg;if(!fx){return}gg=[];for(gi=gj=0,gh=ga.length;gj<gh;gi=++gj){gk=ga[gi];if(gk.link_hash&&gk.link_hash.toLowerCase()===fx.toLowerCase()){fF=gi;if(!aJ.shown){gg.push(aJ.show())}else{gg.push(fU())}}else{gg.push(void 0)}}return gg};gc=function(){return on_script_loaded(function(){a2.watch("lh",function(gg){fx=gg;return f2()});return a2.watch("f",function(gi){var gj,gl,gk,gh,gg;gg=[];for(gj=gk=0,gh=ga.length;gk<gh;gj=++gk){gl=ga[gj];if(gl.filename.toLowerCase()===gi.toLowerCase()){fF=gj;if(!aJ.shown){gg.push(aJ.show())}else{gg.push(fU())}}else{gg.push(void 0)}}return gg})})};fw=function(gk,gm){var gi,gl,gh,gj,gg;if(gm==null){gm=bE("#lightbox_share")}gh=eW.get();gj=c8.categorize_files(gh),gi=gj[0],gl=gj[1];if(gh.length===0){gm.text(eA("Share"));return(gg=ga[fF])!=null?gg.toggle_select_button_off(bE("#lightbox-select-button")):void 0}else{if(gh.length===1){if(gi){return gm.text(eA("Share 1 photo"))}else{return gm.text(eA("Share 1 video"))}}else{if(gi&&gl){return gm.text(eA("Share %(num_files)s items",{comment:"num_files is a number greater than 1"}).format({num_files:gh.length}))}else{if(gi){return gm.text(eA("Share %(num_photos)s photos",{comment:"num_photos is a number greater than 1"}).format({num_photos:gh.length}))}else{return gm.text(eA("Share %(num_videos)s videos",{comment:"num_videos is a number greater than 1"}).format({num_videos:gh.length}))}}}}};fH=function(){bo.hide_all();bE("#file-preview-modal .delete-file-prompt").show();bE(document).trigger("dropdownOpened",[1]);fG();ft=true;f7(aJ.toggle_delete);return bE("#lightbox-delete-photo").focus()};f3=function(){var gh,gg;if(ft){gh=bE("#file-preview-modal .delete-file-prompt");gh.hide();bE(document).trigger("dropdownClosed",[1]);if((gg=gh.find(":focus")[0])!=null){gg.blur()}fV();ft=false;return fA()}};fO=function(){gf();if(ft){return f3()}else{return fH()}};fs=function(){return ga[fF].delete_pressed()};return{init_from_preview_objs:function(gj,gn,gi){var gm,gl,gg,gk,gh;if(gi==null){gi=true}gg=[];for(gk=0,gh=gj.length;gk<gh;gk++){gm=gj[gk];if(gm.is_video){gl=new bG({filename:gm.filename,fq_path:gm.path,thumbnail_url_tmpl:gm.thumbnail_url,preview_url:gm.preview_url,dl_url:gm.dl_url,shmodel_link:gm.shmodel_link,ns_id:gm.ns_id,ns_path:gm.path,link_hash:gm.item_id+"-"+gm.filename,metadata_link:gm.metadata_link})}else{gl=new X({filename:gm.filename,fq_path:gm.path,thumbnail_url_tmpl:gm.thumbnail_url,dl_url:gm.dl_url,original_url:gm.orig_url,shmodel_link:gm.shmodel_link,ns_id:gm.ns_id,ns_path:gm.ns_path,link_hash:gm.item_id+"-"+gm.filename,enable_download:gm.enable_download})}gg.push(gl)}aJ.init(gg,{include_delete:false,keep_url:true,filename_in_url:true,enable_sublinks:gi});return document.on(aJ.EXIT_SELECT_EVT,function(gp){var go;key.setScope("all");go=bE(gn)[gg.indexOf(gp.memo)];d5.scroll_to_thumb(go);bE(go).addClass("wiggobble");return setTimeout((function(){return bE(go).removeClass("wiggobble")}),1000)})},init:function(gg,gh){if(aJ.shown){return}aJ.more_actions_button=new Element("a",{id:"lightbox-more-actions-button",href:"#","class":"lightbox-more-actions-button title_bubble black extra-margin",title:eA("More actions")});aJ.more_actions_button.observe("click",(function(gi){gi.preventDefault();return aJ.toggle_more_actions_menu()}));aJ.more_actions_button.__date(cv.make("web","lightbox_more"));gh=gh||{};f8={include_delete:gh.include_delete||false,keep_url:gh.keep_url||false,num_previews:gh.num_previews||null,filename_in_url:gh.filename_in_url||false,no_wrap:(gh.no_wrap||false)||true,no_preload:gh.no_preload||false,enable_sublinks:gh.enable_sublinks!=null?gh.enable_sublinks:true,share_button_experiment_variant:gh.share_button_experiment_variant||false};fQ=gh.is_loading||false;cJ(!f8.filename_in_url||f8.keep_url,"filename_in_url cannot be used with keep_url off");ga=gg;if(gh.start_index!=null){aJ.show(gh.start_index)}if(f8.filename_in_url){gc()}return $(document.body).on("click",".more-actions-item",function(gi,gj){if(gj.down("a").getAttribute("href").length<2){gi.preventDefault()}return aJ.close_more_actions_menu()})},update_previews:function(gg){return ga=gg},show:function(gg){var gh,gi;if(aJ.shown){return}cJ(ga&&ga.length,"Lightbox.show() requires file preview objects to show");f6();if(gg!=null){fF=gg}bE("#file-preview-modal").trigger("lightbox-init-show",{preview:ga[fF]});if((gi=ga[fF])!=null?gi.enable_download:void 0){aJ.more_actions_button.show()}else{aJ.more_actions_button.hide()}cJ(!aJ.shown,"Trying to reshow file preview modal");$("file-preview-modal").show();B.scroll_lock_document();fU(true);aJ.shown=1;if(!f8.keep_url){gh=eD.deconstruct_url(eD.get_url());if(gh.path.indexOf("/lightbox/")!==0){eD.push_state("/lightbox"+gh.path,gh.qargs)}}return fV()},jump_to:function(gg){cJ(aJ.shown,"Lightbox should be showing");fF=gg;fU();return fV()},set_no_wrap:function(gg){return f8.no_wrap=gg},update_with_error:function(){fr=true;return fZ()},num_previews:function(){return f8.num_previews||ga.length},get_previews:function(){return ga},current_index:function(){return fF},close_more_actions_menu:gf,toggle_more_actions_menu:fy,update_share_button_text:fw,toggle_delete:fO,delete_current:fs,back:fK,PHOTO_CHANGE_EVT:"db:lightbox:photo_change",PHOTO_DELETE_EVT:"db:lightbox:photo_delete",PHOTO_REMOVE_FROM_ALBUM_EVT:"db:lightbox:photo_remove_from_album",ACTIONS_ADDED:"db:lightbox:actions_added",EXIT_SELECT_EVT:fD,NEXT:1,PREV:-1,vid_thumbnail_hidden:null,KEY_SCOPE:"lightbox",LIGHTBOX_HIDE_EVT:"lightbox-hide",LIGHTBOX_SHOW_EVT:"lightbox-preview"}})();var bF;bF=D.Tour=(function(){var fn,fm,fp,fq,fu,fs,ft,fr,fo,fv,fl,T;fm=6;fn=0;fl=function(fw){var fF,fE,fD,fy,fx,fz,fB,fC,fA;$$(".page-end").each(Element.remove);fx=fw;fB=fm-fw-1;fF=document.createDocumentFragment();for(fE=fC=0;0<=fx?fC<fx:fC>fx;fE=0<=fx?++fC:--fC){fy=new Element("img",{src:"/static/images/page-left-vflvWgvOr.png","class":"page-end-left page-end"});fy.style.left=(28-fE*5)+"px";fy.style.zIndex=fm-fE;fF.appendChild(fy)}for(fD=fA=0;0<=fB?fA<fB:fA>fB;fD=0<=fB?++fA:--fA){fz=new Element("img",{src:"/static/images/page-right-vflnAeb-6.png","class":"page-end-right page-end"});fz.style.right=(31-fD*5)+"px";fz.style.zIndex=fm-fD;fF.appendChild(fz)}return $("book").appendChild(fF)};T=function(fw){(fw>0?Element.show:Element.hide)("tour-page-back");return(fw+1<fm?Element.show:Element.hide)("tour-page-forward")};fo=function(fw){$$(".pages").invoke("hide");return $("page-"+fw).show()};fp=function(fw){T(fw);fl(fw);fo(fw);return fn=fw};fr=function(fx){var fw;Event.extend(fx).preventDefault();fw=fn-1;if(fw<0){return}fp(fw);return eD.push_state("/tour/"+fw)};fs=function(fx){var fw;Event.extend(fx).preventDefault();fw=fn+1;if(fw>=fm){return}fp(fw);return eD.push_state("/tour/"+fw)};fv=function(fx,fy){var fw;fx.preventDefault();fw=parseInt(fy.href.split("/").last(),10);fp(fw);return eD.push_state("/tour/"+fw)};fu=function(){$("tour-page-back").observe("click",fr);$("tour-page-forward").observe("click",fs);key("right",fs);key("left",fr);return $("toc").on("click","a",fv)};fq=function(fx,fy){var fw;fw=parseInt(fx,10)||0;if(fw<0||fw>=fm){fw=0}return fp(fw)};ft=function(){var fA,fz,fx,fy,fw;fy=$$(".page-right img");fw=[];for(fz=0,fx=fy.length;fz<fx;fz++){fA=fy[fz];fw.push(d5.preload_image(fA.src))}return fw};return{setup:function(){return bE(function(){eD.add_callback("/tour",fq);fu();return ft()})}}})();var bQ,bK=[].indexOf||function(fm){for(var fl=0,T=this.length;fl<T;fl++){if(fl in this&&this[fl]===fm){return fl}}return -1};bQ=INLINE_JS.Photos=D.Photos={THUMB_SIZE:198,MONTH_HEADER_HEIGHT:46,COLLECTION_HEADER_HEIGHT:4,LIGHTBOX_OFFSET:25,DUPLICATES_SNIPPET_LENGTH:30,KEY_SCOPE:"photos",NUM_PHOTOS_LONG_RUNNING_DELETES:100,NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP:200,_all_photos_timeline:null,_single_collection_timeline:null,_last_lightbox_photo:null,_current_collection_gid:null,_in_all_collections_view:false,_tmpl:null,_cu_duplicate_tmpl:null,_creating_filetags:false,_creating_filetags_cb:null,event_metadata_cache:{},scroll_count:0,initialized:false,_init_finished:false,init:function(fr,fm,fo,fv,fs,fn,fl,ft,fx,T){var fq,fu,fw,fp;this.event_metadata_cache=fl;this._root_collection_gid=T;this.initialized=true;this.disable_selection();d5.disable_ie_image_dragging();this._tmpl=fg.tmpl("cu_list_item_tmpl");this._cu_duplicate_tmpl=fg.tmpl("cu_duplicate_list_item_tmpl");this._current_collection_gid=fs!=null?fs.gid:void 0;key.setScope(this.KEY_SCOPE);this.include_shared_folders=ft.include_shared_folders;this.show_hidden=ft.show_hidden;this.timestamp_edit_enabled=fx.timestamp_edit_enabled;this.undo_enabled=fx.undo_enabled;this.local_storage_enabled=fx.local_storage_enabled;fu=eD.deconstruct_url();fp="share" in fu.qargs;for(fw in fv){if(fv.hasOwnProperty(fw)){eW.inc_num_loading_events_before_select(fp)}}this._init_timeline(fr,fm,fo,fv);this._init_lightbox();fq=[];if(fs!=null){fq.push(new ab(fs,false))}cG.init(fq,fn);eW.drag_select_enabled=fx.drag_select_enabled;if(ft.show_photos_tour){aL.next()}delete fu.qargs.selr;delete fu.qargs.user_email;delete fu.qargs.uid;delete fu.qargs.share;delete fu.qargs.m;if("uuid" in fu.qargs){delete fu.qargs.uuid;delete fu.qargs.id}if(dL){eD.replace_state(fu.path,fu.qargs)}else{if(!F.parse(window.location.href).fragment){eD.push_state("/photos",fu.qargs)}}this._listen();return this._init_finished=true},_listen:function(){$(document.body).on("click",".cu-thumb",this._thumb_click.bind(this));$(document.body).on("dblclick",".cu-thumb",this._thumb_double_click.bind(this));$(document.body).on("contextmenu",".cu-thumb",this._thumb_context_menu.bind(this));document.observe(aJ.PHOTO_CHANGE_EVT,this._lightbox_photo_change.bind(this));document.observe(aJ.PHOTO_DELETE_EVT,this._lightbox_delete.bind(this));document.observe(aJ.PHOTO_REMOVE_FROM_ALBUM_EVT,this._lightbox_remove.bind(this));document.observe(aJ.EXIT_SELECT_EVT,this._lightbox_exit.bind(this));document.observe(bn.HIDE_EVT,this._context_menu_hide.bind(this));Event.observe(window,"resize",this._window_resize.bind(this));eD.add_callback("/photos",this._history_change_handler.bind(this));document.observe(dc.EVENT_MISCOUNT_EVT,this._photos_changed.bind(this));document.observe(dc.PHOTOS_LOADED_EVT,this._photos_loaded.bind(this));document.observe(ci.PHOTOS_ADDED_EVT,this._photos_changed.bind(this));document.observe(ci.PHOTOS_REMOVED_EVT,this._photos_changed.bind(this));bE("#photos-nav-item").on("click",this.show_all_photos.bind(this));bE("#back-to-photos").on("click",this._back_to_photos.bind(this));bE("#back-to-albums").on("click",this._back_to_albums.bind(this));bE("#share-selected").on("click",this._share_selected.bind(this));bE("#clear-selected").on("click",this._clear_selected.bind(this));bE("#share-collection").on("click",this._share_collection.bind(this));if(this.include_shared_folders){bE("#do-include-shared-folders").prop("checked",true)}else{bE("#dont-include-shared-folders").prop("checked",true)}cG.listen();eW.listen();$(document.body).on("click",".event-select",this._select_event.bind(this));$(document.body).on("click",".event-share",this._share_event.bind(this));$(document.body).on("click",".event-add-to-album",this._add_event_to_album.bind(this));return bE(".show-all-photos").on("click",this.show_all_photos.bind(this))},_select_event:function(fr){var fn,fq,fm,fp,fl,fo,T;fq=$(fr.target).up(".cu-month-header").identify().slice(2);fn=this.get_timeline().events.valueFromKey(fq);fo=fn.photos;T=[];for(fp=0,fl=fo.length;fp<fl;fp++){fm=fo[fp];T.push(eW._add(fm))}return T},_share_event:function(fq){var fm,fp,fl,fo,T,fn;fp=$(fq.target).up(".cu-month-header").identify().slice(2);fm=this.get_timeline().events.valueFromKey(fp);fn=fm.photos;for(fo=0,T=fn.length;fo<T;fo++){fl=fn[fo];eW._add(fl)}return this._share_selected()},_add_event_to_album:function(fq){var fm,fp,fl,fo,T,fn;fp=$(fq.target).up(".cu-month-header").identify().slice(2);fm=this.get_timeline().events.valueFromKey(fp);fn=fm.photos;for(fo=0,T=fn.length;fo<T;fo++){fl=fn[fo];eW._add(fl)}return cG.show_add_to_album_modal(fq,eW.get())},_init_timeline:function(fr,fm,fn,ft){var fl,fu,fs,T,fv,fq,fp,fo;if(!fr.length){this.show_empty_state();return}fl=this.in_single_collection_view()?$("single-collection-list"):$("photos-list");fq=$("cu-view").cumulativeOffset().top+fl.getLayout().get("margin-top")+fl.getLayout().get("padding-top");if(bE("#carousel-promo-banner").outerHeight()){fq+=bE("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}fs=$("cu-view").cumulativeOffset().left+fl.getLayout().get("margin-left")+fl.getLayout().get("padding-left");fu={top_offset:fq,left_offset:fs,thumb_size:this.THUMB_SIZE,header_height:this.in_single_collection_view()?this.COLLECTION_HEADER_HEIGHT:this.MONTH_HEADER_HEIGHT};T={uses_lightbox:true,uses_timeline_nav:true,log_thumb_loading:true};fv=new ci(fl,null,fr,fm,fn,ft,this._tmpl,fu,T);if(this.in_single_collection_view()){if((fp=this._single_collection_timeline)!=null){fp.unlisten()}this._single_collection_timeline=fv}else{if((fo=this._all_photos_timeline)!=null){fo.unlisten()}this._all_photos_timeline=fv}return this.get_timeline().render()},_init_lightbox:function(){var fl,T;if(this.get_timeline()==null){return}if(aJ.shown){T=this.get_timeline().get_preview_objs();if(T.length){aJ.update_previews(T);fl=Math.min(aJ.current_index(),T.length-1);return aJ.jump_to(fl)}else{return aJ.back()}}else{return aJ.init(this.get_timeline().get_preview_objs(),{include_delete:true,no_wrap:true})}},_photos_loaded:function(){return this._init_lightbox()},_photos_changed:function(){this._init_lightbox();return this.set_empty_state()},_refresh_view:function(fl){var T;if((T=this.get_timeline())!=null){T.unlisten()}eW.clear();$("cu-empty").hide();$("single-album-empty").hide();if(this.in_single_collection_view()){$("single-collection-list").__date()}this._refresh_photo_events(fl);return window.scrollTo(0,0)},_refresh_photo_events:function(T){this.event_metadata_cache=null;return new Ajax.DBRequest("/photos_events",{parameters:{collection_gid:this._current_collection_gid,show_hidden:this.show_hidden},onSuccess:(function(fl){return function(fm){var fn;fn=JSON.parse(fm.responseText);if(fn==="deleted_collection"){fl._current_collection_gid=null;cG.reload();fl.show_all_collections();ae.error(eA("This album has been deleted!"));return}fl._init_timeline(fn.header_ids,fn.header_id_to_name,fn.header_id_to_num_photos,{});fl._init_lightbox();return typeof T==="function"?T():void 0}})(this)})},set_empty_state:function(){if(this.get_timeline().events.length()){return this.hide_empty_state()}else{return this.show_empty_state()}},show_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").show()}else{return $("cu-empty").show()}},hide_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").hide()}else{return $("cu-empty").hide()}},get_timeline:function(){if(this.in_single_collection_view()){return this._single_collection_timeline}else{return this._all_photos_timeline}},show_in_folder:function(T){if(T.duplicates_info!=null){return this._show_duplicates_modal(T,false)}else{return window.open(this._get_browse_link(T),"_blank")}},_get_browse_link:function(fl){var T;T=fi.get_browse_root(cK.get_viewer().photos_user);return String(F({path:""+T+(ay.normalize(ay.parent_dir(fl.fq_path))),query:{select:fl.filename}}))},in_single_collection_view:function(){return this._current_collection_gid!=null},in_all_collections_view:function(){return this._in_all_collections_view},get_current_collection:function(){if(this._current_collection_gid!=null){return cG.get(this._current_collection_gid)}else{return null}},get_current_collection_gid:function(){return this._current_collection_gid||this._root_collection_gid},enable_selection:function(){return d5.enableSelection($(document.body))},disable_selection:function(){return d5.disableSelection($(document.body))},show_collection:function(fm){var fl,T;i.log_transition_to(cl.SINGLE_COLLECTION_VIEW);T=eD.deconstruct_url();fl="/lightbox";if(T.path.indexOf(fl)===0){T.path=T.path.slice(fl.length);key.setScope(this.KEY_SCOPE);this._last_lightbox_photo=null}if(bK.call(T.path,"/album/")<0){if(T.path==="/photos/all_albums"){$("back-to-photos").hide();$("back-to-albums").show()}else{$("back-to-albums").hide();$("back-to-photos").show()}}if(fm!=null){T.path=cG.get(fm).url}return eD.push_state(T.path,T.qargs)},show_all_collections:function(){i.log_transition_to(cl.ALBUMS_VIEW);return eD.push_state("/photos/all_albums")},show_all_photos:function(fl){var T;fl.preventDefault();i.log_transition_to(cl.PHOTOS_VIEW);T=eD.deconstruct_url();if(T.path==="/photos"){return this._refresh_view()}else{eW.clear();return eD.push_state("/photos")}},_back_to_photos:function(T){eW.clear();return this.show_all_photos(T)},_back_to_albums:function(T){eW.clear();return this.show_all_collections()},get_thumb_click_event_data:function(fm,T){var fl;fl=fm.event;return{timeline_photo_index:T,event_photo_index:fl.photos.indexOf(fm),num_photos_in_event:fl.photos.length,event_index:this.get_timeline().events.list.indexOf(fl.unique_id),num_events:this.get_timeline().events.list.length}},_thumb_click:function(fl){var T;T=this.get_timeline().get_photo_for_thumb_elm($(fl.target));if(eW._drag_drop.ignore_next_click){return eW._drag_drop.ignore_next_click=false}else{return eW.photo_click(fl,T)}},_thumb_double_click:function(fn){var fm,fl,T;fl=this.get_timeline().get_photo_for_thumb_elm($(fn.target));T=this.get_timeline().index_of_photo(fl);this._preview(T);fm=this.get_thumb_click_event_data(fl,T);return i.log_interaction(en.OPEN_LIGHTBOX,db.DBL_CLICK,fm)},_thumb_context_menu:function(fp){var fm,fq,fo,fl,fn,T;fm=this.get_timeline().get_photo_for_thumb_elm($(fp.target));if(fp.shiftKey){eW.photo_click(fp,fm);return}if(eW.contains(fm)){fq=eW.get()}else{fq=[fm]}bn.show_photos(fp,fq);T=[];for(fo=0,fl=fq.length;fo<fl;fo++){fm=fq[fo];T.push((fn=this.get_timeline().get_thumb_elm_for_photo(fm))!=null?fn.addClassName("context-selected"):void 0)}return T},_context_menu_hide:function(T){$$(".cu-thumb.context-selected").invoke("removeClassName","context-selected");return $$(".photo-collection.context-selected").invoke("removeClassName","context-selected")},_share_selected:function(fl){var T;T=eW.get();if(!T.length){return}ez.show(T,false);return i.log_interaction(en.SHARE,db.SAH,{num_photos:T.length})},_clear_selected:function(fl){var T;T=eW.get().length;eW.clear();return i.log_interaction(en.CLEAR_SELECTED,db.SAH,{num_photos:T})},_share_collection:function(fl){var T;cJ(this.in_single_collection_view(),"_share_collection can only happen in single collection view");T=this.get_current_collection();if(T.num_items===0){ae.error(eA("This album is empty. Add some photos before you share it!"));return}ez.show(this.get_current_collection(),true);return i.log_interaction(en.SHARE_ALBUM,db.SCA)},toggle_mem_lane_settings:function(T){var fm,fl;if(T){Event.extend(T).preventDefault()}if(!bE("#memory-lane-settings-menu").visible()){fl=bE("#memory-lane-settings-menu");eU.show($("memory-lane-settings-menu"),$("memory-lane-settings-button"));fm=function(fn){return fn.stopPropagation()};fl.off("mousedown");fl.off("click");fl.on("mousedown",fm);return fl.on("click",fm)}},show_delete_photos_modal:function(fs){var ft,fp,fm,fq,T,fl,fn,fr,fo;if(fs.length===1){fl=fs[0];if(fl.duplicates_info!=null){this._show_duplicates_modal(fl,true);return}}else{ft=[];for(fn=0,fr=fs.length;fn<fr;fn++){fl=fs[fn];if(fl.duplicates_info!=null){fp=fl.duplicates_info.slice(0);fp.push(fl);fp.sort(function(fv,fu){return fu.mtime-fv.mtime});ft=ft.concat(fp)}}if(ft.length){this._show_delete_multiple_duplicates_modal(fs,ft);return}}fo=c8.categorize_files(fs),fq=fo[0],T=fo[1];if(fq&&T){fm=bc("Delete %(file_count)s item?","Delete %(file_count)s items?",fs.length)}else{if(fq){fm=bc("Delete %(file_count)s photo?","Delete %(file_count)s photos?",fs.length)}else{fm=bc("Delete %(file_count)s video?","Delete %(file_count)s videos?",fs.length)}}return dM.show({title_text:fm.format({file_count:fs.length}),body_html:eA("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:c8.file_desc(fs)}),confirm_text:eA("Delete"),cancel_text:eA("Cancel"),confirm_callback:(function(fu){return function(){return fu._delete_photos(fs)}})(this)})},_delete_photos:function(fz){var fv,ft,fn,fw,T,fl,fy,fs,fq,fp,fx,fm,fr,fo,fu;fz=fz.slice(0);fy=[];for(fq=0,fx=fz.length;fq<fx;fq++){fl=fz[fq];fy.push(fl.fq_path);if(fl.duplicates_info!=null){fr=fl.duplicates_info;for(fp=0,fm=fr.length;fp<fm;fp++){fn=fr[fp];fy.push(fn.fq_path)}}}fo=c8.categorize_files(fz),fw=fo[0],T=fo[1];if(fw&&T){ft=bc("Deleting file","Deleting files",fy.length);fv=bc("Deleted file.","Deleted files.",fy.length)}else{if(fw){ft=bc("Deleting photo","Deleting photos",fy.length);fv=bc("Deleted photo.","Deleted photos.",fy.length)}else{ft=bc("Deleting video","Deleting videos",fy.length);fv=bc("Deleted video.","Deleted videos.",fy.length)}}fu=function(fA){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(fA)},html_in_error_msg:true,progress_text:eA("Undoing..."),onSuccess:function(fB){var fC;fC=eA("Undo complete");ae.success(fC);return bQ._all_photos_timeline.restore_removed_photos()},subject_user:cK.get_viewer().photos_user})};fs=(function(fA){return function(fB){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:fy},job:fy.length>bQ.NUM_PHOTOS_LONG_RUNNING_DELETES,job_user:cK.get_viewer().photos_user,progress_text:ft,onSuccess:function(fE){var fC,fF,fD;fF=fE.responseText.evalJSON();fD=bQ.undo_enabled&&(bQ._all_photos_timeline!=null);fC=fD?fF.changesets:null;W.notifyWithUndo(ft,fC,fu);bQ.get_timeline().remove_photos(fz);if(fB.length>0){return cG.refresh_album_views(fB)}},subject_user:cK.get_viewer().photos_user})}})(this);return new Ajax.DBRequest("/collections_from_paths",{parameters:{fq_paths:JSON.stringify(fy)},onSuccess:(function(fA){return function(fD){var fC,fB,fE,fF;fB=JSON.parse(fD.responseText);fE=[];for(fF in fB){fC=fB[fF];fE=fE.concat(fC)}return fs(fE)}})(this)})},_preview:function(T){return aJ.show(T)},_lightbox_delete:function(T){var fl;fl=T.memo.photo;i.log_interaction(en.DELETE,db.LIGHTBOX);return this.show_delete_photos_modal([fl])},_lightbox_remove:function(fl){var T;T=fl.memo.photo;this.get_current_collection().remove_photos([T]);return i.log_interaction(en.REMOVE,db.LIGHTBOX)},_show_duplicates_modal:function(fl,fA){var fs,fz,fq,fu,ft,fn,fw,fm,fr,fv,T,fy,fo,fx,fp;ft=fl.duplicates_info.slice(0);ft.push(fl);ft.sort(function(fC,fB){return fB.mtime-fC.mtime});fu=$("cu-duplicate-files");fn=[];for(fo=0,fx=ft.length;fo<fx;fo++){fq=ft[fo];fz="Dropbox"+ay.normalize(ay.parent_dir(fq.fq_path));fn.push(this._cu_duplicate_tmpl({thumbnail_url:fq.thumbnail_url,filename_snippet:bU.em_snippet(fq.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bU.em_snippet(fz,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(fq)}))}fu.__date(fn);if(ft.length>=5){fu.addClassName("scroll")}else{fu.removeClassName("scroll")}fp=c8.categorize_files([fl]),fv=fp[0],T=fp[1];if(fv){fm=eA("There are multiple copies of this photo.");fr=eA("Delete all copies of this photo?")}else{fm=eA("There are multiple copies of this video.");fr=eA("Delete all copies of this video?")}if(fA){fw="delete_32";fy=fr;fs=fm+" "+eA("Would you like to delete them all?");$("cu-delete-all-duplicates").show()}else{fw="folder_32";fy=eA("Show in folder");fs=fm+" "+eA("Which folder would you like to view?");$("cu-delete-all-duplicates").hide()}ds.fillVal(fs,"cu-duplicates-desc");return fc.show(fy,$("cu-duplicates-modal"),{action:this._delete_photos.curry([fl])})},_show_delete_multiple_duplicates_modal:function(fx,fs){var fw,fq,ft,fm,fl,fr,fp,fu,T,fn,fv,fo;ft=$("cu-multiple-duplicate-files");fm=[];for(fn=0,fv=fs.length;fn<fv;fn++){fq=fs[fn];fw="Dropbox"+ay.normalize(ay.parent_dir(fq.fq_path));fm.push(this._cu_duplicate_tmpl({thumbnail_url:fq.thumbnail_url,filename_snippet:bU.em_snippet(fq.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bU.em_snippet(fw,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(fq)}))}ft.__date(fm);if(fs.length>=5){ft.addClassName("scroll")}else{ft.removeClassName("scroll")}fo=c8.categorize_files(fx),fu=fo[0],T=fo[1];if(fu&&T){fl=eA("Delete %(num_files)s files and all copies?").format({num_files:fx.length});fr=eA("There are multiple copies of these files in your Dropbox.");fp=eA("Show files with multiple copies")}else{if(fu){fl=eA("Delete %(num_photos)s photos and all copies?").format({num_photos:fx.length});fr=eA("There are multiple copies of these photos in your Dropbox.");fp=eA("Show photos with multiple copies")}else{fl=eA("Delete %(num_videos)s videos and all copies?").format({num_videos:fx.length});fr=eA("There are multiple copies of these videos in your Dropbox.");fp=eA("Show videos with multiple copies")}}ds.fillVal(fr,"cu-multiple-duplicates-desc");ds.fillVal(fp,"cu-multiple-duplicates-show");$("cu-multiple-duplicates-modal").removeClassName("show-duplicates");return fc.show(fl,$("cu-multiple-duplicates-modal"),{action:this._delete_photos.curry(fx)})},show_timestamps_modal:function(fp){var fl,fm,fn,T,fo;fp.sort_by_key((function(fq){return fq.time_taken}),true);T=(function(){var fs,fr,fq;fq=[];for(fs=0,fr=fp.length;fs<fr;fs++){fn=fp[fs];fq.push(fn.time_taken)}return fq})();fl=(function(){var fs,fr,fq;fq=[];for(fs=0,fr=fp.length;fs<fr;fs++){fn=fp[fs];fq.push(fn.item_counter)}return fq})();fm=(function(){var fs,fr,fq;fq=[];for(fs=0,fr=T.length;fs<fr;fs++){fo=T[fs];if(fo==null){fq.push(fo)}}return fq})();if(fm.length===T.length){return this._show_add_timestamps_modal(fp,T,fl)}else{if(fm.length===0){return this._show_edit_timestamps_modal(fp,T,fl)}else{return cJ(false,"Timestamp modal should only open when all selected photos either have or don't have timestamp information.")}}},_scroll_to_photo_after_timestamp_edit:function(T,fl){return this._refresh_photo_events((function(fm){return function(){var fn,fo;fo=("m_"+(fl.getFullYear()))+(""+(fl.getMonth()+1)).lpad(2);fn=fm.get_timeline().events.valueFromKey(fo);cJ(fn!=null,"Event is missing after a timestamp edit!");eB.update("2/3");fn.on_load_all_metadata=function(){fm.get_timeline().scroll_to_photo_with_key(T.uniqueness_key);eB.hide();return ae.success("New timestamps have been saved!")};if(fn.has_loaded_metadata()){fn.on_load_all_metadata();return fn.on_load_all_metadata=null}else{return fn.load_metadata()}}})(this))},_show_add_timestamps_modal:function(fo,fl,T){var fn,fm;fm=bE("#add-timestamp-modal");fn=new H("date_picker",{disable_future:true});return fc.show("Set Timestamps",fm[0],{action:(function(fp){return function(){var ft,fx,fv,fw,fr,fs,fu,fq;fv=d5.to_iso8601_date(fn.selected_date,false,true);fw=(function(){var fA,fz,fy;fy=[];for(fs=fA=0,fz=fo.length;0<=fz?fA<fz:fA>fz;fs=0<=fz?++fA:--fA){fy.push(fv)}return fy})();fr={};for(ft=fu=0,fq=T.length;fu<fq;ft=++fu){fx=T[ft];fr[fx]=fw[ft]}eB.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(fr)},onSuccess:function(fy){eB.update("1/3");return fp._scroll_to_photo_after_timestamp_edit(fo[0],fn.selected_date)}})}})(this)})},_show_edit_timestamps_modal:function(fs,fr,fn){var T,fq,fm,fo,fp,fl;fq=bE("#edit-timestamp-modal");T=(function(){var fv,fu,ft;ft=[];for(fv=0,fu=fr.length;fv<fu;fv++){fo=fr[fv];ft.push(N.toUTCDate(new Date(fo)))}return ft})();fm={year:0,month:0,day:0,hour:0};fp=function(ft){return eA("%(date)s at %(time)s").format({date:N.localize(ft),time:N.format(ft,Constants.time_format)})};fl=function(ft,fx,fy,fw){var fv,fu;if(ft==null){ft=0}if(fx==null){fx=0}if(fy==null){fy=0}if(fw==null){fw=0}fm.year+=ft;fm.month+=fx;fm.day+=fy;fm.hour+=fw;fu=b4.increment_date(new Date(T[0]),fm.year,fm.month,fm.day,fm.hour,0);fv=b4.increment_date(new Date(T[T.length-1]),fm.year,fm.month,fm.day,fm.hour,0);if(fs.length===1){return fq.find("#timestamp-new").text(fp(fu))}else{fq.find("#timestamp-new-start").text(fp(fu));return fq.find("#timestamp-new-end").text(fp(fv))}};if(fs.length===1){fq.find("#edit-timestamp-single").show();fq.find("#edit-timestamp-multi").hide();fq.find("#timestamp-current").text(fp(T[0]))}else{fq.find("#edit-timestamp-single").hide();fq.find("#edit-timestamp-multi").show();fq.find("#timestamp-current-start").text(fp(T[0]));fq.find("#timestamp-current-end").text(fp(T[T.length-1]))}fl();bE("#timestamp-year-plus").on("click",fl.curry(1,0,0,0));bE("#timestamp-year-minus").on("click",fl.curry(-1,0,0,0));bE("#timestamp-month-plus").on("click",fl.curry(0,1,0,0));bE("#timestamp-month-minus").on("click",fl.curry(0,-1,0,0));bE("#timestamp-day-plus").on("click",fl.curry(0,0,1,0));bE("#timestamp-day-minus").on("click",fl.curry(0,0,-1,0));bE("#timestamp-hour-plus").on("click",fl.curry(0,0,0,1));bE("#timestamp-hour-minus").on("click",fl.curry(0,0,0,-1));fc.onHide=function(){var ft,fw,fu,fv;fv=["year","month","day","hour"];for(fw=0,fu=fv.length;fw<fu;fw++){ft=fv[fw];bE("#timestamp-"+ft+"-plus").off("click");bE("#timestamp-"+ft+"-minus").off("click")}fc.onHide=null;return fc.hide()};return fc.show("Edit Timestamps",fq[0],{action:(function(ft){return function(){var fD,fA,fu,fv,fB,fF,fC,fy,fE,fz,fx,fw;if((((fm.year===(fw=fm.month)&&fw===(fx=fm.day))&&fx===(fz=fm.hour))&&fz===0)){return}i.log_interaction(en.EDIT_TIMESTAMP,db.PCM,{num_photos:fs.length});fv=(function(){var fI,fH,fG;fG=[];for(fI=0,fH=T.length;fI<fH;fI++){fD=T[fI];fG.push(b4.increment_date(fD,fm.year,fm.month,fm.day,fm.hour,0))}return fG})();fB=(function(){var fI,fH,fG;fG=[];for(fI=0,fH=fv.length;fI<fH;fI++){fF=fv[fI];fG.push(d5.to_iso8601_date(fF,false,true))}return fG})();fC={};for(fA=fy=0,fE=fn.length;fy<fE;fA=++fy){fu=fn[fA];fC[fu]=fB[fA]}eB.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(fC)},job:fs.length>ft.NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP,job_user:cK.get_viewer().photos_user,onSuccess:function(fG){eB.update("1/3");return ft._scroll_to_photo_after_timestamp_edit(fs[0],fv[0])}})}})(this)})},_preload_file_previews:function(fn){var ft,fr,fm,T,fy,fx,fu,fs,fv,fq,fp,fw,fl,fo;fv=this.get_timeline().get_photos();if(fn[0]<=fn[fn.length-1]){fs=null;for(fq=0,fw=fn.length;fq<fw;fq++){fr=fn[fq];T=fv[fr];if(T.status!==J.PLACEHOLDER){continue}fy=T.event;if(fs==null){fs=fy;fu=T}if(fy===fs){continue}if(fs.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}fs.load_metadata();fs=fy;fu=T}if((fs!=null)&&!fs.has_loaded_metadata()){ft=fs.photos.indexOf(fu);fm=fs.photos.indexOf(T);if(fs.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}return fs.load_metadata_range(ft,fm)}}else{fo=[];for(fp=0,fl=fn.length;fp<fl;fp++){fr=fn[fp];T=fv[fr];if(T.status!==J.PLACEHOLDER){continue}fy=T.event;fx=fy.photos.indexOf(T);fo.push(fy.load_metadata(fx))}return fo}},_lightbox_photo_change:function(fs){var T,fu,fp,ft,fq,fo,fr,fn,fm,fl;this._last_lightbox_photo=fs.memo.preview_obj.photo;T=fs.memo.index;fp=aJ.num_previews();if(T===0||T===fp-1){return}if(fs.memo.direction===aJ.NEXT||(fs.memo.direction==null)){fu=Math.min(T+this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,fp-1);return this._preload_file_previews((function(){fm=[];for(var fv=fr=T+1;fr<=fu?fv<=fu:fv>=fu;fr<=fu?fv++:fv--){fm.push(fv)}return fm}).apply(this))}else{if(fs.memo.direction===aJ.PREV){ft=Math.max(T-this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,0);return this._preload_file_previews((function(){fl=[];for(var fv=fn=T-1;fn<=ft?fv<=ft:fv>=ft;fn<=ft?fv++:fv--){fl.push(fv)}return fl}).apply(this))}}},_lightbox_exit:function(T){return key.setScope(this.KEY_SCOPE)},_window_resize:function(){var fm,fl,fn,T;fl=$("cu-view").cumulativeOffset().top+$("photos-list").getLayout().get("margin-top")+$("photos-list").getLayout().get("padding-top");if(bE("#carousel-promo-banner").outerHeight()){fl+=bE("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}fm=$("cu-view").cumulativeOffset().left+$("photos-list").getLayout().get("margin-left")+$("photos-list").getLayout().get("padding-left");if((fn=this._all_photos_timeline)!=null){fn.update_offsets(fl,fm)}return(T=this._single_collection_timeline)!=null?T.update_offsets(fl,fm):void 0},_history_change_handler:function(fx,fw){var fs,ft,fu,fp,fn,fq,fv,fr,fo,fm,fl,T;if(this._init_finished){if(fc.shown()){fc.hide()}}$("photos-nav-item").removeClassName("selected");$$(".sidebar-album.selected").invoke("removeClassName","selected");if((fr=this.get_timeline())!=null){fr.unlisten()}if(fx==="all_albums"){cG.load_collections(null);this._in_all_collections_view=true;$("cu-view").removeClassName("single-collection");$("cu-view").addClassName("all-collections");if((fo=$("all-albums-sidebar"))!=null){fo.addClassName("selected")}eW.clear();document.title=eA("Albums")+" - Dropbox";cG.restore_all_albums_scroll_position();this._current_collection_gid=null;return}else{this._in_all_collections_view=false;$("cu-view").removeClassName("all-collections")}if(fx.startsWith("album/")){fs=cG.get_from_url("/photos/"+fx);fm=$$(".sidebar-album");for(fq=0,fv=fm.length;fq<fv;fq++){fu=fm[fq];if(fu.readAttribute("data-gid")===fs.gid){fu.addClassName("selected");break}}$("single-collection-title").__date(bU.em_snippet(fs.name,cG.HEADER_COLLECTION_SNIPPET_LENGTH,1));if(fs.shmodel_url!=null){$("single-collection-share-status").writeAttribute("href",fs.shmodel_url);if(((fl=fs.member_fnames)!=null?fl.length:void 0)>1){ft=eA("%(photo_video_desc)s from %(album_members)s",{comment:'for example: "3 photos and 1 video from Peter, Boris, and Ryan"'}).format({photo_video_desc:c8.album_desc(fs),album_members:d5.nice_list(fs.member_fnames)});$("single-collection-share-status").__date(ft)}else{$("single-collection-share-status").__date(eA("Shared"))}}else{$("single-collection-share-status").__date()}$("cu-view").addClassName("single-collection");if(!fs.is_creator){$("cu-view").addClassName("not-collection-creator")}document.title=""+fs.name+" - Dropbox";cy.log_event("show_collection",fs.gid,fs.num_photos,fs.is_anonymous)}else{fs=null;$("cu-view").removeClassName("single-collection");$("photos-nav-item").addClassName("selected");document.title=eA("Photos")+" - Dropbox"}fp=false;if(fs!=null){if(fs.gid!==this._current_collection_gid){fp=true}}else{if(this._all_photos_timeline==null){fp=true}}this._current_collection_gid=fs!=null?fs.gid:null;if(fp){this._refresh_view()}else{this._init_lightbox();this.get_timeline().init_timeline_nav();this.get_timeline().restore_scroll_position();this.get_timeline().listen()}if((this._last_lightbox_photo!=null)&&this.get_timeline().num_photos()){fn=this._last_lightbox_photo.uniqueness_key;this.get_timeline().scroll_to_photo_with_key(fn);if((T=$(fn))!=null){T.addClassName("wiggobble")}setTimeout((function(){return $(fn).removeClassName("wiggobble")}),1000);return this._last_lightbox_photo=null}}};var aL;aL=INLINE_JS.PhotosTour=D.PhotosTour={_frame:0,next:function(){var T;fc.show("",bE("#photos-tour-"+(this._frame+1))[0],null,null,700,null,null,false);T=this._frame;i.log_interaction(a8.SHOW_MODAL,"",{frame:T});bE("#modal-x").off("click");bE("#modal-x").on("click",((function(fl){return function(){return i.log_interaction(a8.EXIT_MODAL,"",{frame:T})}})(this)));return this._frame=(this._frame+1)%4},hide:function(T){i.log_interaction(T,"");return fc.hide()}};var c8;c8=D.PhotosUtil={categorize_files:function(fl){var fm,T;fm=fl.filter(function(fn){return fn.preview_type==="photo"});T=fl.filter(function(fn){return fn.preview_type==="video"});return[fm.length,T.length]},file_desc:function(fp,fm,T){var fl,fo,fn;if(fm==null){fm=false}if(T==null){T=false}fn=this.categorize_files(fp),fl=fn[0],fo=fn[1];return this._photo_video_desc(fl,fo,fm,T)},album_desc:function(fm,fl,T){if(fl==null){fl=false}if(T==null){T=false}return this._photo_video_desc(fm.num_photos,fm.num_videos,fl,T)},_photo_video_desc:function(fl,fq,fm,T){var fn,fp,fo;fp=bc("%d photo","%d photos",fl,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(fl);fo=bc("%d video","%d videos",fq,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(fq);if(fl&&fq){if(fm){fn=fl+fq;return bc("%d item","%d items",fn).format(fn)}else{if(T){return new fg(""+fp+"<br/>"+fo)}else{return eA("%(num_photos)s and %(num_videos)s",{comment:"num_photos and num_videos may be like either '1 photo' or '%d photos'"}).format({num_photos:fp,num_videos:fo})}}}else{if(fl){return fp}else{if(fq){return fo}else{return""}}}}};var eW,bK=[].indexOf||function(fm){for(var fl=0,T=this.length;fl<T;fl++){if(fl in this&&this[fl]===fm){return fl}}return -1};eW=INLINE_JS.PhotosSelection=D.PhotosSelection={CHANGE_EVT:"db:photos_selection:change",SHIFT_KEY_CODE:16,DRAG_STATUS_OFFSET:16,DRAG_START_THRESHOLD:10,SCROLL_BAR_WIDTH:10,_selected:[],_context_selected:null,_highlighted:[],_dehighlighted:[],_last_selected:null,_last_mouseover:null,_drag_select:{},_marquee:{},_drag_drop:{},_events_highlighting:[],_last_highlight_from_photo:null,_last_highlight_to_photo:null,_select_highlighted_waiting:0,_show_share_after_loading_selected:false,_num_pending_events_with_selections:0,_max_num_pending_events_with_selections:0,listen:function(){$(document.body).on("keydown",(function(T){return function(fl){if(fl.keyCode===T.SHIFT_KEY_CODE&&T._last_mouseover&&!B.focus_in_input()){return T._highlight_range(T._last_selected,T._last_mouseover)}}})(this));$(document.body).on("keyup",(function(T){return function(fl){if(fl.keyCode===T.SHIFT_KEY_CODE&&!T._marquee.active){return T.clear_highlighted()}}})(this));key("delete, command+backspace, backspace",bQ.KEY_SCOPE,(function(T){return function(fl){fl.preventDefault();if(bQ.in_single_collection_view()){if(T._selected.length){return cG.show_remove_photos_modal(bQ.get_current_collection(),T._selected)}}else{if(T._selected.length){return bQ.show_delete_photos_modal(T._selected)}}}})(this));key("esc",bQ.KEY_SCOPE,(function(T){return function(fm){var fl;if(typeof fm.preventDefault==="function"){fm.preventDefault()}if(T._drag_drop.active){T._drag_drop.active=false;if((fl=$("albums-sidebar-list"))!=null){fl.removeClassName("drag-drop")}return $("photos-drag-status").removeClassName("active")}else{T.clear();return i.log_interaction(en.CLEAR_SELECTED,db.ESC)}}})(this));$(document.body).on("mouseover",".cu-thumb",this._photo_mouseover.bind(this));$(document.body).on("mouseout",".cu-thumb",this._photo_mouseout.bind(this));$(document.body).on("mousedown",this._body_mousedown.bind(this));$(document.body).on("mousemove",this._body_mousemove.bind(this));$(document).on("mouseup",this._body_mouseup.bind(this));$(document.body).on("dblclick",this._body_double_click.bind(this));return A.init(null,bE("#cu-header").height())},is_selection_active:function(){return this._highlighted.length||this._selected.length||this._marquee.active||this._drag_drop.active||this._drag_select.active},get:function(){return this._selected},contains:function(fl){var T,fn,fm;fn=(function(){var fr,fp,fq,fo;fq=this._selected;fo=[];for(fr=0,fp=fq.length;fr<fp;fr++){T=fq[fr];fo.push(T.uniqueness_key)}return fo}).call(this);return fm=fl.uniqueness_key,bK.call(fn,fm)>=0},clear:function(){this._selected=[];this._last_selected=null;$$(".cu-thumb.selected").invoke("removeClassName","selected");$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected");eU.hide_all();return document.fire(eW.CHANGE_EVT)},clear_highlighted:function(){this._highlighted=[];this._dehighlighted=[];if(!this._select_highlighted_waiting){$$(".cu-thumb.highlighted").invoke("removeClassName","highlighted");$$(".cu-thumb.dehighlighted").invoke("removeClassName","dehighlighted");this._last_highlight_from_photo=null;return this._last_highlight_to_photo=null}},photo_click:function(fl,T){if(fl.isRightClick()&&!fl.shiftKey){return}if(fl.shiftKey){return this._select_highlighted()}else{if(this.contains(T)){return this._remove(T)}else{return this._add(T)}}},num_selected:function(){return this._selected.length},refresh:function(fn){var fp,fq,fm,fr,fo,fl,T;fr=(function(){var fv,ft,fu,fs;fu=this._selected;fs=[];for(fv=0,ft=fu.length;fv<ft;fv++){fm=fu[fv];fs.push(fm.uniqueness_key)}return fs}).call(this);T=[];for(fo=0,fl=fn.length;fo<fl;fo++){fq=fn[fo];fp=fr.indexOf(fq.uniqueness_key);if(fp>=0){T.push(this._selected[fp]=fq)}else{T.push(void 0)}}return T},inc_num_loading_events_before_select:function(T){if(!this._show_share_after_loading_selected){eB.show(eA("Loading photos..."))}this._show_share_after_loading_selected=T;this._num_pending_events_with_selections++;if(this._num_pending_events_with_selections>this._max_num_pending_events_with_selections){return this._max_num_pending_events_with_selections=this._num_pending_events_with_selections}},dec_num_loading_events_before_select:function(){this._num_pending_events_with_selections--;eB.update(""+(this._max_num_pending_events_with_selections-this._num_pending_events_with_selections)+"/"+this._max_num_pending_events_with_selections);if(this._num_pending_events_with_selections===0){eB.hide();if(this._show_share_after_loading_selected){this._show_share_after_loading_selected=false;if(this.num_selected()>0){return bQ._share_selected()}}}},_photo_mouseover:function(T){this._last_mouseover=bQ.get_timeline().get_photo_for_thumb_elm($(T.target));if(T.shiftKey){return this._highlight_range(this._last_selected,this._last_mouseover)}else{if(this._drag_select.active){return this._highlight_range(this._drag_select.anchor,this._last_mouseover,true)}}},_photo_mouseout:function(T){if(!this._marquee.active){this.clear_highlighted();return this._last_mouseover=null}},_body_mousedown:function(fn){var T,fl,fm;if(bQ.in_all_collections_view()||fn.isRightClick()||this._invalid_mouse_target($(fn.target))){return}bn.hide();eU.hide_all();T=(fm=bQ.get_timeline())!=null?fm.get_photo_for_thumb_elm($(fn.target)):void 0;if(T!=null){if(this.contains(T)||!eW.drag_select_enabled){fl=B.scroll_offsets();this._drag_drop.active=true;this._drag_drop.start_x=fn.clientX+fl.left;this._drag_drop.start_y=fn.clientY+fl.top;this._drag_drop.anchor=$(fn.target);this._drag_drop.single_photo=this.contains(T)?null:T;this._build_drag_status(T);this._update_drag_status_position(fn)}else{this._drag_select.active=true;this._drag_select.anchor=T}}else{fl=B.scroll_offsets();if((fn.clientX+fl.left)>=($(document.body).getWidth()-this.SCROLL_BAR_WIDTH)){return}this._marquee.active=true;this._marquee.start_x=fn.clientX+fl.left;this._marquee.start_y=fn.clientY+fl.top;this._marquee.x_max_boundary=-1;this._marquee.y_max_boundary=-1}return A.start()},_body_mousemove:function(fn){var fl,T,fo,fm;fl=B.scroll_offsets();T=fn.clientX+fl.left;fo=fn.clientY+fl.top;if(this._marquee.active){if(!$("marquee").visible()){if(Math.abs(T-this._marquee.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(fo-this._marquee.start_y)<this.DRAG_START_THRESHOLD){return}}this._marquee.end_x=T;this._marquee.end_y=fo;return this._draw_marquee()}else{if(this._drag_drop.active){if(!$("photos-drag-status").hasClassName("active")){if(Math.abs(T-this._drag_drop.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(fo-this._drag_drop.start_y)<this.DRAG_START_THRESHOLD){return}}this._update_drag_status_position(fn);$$(".sidebar-album").invoke("removeClassName","album-flash");if((fm=$("albums-sidebar-list"))!=null){fm.addClassName("drag-drop")}return $("photos-drag-status").addClassName("active")}}},_body_mouseup:function(fm){var fl,T;if(this._drag_select.active){this._drag_select.active=false;this._select_highlighted()}if(this._marquee.active){this._marquee.active=false;$("marquee").hide();fl=this._highlighted.length;this._select_highlighted();if(fl){i.log_interaction(en.MARQUEE_SELECT,db.DRAG,{num_selected:fl})}}if(this._drag_drop.active){if($(fm.target)===this._drag_drop.anchor&&$("photos-drag-status").hasClassName("active")){this._drag_drop.ignore_next_click=true}this._drag_drop.active=false;this._drag_drop.anchor=null;this._drag_drop.single_photo=null;if((T=$("albums-sidebar-list"))!=null){T.removeClassName("drag-drop")}$("photos-drag-status").removeClassName("active")}return A.end()},_body_double_click:function(T){if(bQ.get_timeline().get_photo_for_thumb_elm($(T.target))||this._invalid_mouse_target($(T.target))){return}this.clear();return i.log_interaction(en.CLEAR_SELECTED,db.DBL_CLICK)},_draw_marquee:function(){var T,fo,fn,fm,fl;fl=Math.abs(this._marquee.start_x-this._marquee.end_x);T=Math.abs(this._marquee.start_y-this._marquee.end_y);fn=Math.min(this._marquee.start_y,this._marquee.end_y);fo=Math.min(this._marquee.start_x,this._marquee.end_x);$("marquee").setStyle({width:fl+"px",height:T+"px",top:fn+"px",left:fo+"px"});$("marquee").show();fm=false;if(bQ.get_timeline()!=null){if(this._marquee.end_x>=this._marquee.x_max_boundary||this._marquee.end_x<=this._marquee.x_min_boundary){this._update_marquee_x_bounds(this._marquee.end_x);fm=true}if(this._marquee.end_y>=this._marquee.y_max_boundary||this._marquee.end_y<=this._marquee.y_min_boundary){this._update_marquee_y_bounds(this._marquee.end_y);fm=true}if(fm){return this._update_marquee_highlight(fn,fo,fl,T)}}},_update_marquee_highlight:function(fv,fm,T,fx){var ft,fu,fr,fl,fq,fp,fw,fs,fo,fn;this.clear_highlighted();fl=[];fu=bQ.get_timeline().grid.photo_col_offsets.length;fs=bQ.get_timeline().grid.photo_col_offsets.slice(0,fu-1);for(ft=fq=0,fw=fs.length;fq<fw;ft=++fq){fr=fs[ft];if(fr<=fm+T&&bQ.get_timeline().grid.photo_col_offsets[ft+1]>=fm){fl.push(ft)}}fn=[];for(ft=fp=0,fo=bQ.get_timeline().events.length();0<=fo?fp<fo:fp>fo;ft=0<=fo?++fp:--fp){fn.push(bQ.get_timeline().events.valueAtIndex(ft).marquee_highlight(fv,fv+fx,fl))}return fn},_update_marquee_x_bounds:function(T){var fn,fq,fr,fp,fm,fo,fl;fq=$(document.body).getWidth();if(T<bQ.get_timeline().grid.photo_col_offsets.first()){this._marquee.x_min_boundary=-1;return this._marquee.x_max_boundary=bQ.get_timeline().grid.photo_col_offsets.first()}else{if(T>bQ.get_timeline().grid.photo_col_offsets.last()){this._marquee.x_min_boundary=bQ.get_timeline().grid.photo_col_offsets.last();return this._marquee.x_max_boundary=fq}else{fo=bQ.get_timeline().grid.photo_col_offsets;fl=[];for(fn=fp=0,fm=fo.length;fp<fm;fn=++fp){fr=fo[fn];if(fr>T){this._marquee.x_min_boundary=bQ.get_timeline().grid.photo_col_offsets[fn-1];this._marquee.x_max_boundary=fr;break}else{fl.push(void 0)}}return fl}}},_update_marquee_y_bounds:function(fr){var T,fo,fn,fq,fm,fp,fl;fn=$(document.body).getHeight();if(fr<bQ.get_timeline().grid.photo_row_offsets.first()){this._marquee.y_min_boundary=-1;return this._marquee.y_max_boundary=bQ.get_timeline().grid.photo_row_offsets.first()}else{if(fr>bQ.get_timeline().grid.photo_row_offsets.last()){this._marquee.y_min_boundary=bQ.get_timeline().grid.photo_row_offsets.last();return this._marquee.y_max_boundary=fn}else{fp=bQ.get_timeline().grid.photo_row_offsets;fl=[];for(fo=fq=0,fm=fp.length;fq<fm;fo=++fq){T=fp[fo];if(T>fr){this._marquee.y_min_boundary=bQ.get_timeline().grid.photo_row_offsets[fo-1];this._marquee.y_max_boundary=T;break}else{fl.push(void 0)}}return fl}}},_build_drag_status:function(fn){var fm,T,fl;T=bQ.get_timeline().get_thumb_elm_for_photo(fn);fl=T.down("img.thumb-content").cloneNode(false);$("photos-drag-status").down(".thumb").__date(fl);fm=this._drag_drop.single_photo?[this._drag_drop.single_photo]:this._selected;return $("photos-drag-status").down(".count").__date(c8.file_desc(fm,false,true))},_update_drag_status_position:function(T){return $("photos-drag-status").setStyle({left:(T.pointerX()-B.scroll_offsets().left+this.DRAG_STATUS_OFFSET)+"px",top:(T.pointerY()-B.scroll_offsets().top+this.DRAG_STATUS_OFFSET)+"px"})},_highlight_range:function(fw,fv,fm){var fu,T,fn,fr,ft,fs,fl,fp,fq,fo;if(fm==null){fm=false}this.clear_highlighted();this._events_highlighting=[];this._last_highlight_from_photo=fw;this._last_highlight_to_photo=fv;fn=bQ.get_timeline().index_of_photo(fw);fl=bQ.get_timeline().index_of_photo(fv);fu=!fm&&this.contains(fv)&&!this.contains(fw);fo=[];for(fr=fp=fn;fn<=fl?fp<=fl:fp>=fl;fr=fn<=fl?++fp:--fp){fs=bQ.get_timeline().photo_at_index(fr);if(fs.status===J.PLACEHOLDER){if(fs.event!==ft){T=fs.event;if(!T.has_loaded_metadata()){T.on_load_all_metadata=this._highlight_range_incremental.bind(this);T.load_metadata();if(fq=T.unique_id,bK.call(this._events_highlighting,fq)<0){this._events_highlighting.push(T.unique_id)}fo.push(ft=T)}else{fo.push(void 0)}}else{fo.push(void 0)}}else{if(this.contains(fs)){if(fu){fo.push(this._dehighlight(fs))}else{fo.push(void 0)}}else{if(!fu){fo.push(this._highlight(fs))}else{fo.push(void 0)}}}}return fo},_highlight_range_incremental:function(T){var fr,fm,fs,fo,fp,fl,fq,fn;fs=this._last_highlight_from_photo;fq=this._last_highlight_to_photo;if(!((fs!=null)&&(fq!=null))){return}fm=bQ.get_timeline().index_of_photo(fs);fl=bQ.get_timeline().index_of_photo(fq);for(fo=fn=fm;fm<=fl?fn<=fl:fn>=fl;fo=fm<=fl?++fn:--fn){fp=bQ.get_timeline().photo_at_index(fo);if(fp.status!==J.PLACEHOLDER&&!this.contains(fp)&&this._highlighted.indexOf(fp)===-1){this._highlight(fp)}}fr=this._events_highlighting.indexOf(T.unique_id);if(fr>=0){this._events_highlighting.splice(fr,1)}if(this._select_highlighted_waiting){eB.update(""+(this._select_highlighted_waiting-this._events_highlighting.length)+"/"+this._select_highlighted_waiting);if(this._events_highlighting.length===0){return this._select_highlighted()}}},_highlight_list:function(fn){var fm,fo,fl,T;this.clear_highlighted();T=[];for(fo=0,fl=fn.length;fo<fl;fo++){fm=fn[fo];if(!this.contains(fm)){T.push(this._highlight(fm))}else{T.push(void 0)}}return T},_select_highlighted:function(){var fn,fq,fo,fm,fl,fp,T;if(this._events_highlighting.length>0){eB.show(eA("Selecting photos..."));this._select_highlighted_waiting=this._events_highlighting.length;return}fp=this._highlighted;for(fq=0,fm=fp.length;fq<fm;fq++){fn=fp[fq];this._add(fn)}T=this._dehighlighted;for(fo=0,fl=T.length;fo<fl;fo++){fn=T[fo];this._remove(fn)}if(this._select_highlighted_waiting){eB.hide();this._select_highlighted_waiting=0}return this.clear_highlighted()},_highlight:function(fl){var T;this._highlighted.push(fl);T=bQ.get_timeline().get_thumb_elm_for_photo(fl);return T!=null?T.addClassName("highlighted"):void 0},_dehighlight:function(fl){var T;this._dehighlighted.push(fl);T=bQ.get_timeline().get_thumb_elm_for_photo(fl);return T!=null?T.addClassName("dehighlighted"):void 0},_add:function(fl){var T;cJ(fl.status!==J.PLACEHOLDER,"placeholder photos can't be added to the selection",true,["photo_selection_placeholder"]);T=bQ.get_timeline().get_thumb_elm_for_photo(fl);if(T!=null){T.addClassName("selected")}this._selected.push(fl);this._last_selected=fl;ds.fillVal(c8.file_desc(this._selected,true),"selected-desc");ds.fillVal(this._selected.length,"num-selected");$("cu-view").addClassName("photos-selected");this._check_for_single_selection();$("page-sidebar").addClassName("photos-selected");return document.fire(eW.CHANGE_EVT)},_remove:function(fm){var fl,T;T=bQ.get_timeline().get_thumb_elm_for_photo(fm);if(T!=null){T.removeClassName("selected")}fl=this._selected.indexOf(fm);if(fl!==-1){this._selected.splice(fl,1);this._last_selected=fm;if(this._selected.length){ds.fillVal(c8.file_desc(this._selected,true),"selected-desc");ds.fillVal(this._selected.length,"num-selected")}else{$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected")}}this._check_for_single_selection();return document.fire(eW.CHANGE_EVT)},_invalid_mouse_target:function(fn){var fl,fm,T;fl=fn.classNames().toArray().concat(fn.up().classNames().toArray());return(bK.call(fl,"freshbutton")>=0)||(bK.call(fl,"freshbutton-blue")>=0)||(bK.call(fl,"freshbutton-lightblue")>=0)||(bK.call(fl,"freshbutton-blue-on-gray")>=0)||(bK.call(fl,"timeline-elm")>=0)||(fn.up(".no-marquee")!=null)||(fn.up("#context-menu")!=null)||(fn.up(".freshdropdown-menu")!=null)||fn.nodeName==="A"||((fm=fn.tagName.toUpperCase())==="INPUT"||fm==="TEXTAREA"||fm==="SELECT")||fc.shown()||((T=$("modal-progress-content"))!=null?T.visible():void 0)||aJ.shown},_check_for_single_selection:function(){if(this._selected.length===1){return $("cu-view").addClassName("single-selection")}else{return $("cu-view").removeClassName("single-selection")}}};var cG,bK=[].indexOf||function(fm){for(var fl=0,T=this.length;fl<T;fl++){if(fl in this&&this[fl]===fm){return fl}}return -1};cG=INLINE_JS.PhotosCollections=D.PhotosCollections={SIDEBAR_COLLECTION_SNIPPET_LENGTH:10,HEADER_COLLECTION_SNIPPET_LENGTH:25,CONTEXT_MENU_COLLECTION_SNIPPET_LENGTH:11,NUM_PHOTOS_LONG_RUNNING_ADDS:100,NUM_PHOTOS_LONG_RUNNING_REMOVES:250,NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES:50,LOADING_SPINNER:new fg('<br/><div class="cu-loading"><img src="/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif" /></div>'),_collections:[],_gid_to_collection:{},_url_to_collection:{},_collection_list_item_tmpl:null,_albums_sidebar_tmpl:null,_all_collections_loaded:false,_removed_pre_load:[],_all_albums_scroll_position:0,_num_loading_collections:0,init:function(fl,T){this._collections=fl;this._gid_to_collection=fl.dict_by("gid");this._url_to_collection=fl.dict_by("url");this._collection_list_item_tmpl=fg.tmpl("collection_list_item_tmpl");this._albums_sidebar_tmpl=fg.tmpl("albums_sidebar_tmpl");this._all_collections_loaded=false;this._sidebar_collections_loaded=false;this._num_loading_collections=0;this.refresh_album_views();return this._init_collections()},_init_collections:function(){var T;T=eD.deconstruct_url();if(T.path!=="/photos/all_albums"){return this.load_collections(5)}},load_collections:function(T){if(this._num_loading_collections!==null&&(this._num_loading_collections<T||T===null)){this._num_loading_collections=T;return cC.WebRequest({url:"/collections",data:{limit:T},subject_user:cK.get_viewer().photos_user,success:(function(fl){return function(fs){var fr,fq,fn,fp,fm,fo;fn=JSON.parse(fs);for(fp=0,fm=fn.length;fp<fm;fp++){fq=fn[fp];if(!(fq.gid in fl._gid_to_collection)&&!(fo=fq.gid,bK.call(fl._removed_pre_load,fo)>=0)){fr=new ab(fq,false);fl._collections.push(fr);fl._gid_to_collection[fr.gid]=fr;fl._url_to_collection[fr.url]=fr}}if(T===null||fn.length<T){fl._all_collections_loaded=true;fl._sidebar_collections_loaded=true}if(T>=5){fl._sidebar_collections_loaded=true}return fl.refresh_album_views()}})(this)})}},reload:function(){this._collections=[];this._gid_to_collection={};this._url_to_collection={};this._all_collections_loaded=false;this.refresh_album_views();return this._init_collections()},listen:function(){$("single-collection-title").observe("click",(function(T){return function(fl){if(!bQ.get_current_collection().is_creator){return}T.header_rename();return i.log_interaction(en.RENAME_ALBUM,db.CLICK_TITLE)}})(this));$(document.body).on("contextmenu",".albums-list-item",this._albums_list_item_contextmenu.bind(this));$(document.body).on("click",".show-collection-target",this._show_collection_click.bind(this));$(document.body).on("click",".collection-shmodel-target",this._collection_shmodel_click.bind(this));$(document.body).on("click",".add-to-album-target",this._add_to_album_click.bind(this));$(document.body).on("mouseover",".add-to-album-drop-target",this._drop_target_mouseover.bind(this));$(document.body).on("mouseup",".add-to-album-drop-target",this._drop_target_mouseup.bind(this));$(document.body).on("mouseout",".add-to-album-drop-target",this._drop_target_mouseout.bind(this));$(document.body).on("click",".create-album-target",this._create_album_click.bind(this));document.observe(bn.HIDE_EVT,(function(){return $$(".albums-list-item.context-selected").invoke("removeClassName","context-selected")}));Event.observe(window,"scroll",this._window_scroll.bind(this));document.observe(ab.CREATE_EVT,this._collection_created.bind(this));document.observe(ab.ADD_EVT,this._collection_photos_added.bind(this));document.observe(ab.REMOVE_EVT,this._collection_photos_removed.bind(this));document.observe(ab.UNDO_REMOVE_EVT,this._collection_undid_remove.bind(this));document.observe(ab.RENAME_EVT,this._collection_renamed.bind(this));document.observe(ab.DELETE_EVT,this._collection_deleted.bind(this));document.observe(ab.SHARE_EVT,this._collection_shared.bind(this));document.observe(ab.UNSHARE_EVT,this._collection_unshared.bind(this));return document.observe(ab.COVER_CHANGE_EVT,this._collection_cover_changed.bind(this))},render_all_albums_view:function(){var fo,fl,fn,T,fm;if(this._collections.length||!this._all_collections_loaded){$("albums-empty").hide()}else{$("albums-empty").show()}fl=[];fm=this._collections;for(fn=0,T=fm.length;fn<T;fn++){fo=fm[fn];fl.push(this._collection_list_item_tmpl({collection:fo,additional_class:"albums-list-item show-collection-target",Sprite:cv,Emstring:bU}))}$("albums-list").__date(fl);$("albums-list").__sert(new Element("div",{"class":"clearfix"}));if(!this._all_collections_loaded){return $("albums-list").__sert(this.LOADING_SPINNER)}},render_add_to_album_modal:function(){var fp,fl,fm,fo,T,fn;fl=[];fm={name:eA("Create new album"),thumbnail_url_256:"/static/images/new_album_big-vflQJ5xd7.png"};fl.push(this._collection_list_item_tmpl({collection:fm,additional_class:"create-album-target",hide_icons:true,Sprite:cv,Emstring:bU}));fn=this._collections;for(fo=0,T=fn.length;fo<T;fo++){fp=fn[fo];fl.push(this._collection_list_item_tmpl({collection:fp,additional_class:"add-to-album-target",Sprite:cv,Emstring:bU}))}$("add-to-album-modal-list").__date(fl);if(!this._all_collections_loaded&&this._collections.length>0){return $("add-to-album-modal-list").__sert(this.LOADING_SPINNER)}},render_albums_sidebar:function(){var fq,fs,fo,fr,fp,fn,fl,T,fm;if(!this._sidebar_collections_loaded){return}if(!this._collections.length){$("albums-sidebar").hide();$("main-nav-bottom").show();return}$("main-nav-bottom").hide();$("albums-sidebar").show();fs=this._albums_sidebar_tmpl({collections:this._collections.slice(0,5),_:eA,Sprite:cv,PhotosCollections:cG});if((fp=$("albums-sidebar"))!=null){fp.__date(fs)}if((fn=$("all-albums-sidebar"))!=null){fn.observe("click",bQ.show_all_collections)}if((fl=$("all-albums-sidebar"))!=null){fl.observe("mouseup",(function(ft){return function(fu){var fv;if(!eW._drag_drop.active){return}if(eW._drag_drop.single_photo!=null){fv=[eW._drag_drop.single_photo]}else{fv=eW.get()}ft.show_add_to_album_modal(fu,fv);return i.log_interaction(en.ADD_TO_OTHER_ALBUM,db.DROP_TARGET,{num_photos:eW.get().length})}})(this))}if(bQ.in_all_collections_view()){return $("all-albums-sidebar").addClassName("selected")}else{if(bQ.in_single_collection_view()){T=$$(".sidebar-album");fm=[];for(fo=0,fr=T.length;fo<fr;fo++){fq=T[fo];if(fq.readAttribute("data-gid")===bQ.get_current_collection().gid){fq.addClassName("selected");break}else{fm.push(void 0)}}return fm}}},refresh_album_views:function(fl){var T;if(fl==null){fl=null}T=(function(fm){return function(){fm.render_all_albums_view();fm.render_albums_sidebar();return fm.render_add_to_album_modal()}})(this);if(fl!=null?fl.length:void 0){return cC.WebRequest({url:"/collections",data:{collection_gids:JSON.stringify(fl.unique())},subject_user:cK.get_viewer().photos_user,success:(function(fm){return function(fq){var fw,fv,fo,fu,fs,fr,fx,fn,ft,fp;ft=JSON.parse(fq);for(fs=0,fx=ft.length;fs<fx;fs++){fo=ft[fs];fv=new ab(fo,false);fm._gid_to_collection[fv.gid]=fv;fm._url_to_collection[fv.url]=fv;fp=fm._collections;for(fu=fr=0,fn=fp.length;fr<fn;fu=++fr){fw=fp[fu];if(fw.gid===fv.gid){fm._collections[fu]=fv;break}}}return T()}})(this)})}else{return T()}},show_add_to_album_modal:function(T,fl){if(fl!==eW.get()&&(eW._drag_drop.single_photo==null)){eW._context_selected=fl}fc.onHide=function(){eW._context_selected=null;delete fc.onHide;return fc.hide()};fc.show(eA("Choose an album"),$("add-to-album-modal"),false,false,893);return this.load_collections(null)},add_photos:function(fm,fo,fl){var T,fn;if(fl==null){fl=true}fn=bQ.get_current_collection_gid();T=fo.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;ae.success(eA("Adding to album..."));return fm.add_photos(fo,fn,T,fl)},show_remove_photos_modal:function(fn,fp){var fm,T,fo,fl;fl=c8.categorize_files(fp),T=fl[0],fo=fl[1];if(T&&fo){fm=bc("Remove %(file_count)s item?","Remove %(file_count)s items?",fp.length)}else{if(T){fm=bc("Remove %(file_count)s photo?","Remove %(file_count)s photos?",fp.length)}else{fm=bc("Remove %(file_count)s video?","Remove %(file_count)s videos?",fp.length)}}fm=fm.format({file_count:fp.length});ds.fillVal(c8.file_desc(fp),"collection-remove-files");ds.fillVal(fn.name.escapeHTML(),"collection-remove-name");return fc.show(fm,ds.fromElm("collection-remove-modal"),{action:(function(fq){return function(){var fr;fp=fp.slice(0);fr=fp.length>fq.NUM_PHOTOS_LONG_RUNNING_REMOVES;return fn.remove_photos(fp,fr)}})(this)})},header_rename:function(){if(bE("#single-collection-title-container").hasClass("editing")){return}bE("#single-collection-title-container").addClass("editing");return bQ.get_current_collection().rename($("single-collection-title"))},show_delete_modal:function(fl){var T;ds.fillVal(fl.name.escapeHTML(),"collection-delete-name");T=eA("Delete album?");return fc.show(T,ds.fromElm("collection-delete-modal"),{action:function(){if(fl.num_items>this.NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES){ae.success(eA("Deleting '%(collection_name)s'...").format({collection_name:fl.name}),100)}return fl["delete"]()}})},show_unshare_modal:function(fl){var T;ds.fillVal(fl.name.escapeHTML(),"collection-unshare-name");T=eA("Unshare album?");return fc.show(T,ds.fromElm("collection-unshare-modal"),{action:function(){return fl.unshare()}})},create:function(fs,fr,fw,fl){var fn,fo,fm,fp,fu,fv,ft,T,fq;if(fl==null){fl=false}if(fs){Event.extend(fs).preventDefault();fq=$(fs.target);if(fq.hasClassName("inplaceeditor-form")||(fq.up(".inplaceeditor-form")!=null)){return}if(fq.up("#context-menu")){fn=true}else{if(fq.up(".freshdropdown-menu")){fm=true}}}bQ.enable_selection();if(!fw){fw=eW.get()}fp=(function(){var fz,fy,fx;fx=[];for(fz=0,fy=fw.length;fz<fy;fz++){T=fw[fz];fx.push(T.item_counter)}return fx})();fw.sort_by_key(function(fx){return fx.time_taken});fu=fw.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;ft=(function(fx){return function(fz){var fC,fA,fy,fB;fA=JSON.parse(fz.responseText);fC=new ab(fA);eW.clear();eU.hide_all();bn.hide();fc.hide();bQ.disable_selection();fB=eA("Created '%(collection_name)s'");fy=fC.name.escapeHTML();fB=fB.format({collection_name:"<a data-gid='"+fC.gid+"' class='show-collection-target'>"+fy+"</a>"});ae.success(new fg(fB));return fx.flash_sidebar_album(fC.gid)}})(this);fv=function(){if(!fm){eU.hide_all()}if(!fn){bn.hide()}cG.render_albums_sidebar();return bQ.disable_selection()};fo=new Ajax.InPlaceEditor(fr,"/collection_create",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:fl,initialText:"",cancelIfSame:true,clickToEdit:false,onCancel:fv,onFailure:function(){},savingText:eA("Creating..."),onLeaveEditMode:bQ.disable_selection(),onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:ft,job:fu,job_user:cK.get_viewer().photos_user,progress_text:eA("Creating album...")},callback:function(fx,fz){var fy;ae.success(eA("Creating album..."));fy={collection_name:fz,item_counters:JSON.stringify(fp),source_collection_gid:bQ.get_current_collection_gid()};return fy}});fo.enterEditMode();if(!fl){return fo._controls.editor.observe("blur",fv)}},toggle_more_selected_actions:function(T){if(T){Event.extend(T).preventDefault()}if(!$("more-selected-actions-menu").visible()){return eU.show($("more-selected-actions-menu"),$("more-selected-actions-button"))}},toggle_more_actions:function(T){var fl;if(T){Event.extend(T).preventDefault()}if(!$("more-collection-actions-menu").visible()){if(bQ.get_current_collection().share_tkey!=null){$("unshare-album").show()}else{$("unshare-album").hide()}if(b1.msie_version_at_most(10)){fl=bE("#more-collection-actions-menu");if(!fl.parent().is("body")){bE(document.body).append(fl.remove())}}return eU.show($("more-collection-actions-menu"),$("more-collection-actions-button"))}},_collection_created:function(T){var fl;fl=T.memo.collection;if(!fl.is_anonymous){this._collections.unshift(fl)}this._gid_to_collection[fl.gid]=fl;this._url_to_collection[fl.url]=fl;return this.refresh_album_views()},_collection_changed:function(T){this._collections.removeItem(T);this._collections.unshift(T);return this.refresh_album_views()},_collection_photos_added:function(fr){var fq,fo,fn,fs,ft,fm,T,fl,fu,fp;fq=fr.memo.collection;fu=fr.memo.photos;fs=fr.memo.num_items_added;fm=fr.memo.num_photos_added;fl=fr.memo.num_videos_added;if(fr.memo.promote_collection&&fs>0){this._collection_changed(fq)}else{this.refresh_album_views()}if(fu===eW.get()){eW.clear()}if(fs<1){fp=c8.categorize_files(fu),ft=fp[0],T=fp[1];if(ft&&T){fn=bc("That item is already in '%(collection_name)s'","Those items are already in '%(collection_name)s'",fu.length)}else{if(ft){fn=bc("That photo is already in '%(collection_name)s'","Those photos are already in '%(collection_name)s'",fu.length)}else{fn=bc("That video is already in '%(collection_name)s'","Those videos are already in '%(collection_name)s'",fu.length)}}}else{if(fm&&fl){fn=bc("Added item to '%(collection_name)s'","Added items to '%(collection_name)s'",fu.length)}else{if(fm){fn=bc("Added photo to '%(collection_name)s'","Added photos to '%(collection_name)s'",fu.length)}else{fn=bc("Added video to '%(collection_name)s'","Added videos to '%(collection_name)s'",fu.length)}}}fo=fq.name.escapeHTML();fn=fn.format({collection_name:"<a data-gid='"+fq.gid+"' class='show-collection-target'>"+fo+"</a>"});return ae.success(new fg(fn))},_collection_photos_removed:function(fl){var fm,fn,T;fm=fl.memo.collection;fn=fl.memo.photos;T=bQ.undo_enabled?fl.memo.undo_changeset:null;bQ.get_timeline().remove_photos(fn);this._collection_changed(fm);return ae.success(eA("Removed %(files_desc)s from '%(collection_name)s'").format({files_desc:c8.file_desc(fn),collection_name:fm.name}),null,null,T,(function(){return fm.undo_remove(T)}))},_collection_undid_remove:function(T){var fl;fl=T.memo.collection;bQ.get_timeline().restore_removed_photos();cG.refresh_album_views([fl.gid]);return ae.success(eA("Undo complete"))},_collection_renamed:function(fl){var fm,T;fm=fl.memo.collection;if(((T=bQ.get_current_collection())!=null?T.gid:void 0)===fm.gid){bE("#single-collection-title").text(bU.em_snippet(fm.name,this.HEADER_COLLECTION_SNIPPET_LENGTH,1));document.title=""+fm.name+" - Dropbox"}this._collection_changed(fm);return ae.success(eA("Renamed '%(collection_name)s'").format({collection_name:fm.name}))},_collection_deleted:function(fl){var fm,T;fm=fl.memo.collection;this._collections.removeItem(fm);if(!this._all_collections_loaded){this._removed_pre_load.push(fm.gid)}this.refresh_album_views();if(((T=bQ.get_current_collection())!=null?T.gid:void 0)===fm.gid){bQ.show_all_collections()}delete this._gid_to_collection[fm.gid];delete this._url_to_collection[fm.url];return ae.success(eA("Deleted '%(collection_name)s'").format({collection_name:fm.name}))},_collection_shared:function(fl){var fm,T;fm=fl.memo.collection;this._collection_changed(fm);if(((T=bQ.get_current_collection())!=null?T.gid:void 0)===fm.gid){bE("#single-collection-share-status").text(eA("Shared"));return bE("#single-collection-share-status").attr("href",fm.shmodel_url)}},_collection_unshared:function(fl){var fm,T;fm=fl.memo.collection;if(((T=bQ.get_current_collection())!=null?T.gid:void 0)===fm.gid){bE("#single-collection-share-status").text("")}return ae.success(eA("Unshared '%(collection_name)s'").format({collection_name:fm.name}))},_collection_cover_changed:function(T){var fm,fl;fm=T.memo.collection;this._collection_changed(fm);fl=eA("Changed cover photo for '%(collection_name)s'");fl=fl.format({collection_name:fm.name.escapeHTML()});return ae.success(fl)},_albums_list_item_contextmenu:function(fl,T){bn.show_photo_collection(fl,this.get(T.readAttribute("data-gid")),T);T.removeClassName("album-flash");return T.addClassName("context-selected")},_show_collection_click:function(fm,T){var fl;fl=$(fm.target);if(fl.hasClassName("inplaceeditor-form")||(fl.up(".inplaceeditor-form")!=null)){return}return bQ.show_collection(T.readAttribute("data-gid"))},_collection_shmodel_click:function(fl,T){return this.go_to_link(this.get(T.readAttribute("data-gid")))},_add_to_album_click:function(fl,T){if(eW._context_selected){this.add_photos(this.get(T.readAttribute("data-gid")),eW._context_selected);eW._context_selected=null}else{this.add_photos(this.get(T.readAttribute("data-gid")),eW.get())}delete fc.onHide;fc.hide();return i.log_interaction(en.ADD_TO_RECENT_ALBUM,db.SAH,{num_photos:eW.get().length})},_drop_target_mouseover:function(fl,T){if(eW._drag_drop.active){T.addClassName("hovered");return $("photos-drag-status").addClassName("hovering")}},_drop_target_mouseout:function(fl,T){if(eW._drag_drop.active){T.removeClassName("hovered");return $("photos-drag-status").removeClassName("hovering")}},_drop_target_mouseup:function(fl,T){var fm;if(T.hasClassName("hovered")){T.removeClassName("hovered");$("photos-drag-status").removeClassName("hovering");if(eW._drag_drop.single_photo!=null){fm=[eW._drag_drop.single_photo]}else{fm=eW.get()}if(T.readAttribute("data-gid")!=null){this.add_photos(this.get(T.readAttribute("data-gid")),fm,false)}if(T.identify()==="add-to-album-sidebar-new"){return i.log_interaction(en.ADD_TO_NEW_ALBUM,db.DROP_TARGET,{num_photos:eW.get().length})}else{if(T.identify()==="all-albums-sidebar"){return i.log_interaction(en.ADD_TO_OTHER_ALBUM,db.DROP_TARGET,{num_photos:eW.get().length})}else{return i.log_interaction(en.ADD_TO_RECENT_ALBUM,db.DROP_TARGET,{num_photos:eW.get().length})}}}},_create_album_click:function(T,fl){if(eW._context_selected){this.create(T,fl.down(".collection-name"),eW._context_selected,true);return eW._context_selected=null}else{return this.create(T,fl.down(".collection-name"),eW.get(),true)}},_window_scroll:function(){if(bQ.in_all_collections_view()){return this._all_albums_scroll_position=B.scroll_offsets().top}},get_all:function(){return this._collections},get_from_url:function(T){return this._url_to_collection[T]},get:function(T){return this._gid_to_collection[T]},go_to_link:function(T){return window.open(T.shmodel_url,"_blank")},restore_all_albums_scroll_position:function(){if(this._all_albums_scroll_position!=null){return window.scrollTo(0,this._all_albums_scroll_position)}else{return window.scrollTo(0,0)}},two_line_snippet:function(fm,fl){var T,fo,fn;T=bU.em_snippet(fm,fl,1);fo=T.lastIndexOf(" ");if(fo===-1){return T}else{T=T.slice(0,+fo+1||9000000000);fn=bU.em_snippet(fm.slice(fo+1),fl,1);return T+fn}},get_default_album_name:function(){var T;T=eA("Untitled album");return this.increment_collection_name_until_valid(T)},collection_name_in_use:function(fl){var fo,fn,T,fm;fm=this.get_all();for(fn=0,T=fm.length;fn<T;fn++){fo=fm[fn];if(fo.name===fl.trim()){return true}}return false},increment_collection_name_until_valid:function(fl){var fm,T;fm=this.collection_name_in_use(fl);T=0;while(fm){T++;fm=this.collection_name_in_use(fl+(" ("+T+")"))}return(T===0?fl:fl+(" ("+T+")"))},flash_sidebar_album:function(fo){var fp,fn,fl,fm,T;fm=$$(".sidebar-album");T=[];for(fn=0,fl=fm.length;fn<fl;fn++){fp=fm[fn];if(fp.readAttribute("data-gid")===fo){fp.removeClassName("album-flash");fp.addClassName("album-flash");break}else{T.push(void 0)}}return T}};var ci;ci=D.PhotoTimeline=(function(){T.PHOTOS_ADDED_EVT="db:phototimeline:photos_added";T.PHOTOS_REMOVED_EVT="db:phototimeline:photos_removed";T.prototype.THUMB_SIZE=null;T.prototype.HEADER_HEIGHT=null;T.prototype.THUMBS_PER_ROW=4;T.prototype.RENDER_SCROLL_WAIT=100;T.prototype.RENDER_SCROLL_MAX_WAIT=750;T.prototype.HIDE_TIMELINE_NAV_DELAY=1500;T.prototype.THUMBS_BATCH_SIZE=12;T.prototype.VIEWPORT_SCALE_SCROLL_DIRECTION=4;T.prototype.VIEWPORT_SCALE_OTHER_DIRECTION=1;T.prototype.TIMELINE_NAV_MOUSE_THRESHOLD=100;T.prototype.TIMELINE_NAV_ELM_HEIGHT=20;T.prototype.TIMELINE_DOT_HTML=cv.html("web","timeline_dot");T.container;T.scroll_container;T.events;T.current_event;T.key_to_photo;T.preview_objs;T.tmpl;T.last_render_scroll_timeout;T.start_render_scroll_time;T.last_scroll_position;T.hide_timeline_nav_timeout;T.grid;T._skip_scroll_update;T.header_id_to_sel_items;T.event_remove_info;T.opts;function T(fm,fn,fq,fo,fp,fr,fs,ft,fl){this.container=fm;this.scroll_container=fn;this.tmpl=fs;this.opts=fl;this.THUMB_SIZE=ft.thumb_size;this.HEADER_HEIGHT=ft.header_height;this.key_to_photo={};this.preview_objs=[];this.start_render_scroll_time=-1;this.grid={};this._skip_scroll_update=false;this.header_id_to_sel_items=fr;this.event_remove_info=[];this._init_events(fq,fo,fp);this.update_offsets(ft.top_offset,ft.left_offset);this.listen();dy.start_capture(this.scroll_container)}T.prototype._init_events=function(ft,fn,fp){var fm,fr,fw,fo,fq,fu,fl,fs,fv;if(ft.length<1){this.events=new aZ([],{});return}fr=[];fq={};fw=false;for(fs=0,fv=ft.length;fs<fv;fs++){fo=ft[fs];fo=String(fo);fl=fo in this.header_id_to_sel_items?this.header_id_to_sel_items[fo]:[];fu=false;if(fl.length&&!fw){fw=true;fu=true}fm=new dc(this,fo,fn[fo],fp[fo],fl,fu);fr.push(fo);fq[fo]=fm}return this.events=new aZ(fr,fq)};T.prototype.listen=function(){this._bound_window_scroll=this._window_scroll.bind(this);this._bound_window_resize=this._window_resize.bind(this);this._body_mousemove_handler=$(document.body).on("mousemove",this._body_mousemove.bind(this));this._timeline_elm_click_handler=$(document.body).on("click",".timeline-elm",this._timeline_elm_click.bind(this));this._show_missing_timestamp_bucket_handler=$(document.body).on("click","#show-missing-timestamps-button",this._show_missing_timestamp_bucket.curry(true,false).bind(this));if(this.scroll_container!=null){this.scroll_container.observe("scroll",this._bound_window_scroll)}else{Event.observe(window,"scroll",this._bound_window_scroll)}Event.observe(window,"resize",this._bound_window_resize);return $(document).observe(dc.EVENT_MISCOUNT_EVT,this._event_miscount.bind(this))};T.prototype.unlisten=function(){var fm,fl,fn;if((fm=this._body_mousemove_handler)!=null){fm.stop()}if((fl=this._timeline_elm_click_handler)!=null){fl.stop()}if((fn=this._show_missing_timestamp_bucket_handler)!=null){fn.stop()}if(this.scroll_container!=null){this.scroll_container.stopObserving("scroll",this._bound_window_scroll)}else{Event.stopObserving(window,"scroll",this._bound_window_scroll)}Event.stopObserving(window,"resize",this._bound_window_resize);return $(document).stopObserving(dc.EVENT_MISCOUNT_EVT)};T.prototype.render=function(){this._render_empty_grid();this.init_timeline_nav();this._load_metadata_for_sel_events();return this._render_viewport()};T.prototype.update_offsets=function(fn,fm){var fo,fq,fp,fl;cJ(this.THUMBS_PER_ROW>0,"Invalid THUMBS_PER_ROW: "+this.THUMBS_PER_ROW);this.top_offset=fn;this.refresh_row_offsets();this.left_offset=fm;this.grid.photo_col_offsets=[];fl=[];for(fo=fq=0,fp=this.THUMBS_PER_ROW;0<=fp?fq<=fp:fq>=fp;fo=0<=fp?++fq:--fq){fl.push(this.grid.photo_col_offsets.push(this.left_offset+this.THUMB_SIZE*fo))}return fl};T.prototype.refresh_row_offsets=function(){var fs,fp,fn,fr,fo,fm,fq,fl;this.grid.photo_row_offsets=[];fs=this.top_offset;fq=this.events.getValues();for(fr=0,fm=fq.length;fr<fm;fr++){fp=fq[fr];fp.top_offset=fs;fs+=this.HEADER_HEIGHT;this.grid.photo_row_offsets.push(fs);for(fn=fo=0,fl=fp.get_num_rows();0<=fl?fo<fl:fo>fl;fn=0<=fl?++fo:--fo){fs+=this.THUMB_SIZE;this.grid.photo_row_offsets.push(fs)}}};T.prototype._render_empty_grid=function(){var fm,fp,fo,fl,fn;this.container.__date();fn=this.events.getValues();for(fo=0,fl=fn.length;fo<fl;fo++){fm=fn[fo];if(!(fm.is_missing_timestamp_bucket()&&this.events.length()>1)){fm.add_html_elements_to(this.container)}}if(this.has_missing_timestamp_bucket()&&this.events.length()>1){fp=bE('<div id="show-missing-timestamps-button"/>').addClass("freshbutton-silver").text(eA("Show photos with missing dates"));return bE(this.container).append(fp)}};T.prototype._render_viewport=function(fo){var fm,fx,fp,fw,fz,fu,ft,fr,fy,fn,fl,fv,fs,fq;if(fo==null){fo=false}this.start_render_scroll_time=-1;fz=this.get_viewport_info();fx=[];fv=this.events.getValues();for(fu=0,fy=fv.length;fu<fy;fu++){fm=fv[fu];if(!(fm.has_loaded_metadata()||fm.loading_metadata||(fm.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown()))){if(fm.in_current_viewport(fz,false)){fx.unshift(fm)}else{if(fm.in_current_viewport(fz,true)){fx.push(fm)}}}}for(ft=0,fn=fx.length;ft<fn;ft++){fm=fx[ft];fs=fm.get_photo_range_to_render(fz,true),fp=fs[0],fw=fs[1];fm.load_metadata_range(fp,fw)}if(fo){fz=this.get_viewport_info();fq=this.events.getValues();for(fr=0,fl=fq.length;fr<fl;fr++){fm=fq[fr];if(fm.in_current_viewport(fz,false)){fm.timing_stopped_scrolling_on_event=b4.time()-this.RENDER_SCROLL_WAIT}}}return this._load_visible_photos()};T.prototype._load_metadata_for_sel_events=function(){var fn,fp,fl,fo,fm;if("a_missing_timestamps" in this.header_id_to_sel_items){this._show_missing_timestamp_bucket(false,false)}fo=this.header_id_to_sel_items;fm=[];for(fp in fo){fl=fo[fp];fn=this.events.valueFromKey(fp);if(fn!=null){fn.load_metadata()}fm.push(cJ(fn!=null,"Missing "+fp+" in list of events with selected photos"))}return fm};T.prototype._load_visible_photos=function(){var fn,fp,fm,fo,fl;fo=this.events.getValues();fl=[];for(fp=0,fm=fo.length;fp<fm;fp++){fn=fo[fp];if(!(fn.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){fl.push(fn.update_photo_divs())}else{fl.push(void 0)}}return fl};T.prototype._body_mousemove=function(fl){if(!this.opts.uses_timeline_nav){return}if((fl.clientX+B.scroll_offsets().left)>=($(document.body).getWidth()-this.TIMELINE_NAV_MOUSE_THRESHOLD)){return $("timeline-nav").addClassName("mouse-active")}else{return $("timeline-nav").removeClassName("mouse-active")}};T.prototype._timeline_elm_click=function(fo,fn){var fl,fm;fm=fn.readAttribute("data-event-id");if(fm){fl=this.events.valueFromKey(fm)}this._update_timeline_position(fl);if(fl.is_missing_timestamp_bucket()){i.log_interaction(cl.MISSING_TIMESTAMPS_VIEW);if(!this.is_missing_timestamp_bucket_shown()){this._show_missing_timestamp_bucket(false)}}return this._scroll_to_event(fl)};T.prototype._scroll_to_event=function(fn,fl){var fm;if(fl==null){fl=false}fm=fn.top_offset-this.top_offset;if(fn&&(B.scroll_offsets().top!==fm)){if(fl){return bE("html, body").animate({scrollTop:fm},200)}else{this._skip_scroll_update=true;return window.scrollTo(B.scroll_offsets().left,fm)}}};T.prototype._window_scroll=function(){var fo,fn,fr,fq,fm,fp,fl;fn=b4.time();bs.clear_all_pending_batches();if(this.start_render_scroll_time===-1||fn-this.start_render_scroll_time<this.RENDER_SCROLL_MAX_WAIT){clearTimeout(this.last_render_scroll_timeout)}if(this.start_render_scroll_time===-1){this.start_render_scroll_time=fn}fr=this.visible_thumbs_loaded()?0:this.RENDER_SCROLL_WAIT;this.last_render_scroll_timeout=setTimeout(this._render_viewport.curry(true).bind(this),fr);if(this.opts.uses_timeline_nav){this._update_timeline_position();$("timeline-nav").addClassName("scroll-active");clearTimeout(this.hide_timeline_nav_timeout);this.hide_timeline_nav_timeout=setTimeout(((function(fs){return function(){return $("timeline-nav").removeClassName("scroll-active")}})(this)),this.HIDE_TIMELINE_NAV_DELAY)}this.last_scroll_position=B.scroll_offsets().top;bQ.scroll_count++;fp=this.events.getValues();fl=[];for(fq=0,fm=fp.length;fq<fm;fq++){fo=fp[fq];fl.push(fo.logged_thumbs_arrived=false)}return fl};T.prototype._window_resize=function(){this._resize_timeline_nav();return this._show_hide_timeline_elms()};T.prototype.init_timeline_nav=function(){var fm,fo,fl,fn;if(!this.opts.uses_timeline_nav){return}this.grid.side_nav={};this.current_event=null;this._resize_timeline_nav();fn=this.events.getValues().reverse();for(fo=0,fl=fn.length;fo<fl;fo++){fm=fn[fo];fm.add_to_timeline_nav(fm===this.events.getValues()[0])}this._update_timeline_position();return this._show_hide_timeline_elms()};T.prototype._resize_timeline_nav=function(){var fl;if(!this.opts.uses_timeline_nav){return}fl=this.get_viewport_info().height-this.TIMELINE_NAV_ELM_HEIGHT;return $("timeline-nav").setStyle({height:fl+"px"})};T.prototype._update_timeline_position=function(fr){var fv,fs,fl,fu,fp,fo,ft,fm,fq,fn;if(!this.opts.uses_timeline_nav){return}if(this._skip_scroll_update){this._skip_scroll_update=false;return}if(fr==null){fu=this.get_viewport_info();if(this.scroll_container==null){fu.top=document.viewport.getScrollOffsets().top}fv=fu.top+fu.height/2;fq=this.events.getValues();for(fp=0,ft=fq.length;fp<ft;fp++){fl=fq[fp];if(fl.top_offset>fv){break}fr=fl}}if((fr==null)||fr===this.current_event){return}$$(".timeline-elm.current").invoke("removeClassName","current");fn=$$(".timeline-elm");for(fo=0,fm=fn.length;fo<fm;fo++){fs=fn[fo];if(fs.readAttribute("data-event-id")===fr.unique_id){fs.addClassName("current");break}}return this.current_event=fr};T.prototype._show_hide_timeline_elms=function(){var fs,fp,fn,fo,fr,fm,fq,fl;if(!this.opts.uses_timeline_nav){return}fn=$("cu-header").cumulativeOffset().left+$("cu-header").getWidth();fp=$("cu-header").cumulativeOffset().top+$("cu-header").getHeight();fq=$$(".timeline-elm");fl=[];for(fr=0,fm=fq.length;fr<fm;fr++){fs=fq[fr];fs.show();fo=fs.cumulativeOffset();if(fo.top<fp&&fo.left<fn){fl.push(fs.hide())}else{fl.push(void 0)}}return fl};T.prototype._event_miscount=function(fl){this.refresh_row_offsets();return this._load_visible_photos()};T.prototype.remove_photos=function(fs){var fo,fq,fr,fn,fm,fp,fl;fs=fs.slice(0);this.event_remove_info=[];fr={};for(fp=0,fl=fs.length;fp<fl;fp++){fn=fs[fp];fq=fn.event.unique_id;if(fq in fr){fr[fq].push(fn)}else{fr[fq]=[fn]}}for(fq in fr){fs=fr[fq];fo=this.events.valueFromKey(fq);fm=fo.remove_photos(fs);this.event_remove_info.push({event:fo,remove_info:fm})}this.init_timeline_nav();this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(T.PHOTOS_REMOVED_EVT,this)};T.prototype.restore_removed_photos=function(){var fm,fA,fw,fz,fx,fo,fv,ft,fs,fq,fy,fn,fl,fu,fr,fp;eW.clear();fu=this.event_remove_info.reverse();for(ft=0,fy=fu.length;ft<fy;ft++){fA=fu[ft];fm=fA.event;fx=fA.remove_info;if(fx.removed_event_index!=null){this.events.insertAtIndex(fx.removed_event_index,fm.unique_id,fm);fm.restore()}fm.add_photos(fx.removed_photos_and_indexes.reverse());fr=fx.removed_photos_and_indexes;for(fs=0,fn=fr.length;fs<fn;fs++){fz=fr[fs];eW._add(fz.photo)}}fo=null;fv=null;fp=this.event_remove_info;for(fq=0,fl=fp.length;fq<fl;fq++){fA=fp[fq];fm=fA.event;fx=fA.remove_info;fw=this.events.indexOfKey(fm.unique_id);if((fo==null)||fo>fw){fo=fw;fv=fx.removed_photos_and_indexes[0].photo}}this.event_remove_info=[];this.init_timeline_nav();if(fv!=null){this.scroll_to_photo_with_key(fv.uniqueness_key)}this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(T.PHOTOS_ADDED_EVT,this)};T.prototype.get_photos=function(){var fm,fp,fo,fl,fn;fp=[];fn=this.events.getValues();for(fo=0,fl=fn.length;fo<fl;fo++){fm=fn[fo];fp=fp.concat(fm.photos)}return fp};T.prototype.num_photos=function(){var fn,fm,fp,fl,fo;fm=0;fo=this.events.getValues();for(fp=0,fl=fo.length;fp<fl;fp++){fn=fo[fp];fm+=fn.photos.length}return fm};T.prototype.get_preview_objs=function(){var fl,fm,fs,fq,fp,ft,fn,fr,fo;fs=[];fr=this.events.getValues();for(fq=0,ft=fr.length;fq<ft;fq++){fl=fr[fq];fo=fl.photos;for(fp=0,fn=fo.length;fp<fn;fp++){fm=fo[fp];fs.push(fm.preview_obj)}}return fs};T.prototype.index_of_photo=function(fn){var fo,fm,fq,fl,fp;fm=0;fp=this.events.getValues();for(fq=0,fl=fp.length;fq<fl;fq++){fo=fp[fq];if(fo===fn.event){fm+=fo.photos.indexOf(fn);break}else{fm+=fo.photos.length}}return fm};T.prototype.photo_at_index=function(fn){var fl,fo,fq,fm,fp;fl=0;fp=this.events.getValues();for(fq=0,fm=fp.length;fq<fm;fq++){fo=fp[fq];if(fl+fo.photos.length>fn){return fo.photos[fn-fl]}else{fl+=fo.photos.length}}return null};T.prototype.get_thumb_elm_for_photo=function(fl){return $(fl.uniqueness_key)};T.prototype.get_photo_for_thumb_elm=function(fl){if(!fl.hasClassName("cu-thumb")){fl=fl.up(".cu-thumb")}if(fl){return this.key_to_photo[fl.identify()]}else{return null}};T.prototype.get_viewport_info=function(){var fl,fm;if(this.scroll_container!=null){fm=this.scroll_container.scrollTop;fl=this.scroll_container.getHeight()}else{fm=B.scroll_offsets().top;fl=B.viewport_dimensions().height}return{top:fm,height:fl,bottom:fm+fl}};T.prototype.scroll_to_photo_with_key=function(fm){var fq,fn,fl,fp,fo;B.scroll_unlock_document();fq=$(fm);if(fq!=null?fq.visible():void 0){d5.scroll_to_thumb(fq)}else{fl=this.key_to_photo[fm];fn=fl.event;if(fl.event!=null){fp=Math.floor(fn.photos.indexOf(fl)/this.THUMBS_PER_ROW);fo=this.get_viewport_info().height;B.scroll_to(0,fn.top_offset+this.HEADER_HEIGHT+fp*this.THUMB_SIZE-fo/2)}}return this._load_visible_photos()};T.prototype.restore_scroll_position=function(){B.scroll_unlock_document();if(this.last_scroll_position!=null){window.scrollTo(0,this.last_scroll_position)}else{window.scrollTo(0,0)}if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return this._load_visible_photos()}};T.prototype.visible_thumbs_loaded=function(){var fm,fo,fl,fn;fn=this.events.getValues();for(fo=0,fl=fn.length;fo<fl;fo++){fm=fn[fo];if(!fm.visible_thumbs_loaded()){return false}}return true};T.prototype.has_missing_timestamp_bucket=function(){var fl;fl=this.events.getValues();return fl[fl.length-1].is_missing_timestamp_bucket()};T.prototype.is_missing_timestamp_bucket_shown=function(){var fl,fm;if(!this.has_missing_timestamp_bucket()){return false}fl=this.events.getValues();fm=fl[fl.length-1].unique_id;return bE("#p-"+fm).length>0};T.prototype._show_missing_timestamp_bucket=function(fl,fo){var fn,fm;if(fl==null){fl=true}if(fo==null){fo=false}if(!(this.has_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){return}fm=this.events.getValues();fn=fm[fm.length-1];bE("#show-missing-timestamps-button").hide();fn.add_html_elements_to(this.container);if(!fo){if(this.opts.uses_timeline_nav){$("timeline-nav").addClassName("mouse-active")}this._scroll_to_event(fn,fl);this._render_viewport()}return this.init_timeline_nav()};return T})();var dc;dc=D.PhotoEvent=(function(){T.EVENT_MISCOUNT_EVT="db:photoevent:miscount";T.PHOTOS_LOADED_EVT="db:photoevent:photos_loaded";T.prototype.MONTH_PREFIX="m_";T.prototype.COLLECTION_PREFIX="c_";T.prototype.EVENT_PREFIX="e_";T.prototype.MISSING_TIMESTAMP_PREFIX="a_";T.prototype.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD=5;T.prototype.MAX_PHOTOS_PER_METADATA_REQUEST=500;T.timeline;T.unique_id;T.name;T.init_num_photos;T.photos;T.header_html;T.placeholder_html;T.top_offset;T.loading_metadata;T.cursor;T.num_photos_loaded;T.prototype.LOADING_ORDER_NOT_DECIDED=-1;T.prototype.LOADING_ORDER_TOP_DOWN=0;T.prototype.LOADING_ORDER_BOTTOM_UP=1;T.loading_order;T.num_photos_to_load;T.on_load_all_metadata;T.init_sel_items;T.scroll_to_first_sel;T.num_to_select;T.logged_thumbs_arrived;T.timing_metadata_received;T.timing_stopped_scrolling_on_event;T.scroll_count;function T(ft,fq,fm,fr,fl,fp){var fo,fu,fn,fs;this.timeline=ft;this.unique_id=fq;this.name=fm;this.init_num_photos=fr;this.photos=(function(){var fw,fv;fv=[];for(fo=fw=0;0<=fr?fw<fr:fw>fr;fo=0<=fr?++fw:--fw){fv.push(new J(this))}return fv}).call(this);this.init_sel_items={};for(fn=0,fs=fl.length;fn<fs;fn++){fu=fl[fn];this.init_sel_items[fu]=true}this.num_to_select=fl.length;this.scroll_to_first_sel=fp;this._generate_container_html();this.timing_metadata_received=-1;this.timing_stopped_scrolling_on_event=-1;this.num_photos_loaded=0;this.loading_order=this.LOADING_ORDER_NOT_DECIDED;this.num_photos_to_load=0;this.loading_metadata=false;if(fr===0){$("single-album-empty").show()}}T.prototype.is_month=function(){return this.unique_id.slice(0,2)===this.MONTH_PREFIX};T.prototype.is_missing_timestamp_bucket=function(){return this.unique_id.slice(0,2)===this.MISSING_TIMESTAMP_PREFIX};T.prototype.get_month=function(){var fl;cJ(this.is_month(),"this must be a month event");fl=parseInt(this.unique_id.slice(6,8),10);cJ(!isNaN(fl),"Month was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return fl};T.prototype.get_year=function(){var fl;cJ(this.is_month(),"this must be a month event");fl=parseInt(this.unique_id.slice(2,6),10);cJ(!isNaN(fl),"Year was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return fl};T.prototype.is_collection=function(){return this.unique_id.slice(0,2)===this.COLLECTION_PREFIX};T.prototype.get_collection_gid=function(){cJ(this.is_collection(),"this must be a collection event");return this.unique_id.slice(2)};T.prototype.is_event=function(){return this.unique_id.slice(0,2)===this.EVENT_PREFIX};T.prototype._generate_container_html=function(){var fo,fm,fp,fr,fn,fl,fq;fr=this.name;if(this.is_event()){this.header_html=new Element("h1",{id:"h-"+this.unique_id,"class":"cu-month-header"});this.header_html.__sert(fr);fo=new Element("div",{"class":"event-button event-add-to-album title_bubble","data-title":"Add to album"});fo.__date(cv.html("web","event_add_to_album"));this.header_html.__sert(fo);fq=new Element("div",{"class":"event-button event-share title_bubble","data-title":"Share"});fq.__date(cv.html("web","event_share"));this.header_html.__sert(fq);fl=new Element("div",{"class":"event-button event-select title_bubble","data-title":"Select all"});fl.__date(cv.html("web","event_select"));this.header_html.__sert(fl)}else{this.header_html=new fg("<h1 class='cu-month-header' id='h-"+this.unique_id+"'><span>"+fr+"</span></h1>")}fm=this.get_content_height();fn=this.photos.length%this.timeline.THUMBS_PER_ROW;fp=fn===0?0:(this.timeline.THUMBS_PER_ROW-fn)*this.timeline.THUMB_SIZE;return this.placeholder_html=new fg('<div style="height: '+fm+'px;" id="p-'+this.unique_id+'" class="content-placeholder-container">\n  <div style="height: '+fm+'px;" id="p-top-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="height: 0px;" id="p-bottom-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="width: '+fp+'px" id="p-cover-'+this.unique_id+'" class="thumb-cover"></div>\n</div>')};T.prototype.add_html_elements_to=function(fm){var fl;if(this.is_event()){fl=new Element("div",{"class":"photo-event"});fl.__sert(this.header_html);fl.__sert(this.placeholder_html);return fm.__sert(fl)}else{fm.__sert(this.header_html);return fm.__sert(this.placeholder_html)}};T.prototype.remove=function(){$("h-"+this.unique_id).hide();$("p-"+this.unique_id).hide();return this.timeline.events.remove(this.unique_id)};T.prototype.restore=function(){$("h-"+this.unique_id).show();return $("p-"+this.unique_id).show()};T.prototype.add_to_timeline_nav=function(fs){var fl,fq,ft,fm,fu,fp,fo,fr,fn;if(fs==null){fs=false}if(!(this.is_month()||this.is_event()||this.is_missing_timestamp_bucket())){return}fn=this.timeline.get_viewport_info().height;fu=this.timeline.TIMELINE_NAV_ELM_HEIGHT;fp=$(document.body).getHeight();fo=this.top_offset/fp*100;if(this.is_event()){fm=this.name}else{if(this.is_missing_timestamp_bucket()){fm=eA("Missing dates")}else{fm=b4.month_abbr_with_year(this.get_month()-1,this.get_year())}}ft=false;for(fr in this.timeline.grid.side_nav){fl=Math.abs(this.timeline.events.valueFromKey(fr).top_offset-this.top_offset);if(fl/fp*fn<fu){ft=true;if(fs){bE("#timeline-nav-"+fr).remove()}}}fq=bE("#timeline-nav-"+this.unique_id);if(!ft||fs){if(fq.length){fq.css("top",""+fo+"%")}else{fq=bE("<div/>");fq.addClass("timeline-elm");fq.attr({"data-event-id":this.unique_id.toString(),id:"timeline-nav-"+this.unique_id});fq.css("top",""+fo+"%");fq.text(fm);bE("#timeline-nav").append(fq)}return this.timeline.grid.side_nav[this.unique_id]=fo}else{if(fq.length){return fq.remove()}}};T.prototype.marquee_highlight=function(fl,fs,fp){var fn,ft,fm,fu,fw,fo,fr,fq,fv;if(this.top_offset>fs||this.top_offset+this.get_height()<fl){return}if(fl<this.top_offset){fs-=this.top_offset;if(fs<this.timeline.HEADER_HEIGHT){return}fo=0;fw=Math.floor((fs-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{if(fs>this.top_offset+this.get_height()){fl-=this.top_offset;fw=Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW);if(fl<this.timeline.HEADER_HEIGHT){fo=0}else{fo=Math.floor((fl-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}else{fl-=this.top_offset;fs-=this.top_offset;if(fl<this.timeline.HEADER_HEIGHT&&fs<this.timeline.HEADER_HEIGHT){return}else{if(fl<this.timeline.HEADER_HEIGHT){fo=0;fw=Math.floor((fs-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{fo=Math.floor((fl-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fw=Math.floor((fs-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}}}for(fu=fr=fo;fo<=fw?fr<=fw:fr>=fw;fu=fo<=fw?++fr:--fr){for(fq=0,fv=fp.length;fq<fv;fq++){fn=fp[fq];ft=this.timeline.THUMBS_PER_ROW*fu+fn;if(ft<this.photos.length){fm=this.photos[ft];if(fm.status!==J.PLACEHOLDER&&!eW.contains(fm)){eW._highlight(fm)}}}}};T.prototype.add_photos=function(fo){var fn,fm,fp,fq,fl;for(fq=0,fl=fo.length;fq<fl;fq++){fp=fo[fq];fm=fp.photo;fn=fp.index;cJ(fn<=this.photos.length,"cannot insert past end of photos array");this.photos.splice(fn,0,fm);if(fm.status>=J.LOADED){fm.status=J.LOADED;this.num_photos_loaded++;this.num_photos_to_load=Math.max(this.num_photos_to_load,this.num_photos_loaded)}}return this._num_photos_changed()};T.prototype.remove_photos=function(ft){var fq,fl,fp,fr,fm,fn,fs,fo;fq=this.timeline.events.indexOfKey(this.unique_id);fm=[];for(fn=0,fs=ft.length;fn<fs;fn++){fl=ft[fn];fp=this.photos.indexOf(fl);cJ(fp>-1,"Photo not found in the photos array!");this.photos.splice(fp,1);if(fl.status>=J.LOADED){this.num_photos_loaded--;if((fo=$(fl.uniqueness_key))!=null){fo.remove()}fl.status=J.LOADED}eW._remove(fl);fm.push({photo:fl,index:fp})}this._num_photos_changed();fr={removed_photos_and_indexes:fm};if(this.photos.length===0){fr.removed_event_index=fq}return fr};T.prototype._num_photos_changed=function(){if(this.photos.length===0){return this.remove()}else{return this._update_placeholder_container()}};T.prototype.update_placeholders=function(){if($("p-"+this.unique_id)!=null){this._update_placeholder_container();$("p-top-"+this.unique_id).setStyle({height:""+(this.get_content_height())+"px"});return $("p-bottom-"+this.unique_id).setStyle({height:"0px"})}else{return this._generate_container_html()}};T.prototype._update_placeholder_container=function(){var fm,fl;$("p-"+this.unique_id).setStyle({height:""+(this.get_content_height())+"px"});fl=this.photos.length%this.timeline.THUMBS_PER_ROW;fm=fl!==0?(this.timeline.THUMBS_PER_ROW-fl)*this.timeline.THUMB_SIZE:0;return $("p-cover-"+this.unique_id).setStyle({width:""+fm+"px"})};T.prototype.load_metadata=function(fs){var fn,fm,fr,fl,fp,fq,fo;fl=0;if((!this._is_valid_photo_index(fs))||(this.num_to_select>0)){if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=this.LOADING_ORDER_TOP_DOWN}fl=this.photos.length}else{if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=fs*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}fl=this._is_loading_from_bottom()?this.photos.length-fs:fs+1}this.num_photos_to_load=Math.max(this.num_photos_to_load,fl);if(this.has_loaded_metadata()||(this.num_photos_loaded>=this.num_photos_to_load)){return}if(this.loading_metadata){return}if(this.load_cached_metadata()){return}this.loading_metadata=true;fp={show_hidden:bQ.show_hidden};if(this.cursor!=null){fp.cursor=this.cursor}if(this._is_loading_from_bottom()){fp.chron_order=true}fp.limit=Math.max(this.num_photos_to_load-this.num_photos_loaded,0);if(fp.limit>this.MAX_PHOTOS_PER_METADATA_REQUEST){fp.limit=this.MAX_PHOTOS_PER_METADATA_REQUEST}if(this.is_event()){fq=this.unique_id.split("_");fn=fq[2];fm=fq[1];fp.filters=JSON.stringify({date_begin:fn,date_end:fm},{event_id:this.unique_id})}else{if(this.is_missing_timestamp_bucket()){fp.filters=JSON.stringify({other:true})}else{if(this.is_month()){fo=this.get_year();fr=this.get_month();fn=d5.to_iso8601_date(new Date(fo,fr-1,1,0,0,0,0),false,true);fm=d5.to_iso8601_date(new Date(fo,fr,1,0,0,0),false,true);fp.filters=JSON.stringify({date_begin:fn,date_end:fm},{year:fo,month:fr})}else{if(this.is_collection()){fp.filters=JSON.stringify({collection_gid:this.get_collection_gid()})}else{cJ(false,"invalid photo event id: "+this.unique_id)}}}}return new cC.WebRequest({url:"/photos_event_metadata",data:fp,dataType:"json",success:(function(ft){return function(fu){ft.timing_metadata_received=b4.time();ft.cursor=fu.cursor;return ft._load_metadata_callback(fu.photos,fu.key_to_duplicates,(fu.more!=null)&&fu.more)}})(this)})};T.prototype.load_metadata_range=function(fm,fl){if(!(this._is_valid_photo_index(fm)&&this._is_valid_photo_index(fl))){this.load_metadata();return}if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=fm*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}if(this._is_loading_from_bottom()){return this.load_metadata(fm)}else{return this.load_metadata(fl)}};T.prototype.load_cached_metadata=function(){var fl,fm;if(this.loading_metadata||this._is_loading_from_bottom()||this.num_photos_loaded>0||(((fm=bQ.event_metadata_cache)!=null?fm[this.unique_id]:void 0)==null)){return false}fl=bQ.event_metadata_cache[this.unique_id];this.cursor=fl.cursor;this._load_metadata_callback(fl.photos,fl.key_to_duplicates,fl.more);return true};T.prototype._load_metadata_callback=function(fx,fq,fr){var fw,fs,fC,ft,fD,fn,fu,fA,fp,fy,fo,fv,fm,fl,fz,fB;ft=[];fp=[];fv=false;for(fw=fm=0,fz=fx.length;fm<fz;fw=++fm){fu=fx[fw];if(this.has_loaded_metadata()){fn=new J(this);if(this._is_loading_from_bottom()){this.photos.unshift(fn)}else{this.photos.push(fn)}fv=true}else{if(this.num_photos_loaded<this.photos.length){fs=this._is_loading_from_bottom()?this.photos.length-1-this.num_photos_loaded:this.num_photos_loaded;fn=this.photos[fs]}else{cJ(false,"num_photos_loaded should never be greater than photos.length")}}fn.init_metadata(fu);if(fn.uniqueness_key in fq){fn.set_duplicates(fq[fn.uniqueness_key])}if(fw<this.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD){fp.push(fn.preview_obj)}ft.push(fn)}if(this.timeline.opts.uses_lightbox){window.setTimeout((function(){var fH,fG,fF,fE;fE=[];for(fG=0,fF=fp.length;fG<fF;fG++){fH=fp[fG];fE.push(fH.preload())}return fE}),500)}eW.refresh(ft);for(fl=0,fB=ft.length;fl<fB;fl++){fn=ft[fl];if(fn.item_counter in this.init_sel_items){eW._add(fn);this.num_to_select--;if(this.num_to_select===0){eW.dec_num_loading_events_before_select()}delete this.init_sel_items[fn.item_counter];if(this.scroll_to_first_sel){this.scroll_to_first_sel=false;fo=this.timeline;fC=fn.uniqueness_key;bE(document).ready(function(){return fo.scroll_to_photo_with_key(fC)})}}}if(!fr){if(this.num_photos_loaded<this.photos.length){fD=this.photos.length-this.num_photos_loaded;fy=this._is_loading_from_bottom()?0:this.num_photos_loaded;this.photos.splice(fy,fD);this.num_photos_to_load=Math.min(this.num_photos_to_load,this.num_photos_loaded)}if(fv||fD){this._fix_photo_miscount()}if(typeof this.on_load_all_metadata==="function"){this.on_load_all_metadata(this)}this.on_load_all_metadata=null}this.loading_metadata=false;this.update_photo_divs();$(document).fire(T.PHOTOS_LOADED_EVT,this);if(!this.has_loaded_metadata()&&this.num_photos_to_load>this.num_photos_loaded){fA=this._is_loading_from_bottom()?this.photos.length-this.num_photos_to_load:this.num_photos_to_load-1;return this.load_metadata(fA)}};T.prototype._fix_photo_miscount=function(){var fn,fm,fl;fn=Math.ceil(this.init_num_photos/this.timeline.THUMBS_PER_ROW);fm=this.get_num_rows()-fn;if(typeof i!=="undefined"&&i!==null){i.log("event_miscount",null,null,null,{event_id:this.unique_id,false_count:this.init_num_photos,true_count:this.photos.length,count_delta:this.photos.length-this.init_num_photos})}fl=B.scroll_offsets().top;if(this.top_offset+this.get_height()<fl){B.scroll_to(0,fl+fm*this.timeline.THUMB_SIZE)}this._num_photos_changed();return $(document).fire(T.EVENT_MISCOUNT_EVT,this)};T.prototype.get_num_rows=function(){return Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW)};T.prototype.get_content_height=function(){return this.get_num_rows()*this.timeline.THUMB_SIZE};T.prototype.get_height=function(){return this.timeline.HEADER_HEIGHT+this.get_content_height()};T.prototype.has_loaded_metadata=function(){return this.num_photos_loaded===this.photos.length};T.prototype.visible_thumbs_loaded=function(fn){var fr,fq,fm,fl,fp,fo;if(fn==null){fn=this.timeline.get_viewport_info()}fo=this.get_photo_range_to_render(fn,false),fr=fo[0],fq=fo[1];if(fr===null&&fq===null){return true}for(fl=fp=fr;fr<=fq?fp<=fq:fp>=fq;fl=fr<=fq?++fp:--fp){fm=this.photos[fl];if((fm==null)||!(fm.status>=J.RENDERED)){return false}}return true};T.prototype._is_loaded=function(fl){var fm,fn;if(this._is_loading_from_bottom()){fn=this.photos.length-this.num_photos_loaded;fm=this.photos.length-1}else{fn=0;fm=this.num_photos_loaded-1}return(fn<=fl&&fl<=fm)};T.prototype._is_loading_from_bottom=function(){return this.loading_order===this.LOADING_ORDER_BOTTOM_UP};T.prototype._is_valid_photo_index=function(fl){return(fl!=null)&&(fl>=0)&&(fl<=this.photos.length-1)};T.prototype.update_photo_divs=function(){var fn,fm,fC,fB,fG,fJ,fD,fy,fs,fK,fA,fH,fw,ft,fq,fo,fL,fM,fl,fI,fz,fx,fv,fr,fp,fu,fF,fE;if(!this.num_photos_loaded){return}fH=this.timeline.get_viewport_info();if(this.hide_photos_if_not_in_current_viewport(fH)){return}fI=this.get_photo_range_to_render(fH),fC=fI[0],fB=fI[1];cJ((fC!=null)&&(fB!=null),"This line is after @hide_photos_if_not_in_ current_viewport, so first_photo_to_render and last_photo_to_render shouldn't be null.");if(!this.has_loaded_metadata()&&((!this._is_loaded(fC))||(!this._is_loaded(fB)))){this.load_metadata_range(fC,fB);if(this._is_loading_from_bottom()){fC=Math.max(fC,this.photos.length-this.num_photos_loaded)}else{fB=Math.min(fB,this.num_photos_loaded-1)}if(fC>fB){return}}fJ=Math.floor(fC/this.timeline.THUMBS_PER_ROW);fA=fJ*this.timeline.THUMB_SIZE;$("p-top-"+this.unique_id).setStyle({height:fA+"px"});fG=Math.floor((this.photos.length-1)/this.timeline.THUMBS_PER_ROW)-Math.floor(fB/this.timeline.THUMBS_PER_ROW);fm=fG*this.timeline.THUMB_SIZE;$("p-bottom-"+this.unique_id).setStyle({height:fm+"px"});this._hide_photos((function(){fu=[];for(var fN=0;0<=fC?fN<fC:fN>fC;0<=fC?fN++:fN--){fu.push(fN)}return fu}).apply(this));this._hide_photos((function(){fF=[];for(var fN=fz=fB+1,fO=this.photos.length;fz<=fO?fN<fO:fN>fO;fz<=fO?fN++:fN--){fF.push(fN)}return fF}).apply(this));this._show_photos((function(){fE=[];for(var fN=fC;fC<=fB?fN<=fB:fN>=fB;fC<=fB?fN++:fN--){fE.push(fN)}return fE}).apply(this));fv=eW.get();for(fo=0,fL=fv.length;fo<fL;fo++){fy=fv[fo];if((fr=$(fy.uniqueness_key))!=null){fr.addClassName("selected")}}this.scroll_count=bQ.scroll_count;fn=[];fp=this.get_thumb_indexes_to_load(fH);for(fl=0,fM=fp.length;fl<fM;fl++){fs=fp[fl];fy=this.photos[fs];if((fy!=null)&&fy.status>=J.RENDERED){fK=$(fy.uniqueness_key);if((fK!=null?fK.down("img"):void 0)!=null){fn.push(fK.down("img"))}}}fD=function(fN){return fN.up(".cu-thumb").addClassName("thumb-loaded")};return bs.batch_load_thumbs(fn,this.timeline.THUMBS_BATCH_SIZE,fD,this.log_thumb_load.bind(this))};T.prototype._hide_photos=function(fp){var fn,fo,fm,fl;fl=[];for(fo=0,fm=fp.length;fo<fm;fo++){fn=fp[fo];fl.push(this._hide_photo(fn))}return fl};T.prototype._hide_photo=function(fl){var fm;fm=this.photos[fl];if((fm==null)||!(fm.status===J.DISPLAYED)){return}$(fm.uniqueness_key).hide();return fm.status=J.RENDERED};T.prototype._show_photos=function(fB){var fx,fw,fA,fp,fy,fu,fo,fv,ft,fr,fq,fz,fn,fm,fl,fs;fp=[];for(fv=0,fz=fB.length;fv<fz;fv++){fw=fB[fv];fy=this._get_photo_insert_info(fw);if(!fy){continue}fA=fy[0],fo=fy[1];fu=false;for(ft=0,fn=fp.length;ft<fn;ft++){fx=fp[ft];if(fx.after===fA){fx.photos.push(fo);fu=true;break}}if(!fu){fp.push({after:fA,photos:[fo]})}}for(fr=0,fm=fp.length;fr<fm;fr++){fx=fp[fr];fx.after.__sert({after:fx.photos})}fs=[];for(fq=0,fl=fB.length;fq<fl;fq++){fw=fB[fq];fs.push(this.photos[fw].status=J.DISPLAYED)}return fs};T.prototype._get_photo_insert_info=function(fl){var fo,fm,fn,fs,fp,fr,fq;fn=this.photos[fl];if((fn==null)||fn.status===J.DISPLAYED){return}if(fn.status===J.RENDERED){$(fn.uniqueness_key).show()}else{fm=$("p-top-"+this.unique_id);if(fl!==0){for(fo=fr=fq=fl-1;fq<=0?fr<=0:fr>=0;fo=fq<=0?++fr:--fr){fs=this.photos[fo];if((fs!=null)&&fs.status>=J.RENDERED){fp=$(fs.uniqueness_key);cJ(fp!=null,"photo "+fo+" was marked as rendered, but its thumb elm doesn't exist");fm=fp;break}}}return[fm,fn.thumb_html]}};T.prototype.in_y_range=function(fm,fl){return !(this.top_offset+this.timeline.HEADER_HEIGHT>fl||this.top_offset+this.get_height()<fm)};T.prototype.in_current_viewport=function(fn,fp){var fl,fm,fo;if(fn==null){fn=this.timeline.get_viewport_info()}if(fp==null){fp=true}fm=fn.top;fl=fn.top+fn.height;if(fp){fo=this._blur_range(fm,fl,fn),fm=fo[0],fl=fo[1]}return this.in_y_range(fm,fl)};T.prototype.hide_photos_if_not_in_current_viewport=function(fo){var fm,fq,fn,fp,fl,fr;if(!this.in_current_viewport(fo)){if(this._is_loading_from_bottom()){for(fm=fq=fp=this.photos.length-this.num_photos_loaded,fl=this.photos.length;fp<=fl?fq<fl:fq>fl;fm=fp<=fl?++fq:--fq){this._hide_photo(fm)}}else{for(fm=fn=0,fr=this.num_photos_loaded;0<=fr?fn<fr:fn>fr;fm=0<=fr?++fn:--fn){this._hide_photo(fm)}}$("p-top-"+this.unique_id).setStyle({height:this.get_content_height()+"px"});$("p-bottom-"+this.unique_id).setStyle({height:"0px"});return true}return false};T.prototype._blur_range=function(fo,fl,fq){var fn,fm,fp;if(fq==null){fq=this.timeline.get_viewport_info()}fp=dy.get();if(fp>=0){fm=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION;fn=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION}else{if(fp<0){fm=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION;fn=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION}}fo-=fm*fq.height;fl+=fn*fq.height;return[fo,fl]};T.prototype.get_photo_range_to_render=function(ft,fn){var fr,fm,fq,fs,fp,fl,fo;if(fn==null){fn=true}fl=ft.top;fp=ft.bottom;if(fn){fo=this._blur_range(fl,fp,ft),fl=fo[0],fp=fo[1]}if(!this.in_y_range(fl,fp)){return[null,null]}fs=Math.floor((fl-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fr=Math.floor((fp-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fm=Math.min(this.photos.length-1,fs*this.timeline.THUMBS_PER_ROW);fq=Math.min(this.photos.length-1,(fr+1)*this.timeline.THUMBS_PER_ROW-1);cJ(!isNaN(fq),"Last photo to render should not be NaN.  "+("viewport_data.bottom="+ft.bottom+" ")+("viewport_data.height="+ft.height+" ")+("photos.length="+this.photos.length+" ")+("top_offset="+this.top_offset+" ")+("bottom_row_to_render="+fr+" "),true,["photo_event_nan_limit"]);return[Math.max(0,fm),fq]};T.prototype.get_photo_range_to_render_with_blur=function(fo){var fm,fr,fn,fq,fp,fl;fp=this.get_photo_range_to_render(fo,true),fr=fp[0],fq=fp[1];fl=this.get_photo_range_to_render(fo,false),fm=fl[0],fn=fl[1];return[fr,fm,fn,fq]};T.prototype.get_thumb_indexes_to_load=function(fy){var fF,fv,ft,fs,fC,fE,fB,fD,fz,fp,fn,fm,fl,fA,fr,fq,fo,fx,fw,fu;fA=this.get_photo_range_to_render_with_blur(fy),fv=fA[0],fF=fA[1],ft=fA[2],fs=fA[3];if(fF==null){fC=(function(){fo=[];for(var fG=fv;fv<=fs?fG<=fs:fG>=fs;fv<=fs?fG++:fG--){fo.push(fG)}return fo}).apply(this);if(this.top_offset>fy.bottom){return fC}else{return fC.reverse()}}fD=(function(){fx=[];for(var fG=fF;fF<=ft?fG<=ft:fG>=ft;fF<=ft?fG++:fG--){fx.push(fG)}return fx}).apply(this);fE=[];fB=[];if(fv<fF){fE=(function(){fw=[];for(var fG=fr=fF-1;fr<=fv?fG<=fv:fG>=fv;fr<=fv?fG++:fG--){fw.push(fG)}return fw}).apply(this)}if(fs>ft){fB=(function(){fu=[];for(var fG=fq=ft+1;fq<=fs?fG<=fs:fG>=fs;fq<=fs?fG++:fG--){fu.push(fG)}return fu}).apply(this)}fz=dy.get();if(fz>=0){return fD.concat(fB).concat(fE)}else{return fD.concat(fE).concat(fB)}};T.prototype.log_thumb_load=function(fm,fn){var fp,fl,fo;if(!this.timeline.opts.log_thumb_loading){return}if(this.scroll_count===bQ.scroll_count&&!this.logged_thumbs_arrived){if((fm+1)%this.timeline.THUMBS_PER_ROW===0||fm+1===fn){if(this.visible_thumbs_loaded()){fl=this.timeline.get_viewport_info();fp=this.timeline.events.indexOfKey(this.unique_id)===(this.timeline.events.length()-1);if((this.top_offset<fl.bottom&&fl.bottom<this.top_offset+this.get_height())||fp){if(bQ.scroll_count<2&&((fo=i.get_current_view())===cl.PHOTOS_VIEW||fo===cl.CAMERA_VIEW)){this.log_timing_event(I.viewport_initial_load);bQ.scroll_count+=2}else{this.log_timing_event(I.viewport_loaded)}}return this.logged_thumbs_arrived=true}}}};T.prototype.log_timing_event=function(fo){var fl,fm,fp,fn;fm=b4.time();fl={};if(fo===I.viewport_initial_load){if((typeof performance!=="undefined"&&performance!==null?(fn=performance.timing)!=null?fn.navigationStart:void 0:void 0)!=null){fp=b4.time()-performance.timing.navigationStart;fl={current_view:i.get_current_view()};eh.log_ajax_transition(fp,fo,fl,fo)}return}if(this.timing_stopped_scrolling_on_event===-1){return}if(fo===I.viewport_loaded){fp=fm-this.timing_stopped_scrolling_on_event}return eh.log_ajax_transition(fp,fo,fl,fo)};return T})();var J;J=D.Photo=(function(){T.PLACEHOLDER=0;T.LOADED=1;T.RENDERED=2;T.DISPLAYED=3;T.uniqueness_key;T.item_counter;T.filename;T.ns_id;T.ns_path;T.fq_path;T.href;T.thumbnail_url;T.large_thumbnail_url;T.time_taken;T.display_time_taken;T.preview_type;T.mtime;T.video_streaming_url;T.is_visible;T.user_id;T.event;T.status;T.thumb_html;T.preview_obj;T.duplicates_info;function T(fl){this.event=fl;this.status=T.PLACEHOLDER;this.preview_obj=fl.unique_id}T.prototype.init_metadata=function(fl){this.uniqueness_key=fl.uniqueness_key;this.item_counter=fl.item_counter;this.filename=fl.filename;this.ns_id=fl.ns_id;this.ns_path=fl.ns_path;this.fq_path=fl.path;this.href=fl.href;this.thumbnail_url=fl.thumbnail_url;this.large_thumbnail_url=fl.large_thumbnail_url;this.time_taken=fl.time_taken;this.display_time_taken=fl.display_time_taken;this.preview_type=fl.preview_type;this.mtime=fl.mtime;this.video_streaming_url=fl.video_streaming_url;this.is_visible=fl.is_visible;this.user_id=fl.user_id;this.thumb_html=this.event.timeline.tmpl({photo:this,display_date:this._get_display_date(),shareable:true,Sprite:cv});this.preview_obj=this._get_preview_obj();this.status=T.LOADED;this.event.num_photos_loaded+=1;return this.event.timeline.key_to_photo[this.uniqueness_key]=this};T.prototype.set_duplicates=function(fn){var fm,fo,fl;for(fo=0,fl=fn.length;fo<fl;fo++){fm=fn[fo];fm.fq_path=fm.path}return this.duplicates_info=fn};T.prototype._get_preview_obj=function(){if(!this.event.timeline.opts.uses_lightbox){return}if(this.preview_type==="photo"&&this.large_thumbnail_url){if(bQ.in_single_collection_view()){return new eT({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:F.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}else{return new dq({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:F.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}}else{if(this.preview_type==="video"&&this.large_thumbnail_url&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){if(bQ.in_single_collection_view()){return new aq({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:F.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}else{return new e2({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:F.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}}}return null};T.prototype._get_display_date=function(){var fl;if(this.time_taken!=null){fl=new Date(this.time_taken);return b4.nice_date_with_month_name(fl,fl.getUTCFullYear()<new Date().getFullYear(),true)}else{return""}};return T})();var ab;ab=D.PhotoCollection=(function(){T.CREATE_EVT="db:photocollection:create";T.ADD_EVT="db:photocollection:add";T.REMOVE_EVT="db:photocollection:remove";T.UNDO_REMOVE_EVT="db:photocollection:undo_remove";T.RENAME_EVT="db:photocollection:rename";T.DELETE_EVT="db:photocollection:delete";T.SHARE_EVT="db:photocollection:share";T.UNSHARE_EVT="db:photocollection:unshare";T.COVER_CHANGE_EVT="db:photocollection:cover_change";T.gid;T.name;T.num_items;T.num_photos;T.num_videos;T.thumbnail_url_32;T.thumbnail_url_256;T.is_anonymous;T.share_tkey;T.shmodel_url;T.short_url;T.is_creator;T.member_fnames;function T(fm,fl){if(fl==null){fl=true}cJ((fm.gid!=null)&&(fm.url!=null)&&(fm.name!=null)&&(fm.num_items!=null)&&(fm.num_photos!=null)&&(fm.num_videos!=null),"missing required PhotoCollection params");this.gid=fm.gid;this.url=fm.url;this.name=fm.name;this.num_items=fm.num_items;this.num_photos=fm.num_photos;this.num_videos=fm.num_videos;this.thumbnail_url_32=fm.thumbnail_url_32||null;this.thumbnail_url_256=fm.thumbnail_url_256||null;this.is_anonymous=fm.is_anonymous!=null?fm.is_anonymous:false;this.share_tkey=fm.share_tkey||null;this.shmodel_url=fm.shmodel_url||null;this.short_url=fm.short_url||null;this.is_creator=fm.is_creator!=null?fm.is_creator:true;this.member_fnames=fm.member_fnames||[eA("You")];if(fl){document.fire(T.CREATE_EVT,{collection:this})}}T.prototype.add_photos=function(fr,fq,fn,fp){var fl,fo,fm;if(fn==null){fn=false}if(fp==null){fp=true}fl=(function(){var fu,ft,fs;fs=[];for(fu=0,ft=fr.length;fu<ft;fu++){fm=fr[fu];fs.push(fm.item_counter)}return fs})();cJ(fl.length,"Have to add at least one photo");fo={collection_gid:this.gid,item_counters:JSON.stringify(fl),source_collection_gid:fq};return new Ajax.DBRequest("/collection_add",{parameters:fo,job:fn,job_user:cK.get_viewer().photos_user,progress_text:eA("Adding to album..."),onSuccess:(function(fs){return function(fv){var ft,fw,fu,fx;fx=JSON.parse(fv.responseText);fs.thumbnail_url_32=fx.thumbnail_url_32;fs.thumbnail_url_256=fx.thumbnail_url_256;fw=fx.new_num_photos-fs.num_photos;fu=fx.new_num_videos-fs.num_videos;ft=fx.new_num_items-fs.num_items;fs.num_photos=fx.new_num_photos;fs.num_videos=fx.new_num_videos;fs.num_items=fx.new_num_items;return document.fire(T.ADD_EVT,{collection:fs,photos:fr,num_items_added:ft,num_photos_added:fw,num_videos_added:fu,promote_collection:fp})}})(this)})};T.prototype.remove_photos=function(fo,fn){var fl,fm;if(fn==null){fn=false}fl=(function(){var fr,fq,fp;fp=[];for(fr=0,fq=fo.length;fr<fq;fr++){fm=fo[fr];fp.push(fm.item_counter)}return fp})();return new Ajax.DBRequest("/collection_remove",{parameters:{collection_gid:this.gid,item_counters:JSON.stringify(fl),is_shared:this.share_tkey!=null,num_items:this.num_items},job:fn,job_user:cK.get_viewer().photos_user,progress_text:eA("Removing from album..."),onSuccess:(function(fp){return function(fq){var fr;fr=JSON.parse(fq.responseText);fp.thumbnail_url_32=fr.thumbnail_url_32;fp.thumbnail_url_256=fr.thumbnail_url_256;fp.num_photos=fr.new_num_photos;fp.num_videos=fr.new_num_videos;fp.num_items=fr.new_num_items;return document.fire(T.REMOVE_EVT,{collection:fp,photos:fo,undo_changeset:fr.undo_changeset})}})(this)})};T.prototype.undo_remove=function(fl){return new Ajax.DBRequest("/photos_undo_remove",{parameters:{collection_gid:this.gid,changeset:fl},html_in_error_msg:true,progress_text:eA("Undoing..."),onSuccess:(function(fm){return function(){return document.fire(T.UNDO_REMOVE_EVT,{collection:fm})}})(this)})};T.prototype.rename=function(fm){var fl;bQ.enable_selection();fl=new Ajax.InPlaceEditor(fm,"/collection_rename",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.name,cancelIfSame:true,clickToEdit:false,onComplete:function(){return bE("#single-collection-title-container").removeClass("editing")},onFailure:function(){},savingText:eA("Saving..."),onLeaveEditMode:bQ.disable_selection,onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:(function(fn){return function(fo){fn.name=fo.responseText;return document.fire(T.RENAME_EVT,{collection:fn})}})(this)},callback:(function(fn){return function(fo,fp){return{collection_gid:fn.gid,new_collection_name:fp,is_shared:fn.share_tkey!=null}}})(this)});return fl.enterEditMode()};T.prototype["delete"]=function(){if(this.share_tkey!=null){new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{subject_user:cK.get_viewer().photos_user})}return new Ajax.DBRequest("/collection_delete",{parameters:{collection_gid:this.gid,is_shared:this.share_tkey!=null,num_items:this.num_items},subject_user:cK.get_viewer().photos_user,onSuccess:(function(fl){return function(){return document.fire(T.DELETE_EVT,{collection:fl})}})(this)})};T.prototype.attach_to_token=function(fn,fp,fm,fo,fl){return new Ajax.DBRequest("/collection_attach_to_dummy_token",{parameters:{tkey:fn,collection_gid:this.gid,num_items:this.num_items},onSuccess:(function(fq){return function(){fq.share_tkey=fn;fq.shmodel_url=fp;fq.short_url=fm;if(typeof fo==="function"){fo()}return document.fire(T.SHARE_EVT,{collection:fq})}})(this),onFailure:function(){return typeof fl==="function"?fl():void 0}})};T.prototype.send_link=function(fm,fo,fs,fn,fr,fl){var fq,fp;fq=(function(ft){return function(){ft.share_tkey=fo;ft.shmodel_url=fs;ft.short_url=fn;if(typeof fr==="function"){fr()}return document.fire(T.SHARE_EVT,{collection:ft})}})(this);fp={collection_gid:this.gid,share_tkey:fo,num_items:this.num_items};return bT.ajax_submit(fm,"/collection_share",fq,fl,fm.down(".tokenizer-submit-button"),fp)};T.prototype.unshare=function(){cJ(this.share_tkey!=null,"Can't unshare collection "+this.gid+" without a tkey");return new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{onSuccess:(function(fl){return function(){fl.share_tkey=null;fl.shmodel_url=null;fl.short_url=null;return document.fire(T.UNSHARE_EVT,{collection:fl})}})(this),subject_user:cK.get_viewer().photos_user})};T.prototype.set_cover=function(fl){return new Ajax.DBRequest("/collection_set_cover",{parameters:{collection_gid:this.gid,item_counter:fl.item_counter},onSuccess:(function(fm){return function(fn){var fo;fo=JSON.parse(fn.responseText);fm.thumbnail_url_32=fo.thumbnail_url_32;fm.thumbnail_url_256=fo.thumbnail_url_256;return document.fire(T.COVER_CHANGE_EVT,{collection:fm})}})(this)})};return T})();var b5,l;b5=__PARENT_SCOPE__.FilePreview=INLINE_JS.FilePreview=D.FilePreview={PARTIAL_TEXT_LENGTH_THRESHOLD:64*1024,_pdfLoader:new av(),init_pdf:function(fp,fo,fm,T){var fl,fn;this._pdfLink=T;this.iframe_src=fo;this._log_pdf_render_time(fp);if(fp==="pdf-native"||fp==="pdf-embedded"||fp==="pdf-js"){window.addEventListener("message",l,false);bE((function(fq){return function(){var fu,ft,fs,fr;fr=F.parse(fo);fu=bE("#pdf-embed-container");if(fu.attr("data-docpreview-annotation-marker-enabled")==="True"){fr=fr.updateQuery("annotation_marker","1")}if(fu.attr("data-docpreview-annotation-highlight-enabled")==="True"){fr=fr.updateQuery("annotation_highlight","1")}if(fu.attr("data-docpreview-annotation-region-enabled")==="True"){fr=fr.updateQuery("annotation_region","1")}if(fp==="pdf-js"){fs=fr.getQuery();fq._pdfLoader.startListening();fq._pdfLoader.openFile(fs.file);delete fs.file;fr.setQuery(fs)}ft=bE("#pdf-embed-iframe");ft.attr("src",String(fr));ft.attr("type","application/pdf");ft.attr("allowfullscreen","");ft.addClass("pdfjs");bE("html, body").addClass("full_height");return fq._fire_pdf_render_event()}})(this));this.preview_status=fm;if(b1.chrome){fn=function(){var fq;fq=bE('link[rel="shortcut icon"]').remove();return bE("head").append(fq)};setTimeout(fn,1000)}fl=$$("#pdf-embed-container iframe");return window.setTimeout(((function(fq){return function(){return fl.invoke("setStyle",{visibility:"visible"})}})(this)),200)}},init_excel:function(T){window.addEventListener("message",l,false);return bE("#pdf-embed-iframe").attr("src",T)},excel_preview_unsupported:function(){return this.preview_failed()},init_font:function(){return bE((function(T){return function(){if(!$(document.documentElement).hasClassName("fontface")||$(document.body).hasClassName("gecko")){return $(document.body).removeClassName("file-preview-body")}}})(this))},init_htmlified:function(){if(window.htmlified_height){this.htmlified_loaded();return}if(!window.postMessage){this.preview_failed();return}return setTimeout(((function(T){return function(){if(!window.htmlified_height){return T.preview_failed()}}})(this)),10000)},htmlified_loaded:function(){var T;if((T=$("htmlified-loading"))!=null){T.remove()}if(bE("#htmlified-wrapper[data-docpreview-ui-rams-enabled='True'] iframe, code-wrapper[data-docpreview-ui-rams-enabled='True'] iframe").length===0){$("htmlified").style.height=window.htmlified_height+"px"}return $("htmlified").style.visibility=""},init_video:function(fo,fq,fl,fn,T,fm,fp){return bE((function(fr){return function(){var fu,fs,ft;ft=fp.width()*0.9;fs=ft*0.55;fu=fr._video_preview_failed;if(fn==="hls"){fr.player=bt.embed("#video",{src:fl,type:"application/vnd.apple.mpegurl",width:ft,height:fs,controls:true,poster:T,onError:fu,onReady:fr._player_ready,metadata_link:fm})}else{bE("#video").empty();if(fo){if(fq){fr.player=bt.embed("#video",{src:fl,type:"video/mp4",width:ft,height:fs,controls:true,poster:T,onError:fu,onReady:fr._player_ready,metadata_link:fm})}else{fu()}}else{fr.player=bt.embed("#video",{src:fl,type:"video/flv",width:ft,height:fs,controls:true,poster:T,onError:fu,onReady:fr._player_ready,metadata_link:fm})}}bE(".vjs-poster").hide();bE(".vjs-big-play-button").hide();fr.player.on("play",fr._onPlay);return fr.player.on("ended",fr._onEnded)}})(this))},photo_loaded:function(fm){var fl,T;if((fl=window.performance)!=null?(T=fl.timing)!=null?T.navigationStart:void 0:void 0){fm=fm-window.performance.timing.navigationStart;return eh.log_ajax_transition(fm,"file-preview-photo")}},switch_preview:function(fl,fo,fr){var fq,fp,fn,fm,T;fn=INLINE_JS.URI.parse(this.iframe_src);T=INLINE_JS.URI.parse(fn.getQuery().file);fm=T.updateQuery({revision_id:fl}).toString();fp=F.parse(this.iframe_src).updateQuery({file:fm});if(fo){fp.updateQuery({annotation_marker:"1"});fp.updateQuery({annotation_highlight:"1"});fp.updateQuery({annotation_region:"1"})}else{fp.removeQuery("annotation_marker");fp.removeQuery("annotation_highlight");fp.removeQuery("annotation_region")}fq=bE("#pdf-embed-iframe");fq.attr("src",fp.toString());fq.on("load",fr);return this._fire_pdf_render_event()},_player_ready:function(){var T;T=function(){bE(".vjs-poster").show();bE(".vjs-big-play-button").show();return bE(".vjs-big-play-button").focus()};return T.defer()},_onPlay:function(){bE(".vjs-poster").hide();return bE(".vjs-big-play-button").hide()},_onEnded:function(){bE(".vjs-poster").show();bE(".vjs-big-play-button").show();return bE(".vjs-loading-spinner").hide()},_video_preview_failed:function(T){if(T==="needflash"){bE("#video-preview-flash-message").show()}return b5.preview_failed()},preview_failed:function(){var T;T=bE(document.body);if(T.hasClass("shmodel-body")){T.removeClass("file-preview-body")}ae.error(eA("Preview failed."));return bE(document).trigger("preview_failed")},_fire_pdf_render_event:function(){var T;if(document.createEvent&&window.dispatchEvent){T=document.createEvent("UIEvents");T.initUIEvent("pagerender",false,false,window,0);return window.dispatchEvent(T)}},_log_pdf_render_time:function(fl){var T;T=function(fp){var fn,fo,fm;if((fo=window.performance)!=null?(fm=fo.timing)!=null?fm.navigationStart:void 0:void 0){fn=b4.time()-window.performance.timing.navigationStart;return eh.log_ajax_transition(fn,fp)}};Event.observe(window,"pagerender",function(){Event.stopObserving(window,"pagerender");return T(fl)});return Event.observe(window,"parsecomplete",function(){Event.stopObserving(window,"parsecomplete");return T(""+fl+"-parse")})},_getEmbedContainer:function(){var T;T=bE("#pdf-embed-container, #html-container, #htmlified-wrapper, #code-wrapper");if(T.length!==1){T=[]}return T},nativePdfPrint:function(){var T,fm,fl;if(!bE("body").hasClass("file-preview-body")||bE("#pdf-embed-iframe").length!==1||(this._pdfLink==null)){return false}fl=F.parse(b1.get_href());fl.setQuery({preview:1,force_no_progressive:1});T=F.parse(this._pdfLink).getAuthority();fm=bV.getNativePrintUrl(fl.toString(),T,bE("#pdf-embed-container"));if(fm==null){return false}window.open(fm,"_blank");return true},enter_rams_fullscreen:function(){return bV.enter_rams_fullscreen(bE(this._getEmbedContainer()))},exit_rams_fullscreen:function(){return bV.exit_rams_fullscreen(bE(this._getEmbedContainer()))},is_rams_fullscreen_active:function(){return bV.is_rams_fullscreen_active(bE(this._getEmbedContainer()))}};l=function(fo){var fn,fl,fm,T;fl={"https://dl.dropbox.com":true};fl["https://"+fj.DL_DOC_DOMAIN]=true;fl["https://"+Constants.DL_DOC_USER_CONTENT_DOMAIN]=true;fl["https://"+Constants.PUBSERVER]=true;fl["https://"+Constants.WEB_STATIC_DROPBOX_HOST]=true;if(fl[fo.origin]){fm={};try{fm=JSON.parse(fo.data);fn=fm.action}catch(fp){T=fp;fn=fo.data}switch(fn){case"failed":return b5.preview_failed()}}};var aB;aB=D.ClientDownload=(function(){function T(){}T.prototype.show_download_modal=function(){return new Ajax.DBRequest("/download_modal_view",{onSuccess:function(fl){var fm;fm=bE("<div",{"class":"brodal-header",text:eA("Install Dropbox")});return fc.show(fm[0],$("client-download"),{},false,450)},subject_user:cr.active_user})};return T})();var cy,en,i,I,a8,db,cl;cy=D.AlbumsLogger={log_share:function(fl,fo,fn,fm,T){return cy.log(fl,fo,true,fn,fm,T)},log_event:function(T,fn,fm,fl){return cy.log(T,fn,false,fm,fl)},log:function(fl,fq,fn,fp,fo,T){var fm;fm={evt:fl,collection_gid:fq,is_anonymous:fo};if(fn!=null){fm.share_event=fn}if(fp!=null){fm.num_items=fp}if(T!=null){fm.on_create=T}return new Ajax.DBRequest("/collection_log",{method:"post",noAutonotify:true,parameters:fm})}};en=INLINE_JS.PhotosEvents=D.PhotosEvents={CLEAR_SELECTED:"clear_selected",SHARE:"share",SHARE_ALBUM:"share_album",GO_TO_ALBUM_LINK:"go_to_album_link",UNSHARE_ALBUM:"unshare_album",ADD_TO_NEW_ALBUM:"add_to_new_album",ADD_TO_RECENT_ALBUM:"add_to_recent_album",ADD_TO_OTHER_ALBUM:"add_to_other_album",SHOW_IN_FOLDER:"show_in_folder",DELETE:"delete",DELETE_ALBUM:"delete_album",REMOVE:"remove",SET_AS_COVER:"set_as_cover",RENAME_ALBUM:"rename_album",OPEN_LIGHTBOX:"open_lightbox",MARQUEE_SELECT:"marquee_select",SEND:"send",GET_LINK:"get_link",FB_SHARE:"fb_share",TWITTER_SHARE:"twitter_share"};a8=INLINE_JS.PhotosTourEvents=D.PhotosTourEvents={SKIP:"skip",AWESOME:"awesome",EXIT_MODAL:"exit_modal",SHOW_MODAL:"show_modal"};db=INLINE_JS.PhotosTriggers=D.PhotosTriggers={SAH:"selected_actions_header",PCM:"photos_context_menu",CCM:"collections_context_menu",SCA:"single_collection_action",CLICK:"click",DBL_CLICK:"double_click",DRAG:"drag",ESC:"escape",CLICK_TITLE:"click_title",LIGHTBOX:"lightbox",DROP_TARGET:"drop_target",FOSHMODAL:"foshmodal"};cl=D.PhotosViews={PHOTOS_VIEW:"photos_view",CAMERA_VIEW:"camera_view",ALBUMS_VIEW:"albums_view",SINGLE_COLLECTION_VIEW:"single_collection_view",NOT_PHOTOS:"not_photos",MISSING_TIMESTAMPS_VIEW:"missing_timestamps_view"};i=INLINE_JS.PhotosLogger=D.PhotosLogger={last_logged_error_msg:null,last_error_msg_url:null,get_current_view:function(){var T,fm,fl;T=((fl=$("modal"))!=null?fl.visible():void 0)&&$("shmodal").visible();fm=T?"-foshmodal":"";if(bQ.in_single_collection_view()){return cl.SINGLE_COLLECTION_VIEW+fm}else{if(bQ.in_all_collections_view()){return cl.ALBUMS_VIEW+fm}else{if(bQ.initialized){return cl.PHOTOS_VIEW+fm}else{return cl.NOT_PHOTOS}}}},log_interaction:function(T,fl,fm){return i.log(T,fl,null,i.get_current_view(),fm)},log_transition_to:function(T){return i.log(T,null,null,i.get_current_view(),null,true)},log:function(fl,fm,T,fq,fo,fp){var fn;fn={evt:fl,trigger:fm,view:T};if(fo!=null){fn.data=JSON.stringify(fo)}if(fq!=null){fn.start_view=fq}if(fp!=null){fn.transition=true}return new Ajax.DBRequest("/photos_log",{method:"post",noAutonotify:true,parameters:fn})}};I=D.PhotosTimingEvents={viewport_loaded:"viewport_loaded",viewport_initial_load:"viewport_initial_load"};var dK,aN;aN=D.ShmodelLogger={CLICK_SIGN_IN:"click_sign_in",CLICK_ADD_TO_MY_DROPBOX:"click_add_to_my_dropbox",REMOVE_LINK:"remove_link",CLICK_FILENAME:"click_filename",CLICK_DOWNLOAD:"click_download",LOGIN_THRU_DEFAULT_DROPDOWN:"login_thru_default_dropdown",CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN:"click_signup_thru_default_dropdown",CLICK_SHARE:"click_share",log:function(T){return new Ajax.DBRequest("/shmlog",{method:"post",noAutonotify:true,parameters:{evt:T,url:window.location.href}})},attachLogListener:function(T,fl){if(fl==null){return}return fl.observe("click",function(fm){aN.log(T);if(fl.href&&fl.href!=="#"&&fl.target!=="_blank"){Event.stop(fm);return(function(){return window.location.href=fl.href}).defer()}})}};dK=D.RegistrationLogger={log:function(T){var fl;fl=window.location.href;return new Ajax.DBRequest("/share/reglog",{method:"post",noAutonotify:true,parameters:{evt:T,url:fl}})},attachLogListener:function(T,fl){if(fl==null){return}return fl.observe("click",function(fm){dK.log(T);if(fl.href&&fl.href!=="#"&&fl.target!=="_blank"){Event.stop(fm);return(function(){return window.location.href=fl.href}).defer()}})}};var f;f=D.ModalFlow=(function(){function T(ft,fr,fv,fn,fm,fq,fu){var fl,fo,fs,fp;this.title=ft;this.icon=fr;this.states=fv;this.next_state_table=fn;this.previous_state_table=fm;this.initial=fq;this.onStart=fu;this._state_map={};fp=this.states;for(fo=0,fs=fp.length;fo<fs;fo++){fl=fp[fo];this._state_map[fl.name]=fl}this.state=null;this._exit_listeners=[];this._cleanup_queue=[]}T.prototype.start=function(){var fo,fn,fl,fm;this.vars={};fm=this.states;for(fn=0,fl=fm.length;fn<fl;fn++){fo=fm[fn];fo.next=this._next.bind(this,fo);fo.back=this._back.bind(this,fo);if(fo.onSubmit){fo.onSubmitFn=(function(fp,fq){fp.onSubmit(this,fp,fq);return false}).bind(this,fo)}else{fo.onSubmitFn=((function(fp){return function(fq,fr){fq.next();return false}})(this)).bind(this,fo)}fo.contents.on("submit",fo.onSubmitFn);fo.contents.find(".backbutton").on("click",fo.back)}fc.onHide=this._onExit.bind(this);if(this.onStart){this.onStart()}this.to_state(this.initial);return false};T.prototype.to_state=function(fm){var fl;this.state=this._state_map[fm];fl=this.title;if(this.state.title!=null){fl=this.state.title}fc.show(fl,this.state.contents[0]);return this.state.enter(this)};T.prototype._next=function(fl){var fm;if(fl===this.state){fm=this.next_state_table[this.state.name](this);if(fm==="__exit__"){return this.exit()}else{return this.to_state(fm)}}};T.prototype._back=function(fl){var fm;if(fl===this.state){fm=this.previous_state_table[this.state.name](this);if(fm==="__cancel__"){return this.exit()}else{if(fm){return this.to_state(fm)}}}};T.prototype.exit=function(){return this._onExit()};T.prototype._onExit=function(fs){var fn,fl,fq,fp,ft,fm,fr,fo;fr=this.states;for(fq=0,ft=fr.length;fq<ft;fq++){fl=fr[fq];fl.contents.off("submit",fl.onSubmitFn)}this._cleanUpExitListeners();fo=this._exit_listeners;for(fp=0,fm=fo.length;fp<fm;fp++){fn=fo[fp];fn(fs)}fc.onHide=null;return fc.hide()};T.prototype.addExitListener=function(fl){return this._exit_listeners.push(fl)};T.prototype.removeExitListener=function(fl){return this._cleanup_queue.push(fl)};T.prototype._cleanUpExitListeners=function(){var fp,fo,fr,fm,fq,fl;fq=this._cleanup_queue;fl=[];for(fr=0,fm=fq.length;fr<fm;fr++){fp=fq[fr];fo=this._exit_listeners.indexOf(fp);fl.push(this._exit_listeners.splice(fo,1))}return fl};return T})();var cE;cE=D.TwoFactorAuth={_checkpoint_token:null,_email:null,_container_selector:null,_error_selector:null,_is_offline_setup:null,_invalid_code_count:null,_current_flow:null,set_user:function(T){this._user=cK.get_viewer().get_user_by_id(T);cJ(this._user,""+T+" is invalid");return bE("#twofactor-enter-password .email-placeholder").text(this._user.email)},login_init:function(){this._container_selector="#twofactor-confirm";this._error_selector="#twofactor-confirm .error-message";return this.login_listen()},login_listen:function(){bE("#resend-link").on("click",this.resend_phone_code.bind(this));return bE("#code").focus()},init:function(fl,T){this._container_selector=".twofactor-account-form";this._error_selector=".twofactor-account-form .error-message";this.account_listen();d5.async_load_script(fl);return d5.async_load_script(T)},account_listen:function(){var fu,fp,T,fm,fn,fq,fo,fx,fs,fr,fy,fl,fw,ft,fv;fw={name:"delivery_choice",enter:(function(fz){return function(fA){var fB;fz.hide_error();fB=0;bE(".delivery-choice").each(function(){var fC;fC=bE(this).height();return fB=Math.max(fC,fB)});bE(".delivery-choice").height(fB);return bE(".delivery-choice.selected > input").prop("checked",true)}})(this),contents:bE("#twofactor-delivery-choice"),onSubmit:(function(fz){return function(fA,fB,fC){fA.vars.sms=!!(bE("#use-sms")[0].getValue()==="on");if(!fA.vars.sms){return fz.fetch_offline_key(fA,fB)}else{return fB.next()}}})(this)};ft={name:"enter_phone_number",enter:(function(fz){return function(fB){var fC,fA;fz.hide_error();fz._is_offline_setup=false;fz._phone_number=null;fC=$("twofactor-enter-phone");fA=fz.fill_phone_number_for_edit(fC,bE("#twofactor-row-"+fz._user.role+" #twofactor-sms-number").text());return fA.focus()}})(this),contents:bE("#twofactor-enter-phone"),onSubmit:this.submit_phone_number.bind(this)};fv={name:"offline_setup",enter:(function(fz){return function(fA){fz.hide_error();fz._is_offline_setup=true;return fz._phone_number=null}})(this),contents:bE("#twofactor-offline-setup")};fl={name:"confirm_phone",enter:(function(fz){return function(fA){var fB;fz._invalid_code_count=0;if(fz._is_offline_setup){$("twofactor-enable-confirm").addClassName("offline")}else{fB=fA.vars.phone_number;cJ(fB,"expected a display_phone argument");$("phone-number-placeholder").__date(fB);$("twofactor-enable-confirm").removeClassName("offline")}fz.hide_error();$("phone-code").clear().focus();return fz.fill_delivery_choice(fB)}})(this),onSubmit:this.submit_phone_code.bind(this),contents:bE("#twofactor-enable-confirm")};fy={name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_next"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_none"),contents:bE("#twofactor-enter-backup-phone")};fq=new f(this.DEFAULT_ENABLE_TITLE,this.LOCK_ICON,[{name:"enable_start",enter:this.hide_error.bind(this),contents:bE("#twofactor-start")},{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.ENABLE_CONFIRM_HREF,(function(fz){return function(fA,fB){fz.successfully_enabled=false;fA.vars.mode="ENABLE";fA.vars.passed_password=true;return fB.next()}})(this)),contents:bE("#twofactor-enter-password")},fw,ft,fv,fl,fy,{name:"recovery_code",enter:(function(fz){return function(){fz.fill_backup_phone(fz._backup_phone);return fz.hide_error.bind(fz)}})(this),onSubmit:this.submit_finish.bind(this,false),contents:bE("#twofactor-recovery")},{name:"congrats_done",enter:this.after_enabled.bind(this),title:eA("Congrats! You've enabled two-step verification!"),contents:bE("#twofactor-done")}],{enable_start:function(){return"password"},password:function(){return"delivery_choice"},delivery_choice:(function(fz){if(fz.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"recovery_code"},recovery_code:function(){return"congrats_done"},congrats_done:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{enable_start:function(){return null},password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(fz){if(fz.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"},recovery_code:function(){return"backup_phone"},congrats_done:function(){return null}},"enable_start",function(){return this.vars.passed_password=false});fq.addExitListener((function(fz){return function(fA){if(fq.vars.passed_password&&fA&&!fz.successfully_enabled){return ae.error(eA("Two-step verification is not enabled"))}}})(this));fn=new f(this.DEFAULT_EDIT_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fz){return function(fB,fC){var fA;fz.successfully_enabled=false;bE(".delivery-choice").removeClass("selected");fA=!bE("#twofactor-row").hasClass("with-sms");bE(fA?"#app-choice":"#sms-choice").addClass("selected");bE("#twofactor-recovery").addClass("edit-mode");fB.vars.passed_password=true;return fC.next()}})(this)),contents:bE("#twofactor-enter-password")},fw,ft,fv,fl,{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_everything"),contents:bE("#twofactor-enter-backup-phone")}],{password:function(){return"delivery_choice"},delivery_choice:(function(fz){if(fz.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(fz){if(fz.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"}},"password",function(){return this.vars.passed_password=false});fn.addExitListener((function(fz){return function(fA){if(fn.vars.passed_password&&fA&&!fz.successfully_enabled){return ae.error(eA("Two-step verification has not been changed"))}}})(this));T=new f(this.DEFAULT_DISABLE_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.DISABLE_CONFIRM_HREF,(function(fz){return function(fA,fB){fz.successfully_disabled=false;fA.vars.passed_password=true;return fB.next()}})(this)),contents:bE("#twofactor-enter-password")},{name:"disable",enter:this.hide_error.bind(this),contents:bE("#twofactor-disable"),onSubmit:this.disable_submit.bind(this)}],{password:function(){return"disable"},disable:function(){return"__exit__"}},{password:function(){return null},disable:function(){return"__cancel__"}},"password",function(){return this.vars.passed_password=false});T.addExitListener((function(fz){return function(fA){if(T.vars.passed_password&&fA&&!fz.successfully_disabled){return ae.error(eA("Two-step verification is still enabled"))}}})(this));fu=new f(this.ADD_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fz,fA){return fA.next()}),contents:bE("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,true,"save_backup_phone"),contents:bE("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");fm=new f(this.EDIT_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fz,fA){return fA.next()}),contents:bE("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_backup_phone"),contents:bE("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");fx=new f(this.EDIT_RECOVERY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fz){return function(fA,fB){return new Ajax.DBRequest(fz.RECOVERY_CODE_HREF,{parameters:{checkpoint_token:fz._checkpoint_token},onSuccess:function(fD){var fC,fE;fE=fD.responseText.strip();if(fE.startsWith("OK:")){fC=[fE.substr(3)];fz.fill_recovery_codes(fC,"backup-code-div-edit");return fB.next()}else{switch(fE){case"EXPIRED":return fz.show_error_expired();case"ALREADY_DISABLED":bE("#twofactor-row").removeClass("twofactor-enabled");ae.success(eA("Two-step verification is already disabled. Did you maybe disable it in another window?"));return fc.hide()}}},onFailure:fz.show_error500.bind(fz),cleanUp:fz.hide_loading.bind(fz),subject_user:fz._user})}})(this)),contents:bE("#twofactor-enter-password")},{name:"recovery_code",enter:this.hide_error.bind(this),contents:bE("#twofactor-recovery-edit"),onSubmit:(function(fz){return function(fA,fB){fz._checkpoint_token=null;return fB.next()}})(this)}],{password:function(){return"recovery_code"},recovery_code:function(){return"__exit__"}},{password:function(){return null},recovery_code:function(){return null}},"password");fr=(function(fz){return function(fA){return new Ajax.DBRequest(fz.ADD_SECURITY_KEY_FINISH_HREF,{parameters:{checkpoint_token:fz._checkpoint_token,device_response:JSON.stringify(fA)},noAutonotify:true,onSuccess:function(fB){var fC;fC=fB.responseText.strip();fp.to_state("register_success");return bE(document).trigger("security-key-manager:UPDATE_KEYS",fz._user.id)},onFailure:function(fD){var fB,fC;fB=JSON.parse(fD.responseText.substr(4));fC=fB.security_key_register!=null?fB.security_key_register["message_text"]:ae.DEFAULT_ERROR;bE("#twofactor-security-key-register-error #error-msg").text(fC);return fp.to_state("register_error")},cleanUp:fz.hide_loading.bind(fz),subject_user:fz._user})}})(this);fo=(function(fz){return function(fA,fB){return new Ajax.DBRequest(fz.ADD_SECURITY_KEY_START_HREF,{parameters:{checkpoint_token:fz._checkpoint_token},onSuccess:function(fC){var fD;fD=JSON.parse(fC.responseText);u2f.register(fD.registerRequests,fD.authenticateRequests,fr);return fB.next()},onFailure:fz.show_error500.bind(fz),cleanUp:fz.hide_loading.bind(fz),subject_user:fz._user})}})(this);fs=new f(this.ADD_SECURITY_KEY_TITLE,this.LOCK_ICON,[{name:"unsupported_browser",enter:this.hide_error.bind(this),contents:bE("#twofactor-security-key-unsupported-browser")}],{unsupported_browser:function(){return"__exit__"}},{},"unsupported_browser");fp=new f(this.ADD_SECURITY_KEY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fz,fA){return fA.next()}),contents:bE("#twofactor-enter-password")},{name:"intro",enter:this.hide_error.bind(this),contents:bE("#twofactor-security-key-intro")},{name:"prepare_register",enter:this.hide_error.bind(this),contents:bE("#twofactor-security-key-prepare-register"),onSubmit:fo},{name:"register",enter:this.hide_error.bind(this),contents:bE("#twofactor-security-key-register")},{name:"register_error",enter:this.hide_error.bind(this),contents:bE("#twofactor-security-key-register-error"),onSubmit:fo},{name:"register_success",enter:(function(fz){return function(){fz.hide_error.bind(fz);return fz._checkpoint_token=null}})(this),onSubmit:function(fz,fA){ae.success(eA("Successfully added security key."));return fA.next()},contents:bE("#twofactor-security-key-register-success")}],{password:function(){return"intro"},intro:function(){return"prepare_register"},prepare_register:function(){return"register"},register:function(){return"register_success"},register_error:function(){return"register"},register_success:function(){return"__exit__"}},{},"password");this._bind_phone_input_to_save_button();this._register_skip_link_click_to_submit_finish();bE(".enable-twofactor").on("click",(function(fz){return function(fA){return fz.start_flow(fA,fq)}})(this));bE(".disable-twofactor").on("click",(function(fz){return function(fA){return fz.start_flow(fA,T)}})(this));bE(".add-twofactor-backup-link").on("click",(function(fz){return function(fA){return fz.start_flow(fA,fu)}})(this));bE(".edit-twofactor-backup").on("click",(function(fz){return function(fA){return fz.start_flow(fA,fm)}})(this));bE(".edit-twofactor-recovery").on("click",(function(fz){return function(fA){return fz.start_flow(fA,fx)}})(this));bE(".edit-twofactor-sms, .edit-twofactor-offline").on("click",(function(fz){return function(fA){return fz.start_flow(fA,fn)}})(this));bE(document).on("twofactor:ADD_SECURITY_KEY",(function(fz){return function(fB,fA){if(bE("#twofactor-security-key-unsupported-browser").length){return fz.start_flow(fB,fs,fA)}else{return fz.start_flow(fB,fp,fA)}}})(this));bE("#generate-new-recovery-code").on("click",(function(fz){return function(fA){fz.show_loading();return new Ajax.DBRequest(fz.NEW_RECOVERY_CODE_HREF,{parameters:{checkpoint_token:fz._checkpoint_token},onSuccess:function(fC){var fB,fD;fD=fC.responseText.strip();if(fD.startsWith("OK:")){fB=[fD.substr(3)];return fz.fill_recovery_codes(fB,"backup-code-div-edit")}else{switch(fD){case"EXPIRED":fx.to_state("password");return fz.show_error_expired();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");ae.success(eA("Two-step verification is disabled. Did you maybe disable it in another window?"));return fc.hide()}}},onFailure:fz.show_error500.bind(fz),cleanUp:fz.hide_loading.bind(fz),subject_user:fz._user})}})(this));bE("#twofactor-enter-backup-phone #country-code").on("change",this.reset_phone_field.bind(this));bE("#resend-link").on("click",this.enable_resend_phone_code.bind(this));bE("#twofactor-delivery-choice input").change(function(){bE(".delivery-choice").removeClass("selected");return bE(this).parents(".delivery-choice").addClass("selected")});bE("#show-qr").on("click",function(fz){bE("#twofactor-offline-setup").addClass("showing-qr");return false});bE("#hide-qr").on("click",function(fz){bE("#twofactor-offline-setup").removeClass("showing-qr");return false});if(window.location.hash==="#backup2fa"&&bE("#twofactor-row").hasClass("allow-autopop")){return this.start_flow(fu)}},_bind_phone_input_to_save_button:function(){this.$save_button=bE("#twofactor-enter-backup-phone").find(".back-next").find(".savebutton");this.$phone_input=bE("#twofactor-enter-backup-phone").find(".twofactor-backup-phone-number").find(".phone-text");this.$phone_input.on("keyup",(function(T){return function(fl){return T._toggle_save_phone_button(T.$phone_input,T.$save_button)}})(this));this.$phone_input.on("input",(function(T){return function(fl){return T._toggle_save_phone_button(T.$phone_input,T.$save_button)}})(this));return this._toggle_save_phone_button(this.$phone_input,this.$save_button)},_register_skip_link_click_to_submit_finish:function(){return bE("#twofactor-enter-backup-phone").find(".back-next").find("#skipstep").on("click",(function(T){return function(){return T.submit_finish(true,T._current_flow,T._current_flow.state,null)}})(this))},_toggle_save_phone_button:function(T,fl){var fm;fm=bE.trim(T.val())==="";return fl.prop("disabled",fm)},start_flow:function(fm,fl,T){if(T==null){T=null}fm.preventDefault();if(T==null){T=bE(fm.target).data("uid")}cE.set_user(cK.get_viewer().get_user_by_id(T));this._current_flow=fl;fl.start();return false},connect_login_init:function(){this._container_selector="#twofactor-form";this._error_selector="#twofactor-form .error";return bE("#resend-link").on("click",this.connect_resend_phone_code.bind(this))},resend_phone_code:function(fl){var T;if(this.is_resending()){return}this.show_resending();T="/twofactor_resend";if(bE("#twofactor-confirm").hasClass("backup")){T=F.parse(T).updateQuery({backup:true}).toString()}new Ajax.DBRequest(T,{onSuccess:(function(fm){return function(fn){switch(fn.responseText.strip()){case"OK":fm.hide_error();return fm.notify_resent();case"UNREACHABLE":return fm.show_error_unreachable(true);case"BADCARRIER":return fm.show_error_bad_carrier();case"INVALIDNUMBER":return fm.show_error_invalid_number();case"NOTAMOBILE":return fm.show_error_not_a_mobile();case"RATELIMIT":return ae.error(eA("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-confirm").submit()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},connect_resend_phone_code:function(T){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(fl){return function(fm){switch(fm.responseText.strip()){case"OK":fl.hide_error();return fl.notify_resent();case"UNREACHABLE":return ae.error(error_unreachable(true));case"BADCARRIER":return ae.error(error_bad_carrier());case"INVALIDNUMBER":return fl.show_error_invalid_number();case"NOTAMOBILE":return ae.error(error_not_a_mobile());case"RATELIMIT":return ae.error(eA("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-form").submit()}}})(this),onFailure:(function(fl){return function(fm){return ae.error(fl.error500())}})(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},enable_resend_phone_code:function(T){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(fl){return function(fm){switch(fm.responseText.strip()){case"OK":fl.hide_error();return fl.notify_resent();case"UNREACHABLE":return fl.show_error_unreachable();case"BADCARRIER":return fl.show_error_bad_carrier();case"INVALIDNUMBER":return fl.show_error_invalid_number();case"NOTAMOBILE":return fl.show_error_not_a_mobile();case"RATELIMIT":return ae.error("You've asked for too many SMS messages. Please try again in a few minutes.");case"EXPIRED":fl._current_flow.to_state("password");return fl.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},DEFAULT_ENABLE_TITLE:eA("Enable two-step verification"),DEFAULT_EDIT_TITLE:eA("Edit two-step verification"),DEFAULT_DISABLE_TITLE:eA("Disable two-step verification"),ADD_BACKUP_TITLE:eA("Add a backup phone number"),EDIT_BACKUP_TITLE:eA("Edit backup phone number"),EDIT_RECOVERY_TITLE:eA("View recovery code"),ADD_SECURITY_KEY_TITLE:eA("Add security key"),LOCK_ICON:"lock32",ENABLE_CONFIRM_HREF:"/account/twofactor/confirm_password",DISABLE_CONFIRM_HREF:"/account/twofactor/disable_confirm_password",EDIT_CONFIRM_HREF:"/account/twofactor/edit_confirm_password",ADD_SECURITY_KEY_START_HREF:"/account/twofactor/u2f_start_registration",ADD_SECURITY_KEY_FINISH_HREF:"/account/twofactor/u2f_finish_registration",RECOVERY_CODE_HREF:"/account/twofactor/get_rescue_code",NEW_RECOVERY_CODE_HREF:"/account/twofactor/new_rescue_code",enter_password_shown:function(){var T;this.hide_error();bE("#twofactor-recovery").removeClass("edit-mode");T=$("twofactor-enter-password");bE("#password",T).val("").focus();return false},submit_password:function(fm,fp,T,fn,fo){var fl;fl=$("password").getValue();if(!fl){this.show_error(eA("Please enter your password"));return}this.show_loading();return new Ajax.DBRequest(fm,{parameters:{password:fl},onSuccess:(function(fq){return function(fr){var fs;fs=fr.responseText.strip();if(fs.startsWith("OK:")){fq._checkpoint_token=fs.substr(3);return fp(T,fn)}else{switch(fs){case"EXPIRED_PASSWORD":return fq.show_error_expired_password();case"INVALID":return fq.show_error(eA("Invalid password"));case"RATELIMIT":return fq.show_error(eA("Too many incorrect passwords. Please try again in a few minutes."));case"ALREADY_ENABLED":$("twofactor-row").addClassName("twofactor-enabled");ae.success(eA("Two-step verification is already enabled. Did you maybe enable it in another window?"));return fc.hide();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");ae.success(eA("Two-step verification is already disabled. Did you maybe disable it in another window?"));return fc.hide()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fetch_offline_key:function(T,fl){this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,offline:true},onSuccess:(function(fm){return function(fn){var fo;fo=fn.responseText.strip();if(fo.startsWith("OK:")){fm.fill_key(fo.substr(3));return fl.next()}else{switch(fo){case"EXPIRED":T.to_state("password");return fm.show_error_expired()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_key:function(fl){var T,fn,fm;fl=fl.replace(new RegExp("=+$"),"");T=fl.toLowerCase().replace(/(.{4})/g,"$1 ");$("secret-div").__date(T);$("qr-div").__date();fm=Constants.IS_PROD?"Dropbox":"DropboxDev";fn={text:"otpauth://totp/"+fm+":"+this._user.email+"?secret="+fl+"&issuer="+fm,width:200,height:200};if(!Modernizr.canvas){fn.render="table"}bE("#qr-div").qrcode(fn);if(!Modernizr.canvas){return bE("#qr-div > table").css("margin","0 auto")}},submit_phone_number:function(fl,fn,fo){var T,fm;T=bE("#twofactor-enter-phone .twofactor-phone-number");if(!B.controller(T).validate_on_submit()){return}fm=T.val();this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,phone_number:fm},onSuccess:(function(fp){return function(fq){switch(fq.responseText.strip()){case"OK":fp._phone_number=fm;fl.vars.phone_number=fm;return fn.next();case"EXPIRED":fl.to_state("password");return fp.show_error_expired();case"UNREACHABLE":return fp.show_error_unreachable(T);case"BADCARRIER":return fp.show_error_bad_carrier(T);case"INVALIDNUMBER":return fp.show_error_invalid_number(T);case"NOTAMOBILE":return fp.show_error_not_a_mobile(T);case"RATELIMIT":return fp.show_error(eA("You've added too many phone numbers. Please try again in a few minutes."))}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},submit_phone_code:function(T,fl,fn){var fm;fm=$("phone-code").getValue().strip();if(!fm){this.show_error(eA("Please enter the security code"));return}if(fm.search(/^\d{6}$/)===-1){this.show_error(eA("Invalid security code"));return}this.show_loading();return new Ajax.DBRequest("/account/twofactor/confirm_phone",{parameters:{checkpoint_token:this._checkpoint_token,twofactor_code:fm},onSuccess:(function(fo){return function(fq){var fp,fs,fr;fr=fq.responseText.strip();if(fr.startsWith("OK:")){fp=[fr.substr(3)];fo.fill_recovery_codes(fp,"backup-code-div");return fl.next()}else{switch(fr){case"INVALID":fo._invalid_code_count+=1;fs=fo._invalid_code_count<=2?eA("Invalid code"):fo._is_offline_setup?eA("Invalid code. Check the clock on your phone: it must be accurate to the minute."):eA("Invalid code");return fo.show_error(fs);case"EXPIRED":T.to_state("password");return fo.show_error_expired();case"RATELIMIT":return fo.show_error(eA("Too many invalid codes. Try again in a few minutes."))}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},enter_backup_phone_number_shown:function(fn,fl){var fm,T;this.hide_error();fm=$("twofactor-enter-backup-phone");T=this.fill_phone_number_for_edit(fm,bE("#twofactor-row-"+this._user.role+" #twofactor-backup-number").text());T.focus();if(fn==="back_next"){bE("#twofactor-backup-back-next").show();bE("#twofactor-backup-cancel-save").hide();return bE("#twofactor-backup-back-save").hide()}else{if(fn==="cancel_save"){bE("#twofactor-backup-back-next").hide();bE("#twofactor-backup-cancel-save").show();return bE("#twofactor-backup-back-save").hide()}else{if(fn==="back_save"){bE("#twofactor-backup-back-next").hide();bE("#twofactor-backup-cancel-save").hide();return bE("#twofactor-backup-back-save").show()}}}},submit_backup_phone_number:function(fo,fn,fl,fp,fq){var T,fm;T=bE("#twofactor-enter-backup-phone .twofactor-backup-phone-number");if(!B.controller(T).validate_on_blur()){return}fm=T.val();if(fm){if(this.is_primary_number(fm)){B.controller(T).show_error(eA("You can't use your primary phone as your backup",T));return}}else{if(fo){B.controller(T).show_error(eA("Please enter phone number",T));return}}this._backup_phone=fm;if(fn==="save_backup_phone"){this.save_added_backup_phone(fl,fo,fm)}else{if(fn==="save_everything"){this.submit_finish(false,fl,fp,fq)}else{if(fn==="save_none"){return fp.next()}}}},is_same_phone_number:function(fl,T){if(!fl||!T){return false}return fl.replace(/\D+/g,"")===T.replace(/\D+/g,"")},is_primary_number:function(T){var fl;fl=bE("#twofactor-row-"+this._user.role);if(this._is_offline_setup){return false}if(this.is_same_phone_number(T,fl.data("primary_phone"))){return true}if(this.is_same_phone_number(T,bE("#twofactor-sms-number",fl).text())){return true}return false},save_added_backup_phone:function(T,fm,fl){this.show_loading();return new Ajax.DBRequest("/account/twofactor/set_backup_phone",{parameters:{checkpoint_token:this._checkpoint_token,backup_phone_number:fl},onSuccess:(function(fn){return function(fo){var fp;switch(fo.responseText.strip()){case"OK":fn.hide_error();fp="#twofactor-row-"+fn._user.role;bE(""+fp+" #twofactor-backup-number").text(fl);bE(fp).toggleClass("with-backup",!!fl);if(!fl){ae.success(eA("Backup phone number removed"))}else{if(!fm){ae.success(eA("Backup phone number updated"))}else{ae.success(eA("Backup phone number added"))}}return fc.hide();case"EXPIRED":T.to_state("password");return fn.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_phone_number_for_edit:function(fn,fp){var fo,fl,fm,T;fl=bE("input.text-input-input",fn);if(!fp){return fl.val("")}T=bE('select[name="country_code"]',fn);fo=/^\+\d+/.exec(fp);fo=fo?fo[0]:"";fm=this.option_for_country_code(T,fo);if(fm!=null){fm.selected=true}fl.val(bE.trim(fp.slice(fo.length)));if(fl.length){fl[0].select()}bE("#twofactor-backup-back-save").find("#skipstep").hide();bE(".text-input-wrapper").find("label").hide();return fl},option_for_country_code:function(T,fm){var fl;if(fm){fl=bE('option[value="'+fm+'"]',T);if(fl.length>1){fl=fl.filter("[selected]")}if(fl.length){return fl[0]}}return bE("option[selected]",T)[0]},fill_delivery_choice:function(T){bE("#twofactor-delivery-phone-label,#confirm-phone-primary").toggle(!!T);bE("#twofactor-delivery-offline-label").toggle(!T);bE("#confirm-phone-primary-number").text(T);return bE("#twofactor-row-"+this._user.role).data("primary_phone",T)},fill_backup_phone:function(T){bE("#confirm-phone-backup").toggle(!!T);return bE("#confirm-phone-backup-number").text(T)},fill_recovery_code:function(fl,T){fl=fl.toLowerCase().replace(/(.{4})/g,"$1 ");$(T).__sert(fl);return $(T).__sert(new Element("br"))},fill_recovery_codes:function(fp,fn){var fm,fo,fl,T;$(fn).__date("");T=[];for(fo=0,fl=fp.length;fo<fl;fo++){fm=fp[fo];T.push(this.fill_recovery_code(fm,fn))}return T},submit_finish:function(fl,T,fm,fn){var fo;this.show_loading();fo={checkpoint_token:this._checkpoint_token};if(this._backup_phone&&!fl){fo.backup_phone_number=this._backup_phone}return new Ajax.DBRequest("/account/twofactor/enable_finish",{parameters:fo,onSuccess:(function(fp){return function(fq){switch(fq.responseText.strip()){case"OK":fp.successfully_enabled=true;if(T.vars.mode!=="ENABLE"){return fp.after_enabled(T,fm)}else{return fm.next()}break;case"EXPIRED":T.to_state("password");return fp.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},after_enabled:function(fl,fn){var T,fm;this._checkpoint_token=null;this.hide_error();T=bE("#twofactor-row-"+this._user.role);T.toggleClass("with-sms",!!this._phone_number);bE("#twofactor-sms-number",T).text(this._phone_number||"");T.toggleClass("with-backup",!!this._backup_phone);bE("#twofactor-backup-number",T).text(this._backup_phone||"");T.addClass("twofactor-enabled");bE("tr[id^='session_row_']").slice(1).hide();if(fl.vars.mode!=="ENABLE"){fm="/account/#security";ae.success(new fg(eA('Two-step verification updated. Any <a href="%(path)s">existing sessions, devices and apps</a> can still access your Dropbox.').format({path:fm})));return fn!=null?fn.next():void 0}},disable_submit:function(T,fl){this.show_loading();return new Ajax.DBRequest("/account/twofactor/disable",{parameters:{checkpoint_token:this._checkpoint_token},onSuccess:(function(fm){return function(fo){var fn;switch(fo.responseText.strip()){case"OK":fm.successfully_disabled=true;fm._checkpoint_token=null;fn=bE("#twofactor-row-"+fm._user.role);fn.removeClass("twofactor-enabled with-sms with-backup");bE(document).trigger("security-key-manager:UPDATE_KEYS",fm._user.id);bE("#twofactor-sms-number, #twofactor-backup-number",fn).text("");bE("tr[id^='session_row_']").slice(1).hide();ae.success(eA("Two-step verification is now disabled."));return fl.next();case"EXPIRED":T.to_state("password");return fm.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},show_error:function(fm,T){var fl;if(T){B.controller(T).show_error(fm);return}fl=$$(this._error_selector);if(fm===this.error_expired_password()||fm===this.error_unreachable(true)){fl.invoke("update",fm)}else{fl.invoke("__date",fm)}return fl.invoke("show")},show_error500:function(){return this.show_error(this.error_500())},show_error_bad_carrier:function(T){return this.show_error(this.error_bad_carrier(),T)},show_error_invalid_number:function(T){return this.show_error(this.error_invalid_number(),T)},show_error_not_a_mobile:function(T){return this.show_error(this.error_not_a_mobile(),T)},show_error_unreachable:function(T,fl){if(fl==null){fl=false}return this.show_error(this.error_unreachable(fl),T)},show_error_expired:function(T){return this.show_error(this.error_expired(),T)},show_error_expired_password:function(T){return this.show_error(this.error_expired_password(),T)},error_500:function(){return eA("Sorry, an error occurred. Please try again later.")},error_bad_carrier:function(){return eA("Unfortunately, your carrier is not supported at this time.")},error_invalid_number:function(){return eA("That is not a valid phone number.")},error_not_a_mobile:function(){return eA("That phone number does not appear to be a valid mobile number.")},error_unreachable:function(T){if(T==null){T=false}if(T){return eA('We couldn\'t reach your phone number. If this has happened before <a href="https://www.dropbox.com/help/364/">click here</a>.')}else{return eA("We couldn't reach your phone number. Are you sure it's correct?")}},error_expired:function(){return eA("Since it's been a while, please enter your password again.")},error_expired_password:function(){return eA('Your password has expired. Please create a new password <a target="_blank" href="/password_expired">here</a>.')},hide_error:function(){return $$(this._error_selector).invoke("__date")},show_loading:function(){this.hide_error();return $$(this._container_selector).invoke("addClassName","loading")},hide_loading:function(){return $$(this._container_selector).invoke("removeClassName","loading")},is_resending:function(){return $$(this._container_selector)[0].hasClassName("resending")},show_resending:function(){return $$(this._container_selector).invoke("addClassName","resending")},hide_resending:function(){return $$(this._container_selector).invoke("removeClassName","resending")},hide_resending_with_delay:function(){return setTimeout(this.hide_resending.bind(this),3000)},notify_resent:function(){return ae.success(eA("We sent you another code. It may take a few minutes to arrive."))},reset_phone_field:function(fl){var T,fm;T=fl.element();fm=bE(".sick-input",T.form);bE("input",fm).val("").focus();return this.fill_example_phone_number(T,fm)},fill_example_phone_number:function(T,fn){var fm,fl;if(typeof phone_helpers!=="undefined"&&phone_helpers!==null){fm=bE(T).val().substr(1);fl=phone_helpers.get_example_mobile_number(fm);return bE("label",fn).text(eA("Example: ")+fl)}},reset_phone_field_and_backup_country:function(fl){var T;this.reset_phone_field(fl);if(bE("#backup-phone-number").val()===""){T=bE("#twofactor-enter-backup-phone #country-code");T.val(fl.element().getValue());return this.fill_example_phone_number(T,bE(".sick-input",T[0].form))}}};var bV,bK=[].indexOf||function(fm){for(var fl=0,T=this.length;fl<T;fl++){if(fl in this&&this[fl]===fm){return fl}}return -1};bV=D.FileViewRamsCommon={RAMS_FULLSCREEN_TRANSITION_TIME_MSEC:1000,_PDF_PREVIEW_DOMAINS:[fj.DL_DOC_DOMAIN,fj.BLOCK_CLUSTER,fj.PUBSERVER,fj.DL_DOC_USER_CONTENT_DOMAIN],enter_rams_fullscreen:function(T){T.addClass("rams-fullscreen").data("rams-fullscreen",true);return bE(window).resize()},exit_rams_fullscreen:function(T){T.removeClass("rams-fullscreen").removeData("rams-fullscreen");return bE(window).resize()},is_rams_fullscreen_active:function(fl){var T;T=fl.data("rams-fullscreen");return(T!=null)&&T},_isPdfPreviewDomain:function(T){T=T.toLowerCase();return bK.call(this._PDF_PREVIEW_DOMAINS,T)>=0},_supportsNativePrinting:function(T){return T.attr("data-docpreview-pdf-native-print-enabled")==="True"},getNativePrintUrl:function(fm,T,fl){var fn;if(!this._supportsNativePrinting(fl)){return null}if(!this._isPdfPreviewDomain(T)){console.warn("Blocked attempt to load pdf native print for unexpected domain");return null}fn=F.parse("https://"+T+"/nativeprint");fn.updateQuery({file:fm});return fn.toString()}};var m,bK=[].indexOf||function(fm){for(var fl=0,T=this.length;fl<T;fl++){if(fl in this&&this[fl]===fm){return fl}}return -1};m=__PARENT_SCOPE__.FileViewer=INLINE_JS.FileViewer=D.FileViewer={KEY_SCOPE:"fileviewer",_MODAL_FILEINFO:0,_MODAL_PREVIEW:1,MAX_CHECK_LOCK_TRIES:8,_FADE_MSEC:300,file:null,has_preview:false,preview_locked:false,preview_lock_listener:null,modal_type:this._MODAL_FILEINFO,is_loaded:false,has_key_listener:false,preview_status_timeout_obj:null,preview_status_request:null,_non_fullscreen_vert_overflow:null,hiding:false,check_lock_request:null,check_lock_timeout:null,file_locked:false,file_view_mode:aV.FileViewModeType.UNKNOWN,_frameMessenger:null,_cached_browser_window_title:null,annotation_enabled_for_this_revision:true,_preview_flippable_component:null,active_user:null,_pdfLoader:new av(),_is_browse_drag_enabled:null,_file_view_attempts:0,globalPreviewStateModel:new el.Model({state:"closed",file_obj:null}),globalOpenWithWebButtonStateModel:new el.Model({state:"hidden",file_extension:null}),_get_extension:function(fl){var T;T=fl.lastIndexOf(".");return(T===-1?"":fl.substr(T+1))},_get_preview_type_from_extension:function(fm){var fl,T;fl=fm.substring(0,3);if(fl==="rtf"||fl==="odt"){T="doc"}else{if(fl==="pps"){T="ppt"}else{T=fl}}return T},_file_view_mode_is_browse:function(){var T;return T=this.file_view_mode,bK.call(aV.FileViewModeCategories.BROWSE_FILE_VIEW_MODE_TYPES,T)>=0},_file_view_mode_is_shared_or_member_link:function(){var fl,fm,T;fl=aV.FileViewModeCategories;return(fm=this.file_view_mode,bK.call(fl.SHARED_LINK_FILE_VIEW_MODE_TYPES,fm)>=0)||(T=this.file_view_mode,bK.call(fl.MEMBER_LINK_FILE_VIEW_MODE_TYPES,T)>=0)},show:function(fn,T,fm,fl){this._file_view_attempts=0;this._cached_browser_window_title=document.title;return this._setup_and_load.apply(this,arguments)},_setup_and_load:function(fp,fm,fo,fn){var fq,fl,T;if(fo==null){fo={}}fo=bx.defaults(fo,{files:[],force_file_unlocked:true,file_view_mode:aV.FileViewModeType.UNKNOWN,should_focus_comment_input:false,hide_comments:false,hide_restore:false});if(this._is_browse_drag_enabled==null){this._is_browse_drag_enabled=bE.proxy((function(){return !this.shown()}),this)}T=bE("#file-viewer");if(this.hiding){T.finish()}else{if(this.shown()){this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);return}else{T.hide()}}fq=T.find(".file-viewer-comment-container");if(fo.hide_comments){fq.hide()}else{fq.show()}fl=T.find(".restore-button");if(fl.length){if(fo.hide_restore){fl.hide()}else{fl.show()}}this.file=fp;this.active_user=fm;this.flippable_files=this._filterFlippableFiles(fo.files);this.file_view_mode=fo.file_view_mode;this.should_focus_comment_input=fo.should_focus_comment_input;this._start_time=Date.now();if(this.file.preview_type==="download"){window.location.href=this.file.href}else{B.scroll_lock_document();T.css("pointer-events","").fadeIn(this._FADE_MSEC);return this.load(this.file,fo.force_file_unlocked,fn)}},_getFilesToPreloadActivities:function(){var fl,fn,fm,fq,fp,T,fo;fn=[];fl=this.currentFlippableFileIndex();fo=[1,2,3,4,5,6,-1,-2];for(fp=0,T=fo.length;fp<T;fp++){fm=fo[fp];fq=fl+fm;if((0<=fq&&fq<this.flippable_files.length)){fn.push(this.flippable_files[fq])}}return fn},load:function(fm,fp,fl){var T,fo,fn;if(fp==null){fp=false}this.file=fm;document.title=this.file.filename;T=bE("#file-viewer");if(T.data("is-openwith-allowed")==="True"){if(__CONDITIONAL_JS__.OpenWith.file_supported(this.file)){if(fp){this.file_locked=false}else{this.file_locked=true;this.check_lock()}}}bE(document.activeElement).blur();this._render_viewer();fn=this.modal_type===this._MODAL_FILEINFO;fo=this._getFilesToPreloadActivities();return bE("#file-viewer").trigger("db:filepreview:open",[this.file,this.file_view_mode,this.active_user.id,this.should_focus_comment_input,fn,fl,fo])},_filterFlippableFiles:function(fl){var T;return(function(){var fo,fn,fm;fm=[];for(fo=0,fn=fl.length;fo<fn;fo++){T=fl[fo];if(d4.isFlippable(T.preview_type)){fm.push(T)}}return fm})()},currentFlippableFileIndex:function(){var fm,fl,fo,T,fn;fn=this.flippable_files;for(fl=fo=0,T=fn.length;fo<T;fl=++fo){fm=fn[fl];if(this.file.sjid===fm.sjid){return fl}}return -1},cancel_check_lock:function(){this.file_locked=false;if(this.check_lock_request!=null){this.check_lock_request.abort();this.check_lock_request=null}if(this.check_lock_timeout!=null){clearTimeout(this.check_lock_timeout);return this.check_lock_timeout=null}},check_lock:function(){var fn,fm,fq,T,fr,fo,fl,fp;if(this.check_lock_request!=null){return}this.check_lock_timeout=null;fn=0;T=this.active_user.id;fq=this.file.fq_path;fm=1000;fp=(function(fs){return function(){fn++;if(fn<fs.MAX_CHECK_LOCK_TRIES){if(fn===2){INLINE_JS.Notify.warning(eA("Office Online is saving your file."))}else{if(fn===5){INLINE_JS.Notify.warning(eA("Office Online is taking longer than expected to save. ",+"Your changes are safe and will eventually be saved to Dropbox."))}}fs.check_lock_timeout=setTimeout(fr,fm);return fm=fm*2}else{clearTimeout(fs.check_lock_timeout);fs.check_lock_request=null;fs.file_locked=false;return fs._render_preview(true,true)}}})(this);fl=(function(fs){return function(ft){ft=JSON.parse(ft);if(ft!=null?ft.has_lock:void 0){return fp()}else{fs.check_lock_request=null;fs.file_locked=false;return fs._render_preview(true,true)}}})(this);fo=function(fu,fs,ft){return fp()};fr=(function(fs){return function(){return fs.check_lock_request=cC.WebRequest({url:"/ow/msft/check_lock",data:{user_id:T,fq_path:fq},success:fl,error:fo})}})(this);return fr()},shown:function(){return bE("#file-viewer").css("display")!=="none"},clear_preview_url_timer:function(){if(this.previewUrlTimer!=null){return clearTimeout(this.previewUrlTimer)}},set_preview_url_w_timeout:function(){this.clear_preview_url_timer();return this.previewUrlTimer=setTimeout((function(T){return function(){return T.set_preview_url()}})(this),250)},set_preview_url:function(){var fm,fl,T;fm=F.parse(eD.get_url());fl=fm.getPath();T=fm.removeQuery("select").updateQuery({preview:this.file.filename}).getQuery();return eD.push_state(F.encode_parts(fl),T,{immediatelyRestoreState:false})},unset_preview_url:function(){var fm,fl,T;this.clear_preview_url_timer();fm=F.parse(eD.get_url());if(!this._file_view_mode_is_shared_or_member_link()&&(fm.getPath().match(/^\/s[h]?\/.+/)||!this._file_view_mode_is_browse())){return}if(!("preview" in fm.getQuery())){return}fl=fm.getPath();T=fm.removeQuery("select").removeQuery("preview").getQuery();return eD.push_state(F.encode_parts(fl),T)},render_file_failed:function(){var T,fl;fl=this.file;T=this.active_user;this._teardown_and_hide();fl.doc_preview_status=Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE;this._setup_and_load(fl,T,{files:this.flippable_files,force_file_unlocked:!this.file_locked,file_view_mode:this.file_view_mode,should_focus_comment_input:this.should_focus_comment_input});bE("#file-viewer").show();return bE("#file-viewer").trigger("preview_failed")},_log_view:function(T,fl,fn){var fm;if(fn==null){fn=aV.FileViewModeType.FILE_PREVIEW}this._file_view_attempts++;fm={user_id:this.active_user.id,context:aV.FileViewContextType.PRIVATE,platform:aV.FileViewPlatformType.WEB,ns_id:this.file.ns_id,sjid:this.file.sjid,ns_path:this.file.ns_path,shared_link_url:null,extra:{mode:fn,file_ext:ay.file_extension_for_logging(this.file.filename),file_bytes:this.file.bytes,file_mtime:this.file.ts,preview_type:this.file.preview_type,preview_status:this.file.doc_preview_status,time_taken:T,in_progress:fl,is_team:this.active_user.is_team===1,paid:this.active_user.paid===1,file_view_attempts:this._file_view_attempts}};return ba.FileViewLogger.log(fm)},preload_office_static:function(fl){var fn,fm,T;if(__CONDITIONAL_JS__.OpenWith.PRELOAD_URLS==null){return}fm=this._get_extension(fl);if(fm in __CONDITIONAL_JS__.OpenWith.PRELOAD_URLS){fn=bE("#file-viewer .open-with-static-content-container");T=bE("<iframe/>",{src:__CONDITIONAL_JS__.OpenWith.PRELOAD_URLS[fm]});return fn.html(T)}},unload_office_static:function(){var T;T=bE("#file-viewer .open-with-static-content-container");return T.empty()},_render_viewer:function(){var fs,fl,fv,fw,fn,fy,T,fx,fu,fz,fr,fm,fo,ft,fq,fp;fl=bE("#file-viewer");fs=fl.find(".download-button");fw=F.parse(this.file.href).updateQuery({dl:1}).toString();this.preload_office_static(this.file.filename);ft=(function(fA){return function(fH){var fD,fF,fC,fE,fG,fB;if(fH==null){fH=true}fC=bU.em_snippet(fA.file.filename,35);fD=fl.find(".title-bar .filename");fG={"class":"icon",alt:fA.file.caption};fE=cv.html("web",fA.file.icon,fG).toHTML();fF=bE("<span />",{"class":"filename-text"}).text(fC);fD.html(fE).append(fF);fl.addClass("has-preview");if(fA.file.htmlified_link){fl.addClass("htmlified-preview")}else{if(fA.file.preview_type==="excel"){fl.addClass("html-preview");fl.find(".loading").css("z-index","-1")}else{fl.addClass(""+fA.file.preview_type+"-preview")}}if(fH){fl.find(".loading").show()}fs.on("click",function(fI){fI.preventDefault();return window.location.href=fw});if(fA.file.tkey===void 0&&m.active_user.is_email_verified){fB=function(fI){this.file.tkey=fI.tkey;return this._update_title_bar_buttons()};cC.WebRequest({url:"/sm/get_token",type:"POST",data:{path:fA.file.fq_path},dataType:"json",subject_user:fA.active_user.id,success:fB.bind(fA)})}else{fA._update_title_bar_buttons()}fA.modal_type=fA._MODAL_PREVIEW;fA._first_render_completed=false;return fA._listen()}})(this);fy=(function(fA){return function(){fl.removeClass();fl.find(".loading").hide();return fA._unlisten()}})(this);fo=(function(fA){return function(fB,fG,fE,fD,fC){var fF;if(fB==null){fB=false}if(fG==null){fG=true}if(fE==null){fE=false}if(fD==null){fD=false}if(fC==null){fC=true}fA._log_view(Date.now()-fA._start_time,fD,aV.FileViewModeType.FILE_PREVIEW);fF=fA._get_extension(fA.file.filename);if(fF==="doc"||fF==="docx"||fF==="odt"||fF==="ppt"||fF==="pptx"||fF==="xls"||fF==="xlsx"||fF==="pdf"||fF==="eps"||fF==="ai"||fF==="psd"||fF==="svg"||fF==="txt"||fF==="rtf"||fF==="pspimage"||fF==="tif"||fF==="tiff"||fF==="yuv"||fF==="url"||fF==="webloc"||fF==="website"){fA.globalPreviewStateModel.set({state:"open",file_obj:fA.file})}if(!fB){ft(fG);fA._update_title_bar_buttons()}fA._render_preview(fE,fC);return fA._initial_resize()}})(this);fm=(function(fA){return function(fC){var fB,fE,fF,fD;if(fC==null){fC=false}fB=fA.file.filename.indexOf(".");fE=fA.file.filename.substring(fB+1);if(fE==="key"&&fA.file.preview_type===null){fD="/static/images/icons128/"+(ay.file_icon("_other"))+".png"}else{fD="/static/images/icons128/"+(ay.file_icon(fA.file.filename))+".png"}fA.globalPreviewStateModel.set({state:"closed",file_obj:null});fF=bU.em_snippet(fA.file.filename,20);fl.find(".title-bar .filename").text(fF);fl.addClass("no-preview");fl.find(".file-thumbnail img").attr({src:fD});fl.find(".file-type").text(fF);fl.find(".file-size").text(fA.file.size);fl.find(".file-modified").text(fA.file.ago||"");fs.on("click",function(){return b1.unsafeRedirect(fw)});fA.modal_type=fA._MODAL_FILEINFO;fA._listen();fA._log_view(Date.now()-fA._start_time,fC,aV.FileViewModeType.FILE_INFO);fA._update_title_bar_buttons();return fA._initial_resize()}})(this);fn=this._get_extension(this.file.filename);fz=((fp=this.file.preview_type)==="doc"||fp==="excel"||fp==="keynote"||fp==="adobecs"||fp==="linkfile")&&(this.file.bytes<Constants.MAX_PDF_FILE_SIZE_B||ay.file_extension(this.file.filename).toLowerCase()!=="pdf")&&!b1.msie_version_at_most(9);fr=this._is_saveas_experiment_enabled()&&ay.file_extension(this.file.filename).toLowerCase()!=="pdf";this.has_preview=d4.isFlippable(this.file.preview_type)||(this.file.preview_type==="text"&&this.file.bytes<Constants.MAX_TEXT_FILE_SIZE_B)||(this.file.preview_type==="html"&&"sandbox" in document.createElement("iframe"))||(this.file.preview_type==="linkfile")||((fz&&this.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE)&&(!this.file_locked&&!fr));T=fz&&this._preview_progressive_try(fn)&&this.file.doc_preview_status!==Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE&&!this.file_locked;if(this.has_preview||T){return fo(false,!(this.file.preview_type==="doc"),false,false,this.has_preview)}fx=this.file_locked||(fz&&this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS);if(!fx){return fm()}ft();fu=F({path:"/doc_preview_status"+this.file.fq_path}).toString();fq=Date.now();return(fv=(function(fA){return function(){var fB;fB=Date.now();if(fB-fq>=5000){setTimeout(bE.proxy(fA.render_file_failed,fA),0);return}return fA.preview_status_request=bE.ajax(fu,{success:function(fC){if(fA.file){return fA.file.doc_preview_status=parseInt(fC,10)}},complete:function(fC,fD){if(fD==="abort"){return}if(fA.file_locked){return}if(fA.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE){fA.has_preview=true;return fo(true,false,true,true)}else{if(fA.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return fA.preview_status_timeout_obj=setTimeout(fv,1000)}else{fA.render_file_failed()}}},timeout:5000-(fB-fq),subject_user:fA.active_user})}})(this))()},switch_preview:function(fl,fn,fp){var fo,fm,T;if(fl!=null){if(this.file!=null){this.annotation_enabled_for_this_revision=fn;this.file.href=fl;fm=bE("#file-viewer .preview-content-container");T="";fm.html(T);this._render_preview(false,true);fo=fm.find("iframe");if(fo.length>0){return fo.on("load",fp)}}}},_remove_loading:function(T){var fl;if(T==null){T=true}fl=bE("#file-viewer .loading");fl.hide();fl.css("z-index","");return this.is_loaded=T},_render_blank:function(){var fl,T;fl=bE("#file-viewer .preview-content-container");T=dA.createElement(G,{icon:this.file.icon,filename:this.file.filename,created:new Date(this.file.ts*1000),size:this.file.size});return dA.render(T,fl.get(0))},_render_linkfile:function(){var fl,T;fl=bE("#file-viewer .preview-content-container");T=dA.createElement(R,{filename:this.file.filename,source:"browse","authenticated-data-link":true});return dA.render(T,fl.get(0))},_update_title_bar_buttons:function(){var fn,fm,ft,fD,fz,fs,fH,fu,fv,fq,fo,T,fB,fr,fp,fF,fG,fy,fC,fE,fI,fx,fA,fw,fl;fs=bE("#file-viewer");fz=fs.find(".share-button");if(this._file_view_mode_is_shared_or_member_link()){fz.remove()}fn=fs.find(".download-button");fm=fs.find(".split-button.openwith");fD=fm!=null?fm.find(".main-button"):void 0;ft=fm!=null?fm.find(".more-button"):void 0;fH=eA("Open",{comment:"Open a file natively on the user's computer"});fA=function(){return fs.data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)};fx=(function(fJ){return function(fL){var fM,fK;return fs.data("is-openwith-allowed")==="True"&&((fM=__CONDITIONAL_JS__.OpenWith)!=null?fM.get_open_handler_for(fL,fJ.active_user):void 0)&&fL.bytes<((fK=__CONDITIONAL_JS__.OpenWith)!=null?fK.MAX_SUPPORTED_FILE_SIZE_B:void 0)&&fL.doc_preview_status!==Constants.DOC_PREVIEW_UNAVAILABLE_PROTECTED_DOC}})(this);fF=(function(fJ){return function(fK){return __CONDITIONAL_JS__.UnityFeatures.open_file(fJ.file.ns_id,fJ.file.ns_path,fJ.file.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(fL){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)},fK)}})(this);fr=function(){return fF(false)};fp=function(){return fF(true)};fG=(function(fJ){return function(){var fL,fK,fM;fL=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(fJ.file,fJ.active_user);if(fL){if((fM=__CONDITIONAL_JS__.OpenWithMicrosoftLogger)!=null){fM.log_open_button_pressed(fJ.active_user.id,ay.file_extension(fJ.file.filename).toLowerCase(),fJ.file.ns_id,fJ.file.ns_path)}fK=fL.uri+"?hpt_click_ts="+Date.now();return b1.redirect(fK)}}})(this);fI=(function(fJ){return function(fR,fS,fK){var fO,fN,fT,fM,fL,fV,fP,fQ,fU;fU=[];fP=fS!=null;if(fP&&(fS.can_open_directly||(fS.can_open_directly==null))){fO=fS.open_application_name||eA("Open");fQ=eA("Desktop");if(__CONDITIONAL_JS__.UnityFeatures.client_supports_open_in_file_browser()){fQ=eA("Open in %(app_name)s").format({app_name:fO})}fU.push({id:"ow_desktop",label:fQ,icon:"ow_desktop",callback:fr})}if(fR){fV=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(fJ.file,fJ.active_user);fU.push({id:"ow_web",label:fV.name,icon:fV.icon,callback:fG})}if(fP&&__CONDITIONAL_JS__.UnityFeatures.client_supports_open_in_file_browser()){fL=fS.file_browser_display_name||eA("File Browser");fQ=eA("Show in %(file_browser)s").format({file_browser:fL});if(fP&&!fS.can_open_directly&&!fR){fH=fQ}fU.push({id:"ow_folder",label:fQ,icon:"ow_folder",callback:fp})}fy(fH,fU);if(!fR&&!fP){fT=false}else{if(fP){fT=false}else{fT=true}}if(!fT&&!fK){fJ._hide_more_button()}else{fJ._show_more_button(fK,fT)}fN=function(fW,fY,fZ,fX){if(fJ._open_button_update_state_timeout){clearTimeout(fJ._open_button_update_state_timeout)}return fJ._open_button_update_state_timeout=setTimeout((function(){fJ.globalOpenWithWebButtonStateModel.set({user_id:fW,state:fY,file_extension:fZ,target_button:fX});return fJ._open_button_update_state_timeout=null}),200)};if(fR){fM=ay.file_extension(fJ.file.filename).toLowerCase();if(fP){return fN(fJ.active_user.id,"visible",fM,ft)}else{return fN(fJ.active_user.id,"visible",fM,fD)}}else{return fN(null,"hidden",null,null)}}})(this);fC=function(fJ){if(fm!=null){fm.toggleClass("shown",fJ)}return fn.toggle(!fJ)};fy=function(fK,fJ){if(!(fJ instanceof Array)){fJ=[fJ]}if(fJ.length===0){return fC(false)}else{if(fJ.length===1){return fq(fK,fJ[0].callback)}else{return fo(fK,fJ)}}};fq=function(fJ,fK){if((fm==null)&&(fD==null)){return}fC(true);fm.removeClass("split");fD.text(fJ);return fD.off("click").on("click",fK)};fo=function(fN,fJ){var fM,fL,fP,fO,fK;if((fm==null)&&(fD==null)&&(ft==null)){return}fC(true);fm.addClass("split");fD.text(fN);fM=fs.find(".openwith-dropdown");fD.off("click").on("click",function(fQ){return fJ[0].callback(fQ)});ft.off("click").on("click",function(fR){var fQ;fQ=bE(this).parent().siblings(".openwith-dropdown");if(fQ.is(":visible")){return}fQ.removeAttr("style");eU.show(fQ,this,null,true);return fR.stopPropagation()});fM.find("li").hide();fP=function(fQ){var fR;fR=fM.find("."+fQ.id);fR.find("a .sprite-text-inner").text(fQ.label);cv.src(fR.find("a .sprite")[0],"web",fQ.icon);fR.find("a").off("click").on("click",function(fS){fS.preventDefault();return fQ.callback(fS)});return fR.show()};for(fO=0,fK=fJ.length;fO<fK;fO++){fL=fJ[fO];fP(fL)}return bE("#file-viewer-container").off("click",eU.hide_all).on("click",eU.hide_all)};fE=!!fA();fu=!!fx(this.file);fv=!!this.file.tkey;fI(fu,null,fv);if(fE){T=function(fJ){var fK;fK=function(fL){fJ.file_browser_display_name=fL;return fI(fu,fJ,fv)};return __CONDITIONAL_JS__.UnityFeatures.file_browser_display_name(fK,fK)};if((fw=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fw.is_cached_and_locally_available(this.file.ns_id,this.file.ns_path):void 0){return T((fl=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fl.get(this.file.ns_id,this.file.ns_path):void 0)}else{fB=function(fJ){if(fJ.is_locally_available){return T(fJ)}};return __CONDITIONAL_JS__.UnityFeatures.check_file(this.file.ns_id,this.file.ns_path,this.file.user_id,fB)}}},_show_more_button:function(fq,fl){var fo,fp,fm,fn,T;T=bE("#file-viewer");fo=T.find(".more-options-button");fo.show();fm=T.find(".more-options-dropdown");fo.on("click",function(fr){if(fm.is(":visible")){return}eU.show(fm,fo,null,true);return fr.stopPropagation()});bE("#file-viewer-container").on("click",eU.hide_all);fn=fm.find(".remove-link");fn.off("click");if(fq){fn.show();fn.on("click",(function(fr){return function(fs){eU.hide_all();return aj.confirm_remove(fr.file.filename,fr.file.tkey,0,0,0,fr.file.user_id)}})(this))}else{fn.hide()}fp=fm.find(".download-button");return fp.toggle(fl)},_hide_more_button:function(){var fl,T;T=bE("#file-viewer");fl=T.find(".more-options-button");fl.off("click").hide();bE("#file-viewer-container").off("click",eU.hide_all);return T.find(".remove-link").off("click")},_initial_resize:function(){var T;if(this.is_loaded){return}T=function(){return bE("window").trigger("resize")};return setTimeout(T,0)},_is_pptx_slim_enabled:function(){return ax.getGandalfRule("docpreview-pptx-slim")},_get_progressive_url:function(fo,fn){var fp,T,fm,fl;fl=this.active_user;fo=this._get_preview_type_from_extension(fo);fm=F.parse(fn);T=false;if((fo==="doc"&&fl.progressive_previews_doc)||(fo==="key")||(fo==="keynote")||(fo==="adobecs")){if(!(Constants.PDF_PREVIEW_MODE==="pdf-js")){fm=fm.updateQuery({post_message_on_failure:1})}}else{if(fo==="ppt"&&fl.progressive_previews_ppt&&!this._is_pptx_slim_enabled()){fp="private_progressive_viewer";T=true}else{if(fo==="xls"&&fl.progressive_previews_xls){if(fl.xls_edit){fp="xls/edit"}else{fp="xls/preview"}}}}if(fp){if(T){fm.setAuthority(Constants.WEBSERVER)}else{fm.setAuthority(fm.getAuthority().replace("dl-web","dl-doc"))}fm.setPath(fm.getPath().replace("/pri/get/","/get/"));fm.setPath(fm.getPath().replace("/get/","/"+fp+"/"))}fm=fm.updateQuery({get_preview:1,rams_ui:this._is_rams_ui()?1:0,saveas:this._is_saveas_experiment_enabled()?1:0});return fm},_get_pdf_js_url:function(T){if(Constants.PDF_PREVIEW_MODE==="pdf-js"){T=F.parse(Constants.static_url_pdfjs_viewer)}return T},_preview_is_progressive:function(fl){var T;fl=this._get_preview_type_from_extension(fl);T=this.active_user;return(fl==="doc"&&T.progressive_previews_doc)||(fl==="ppt"&&T.progressive_previews_ppt)||(fl==="xls"&&T.progressive_previews_xls)||(fl==="key"||fl==="keynote")||(fl==="eps"||fl==="ai")},_preview_progressive_try:function(fl){var fm,T;if(!this._preview_is_progressive(fl)){return false}if(this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return true}fl=this._get_preview_type_from_extension(fl);fm=this.file.doc_preview_status===Constants.DOC_PREVIEW_UNAVAILABLE_FAILED&&((fl==="ppt"&&this.active_user.progressive_previews_ppt_try_failed)||(fl==="doc"&&this.active_user.progressive_previews_doc_try_failed)||(fl==="xls"&&this.active_user.progressive_previews_xls_try_failed)||(fl==="eps"||fl==="ai"));T=fl==="key"||fl==="keynote";return fm||T||this._is_saveas_experiment_enabled()},_set_previews_sandbox_params:function(fl,T){fl=this._get_preview_type_from_extension(fl);if(fl!=="xls"){return""}else{return null}},_prepare_annotation_url:function(T){if(this._is_annotation_marker_enabled()){T=T.updateQuery("annotation_marker","1")}if(this._is_annotation_highlight_enabled()){T=T.updateQuery("annotation_highlight","1")}if(this._is_annotation_region_enabled()){T=T.updateQuery("annotation_region","1")}return T},_render_preview:function(fC,fA){var fl,fq,fs,fB,fx,fm,fD,ft,fz,fr,fE,fG,fy,T,fw,fv,fp,fn,fF,fu,fo;if(fC==null){fC=false}if(fA==null){fA=true}if(fC){this._remove_loading(false)}fy=bE("#file-viewer .preview-content-container");if(fy.find("iframe").length>0){return}if(this.file.htmlified_link){ft=bE("<iframe/>",{src:this.file.htmlified_link});fy.append(ft);return ft.on("load",this._remove_loading)}else{if(this.file.preview_type==="doc"){fs=this._get_extension(this.file.filename);fq=this._get_preview_type_from_extension(fs);if(fq==="ppt"&&!this._is_pptx_slim_enabled()){fp=this._get_progressive_url(fs,this.file.href);ft=bE("<iframe/>",{src:fp.toString(),allowfullscreen:"",type:"application/pdf"});fy.append(ft)}else{if(ax.getGandalfRule("security-primodel")){fp=this._get_progressive_url(fs,this.file.direct_blockserver_link)}else{fp=this._get_progressive_url(fs,this.file.href)}if(this.active_user.inline_commenting){bE("#file-viewer-container").css({marginLeft:"0",width:"90%",left:"5%"});fp.setAuthority(fp.getAuthority().replace("dl-web","dl-doc"));fp.setPath(fp.getPath().replace("/get/","/dochax_private_commentless_preview/"));fx=fp.toString();fp=F.parse(Constants.static_url_pdfjs_hack_viewer);fp.setQuery({file:fx})}else{if(!fA){fp=fp.updateQuery({generate_preview:1});fp.setAuthority(fp.getAuthority().replace("dl-web","dl-doc"))}fE=fq==="ppt"&&this._is_pptx_slim_enabled();this._pdfLoader.openFile(fp,{presentationMode:fE});fp=this._get_pdf_js_url()}fp=fp.updateQuery(Constants.UID_PARAM_NAME,this.active_user);fp=this._prepare_annotation_url(fp);ft=bE("<iframe/>",{src:String(fp),type:"application/pdf"});ft.addClass("pdfjs");fy.append(ft)}return ft.on("load",this._remove_loading)}else{if(this.file.preview_type==="html"){ft=bE("<iframe/>",{src:this.file.href,sandbox:""});fy.append(ft);return ft.on("load",this._remove_loading)}else{if(this.file.preview_type==="excel"){if(ax.getGandalfRule("security-primodel")){fp=this._get_progressive_url("xls",this.file.direct_blockserver_link)}else{fp=this._get_progressive_url("xls",this.file.href)}ft=bE("<iframe/>",{src:fp,type:"application/pdf"});this._set_previews_sandbox_params("xls",ft);fy.append(ft);return ft.on("load",this._remove_loading)}else{if(this.file.preview_type==="keynote"){fp=this._get_progressive_url("html",this.file.href);fp=fp.updateQuery({generate_preview:1});fp=fp.updateQuery({post_message_on_failure:1});ft=bE("<iframe/>",{src:fp,type:"text/html"});fy.append(ft);return ft.on("load",this._remove_loading)}else{if(this.file.preview_type==="adobecs"){if(ax.getGandalfRule("security-primodel")){fp=this._get_progressive_url("adobecs",this.file.direct_blockserver_link)}else{fp=this._get_progressive_url("adobecs",this.file.href)}fp=fp.updateQuery({generate_preview:1});this._pdfLoader.openFile(fp);fp=this._get_pdf_js_url();fp=fp.updateQuery(Constants.UID_PARAM_NAME,this.active_user);fp=this._prepare_annotation_url(fp);ft=bE("<iframe/>",{src:String(fp),type:"application/pdf"});ft.addClass("pdfjs");fy.append(ft);return ft.on("load",this._remove_loading)}else{if(this.file.preview_type==="linkfile"){this._remove_loading();return this._render_linkfile()}else{fl=this.currentFlippableFileIndex();fB=this._get_extension(this.file.filename);if(d4.isFlippable(this.file.preview_type)){bE("#file-viewer .loading").css("z-index","1");if(this.file.preview_type==="video"){fw=typeof this.file.video_transcode_url==="string"?this.file.video_transcode_url:this.file.fq_path!=null?bt.video_transcode_url(this.file.fq_path,this.file.hash,this.active_user):void 0;fv=this.file.thumbnail_url_tmpl}else{if(this.file.preview_type==="photo"&&!(fB==="gif"&&this.file.bytes>Constants.MAX_GIF_FILE_SIZE_B)){if(fB==="gif"){fv=this.file.href}else{fv=this.file.thumbnail_url_tmpl}fz=[];fu=[1,2,3,4,5,6,-1,-2];for(fn=0,fF=fu.length;fn<fF;fn++){fD=fu[fn];fr=fl+fD;if(0<=fr&&fr<this.flippable_files.length){fz.push(this.flippable_files[fr].thumbnail_url_tmpl)}}}}fm={"preview-type":this.file.preview_type,"preview-url":fw,"thumbnail-url-tmpl":fv,"file-extension":fB,"file-meta":{filename:this.file.filename,mtime:this.file.ts,formattedSize:this.file.size},imagesToPreload:fz,index:fl,count:this.flippable_files.length,onPrevious:(function(fH){return function(){return fH.loadPreviousFlippable()}})(this),onNext:(function(fH){return function(){return fH.loadNextFlippable()}})(this),onLoad:(function(fH){return function(){fH._remove_loading()}})(this),onError:(function(fH){return function(){fH._remove_loading()}})(this)};if((fo=this._preview_flippable_component)!=null?fo.isMounted():void 0){fG=this._preview_flippable_component.props;return this._preview_flippable_component.setProps(fm)}else{T=dA.createElement(d4,fm);return this._preview_flippable_component=dA.render(T,fy.get(0))}}else{return this._render_blank()}}}}}}}}},post_preview_message:function(fs){var fr,fo,fp,ft,fl,T,fn,fq,fm;fp=bE("#file-viewer .preview-content-container iframe");fm=[];for(fn=0,fq=fp.length;fn<fq;fn++){fo=fp[fn];T=fo.src;fl="://";ft=T.indexOf(fl);if(ft===-1){fr=T.indexOf("/")}else{fr=T.indexOf("/",ft+fl.length)}if(fr!==-1){T=T.substring(0,fr)}fm.push(fo.contentWindow.postMessage(fs,T))}return fm},notify_preview_sfj:function(){if(this.file_locked){this.cancel_check_lock();this._render_preview(true,false)}return m.post_preview_message('{"action":"notify_sfj"}')},loadPreviousFlippable:function(){var T;if(d4.isFlippable(this.file.preview_type)&&this.currentFlippableFileIndex()>0){this.load(this.flippable_files[this.currentFlippableFileIndex()-1]);this.set_preview_url();T=this._getFilesToPreloadActivities();return bE("#file-viewer").trigger("db:filepreview:prev",[this.file,this.file_view_mode,this.active_user.id,T])}},loadNextFlippable:function(){var T;if(d4.isFlippable(this.file.preview_type)&&this.currentFlippableFileIndex()<this.flippable_files.length-1){this.load(this.flippable_files[this.currentFlippableFileIndex()+1]);this.set_preview_url();T=this._getFilesToPreloadActivities();return bE("#file-viewer").trigger("db:filepreview:next",[this.file,this.file_view_mode,this.active_user.id,T])}},_listen:function(){var fl,T,fm;fl=bE("#file-viewer");this._pdfLoader.startListening();cL.addFileDragEnabledCheck(this._is_browse_drag_enabled);fl.find(".js-close-button").on("click",bE.proxy(this._on_close,this));if(this._file_view_mode_is_browse()){this.sfj_callback_handle=cr.add_subscribe_sfj_callback(m.notify_preview_sfj.bind(this))}if(!this.has_key_listener){key("esc",this.KEY_SCOPE,(function(fn){return function(fo){if(fn.is_rams_fullscreen_active()||B.focus_in_input()||B.is_input(fo.target)){return}return fn._teardown_and_hide()}})(this));key("left",this.KEY_SCOPE,(function(fn){return function(fo){return fn.loadPreviousFlippable()}})(this));key("right",this.KEY_SCOPE,(function(fn){return function(fo){return fn.loadNextFlippable()}})(this));this.has_key_listener=true}this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);if(this.modal_type===this._MODAL_PREVIEW){fl.find(".share-button").on("click",bE.proxy(this._share,this));fm=(function(fn){return function(fo){if(fn.file.fq_path.toLowerCase()===fo.memo.fq_path.toLowerCase()){fn.file.tkey=fo.memo.tkey;return fn._update_title_bar_buttons()}}})(this);T=(function(fn){return function(fo){if(fn.file.tkey===fo.memo.token){fn.file.tkey=null;return fn._update_title_bar_buttons()}}})(this);this.share_link_callback=fm.bind(this);this.remove_link_callback=T.bind(this);document.observe(aF.LINKS_ADD,this.share_link_callback);document.observe(aF.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){fl.find(".share-button").on("click",bE.proxy(this._share,this))}}bE(window).on("resize",bE.proxy(this._resize,this));this.handleMessageFromChild=function(fn){switch(fn.action){case"failed":return m.render_file_failed();case"lock_preview":return m.preview_locked=true;case"unlock_preview":return m.preview_locked=false;case"toggle_preview_lock":return m.preview_locked=!m.preview_locked;case"hide_iframe":return m._teardown_and_hide();case"loaded":return m.post_preview_message('{"action":"listening_sfj"}');case"pagerendered":return m._handle_page_rendered(fn.parameters)}};this._frameMessenger=new ev();this._frameMessenger.configureChildMessaging(".preview-content-container > iframe",bE.proxy(this.handleMessageFromChild,this),["failed","lock_preview","unlock_preview","toggle_preview_lock","hide_iframe","loaded","pagerendered"]);this._frameMessenger.startListening();return window.onbeforeunload=function(fn){if(m.preview_locked){return""}else{return void 0}}},_unlisten:function(){var T;T=bE("#file-viewer");this._pdfLoader.stopListening();T.off("click",bE.proxy(this._teardown_and_hide,this));cL.removeFileDragEnabledCheck(this._is_browse_drag_enabled);T.find("#file-viewer-container").off("click",function(fl){return fl.stopPropagation()});T.find(".js-close-button").off("click",bE.proxy(this._on_close,this));if(this.modal_type===this._MODAL_PREVIEW){T.find(".share-button").off("click",bE.proxy(this._share,this));T.find(".download-button").off("click");bE(document).off("click",eU.hide_all);document.stopObserving(aF.LINKS_ADD,this.share_link_callback);document.stopObserving(aF.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){T.find(".share-button").off("click",bE.proxy(this._share,this))}}bE(window).off("resize",bE.proxy(this._resize,this));key.setScope(this.prev_scope);if(this._file_view_mode_is_browse()){cr.remove_sfj_callback(this.sfj_callback_handle);return this.sfj_callback_handle=null}},_resize:function(fm){var fl,T;if(!this._is_rams_ui()){fl=bE("#file-viewer");T=fl.find("#file-viewer-container").height()-(fl.find(".title-bar").height()+1);fl.find(".preview").height(T);return fl.trigger("height-resize",{height:T})}},_share:function(T){ba.ShmodelUILogger.log("via-browse-file-viewer");T.preventDefault();return new dg(this.active_user.id,this.file.fq_path,"file_viewer").show()},_on_close:function(T){T.preventDefault();return this._teardown_and_hide()},_teardown_and_hide:function(){var T;if(this.hiding){return}this.hiding=true;this.clear_preview_url_timer();this.unload_office_static();this.globalPreviewStateModel.set({state:"closed",file_obj:null});if(this.preview_locked){if(!confirm("You have unsaved changes. Are you sure you want to leave this page?")){return}}if(this.preview_status_timeout_obj){clearTimeout(this.preview_status_timeout_obj);this.preview_status_timeout_obj=null}if(this.preview_status_request){this.preview_status_request.abort();this.preview_status_request=null}if(this._file_view_mode_is_browse()){eX.set_selected_files(this.file)}if(this._file_view_mode_is_browse()||this._file_view_mode_is_shared_or_member_link()){m.unset_preview_url()}B.scroll_unlock_document();T=bE("#file-viewer");return T.css("pointer-events","none").fadeOut({duration:this._FADE_MSEC,always:(function(fl){return function(){var fo,fn,fm;if(fl.is_rams_fullscreen_active()){fl.exit_rams_fullscreen()}if(__CONDITIONAL_JS__.UnityFeatures!=null){fm=eA("Download");fo=T.find(".download-button");fo.text(fm);fo.off("click")}fl._hide_more_button();T.removeClass("has-preview").removeClass("no-preview");fn=T.find(".preview-content-container");dA.unmountComponentAtNode(fn.get(0));fl._preview_flippable_component=null;fn.empty();T.find(".file-thumbnail img").attr({src:""});T.find(".title-bar .filename").text("");T.attr({"class":""});fl._unlisten();fl._remove_loading();document.title=fl._cached_browser_window_title;fl._cached_browser_window_title=null;fl.last_file=fl.file;fl.file=null;fl.preview_locked=false;window.removeEventListener("message",fl.preview_lock_listener);fl.is_loaded=false;fl.hiding=false;fl.cancel_check_lock();T.trigger("db:filepreview:close")}})(this)})},_handle_page_rendered:function(T){var fl,fq,ft,fr,fo,fp,fm,fs,fn;if(!this._first_render_completed){fl=ay.file_extension_for_logging(this.file.filename);fp=T.stats;fr=((fn=this.file)!=null?fn.bytes:void 0)!=null?this.file.bytes:0;fq=bE.extend(T.attributes,{total_time:Date.now()-this._start_time,file_ext:fl,source:"file-viewer",originalSize:fr,docPreviewStatus:this.file.doc_preview_status});for(fm=0,fs=fp.length;fm<fs;fm++){fo=fp[fm];ft=(function(){switch(fo.name){case"Page Request":return"viewer_page_request_time";case"Rendering":return"viewer_rendering_time";case"Overall":return"viewer_overall_time"}})();fq[ft]=fo.end-fo.start}ba.UserActivityLogger.log("web","file_view_first_page_rendered",fq);ba.PreviewActivityLogger.log("file_view_first_page_rendered",{file_ext:fl,extra:JSON.stringify(fq)});return this._first_render_completed=true}},resize:function(){return this._resize(null)},hide:function(){return this._teardown_and_hide()},nativePdfPrint:function(){var fl,fn,T,fm;if(this.file.doc_preview_status!==Constants.DOC_PREVIEW_AVAILABLE||((fm=this.file.preview_type)!=="doc"&&fm!=="ppt"&&fm!=="adobecs")){return false}T=this._get_progressive_url("doc",this.file.href);fl=F.parse(T).getAuthority();fn=bV.getNativePrintUrl(T,fl,bE("#file-viewer"));if(fn==null){return false}window.open(fn,"_blank");return true},_is_annotation_marker_enabled:function(){return bE("#file-viewer").attr("data-docpreview-annotation-marker-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_annotation_highlight_enabled:function(){return bE("#file-viewer").attr("data-docpreview-annotation-highlight-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_annotation_region_enabled:function(){return bE("#file-viewer").attr("data-docpreview-annotation-region-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_saveas_experiment_enabled:function(){return bE("#file-viewer").attr("data-docpreview-saveas-experiment")==="True"},_is_rams_ui:function(){return bE("#file-viewer").attr("data-docpreview-ui-rams-enabled")==="True"},enter_rams_fullscreen:function(){var T;bV.enter_rams_fullscreen(bE(".preview"));T=bE("html");this._non_fullscreen_vert_overflow=T.css("overflow-y");return T.css("overflow-y","hidden")},exit_rams_fullscreen:function(){bV.exit_rams_fullscreen(bE(".preview"));bE("html").css("overflow-y",this._non_fullscreen_vert_overflow);return this._non_fullscreen_vert_overflow=null},is_rams_fullscreen_active:function(){return bV.is_rams_fullscreen_active(bE(".preview"))}};var dZ;dZ=D.Index2={init:function(fs,fo){var fq,ft,fl,fu,fp,T,fn,fm,fr;if(fo){bE("#sign-in").on("click",function(fA){var fv,fy,fx,fw,fz;fA.preventDefault();fx=bE("#sign-in-form");fc.show(eA("Sign in"),fx[0],false,false,416,false,"sign-in-modal");fy=fx.find("#login_email");fy.focus();return new b6(fv=fy,fz=function(){fx.find("#password-field").hide();fx.find("#remember-me").hide();fx.find("#login_submit").val(eA("Continue"));fx.find("#forgot_password_link").hide();return fx.find("#sso_description_footer").show()},fw=function(){fx.find("#password-field").show();fx.find("#remember-me").show();fx.find("#login_submit").val(eA("Sign in"));fx.find("#forgot_password_link").show();return fx.find("#sso_description_footer").hide()})})}fq=function(){if(!bE("#signup-container").hasClass("form_shown")){return bE.when(bE("#signup-container").animate({marginTop:-245},{easing:"easeInOutCubic",duration:500}).promise()).done(function(){bE("#signup-container").addClass("form_shown");return bE("#signup-container .text-input input:visible").first().focus()})}};if(!fs){bE(".register").find(".login-button").on("click",function(fv){if(!bE("#signup-container").hasClass("form_shown")){fv.preventDefault();return fq()}});dZ.animate()}else{bE(".photo").show()}ft=function(){if(!bE("#signup-container").hasClass("form_shown")){return bE(".register").find(".login-button").trigger("click")}};bE(".buttons .freshbutton-blue").on("click",function(fv){fv.preventDefault();bE("html, body").animate({scrollTop:0},{queue:false,duration:500,complete:ft});return false});bE("#learn-more").on("click",function(fv){fv.preventDefault();bE("html, body").animate({scrollTop:bE("#divider").offset().top},{queue:false,duration:500});return false});if(bw.are_enabled()){ba.WebMiscActivityLogger.log("index_page",{event_name:"cookies_enabled"})}else{ae.error(eA("Please enable browser-cookies to use the Dropbox website."))}T=["#devices-background",".register-button","#learn-more",".buttons .freshbutton-blue",".buttons .freshbutton-silver","#sign-in a","#page-header .downloading-link"];fn=function(fv){return bE(fv).on("click",function(){return ba.WebMiscActivityLogger.log("index_page",{event_name:"click",id:fv})})};for(fm=0,fr=T.length;fm<fr;fm++){fl=T[fm];fn(fl)}fp=[".bullet-0 .subline",".bullet-0 .description",".bullet-1 .subline",".bullet-1 .description",".bullet-2 .subline",".bullet-2 .description",".bullet-3 .subline",".bullet-3 .description",".bottom .buttons"];fu={};return bE(window).scroll(function(){var fB,fC,fA,fy,fx,fz,fw,fv;fv=[];for(fz=0,fw=fp.length;fz<fw;fz++){fA=fp[fz];if(bE(fA).length&&!fu[fA]){fC=bE(window).scrollTop();fB=fC+bE(window).outerHeight();fx=bE(fA).offset().top;fy=fx+bE(fA).outerHeight();if(fy<=fB){ba.WebMiscActivityLogger.log("index_page",{event_name:"scroll",id:fA});fv.push(fu[fA]=true)}else{fv.push(void 0)}}else{fv.push(void 0)}}return fv})},_animate_points:function(fq,fr,fs,fl,fu,fp,T){var fn,fm,fo,ft;if(T==null){T=0}T=Math.min(Math.max(T,0),1);fo=fp(T);ft=[(function(){var fx,fw,fv;fv=[];for(fn=fx=0,fw=fr.length;0<=fw?fx<fw:fx>fw;fn=0<=fw?++fx:--fx){fv.push([(function(){var fz,fy;fy=[];for(fm=fz=0;fz<2;fm=++fz){fy.push(fr[fn][fm]+(fs[fn][fm]-fr[fn][fm])*fo)}return fy})()])}return fv})()];fq.attr("points",dZ.points_array_to_str(ft));if(T>=1){return fu.resolve()}else{return setTimeout(function(){return dZ._animate_points(fq,fr,fs,fl,fu,fp,T+(10/fl))},10)}},animate_points:function(fl,fq,fp,fm,fo,fn){var T;if(fn==null){fn=jQuery.easing.linear}T=bE.Deferred();dZ._animate_points(fl,fq,fp,fm,T,fn);return T.done(function(){return typeof fo==="function"?fo():void 0}).promise()},animate_hide_rects:function(fl,fp,fr){var T,fm,fq,fo,fn;T=bE.Deferred().resolve().promise();fq=function(fs){var fx,fu,fw,ft,fv;ft=bE(fl[fs]);fx=dZ.points_str_to_array(ft.attr("points"));fv=[fx[1],fx[1],fx[2],fx[2]];fu=dZ.inverse(jQuery.easing.linear);fw=fp*(fu((fs+1)/fl.length)-fu(fs/fl.length));return T=T.then(function(){return dZ.animate_points(ft,fx,fv,fw)})};for(fm=fo=0,fn=fl.length;0<=fn?fo<fn:fo>fn;fm=0<=fn?++fo:--fo){fq(fm)}return T.done(function(){return typeof fr==="function"?fr():void 0}).promise()},animate_delay:function(fl){var T;T=bE.Deferred();setTimeout(T.resolve,fl);return T.promise()},animate:function(){return bE.Deferred().resolve().promise().then(function(){return dZ.animate_docs()}).then(function(){return dZ.animate_graphs()}).then(function(){return dZ.animate_photos()})},inverse:function(fl,T){if(T==null){T=0.000001}return function(fp){var fn,fo,fm;fo=0;fn=1;while(fn-fo>T){fm=(fo+fn)/2;if(fl(fm)<fp){fo=fm}else{fn=fm}}return fo}},points_str_to_array:function(fq){var fm,fp,fo,fl,fn,T;fn=fq.split(" ");T=[];for(fo=0,fl=fn.length;fo<fl;fo++){fp=fn[fo];T.push((function(){var fu,fs,fr,ft;fr=fp.split(",");ft=[];for(fu=0,fs=fr.length;fu<fs;fu++){fm=fr[fu];ft.push(parseFloat(fm))}return ft})())}return T},points_array_to_str:function(fl){var T;return((function(){var fo,fn,fm;fm=[];for(fo=0,fn=fl.length;fo<fn;fo++){T=fl[fo];fm.push(T.join(","))}return fm})()).join(" ")},animate_docs:function(){var fq,T,fn,fm,fp,fl,fo;fl=[[5,6],[177,1],[184,157],[13,180]];T="";for(fp=fo=0.475;fo<=0.625;fp=fo+=0.05){fq=fp+0.05;fn=[[fl[0][0]+(fl[3][0]-fl[0][0])*fp,fl[0][1]+(fl[3][1]-fl[0][1])*fp],[fl[1][0]+(fl[2][0]-fl[1][0])*fp,fl[1][1]+(fl[2][1]-fl[1][1])*fp],[fl[1][0]+(fl[2][0]-fl[1][0])*fq,fl[1][1]+(fl[2][1]-fl[1][1])*fq],[fl[0][0]+(fl[3][0]-fl[0][0])*fq,fl[0][1]+(fl[3][1]-fl[0][1])*fq]];fn=dZ.points_array_to_str(fn);T+="<polygon points='"+fn+"' style='fill:#f5f9fc;stroke:none;' />"}fm=bE('<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="190" width="188">\n   '+T+"\n</svg>");return bE.Deferred().resolve().promise().then(function(){bE(".doc, .graph, .photo").hide();bE(".comp.doc").append(fm);return bE(".comp.doc").show("slide",{direction:"down"},850).promise()}).then(function(){return dZ.animate_hide_rects(fm.find("polygon"),2500,function(){return fm.remove()})}).then(function(){return dZ.animate_delay(500)}).then(function(){return bE(".tablet.doc, .phone.doc").show("fade",{easing:"easeInOutCubic"},400).promise()}).then(function(){return dZ.animate_delay(1500)}).then(function(){return bE(".tablet.doc, .phone.doc, .comp.doc").hide("fade",{easing:"easeInOutCubic",duration:700}).promise()})},animate_graphs:function(){var fl,T;fl=[[83,98],[158,37],[241,77],[171,145]];T=bE('<svg xmlns="http://www.w3.org/2000/svg" version="1.1">\n    <polygon style="fill:#f5f9fc;stroke:none;"/>\n</svg>');T.find("polygon").attr("points",dZ.points_array_to_str(fl));return bE.Deferred().resolve().promise().then(function(){bE(".doc, .graph, .photo").hide();bE(".tablet.graph .graph-grid").hide();bE(".tablet.graph").append(T);return bE(".tablet.graph").show("fade",{},500).promise()}).then(function(){var fm;fm=[fl[0],fl[1],fl[1],fl[0]];return dZ.animate_points(T.find("polygon"),fl,fm,600,function(){return T.remove()})}).then(function(){if(!b1.msie_version_at_most(8)){return bE(".tablet.graph .graph-grid").show("fade",{},400).promise()}}).then(function(){return dZ.animate_delay(500)}).then(function(){return bE(".comp.graph, .phone.graph").show("fade",{easing:"easeInOutCubic"},500).promise()}).then(function(){return dZ.animate_delay(2000)}).then(function(){return bE(".graph").hide("fade",{easing:"easeInOutCubic"},700).promise()})},animate_photos:function(){return bE.Deferred().resolve().promise().then(function(){bE(".doc, .graph, .photo").hide();bE(".phone.photo img").not(".photo-flash").css({left:-18*1.15,top:-66*1.15,position:"absolute"});bE(".phone.photo").show();return bE.when((function(){if(!b1.msie_version_at_most(8)){return bE(".phone.photo .photo-flash").show().hide("fade",{},2000).promise()}})(),(function(){return bE.Deferred().resolve().promise().then(function(){return bE(".phone.photo img").not(".photo-flash").animate({left:0,top:0},{duration:800,easing:"easeInOutCubic"}).promise()}).then(function(){return dZ.animate_delay(750)}).then(function(){return bE(".tablet.photo, .comp.photo").show("fade",{easing:"easeInOutCubic"},500).promise()})})())})}};var dB,L,du=function(T,fl){return function(){return T.apply(fl,arguments)}},au={}.hasOwnProperty,cN=function(fn,fl){for(var T in fl){if(au.call(fl,T)){fn[T]=fl[T]}}function fm(){this.constructor=fn}fm.prototype=fl.prototype;fn.prototype=new fm();fn.__super__=fl.prototype;return fn};L=INLINE_JS.UserNotifier=D.UserNotifier={USER_NOTIFICATION_STATUS_UNREAD:0,USER_NOTIFICATION_STATUS_READ:1,USER_NOTIFICATION_STATUS_INVISIBLE:2,MAX_ROWS_TO_RETRIEVE:100,MAX_INITIAL_ROWS:10,NUM_ROWS_TO_APPEND:10,SCROLLING_OFFSET:10,_is_retrieving_feed:false,_unread_count:0,_notifications:[],LAST_ACKED_META_ID_KEY:"last_acked_meta_id_key",_current_meta_not_id:null,_num_event_rows:0,_acked_ids:{},_shown:{},_has_more:false,_has_acked:false,THUMBS_BATCH_SIZE:16,_thumb_cache:{},init:function(){var fl,fm,T;this.refresh_feed();bE("#event-feed-container").scroll(function(){if(L._has_more){if(L._scroller_within_offset_to_bottom(L.SCROLLING_OFFSET)){return L._append_event_rows(false)}}});Event.observe($("event-feed-container"),"mousewheel",this.scrolling.bind(this));Event.observe($("event-feed-container"),"DOMMouseScroll",this.scrolling.bind(this));bE("#event-feed").on("click",this._mouseclick.bind(this));T=[];for(fm in d8){fl=d8[fm];T.push(this._subscribe_user(fl))}return T},refresh_feed:function(T,fl){var fn,fo,fm;fm=(function(fp){return function(fr){var fu,fs,ft,fq;fp._unread_count=fr.unread_count;fp._notifications=fr.notifications;if(fr.meta_notification){fs=fr.meta_notification;ft=fp._identifier(fs);if(ft!==fp._get_last_acked_meta_not_id()){fp._unread_count++}fp._current_meta_not_id=ft;fp._notifications.push(fs)}fp._has_acked=false;fp._notifications.sort(fp._sort_key);fp._append_event_rows(true);fp.update_jewel_ui(fp._unread_count);if((T!=null)&&(fl!=null)){fq=T.get_user_id();fu=fr.latest_nid[fq];T.handler_success(fl,{nid:fr.latest_nid[fq]})}if(bZ){return bZ.refresh_inbox_counts()}}})(this);fo=(function(fp){return function(){return fp._is_retrieving_feed=false}})(this);fn=(function(fp){return function(){var fq;fp._is_retrieving_feed=true;fq={count:fp.MAX_ROWS_TO_RETRIEVE};return new bE.ajax("/web/notifications/retrieve",{data:fq,dataType:"json",type:"POST",success:fm,error:function(){if((T!=null)&&(fl!=null)){return T.handler_failure(fl)}},complete:fo})}})(this);return fn()},ack_unread_notifications:function(){if(!this._has_acked&&this._unread_count>0){this.update_jewel_ui(0);if(this._get_last_acked_meta_not_id()!==this._current_meta_not_id){this._set_last_acked_meta_not_id(this._current_meta_not_id);this._acked_ids[this._current_meta_not_id]=true}new bE.ajax("/web/notifications/ack_all",{dataType:"json",type:"POST",success:(function(T){return function(fn){var fo,fq,fp,fm,fl;fl=[];for(fp=0,fm=fn.length;fp<fm;fp++){fq=fn[fp];fo=T._identifier(fq);T._acked_ids[fo]=true;fl.push(T._append_event_rows())}return fl}})(this)});return this._has_acked=true}},update_jewel_ui:function(T){bE("#new-notification-count").text(T).toggleClass("show",T>0);if(T>0){bE(".notifications-bell").addClass("shake")}return setTimeout((function(){return bE(".notifications-bell").removeClass("shake")}),500)},scrolling:function(T){var fl;if(T.originalEvent){T=T.originalEvent}fl=T.detail?T.detail*(-40):T.wheelDelta;if(!this._has_more&&fl<=0&&this._scroller_within_offset_to_bottom(0)){return this.preventDefault(T)}else{if(fl>=0&&$("event-feed-container").scrollTop===0){return this.preventDefault(T)}}},clear_cached_client_states:function(){if(this._is_retrieving_feed){return}this._acked_ids={};return this._append_event_rows(true)},preventDefault:function(T){if(typeof T.preventDefault==="function"){T.preventDefault()}return T.returnValue=false},_subscribe_user:function(T){var fl;return fl=T.subscribe_user({name:"NotificationFeedUpdater",handler:(function(fm){return function(){return fm.refresh_feed(T,fl)}})(this)})},_append_event_rows:function(ft){var T,fx,fA,fm,fv,fr,fu,fs,fq,fw,fl,fo,fz,fn,fy,fp;if(ft==null){ft=false}if(ft){bE("#event-feed").empty();this._shown={};this._num_event_rows=Math.min(this._notifications.length,this.MAX_INITIAL_ROWS)}else{this._num_event_rows+=this.NUM_ROWS_TO_APPEND;this._num_event_rows=Math.min(this._num_event_rows,this._notifications.length)}fw=bE(".feed-row").size();fx=[];fp=this._notifications;for(fu=fn=0,fy=fp.length;fn<fy;fu=++fn){fq=fp[fu];if(fw>=this._num_event_rows){break}fv=this._identifier(fq);if(fv in this._shown){continue}this._shown[fv]=true;fo=fq.status;fm=bE(fq.notification_div);bE("#event-feed").append(fm);fw++;fr=fm.find("img").get(0);if(fr){T=bE(fr);fA=T.attr("data-src");if(fA){if(this._thumb_cache[fA]){fs=this._thumb_cache[fA];T.attr("src",fs);if(!fs.endsWith(cv.SPACER)){this._add_thumbnail_frame(T)}}else{if(!(fA in this._thumb_cache)){this._thumb_cache[fA]=false;fz=fq.user_id;T.data("uid",fz);T.data("not-identifier",fv);fx.push($(fr))}}}}if(!fm.hasClass("feed-row")){fm=fm.find(".feed-row")}if(fq.type_id===Constants.NOTIFICATION_TYPE_META){fm.addClass("meta-feed");if((!(fv in this._acked_ids))&&(fv===this._get_last_acked_meta_not_id())){fm.addClass("read")}}if(fo===this.USER_NOTIFICATION_STATUS_INVISIBLE){fm.addClass("invisible");if(fv in this._acked_ids){delete this._acked_ids[fv]}}if(fo===this.USER_NOTIFICATION_STATUS_READ){if(!(fv in this._acked_ids)){fm.addClass("read")}}}fl=(function(fB){return function(fF){var fD,fC,fE;if(!fF.src.endsWith(cv.SPACER)){fD=bE(fF);fB._add_thumbnail_frame(fD);fv=fD.data("not-identifier");fE=fD.attr("data-src");fC=fD.attr("src");return fB._thumb_cache[fE]=fC}}})(this);bs.batch_load_thumbs(fx,this.THUMBS_BATCH_SIZE,fl);this._has_more=this._num_event_rows<this._notifications.length;if(bE(".feed-row").length===0){return bE("#event-feed-container").addClass("empty")}else{return bE("#event-feed-container").removeClass("empty")}},_identifier:function(T){return""+T.user_id+" "+T.type_id+" "+T.target_object_key},_sort_key:function(fl,T){if(fl.sticky&&!T.sticky){return -1}if(T.sticky&&!fl.sticky){return 1}if(fl.status===L.USER_NOTIFICATION_STATUS_UNREAD&&T.status!==L.USER_NOTIFICATION_STATUS_UNREAD){return -1}if(T.status===L.USER_NOTIFICATION_STATUS_UNREAD&&fl.status!==L.USER_NOTIFICATION_STATUS_UNREAD){return 1}return T.feed_time-fl.feed_time},_get_last_acked_meta_not_id:function(){if(window.localStorage){return localStorage.getItem(this.LAST_ACKED_META_ID_KEY)}},_set_last_acked_meta_not_id:function(T){if(window.localStorage){return localStorage.setItem(this.LAST_ACKED_META_ID_KEY,T)}},_add_thumbnail_frame:function(T){bE(T).addClass("thumbnail");return bE(T).parent(".feed-thumbnail").addClass("has-frame")},_mouseclick:function(fm){var fl,T;fl=bE(fm.target);if(fl.is("a")){if(fl.hasClass("view")){fm.preventDefault();T=fl.attr("data-mount");window.open(T)}}if(fl.closest("a").hasClass("meta-notification-sign-in-needed")){fm.preventDefault();return bO.show_page_login_modal((function(fn){return function(){return fn.refresh_feed()}})(this))}},_scroller_within_offset_to_bottom:function(fl){var T;T=$("event-feed-container");return T.scrollTop+T.offsetHeight+fl>=T.scrollHeight}};dB=D.NotificationUIButton=(function(fl){cN(T,fl);T.prototype.selector=function(){return".notification-button"};function T(){this.clear=du(this.clear,this);this.active=du(this.active,this);this._clear_sticky_notification_on_popover_close=du(this._clear_sticky_notification_on_popover_close,this);T.__super__.constructor.call(this);this._overflowY="auto";this._position="static";this._max_height="0px"}T.prototype._clear_sticky_notification_on_popover_close=function(){if(!bE(this.selector())[0].hasClassName("active")){return L.clear_cached_client_states()}};T.prototype.active=function(fm,fo){var fn;fn=fm.target.hasClassName("feed-row")?fm.target:$(fm.target).up(".feed-row");if(fn){if(!fn.hasClassName("clickable")){return}}T.__super__.active.call(this,fm,fo);return this._clear_sticky_notification_on_popover_close()};T.prototype.clear=function(fm){T.__super__.clear.call(this,fm);return this._clear_sticky_notification_on_popover_close()};return T})(dV);var bB,cm,eP;eP=D.UnsupportedBrowser={init:function(){return bE("#unsupported-browser-dismiss").on("click",function(T){T.preventDefault();e8.hide();return bE.ajax({url:"/dismiss_browser_msg",type:"POST"})})}};cm=D.ExpiredCCNotificationBar={init:function(T){return bE(".expired-dismiss").on("click",function(fl){fl.preventDefault();e8.hide();return bE.ajax({url:"/dismiss_expired_cc_notification",type:"POST",data:{source:T}})})}};bB=D.BetaLocaleNotificationBar={init:function(T){return bE(".beta-locale-dismiss").on("click",function(fl){fl.preventDefault();e8.hide();return bE.ajax({url:"/dismiss_beta_locale_notification",type:"POST",data:{source:T}})})}};var e;e=INLINE_JS.viewer=cK.get_viewer();var K,cb,h,g,cO,cI,x,em;if(!Constants.is_test){bE(eR.check_timezone)}if(window._document_observe_listeners){x=window._document_observe_listeners;for(h=0,cO=x.length;h<cO;h++){cb=x[h];if(document.loaded){cb.func()}else{document.observe(cb.event,cb.func)}}}if(window._jquery_ready_handlers){em=window._jquery_ready_handlers;for(g=0,cI=em.length;g<cI;g++){K=em[g];bE(K)}}bE(function(){Event.fire(document,"script:loaded");return $(document.body).removeClassName("deferred-resources")});return D});